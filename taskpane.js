(()=>{"use strict";const e=Object.freeze({GEMINI:"gemini",OPENAI:"openai"}),t=Object.freeze({provider:e.GEMINI,geminiModel:"gemini-3-flash-preview",openaiModel:"gpt-5-mini",geminiReasoningEffort:"auto",openaiReasoningEffort:"medium",maxOutputTokens:4096,retry:2,timeoutMs:12e4,cache:!0,cacheTtlSec:604800,webCacheTtlSec:3600}),n=Object.freeze({DEFAULT_PROVIDER:"AI_DEFAULT_PROVIDER_V3",GEMINI_API_KEY:"AI_GEMINI_API_KEY_V3",OPENAI_API_KEY:"AI_OPENAI_API_KEY_V3",GEMINI_MODEL:"AI_GEMINI_MODEL_V3",OPENAI_MODEL:"AI_OPENAI_MODEL_V3",GEMINI_REASONING_EFFORT:"AI_GEMINI_REASONING_EFFORT_V3",OPENAI_REASONING_EFFORT:"AI_OPENAI_REASONING_EFFORT_V3",MAX_OUTPUT_TOKENS:"AI_MAX_OUTPUT_TOKENS_V3",ONBOARDING_SEEN:"AI_ONBOARDING_SEEN_V1",MIGRATION_DONE:"AI_MIGRATION_DONE_V3",REQUEST_LOG:"AI_REQUEST_LOG_V1",REQUEST_LOG_CLEAR_AT:"AI_REQUEST_LOG_CLEAR_AT_V1",CACHE_INDEX:"AI_CACHE_INDEX_V1",CACHE_CLEAR_AT:"AI_CACHE_CLEAR_AT_V1"}),o=Object.freeze({GEMINI_API_KEY:"GEMINI_API_KEY",MAX_OUTPUT_TOKENS:"MAX_OUTPUT_TOKENS",DEFAULT_PROVIDER_V2:"AI_DEFAULT_PROVIDER_V2",GEMINI_API_KEY_V2:"AI_GEMINI_API_KEY_V2",OPENAI_API_KEY_V2:"AI_OPENAI_API_KEY_V2",GEMINI_MODEL_V2:"AI_GEMINI_MODEL_V2",OPENAI_MODEL_V2:"AI_OPENAI_MODEL_V2",GEMINI_MAX_TOKENS_V2:"AI_GEMINI_MAX_OUTPUT_TOKENS_V2",OPENAI_MAX_TOKENS_V2:"AI_OPENAI_MAX_OUTPUT_TOKENS_V2"});let i=null;function a(){try{if("undefined"!=typeof OfficeRuntime&&OfficeRuntime?.storage?.getItem)return{kind:"office",storage:OfficeRuntime.storage}}catch{}try{if("undefined"!=typeof window&&window?.localStorage?.getItem)return{kind:"local",storage:window.localStorage}}catch{}const e=new Map;return{kind:"memory",storage:{getItem:async t=>e.has(t)?e.get(t):null,async setItem(t,n){e.set(t,String(n))},async removeItem(t){e.delete(t)}}}}function s(){try{if("undefined"!=typeof window&&window?.localStorage?.getItem)return window.localStorage}catch{return null}return null}async function r(e){const{kind:t,storage:n}=a();if("local"===t)try{return n.getItem(e)}catch{return null}if("office"===t)try{const t=await n.getItem(e);if(null==t){const t=s();if(!t)return null;try{const n=t.getItem(e);return null==n?null:n}catch{return null}}return t}catch{const t=s();if(!t)return null;try{return t.getItem(e)}catch{return null}}try{return await n.getItem(e)}catch{return null}}async function c(e,t){const{kind:n,storage:o}=a(),i=null==t?"":String(t);if("local"===n)try{return void o.setItem(e,i)}catch{return}if("office"===n){try{await o.setItem(e,i)}catch{}const t=s();if(!t)return;try{t.setItem(e,i)}catch{}return}try{await o.setItem(e,i)}catch{}}async function u(e){const{kind:t,storage:n}=a();if("local"===t)try{return void n.removeItem(e)}catch{return}if("office"===t){try{await n.removeItem(e)}catch{}const t=s();if(!t)return;try{t.removeItem(e)}catch{}return}try{await n.removeItem(e)}catch{}}async function l(){if(i)return i;i=(async()=>{if("1"!==await r(n.MIGRATION_DONE)){if(!d(await r(n.DEFAULT_PROVIDER))){const e=d(await r(o.DEFAULT_PROVIDER_V2));await c(n.DEFAULT_PROVIDER,e||t.provider)}if(!await r(n.GEMINI_API_KEY)){const e=await r(o.GEMINI_API_KEY_V2)||await r(o.GEMINI_API_KEY);e&&await c(n.GEMINI_API_KEY,e)}if(!await r(n.OPENAI_API_KEY)){const e=await r(o.OPENAI_API_KEY_V2);e&&await c(n.OPENAI_API_KEY,e)}if(!await r(n.GEMINI_MODEL)){const e=await r(o.GEMINI_MODEL_V2);await c(n.GEMINI_MODEL,e||t.geminiModel)}if(!await r(n.OPENAI_MODEL)){const e=await r(o.OPENAI_MODEL_V2);await c(n.OPENAI_MODEL,e||t.openaiModel)}if(!await r(n.MAX_OUTPUT_TOKENS)){const e=[await r(o.MAX_OUTPUT_TOKENS),await r(o.GEMINI_MAX_TOKENS_V2),await r(o.OPENAI_MAX_TOKENS_V2)].map(e=>parseInt(String(e||"").trim(),10)).filter(e=>Number.isFinite(e)&&e>0),i=e.length?Math.max(...e):t.maxOutputTokens;await c(n.MAX_OUTPUT_TOKENS,String(i))}await c(n.MIGRATION_DONE,"1")}})();try{await i}finally{i=null}}function d(t){if(!t)return"";const n=String(t).trim().toLowerCase();return n===e.GEMINI?e.GEMINI:n===e.OPENAI?e.OPENAI:"google"===n||"gem"===n?e.GEMINI:"oai"===n||"chatgpt"===n?e.OPENAI:""}const m=new Set(["auto","minimal","low","medium","high"]),p=new Set(["none","minimal","low","medium","high"]);function f(e){const n=String(e||"").trim().toLowerCase();return n&&m.has(n)?n:t.geminiReasoningEffort}function g(e){const n=String(e||"").trim().toLowerCase();return n&&p.has(n)?n:t.openaiReasoningEffort}async function E(){return await l(),d(await r(n.DEFAULT_PROVIDER))||t.provider}function h(t){return d(t)===e.OPENAI?n.OPENAI_API_KEY:n.GEMINI_API_KEY}async function y(e){return await l(),(await r(h(e))||"").trim()}function I(t){return d(t)===e.OPENAI?n.OPENAI_MODEL:n.GEMINI_MODEL}async function _(n){await l();const o=d(n),i=await r(I(o));return i&&String(i).trim()?String(i).trim():o===e.OPENAI?t.openaiModel:t.geminiModel}async function w(){return await l(),f(await r(n.GEMINI_REASONING_EFFORT)||t.geminiReasoningEffort)}async function N(){return await l(),g(await r(n.OPENAI_REASONING_EFFORT)||t.openaiReasoningEffort)}async function A(e){const t=g(e);return await c(n.OPENAI_REASONING_EFFORT,t),t}async function k(e){const t=f(e);return await c(n.GEMINI_REASONING_EFFORT,t),t}async function v(){await l();const e=await r(n.MAX_OUTPUT_TOKENS);return C(parseInt(String(e||"").trim(),10),1,128e3,t.maxOutputTokens)}async function T(e){const o=C(e,1,128e3,t.maxOutputTokens);return await c(n.MAX_OUTPUT_TOKENS,String(o)),o}function O(){return Date.now()}function M(e){return new Promise(t=>setTimeout(t,e))}function C(e,t,n,o=t){const i=parseInt(String(e),10);return Number.isFinite(i)?Math.max(t,Math.min(n,i)):o}function b(e){const t=parseInt(String(e||"").trim(),10);return Number.isFinite(t)&&t>0?t:0}const S="AI_CACHE_ENTRY_V1:";let x=0;async function L(){const e=b(await r(n.CACHE_CLEAR_AT));return e>x&&(x=e),x}async function P(){const e=await r(n.CACHE_INDEX);if(!e)return[];try{const t=JSON.parse(e);return Array.isArray(t)?t:[]}catch{return[]}}async function R(e){try{await c(n.CACHE_INDEX,JSON.stringify(e))}catch{}}function G(e,t=0){const n=O(),o=[],i=[];for(const a of e||[]){if(!a||!a.key)continue;const e=Number(a.savedAtMs||0);t&&(!Number.isFinite(e)||e<=t)||a.expiresAtMs&&a.expiresAtMs<=n?i.push(a.key):o.push(a)}if(o.length>250){o.sort((e,t)=>(e.savedAtMs||0)-(t.savedAtMs||0));const e=o.length-250,t=o.slice(0,e);for(const e of t)i.push(e.key);return{list:o.slice(e),removedKeys:i}}return{list:o,removedKeys:i}}async function K(e){e&&await u(S+e)}async function D(e){const t=await P(),n=(t||[]).filter(t=>t?.key!==e);n.length!==t.length&&await R(n)}async function F(e,t,n,o={}){if(!e)return;const i=O(),a=await L(),s=a&&i<=a?a+1:i,r="number"==typeof n&&n>0?s+n:null,u={v:1,savedAtMs:s,expiresAtMs:r,value:t},l=JSON.stringify(u);await c(S+e,l);const d=await P(),m=o.provider||t?.provider||"",p=o.model||t?.model||"",f=l.length;let g=!1;const E=(d||[]).map(t=>t?.key!==e?t:(g=!0,{key:e,provider:m,model:p,size:f,savedAtMs:s,expiresAtMs:r}));g||E.push({key:e,provider:m,model:p,size:f,savedAtMs:s,expiresAtMs:r});const h=G(E,a);for(const e of h.removedKeys)await K(e);await R(h.list)}function U(e){if(Array.isArray(e))return e.map(U);if(t=e,"[object Object]"===Object.prototype.toString.call(t)){const t={};for(const n of Object.keys(e).sort())t[n]=U(e[n]);return t}var t;return e}const V=864e5;let $=[],Y=null,j=!1,B=0,J=0;async function z(e={}){const t=b(await r(n.REQUEST_LOG_CLEAR_AT));return t>J&&(J=t,$=[],e.reset?(j=!0,Y=null,B=O()):j=!1),J}async function X(e=!1){if(Y)return Y;Y=(async()=>{const t=await z();if(!e&&j)return $;const o=await r(n.REQUEST_LOG);let i=[];if(o)try{const e=JSON.parse(o);Array.isArray(e)&&(i=e)}catch{i=[]}const a=O();return i=i.map(e=>{if(!e)return null;let t=e.ts;if("string"==typeof t){const e=Date.parse(t);Number.isFinite(e)&&(t=e)}return"number"!=typeof t?null:{...e,ts:t}}).filter(e=>e&&"number"==typeof e.ts&&e.ts>t&&a-e.ts<=V),$=i.slice(-500),j=!0,B=O(),$})();try{return await Y}finally{Y=null}}async function H(){try{await c(n.REQUEST_LOG,JSON.stringify($.slice(-500)))}catch{}}function q(){const e=O(),t=J||0;$=($||[]).filter(n=>n&&"number"==typeof n.ts&&n.ts>t&&e-n.ts<=V),$.length>500&&($=$.slice(-500))}function Q(e){!async function(e){try{await z({reset:!0});const t={ts:O(),...e};if(j)return $.push(t),q(),B=O(),void await H();await X(),$.push(t),q(),B=O(),await H()}catch{}}(e)}const W=new class{constructor(e=500){this.maxEntries=e,this.map=new Map}get(e){if(!this.map.has(e))return null;const t=this.map.get(e);return t?.expiresAtMs&&t.expiresAtMs<=O()?(this.map.delete(e),null):(this.map.delete(e),this.map.set(e,t),t.value)}set(e,t,n){const o="number"==typeof n&&n>0?O()+n:null;for(this.map.has(e)&&this.map.delete(e),this.map.set(e,{value:t,expiresAtMs:o});this.map.size>this.maxEntries;){const e=this.map.keys().next().value;this.map.delete(e)}}clear(){this.map.clear()}}(800);let Z=0;const ee=new Map;let te=0;const ne=[];function oe(e){return"string"==typeof e&&e.trim().length>0}function ie(e,t=!1){if("boolean"==typeof e)return e;if("number"==typeof e)return 0!==e;if("string"==typeof e){const t=e.trim().toLowerCase();if(["1","true","yes","y","on"].includes(t))return!0;if(["0","false","no","n","off"].includes(t))return!1}return t}function ae(e){return C(e,1e3,12e4,t.timeoutMs)}function se(e){return String(e||"").toLowerCase()}function re(e){const t=se(e);return!!t&&(t.includes("responseschema")||t.includes("response schema")||t.includes("response_schema")||t.includes("responsemime")||t.includes("response mime")||t.includes("response_mime")||t.includes("response_mime_type")||t.includes("json_schema")||t.includes("response_format")||t.includes("text.format"))}function ce(e){const t=se(e);return!!t&&!!(t.includes("web_search")||t.includes("google_search")||t.includes("web search")||t.includes("google search"))&&(t.includes("not supported")||t.includes("unsupported")||t.includes("unknown")||t.includes("unrecognized")||t.includes("invalid")||t.includes("not enabled")||t.includes("not available"))}function ue(e){if(!oe(e))return"Return valid JSON only.";const t=String(e).trim();return/json/i.test(t)?t:t+" Return valid JSON only."}function le(e,t){return"AI.FORMULA"!==e?"":function(e){if(!oe(e))return"";const t=String(e).trim(),n=t.match(/=[^\n\r]+/),o=(n?n[0]:t).trim();return o.startsWith("=")?o:""}(t)}async function de(n){const o=O(),i=d(n?.provider)||await E(),a=await _(i),s=await y(i),c=n?.functionName||"aiGenerate";if(!s)return Q({fn:c,provider:i,model:a,ok:!1,ms:O()-o,cache:!1,code:"API_KEY_MISSING",message:`ClÃ© API manquante pour le fournisseur ${i}.`}),{ok:!1,provider:i,model:a,code:"API_KEY_MISSING",message:`ClÃ© API manquante pour le fournisseur ${i}.`};const u=String(n?.user||""),l=oe(n?.system)?String(n.system):"",m=ie(n?.webSearch,!1),p=ae(n?.timeoutMs),f=(g=n?.retry,C(g,0,5,t.retry));var g;const h=await v(),I=function(e){return C(e,1,128e3,t.maxOutputTokens)}(n?.maxOutputTokens??h),A=i===e.OPENAI?await N():"",k=i===e.GEMINI?await w():"",T=i===e.GEMINI?function(e,t){const n=String(t||"").trim().toLowerCase();if(!n||"auto"===n||"none"===n)return null;const o=String(e||"").trim().toLowerCase();if(!o.includes("gemini"))return null;if(o.includes("gemini-3"))return o.includes("flash")?{thinkingLevel:(new Set(["minimal","low","medium","high"]).has(n)?n:"low").toUpperCase()}:{thinkingLevel:("high"===n||"medium"===n?"high":"low").toUpperCase()};if(o.includes("gemini-2.5")){let e={minimal:512,low:2048,medium:8192,high:24576}[n];return e?(o.includes("flash-lite")&&(e=Math.max(512,e)),o.includes("pro")&&(e=Math.max(128,e)),{thinkingBudget:e}):null}return null}(a,k):null,b=ie(n?.cache,t.cache),x=C(n?.cacheTtlSec??(m?t.webCacheTtlSec:t.cacheTtlSec),1,31536e3,m?t.webCacheTtlSec:t.cacheTtlSec);await async function(){const e=await async function(){return await L()}();e>Z&&(Z=e,W.clear())}();const P={v:3,provider:i,model:a,maxOutputTokens:I,reasoningEffort:A,geminiReasoningEffort:k,webSearch:m,system:l,user:u,responseMimeType:n?.responseMimeType||"",responseJsonSchema:n?.responseJsonSchema||null},R=await async function(e){const t="string"==typeof e?e:(n=e,JSON.stringify(U(n)));var n;try{if("undefined"!=typeof crypto&&crypto?.subtle?.digest&&"undefined"!=typeof TextEncoder){const e=(new TextEncoder).encode(t),n=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(n)).map(e=>e.toString(16).padStart(2,"0")).join("")}}catch{}return`fnv1a:${function(e){let t=2166136261;for(let n=0;n<e.length;n++)t^=e.charCodeAt(n),t=Math.imul(t,16777619);return(t>>>0).toString(16).padStart(8,"0")}(t)}`}(P);if(b){const e=W.get(R);if(e){const t=le(c,e?.text);return Q({fn:c,provider:i,model:a,ok:!0,ms:O()-o,cache:!0,cacheKind:"memory",inputTokens:0,outputTokens:0,reasoningTokens:0,totalTokens:0,formula:t||void 0}),{...e,cached:!0,cacheKind:"memory"}}const t=await async function(e){if(!e)return null;const t=await L(),n=await r(S+e);if(!n)return await D(e),null;try{const o=JSON.parse(n);if(!o||"object"!=typeof o)throw new Error("Invalid entry");const i=Number(o.savedAtMs||0);return t&&(!Number.isFinite(i)||i<=t)||o.expiresAtMs&&o.expiresAtMs<=O()?(await K(e),await D(e),null):o.value||null}catch{return await K(e),await D(e),null}}(R);if(t){const e=le(c,t?.text);return W.set(R,t,1e3*x),Q({fn:c,provider:i,model:a,ok:!0,ms:O()-o,cache:!0,cacheKind:"persistent",inputTokens:0,outputTokens:0,reasoningTokens:0,totalTokens:0,formula:e||void 0}),{...t,cached:!0,cacheKind:"persistent"}}}if(ee.has(R))return ee.get(R);const G=async function(){te>=4&&await new Promise(e=>ne.push(e)),te++;try{return await(async()=>{let t=0,r=null;const d=async t=>i===e.OPENAI?async function({apiKey:t,model:n,system:o,user:i,maxOutputTokens:a,reasoningEffort:s,timeoutMs:r,webSearch:c,responseMimeType:u,responseJsonSchema:l}){const d="https://api.openai.com/v1/responses",m={model:n,input:i,max_output_tokens:a,store:!1};if(oe(s)&&(m.reasoning={effort:s}),oe(o)){const e="application/json"===u||l?o+" You must return valid JSON.":o;m.instructions=e}l?m.text={format:{type:"json_schema",name:"excel_ai_schema",strict:!0,schema:l}}:"application/json"===u&&(m.text={format:{type:"json_object"}}),c&&(m.tools=[{type:"web_search"}],m.include=["web_search_call.action.sources"]);const p=await ge(d,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify(m)},r),f=await Ee(p);if(!p.ok){const t=function(e){try{const t=e?.error?.message;return t?String(t):""}catch{return""}}(f)||`OpenAI API error (${p.status}).`;return{ok:!1,provider:e.OPENAI,model:n,code:"API_ERROR",message:t}}const g=function(e){try{if("string"==typeof e?.output_text&&e.output_text.trim())return e.output_text}catch{}try{const t=e?.output;if(Array.isArray(t)){const e=[];for(const n of t){if("string"==typeof n?.text&&n.text.trim()&&e.push(n.text),"string"==typeof n?.output_text&&n.output_text.trim()&&e.push(n.output_text),"output_text"===n?.type&&"string"==typeof n?.text&&e.push(n.text),"text"===n?.type&&"string"==typeof n?.text&&e.push(n.text),"message"===n?.type){const t=n?.content;if(Array.isArray(t))for(const n of t)"text"===n?.type&&n?.text&&e.push(n.text),"output_text"===n?.type&&n?.text&&e.push(n.text);else"string"==typeof t&&e.push(t)}if("message"!==n?.type){const t=n?.content;if(Array.isArray(t))for(const n of t)"text"===n?.type&&n?.text&&e.push(n.text),"output_text"===n?.type&&n?.text&&e.push(n.text);else"string"==typeof t&&e.push(t)}}if(e.length>0)return e.join("\n").trim()}}catch{}try{return e?.choices?.[0]?.message?.content||""}catch{return""}}(f),E=c?function(e){try{const t=e?.output;if(!Array.isArray(t))return[];const n=[];for(const e of t){if("web_search_call"!==e?.type)continue;const t=e?.action?.sources;if(Array.isArray(t))for(const e of t)e?.url&&n.push({title:e?.title||"",url:e.url})}return fe(n)}catch{return[]}}(f):[],h=function(e){try{const t=e?.usage;if(!t)return null;const n=pe(t?.output_tokens),o=pe(t?.output_tokens_details?.reasoning_tokens),i=Math.max(0,n-o);return{inputTokens:pe(t?.input_tokens),outputTokens:i,reasoningTokens:o,totalTokens:pe(t?.total_tokens),cachedInputTokens:pe(t?.input_tokens_details?.cached_tokens)}}catch{return null}}(f);return oe(g)?{ok:!0,provider:e.OPENAI,model:n,text:g.trim(),sources:E,usage:h}:{ok:!1,provider:e.OPENAI,model:n,code:"EMPTY_RESPONSE",message:"RÃ©ponse vide d'OpenAI."}}(t):async function({apiKey:t,model:n,system:o,user:i,maxOutputTokens:a,thinkingConfig:s,timeoutMs:r,webSearch:c,responseMimeType:u,responseJsonSchema:l}){const d=function(e,t){return`https://generativelanguage.googleapis.com/v1beta/models/${encodeURIComponent(e)}:generateContent?key=${encodeURIComponent(t)}`}(n,t),m={contents:[{role:"user",parts:[{text:i}]}],generationConfig:{maxOutputTokens:a}};if(s&&"object"==typeof s&&(m.generationConfig.thinkingConfig=s),oe(o)){const e="application/json"===u||l?o+" You must return valid JSON.":o;m.systemInstruction={role:"system",parts:[{text:e}]}}u&&(m.generationConfig.responseMimeType=u),l&&(m.generationConfig.responseSchema=l),c&&(m.tools=[{google_search:{}}]);const p=await ge(d,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(m)},r),f=await Ee(p);if(!p.ok){const t=function(e){try{const t=e?.error?.message;return t?String(t):""}catch{return""}}(f)||`Gemini API error (${p.status}).`;return{ok:!1,provider:e.GEMINI,model:n,code:"API_ERROR",message:t}}const g=function(e){try{const t=e?.candidates?.[0],n=t?.content?.parts;return Array.isArray(n)?n.map(e=>e?.text||"").join(""):""}catch{return""}}(f),E=function(e){try{const t=e?.candidates?.[0],n=t?.groundingMetadata,o=n?.groundingChunks;if(!Array.isArray(o))return[];const i=[];for(const e of o){const t=e?.web;t?.uri&&i.push({title:t?.title||"",url:t.uri})}return fe(i)}catch{return[]}}(f),h=function(e){try{const t=e?.usageMetadata;return t?{inputTokens:pe(t?.promptTokenCount),outputTokens:pe(t?.candidatesTokenCount),reasoningTokens:pe(t?.thoughtsTokenCount),totalTokens:pe(t?.totalTokenCount),cachedInputTokens:pe(t?.cachedContentTokenCount)}:null}catch{return null}}(f);return oe(g)?{ok:!0,provider:e.GEMINI,model:n,text:g.trim(),sources:E,usage:h}:{ok:!1,provider:e.GEMINI,model:n,code:"EMPTY_RESPONSE",message:"RÃ©ponse vide de Gemini."}}(t);for(;t<=f;){t++;try{const e={apiKey:s,model:a,system:l,user:u,maxOutputTokens:I,reasoningEffort:A,thinkingConfig:T,timeoutMs:p,webSearch:m,responseMimeType:n?.responseMimeType,responseJsonSchema:n?.responseJsonSchema};let r=await d(e);if(!r.ok){let t=e;t.webSearch&&(ce(r.message)||"API_ERROR"===r.code||"EMPTY_RESPONSE"===r.code)&&(t={...t,webSearch:!1},r=await d(t));const n=t.responseMimeType||t.responseJsonSchema;!r.ok&&n&&(re(r.message)||"API_ERROR"===r.code||"EMPTY_RESPONSE"===r.code)&&(t={...t,responseMimeType:void 0,responseJsonSchema:void 0,system:ue(t.system)},r=await d(t))}const f=me(r?.usage),g=r.ok?le(c,r.text):"";return Q({fn:c,provider:i,model:a,ok:r.ok,ms:O()-o,attempt:t,cache:!1,inputTokens:f.inputTokens,outputTokens:f.outputTokens,reasoningTokens:f.reasoningTokens,cachedInputTokens:f.cachedInputTokens,totalTokens:f.totalTokens,code:r.code,message:r.message,formula:g||void 0}),r.ok&&b&&(W.set(R,r,1e3*x),await F(R,r,1e3*x,{provider:i,model:a})),r}catch(e){r=e,t<=f&&await M(250*t)}}const g=r?.message?String(r.message):"Erreur inconnue.";return Q({fn:c,provider:i,model:a,ok:!1,ms:O()-o,cache:!1,code:"API_ERROR",message:g}),{ok:!1,provider:i,model:a,code:"API_ERROR",message:g}})()}finally{te--;const e=ne.shift();e&&e()}}();ee.set(R,G);try{return await G}finally{ee.delete(R)}}function me(e){if(!e||"object"!=typeof e)return{inputTokens:0,outputTokens:0,reasoningTokens:0,totalTokens:0,cachedInputTokens:0};const t=pe(e.inputTokens),n=pe(e.outputTokens),o=pe(e.reasoningTokens),i=pe(e.cachedInputTokens),a=pe(e.totalTokens),s=t+n+o;return{inputTokens:t,outputTokens:n,reasoningTokens:o,totalTokens:Math.max(a,s),cachedInputTokens:i}}function pe(e){const t=Number(e);return!Number.isFinite(t)||t<=0?0:Math.floor(t)}function fe(e){const t=new Set,n=[];for(const o of e||[]){const e=String(o?.url||"").trim();if(!e)continue;const i=e.toLowerCase();t.has(i)||(t.add(i),n.push({title:String(o?.title||"").trim(),url:e}))}return n}async function ge(e,t,n){const o=ae(n);if("undefined"==typeof AbortController)return await fetch(e,t);const i=new AbortController,a=setTimeout(()=>i.abort(),o);try{return await fetch(e,{...t,signal:i.signal})}finally{clearTimeout(a)}}async function Ee(e){try{return await e.json()}catch{return{}}}function he(e){return document.getElementById(e)}function ye(e,t){if(he("statusLine").textContent=e||"",t)try{he("statusDetails").textContent=JSON.stringify(t,null,2)}catch{he("statusDetails").textContent=String(t)}else he("statusDetails").textContent=""}function Ie(e){const t=Number(e);return Number.isFinite(t)?Math.round(t).toLocaleString("en-US"):"0"}const _e="â‚¬";function we(e){const t=Number(e);return Number.isFinite(t)?`${_e}${t.toFixed(4)}`:`${_e}0.0000`}function Ne(e){const t=Number(e);return Number.isFinite(t)?`${(t/1e3).toFixed(2)}s`:"0.00s"}function Ae(e){try{return new Date(e).toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"})}catch{return"--:--"}}const ke=["auto","minimal","low","medium","high"],ve=["none","minimal","low","medium","high"],Te="[data-help]";let Oe={gemini:"",openai:""};const Me={gemini:t.geminiModel,openai:t.openaiModel},Ce={gemini:[{id:"gemini-3-pro-preview",label:"Gemini 3 Pro Preview",prices:{input:2,output:12,cachedInput:.2},costLevel:3,reasoningLevel:3},{id:"gemini-3-flash-preview",label:"Gemini 3 Flash Preview",prices:{input:.5,output:3,cachedInput:.05},costLevel:2,reasoningLevel:2,recommended:!0},{id:"gemini-2.5-flash-lite",label:"Gemini 2.5 Flash Lite",prices:{input:.1,output:.4,cachedInput:.01},costLevel:1,reasoningLevel:1}],openai:[{id:"gpt-5.2",label:"GPT-5.2",prices:{input:1.75,output:14,cachedInput:.175},costLevel:3,reasoningLevel:3,supportsReasoningNone:!0},{id:"gpt-5-mini",label:"GPT-5 Mini",prices:{input:.25,output:2,cachedInput:.025},costLevel:2,reasoningLevel:2,recommended:!0,supportsReasoningNone:!1},{id:"gpt-5-nano",label:"GPT-5 Nano",prices:{input:.05,output:.4,cachedInput:.005},costLevel:1,reasoningLevel:1,supportsReasoningNone:!1}]},be={gemini:new Map(Ce.gemini.map(e=>[e.id.toLowerCase(),e])),openai:new Map(Ce.openai.map(e=>[e.id.toLowerCase(),e]))},Se={gemini:"Gemini",openai:"OpenAI"};function xe(e,t){const n=Math.max(1,Number(t)||1);return new Array(n+1).join(e)}function Le(e,t){const n=he("geminiReasoningEffort");if(!n)return"";const o=function(e){const t=String(e||"").trim().toLowerCase();return t.includes("gemini-3")&&t.includes("flash")?["auto","minimal","low","medium","high"]:t.includes("gemini-3")?["auto","low","high"]:t.includes("gemini-2.5")?["auto","minimal","low","medium","high"]:["auto","low","high"]}(e);let i=Pe(t,ke);i||(i=ke[0]),o.includes(i)||("minimal"===i&&(i="low"),"medium"===i&&(i="high")),i=function(e,t,n){if(!e)return t[0]||"";if(t.includes(e))return e;const o=n.indexOf(e);if(o<0)return t[0]||"";let i=t[0]||"",a=Number.POSITIVE_INFINITY;for(const e of t){const t=n.indexOf(e);if(t<0)continue;const s=Math.abs(t-o);s<a&&(a=s,i=e)}return i}(i,o,ke);const a=ke.indexOf(i);return n.value=String(a>=0?a:0),n.setAttribute("aria-valuetext",i),i}function Pe(e,t=ve){const n=String(e||"").trim().toLowerCase();if(!n)return"";const o=Number(n);return Number.isFinite(o)?t[Math.min(t.length-1,Math.max(0,Math.round(o)))]||"":n}function Re(e,t){const n=he("openaiReasoningEffort");if(!n)return"";const o=function(e){const t=String(e||"").trim().toLowerCase(),n=be.openai?.get(t);return!n||"boolean"!=typeof n.supportsReasoningNone||n.supportsReasoningNone}(e),i=n.closest(".reasoning");i&&i.classList.toggle("reasoning--no-none",!o),n.dataset.allowNone=o?"1":"0";const a=o?ve:ve.slice(1);let s=Pe(t);a.includes(s)||(s=a[0]||"minimal");const r=ve.indexOf(s);return n.value=String(r>=0?r:0),n.setAttribute("aria-valuetext",s),s}function Ge(e){const t=Number(e);if(!Number.isFinite(t))return`${_e}0`;const n=t>=1?2:3;let o=t.toFixed(n);return o=o.replace(/\.?0+$/,""),`${_e}${o}`}function Ke(e){return{cost:xe("$",e.costLevel),reasoning:xe("ðŸ§ ",e.reasoningLevel)}}function De(e){const t=Ke(e);return`${e.recommended?"â˜… ":""}${e.id} | ${t.cost} | ${t.reasoning}`}function Fe(e){if(!e)return 0;const t=function(e,t){const n=String(e||"").toLowerCase(),o=String(t||"").trim().toLowerCase(),i=be[n];if(i&&o&&i.has(o))return i.get(o);const a=Me[n];return i&&a&&i.has(a.toLowerCase())?i.get(a.toLowerCase()):null}(String(e.provider||"").toLowerCase(),e.model);if(!t)return 0;const n=Math.max(0,Number(e.inputTokens||0)),o=Math.max(0,Number(e.outputTokens||0)),i=Math.max(0,Number(e.reasoningTokens||0)),a=Math.max(0,Number(e.cachedInputTokens||0)),s=o+i,r=Math.min(a,n),c=Math.max(0,n-r),u=t.prices||{};return c/1e6*Number(u.input||0)+r/1e6*Number(u.cachedInput??u.input??0)+s/1e6*Number(u.output||0)}function Ue(e){return{provider:e?.provider||"",inputTokens:Number(e?.inputTokens||0),outputTokens:Number(e?.outputTokens||0),reasoningTokens:Number(e?.reasoningTokens||0),cachedInputTokens:Number(e?.cachedInputTokens||0),totalTokens:Number(e?.totalTokens||0),ok:!!e?.ok,cache:!!e?.cache,ms:Number(e?.ms||0),fn:e?.fn||"AI",model:e?.model||"",ts:Number(e?.ts||0),message:e?.message||"",formula:e?.formula||""}}function Ve(e,t,n){if(!t)return;const o=Ce[e]||[],i=String(n||"").trim(),a=i.toLowerCase(),s=Me[e]||"";t.innerHTML="";let r=!1;for(const e of o){const n=document.createElement("option");n.value=e.id,n.textContent=De(e),e.id.toLowerCase()===a&&(n.selected=!0,r=!0),t.appendChild(n)}if(i&&!r){const e=document.createElement("option");return e.value=i,e.textContent=`${i} | hors liste`,e.selected=!0,void t.appendChild(e)}!i&&s&&(t.value=s)}function $e(e,t){const n=he(e);n&&(n.classList.toggle("is-open",t),n.setAttribute("aria-hidden",t?"false":"true"))}function Ye(e){const t=he(e);return!!t&&t.classList.contains("is-open")}function je(e){$e("pricingModal",e)}function Be(e){$e("onboardingModal",e)}function Je(e){$e("onboardingKeysModal",e)}function ze(){je(!1)}function Xe(e,t){const n=he(e);if(!n)return;const o=!!t;n.textContent=o?"ClÃ© enregistrÃ©e":"ClÃ© manquante",n.classList.toggle("key-status--ok",o),n.classList.toggle("key-status--missing",!o)}function He(){const e=!Oe.gemini&&!Oe.openai;document.querySelectorAll("[data-key-alert]").forEach(t=>{t.classList.toggle("is-hidden",!e)})}function qe(){const e=he("geminiKey"),t=he("openaiKey");e&&(e.placeholder=Oe.gemini?"ClÃ© enregistrÃ©e (laisser vide pour conserver)":"AIza..."),t&&(t.placeholder=Oe.openai?"ClÃ© enregistrÃ©e (laisser vide pour conserver)":"sk-...")}function Qe(e){const t=Number(e);return Number.isFinite(t)?Math.min(17,Math.max(7,Math.round(t))):7}function We(e){return 2**Qe(e)}function Ze(t){const n=t===e.GEMINI;he("providerGemini").classList.toggle("segmented__btn--active",n),he("providerOpenAI").classList.toggle("segmented__btn--active",!n),he("providerGemini").setAttribute("aria-pressed",n?"true":"false"),he("providerOpenAI").setAttribute("aria-pressed",n?"false":"true")}function et(e){const t="gemini"===e;he("tabGemini").classList.toggle("tab--active",t),he("tabOpenAI").classList.toggle("tab--active",!t),he("tabGemini").setAttribute("aria-selected",t?"true":"false"),he("tabOpenAI").setAttribute("aria-selected",t?"false":"true"),he("panelGemini").classList.toggle("tab-panel--active",t),he("panelOpenAI").classList.toggle("tab-panel--active",!t)}async function tt(t={}){const{preserveKeyInputs:n=!1,silent:o=!1}=t;he("storageBackend").textContent=a().kind;const[i,s,r,c,u,l,d,m]=await Promise.all([E(),v(),_(e.GEMINI),_(e.OPENAI),y(e.GEMINI),y(e.OPENAI),w(),N()]);Ze(i);const p=function(e){const t=Number(e);return!Number.isFinite(t)||t<=0?7:Qe(Math.log2(t))}(s),f=We(p);he("maxTokensRange").value=String(p),he("maxTokensValue").textContent=Ie(f),f!==s&&await T(f);const g=he("geminiModel"),h=he("openaiModel");Ve(e.GEMINI,g,r),Ve(e.OPENAI,h,c);const I=g?g.value:r,O=h?h.value:c,M=Le(I,d);M&&M!==d&&await k(M);const C=Re(O,m),b=C||m;var S;C&&C!==m&&await A(C),n||(he("geminiKey").value="",he("openaiKey").value=""),S=l,Oe={gemini:(u||"").trim(),openai:(S||"").trim()},qe(),He(),Xe("geminiKeyStatus",u),Xe("openaiKeyStatus",l),o||ye("Configuration chargÃ©e.",{defaultProvider:i,maxOutputTokens:f,gemini:{key:u?"set":"missing",model:r,reasoningEffort:M},openai:{key:l?"set":"missing",model:c,reasoningEffort:b}})}function nt(e,t,n,o){const i=document.createElement("div");i.className="breakdown__row "+(o?"breakdown__row--sub":"breakdown__row--total");const a=document.createElement("div");if(a.className="breakdown__name",o){const t=document.createElement("span");t.className="breakdown__model",t.textContent=e,a.appendChild(t)}else a.textContent=e;const s=document.createElement("div");s.className="breakdown__tokens",s.textContent=`${Ie(t)} tokens`;const r=document.createElement("div");return r.className="breakdown__cost",r.textContent=we(n),i.appendChild(a),i.appendChild(s),i.appendChild(r),i}async function ot(){const t=(await async function(e={}){const t=!!e?.fresh,n=O();return t||!j||n-B>1500?await X(!0):await X(!1),$.slice()}({fresh:!0})).map(Ue).sort((e,t)=>t.ts-e.ts),n={gemini:{tokens:0,cost:0,models:new Map},openai:{tokens:0,cost:0,models:new Map}},o={inputTokens:0,reasoningTokens:0,outputTokens:0,cachedInputTokens:0,cost:0,requests:t.length,byProvider:{gemini:{tokens:0,cost:0},openai:{tokens:0,cost:0}}};for(const e of t){const t=Math.max(0,e.inputTokens),i=Math.max(0,e.reasoningTokens),a=Math.max(0,e.outputTokens),s=t+i+a,r=Fe(e);o.inputTokens+=t,o.reasoningTokens+=i,o.outputTokens+=a,o.cachedInputTokens+=Math.max(0,e.cachedInputTokens||0),o.cost+=r;const c=n[String(e.provider||"").toLowerCase()];if(c&&(c.tokens+=s,c.cost+=r,s>0||r>0)){const t=String(e.model||"").trim()||"modele inconnu",n=t.toLowerCase(),o=c.models.get(n)||{label:t,tokens:0,cost:0};o.tokens+=s,o.cost+=r,c.models.set(n,o)}}o.byProvider.gemini.tokens=n.gemini.tokens,o.byProvider.gemini.cost=n.gemini.cost,o.byProvider.openai.tokens=n.openai.tokens,o.byProvider.openai.cost=n.openai.cost,he("usageTokensTotal").textContent=Ie(o.inputTokens+o.reasoningTokens+o.outputTokens),he("usageTokensInTotal").textContent=Ie(o.inputTokens),he("usageTokensReasoningTotal").textContent=Ie(o.reasoningTokens),he("usageTokensOutTotal").textContent=Ie(o.outputTokens),he("usageCostTotal").textContent=we(o.cost),he("usageCostGemini").textContent=we(o.byProvider.gemini.cost),he("usageCostOpenAI").textContent=we(o.byProvider.openai.cost),function(t){const n=he("usageBreakdown");if(!n)return;n.innerHTML="";const o=[e.GEMINI,e.OPENAI];for(const e of o){const o=t[e]||{tokens:0,cost:0,models:new Map};n.appendChild(nt(Se[e]||e,o.tokens,o.cost,!1));const i=Array.from(o.models.values()).filter(e=>(e.tokens||0)>0||(e.cost||0)>0).sort((e,t)=>t.tokens-e.tokens||e.label.localeCompare(t.label));for(const e of i)n.appendChild(nt(e.label,e.tokens,e.cost,!0))}}(n),function(e){const t=he("logList");if(t.innerHTML="",!e.length){const e=document.createElement("div");return e.className="log-item",e.textContent="Aucune activitÃ© enregistrÃ©e pour le moment.",void t.appendChild(e)}const n=(e,t)=>{const n=document.createElement("span");n.className="token-flow";const o=document.createElement("span");o.className="token-flow__icon",o.textContent=e;const i=document.createElement("span");return i.className="token-flow__value",i.textContent=Ie(t),n.appendChild(o),n.appendChild(i),n},o=e.slice(0,40);for(const e of o){const o=document.createElement("div"),i=e.cache?" log-item--cache":"";o.className=`log-item ${e.ok?"log-item--ok":"log-item--error"}${i}`;const a=document.createElement("div");a.className="log-item__top";const s=document.createElement("div");s.className="log-item__title";const r=document.createElement("span");r.className="log-item__title-text",r.textContent=e.fn,s.appendChild(r);const c=String(e.formula||"").trim();let u=null;if(c){const e=document.createElement("button");e.className="log-item__toggle",e.type="button",e.setAttribute("aria-expanded","false"),e.setAttribute("aria-label","Afficher la formule");const t=document.createElement("span");t.className="log-item__chevron",e.appendChild(t),e.addEventListener("click",()=>{const t=o.classList.toggle("log-item--expanded");e.setAttribute("aria-expanded",t?"true":"false"),e.setAttribute("aria-label",t?"Masquer la formule":"Afficher la formule")}),s.appendChild(e),u=document.createElement("div"),u.className="log-item__detail",u.textContent=c}const l=document.createElement("div");l.style.display="flex",l.style.gap="6px";const d=document.createElement("span");d.className="tag",d.textContent=e.provider?e.provider.toUpperCase():"â€”",l.appendChild(d);const m=document.createElement("span");if(m.className="tag "+(e.ok?"":"tag--error"),m.textContent=e.ok?"OK":"Erreur",l.appendChild(m),e.cache){const e=document.createElement("span");e.className="tag tag--cache",e.textContent="Cache",l.appendChild(e)}a.appendChild(s),a.appendChild(l);const p=document.createElement("div");p.className="log-item__meta";const f=Math.max(0,e.inputTokens+e.reasoningTokens+e.outputTokens),g=e.model?e.model:"",E=Ne(e.ms),h=document.createElement("div");if(h.className="log-item__info",!e.ok&&e.message?h.textContent=`${E} Â· ${e.message.slice(0,60)}`:h.textContent=`${Ae(e.ts)} Â· ${E}${g?` Â· ${g}`:""}`,e.cache){const e=document.createElement("div");e.className="log-item__cache",e.textContent="Cache local",p.appendChild(e)}else{const t=document.createElement("div");t.className="log-item__tokens";const o=document.createElement("div");o.className="log-item__tokens-line";const i=document.createElement("span");i.className=`log-item__heat ${it(f)}`;const a=document.createElement("span");a.className="log-item__tokens-total",a.textContent=`${Ie(f)} tokens`;const s=document.createElement("span");s.className="log-item__tokens-detail",s.appendChild(document.createTextNode("(")),s.appendChild(n("IN",e.inputTokens)),s.appendChild(document.createTextNode(" / ")),s.appendChild(n("REF",e.reasoningTokens)),s.appendChild(document.createTextNode(" / ")),s.appendChild(n("OUT",e.outputTokens)),s.appendChild(document.createTextNode(")")),o.appendChild(i),o.appendChild(a),o.appendChild(s),t.appendChild(o),p.appendChild(t)}p.appendChild(h),o.appendChild(a),u&&o.appendChild(u),o.appendChild(p),t.appendChild(o)}}(t),function(e){const t=he("usageChart");if(!t)return;const n=t.getContext("2d");if(!n)return;const o=t.clientWidth||320,i=t.clientHeight||140,a=window.devicePixelRatio||1;t.width=o*a,t.height=i*a,n.setTransform(a,0,0,a,0,0);const s=Date.now()-36e5,r=new Array(60).fill(0);for(const t of e){if(!t.ts||t.ts<s)continue;const e=Math.floor((t.ts-s)/6e4);e>=0&&e<r.length&&(r[e]+=Math.max(0,t.inputTokens+t.reasoningTokens+t.outputTokens))}const c=Math.max(...r,1),u=getComputedStyle(document.documentElement).getPropertyValue("--accent-2").trim()||"#2a9d8f";n.clearRect(0,0,o,i),n.strokeStyle="rgba(38, 70, 83, 0.12)",n.lineWidth=1;for(let e=1;e<=3;e++){const t=i/4*e;n.beginPath(),n.moveTo(0,t),n.lineTo(o,t),n.stroke()}n.beginPath(),r.forEach((e,t)=>{const a=t/(r.length-1)*o,s=i-e/c*(i-12)-6;0===t?n.moveTo(a,s):n.lineTo(a,s)});const l=n.createLinearGradient(0,0,0,i);l.addColorStop(0,"rgba(42, 157, 143, 0.35)"),l.addColorStop(1,"rgba(42, 157, 143, 0.02)"),n.lineWidth=2,n.strokeStyle=u,n.stroke(),n.lineTo(o,i),n.lineTo(0,i),n.closePath(),n.fillStyle=l,n.fill()}(t)}function it(e){const t=Number(e||0);return t>=8e3?"token-heat--extreme":t>=4e3?"token-heat--hot":t>=1500?"token-heat--warm":"token-heat--cool"}async function at(){const t=await async function(){const t=G(await P(),await L());if(t.removedKeys.length){for(const e of t.removedKeys)await K(e);await R(t.list)}const n={entries:0,sizeBytes:0,providers:{gemini:{entries:0,sizeBytes:0},openai:{entries:0,sizeBytes:0}},oldestMs:null,newestMs:null};for(const o of t.list||[]){if(!o?.key)continue;n.entries+=1,n.sizeBytes+=Number(o.size||0);const t=String(o.provider||"").toLowerCase();t===e.GEMINI?(n.providers.gemini.entries+=1,n.providers.gemini.sizeBytes+=Number(o.size||0)):t===e.OPENAI&&(n.providers.openai.entries+=1,n.providers.openai.sizeBytes+=Number(o.size||0));const i=Number(o.savedAtMs||0);i&&(n.oldestMs=null==n.oldestMs?i:Math.min(n.oldestMs,i),n.newestMs=null==n.newestMs?i:Math.max(n.newestMs,i))}return n}();he("cacheEntries").textContent=Ie(t.entries),he("cacheSize").textContent=function(e){const t=Number(e);return!Number.isFinite(t)||t<=0?"0 KB":t<1024?`${t} B`:t<1048576?`${(t/1024).toFixed(1)} KB`:`${(t/1048576).toFixed(2)} MB`}(t.sizeBytes),he("cacheGeminiEntries").textContent=Ie(t.providers.gemini.entries),he("cacheOpenAIEntries").textContent=Ie(t.providers.openai.entries)}async function st(o={}){const{silent:i=!1,message:a="Configuration enregistrÃ©e."}=o,s=he("providerGemini").classList.contains("segmented__btn--active")?e.GEMINI:e.OPENAI,r=We(Qe(he("maxTokensRange").value)),u=await async function(e){const o=d(e)||t.provider;return await c(n.DEFAULT_PROVIDER,o),o}(s),l=await T(r);return i||ye(a,{defaultProvider:u,maxOutputTokens:l}),{savedProvider:u,savedTokens:l}}function rt(){document.querySelectorAll(Te).forEach(e=>{e.classList.remove("is-open");const t=e.querySelector("button");t&&t.setAttribute("aria-expanded","false")})}async function ct(e,t){const n=(t||"").trim();return n?(await async function(e,t){const n=(t||"").trim();return await c(h(e),n),n}(e,n),Oe[e]=n,qe(),He(),n):""}async function ut(e,t,n){const o=await ct(e,t?.value||"");o&&(t&&(t.value=""),n&&Xe(n,o),ye("ClÃ© enregistrÃ©e.",{provider:e}))}async function lt(n){const o=n===e.GEMINI,i=he(o?"geminiModel":"openaiModel");if(!i)return;const a=(i.value||"").trim();await async function(n,o){const i=d(n),a=String(o||"").trim();a?await c(I(i),a):await c(I(i),i===e.OPENAI?t.openaiModel:t.geminiModel)}(n,a);let s="";if(o){const e=he("geminiReasoningEffort");s=Le(a,e?e.value:""),s&&await k(s)}else{const e=he("openaiReasoningEffort");s=Re(a,e?e.value:""),s&&await A(s)}ye("Configuration enregistrÃ©e.",{provider:n,model:a,reasoningEffort:s||void 0})}async function dt(e=!0){e&&await async function(e=!0){return await c(n.ONBOARDING_SEEN,e?"1":"0"),e}(!0),Je(!1),Be(!1)}async function mt(e){await async function(e){await u(h(e))}(e),await tt({silent:!0}),ye("ClÃ© effacÃ©e.",{provider:e})}async function pt(e){ye("Test en coursâ€¦",{provider:e});const t=await async function(e){const t=d(e)||await E(),n=await _(t);return await y(t)?await de({provider:t,system:"You are a test endpoint. Reply with exactly: OK",user:"OK",maxOutputTokens:500,cache:!1,webSearch:!1,functionName:"AI.MINIMAL_TEST"}):{ok:!1,provider:t,model:n,code:"API_KEY_MISSING",message:`ClÃ© API manquante pour le fournisseur ${t}.`}}(e);t.ok?ye("OK",{provider:t.provider,model:t.model,response:t.text}):ye("Ã‰chec",{provider:t.provider,model:t.model,error:t.message,code:t.code})}async function ft(){document.querySelectorAll("[data-collapse-toggle]").forEach(e=>{const t=e.getAttribute("aria-controls"),n=e.closest("[data-collapsible]");if(!t||!n)return;if(!document.getElementById(t))return;const o=n.classList.contains("is-collapsed");e.setAttribute("aria-expanded",o?"false":"true"),e.addEventListener("click",()=>{const t=!n.classList.contains("is-collapsed");n.classList.toggle("is-collapsed",t),e.setAttribute("aria-expanded",t?"false":"true")})}),function(){let e=!1;const t=()=>{e||(e=!0,setTimeout(async()=>{e=!1,await ot(),await at()},250))};try{if("undefined"!=typeof OfficeRuntime&&OfficeRuntime?.storage?.onChanged){const e=OfficeRuntime.storage.onChanged;"function"==typeof e.add?e.add(()=>t()):"function"==typeof e.addListener?e.addListener(()=>t()):"function"==typeof e&&e(()=>t())}}catch{}try{window.addEventListener("storage",()=>t())}catch{}}(),document.querySelectorAll(Te).forEach(e=>{const t=e.querySelector("button");t&&(t.setAttribute("aria-expanded","false"),t.addEventListener("click",n=>{n.stopPropagation();const o=e.classList.contains("is-open");rt();const i=!o;e.classList.toggle("is-open",i),t.setAttribute("aria-expanded",i?"true":"false")}))}),document.addEventListener("click",e=>{e.target.closest(Te)||rt()});const t=he("pricingHelp");t&&t.addEventListener("click",()=>(function(){const t=he("pricingTableBodyGemini"),n=he("pricingTableBodyOpenAI");if(!t&&!n)return;t&&(t.innerHTML=""),n&&(n.innerHTML="");const o=(e,t)=>{if(!t)return;const n=Ce[e]||[];for(const e of n){const n=document.createElement("tr"),o=Ke(e),i=document.createElement("td");i.textContent=e.id;const a=document.createElement("td");a.className="pricing-table__col-price",a.textContent=Ge(e.prices?.input);const s=document.createElement("td");s.className="pricing-table__col-price",s.textContent=Ge(e.prices?.output);const r=document.createElement("td");r.className="pricing-table__col-icon",r.textContent=o.cost;const c=document.createElement("td");c.className="pricing-table__col-icon",c.textContent=o.reasoning,n.appendChild(i),n.appendChild(a),n.appendChild(s),n.appendChild(r),n.appendChild(c),t.appendChild(n)}};o(e.GEMINI,t),o(e.OPENAI,n)}(),void je(!0))),document.querySelectorAll("[data-modal-close]").forEach(e=>{e.addEventListener("click",()=>ze())}),document.querySelectorAll("[data-onboarding-close]").forEach(e=>{e.addEventListener("click",async()=>dt(!0))}),document.querySelectorAll("[data-onboarding-keys-close]").forEach(e=>{e.addEventListener("click",()=>Je(!1))});const o=he("onboardingClose");o&&o.addEventListener("click",async()=>dt(!0));const i=he("onboardingDone");i&&i.addEventListener("click",async()=>dt(!0));const a=he("onboardingKeysButton");a&&a.addEventListener("click",()=>Je(!0));const s=he("onboardingKeysSave");s&&s.addEventListener("click",async()=>async function(){const t=he("onboardingGeminiKey"),n=he("onboardingOpenAIKey"),o=await ct(e.GEMINI,t?.value||""),i=await ct(e.OPENAI,n?.value||"");t&&(t.value=""),n&&(n.value=""),Xe("geminiKeyStatus",Oe.gemini),Xe("openaiKeyStatus",Oe.openai),(o||i)&&ye("ClÃ©s enregistrÃ©es.",{gemini:!!o,openai:!!i}),(Oe.gemini||Oe.openai)&&Je(!1)}());const d=he("onboardingKeysLater");d&&d.addEventListener("click",()=>Je(!1)),document.querySelectorAll("[data-key-alert]").forEach(e=>{e.addEventListener("click",()=>Je(!0)),e.addEventListener("keydown",e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),Je(!0))})}),document.addEventListener("keydown",async e=>{"Escape"===e.key&&(rt(),Ye("onboardingKeysModal")?Je(!1):Ye("onboardingModal")?await dt(!0):Ye("pricingModal")&&ze())}),he("tabGemini").addEventListener("click",()=>et("gemini")),he("tabOpenAI").addEventListener("click",()=>et("openai")),he("providerGemini").addEventListener("click",async()=>{Ze(e.GEMINI),await st()}),he("providerOpenAI").addEventListener("click",async()=>{Ze(e.OPENAI),await st()}),he("maxTokensRange").addEventListener("input",()=>{!function(){const e=We(Qe(he("maxTokensRange").value));he("maxTokensValue").textContent=Ie(e)}()}),he("maxTokensRange").addEventListener("change",async()=>{await st()});const m=he("geminiReasoningEffort");m&&(m.addEventListener("input",()=>{const e=he("geminiModel");Le(e?e.value:"",m.value)}),m.addEventListener("change",async()=>{await async function(){const e=he("geminiModel"),t=he("geminiReasoningEffort");if(!t)return;const n=Le(e?e.value:"",t.value);n&&await k(n),ye("Effort de raisonnement enregistrÃ©.",{geminiReasoningEffort:n})}()}));const p=he("openaiReasoningEffort");p&&(p.addEventListener("input",()=>{const e="0"!==p.dataset.allowNone;let t=Pe(p.value);e||"none"!==t||(p.value="1",t=Pe(p.value)),p.setAttribute("aria-valuetext",t)}),p.addEventListener("change",async()=>{await async function(){const e=he("openaiModel"),t=he("openaiReasoningEffort");if(!t)return;const n=Re(e?e.value:"",t.value);n&&await A(n),ye("Effort de raisonnement enregistrÃ©.",{openaiReasoningEffort:n})}()}));const f=he("geminiModel");f&&f.addEventListener("change",async()=>{await lt(e.GEMINI)});const g=he("openaiModel");g&&g.addEventListener("change",async()=>{await lt(e.OPENAI)});const E=he("geminiKey");E&&E.addEventListener("change",async()=>{await ut(e.GEMINI,E,"geminiKeyStatus")});const h=he("openaiKey");h&&h.addEventListener("change",async()=>{await ut(e.OPENAI,h,"openaiKeyStatus")}),he("clearGemini").addEventListener("click",async()=>mt(e.GEMINI)),he("clearOpenAI").addEventListener("click",async()=>mt(e.OPENAI)),he("testGemini").addEventListener("click",async()=>pt(e.GEMINI)),he("testOpenAI").addEventListener("click",async()=>pt(e.OPENAI)),he("clearLogs").addEventListener("click",async()=>{await async function(){const e=O();$=[],j=!0,Y=null,J=e,B=e,await c(n.REQUEST_LOG_CLEAR_AT,String(e)),await u(n.REQUEST_LOG)}(),await ot(),ye("Journal effacÃ©.",{ok:!0})}),he("refreshCache").addEventListener("click",async()=>{await at(),ye("Cache actualisÃ©.",{ok:!0})}),he("clearCache").addEventListener("click",async()=>{await async function(){W.clear(),await async function(){const e=O();x=e,await c(n.CACHE_CLEAR_AT,String(e));const t=await P();for(const e of t||[])e?.key&&await K(e.key);await u(n.CACHE_INDEX)}()}(),await at(),ye("Cache vidÃ©.",{ok:!0})}),et("gemini"),await tt(),await ot(),await at(),await async function(){await async function(){return await l(),"1"===await r(n.ONBOARDING_SEEN)}()||Be(!0)}(),setInterval(ot,2e3),setInterval(at,12e3)}document.addEventListener("DOMContentLoaded",async()=>{await async function(){try{"undefined"!=typeof Office&&Office?.onReady&&await Office.onReady()}catch{}}(),await ft()})})();
//# sourceMappingURL=taskpane.js.map