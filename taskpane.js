(()=>{"use strict";const e=Object.freeze({GEMINI:"gemini",OPENAI:"openai"}),t=Object.freeze({provider:e.GEMINI,geminiModel:"gemini-3-flash-preview",openaiModel:"gpt-5-mini",geminiReasoningEffort:"minimal",openaiReasoningEffort:"low",maxOutputTokens:4096,retry:2,timeoutMs:12e4,cache:!0,cacheTtlSec:604800,webCacheTtlSec:3600}),n=Object.freeze({DEFAULT_PROVIDER:"AI_DEFAULT_PROVIDER_V3",GEMINI_API_KEY:"AI_GEMINI_API_KEY_V3",OPENAI_API_KEY:"AI_OPENAI_API_KEY_V3",GEMINI_MODEL:"AI_GEMINI_MODEL_V3",OPENAI_MODEL:"AI_OPENAI_MODEL_V3",GEMINI_REASONING_EFFORT:"AI_GEMINI_REASONING_EFFORT_V3",OPENAI_REASONING_EFFORT:"AI_OPENAI_REASONING_EFFORT_V3",MAX_OUTPUT_TOKENS:"AI_MAX_OUTPUT_TOKENS_V3",ONBOARDING_SEEN:"AI_ONBOARDING_SEEN_V1",ONBOARDING_KEYS_CONFIRMED:"AI_ONBOARDING_KEYS_CONFIRMED_V1",SECTION_ORDER:"AI_SECTION_ORDER_V1",SECTION_HIDDEN:"AI_SECTION_HIDDEN_V1",LICENSE:"AI_LICENSE_V1",PRIVACY_MODE:"AI_PRIVACY_MODE_V1",MIGRATION_DONE:"AI_MIGRATION_DONE_V3",REQUEST_LOG:"AI_REQUEST_LOG_V1",REQUEST_LOG_CLEAR_AT:"AI_REQUEST_LOG_CLEAR_AT_V1",CACHE_INDEX:"AI_CACHE_INDEX_V1",CACHE_CLEAR_AT:"AI_CACHE_CLEAR_AT_V1"}),i=new Set([n.GEMINI_API_KEY,n.OPENAI_API_KEY,n.LICENSE]),o=Object.freeze({GEMINI_API_KEY:"GEMINI_API_KEY",MAX_OUTPUT_TOKENS:"MAX_OUTPUT_TOKENS",DEFAULT_PROVIDER_V2:"AI_DEFAULT_PROVIDER_V2",GEMINI_API_KEY_V2:"AI_GEMINI_API_KEY_V2",OPENAI_API_KEY_V2:"AI_OPENAI_API_KEY_V2",GEMINI_MODEL_V2:"AI_GEMINI_MODEL_V2",OPENAI_MODEL_V2:"AI_OPENAI_MODEL_V2",GEMINI_MAX_TOKENS_V2:"AI_GEMINI_MAX_OUTPUT_TOKENS_V2",OPENAI_MAX_TOKENS_V2:"AI_OPENAI_MAX_OUTPUT_TOKENS_V2"});let a=null,s=!1,r=null,c=0;function u(){s=!0}function l(){if(!s)try{if("undefined"!=typeof OfficeRuntime&&OfficeRuntime?.storage?.getItem)return{kind:"office",storage:OfficeRuntime.storage}}catch{}try{if("undefined"!=typeof window&&window?.localStorage?.getItem)return{kind:"local",storage:window.localStorage}}catch{}const e=new Map;return{kind:"memory",storage:{getItem:async t=>e.has(t)?e.get(t):null,async setItem(t,n){e.set(t,String(n))},async removeItem(t){e.delete(t)}}}}function d(){try{if("undefined"!=typeof window&&window?.localStorage?.getItem)return window.localStorage}catch{return null}return null}function f(e,t){try{return e.getItem(t)}catch{return null}}function m(e,t,n){try{return e.setItem(t,n),!0}catch{return!1}}function p(e,t){try{return e.removeItem(t),!0}catch{return!1}}async function g(e,t={}){const{kind:n,storage:o}=l(),a=t.sensitive??function(e){return i.has(e)}(e),r=!1!==t.allowLocalFallback;if("local"===n)return f(o,e);if("office"===n){let t=null;try{t=await o.getItem(e)}catch{u()}if(null!=t){if(a){const t=d();t&&p(t,e)}return t}if(!r)return null;const n=d();if(!n)return null;const i=f(n,e);if(null==i)return null;if(!s)try{await o.setItem(e,String(i)),p(n,e)}catch{u()}return i}try{return await o.getItem(e)}catch{return null}}async function E(e,t,n={}){const{kind:i,storage:o}=l(),a=null==t?"":String(t),s=!1!==n.allowLocalFallback;if("local"!==i){if("office"===i){let t=!1;try{await o.setItem(e,a),t=!0}catch{u()}const n=d();if(t)return void(n&&p(n,e));if(!s||!n)return;return void m(n,e,a)}try{await o.setItem(e,a)}catch{}}else m(o,e,a)}async function y(e){const{kind:t,storage:n}=l();if("local"!==t){if("office"===t){let t=!1;try{await n.removeItem(e),t=!0}catch{u()}const i=d();return void(i&&p(i,e))}try{await n.removeItem(e)}catch{}}else p(n,e)}async function h(){if(a)return a;a=(async()=>{if("1"!==await g(n.MIGRATION_DONE)){if(!w(await g(n.DEFAULT_PROVIDER))){const e=w(await g(o.DEFAULT_PROVIDER_V2));await E(n.DEFAULT_PROVIDER,e||t.provider)}if(!await g(n.GEMINI_API_KEY)){const e=await g(o.GEMINI_API_KEY_V2)||await g(o.GEMINI_API_KEY);e&&await E(n.GEMINI_API_KEY,e)}if(!await g(n.OPENAI_API_KEY)){const e=await g(o.OPENAI_API_KEY_V2);e&&await E(n.OPENAI_API_KEY,e)}if(!await g(n.GEMINI_MODEL)){const e=await g(o.GEMINI_MODEL_V2);await E(n.GEMINI_MODEL,e||t.geminiModel)}if(!await g(n.OPENAI_MODEL)){const e=await g(o.OPENAI_MODEL_V2);await E(n.OPENAI_MODEL,e||t.openaiModel)}if(!await g(n.MAX_OUTPUT_TOKENS)){const e=[await g(o.MAX_OUTPUT_TOKENS),await g(o.GEMINI_MAX_TOKENS_V2),await g(o.OPENAI_MAX_TOKENS_V2)].map(e=>parseInt(String(e||"").trim(),10)).filter(e=>Number.isFinite(e)&&e>0),i=e.length?Math.max(...e):t.maxOutputTokens;await E(n.MAX_OUTPUT_TOKENS,String(i))}await E(n.MIGRATION_DONE,"1")}})();try{await a}finally{a=null}}function w(t){if(!t)return"";const n=String(t).trim().toLowerCase();return n===e.GEMINI?e.GEMINI:n===e.OPENAI?e.OPENAI:"google"===n||"gem"===n?e.GEMINI:"oai"===n||"chatgpt"===n?e.OPENAI:""}const I=new Set(["auto","minimal","low","medium","high"]),A=new Set(["none","minimal","low","medium","high"]);function v(e){const n=String(e||"").trim().toLowerCase();return n&&I.has(n)?n:t.geminiReasoningEffort}function _(e){const n=String(e||"").trim().toLowerCase();return n&&A.has(n)?n:t.openaiReasoningEffort}async function N(){return await h(),w(await g(n.DEFAULT_PROVIDER))||t.provider}function k(t){return w(t)===e.OPENAI?n.OPENAI_API_KEY:n.GEMINI_API_KEY}async function T(e){return await h(),(await g(k(e))||"").trim()}async function O(e){return!!await T(e)}function C(t){return w(t)===e.OPENAI?n.OPENAI_MODEL:n.GEMINI_MODEL}async function b(n){await h();const i=w(n),o=await g(C(i));return o&&String(o).trim()?String(o).trim():i===e.OPENAI?t.openaiModel:t.geminiModel}async function S(){return await h(),v(await g(n.GEMINI_REASONING_EFFORT)||t.geminiReasoningEffort)}async function M(){return await h(),_(await g(n.OPENAI_REASONING_EFFORT)||t.openaiReasoningEffort)}async function L(e){const t=_(e);return await E(n.OPENAI_REASONING_EFFORT,t),t}async function x(e){const t=v(e);return await E(n.GEMINI_REASONING_EFFORT,t),t}async function P(){await h();const e=await g(n.MAX_OUTPUT_TOKENS);return B(parseInt(String(e||"").trim(),10),1,128e3,t.maxOutputTokens)}async function R(e){const i=B(e,1,128e3,t.maxOutputTokens);return await E(n.MAX_OUTPUT_TOKENS,String(i)),i}async function G(){return await h(),"1"===await g(n.ONBOARDING_KEYS_CONFIRMED)}async function D(e=!0){return await E(n.ONBOARDING_KEYS_CONFIRMED,e?"1":"0"),e}async function K(){return await async function(){const e=U();if(null!=r&&e-c<2e3)return r;const t="1"===await g(n.PRIVACY_MODE);return r=t,c=e,t}()}function F(e){if(!Array.isArray(e))return[];const t=[],n=new Set;for(const i of e){const e=String(i||"").trim();e&&!n.has(e)&&(n.add(e),t.push(e))}return t}async function V(e){const t=F(e);return await E(n.SECTION_HIDDEN,JSON.stringify(t)),t}async function q(e){return e?(await E(n.LICENSE,JSON.stringify(e)),e):(await y(n.LICENSE),null)}async function $(){await y(n.LICENSE)}function U(){return Date.now()}function Y(e){return new Promise(t=>setTimeout(t,e))}function B(e,t,n,i=t){const o=parseInt(String(e),10);return Number.isFinite(o)?Math.max(t,Math.min(n,o)):i}const j=[/\bsk-[A-Za-z0-9-_]{1,}\b/gi,/\bAIza[0-9A-Za-z_-]{1,}\b/gi,/\b[A-Z0-9]{4}(?:-[A-Z0-9]{4}){1,3}\b/gi];function z(e){if(null==e)return"";let t=String(e);for(const e of j)t=t.replace(e,"[REDACTED]");return t}function J(e){if(null==e)return e;if("string"==typeof e)return z(e);if(Array.isArray(e))return e.map(J);if("object"==typeof e){const t={};for(const[n,i]of Object.entries(e))t[n]=J(i);return t}return e}function H(e){const t=parseInt(String(e||"").trim(),10);return Number.isFinite(t)&&t>0?t:0}const X="AI_CACHE_ENTRY_V1:";let Q=0;async function W(){const e=H(await g(n.CACHE_CLEAR_AT));return e>Q&&(Q=e),Q}async function Z(){const e=await g(n.CACHE_INDEX);if(!e)return[];try{const t=JSON.parse(e);return Array.isArray(t)?t:[]}catch{return[]}}async function ee(e){try{await E(n.CACHE_INDEX,JSON.stringify(e))}catch{}}function te(e,t=0){const n=U(),i=[],o=[];for(const a of e||[]){if(!a||!a.key)continue;const e=Number(a.savedAtMs||0);t&&(!Number.isFinite(e)||e<=t)||a.expiresAtMs&&a.expiresAtMs<=n?o.push(a.key):i.push(a)}if(i.length>250){i.sort((e,t)=>(e.savedAtMs||0)-(t.savedAtMs||0));const e=i.length-250,t=i.slice(0,e);for(const e of t)o.push(e.key);return{list:i.slice(e),removedKeys:o}}return{list:i,removedKeys:o}}async function ne(e){e&&await y(X+e)}async function ie(e){const t=await Z(),n=(t||[]).filter(t=>t?.key!==e);n.length!==t.length&&await ee(n)}async function oe(e,t,n,i={}){if(!e)return;if(await K())return;const o=U(),a=await W(),s=a&&o<=a?a+1:o,r="number"==typeof n&&n>0?s+n:null,c={v:1,savedAtMs:s,expiresAtMs:r,value:t},u=JSON.stringify(c);await E(X+e,u);const l=await Z(),d=i.provider||t?.provider||"",f=i.model||t?.model||"",m=u.length;let p=!1;const g=(l||[]).map(t=>t?.key!==e?t:(p=!0,{key:e,provider:d,model:f,size:m,savedAtMs:s,expiresAtMs:r}));p||g.push({key:e,provider:d,model:f,size:m,savedAtMs:s,expiresAtMs:r});const y=te(g,a);for(const e of y.removedKeys)await ne(e);await ee(y.list)}function ae(e){if(Array.isArray(e))return e.map(ae);if(t=e,"[object Object]"===Object.prototype.toString.call(t)){const t={};for(const n of Object.keys(e).sort())t[n]=ae(e[n]);return t}var t;return e}const se=864e5;let re=[],ce=null,ue=!1,le=0,de=0;async function fe(e={}){const t=H(await g(n.REQUEST_LOG_CLEAR_AT));return t>de&&(de=t,re=[],e.reset?(ue=!0,ce=null,le=U()):ue=!1),de}async function me(e=!1){if(ce)return ce;ce=(async()=>{if(await K())return!e&&ue||(ue=!0,le=U()),re;const t=await fe();if(!e&&ue)return re;const i=await g(n.REQUEST_LOG);let o=[];if(i)try{const e=JSON.parse(i);Array.isArray(e)&&(o=e)}catch{o=[]}const a=U();return o=o.map(e=>{if(!e)return null;let t=e.ts;if("string"==typeof t){const e=Date.parse(t);Number.isFinite(e)&&(t=e)}return"number"!=typeof t?null:{...e,ts:t}}).filter(e=>e&&"number"==typeof e.ts&&e.ts>t&&a-e.ts<=se).map(e=>ye(e)),re=o.slice(-500),ue=!0,le=U(),re})();try{return await ce}finally{ce=null}}async function pe(){try{if(await K())return;await E(n.REQUEST_LOG,JSON.stringify(re.slice(-500)))}catch{}}function ge(){const e=U(),t=de||0;re=(re||[]).filter(n=>n&&"number"==typeof n.ts&&n.ts>t&&e-n.ts<=se),re.length>500&&(re=re.slice(-500))}function Ee(e){!async function(e){try{const t=ye({ts:U(),...e});if(await K())return re.push(t),ge(),ue=!0,void(le=U());if(await fe({reset:!0}),ue)return re.push(t),ge(),le=U(),void await pe();await me(),re.push(t),ge(),le=U(),await pe()}catch{}}(e)}function ye(e){return e&&"object"==typeof e?J(e):e}async function he(){const e=U();re=[],ue=!0,ce=null,de=e,le=e,await E(n.REQUEST_LOG_CLEAR_AT,String(e)),await y(n.REQUEST_LOG)}const we=new class{constructor(e=500){this.maxEntries=e,this.map=new Map}get(e){if(!this.map.has(e))return null;const t=this.map.get(e);return t?.expiresAtMs&&t.expiresAtMs<=U()?(this.map.delete(e),null):(this.map.delete(e),this.map.set(e,t),t.value)}set(e,t,n){const i="number"==typeof n&&n>0?U()+n:null;for(this.map.has(e)&&this.map.delete(e),this.map.set(e,{value:t,expiresAtMs:i});this.map.size>this.maxEntries;){const e=this.map.keys().next().value;this.map.delete(e)}}clear(){this.map.clear()}}(800);let Ie=0;const Ae=new Map;let ve=0;const _e=[];function Ne(e){return"string"==typeof e&&e.trim().length>0}function ke(e,t=!1){if("boolean"==typeof e)return e;if("number"==typeof e)return 0!==e;if("string"==typeof e){const t=e.trim().toLowerCase();if(["1","true","yes","y","on"].includes(t))return!0;if(["0","false","no","n","off"].includes(t))return!1}return t}function Te(e){return B(e,1e3,12e4,t.timeoutMs)}function Oe(e){return String(e||"").toLowerCase()}function Ce(e){const t=Oe(e);return!!t&&(t.includes("responseschema")||t.includes("response schema")||t.includes("response_schema")||t.includes("responsemime")||t.includes("response mime")||t.includes("response_mime")||t.includes("response_mime_type")||t.includes("json_schema")||t.includes("response_format")||t.includes("text.format"))}function be(e){const t=Oe(e);return!!t&&!!(t.includes("web_search")||t.includes("google_search")||t.includes("web search")||t.includes("google search"))&&(t.includes("not supported")||t.includes("unsupported")||t.includes("unknown")||t.includes("unrecognized")||t.includes("invalid")||t.includes("not enabled")||t.includes("not available"))}function Se(e){if(!Ne(e))return"Return valid JSON only.";const t=String(e).trim();return/json/i.test(t)?t:t+" Return valid JSON only."}function Me(e,t){return"AI.FORMULA"!==e?"":function(e){if(!Ne(e))return"";const t=String(e).trim(),n=t.match(/=[^\n\r]+/),i=(n?n[0]:t).trim();return i.startsWith("=")?i:""}(t)}async function Le(n){const i=U(),o=w(n?.provider)||await N(),a=await b(o),s=await T(o),r=n?.functionName||"aiGenerate",c=Ne(n?.functionCall)?String(n.functionCall):"",u=o===e.OPENAI?await M():"",l=o===e.GEMINI?await S():"",d=o===e.OPENAI?u:l;if(!s)return Ee({fn:r,provider:o,model:a,ok:!1,ms:U()-i,cache:!1,reasoningEffort:d||void 0,call:c||void 0,code:"API_KEY_MISSING",message:`Cl√© API manquante pour le fournisseur ${o}.`}),{ok:!1,provider:o,model:a,code:"API_KEY_MISSING",message:`Cl√© API manquante pour le fournisseur ${o}.`};const f=String(n?.user||""),m=Ne(n?.system)?String(n.system):"",p=ke(n?.webSearch,!1),E=Te(n?.timeoutMs),y=(h=n?.retry,B(h,0,5,t.retry));var h;const I=await P(),A=function(e){return B(e,1,128e3,t.maxOutputTokens)}(n?.maxOutputTokens??I),v=o===e.GEMINI?function(e,t){const n=String(t||"").trim().toLowerCase();if(!n||"auto"===n||"none"===n)return null;const i=String(e||"").trim().toLowerCase();if(!i.includes("gemini"))return null;if(i.includes("gemini-3"))return i.includes("flash")?{thinkingLevel:(new Set(["minimal","low","medium","high"]).has(n)?n:"low").toUpperCase()}:{thinkingLevel:("high"===n||"medium"===n?"high":"low").toUpperCase()};if(i.includes("gemini-2.5")){let e={minimal:512,low:2048,medium:8192,high:24576}[n];return e?(i.includes("flash-lite")&&(e=Math.max(512,e)),i.includes("pro")&&(e=Math.max(128,e)),{thinkingBudget:e}):null}return null}(a,l):null,_=ke(n?.cache,t.cache),k=B(n?.cacheTtlSec??(p?t.webCacheTtlSec:t.cacheTtlSec),1,31536e3,p?t.webCacheTtlSec:t.cacheTtlSec);await async function(){const e=await async function(){return await W()}();e>Ie&&(Ie=e,we.clear())}();const O={v:3,provider:o,model:a,maxOutputTokens:A,reasoningEffort:u,geminiReasoningEffort:l,webSearch:p,system:m,user:f,responseMimeType:n?.responseMimeType||"",responseJsonSchema:n?.responseJsonSchema||null},C=await async function(e){const t="string"==typeof e?e:(n=e,JSON.stringify(ae(n)));var n;try{if("undefined"!=typeof crypto&&crypto?.subtle?.digest&&"undefined"!=typeof TextEncoder){const e=(new TextEncoder).encode(t),n=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(n)).map(e=>e.toString(16).padStart(2,"0")).join("")}}catch{}return`fnv1a:${function(e){let t=2166136261;for(let n=0;n<e.length;n++)t^=e.charCodeAt(n),t=Math.imul(t,16777619);return(t>>>0).toString(16).padStart(8,"0")}(t)}`}(O);if(_){const e=we.get(C);if(e){const t=Me(r,e?.text);return Ee({fn:r,provider:o,model:a,ok:!0,ms:U()-i,cache:!0,cacheKind:"memory",reasoningEffort:d||void 0,call:c||void 0,inputTokens:0,outputTokens:0,reasoningTokens:0,totalTokens:0,formula:t||void 0}),{...e,cached:!0,cacheKind:"memory"}}const t=await async function(e){if(!e)return null;if(await K())return null;const t=await W(),n=await g(X+e);if(!n)return await ie(e),null;try{const i=JSON.parse(n);if(!i||"object"!=typeof i)throw new Error("Invalid entry");const o=Number(i.savedAtMs||0);return t&&(!Number.isFinite(o)||o<=t)||i.expiresAtMs&&i.expiresAtMs<=U()?(await ne(e),await ie(e),null):i.value||null}catch{return await ne(e),await ie(e),null}}(C);if(t){const e=Me(r,t?.text);return we.set(C,t,1e3*k),Ee({fn:r,provider:o,model:a,ok:!0,ms:U()-i,cache:!0,cacheKind:"persistent",reasoningEffort:d||void 0,call:c||void 0,inputTokens:0,outputTokens:0,reasoningTokens:0,totalTokens:0,formula:e||void 0}),{...t,cached:!0,cacheKind:"persistent"}}}if(Ae.has(C))return Ae.get(C);const L=async function(){ve>=4&&await new Promise(e=>_e.push(e)),ve++;try{return await(async()=>{let t=0,l=null;const g=async t=>o===e.OPENAI?async function({apiKey:t,model:n,system:i,user:o,maxOutputTokens:a,reasoningEffort:s,timeoutMs:r,webSearch:c,responseMimeType:u,responseJsonSchema:l}){const d="https://api.openai.com/v1/responses",f={model:n,input:o,max_output_tokens:a,store:!1};if(Ne(s)&&(f.reasoning={effort:s}),Ne(i)){const e="application/json"===u||l?i+" You must return valid JSON.":i;f.instructions=e}l?f.text={format:{type:"json_schema",name:"excel_ai_schema",strict:!0,schema:l}}:"application/json"===u&&(f.text={format:{type:"json_object"}}),c&&(f.tools=[{type:"web_search"}],f.include=["web_search_call.action.sources"]);const m=await De(d,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify(f)},r),p=await Ke(m);if(!m.ok){const t=function(e){try{const t=e?.error?.message;return t?String(t):""}catch{return""}}(p)||`OpenAI API error (${m.status}).`;return{ok:!1,provider:e.OPENAI,model:n,code:"API_ERROR",message:z(t)}}const g=function(e){try{if("string"==typeof e?.output_text&&e.output_text.trim())return e.output_text}catch{}try{const t=e?.output;if(Array.isArray(t)){const e=[];for(const n of t){if("string"==typeof n?.text&&n.text.trim()&&e.push(n.text),"string"==typeof n?.output_text&&n.output_text.trim()&&e.push(n.output_text),"output_text"===n?.type&&"string"==typeof n?.text&&e.push(n.text),"text"===n?.type&&"string"==typeof n?.text&&e.push(n.text),"message"===n?.type){const t=n?.content;if(Array.isArray(t))for(const n of t)"text"===n?.type&&n?.text&&e.push(n.text),"output_text"===n?.type&&n?.text&&e.push(n.text);else"string"==typeof t&&e.push(t)}if("message"!==n?.type){const t=n?.content;if(Array.isArray(t))for(const n of t)"text"===n?.type&&n?.text&&e.push(n.text),"output_text"===n?.type&&n?.text&&e.push(n.text);else"string"==typeof t&&e.push(t)}}if(e.length>0)return e.join("\n").trim()}}catch{}try{return e?.choices?.[0]?.message?.content||""}catch{return""}}(p),E=c?function(e){try{const t=e?.output;if(!Array.isArray(t))return[];const n=[];for(const e of t){if("web_search_call"!==e?.type)continue;const t=e?.action?.sources;if(Array.isArray(t))for(const e of t)e?.url&&n.push({title:e?.title||"",url:e.url})}return Ge(n)}catch{return[]}}(p):[],y=function(e){try{const t=e?.usage;if(!t)return null;const n=Pe(t?.output_tokens),i=Pe(t?.output_tokens_details?.reasoning_tokens),o=Math.max(0,n-i);return{inputTokens:Pe(t?.input_tokens),outputTokens:o,reasoningTokens:i,totalTokens:Pe(t?.total_tokens),cachedInputTokens:Pe(t?.input_tokens_details?.cached_tokens)}}catch{return null}}(p);return Ne(g)?{ok:!0,provider:e.OPENAI,model:n,text:g.trim(),sources:E,usage:y}:{ok:!1,provider:e.OPENAI,model:n,code:"EMPTY_RESPONSE",message:"R√©ponse vide d'OpenAI."}}(t):async function({apiKey:t,model:n,system:i,user:o,maxOutputTokens:a,thinkingConfig:s,timeoutMs:r,webSearch:c,responseMimeType:u,responseJsonSchema:l}){const d=function(e){return`https://generativelanguage.googleapis.com/v1beta/models/${encodeURIComponent(e)}:generateContent`}(n),f={contents:[{role:"user",parts:[{text:o}]}],generationConfig:{maxOutputTokens:a}};if(s&&"object"==typeof s&&(f.generationConfig.thinkingConfig=s),Ne(i)){const e="application/json"===u||l?i+" You must return valid JSON.":i;f.systemInstruction={role:"system",parts:[{text:e}]}}u&&(f.generationConfig.responseMimeType=u),l&&(f.generationConfig.responseSchema=l),c&&(f.tools=[{google_search:{}}]);const m=await De(d,{method:"POST",headers:{"Content-Type":"application/json","x-goog-api-key":t},body:JSON.stringify(f)},r),p=await Ke(m);if(!m.ok){const t=function(e){try{const t=e?.error?.message;return t?String(t):""}catch{return""}}(p)||`Gemini API error (${m.status}).`;return{ok:!1,provider:e.GEMINI,model:n,code:"API_ERROR",message:z(t)}}const g=function(e){try{const t=e?.candidates?.[0],n=t?.content?.parts;return Array.isArray(n)?n.map(e=>e?.text||"").join(""):""}catch{return""}}(p),E=function(e){try{const t=e?.candidates?.[0],n=t?.groundingMetadata,i=n?.groundingChunks;if(!Array.isArray(i))return[];const o=[];for(const e of i){const t=e?.web;t?.uri&&o.push({title:t?.title||"",url:t.uri})}return Ge(o)}catch{return[]}}(p),y=function(e){try{const t=e?.usageMetadata;return t?{inputTokens:Pe(t?.promptTokenCount),outputTokens:Pe(t?.candidatesTokenCount),reasoningTokens:Pe(t?.thoughtsTokenCount),totalTokens:Pe(t?.totalTokenCount),cachedInputTokens:Pe(t?.cachedContentTokenCount)}:null}catch{return null}}(p);return Ne(g)?{ok:!0,provider:e.GEMINI,model:n,text:g.trim(),sources:E,usage:y}:{ok:!1,provider:e.GEMINI,model:n,code:"EMPTY_RESPONSE",message:"R√©ponse vide de Gemini."}}(t);for(;t<=y;){t++;try{const e={apiKey:s,model:a,system:m,user:f,maxOutputTokens:A,reasoningEffort:u,thinkingConfig:v,timeoutMs:E,webSearch:p,responseMimeType:n?.responseMimeType,responseJsonSchema:n?.responseJsonSchema};let l=await g(e);if(!l.ok){let t=e;t.webSearch&&(be(l.message)||"API_ERROR"===l.code||"EMPTY_RESPONSE"===l.code)&&(t={...t,webSearch:!1},l=await g(t));const n=t.responseMimeType||t.responseJsonSchema;!l.ok&&n&&(Ce(l.message)||"API_ERROR"===l.code||"EMPTY_RESPONSE"===l.code)&&(t={...t,responseMimeType:void 0,responseJsonSchema:void 0,system:Se(t.system)},l=await g(t))}const y=xe(l?.usage),h=l.ok?Me(r,l.text):"";return Ee({fn:r,provider:o,model:a,ok:l.ok,ms:U()-i,attempt:t,cache:!1,reasoningEffort:d||void 0,call:c||void 0,inputTokens:y.inputTokens,outputTokens:y.outputTokens,reasoningTokens:y.reasoningTokens,cachedInputTokens:y.cachedInputTokens,totalTokens:y.totalTokens,code:l.code,message:l.message,formula:h||void 0}),l.ok&&_&&(we.set(C,l,1e3*k),await oe(C,l,1e3*k,{provider:o,model:a})),l}catch(e){l=e,t<=y&&await Y(250*t)}}const h=z(l?.message?String(l.message):"Erreur inconnue.");return Ee({fn:r,provider:o,model:a,ok:!1,ms:U()-i,cache:!1,reasoningEffort:d||void 0,call:c||void 0,code:"API_ERROR",message:h}),{ok:!1,provider:o,model:a,code:"API_ERROR",message:h}})()}finally{ve--;const e=_e.shift();e&&e()}}();Ae.set(C,L);try{return await L}finally{Ae.delete(C)}}function xe(e){if(!e||"object"!=typeof e)return{inputTokens:0,outputTokens:0,reasoningTokens:0,totalTokens:0,cachedInputTokens:0};const t=Pe(e.inputTokens),n=Pe(e.outputTokens),i=Pe(e.reasoningTokens),o=Pe(e.cachedInputTokens),a=Pe(e.totalTokens),s=t+n+i;return{inputTokens:t,outputTokens:n,reasoningTokens:i,totalTokens:Math.max(a,s),cachedInputTokens:o}}function Pe(e){const t=Number(e);return!Number.isFinite(t)||t<=0?0:Math.floor(t)}async function Re(){we.clear(),await async function(){const e=U();Q=e,await E(n.CACHE_CLEAR_AT,String(e));const t=await Z();for(const e of t||[])e?.key&&await ne(e.key);await y(n.CACHE_INDEX)}()}function Ge(e){const t=new Set,n=[];for(const i of e||[]){const e=String(i?.url||"").trim();if(!e)continue;const o=e.toLowerCase();t.has(o)||(t.add(o),n.push({title:String(i?.title||"").trim(),url:e}))}return n}async function De(e,t,n){const i=Te(n);if("undefined"==typeof AbortController)return await fetch(e,t);const o=new AbortController,a=setTimeout(()=>o.abort(),i);try{return await fetch(e,{...t,signal:o.signal})}finally{clearTimeout(a)}}async function Ke(e){try{return await e.json()}catch{return{}}}const Fe="Neurow Add-in";function Ve(e){return String(e||"").trim()}function qe(e){const t=String(e||"").trim();if(!t)return"";const n=Date.parse(t);return Number.isFinite(n)?new Date(n).toISOString():""}function $e(e,t){if(!e)return t;if("string"==typeof e.error&&e.error.trim())return e.error.trim();if("string"==typeof e.message&&e.message.trim())return e.message.trim();if(Array.isArray(e.errors)&&e.errors.length){const t=e.errors[0]||{},n=t.detail||t.title||t.message;if(n)return String(n).trim()}return t}async function Ue(e,t){const n=new FormData;Object.entries(t||{}).forEach(([e,t])=>{null!=t&&""!==t&&n.append(e,t)});const i=await fetch(e,{method:"POST",body:n});let o=null;try{o=await i.json()}catch{o=null}return{ok:i.ok,status:i.status,data:o}}function Ye(e,t,n={}){const i=n.instanceId||t?.instance?.id||t?.instance_id||"",o=t?.instance?.name||n.instanceName||Fe,a=qe(t?.license_key?.expires_at||n.expiresAt),s=(new Date).toISOString();return{key:e,instanceId:i,instanceName:o,expiresAt:a,valid:!0,activatedAt:n.activatedAt||s,lastCheckedAt:s}}function Be(e){if(!e||"object"!=typeof e)return null;const t=Ve(e.key);return t?{key:t,instanceId:String(e.instanceId||"").trim(),instanceName:String(e.instanceName||Fe).trim(),expiresAt:qe(e.expiresAt),valid:!1!==e.valid,activatedAt:String(e.activatedAt||"").trim(),lastCheckedAt:String(e.lastCheckedAt||"").trim()}:null}async function je(){return Be(await async function(){await h();const e=await g(n.LICENSE);if(!e)return null;try{return JSON.parse(e)}catch{return null}}())}async function ze(e){const t=Be(e);return t?(await q(t),t):(await $(),null)}function Je(e){if(!e||!e.key)return!1;if(!1===e.valid)return!1;if(e.expiresAt){const t=Date.parse(e.expiresAt);if(Number.isFinite(t)&&t<=Date.now())return!1}return!0}function He(e){return document.getElementById(e)}function Xe(e,t){const n=z(e||"");if(He("statusLine").textContent=n,t)try{const e=J(t);He("statusDetails").textContent=JSON.stringify(e,null,2)}catch{He("statusDetails").textContent=z(t)}else He("statusDetails").textContent=""}function Qe(e){const t=Number(e);return Number.isFinite(t)?Math.round(t).toLocaleString("en-US"):"0"}const We="‚Ç¨";function Ze(e){const t=Number(e);return Number.isFinite(t)?`${We}${t.toFixed(4)}`:`${We}0.0000`}function et(e){const t=Number(e);return Number.isFinite(t)?`${(t/1e3).toFixed(2)}s`:"0.00s"}function tt(e){try{return new Date(e).toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"})}catch{return"--:--"}}function nt(e){return String(e?.dataset?.section||"").trim()}function it(e){return"true"===e?.dataset?.sectionLocked}function ot(e){if(Rt||(Rt=document.querySelector(".app__main")),!Rt)return;const t=document.querySelector(Et);for(const n of e){const e=xt.get(n);e&&(t?Rt.insertBefore(e,t):Rt.appendChild(e))}}function at(e){xt.forEach((t,n)=>{const i=it(t),o=e.has(n)&&!i;t.classList.toggle(yt,o)})}function st(){let e=!1;for(const t of Array.from(Lt)){const n=xt.get(t);n&&!it(n)||(Lt.delete(t),e=!0)}e&&V(Array.from(Lt))}function rt(e,t={}){const{persist:i=!0}=t;St=e.slice(),ot(St),dt(),i&&async function(e){const t=F(e);await E(n.SECTION_ORDER,JSON.stringify(t))}(St)}function ct(e,t={}){const{persist:n=!0}=t;Lt=new Set(e),st(),at(Lt),dt(),n&&V(Array.from(Lt)),dn()}function ut(e,t){const n=St.indexOf(e);if(n<0)return;const i=n+t;if(i<0||i>=St.length)return;const o=St.slice();o.splice(n,1),o.splice(i,0,e),rt(o)}function lt(e){e.querySelectorAll(".section-row").forEach(e=>{e.classList.remove("is-drop-before","is-drop-after","is-dragging")})}function dt(){const e=He("sectionManagerList");if(!e)return;e.innerHTML="";const t=St.length?St:Array.from(xt.keys());t.forEach((n,i)=>{const o=xt.get(n);if(!o)return;const a=function(e){const t=e?.dataset?.sectionTitle;if(t)return t;const n=e?.querySelector?.(".card__title");return n?n.textContent.trim():nt(e)}(o),s=it(o),r=!Lt.has(n)||s,c=document.createElement("div");c.className="section-row",c.dataset.sectionKey=n,c.setAttribute("role","listitem");const u=document.createElement("button");u.type="button",u.className="section-row__handle",u.draggable=!0,u.setAttribute("title","Glisser pour d√©placer"),u.setAttribute("aria-label",`D√©placer ${a}`);const l=document.createElement("div");l.className="section-row__label",l.textContent=a;const d=document.createElement("div");d.className="section-row__controls";const f=document.createElement("button");f.type="button",f.className="move-btn move-btn--up",f.disabled=0===i,f.setAttribute("title","Monter"),f.setAttribute("aria-label",`Monter ${a}`),f.addEventListener("click",()=>ut(n,-1));const m=document.createElement("button");m.type="button",m.className="move-btn move-btn--down",m.disabled=i===t.length-1,m.setAttribute("title","Descendre"),m.setAttribute("aria-label",`Descendre ${a}`),m.addEventListener("click",()=>ut(n,1));const p=document.createElement("label");p.className="visibility-toggle",p.setAttribute("title",s?"Toujours visible":r?"Masquer":"Afficher");const g=document.createElement("input");g.type="checkbox",g.checked=r,g.disabled=s,g.setAttribute("aria-label",s?`${a} toujours visible`:`Afficher ${a}`);const E=document.createElement("span");if(E.className="visibility-toggle__slider",p.appendChild(g),p.appendChild(E),g.addEventListener("change",()=>{s||(g.checked?Lt.delete(n):Lt.add(n),at(Lt),V(Array.from(Lt)),dt())}),d.appendChild(f),d.appendChild(m),s){const e=document.createElement("span");e.className="section-row__lock",e.textContent="Fixe",e.setAttribute("title","Toujours visible"),d.appendChild(e)}d.appendChild(p),c.appendChild(u),c.appendChild(l),c.appendChild(d),e.appendChild(c)})}const ft=["auto","minimal","low","medium","high"],mt=["none","minimal","low","medium","high"],pt="[data-help]",gt="[data-section]",Et="[data-section-settings]",yt="is-section-hidden",ht="[data-key-input]",wt="[data-key-save]",It="[data-license-input]",At="[data-license-status]";let vt={gemini:!1,openai:!1},_t=null,Nt=null,kt=!1,Tt=!1,Ot=!1,Ct=!1,bt=!1,St=[],Mt=[],Lt=new Set,xt=new Map,Pt="",Rt=null;const Gt=new Set;let Dt=null;const Kt={gemini:t.geminiModel,openai:t.openaiModel},Ft={gemini:[{id:"gemini-3-pro-preview",label:"Gemini 3 Pro Preview",prices:{input:2,output:12,cachedInput:.2},costLevel:3,reasoningLevel:3,warning:!0},{id:"gemini-3-flash-preview",label:"Gemini 3 Flash Preview",prices:{input:.5,output:3,cachedInput:.05},costLevel:2,reasoningLevel:2,recommended:!0},{id:"gemini-2.5-flash-lite",label:"Gemini 2.5 Flash Lite",prices:{input:.1,output:.4,cachedInput:.01},costLevel:1,reasoningLevel:1}],openai:[{id:"gpt-5.2",label:"GPT-5.2",prices:{input:1.75,output:14,cachedInput:.175},costLevel:3,reasoningLevel:3,supportsReasoningNone:!0,warning:!0},{id:"gpt-5-mini",label:"GPT-5 Mini",prices:{input:.25,output:2,cachedInput:.025},costLevel:2,reasoningLevel:2,recommended:!0,supportsReasoningNone:!1},{id:"gpt-5-nano",label:"GPT-5 Nano",prices:{input:.05,output:.4,cachedInput:.005},costLevel:1,reasoningLevel:1,supportsReasoningNone:!1}]},Vt={gemini:new Map(Ft.gemini.map(e=>[e.id.toLowerCase(),e])),openai:new Map(Ft.openai.map(e=>[e.id.toLowerCase(),e]))},qt={gemini:"Gemini",openai:"OpenAI"};function $t(e,t){const n=Math.max(1,Number(t)||1);return new Array(n+1).join(e)}function Ut(e,t){const n=String(e||"").toLowerCase(),i=String(t||"").trim().toLowerCase(),o=Vt[n];if(o&&i&&o.has(i))return o.get(i);const a=Kt[n];return o&&a&&o.has(a.toLowerCase())?o.get(a.toLowerCase()):null}function Yt(e,t){const n=He("geminiReasoningEffort");if(!n)return"";const i=function(e){const t=String(e||"").trim().toLowerCase();return t.includes("gemini-3")&&t.includes("flash")?["auto","minimal","low","medium","high"]:t.includes("gemini-3")?["auto","low","high"]:t.includes("gemini-2.5")?["auto","minimal","low","medium","high"]:["auto","low","high"]}(e);let o=Bt(t,ft);o||(o=ft[0]),i.includes(o)||("minimal"===o&&(o="low"),"medium"===o&&(o="high")),o=function(e,t,n){if(!e)return t[0]||"";if(t.includes(e))return e;const i=n.indexOf(e);if(i<0)return t[0]||"";let o=t[0]||"",a=Number.POSITIVE_INFINITY;for(const e of t){const t=n.indexOf(e);if(t<0)continue;const s=Math.abs(t-i);s<a&&(a=s,o=e)}return o}(o,i,ft);const a=ft.indexOf(o);return n.value=String(a>=0?a:0),n.setAttribute("aria-valuetext",o),o}function Bt(e,t=mt){const n=String(e||"").trim().toLowerCase();if(!n)return"";const i=Number(n);return Number.isFinite(i)?t[Math.min(t.length-1,Math.max(0,Math.round(i)))]||"":n}function jt(e,t){const n=He("openaiReasoningEffort");if(!n)return"";const i=function(e){const t=String(e||"").trim().toLowerCase(),n=Vt.openai?.get(t);return!n||"boolean"!=typeof n.supportsReasoningNone||n.supportsReasoningNone}(e),o=n.closest(".reasoning");o&&o.classList.toggle("reasoning--no-none",!i),n.dataset.allowNone=i?"1":"0";const a=i?mt:mt.slice(1);let s=Bt(t);a.includes(s)||(s=a[0]||"minimal");const r=mt.indexOf(s);return n.value=String(r>=0?r:0),n.setAttribute("aria-valuetext",s),s}function zt(e){const t=Number(e);if(!Number.isFinite(t))return`${We}0`;const n=t>=1?2:3;let i=t.toFixed(n);return i=i.replace(/\.?0+$/,""),`${We}${i}`}function Jt(e){return{cost:$t("$",e.costLevel),reasoning:$t("üß†",e.reasoningLevel)}}function Ht(e){const t=Jt(e),n=e.recommended?"‚òÖ ":"";return`${e.warning?"! ":""}${n}${e.id} | ${t.cost} | ${t.reasoning}`}function Xt(t,n){const i=t===e.GEMINI,o=He(i?"geminiModel":"openaiModel"),a=He(i?"geminiModelWarning":"openaiModelWarning");if(!o||!a)return;const s=Ut(t,n||o.value),r=!!s?.warning;a.classList.toggle("is-hidden",!r),o.classList.toggle("input--warning",r)}function Qt(e){if(!e)return 0;const t=Ut(String(e.provider||"").toLowerCase(),e.model);if(!t)return 0;const n=Math.max(0,Number(e.inputTokens||0)),i=Math.max(0,Number(e.outputTokens||0)),o=Math.max(0,Number(e.reasoningTokens||0)),a=Math.max(0,Number(e.cachedInputTokens||0)),s=i+o,r=Math.min(a,n),c=Math.max(0,n-r),u=t.prices||{};return c/1e6*Number(u.input||0)+r/1e6*Number(u.cachedInput??u.input??0)+s/1e6*Number(u.output||0)}function Wt(e){return{provider:e?.provider||"",inputTokens:Number(e?.inputTokens||0),outputTokens:Number(e?.outputTokens||0),reasoningTokens:Number(e?.reasoningTokens||0),cachedInputTokens:Number(e?.cachedInputTokens||0),totalTokens:Number(e?.totalTokens||0),ok:!!e?.ok,cache:!!e?.cache,ms:Number(e?.ms||0),fn:e?.fn||"AI",model:e?.model||"",ts:Number(e?.ts||0),message:e?.message||"",reasoningEffort:e?.reasoningEffort||"",call:e?.call||"",formula:e?.formula||""}}function Zt(e,t,n){if(!t)return;const i=Ft[e]||[],o=String(n||"").trim(),a=o.toLowerCase(),s=Kt[e]||"";t.innerHTML="";let r=!1;for(const e of i){const n=document.createElement("option");n.value=e.id,n.textContent=Ht(e),e.warning&&(n.dataset.warning="1",n.style.color="#b03524",n.style.fontWeight="700"),e.id.toLowerCase()===a&&(n.selected=!0,r=!0),t.appendChild(n)}if(o&&!r){const e=document.createElement("option");return e.value=o,e.textContent=`${o} | hors liste`,e.selected=!0,void t.appendChild(e)}!o&&s&&(t.value=s)}function en(e,t){const n=He(e);n&&(n.classList.toggle("is-open",t),n.setAttribute("aria-hidden",t?"false":"true"))}function tn(e){const t=He(e);return!!t&&t.classList.contains("is-open")}function nn(e){en("settingsModal",e)}function on(e){en("pricingModal",e)}function an(e){en("onboardingModal",e)}function sn(e){en("onboardingKeysModal",e)}function rn(){on(!1)}function cn(e,t){const n=!!t;document.querySelectorAll(`[data-key-status][data-key-status="${e}"]`).forEach(e=>{e.textContent=n?"Cl√© enregistr√©e":"Cl√© manquante",e.classList.toggle("key-status--ok",n),e.classList.toggle("key-status--missing",!n)})}function un(){document.querySelectorAll(ht).forEach(t=>{const n=String(t.dataset.keyInput||"").trim().toLowerCase();n===e.GEMINI?t.placeholder=vt.gemini?"Cl√© enregistr√©e (laisser vide pour conserver)":"AIza...":n===e.OPENAI&&(t.placeholder=vt.openai?"Cl√© enregistr√©e (laisser vide pour conserver)":"sk-...")})}function ln(){return!!vt.gemini||!!vt.openai}function dn(){const e=document.querySelector('[data-section="onboarding"]');if(!e)return;if(!Tt||!kt||!Ct)return;const t=!(_t&&_t.key&&Je(_t)&&(vt.gemini&&vt.openai||Ot&&ln()));e.classList.toggle("is-hidden",!t),t&&e.classList.contains(yt)&&(Lt.delete("onboarding"),ct(Array.from(Lt)))}function fn(t,n){const i=t===e.GEMINI,o=He(i?"geminiModel":"openaiModel"),a=He(i?"geminiReasoningEffort":"openaiReasoningEffort"),s=He(i?"geminiModelGate":"openaiModelGate"),r=!n;o&&(o.disabled=r),a&&(a.disabled=r),s&&s.classList.toggle("is-hidden",!r)}function mn(){fn(e.GEMINI,!!vt.gemini),fn(e.OPENAI,!!vt.openai),function(){const e=He("providerGemini"),t=He("providerOpenAI"),n=!!vt.gemini,i=!!vt.openai;e&&(e.disabled=!n),t&&(t.disabled=!i);const o=He("configProviderGate");if(!o)return;const a=He("configProviderGateText");let s="";n||i||(s="Ajoutez une cl√© API pour activer Gemini ou OpenAI."),o.classList.toggle("is-hidden",!s),a&&(a.textContent=s)}()}function pn(e){const t=String(e||"").trim();if(!t)return 0;const n=Date.parse(t);return Number.isFinite(n)?n:0}function gn(e){const t=pn(e);return t?function(e){try{return new Date(e).toLocaleDateString("fr-FR",{year:"numeric",month:"short",day:"2-digit"})}catch{return""}}(t):""}function En(e,t,n){e&&(e.textContent=t||"",e.classList.toggle("key-status--ok",n),e.classList.toggle("key-status--missing",!n))}function yn(e,t){document.querySelectorAll(At).forEach(n=>{En(n,e,t)})}function hn(e,t={}){const{focus:n=!1,persist:i=!0}=t,o=He("licenseEntry"),a=He("licenseSubscribe");if(!o)return;o.classList.toggle("is-hidden",!e),i&&(Nt=e),a&&a.classList.toggle("is-hidden",e);const s=He("licenseModeSubscribe"),r=He("licenseModeHave");if(s&&r&&(s.classList.toggle("segmented__btn--active",!e),r.classList.toggle("segmented__btn--active",e),s.setAttribute("aria-selected",e?"false":"true"),r.setAttribute("aria-selected",e?"true":"false")),e&&n){const e=He("licenseKeyInput");e&&e.focus()}}async function wn(e={}){const{silent:t=!1}=e,n=await je();_t=n,Tt=!0,function(e){const t=function(e){if(!e||!e.key)return{ok:!1,text:"Aucune licence enregistr√©e"};if(Je(e)){const t=gn(e.expiresAt);return{ok:!0,text:"Licence active"+(t?` ¬∑ renouvellement le ${t}`:"")}}const t=pn(e.expiresAt);return{ok:!1,text:t&&t<=Date.now()?"Licence expir√©e":"Licence invalide"}}(e);document.querySelectorAll(At).forEach(e=>{En(e,t.text,t.ok)})}(n);const i=!(!n||!n.key||Je(n));hn(null===Nt?i:Nt,{persist:!1}),function(e){const t=e?.key?"Cl√© enregistr√©e (laisser vide pour conserver)":"AAAA-BBBB-CCCC-DDDD";document.querySelectorAll(It).forEach(e=>{e.placeholder=t})}(n),function(e){const t=document.querySelectorAll("[data-license-meta]");if(!t.length)return;let n="Cl√© re√ßue par email apr√®s achat (mensuel ou annuel)";if(e&&Je(e)&&e.expiresAt){const t=gn(e.expiresAt);n=t?`Renouvellement le ${t}`:"Licence active"}else if(e&&!Je(e)){const t=gn(e.expiresAt);n=t?`Licence expir√©e le ${t}`:"Licence invalide"}t.forEach(e=>{e.textContent=n})}(n),function(e){const t=He("setupLicenseStep");if(!t)return;const n=!(!e||!Je(e));t.classList.toggle("is-hidden",n)}(n),dn(),!t&&n&&Je(n)&&Xe("Licence active",{expiresAt:n.expiresAt||"n/a"})}function In(e){const t=Number(e);return Number.isFinite(t)?Math.min(17,Math.max(7,Math.round(t))):7}function An(e){return 2**In(e)}function vn(t){const n=t===e.GEMINI;He("providerGemini").classList.toggle("segmented__btn--active",n),He("providerOpenAI").classList.toggle("segmented__btn--active",!n),He("providerGemini").setAttribute("aria-pressed",n?"true":"false"),He("providerOpenAI").setAttribute("aria-pressed",n?"false":"true")}function _n(e){const t="gemini"===e;He("tabGemini").classList.toggle("tab--active",t),He("tabOpenAI").classList.toggle("tab--active",!t),He("tabGemini").setAttribute("aria-selected",t?"true":"false"),He("tabOpenAI").setAttribute("aria-selected",t?"false":"true"),He("panelGemini").classList.toggle("tab-panel--active",t),He("panelOpenAI").classList.toggle("tab-panel--active",!t)}async function Nn(t={}){const{preserveKeyInputs:n=!1,silent:i=!1}=t;He("storageBackend").textContent=l().kind;const[o,a,s,r,c,u,d,f,m]=await Promise.all([N(),P(),b(e.GEMINI),b(e.OPENAI),O(e.GEMINI),O(e.OPENAI),S(),M(),G()]);vn(o);const p=function(e){const t=Number(e);return!Number.isFinite(t)||t<=0?7:In(Math.log2(t))}(a),g=An(p);He("maxTokensRange").value=String(p),He("maxTokensValue").textContent=Qe(g),g!==a&&await R(g);const E=He("geminiModel"),y=He("openaiModel");Zt(e.GEMINI,E,s),Zt(e.OPENAI,y,r);const h=E?E.value:s,w=y?y.value:r,I=Yt(h,d);I&&I!==d&&await x(I);const A=jt(w,f),v=A||f;A&&A!==f&&await L(A),Xt(e.GEMINI,h),Xt(e.OPENAI,w),n||document.querySelectorAll(ht).forEach(e=>{e.value=""}),vt={gemini:!!c,openai:!!u},un(),Ot=!!m,Ct=!0,c||u||!m||(Ot=!1,await D(!1)),kt=!0,cn(e.GEMINI,c),cn(e.OPENAI,u),mn(),dn(),i||Xe("Configuration charg√©e",{defaultProvider:o,maxOutputTokens:g,gemini:{key:c?"set":"missing",model:s,reasoningEffort:I},openai:{key:u?"set":"missing",model:r,reasoningEffort:v}})}function kn(e,t,n,i){const o=document.createElement("div");o.className="breakdown__row "+(i?"breakdown__row--sub":"breakdown__row--total");const a=document.createElement("div");if(a.className="breakdown__name",i){const t=document.createElement("span");t.className="breakdown__model",t.textContent=e,a.appendChild(t)}else a.textContent=e;const s=document.createElement("div");s.className="breakdown__tokens",s.textContent=`${Qe(t)} tokens`;const r=document.createElement("div");return r.className="breakdown__cost",r.textContent=Ze(n),o.appendChild(a),o.appendChild(s),o.appendChild(r),o}async function Tn(){const t=(await async function(e={}){const t=!!e?.fresh,n=U();return t||!ue||n-le>1500?await me(!0):await me(!1),re.slice()}({fresh:!0})).map(Wt).sort((e,t)=>t.ts-e.ts),n={gemini:{tokens:0,cost:0,models:new Map},openai:{tokens:0,cost:0,models:new Map}},i={inputTokens:0,reasoningTokens:0,outputTokens:0,cachedInputTokens:0,cost:0,requests:t.length,byProvider:{gemini:{tokens:0,cost:0},openai:{tokens:0,cost:0}}};for(const e of t){const t=Math.max(0,e.inputTokens),o=Math.max(0,e.reasoningTokens),a=Math.max(0,e.outputTokens),s=t+o+a,r=Qt(e);i.inputTokens+=t,i.reasoningTokens+=o,i.outputTokens+=a,i.cachedInputTokens+=Math.max(0,e.cachedInputTokens||0),i.cost+=r;const c=n[String(e.provider||"").toLowerCase()];if(c&&(c.tokens+=s,c.cost+=r,s>0||r>0)){const t=String(e.model||"").trim()||"modele inconnu",n=t.toLowerCase(),i=c.models.get(n)||{label:t,tokens:0,cost:0};i.tokens+=s,i.cost+=r,c.models.set(n,i)}}i.byProvider.gemini.tokens=n.gemini.tokens,i.byProvider.gemini.cost=n.gemini.cost,i.byProvider.openai.tokens=n.openai.tokens,i.byProvider.openai.cost=n.openai.cost,He("usageTokensTotal").textContent=Qe(i.inputTokens+i.reasoningTokens+i.outputTokens),He("usageTokensInTotal").textContent=Qe(i.inputTokens),He("usageTokensReasoningTotal").textContent=Qe(i.reasoningTokens),He("usageTokensOutTotal").textContent=Qe(i.outputTokens),He("usageCostTotal").textContent=Ze(i.cost);const o=He("usageSummary");o&&(o.textContent=Ze(i.cost)),He("usageCostGemini").textContent=Ze(i.byProvider.gemini.cost),He("usageCostOpenAI").textContent=Ze(i.byProvider.openai.cost),function(t){const n=He("usageBreakdown");if(!n)return;n.innerHTML="";const i=[e.GEMINI,e.OPENAI];for(const e of i){const i=t[e]||{tokens:0,cost:0,models:new Map};n.appendChild(kn(qt[e]||e,i.tokens,i.cost,!1));const o=Array.from(i.models.values()).filter(e=>(e.tokens||0)>0||(e.cost||0)>0).sort((e,t)=>t.tokens-e.tokens||e.label.localeCompare(t.label));for(const e of o)n.appendChild(kn(e.label,e.tokens,e.cost,!0))}}(n),function(e){const t=He("logList");if(t.innerHTML="",!e.length){const e=document.createElement("div");return e.className="log-item log-item--empty",e.textContent="Aucune activit√© enregistr√©e pour le moment",void t.appendChild(e)}const n=(e,t)=>{const n=document.createElement("span");n.className="token-flow";const i=document.createElement("span");i.className="token-flow__icon",i.textContent=e;const o=document.createElement("span");return o.className="token-flow__value",o.textContent=Qe(t),n.appendChild(i),n.appendChild(o),n},i=e.slice(0,40),o=new Set;for(const e of i){const i=document.createElement("div"),a=e.cache?" log-item--cache":"";i.className=`log-item ${e.ok?"log-item--ok":"log-item--error"}${a}`;const s=document.createElement("div");s.className="log-item__top";const r=document.createElement("div");r.className="log-item__title";const c=document.createElement("span");c.className="log-item__title-text",c.textContent=e.fn,r.appendChild(c);const u=String(e.call||e.formula||"").trim();let l=null;if(u){const t=Cn(e);o.add(t);const n=document.createElement("button");n.className="log-item__toggle",n.type="button",n.setAttribute("aria-expanded","false"),n.setAttribute("aria-label","Afficher la fonction");const a=document.createElement("span");a.className="log-item__chevron",n.appendChild(a),Gt.has(t)&&(i.classList.add("log-item--expanded"),n.setAttribute("aria-expanded","true"),n.setAttribute("aria-label","Masquer la fonction")),n.addEventListener("click",()=>{const e=i.classList.toggle("log-item--expanded");n.setAttribute("aria-expanded",e?"true":"false"),n.setAttribute("aria-label",e?"Masquer la fonction":"Afficher la fonction"),e?Gt.add(t):Gt.delete(t)}),r.appendChild(n),l=document.createElement("div"),l.className="log-item__detail",l.textContent=u}const d=document.createElement("div");d.style.display="flex",d.style.gap="6px";const f=document.createElement("span");f.className="tag",f.textContent=e.provider?e.provider.toUpperCase():"‚Äî",d.appendChild(f);const m=document.createElement("span");if(m.className="tag "+(e.ok?"":"tag--error"),m.textContent=e.ok?"OK":"Erreur",d.appendChild(m),e.cache){const e=document.createElement("span");e.className="tag tag--cache",e.textContent="Cache",d.appendChild(e)}s.appendChild(r),s.appendChild(d);const p=document.createElement("div");p.className="log-item__meta";const g=Math.max(0,e.inputTokens+e.reasoningTokens+e.outputTokens),E=e.model?e.model:"",y=e.reasoningEffort?e.reasoningEffort:"",h=et(e.ms),w=[E,y].filter(Boolean).join(" ¬∑ "),I=document.createElement("div");I.className="log-item__info";const A=`${tt(e.ts)} ¬∑ ${h}`,v=w?` ¬∑ ${w}`:"";if(!e.ok&&e.message?I.textContent=`${A}${v} ¬∑ ${e.message.slice(0,60)}`:I.textContent=`${A}${v}`,e.cache){const e=document.createElement("div");e.className="log-item__cache",e.textContent="Cache local",p.appendChild(e)}else{const t=document.createElement("div");t.className="log-item__tokens";const i=document.createElement("div");i.className="log-item__tokens-line";const o=document.createElement("span");o.className=`log-item__heat ${On(g)}`;const a=document.createElement("span");a.className="log-item__tokens-total",a.textContent=`${Qe(g)} tokens`;const s=document.createElement("span");s.className="log-item__tokens-detail",s.appendChild(document.createTextNode("(")),s.appendChild(n("IN",e.inputTokens)),s.appendChild(document.createTextNode(" / ")),s.appendChild(n("REF",e.reasoningTokens)),s.appendChild(document.createTextNode(" / ")),s.appendChild(n("OUT",e.outputTokens)),s.appendChild(document.createTextNode(")")),i.appendChild(o),i.appendChild(a),i.appendChild(s),t.appendChild(i),p.appendChild(t)}p.appendChild(I),i.appendChild(s),l&&i.appendChild(l),i.appendChild(p),t.appendChild(i)}Gt.forEach(e=>{o.has(e)||Gt.delete(e)})}(t),function(e){const t=He("usageChart");if(!t)return;const n=t.getContext("2d");if(!n)return;const i=t.clientWidth||320,o=t.clientHeight||140,a=window.devicePixelRatio||1;t.width=i*a,t.height=o*a,n.setTransform(a,0,0,a,0,0);const s=Date.now()-36e5,r=new Array(60).fill(0);for(const t of e){if(!t.ts||t.ts<s)continue;const e=Math.floor((t.ts-s)/6e4);e>=0&&e<r.length&&(r[e]+=Math.max(0,t.inputTokens+t.reasoningTokens+t.outputTokens))}const c=Math.max(...r,1),u=getComputedStyle(document.documentElement).getPropertyValue("--accent-2").trim()||"#2a9d8f";n.clearRect(0,0,i,o),n.strokeStyle="rgba(38, 70, 83, 0.12)",n.lineWidth=1;for(let e=1;e<=3;e++){const t=o/4*e;n.beginPath(),n.moveTo(0,t),n.lineTo(i,t),n.stroke()}n.beginPath(),r.forEach((e,t)=>{const a=t/(r.length-1)*i,s=o-e/c*(o-12)-6;0===t?n.moveTo(a,s):n.lineTo(a,s)});const l=n.createLinearGradient(0,0,0,o);l.addColorStop(0,"rgba(42, 157, 143, 0.35)"),l.addColorStop(1,"rgba(42, 157, 143, 0.02)"),n.lineWidth=2,n.strokeStyle=u,n.stroke(),n.lineTo(i,o),n.lineTo(0,o),n.closePath(),n.fillStyle=l,n.fill()}(t)}function On(e){const t=Number(e||0);return t>=8e3?"token-heat--extreme":t>=4e3?"token-heat--hot":t>=1500?"token-heat--warm":"token-heat--cool"}function Cn(e){const t=e.call||e.formula||"";return[e.ts||0,e.fn||"",e.provider||"",e.model||"",t].join("|")}function bn(e){bt=!!e;const t=He("privacyModeToggle");t&&(t.checked=bt);const n=He("privacyModeStatus");n&&(n.textContent=bt?"Activ√©":"D√©sactiv√©",n.classList.toggle("is-active",bt));const i=He("privacyModeHint");i&&(i.textContent=bt?"Journal et cache persistants d√©sactiv√©s.":"Journal et cache persistants activ√©s.");const o=He("cacheStatus");o&&(o.textContent=bt?"D√©sactiv√©":"Actif",o.classList.toggle("chip--success",!bt),o.classList.toggle("chip--muted",bt))}async function Sn(){bn(await K())}async function Mn(){const t=await async function(){if(await K())return{entries:0,sizeBytes:0,providers:{gemini:{entries:0,sizeBytes:0},openai:{entries:0,sizeBytes:0}},oldestMs:null,newestMs:null};const t=te(await Z(),await W());if(t.removedKeys.length){for(const e of t.removedKeys)await ne(e);await ee(t.list)}const n={entries:0,sizeBytes:0,providers:{gemini:{entries:0,sizeBytes:0},openai:{entries:0,sizeBytes:0}},oldestMs:null,newestMs:null};for(const i of t.list||[]){if(!i?.key)continue;n.entries+=1,n.sizeBytes+=Number(i.size||0);const t=String(i.provider||"").toLowerCase();t===e.GEMINI?(n.providers.gemini.entries+=1,n.providers.gemini.sizeBytes+=Number(i.size||0)):t===e.OPENAI&&(n.providers.openai.entries+=1,n.providers.openai.sizeBytes+=Number(i.size||0));const o=Number(i.savedAtMs||0);o&&(n.oldestMs=null==n.oldestMs?o:Math.min(n.oldestMs,o),n.newestMs=null==n.newestMs?o:Math.max(n.newestMs,o))}return n}();He("cacheEntries").textContent=Qe(t.entries),He("cacheSize").textContent=function(e){const t=Number(e);return!Number.isFinite(t)||t<=0?"0 KB":t<1024?`${t} B`:t<1048576?`${(t/1024).toFixed(1)} KB`:`${(t/1048576).toFixed(2)} MB`}(t.sizeBytes),He("cacheGeminiEntries").textContent=Qe(t.providers.gemini.entries),He("cacheOpenAIEntries").textContent=Qe(t.providers.openai.entries)}async function Ln(i={}){const{silent:o=!1,message:a="Configuration enregistr√©e"}=i,s=He("providerGemini").classList.contains("segmented__btn--active")?e.GEMINI:e.OPENAI,r=An(In(He("maxTokensRange").value)),c=await async function(e){const i=w(e)||t.provider;return await E(n.DEFAULT_PROVIDER,i),i}(s),u=await R(r);return o||Xe(a,{defaultProvider:c,maxOutputTokens:u}),{savedProvider:c,savedTokens:u}}function xn(e={}){const{focusKey:t=!1}=e,n=document.querySelector('[data-section="onboarding"]');if(n){if(n.classList.remove("is-hidden"),n.classList.contains(yt)&&(Lt.delete("onboarding"),ct(Array.from(Lt))),n.classList.contains("is-collapsed")){n.classList.remove("is-collapsed");const e=n.querySelector("[data-collapse-toggle]");e&&e.setAttribute("aria-expanded","true")}if("function"==typeof n.scrollIntoView&&n.scrollIntoView({behavior:"smooth",block:"start"}),t){const e=n.querySelector(ht);e&&e.focus()}}}function Pn(){document.querySelectorAll(pt).forEach(e=>{e.classList.remove("is-open");const t=e.querySelector("button");t&&t.setAttribute("aria-expanded","false")})}async function Rn(e={}){const{silent:t=!1}=e;return ln()?(Ot=!0,Ct=!0,await D(!0),dn(),!0):(t||Xe("Ajoutez au moins une cl√© API avant de valider",{ok:!1}),!1)}async function Gn(e,t){const n=(t||"").trim();return!!n&&(await async function(e,t){const n=(t||"").trim();return await E(k(e),n),n}(e,n),vt[e]=!0,kt=!0,un(),mn(),dn(),!0)}async function Dn(e,t){const n=await Gn(e,t?.value||"");n&&(t&&(t.value=""),cn(e,n),Xe("Cl√© enregistr√©e",{provider:e}))}async function Kn(n){const i=n===e.GEMINI,o=He(i?"geminiModel":"openaiModel");if(!o)return;const a=(o.value||"").trim();await async function(n,i){const o=w(n),a=String(i||"").trim();a?await E(C(o),a):await E(C(o),o===e.OPENAI?t.openaiModel:t.geminiModel)}(n,a);let s="";if(i){const e=He("geminiReasoningEffort");s=Yt(a,e?e.value:""),s&&await x(s)}else{const e=He("openaiReasoningEffort");s=jt(a,e?e.value:""),s&&await L(s)}Xe("Configuration enregistr√©e",{provider:n,model:a,reasoningEffort:s||void 0}),Xt(n,a)}function Fn(e,t){e&&e.classList.toggle("input--warning",t)}async function Vn(e,t){const n=(e?.value||"").trim();if(Fn(e,!1),!n)return Fn(e,!0),yn("Entrez votre cl√© de licence",!1),void Xe("Cl√© de licence manquante",{ok:!1});const i=t?.textContent||"";t&&(t.disabled=!0,t.textContent="Activation...");const o=await async function(e,t={}){const n=Ve(e);if(!n||n.length<5)return{success:!1,error:"Cle trop courte"};const i=await je();if(!t.force&&i&&i.key===n&&Je(i))return{success:!0,license:i,cached:!0};try{const{ok:e,status:t,data:o}=await Ue("https://api.lemonsqueezy.com/v1/licenses/activate",{license_key:n,instance_name:Fe});if(!e)return{success:!1,error:$e(o,`Erreur API (${t})`)};if(o?.activated){const e=Ye(n,o,{activatedAt:i?.activatedAt});return await q(e),{success:!0,license:e}}return{success:!1,error:$e(o,"Cle invalide")}}catch{return{success:!1,error:"Erreur de connexion internet"}}}(n);if(t&&(t.disabled=!1,t.textContent=i),o.success)return e&&(e.value=""),await wn({silent:!0}),Xe("Licence activ√©e",{expiresAt:o.license?.expiresAt||"n/a"}),void function(e,t={}){const{duration:n=2600}=t,i=He("statusToast");i&&(i.textContent=e||"",i.classList.add("is-visible"),Dt&&(clearTimeout(Dt),Dt=null),Dt=setTimeout(()=>{i.classList.remove("is-visible")},n))}("Licence enregistr√©e");const a=o.error||"Cl√© invalide";Fn(e,!0),yn(a,!1),Xe("√âchec de l'activation",{error:a})}async function qn(e=!0){e&&await async function(e=!0){return await E(n.ONBOARDING_SEEN,e?"1":"0"),e}(!0),sn(!1),an(!1)}async function $n(e){await async function(e){await y(k(e))}(e),await Nn({silent:!0}),Xe("Cl√© effac√©e",{provider:e})}async function Un(e){Xe("Test en cours‚Ä¶",{provider:e});const t=await async function(e){const t=w(e)||await N(),n=await b(t);return await T(t)?await Le({provider:t,system:"You are a test endpoint. Reply with exactly: OK",user:"OK",maxOutputTokens:500,cache:!1,webSearch:!1,functionName:"AI.MINIMAL_TEST"}):{ok:!1,provider:t,model:n,code:"API_KEY_MISSING",message:`Cl√© API manquante pour le fournisseur ${t}.`}}(e);t.ok?Xe("OK",{provider:t.provider,model:t.model,response:t.text}):Xe("√âchec",{provider:t.provider,model:t.model,error:t.message,code:t.code})}async function Yn(){document.querySelectorAll("[data-collapse-toggle]").forEach(e=>{const t=e.getAttribute("aria-controls"),n=e.closest("[data-collapsible]");if(!t||!n)return;if(!document.getElementById(t))return;const i=n.classList.contains("is-collapsed");e.setAttribute("aria-expanded",i?"false":"true"),e.addEventListener("click",()=>{const t=!n.classList.contains("is-collapsed");n.classList.toggle("is-collapsed",t),e.setAttribute("aria-expanded",t?"false":"true")})}),function(){let e=!1;const t=()=>{e||(e=!0,setTimeout(async()=>{e=!1,await Tn(),await Mn(),await Sn(),await wn({silent:!0})},250))};try{if("undefined"!=typeof OfficeRuntime&&OfficeRuntime?.storage?.onChanged){const e=OfficeRuntime.storage.onChanged;"function"==typeof e.add?e.add(()=>t()):"function"==typeof e.addListener?e.addListener(()=>t()):"function"==typeof e&&e(()=>t())}}catch{}try{window.addEventListener("storage",()=>t())}catch{}}(),document.querySelectorAll(pt).forEach(e=>{const t=e.querySelector("button");t&&(t.setAttribute("aria-expanded","false"),t.addEventListener("click",n=>{n.stopPropagation();const i=e.classList.contains("is-open");Pn();const o=!i;e.classList.toggle("is-open",o),t.setAttribute("aria-expanded",o?"true":"false")}))}),document.addEventListener("click",e=>{e.target.closest(pt)||Pn()}),await async function(){if(Rt=document.querySelector(".app__main"),!Rt)return;const e=Array.from(Rt.querySelectorAll(gt));xt=new Map,e.forEach(e=>{const t=nt(e);t&&xt.set(t,e)});const t=await async function(){await h();const e=await g(n.SECTION_ORDER);if(!e)return[];try{return F(JSON.parse(e))}catch{return[]}}(),i=e.map(e=>nt(e)).filter(Boolean);Mt=i.slice(),St=function(e,t){const n=[],i=new Set;if(Array.isArray(e))for(const t of e)t&&!i.has(t)&&xt.has(t)&&(i.add(t),n.push(t));for(const e of t)e&&!i.has(e)&&(i.add(e),n.push(e));return n}(t,i),ot(St),Lt=new Set(await async function(){await h();const e=await g(n.SECTION_HIDDEN);if(!e)return[];try{return F(JSON.parse(e))}catch{return[]}}()),st(),at(Lt),dt(),function(){const e=He("sectionManagerList");e&&(e.addEventListener("dragstart",e=>{const t=e.target.closest(".section-row__handle");if(!t)return;const n=t.closest(".section-row");n&&(Pt=n.dataset.sectionKey||"",n.classList.add("is-dragging"),e.dataTransfer&&(e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",Pt)))}),e.addEventListener("dragover",t=>{if(!Pt)return;t.preventDefault();const n=t.target.closest(".section-row");if(!n||n.dataset.sectionKey===Pt)return;!function(e){e.querySelectorAll(".section-row").forEach(e=>{e.classList.remove("is-drop-before","is-drop-after")})}(e);const i=n.getBoundingClientRect(),o=t.clientY<i.top+i.height/2;n.classList.toggle("is-drop-before",o),n.classList.toggle("is-drop-after",!o)}),e.addEventListener("dragleave",e=>{const t=e.target.closest(".section-row");t&&t.classList.remove("is-drop-before","is-drop-after")}),e.addEventListener("drop",t=>{if(!Pt)return;t.preventDefault();const n=t.target.closest(".section-row"),i=n&&n.dataset.sectionKey||"",o=Pt;Pt="",lt(e);let a=St.slice();if(i){const e=n.getBoundingClientRect();a=function(e,t,n,i){const o=e.filter(e=>e!==t),a=o.indexOf(n);if(a<0)return o.push(t),o;const s=i?a:a+1;return o.splice(s,0,t),o}(a,o,i,t.clientY<e.top+e.height/2)}else a=function(e,t){const n=e.filter(e=>e!==t);return n.push(t),n}(a,o);rt(a)}),e.addEventListener("dragend",()=>{Pt="",lt(e)}))}()}(),await async function(){const e=He("privacyModeToggle");e&&(await Sn(),e.addEventListener("change",async()=>{const t=!!e.checked;await async function(e=!1){const t=!!e;return r=t,c=U(),await E(n.PRIVACY_MODE,t?"1":"0"),t}(t),bn(t),t&&(await he(),await Re()),await Tn(),await Mn(),Xe(t?"Mode confidentialit√© activ√©":"Mode confidentialit√© d√©sactiv√©",{privacyMode:t})}))}();const t=He("settingsButton");t&&t.addEventListener("click",()=>nn(!0)),document.querySelectorAll("[data-settings-open]").forEach(e=>{e.addEventListener("click",()=>nn(!0))}),document.querySelectorAll("[data-settings-close]").forEach(e=>{e.addEventListener("click",()=>nn(!1))});const i=He("sectionManagerReset");i&&i.addEventListener("click",()=>{Mt.length&&rt(Mt)});const o=He("pricingHelp");o&&o.addEventListener("click",()=>(function(){const t=He("pricingTableBodyGemini"),n=He("pricingTableBodyOpenAI");if(!t&&!n)return;t&&(t.innerHTML=""),n&&(n.innerHTML="");const i=(e,t)=>{if(!t)return;const n=Ft[e]||[];for(const e of n){const n=document.createElement("tr"),i=Jt(e),o=document.createElement("td");o.textContent=e.id;const a=document.createElement("td");a.className="pricing-table__col-price",a.textContent=zt(e.prices?.input);const s=document.createElement("td");s.className="pricing-table__col-price",s.textContent=zt(e.prices?.output);const r=document.createElement("td");r.className="pricing-table__col-icon",r.textContent=i.cost;const c=document.createElement("td");c.className="pricing-table__col-icon",c.textContent=i.reasoning,n.appendChild(o),n.appendChild(a),n.appendChild(s),n.appendChild(r),n.appendChild(c),t.appendChild(n)}};i(e.GEMINI,t),i(e.OPENAI,n)}(),void on(!0))),document.querySelectorAll("[data-modal-close]").forEach(e=>{e.addEventListener("click",()=>rn())}),document.querySelectorAll("[data-onboarding-close]").forEach(e=>{e.addEventListener("click",async()=>qn(!0))}),document.querySelectorAll("[data-onboarding-keys-close]").forEach(e=>{e.addEventListener("click",()=>sn(!1))});const a=He("onboardingClose");a&&a.addEventListener("click",async()=>qn(!0));const s=He("onboardingDone");s&&s.addEventListener("click",async()=>qn(!0));const u=He("onboardingKeysButton");u&&u.addEventListener("click",async()=>{await qn(!0),xn({focusKey:!0})}),document.querySelectorAll("[data-onboarding-open]").forEach(e=>{e.addEventListener("click",()=>{nn(!1),xn({focusKey:!0})})});const l=He("onboardingKeysSave");l&&l.addEventListener("click",async()=>async function(){const t=He("onboardingGeminiKey"),n=He("onboardingOpenAIKey"),i=await Gn(e.GEMINI,t?.value||""),o=await Gn(e.OPENAI,n?.value||"");t&&(t.value=""),n&&(n.value=""),cn(e.GEMINI,vt.gemini),cn(e.OPENAI,vt.openai),(i||o)&&Xe("Cl√©s enregistr√©es",{gemini:!!i,openai:!!o}),(vt.gemini||vt.openai)&&(await Rn({silent:!0}),sn(!1))}());const d=He("onboardingKeysLater");d&&d.addEventListener("click",()=>sn(!1)),document.addEventListener("keydown",async e=>{"Escape"===e.key&&(Pn(),tn("onboardingKeysModal")?sn(!1):tn("onboardingModal")?await qn(!0):tn("settingsModal")?nn(!1):tn("pricingModal")&&rn())}),He("tabGemini").addEventListener("click",()=>_n("gemini")),He("tabOpenAI").addEventListener("click",()=>_n("openai")),He("providerGemini").addEventListener("click",async()=>{vn(e.GEMINI),await Ln()}),He("providerOpenAI").addEventListener("click",async()=>{vn(e.OPENAI),await Ln()}),He("maxTokensRange").addEventListener("input",()=>{!function(){const e=An(In(He("maxTokensRange").value));He("maxTokensValue").textContent=Qe(e)}()}),He("maxTokensRange").addEventListener("change",async()=>{await Ln()});const f=He("geminiReasoningEffort");f&&(f.addEventListener("input",()=>{const e=He("geminiModel");Yt(e?e.value:"",f.value)}),f.addEventListener("change",async()=>{await async function(){const e=He("geminiModel"),t=He("geminiReasoningEffort");if(!t)return;const n=Yt(e?e.value:"",t.value);n&&await x(n),Xe("Effort de raisonnement enregistr√©",{geminiReasoningEffort:n})}()}));const m=He("openaiReasoningEffort");m&&(m.addEventListener("input",()=>{const e="0"!==m.dataset.allowNone;let t=Bt(m.value);e||"none"!==t||(m.value="1",t=Bt(m.value)),m.setAttribute("aria-valuetext",t)}),m.addEventListener("change",async()=>{await async function(){const e=He("openaiModel"),t=He("openaiReasoningEffort");if(!t)return;const n=jt(e?e.value:"",t.value);n&&await L(n),Xe("Effort de raisonnement enregistr√©",{openaiReasoningEffort:n})}()}));const p=He("geminiModel");p&&p.addEventListener("change",async()=>{await Kn(e.GEMINI)});const y=He("openaiModel");y&&y.addEventListener("change",async()=>{await Kn(e.OPENAI)}),document.querySelectorAll(ht).forEach(e=>{const t=String(e.dataset.keyInput||"").trim().toLowerCase();t&&(e.addEventListener("input",()=>Fn(e,!1)),e.addEventListener("change",async()=>{await Dn(t,e)}),e.addEventListener("keydown",n=>{if("Enter"!==n.key)return;n.preventDefault();const i=e.closest(".input-action")?.querySelector(wt);i?i.click():Dn(t,e)}))}),document.querySelectorAll(wt).forEach(e=>{const t=String(e.dataset.keySave||"").trim().toLowerCase();t&&e.addEventListener("click",async()=>{const n=e.closest(".input-action")?.querySelector(ht);await Dn(t,n),"true"===e.dataset.keyConfirm&&await Rn()})});const w=He("licenseModeSubscribe"),I=He("licenseModeHave");w&&w.addEventListener("click",()=>hn(!1)),I&&I.addEventListener("click",()=>hn(!0,{focus:!0})),document.querySelectorAll(It).forEach(e=>{e.addEventListener("input",()=>Fn(e,!1)),e.addEventListener("keydown",t=>{if("Enter"!==t.key)return;t.preventDefault();const n=document.querySelector(`[data-license-activate][data-license-target="${e.id}"]`)||e.closest(".input-action, .setup-license__row")?.querySelector("[data-license-activate]");n&&Vn(e,n)})}),document.querySelectorAll("[data-license-activate]").forEach(e=>{e.addEventListener("click",async()=>{const t=e.dataset.licenseTarget,n=(t?He(t):null)||e.closest(".input-action, .setup-license__row")?.querySelector(It);await Vn(n,e)})}),document.querySelectorAll("[data-license-test]").forEach(e=>{e.addEventListener("click",async()=>{const t=e.dataset.licenseTarget,n=(t?He(t):null)||e.closest(".input-action")?.querySelector(It);await async function(e,t){if(!e||!t)return;const n=(e.value||"").trim(),i=_t||await je(),o=n||i?.key||"";if(Fn(e,!1),!o)return Fn(e,!0),void Xe("Cl√© de licence manquante",{ok:!1});const a=t.textContent;t.disabled=!0,t.textContent="Test...";const s=await async function(e,t={}){const n=Ve(e);if(!n||n.length<5)return{success:!1,error:"Cle trop courte"};const i=await je(),o=t.instanceId||i?.instanceId||"";try{const{ok:e,status:t,data:a}=await Ue("https://api.lemonsqueezy.com/v1/licenses/validate",{license_key:n,instance_id:o||void 0});return e?a?.valid?{success:!0,license:Ye(n,a,{instanceId:o,activatedAt:i?.activatedAt})}:{success:!1,error:$e(a,"Cle invalide")}:{success:!1,error:$e(a,`Erreur API (${t})`)}}catch{return{success:!1,error:"Erreur de connexion internet"}}}(o);if(t.disabled=!1,t.textContent=a,s.success){const e=s.license?.expiresAt||"n/a";return i&&o===i.key?(await ze({...i,...s.license,valid:!0,lastCheckedAt:(new Date).toISOString()}),await wn({silent:!0})):i&&i.key||yn("Licence valide (non enregistr√©e)",!0),void(!n||i&&o===i.key?Xe("Licence valide",{expiresAt:e}):Xe("Licence valide. Cliquez sur Activer pour l'enregistrer.",{expiresAt:e}))}const r=s.error||"Cl√© invalide";Xe("Licence invalide",{error:r}),i&&o===i.key?(await ze({...i,valid:!1,lastCheckedAt:(new Date).toISOString()}),await wn({silent:!0})):i&&i.key||yn(r,!1)}(n,e)})}),document.querySelectorAll("[data-license-clear]").forEach(e=>{e.addEventListener("click",async()=>async function(){await async function(){await $()}(),_t=null,document.querySelectorAll(It).forEach(e=>{e.value="",Fn(e,!1)}),await wn({silent:!0}),Xe("Licence effac√©e",{ok:!0})}())});const A=He("clearGemini");A&&A.addEventListener("click",async()=>$n(e.GEMINI));const v=He("clearOpenAI");v&&v.addEventListener("click",async()=>$n(e.OPENAI));const _=He("testGemini");_&&_.addEventListener("click",async()=>Un(e.GEMINI));const N=He("testOpenAI");N&&N.addEventListener("click",async()=>Un(e.OPENAI)),He("clearLogs").addEventListener("click",async()=>{await he(),await Tn(),Xe("Journal effac√©",{ok:!0})}),He("refreshCache").addEventListener("click",async()=>{await Mn(),Xe("Cache actualis√©",{ok:!0})}),He("clearCache").addEventListener("click",async()=>{await Re(),await Mn(),Xe("Cache vid√©",{ok:!0})}),_n("gemini"),await Nn(),await wn({silent:!0}),await Tn(),await Mn(),await async function(){await async function(){return await h(),"1"===await g(n.ONBOARDING_SEEN)}()||an(!0)}(),setInterval(Tn,2e3),setInterval(Mn,12e3)}document.addEventListener("DOMContentLoaded",async()=>{await async function(){try{"undefined"!=typeof Office&&Office?.onReady&&await Office.onReady()}catch{}}(),await Yn()})})();
//# sourceMappingURL=taskpane.js.map