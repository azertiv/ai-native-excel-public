(()=>{"use strict";const e=Object.freeze({GEMINI:"gemini",OPENAI:"openai"}),t=Object.freeze({provider:e.GEMINI,geminiModel:"gemini-3-flash-preview",openaiModel:"gpt-5-mini",geminiReasoningEffort:"minimal",openaiReasoningEffort:"low",maxOutputTokens:4096,concurrencyLimit:4,rpmLimit:0,retry:2,timeoutMs:12e4,cache:!0,cacheTtlSec:604800}),n=Object.freeze({DEFAULT_PROVIDER:"AI_DEFAULT_PROVIDER_V3",GEMINI_API_KEY:"AI_GEMINI_API_KEY_V3",OPENAI_API_KEY:"AI_OPENAI_API_KEY_V3",GEMINI_MODEL:"AI_GEMINI_MODEL_V3",OPENAI_MODEL:"AI_OPENAI_MODEL_V3",GEMINI_REASONING_EFFORT:"AI_GEMINI_REASONING_EFFORT_V3",OPENAI_REASONING_EFFORT:"AI_OPENAI_REASONING_EFFORT_V3",MAX_OUTPUT_TOKENS:"AI_MAX_OUTPUT_TOKENS_V3",CONCURRENCY_LIMIT:"AI_CONCURRENCY_LIMIT_V1",RPM_LIMIT:"AI_RPM_LIMIT_V1",ONBOARDING_SEEN:"AI_ONBOARDING_SEEN_V1",ONBOARDING_KEYS_CONFIRMED:"AI_ONBOARDING_KEYS_CONFIRMED_V1",SECTION_ORDER:"AI_SECTION_ORDER_V1",SECTION_HIDDEN:"AI_SECTION_HIDDEN_V1",LICENSE:"AI_LICENSE_V1",PRIVACY_MODE:"AI_PRIVACY_MODE_V1",MIGRATION_DONE:"AI_MIGRATION_DONE_V3",REQUEST_LOG:"AI_REQUEST_LOG_V1",REQUEST_LOG_CLEAR_AT:"AI_REQUEST_LOG_CLEAR_AT_V1",USAGE_TOTALS:"AI_USAGE_TOTALS_V1",CACHE_INDEX:"AI_CACHE_INDEX_V1",CACHE_CLEAR_AT:"AI_CACHE_CLEAR_AT_V1",RUNTIME_STATUS:"AI_RUNTIME_STATUS_V1"}),o=new Set([n.GEMINI_API_KEY,n.OPENAI_API_KEY,n.LICENSE]),i=Object.freeze({GEMINI_API_KEY:"GEMINI_API_KEY",MAX_OUTPUT_TOKENS:"MAX_OUTPUT_TOKENS",DEFAULT_PROVIDER_V2:"AI_DEFAULT_PROVIDER_V2",GEMINI_API_KEY_V2:"AI_GEMINI_API_KEY_V2",OPENAI_API_KEY_V2:"AI_OPENAI_API_KEY_V2",GEMINI_MODEL_V2:"AI_GEMINI_MODEL_V2",OPENAI_MODEL_V2:"AI_OPENAI_MODEL_V2",GEMINI_MAX_TOKENS_V2:"AI_GEMINI_MAX_OUTPUT_TOKENS_V2",OPENAI_MAX_TOKENS_V2:"AI_OPENAI_MAX_OUTPUT_TOKENS_V2"});let s=null,a=!1,r=null,c=0;const u=1500;let l=null,d=0,m=null,p=0,f=null,g=0,h=null,y=0;const k={gemini:null,openai:null},E={gemini:0,openai:0},T={gemini:null,openai:null},I={gemini:0,openai:0};function A(){a=!0}const w={kind:"memory",storage:(()=>{const e=new Map;return{getItem:async t=>e.has(t)?e.get(t):null,async setItem(t,n){e.set(t,String(n))},async removeItem(t){e.delete(t)}}})()};function v(){if(!a)try{if("undefined"!=typeof OfficeRuntime&&OfficeRuntime?.storage?.getItem)return{kind:"office",storage:OfficeRuntime.storage}}catch{}try{if("undefined"!=typeof window&&window?.localStorage?.getItem)return{kind:"local",storage:window.localStorage}}catch{}return w}function N(){try{if("undefined"!=typeof window&&window?.localStorage?.getItem)return window.localStorage}catch{return null}return null}function _(e,t){try{return e.getItem(t)}catch{return null}}function b(e,t,n){try{return e.setItem(t,n),!0}catch{return!1}}function S(e,t){try{return e.removeItem(t),!0}catch{return!1}}async function M(e,t={}){const{kind:n,storage:i}=v(),s=t.sensitive??function(e){return o.has(e)}(e),r=!1!==t.allowLocalFallback;if("local"===n)return _(i,e);if("office"===n){let t=null;try{t=await i.getItem(e)}catch{A()}if(null!=t){if(s){const t=N();t&&S(t,e)}return t}if(!r)return null;const n=N();if(!n)return null;const o=_(n,e);if(null==o)return null;if(!a)try{await i.setItem(e,String(o)),S(n,e)}catch{A()}return o}try{return await i.getItem(e)}catch{return null}}async function C(e,t,n={}){const{kind:o,storage:i}=v(),s=null==t?"":String(t),a=!1!==n.allowLocalFallback;if("local"!==o){if("office"===o){let t=!1;try{await i.setItem(e,s),t=!0}catch{A()}const n=N();if(t)return void(n&&S(n,e));if(!a||!n)return;return void b(n,e,s)}try{await i.setItem(e,s)}catch{}}else b(i,e,s)}async function x(e){const{kind:t,storage:n}=v();if("local"!==t){if("office"===t){let t=!1;try{await n.removeItem(e),t=!0}catch{A()}const o=N();return void(o&&S(o,e))}try{await n.removeItem(e)}catch{}}else S(n,e)}async function O(){if(s)return s;s=(async()=>{if("1"!==await M(n.MIGRATION_DONE)){if(!L(await M(n.DEFAULT_PROVIDER))){const e=L(await M(i.DEFAULT_PROVIDER_V2));await C(n.DEFAULT_PROVIDER,e||t.provider)}if(!await M(n.GEMINI_API_KEY)){const e=await M(i.GEMINI_API_KEY_V2)||await M(i.GEMINI_API_KEY);e&&await C(n.GEMINI_API_KEY,e)}if(!await M(n.OPENAI_API_KEY)){const e=await M(i.OPENAI_API_KEY_V2);e&&await C(n.OPENAI_API_KEY,e)}if(!await M(n.GEMINI_MODEL)){const e=await M(i.GEMINI_MODEL_V2);await C(n.GEMINI_MODEL,e||t.geminiModel)}if(!await M(n.OPENAI_MODEL)){const e=await M(i.OPENAI_MODEL_V2);await C(n.OPENAI_MODEL,e||t.openaiModel)}if(!await M(n.MAX_OUTPUT_TOKENS)){const e=[await M(i.MAX_OUTPUT_TOKENS),await M(i.GEMINI_MAX_TOKENS_V2),await M(i.OPENAI_MAX_TOKENS_V2)].map(e=>parseInt(String(e||"").trim(),10)).filter(e=>Number.isFinite(e)&&e>0),o=e.length?Math.max(...e):t.maxOutputTokens;await C(n.MAX_OUTPUT_TOKENS,String(o))}await C(n.MIGRATION_DONE,"1")}})();try{await s}finally{s=null}}function L(t){if(!t)return"";const n=String(t).trim().toLowerCase();return n===e.GEMINI?e.GEMINI:n===e.OPENAI?e.OPENAI:"google"===n||"gem"===n?e.GEMINI:"oai"===n||"chatgpt"===n?e.OPENAI:""}const P=new Set(["auto","minimal","low","medium","high"]),R=new Set(["none","minimal","low","medium","high"]);function G(e){const n=String(e||"").trim().toLowerCase();return n&&P.has(n)?n:t.geminiReasoningEffort}function D(e){const n=String(e||"").trim().toLowerCase();return n&&R.has(n)?n:t.openaiReasoningEffort}async function q(){const e=me();if(l&&e-d<u)return l;await O();const o=L(await M(n.DEFAULT_PROVIDER))||t.provider;return l=o,d=e,o}function H(t){return L(t)===e.OPENAI?n.OPENAI_API_KEY:n.GEMINI_API_KEY}async function K(t){const n=L(t)===e.OPENAI?e.OPENAI:e.GEMINI,o=me();if(null!=k[n]&&o-E[n]<u)return(k[n]||"").trim();await O();const i=await M(H(n))||"",s=String(i).trim();return k[n]=s,E[n]=o,s}async function $(e){return!!await K(e)}function F(t){return L(t)===e.OPENAI?n.OPENAI_MODEL:n.GEMINI_MODEL}async function U(n){const o=L(n)===e.OPENAI?e.OPENAI:e.GEMINI,i=me(),s=T[o];if(s&&i-I[o]<u)return s;await O();const a=await M(F(o)),r=a&&String(a).trim()?String(a).trim():o===e.OPENAI?t.openaiModel:t.geminiModel;return T[o]=r,I[o]=i,r}async function j(){const e=me();if(f&&e-g<u)return f;await O();const o=G(await M(n.GEMINI_REASONING_EFFORT)||t.geminiReasoningEffort);return f=o,g=e,o}async function V(){const e=me();if(h&&e-y<u)return h;await O();const o=D(await M(n.OPENAI_REASONING_EFFORT)||t.openaiReasoningEffort);return h=o,y=e,o}async function Y(e){const t=D(e);return await C(n.OPENAI_REASONING_EFFORT,t),h=t,y=me(),t}async function B(e){const t=G(e);return await C(n.GEMINI_REASONING_EFFORT,t),f=t,g=me(),t}async function J(){const e=me();if(m&&e-p<u)return m;await O();const o=await M(n.MAX_OUTPUT_TOKENS),i=fe(parseInt(String(o||"").trim(),10),1,128e3,t.maxOutputTokens);return m=i,p=e,i}async function z(e){const o=fe(e,1,128e3,t.maxOutputTokens);return await C(n.MAX_OUTPUT_TOKENS,String(o)),m=o,p=me(),o}const X=[4,8,16,32,64,128];function Q(e){const n=fe(e,X[0],X[X.length-1],t.concurrencyLimit);if(X.includes(n))return n;let o=X[0],i=Math.abs(n-o);for(const e of X.slice(1)){const t=Math.abs(n-e);t<i&&(o=e,i=t)}return o}async function W(){return await O(),Q(await M(n.CONCURRENCY_LIMIT))}async function Z(e){const t=Q(e);return await C(n.CONCURRENCY_LIMIT,String(t)),t}function ee(e){return fe("string"==typeof e?parseInt(e.trim(),10):Number(e),0,1e5,t.rpmLimit)}async function te(){return await O(),ee(await M(n.RPM_LIMIT))}async function ne(e){const t=ee(e);return await C(n.RPM_LIMIT,String(t)),t}async function oe(){return await O(),"1"===await M(n.ONBOARDING_KEYS_CONFIRMED)}async function ie(e=!0){return await C(n.ONBOARDING_KEYS_CONFIRMED,e?"1":"0"),e}function se(e){return e&&"object"==typeof e?{active:fe(e.active,0,1e5,0),queued:fe(e.queued,0,1e5,0),rpm:fe(e.rpm,0,1e6,0),ts:fe(e.ts,0,Number.MAX_SAFE_INTEGER,0)}:{active:0,queued:0,rpm:0,ts:0}}async function ae(e){const t=se(e);return await C(n.RUNTIME_STATUS,JSON.stringify(t)),t}async function re(){return await async function(){const e=me();if(null!=r&&e-c<2e3)return r;const t="1"===await M(n.PRIVACY_MODE);return r=t,c=e,t}()}function ce(e){if(!Array.isArray(e))return[];const t=[],n=new Set;for(const o of e){const e=String(o||"").trim();e&&!n.has(e)&&(n.add(e),t.push(e))}return t}async function ue(e){const t=ce(e);return await C(n.SECTION_HIDDEN,JSON.stringify(t)),t}async function le(e){return e?(await C(n.LICENSE,JSON.stringify(e)),e):(await x(n.LICENSE),null)}async function de(){await x(n.LICENSE)}function me(){return Date.now()}function pe(e){return new Promise(t=>setTimeout(t,e))}function fe(e,t,n,o=t){const i=parseInt(String(e),10);return Number.isFinite(i)?Math.max(t,Math.min(n,i)):o}const ge=[/\bsk-[A-Za-z0-9-_]{1,}\b/gi,/\bAIza[0-9A-Za-z_-]{1,}\b/gi,/\b[A-Z0-9]{4}(?:-[A-Z0-9]{4}){1,3}\b/gi];function he(e){if(null==e)return"";let t=String(e);for(const e of ge)t=t.replace(e,"[REDACTED]");return t}function ye(e){if(null==e)return e;if("string"==typeof e)return he(e);if(Array.isArray(e))return e.map(ye);if("object"==typeof e){const t={};for(const[n,o]of Object.entries(e))t[n]=ye(o);return t}return e}function ke(e){const t=parseInt(String(e||"").trim(),10);return Number.isFinite(t)&&t>0?t:0}const Ee="AI_CACHE_ENTRY_V1:",Te=5242880;let Ie=0;async function Ae(){const e=ke(await M(n.CACHE_CLEAR_AT));return e>Ie&&(Ie=e),Ie}async function we(){const e=await M(n.CACHE_INDEX);if(!e)return[];try{const t=JSON.parse(e);return Array.isArray(t)?t:[]}catch{return[]}}async function ve(e){try{await C(n.CACHE_INDEX,JSON.stringify(e))}catch{}}function Ne(e,t=0){const n=me(),o=[],i=[];for(const s of e||[]){if(!s||!s.key)continue;const e=Number(s.savedAtMs||0);t&&(!Number.isFinite(e)||e<=t)||s.expiresAtMs&&s.expiresAtMs<=n?i.push(s.key):o.push(s)}let s=0;for(const e of o)s+=Number(e?.size||0);if(o.length>5e3||s>Te){o.sort((e,t)=>(e.savedAtMs||0)-(t.savedAtMs||0));let e=0;for(;o.length-e>5e3||s>Te;){const t=o[e];if(!t)break;i.push(t.key),s-=Number(t?.size||0),e+=1}return{list:o.slice(e),removedKeys:i}}return{list:o,removedKeys:i}}async function _e(e){e&&await x(Ee+e)}async function be(e){const t=await we(),n=(t||[]).filter(t=>t?.key!==e);n.length!==t.length&&await ve(n)}async function Se(e,t,n,o={}){if(!e)return;if(await re())return;const i=me(),s=await Ae(),a=s&&i<=s?s+1:i,r="number"==typeof n&&n>0?a+n:null,c={v:1,savedAtMs:a,expiresAtMs:r,value:t},u=JSON.stringify(c),l=function(e){if("string"!=typeof e)return 0;try{if("undefined"!=typeof TextEncoder)return(new TextEncoder).encode(e).length}catch{}return e.length}(u);if(l>Te)return await _e(e),void await be(e);await C(Ee+e,u);const d=await we(),m=o.provider||t?.provider||"",p=o.model||t?.model||"";let f=!1;const g=(d||[]).map(t=>t?.key!==e?t:(f=!0,{key:e,provider:m,model:p,size:l,savedAtMs:a,expiresAtMs:r}));f||g.push({key:e,provider:m,model:p,size:l,savedAtMs:a,expiresAtMs:r});const h=Ne(g,s);for(const e of h.removedKeys)await _e(e);await ve(h.list)}function Me(e){if(Array.isArray(e))return e.map(Me);if(t=e,"[object Object]"===Object.prototype.toString.call(t)){const t={};for(const n of Object.keys(e).sort())t[n]=Me(e[n]);return t}var t;return e}async function Ce(e){const t="string"==typeof e?e:(n=e,JSON.stringify(Me(n)));var n;try{if("undefined"!=typeof crypto&&crypto?.subtle?.digest&&"undefined"!=typeof TextEncoder){const e=(new TextEncoder).encode(t),n=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(n)).map(e=>e.toString(16).padStart(2,"0")).join("")}}catch{}return`fnv1a:${function(e){let t=2166136261;for(let n=0;n<e.length;n++)t^=e.charCodeAt(n),t=Math.imul(t,16777619);return(t>>>0).toString(16).padStart(8,"0")}(t)}`}const xe=1/0;let Oe=[],Le=null,Pe=!1,Re=0,Ge=0,De=[],qe=null,He=null,Ke=Qe(),$e=null,Fe=!1,Ue=0,je=!1;async function Ve(e={}){const t=ke(await M(n.REQUEST_LOG_CLEAR_AT));return t>Ge&&(Ge=t,Oe=[],e.reset?(Pe=!0,Le=null,Re=me()):Pe=!1),Ge}function Ye(e){return!!e&&!1===e.ok}async function Be(e=!1){if(Le)return Le;Le=(async()=>{if(await re())return!e&&Pe||(Pe=!0,Re=me()),Oe;const t=await Ve();if(!e&&Pe)return Oe;const o=await M(n.REQUEST_LOG);let i=[];if(o)try{i=function(e){if(Array.isArray(e))return e;if(e&&"object"==typeof e){const t=Array.isArray(e.normal)?e.normal:[],n=Array.isArray(e.errors)?e.errors:[];return t.concat(n)}return[]}(JSON.parse(o))}catch{i=[]}const s=me();return i=i.map(e=>{if(!e)return null;let t=e.ts;if("string"==typeof t){const e=Date.parse(t);Number.isFinite(e)&&(t=e)}return"number"!=typeof t?null:{...e,ts:t}}).filter(e=>e&&"number"==typeof e.ts&&e.ts>t&&s-e.ts<=xe).map(e=>st(e)),Oe=i,Je(),Pe=!0,Re=me(),Oe})();try{return await Le}finally{Le=null}}function Je(){const e=me(),t=Ge||0,n=(Oe||[]).filter(n=>n&&"number"==typeof n.ts&&n.ts>t&&e-n.ts<=xe),o=[],i=[];for(const e of n)Ye(e)?i.push(e):o.push(e);o.sort((e,t)=>e.ts-t.ts),i.sort((e,t)=>e.ts-t.ts);const s=o.slice(-50).concat(i.slice(-50));s.sort((e,t)=>e.ts-t.ts),Oe=s}function ze(e){const t=Number(e);return!Number.isFinite(t)||t<=0?0:Math.floor(t)}function Xe(e){const t=Number(e);return!Number.isFinite(t)||t<=0?0:t}function Qe(){return{inputTokens:0,outputTokens:0,reasoningTokens:0,cachedInputTokens:0,cacheStorageTokenHours:0,requests:0,batchApplied:{},byProvider:{[e.GEMINI]:{inputTokens:0,outputTokens:0,reasoningTokens:0,cachedInputTokens:0,cacheStorageTokenHours:0,requests:0,models:{}},[e.OPENAI]:{inputTokens:0,outputTokens:0,reasoningTokens:0,cachedInputTokens:0,cacheStorageTokenHours:0,requests:0,models:{}}}}}function We(e){if(!e||"object"!=typeof e)return{};const t=me(),n=Object.entries(e).filter(([,e])=>e&&"object"==typeof e).filter(([,e])=>{const n=Number(e.ts)||0;return!n||t-n<=864e5}).sort((e,t)=>(Number(e[1].ts)||0)-(Number(t[1].ts)||0)).slice(-80),o={};for(const[e,t]of n)o[e]=t;return o}async function Ze(t=!1){if($e)return $e;$e=(async()=>{if(await re())return!t&&Fe||(Fe=!0,Ue=me()),Ke;if(!t&&Fe)return Ke;const o=await M(n.USAGE_TOTALS);let i=null;if(o)try{i=JSON.parse(o)}catch{i=null}return Ke=function(t){const n=Qe();if(!t||"object"!=typeof t)return n;n.inputTokens=ze(t.inputTokens),n.outputTokens=ze(t.outputTokens),n.reasoningTokens=ze(t.reasoningTokens),n.cachedInputTokens=ze(t.cachedInputTokens),n.cacheStorageTokenHours=Xe(t.cacheStorageTokenHours),n.requests=ze(t.requests),n.batchApplied=function(t){if(!t||"object"!=typeof t)return{};const n={};for(const[o,i]of Object.entries(t)){if(!i||"object"!=typeof i)continue;const t=i.models&&"object"==typeof i.models?i.models:{},s={};for(const[n,o]of Object.entries(t)){if(!o||"object"!=typeof o)continue;const t=String(o.provider||"").toLowerCase();if(t!==e.GEMINI&&t!==e.OPENAI)continue;const i=String(o.modelKey||o.model||n||"").toLowerCase();i&&(s[n]={provider:t,modelKey:i,label:"string"==typeof o.label?o.label:"",inputTokens:ze(o.inputTokens),outputTokens:ze(o.outputTokens),reasoningTokens:ze(o.reasoningTokens),cachedInputTokens:ze(o.cachedInputTokens),cacheStorageTokenHours:Xe(o.cacheStorageTokenHours),requests:ze(o.requests)})}n[o]={ts:Number(i.ts)||0,models:s}}return We(n)}(t.batchApplied);const o=t.byProvider&&"object"==typeof t.byProvider?t.byProvider:{};for(const t of[e.GEMINI,e.OPENAI]){const e=o[t];if(!e||"object"!=typeof e)continue;const i=n.byProvider[t];i.inputTokens=ze(e.inputTokens),i.outputTokens=ze(e.outputTokens),i.reasoningTokens=ze(e.reasoningTokens),i.cachedInputTokens=ze(e.cachedInputTokens),i.cacheStorageTokenHours=Xe(e.cacheStorageTokenHours),i.requests=ze(e.requests);const s=e.models&&"object"==typeof e.models?e.models:{};for(const[e,t]of Object.entries(s)){if(!t||"object"!=typeof t)continue;const n="string"==typeof t.label?t.label:String(e||""),o=String(e||n||"").toLowerCase();o&&(i.models[o]={label:n,inputTokens:ze(t.inputTokens),outputTokens:ze(t.outputTokens),reasoningTokens:ze(t.reasoningTokens),cachedInputTokens:ze(t.cachedInputTokens),cacheStorageTokenHours:Xe(t.cacheStorageTokenHours),requests:ze(t.requests)})}}return n}(i),Fe=!0,Ue=me(),Ke})();try{return await $e}finally{$e=null}}function et(t){if(!t||"object"!=typeof t)return!1;if(t.batch&&Array.isArray(t.batchModels)){const n=t.batchId?String(t.batchId):"",o=me(),i={};for(const n of t.batchModels){if(!n||"object"!=typeof n)continue;const t=String(n.provider||"").toLowerCase();if(t!==e.GEMINI&&t!==e.OPENAI)continue;const o=String(n.model||"").trim(),s=(o||"unknown").toLowerCase(),a=`${t}|${s}`,r=i[a]||{provider:t,modelKey:s,label:o,inputTokens:0,outputTokens:0,reasoningTokens:0,cachedInputTokens:0,cacheStorageTokenHours:0,requests:0};r.inputTokens+=ze(n.inputTokens),r.outputTokens+=ze(n.outputTokens),r.reasoningTokens+=ze(n.reasoningTokens),r.cachedInputTokens+=ze(n.cachedInputTokens),r.cacheStorageTokenHours+=Xe(n.cacheStorageTokenHours),r.requests+=ze(n.requests),!r.label&&o&&(r.label=o),i[a]=r}if(!n){let e=!1;for(const t of Object.values(i))nt(t.provider,t.modelKey,t.label,t)&&(e=!0);return e}const s=Ke.batchApplied||{},a=s[n]?.models||{},r=new Set([...Object.keys(a),...Object.keys(i)]);let c=!1;for(const t of r){const n=i[t]||null,o=a[t]||null;if(!n&&!o)continue;const s=(n?.provider||o?.provider||"").toLowerCase(),r=(n?.modelKey||o?.modelKey||"").toLowerCase();if(s!==e.GEMINI&&s!==e.OPENAI)continue;if(!r)continue;const u={inputTokens:(n?.inputTokens||0)-(o?.inputTokens||0),outputTokens:(n?.outputTokens||0)-(o?.outputTokens||0),reasoningTokens:(n?.reasoningTokens||0)-(o?.reasoningTokens||0),cachedInputTokens:(n?.cachedInputTokens||0)-(o?.cachedInputTokens||0),cacheStorageTokenHours:(n?.cacheStorageTokenHours||0)-(o?.cacheStorageTokenHours||0),requests:(n?.requests||0)-(o?.requests||0),label:n?.label||o?.label||""};tt(u)&&nt(s,r,u.label,u)&&(c=!0)}return s[n]={ts:Number(t.ts)||o,models:i},Ke.batchApplied=We(s),c}const n=ze(t.inputTokens),o=ze(t.outputTokens),i=ze(t.reasoningTokens),s=ze(t.cachedInputTokens),a=Xe(t.cacheStorageTokenHours);if(!(n+o+i+s>0||a>0))return!1;const r=String(t.provider||"").toLowerCase();if(r!==e.GEMINI&&r!==e.OPENAI)return!1;const c=String(t.model||"").trim();return nt(r,(c||"unknown").toLowerCase(),c,{inputTokens:n,outputTokens:o,reasoningTokens:i,cachedInputTokens:s,cacheStorageTokenHours:a,requests:1})}function tt(e){return 0!==Number(e?.inputTokens||0)||0!==Number(e?.outputTokens||0)||0!==Number(e?.reasoningTokens||0)||0!==Number(e?.cachedInputTokens||0)||0!==Number(e?.cacheStorageTokenHours||0)||0!==Number(e?.requests||0)}function nt(e,t,n,o){if(!o)return!1;const i=Number(o.inputTokens||0),s=Number(o.outputTokens||0),a=Number(o.reasoningTokens||0),r=Number(o.cachedInputTokens||0),c=Number(o.cacheStorageTokenHours||0),u=Number(o.requests||0);if(!(i||s||a||r||c||u))return!1;Ke.inputTokens=Math.max(0,Ke.inputTokens+i),Ke.outputTokens=Math.max(0,Ke.outputTokens+s),Ke.reasoningTokens=Math.max(0,Ke.reasoningTokens+a),Ke.cachedInputTokens=Math.max(0,Ke.cachedInputTokens+r),Ke.cacheStorageTokenHours=Math.max(0,Ke.cacheStorageTokenHours+c),Ke.requests=Math.max(0,Ke.requests+u);const l=Ke.byProvider[e];l.inputTokens=Math.max(0,l.inputTokens+i),l.outputTokens=Math.max(0,l.outputTokens+s),l.reasoningTokens=Math.max(0,l.reasoningTokens+a),l.cachedInputTokens=Math.max(0,l.cachedInputTokens+r),l.cacheStorageTokenHours=Math.max(0,l.cacheStorageTokenHours+c),l.requests=Math.max(0,l.requests+u);const d=l.models||{},m=d[t]||{label:n,inputTokens:0,outputTokens:0,reasoningTokens:0,cachedInputTokens:0,cacheStorageTokenHours:0,requests:0};return!m.label&&n&&(m.label=n),m.inputTokens=Math.max(0,m.inputTokens+i),m.outputTokens=Math.max(0,m.outputTokens+s),m.reasoningTokens=Math.max(0,m.reasoningTokens+a),m.cachedInputTokens=Math.max(0,m.cachedInputTokens+r),m.cacheStorageTokenHours=Math.max(0,m.cacheStorageTokenHours+c),m.requests=Math.max(0,m.requests+u),d[t]=m,l.models=d,!0}function ot(e){if(!e||"object"!=typeof e)return;const t=st({ts:me(),...e});if(t.batch&&t.batchId){let e=!1;for(let n=De.length-1;n>=0;n-=1){const o=De[n];if(o&&o.batch&&o.batchId===t.batchId){De[n]=t,e=!0;break}}e||De.push(t)}else De.push(t);De.length>=80?it():qe||(qe=setTimeout(()=>{qe=null,it()},500))}async function it(){if(He)return He;if(De.length){He=(async()=>{try{const e=De;if(De=[],!e.length)return;await Ze();let t=!1;for(const n of e)et(n)&&(t=!0);if(t&&(Ue=me(),je=!0),await re())return Oe.push(...e),Je(),Pe=!0,void(Re=me());await Ve({reset:!0}),Pe||await Be();for(const t of e)if(t?.batch&&t?.batchId){const e=Oe.findIndex(e=>e?.batch&&e?.batchId===t.batchId);e>=0?Oe[e]=t:Oe.push(t)}else Oe.push(t);Je(),Re=me(),await async function(){try{if(await re())return;Je(),await C(n.REQUEST_LOG,JSON.stringify(Oe.slice(-100)))}catch{}}(),je&&(await async function(){try{if(await re())return;await C(n.USAGE_TOTALS,JSON.stringify(Ke))}catch{}}(),je=!1)}catch{}})();try{await He}finally{He=null}}}function st(e){return e&&"object"==typeof e?ye(e):e}async function at(){const e=me();De=[],qe&&(clearTimeout(qe),qe=null),Oe=[],Pe=!0,Le=null,Ge=e,Re=e,await C(n.REQUEST_LOG_CLEAR_AT,String(e)),await x(n.REQUEST_LOG)}const rt=new class{constructor(e=500){this.maxEntries=e,this.map=new Map}get(e){if(!this.map.has(e))return null;const t=this.map.get(e);return t?.expiresAtMs&&t.expiresAtMs<=me()?(this.map.delete(e),null):(this.map.delete(e),this.map.set(e,t),t.value)}set(e,t,n){const o="number"==typeof n&&n>0?me()+n:null;for(this.map.has(e)&&this.map.delete(e),this.map.set(e,{value:t,expiresAtMs:o});this.map.size>this.maxEntries;){const e=this.map.keys().next().value;this.map.delete(e)}}clear(){this.map.clear()}}(800);let ct=0;const ut=new Map,lt=9e5,dt=new Map,mt=new Map,pt=Symbol("queue_cancelled"),ft={ok:!1,code:"QUEUE_CANCELLED",message:"File d'attente arrêtée."};let gt=t.concurrencyLimit,ht=0,yt=t.rpmLimit,kt=0,Et=[],Tt=Promise.resolve(),It=null,At=0;const wt=new class{constructor(){this._items=[],this._head=0}get length(){return this._items.length-this._head}push(e){this._items.push(e)}shift(){if(this._head>=this._items.length)return;const e=this._items[this._head++];return this._head>1024&&2*this._head>this._items.length&&(this._items=this._items.slice(this._head),this._head=0),e}drain(){const e=this._items.slice(this._head);return this._items=[],this._head=0,e}};let vt=null,Nt=null,_t="";const bt=Number.POSITIVE_INFINITY;let St=null;function Mt(){return At+wt.length}function Ct(){return!!St||!(Mt()<bt)&&(St=function(){const e=me();return{id:`batch_${e}_${Math.random().toString(36).slice(2,8)}`,startedAt:e,endedAt:0,totalRequests:0,okCount:0,errorCount:0,cachedCount:0,inputTokens:0,outputTokens:0,reasoningTokens:0,cachedInputTokens:0,msSum:0,msMax:0,msMin:0,peakQueued:0,peakActive:0,models:new Map,lastLogAt:0}}(),!0)}function xt(){St&&(St.peakQueued=Math.max(St.peakQueued,wt.length),St.peakActive=Math.max(St.peakActive,At))}function Ot({provider:e,model:t,ok:n,cached:o,usage:i,ms:s}){if(!St)return!1;St.totalRequests+=1,n?St.okCount+=1:St.errorCount+=1,o&&(St.cachedCount+=1);const a=Number(i?.inputTokens||0)||0,r=Number(i?.outputTokens||0)||0,c=Number(i?.reasoningTokens||0)||0,u=Number(i?.cachedInputTokens||0)||0;St.inputTokens+=a,St.outputTokens+=r,St.reasoningTokens+=c,St.cachedInputTokens+=u;const l=Number(s||0)||0;if(l>0&&(St.msSum+=l,St.msMax=Math.max(St.msMax,l),St.msMin=St.msMin?Math.min(St.msMin,l):l),a+r+c+u>0){const n=`${String(e||"").toLowerCase()}|${String(t||"").trim()}`,o=St.models.get(n)||{provider:String(e||"").toLowerCase(),model:String(t||"").trim(),inputTokens:0,outputTokens:0,reasoningTokens:0,cachedInputTokens:0,requests:0};o.inputTokens+=a,o.outputTokens+=r,o.reasoningTokens+=c,o.cachedInputTokens+=u,o.requests+=1,St.models.set(n,o)}return function(){if(!St)return;const e=me();if(e-St.lastLogAt<1e3)return;St.lastLogAt=e;const t=Lt(!1);t&&ot(t)}(),!0}function Lt(e){if(!St)return null;const t=Array.from(St.models.values()),n=St.inputTokens+St.outputTokens+St.reasoningTokens,o=Math.max(0,(St.endedAt||me())-St.startedAt),i=St.totalRequests>0?Math.round(St.msSum/St.totalRequests):0;return{fn:"AI.BATCH",provider:"batch",model:"",ok:0===St.errorCount,cache:!1,ms:o,inputTokens:St.inputTokens,outputTokens:St.outputTokens,reasoningTokens:St.reasoningTokens,cachedInputTokens:St.cachedInputTokens,totalTokens:n,batch:!0,batchId:St.id,batchLive:!e,batchModels:t,batchStats:{totalRequests:St.totalRequests,ok:St.okCount,error:St.errorCount,cached:St.cachedCount,avgMs:i,maxMs:St.msMax,minMs:St.msMin,peakQueued:St.peakQueued,peakActive:St.peakActive}}}function Pt(){if(!St)return;if(At>0||wt.length>0)return;St.endedAt=me();const e=Lt(!0);St=null,e&&ot(e)}function Rt(){return qt(me()),Et.length}function Gt(){const e={active:At,queued:wt.length,rpm:Rt()};Nt=e,vt||(vt=setTimeout(()=>{vt=null;const e=Nt;if(Nt=null,!e)return;const t=`${e.active}:${e.queued}:${e.rpm}`;t!==_t&&(_t=t,ae({...e,ts:me()}))},120))}async function Dt(){const e=me();if(e-ht<1500)return gt;const t=await W();return gt=t,ht=e,t}function qt(e){const t=e-6e4;for(;Et.length&&Et[0]<=t;)Et.shift()}function Ht(){It||(It=setInterval(()=>{const e=Rt();Gt(),e<=0&&(clearInterval(It),It=null)},1e3))}function Kt(e){return"string"==typeof e&&e.trim().length>0}function $t(e,t=!1){if("boolean"==typeof e)return e;if("number"==typeof e)return 0!==e;if("string"==typeof e){const t=e.trim().toLowerCase();if(["1","true","yes","y","on"].includes(t))return!0;if(["0","false","no","n","off"].includes(t))return!1}return t}function Ft(e){return fe(e,1e3,12e4,t.timeoutMs)}function Ut(e){return String(e||"").toLowerCase()}function jt(e){const t=String(e||"").trim();return t?t.startsWith("models/")?t:`models/${t}`:""}function Vt(e){const t=Ut(e);return!(!t||!t.includes("cached"))&&(t.includes("not found")||t.includes("invalid")||t.includes("expired")||t.includes("does not exist"))}function Yt(e){const t=Ut(e);return!!t&&(t.includes("responseschema")||t.includes("response schema")||t.includes("response_schema")||t.includes("responsemime")||t.includes("response mime")||t.includes("response_mime")||t.includes("response_mime_type")||t.includes("json_schema")||t.includes("response_format")||t.includes("text.format"))}function Bt(e){const t=Ut(e);return!!t&&!!(t.includes("web_search")||t.includes("google_search")||t.includes("web search")||t.includes("google search"))&&(t.includes("not supported")||t.includes("unsupported")||t.includes("unknown")||t.includes("unrecognized")||t.includes("invalid")||t.includes("not enabled")||t.includes("not available"))}function Jt(t,n){if(t!==e.GEMINI||n?.ok)return!1;if(503===n?.status)return!0;if("API_ERROR"!==n?.code)return!1;const o=Ut(n?.message);return!!o&&(o.includes("overloaded")||o.includes("service unavailable")||o.includes("unavailable"))}function zt(e){if(!Kt(e))return"Return valid JSON only.";const t=String(e).trim();return/json/i.test(t)?t:t+" Return valid JSON only."}function Xt(e,t){return"AI.FORMULA"!==e?"":function(e){if(!Kt(e))return"";const t=String(e).trim(),n=t.match(/=[^\n\r]+/),o=(n?n[0]:t).trim();return o.startsWith("=")?o:""}(t)}async function Qt(n){const o=me(),i=L(n?.provider)||await q(),s=await U(i),a=await K(i),r=n?.functionName||"aiGenerate",c=Kt(n?.functionCall)?String(n.functionCall):"",u=i===e.OPENAI?await V():"",l=i===e.GEMINI?await j():"",d=i===e.OPENAI?u:l;if(!a)return ot({fn:r,provider:i,model:s,ok:!1,ms:me()-o,cache:!1,reasoningEffort:d||void 0,call:c||void 0,code:"API_KEY_MISSING",message:`Clé API manquante pour le fournisseur ${i}.`}),{ok:!1,provider:i,model:s,code:"API_KEY_MISSING",message:`Clé API manquante pour le fournisseur ${i}.`};const m=Kt(n?.cachePrefix)?String(n.cachePrefix):"",p=Kt(n?.cacheSuffix)?String(n.cacheSuffix):"",f=m?m+p:String(n?.user||""),g=Kt(n?.system)?String(n.system):"",h=$t(n?.webSearch,!1),y=Ft(n?.timeoutMs),k=(E=n?.retry,fe(E,0,5,t.retry));var E;const T=Math.min(k,2),I=await J(),A=function(e){return fe(e,1,128e3,t.maxOutputTokens)}(n?.maxOutputTokens??I),w=i===e.GEMINI?function(e,t){const n=String(t||"").trim().toLowerCase();if(!n||"auto"===n||"none"===n)return null;const o=String(e||"").trim().toLowerCase();if(!o.includes("gemini"))return null;if(o.includes("gemini-3"))return o.includes("flash")?{thinkingLevel:(new Set(["minimal","low","medium","high"]).has(n)?n:"low").toUpperCase()}:{thinkingLevel:("high"===n||"medium"===n?"high":"low").toUpperCase()};if(o.includes("gemini-2.5")){let e={minimal:512,low:2048,medium:8192,high:24576}[n];return e?(o.includes("flash-lite")&&(e=Math.max(512,e)),o.includes("pro")&&(e=Math.max(128,e)),{thinkingBudget:e}):null}return null}(s,l):null,v=$t(n?.cache,t.cache),N=fe(n?.cacheTtlSec??t.cacheTtlSec,1,31536e3,t.cacheTtlSec),_=v&&!(St||Mt()>=bt);await async function(){const e=await async function(){return await Ae()}();e>ct&&(ct=e,rt.clear())}();const b={v:3,provider:i,model:s,maxOutputTokens:A,reasoningEffort:u,geminiReasoningEffort:l,webSearch:h,system:g,user:f,responseMimeType:n?.responseMimeType||"",responseJsonSchema:n?.responseJsonSchema||null},S=await Ce(b);if(v){const e=rt.get(S);if(e){const t=Xt(r,e?.text),n=Ot({provider:i,model:s,ok:!0,cached:!0,usage:null,ms:me()-o});return n||ot({fn:r,provider:i,model:s,ok:!0,ms:me()-o,cache:!0,cacheKind:"memory",reasoningEffort:d||void 0,call:c||void 0,inputTokens:0,outputTokens:0,reasoningTokens:0,totalTokens:0,formula:t||void 0}),n&&Pt(),{...e,cached:!0,cacheKind:"memory"}}if(_){const e=await async function(e){if(!e)return null;if(await re())return null;const t=await Ae(),n=await M(Ee+e);if(!n)return await be(e),null;try{const o=JSON.parse(n);if(!o||"object"!=typeof o)throw new Error("Invalid entry");const i=Number(o.savedAtMs||0);return t&&(!Number.isFinite(i)||i<=t)||o.expiresAtMs&&o.expiresAtMs<=me()?(await _e(e),await be(e),null):o.value||null}catch{return await _e(e),await be(e),null}}(S);if(e){const t=Xt(r,e?.text);rt.set(S,e,1e3*N);const n=Ot({provider:i,model:s,ok:!0,cached:!0,usage:null,ms:me()-o});return n||ot({fn:r,provider:i,model:s,ok:!0,ms:me()-o,cache:!0,cacheKind:"persistent",reasoningEffort:d||void 0,call:c||void 0,inputTokens:0,outputTokens:0,reasoningTokens:0,totalTokens:0,formula:t||void 0}),n&&Pt(),{...e,cached:!0,cacheKind:"persistent"}}}}if(ut.has(S))return ut.get(S);const C=async function(){for(;;){const e=await Dt();if(At<e)break;if(await new Promise(e=>{wt.push(e),Ct(),xt(),Gt()})===pt)return{...ft}}At++,Ct(),xt(),Gt();try{return await async function(){const e=await async function(){const e=me();if(e-kt<1500)return yt;const t=await te();return yt=t,kt=e,t}();if(e&&!(e<=0))return Tt=Tt.then(()=>async function(e){for(;;){const t=me();if(qt(t),!e||e<=0||Et.length<e)return Et.push(t),Ht(),void Gt();const n=Math.max(0,Et[0]+6e4-t);n>0?await pe(n):await pe(0)}}(e)),Tt}(),await(async()=>{let t=0,l=null;const E=async t=>i===e.OPENAI?async function({apiKey:t,model:n,system:o,user:i,maxOutputTokens:s,reasoningEffort:a,timeoutMs:r,webSearch:c,responseMimeType:u,responseJsonSchema:l}){const d="https://api.openai.com/v1/responses",m={model:n,input:i,max_output_tokens:s,store:!1};if(Kt(a)&&(m.reasoning={effort:a}),Kt(o)){const e="application/json"===u||l?o+" You must return valid JSON.":o;m.instructions=e}l?m.text={format:{type:"json_schema",name:"excel_ai_schema",strict:!0,schema:l}}:"application/json"===u&&(m.text={format:{type:"json_object"}}),c&&(m.tools=[{type:"web_search"}],m.include=["web_search_call.action.sources"]);const p=await sn(d,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify(m)},r),f=await an(p);if(!p.ok){const t=function(e){try{const t=e?.error?.message;return t?String(t):""}catch{return""}}(f)||`OpenAI API error (${p.status}).`;return{ok:!1,provider:e.OPENAI,model:n,code:"API_ERROR",message:he(t)}}const g=function(e){try{if("string"==typeof e?.output_text&&e.output_text.trim())return e.output_text}catch{}try{const t=e?.output;if(Array.isArray(t)){const e=[];for(const n of t){if("string"==typeof n?.text&&n.text.trim()&&e.push(n.text),"string"==typeof n?.output_text&&n.output_text.trim()&&e.push(n.output_text),"output_text"===n?.type&&"string"==typeof n?.text&&e.push(n.text),"text"===n?.type&&"string"==typeof n?.text&&e.push(n.text),"message"===n?.type){const t=n?.content;if(Array.isArray(t))for(const n of t)"text"===n?.type&&n?.text&&e.push(n.text),"output_text"===n?.type&&n?.text&&e.push(n.text);else"string"==typeof t&&e.push(t)}if("message"!==n?.type){const t=n?.content;if(Array.isArray(t))for(const n of t)"text"===n?.type&&n?.text&&e.push(n.text),"output_text"===n?.type&&n?.text&&e.push(n.text);else"string"==typeof t&&e.push(t)}}if(e.length>0)return e.join("\n").trim()}}catch{}try{return e?.choices?.[0]?.message?.content||""}catch{return""}}(f),h=c?function(e){try{const t=e?.output;if(!Array.isArray(t))return[];const n=[];for(const e of t){if("web_search_call"!==e?.type)continue;const t=e?.action?.sources;if(Array.isArray(t))for(const e of t)e?.url&&n.push({title:e?.title||"",url:e.url})}return on(n)}catch{return[]}}(f):[],y=function(e){try{const t=e?.usage;if(!t)return null;const n=tn(t?.output_tokens),o=tn(t?.output_tokens_details?.reasoning_tokens),i=Math.max(0,n-o);return{inputTokens:tn(t?.input_tokens),outputTokens:i,reasoningTokens:o,totalTokens:tn(t?.total_tokens),cachedInputTokens:tn(t?.input_tokens_details?.cached_tokens)}}catch{return null}}(f);return Kt(g)?{ok:!0,provider:e.OPENAI,model:n,text:g.trim(),sources:h,usage:y}:{ok:!1,provider:e.OPENAI,model:n,code:"EMPTY_RESPONSE",message:"Réponse vide d'OpenAI."}}(t):Wt(t);for(;t<=k;){t++;try{const e={apiKey:a,model:s,system:g,user:f,cachePrefix:m||void 0,cacheSuffix:p||void 0,maxOutputTokens:A,reasoningEffort:u,thinkingConfig:w,timeoutMs:y,webSearch:h,responseMimeType:n?.responseMimeType,responseJsonSchema:n?.responseJsonSchema};let l=await E(e);if(!l.ok&&!Jt(i,l)){let t=e;t.webSearch&&(Bt(l.message)||"API_ERROR"===l.code||"EMPTY_RESPONSE"===l.code)&&(t={...t,webSearch:!1},l=await E(t));const n=t.responseMimeType||t.responseJsonSchema;!l.ok&&n&&(Yt(l.message)||"API_ERROR"===l.code||"EMPTY_RESPONSE"===l.code)&&(t={...t,responseMimeType:void 0,responseJsonSchema:void 0,system:zt(t.system)},l=await E(t))}const k=Jt(i,l)&&t<=T;let I=en(l?.usage);"AI.BATCH"===r&&I.cachedInputTokens>0&&(I={...I,inputTokens:Math.max(0,I.inputTokens-I.cachedInputTokens)});const b=l.ok?Xt(r,l.text):"";if(k){await pe(1e4);continue}return Ot({provider:i,model:s,ok:l.ok,cached:!1,usage:I,ms:me()-o})||ot({fn:r,provider:i,model:s,ok:l.ok,ms:me()-o,attempt:t,cache:!1,reasoningEffort:d||void 0,call:c||void 0,inputTokens:I.inputTokens,outputTokens:I.outputTokens,reasoningTokens:I.reasoningTokens,cachedInputTokens:I.cachedInputTokens,totalTokens:I.totalTokens,code:l.code,message:l.message,formula:b||void 0,cacheHint:l.cacheHint||void 0,cacheStorageTokenHours:l.cacheStorageTokenHours||0}),l.ok&&v&&(rt.set(S,l,1e3*N),_&&await Se(S,l,1e3*N,{provider:i,model:s})),l}catch(e){l=e,t<=k&&await pe(250*t)}}const I=function(e){if(!e)return!1;if("AbortError"===e.name)return!0;const t=String(e.message||"").toLowerCase();return t.includes("aborted")||t.includes("timeout")}(l),b=I?"TIMEOUT":"API_ERROR",M=he(I?"Délai dépassé (timeout).":l?.message?String(l.message):"Erreur inconnue.");return Ot({provider:i,model:s,ok:!1,cached:!1,usage:null,ms:me()-o})||ot({fn:r,provider:i,model:s,ok:!1,ms:me()-o,cache:!1,reasoningEffort:d||void 0,call:c||void 0,code:b,message:M}),{ok:!1,provider:i,model:s,code:b,message:M}})()}finally{At--;const e=wt.shift();e&&e(),Gt(),Pt()}}();ut.set(S,C);try{const e=await C;return"QUEUE_CANCELLED"===e?.code&&(Ot({provider:i,model:s,ok:!1,cached:!1,usage:null,ms:me()-o})||ot({fn:r,provider:i,model:s,ok:!1,ms:me()-o,cache:!1,reasoningEffort:d||void 0,call:c||void 0,inputTokens:0,outputTokens:0,reasoningTokens:0,cachedInputTokens:0,totalTokens:0,code:e.code,message:e.message})),e}finally{ut.delete(S)}}async function Wt({apiKey:t,model:n,system:o,user:i,cachePrefix:s,cacheSuffix:a,maxOutputTokens:r,thinkingConfig:c,timeoutMs:u,webSearch:l,responseMimeType:d,responseJsonSchema:m,disableCache:p=!1}){const f=function(e){return`https://generativelanguage.googleapis.com/v1beta/models/${encodeURIComponent(e)}:generateContent`}(n);let g="",h="",y="",k=i;const E=Kt(o)?"application/json"===d||m?o+" You must return valid JSON.":o:"";if(!p&&!l&&Kt(s)&&Kt(a)&&a.trim().length>=1){const e=await async function({apiKey:e,model:t,system:n,prefix:o,ttlMs:i,timeoutMs:s}){if(!e||!Kt(o))return null;if(await re())return null;if(o.length<200)return null;!function(){const e=me();for(const[t,n]of dt.entries())n?.expiresAtMs&&n.expiresAtMs<=e&&dt.delete(t)}();const a=await Ce({v:1,model:String(t||"").trim(),system:String(n||"").trim(),prefix:o}),r=dt.get(a);if(r?.name)return(!Number.isFinite(r.createdAtMs)||r.createdAtMs<=0)&&(r.createdAtMs=me()),(!Number.isFinite(r.expiresAtMs)||r.expiresAtMs<=r.createdAtMs)&&(r.expiresAtMs=r.createdAtMs+(i||lt)),Number.isFinite(r.chargedTokenHours)||(r.chargedTokenHours=0),dt.set(a,r),{name:r.name,cacheKey:a};if(mt.has(a))return mt.get(a);const c=(async()=>{try{const r=await async function({apiKey:e,model:t,system:n,prefix:o,ttlMs:i,timeoutMs:s}){const a={model:jt(t),contents:[{role:"user",parts:[{text:o}]}],ttl:`${Math.max(60,Math.floor((i||lt)/1e3))}s`};Kt(n)&&(a.systemInstruction={role:"system",parts:[{text:n}]});const r=await sn("https://generativelanguage.googleapis.com/v1beta/cachedContents",{method:"POST",headers:{"Content-Type":"application/json","x-goog-api-key":e},body:JSON.stringify(a)},Math.max(1e4,Math.min(6e4,s||3e4))),c=await an(r);if(!r.ok)return{ok:!1,status:r.status,json:c};const u=String(c?.name||"").trim();return u?{ok:!0,name:u,expireTime:c?.expireTime?Date.parse(String(c.expireTime)):0}:{ok:!1,status:r.status,json:c}}({apiKey:e,model:t,system:n,prefix:o,ttlMs:i,timeoutMs:s});if(!r?.ok||!r?.name)return null;const c=Number.isFinite(r.expireTime)&&r.expireTime>0?r.expireTime:me()+(i||lt);return dt.set(a,{name:r.name,createdAtMs:me(),expiresAtMs:c,chargedTokenHours:0}),{name:r.name,cacheKey:a}}catch{return null}})();mt.set(a,c);try{return await c}finally{mt.delete(a)}}({apiKey:t,model:n,system:E,prefix:s,ttlMs:lt,timeoutMs:u});e?.name&&(h=e.name,y=e.cacheKey||"",k=a,g="gemini_cached_content")}const T={contents:[{role:"user",parts:[{text:k}]}],generationConfig:{maxOutputTokens:r}};c&&"object"==typeof c&&(T.generationConfig.thinkingConfig=c),Kt(E)&&!h&&(T.systemInstruction={role:"system",parts:[{text:E}]}),d&&(T.generationConfig.responseMimeType=d),m&&(T.generationConfig.responseSchema=m),l&&(T.tools=[{google_search:{}}]),h&&(T.cachedContent=h);const I=await sn(f,{method:"POST",headers:{"Content-Type":"application/json","x-goog-api-key":t},body:JSON.stringify(T)},u),A=await an(I),w=function(e){try{const t=e?.error;if(!t)return null;const n=t?.message,o=Number(t?.code);return{message:n?String(n):"",status:Number.isFinite(o)?o:void 0}}catch{return null}}(A);if(w?.message)return y&&Vt(w.message)?(dt.delete(y),await Wt({apiKey:t,model:n,system:o,user:i,cachePrefix:s,cacheSuffix:a,maxOutputTokens:r,thinkingConfig:c,timeoutMs:u,webSearch:l,responseMimeType:d,responseJsonSchema:m,disableCache:!0})):{ok:!1,provider:e.GEMINI,model:n,status:w.status??I.status,code:"API_ERROR",message:he(w.message),cacheHint:g};if(!I.ok){const p=Zt(A)||`Gemini API error (${I.status}).`;return y&&Vt(p)?(dt.delete(y),await Wt({apiKey:t,model:n,system:o,user:i,cachePrefix:s,cacheSuffix:a,maxOutputTokens:r,thinkingConfig:c,timeoutMs:u,webSearch:l,responseMimeType:d,responseJsonSchema:m,disableCache:!0})):{ok:!1,provider:e.GEMINI,model:n,status:I.status,code:"API_ERROR",message:he(p),cacheHint:g}}const v=function(e){try{const t=e?.candidates?.[0],n=t?.content?.parts;return Array.isArray(n)?n.map(e=>e?.text||"").join(""):""}catch{return""}}(A),N=function(e){try{const t=e?.candidates?.[0],n=t?.groundingMetadata,o=n?.groundingChunks;if(!Array.isArray(o))return[];const i=[];for(const e of o){const t=e?.web;t?.uri&&i.push({title:t?.title||"",url:t.uri})}return on(i)}catch{return[]}}(A),_=function(e){try{const t=e?.usageMetadata;return t?{inputTokens:tn(t?.promptTokenCount),outputTokens:tn(t?.candidatesTokenCount),reasoningTokens:tn(t?.thoughtsTokenCount),totalTokens:tn(t?.totalTokenCount),cachedInputTokens:tn(t?.cachedContentTokenCount)}:null}catch{return null}}(A);let b=0;if("gemini_cached_content"===g&&y&&_?.cachedInputTokens>0){const e=dt.get(y);if(!(e?.chargedTokenHours&&e.chargedTokenHours>0)){const t=Number(e?.createdAtMs)||0,n=Number(e?.expiresAtMs)||0;let o=0;if(o=t>0&&n>t?n-t:lt,o>0){const t=o/36e5;b=Math.max(0,Number(_.cachedInputTokens)||0)*t,e&&b>0&&(e.chargedTokenHours=b,dt.set(y,e))}}}return Kt(v)?{ok:!0,provider:e.GEMINI,model:n,text:v.trim(),sources:N,usage:_,cacheHint:g,cacheStorageTokenHours:b||0}:{ok:!1,provider:e.GEMINI,model:n,code:"EMPTY_RESPONSE",message:"Réponse vide de Gemini.",cacheHint:g}}function Zt(e){try{const t=e?.error?.message;return t?String(t):""}catch{return""}}function en(e){if(!e||"object"!=typeof e)return{inputTokens:0,outputTokens:0,reasoningTokens:0,totalTokens:0,cachedInputTokens:0};const t=tn(e.inputTokens),n=tn(e.outputTokens),o=tn(e.reasoningTokens),i=tn(e.cachedInputTokens),s=tn(e.totalTokens),a=t+n+o;return{inputTokens:t,outputTokens:n,reasoningTokens:o,totalTokens:Math.max(s,a),cachedInputTokens:i}}function tn(e){const t=Number(e);return!Number.isFinite(t)||t<=0?0:Math.floor(t)}async function nn(){rt.clear(),await async function(){const e=me();Ie=e,await C(n.CACHE_CLEAR_AT,String(e));const t=await we();for(const e of t||[])e?.key&&await _e(e.key);await x(n.CACHE_INDEX)}()}function on(e){const t=new Set,n=[];for(const o of e||[]){const e=String(o?.url||"").trim();if(!e)continue;const i=e.toLowerCase();t.has(i)||(t.add(i),n.push({title:String(o?.title||"").trim(),url:e}))}return n}async function sn(e,t,n){const o=Ft(n);if("undefined"==typeof AbortController)return await fetch(e,t);const i=new AbortController,s=setTimeout(()=>i.abort(),o);try{return await fetch(e,{...t,signal:i.signal})}finally{clearTimeout(s)}}async function an(e){try{return await e.json()}catch{return{}}}ae({active:0,queued:0,rpm:0,ts:me()});const rn="Neurow Add-in";function cn(e){return String(e||"").trim()}function un(e){const t=String(e||"").trim();if(!t)return"";const n=Date.parse(t);return Number.isFinite(n)?new Date(n).toISOString():""}function ln(e,t){if(!e)return t;if("string"==typeof e.error&&e.error.trim())return e.error.trim();if("string"==typeof e.message&&e.message.trim())return e.message.trim();if(Array.isArray(e.errors)&&e.errors.length){const t=e.errors[0]||{},n=t.detail||t.title||t.message;if(n)return String(n).trim()}return t}async function dn(e,t){const n=new FormData;Object.entries(t||{}).forEach(([e,t])=>{null!=t&&""!==t&&n.append(e,t)});const o=await fetch(e,{method:"POST",body:n});let i=null;try{i=await o.json()}catch{i=null}return{ok:o.ok,status:o.status,data:i}}function mn(e,t,n={}){const o=n.instanceId||t?.instance?.id||t?.instance_id||"",i=t?.instance?.name||n.instanceName||rn,s=un(t?.license_key?.expires_at||n.expiresAt),a=(new Date).toISOString();return{key:e,instanceId:o,instanceName:i,expiresAt:s,valid:!0,activatedAt:n.activatedAt||a,lastCheckedAt:a}}function pn(e){if(!e||"object"!=typeof e)return null;const t=cn(e.key);return t?{key:t,instanceId:String(e.instanceId||"").trim(),instanceName:String(e.instanceName||rn).trim(),expiresAt:un(e.expiresAt),valid:!1!==e.valid,activatedAt:String(e.activatedAt||"").trim(),lastCheckedAt:String(e.lastCheckedAt||"").trim()}:null}async function fn(){return pn(await async function(){await O();const e=await M(n.LICENSE);if(!e)return null;try{return JSON.parse(e)}catch{return null}}())}async function gn(e){const t=pn(e);return t?(await le(t),t):(await de(),null)}function hn(e){if(!e||!e.key)return!1;if(!1===e.valid)return!1;if(e.expiresAt){const t=Date.parse(e.expiresAt);if(Number.isFinite(t)&&t<=Date.now())return!1}return!0}function yn(e){return document.getElementById(e)}function kn(e,t){const n=he(e||"");if(yn("statusLine").textContent=n,t)try{const e=ye(t);yn("statusDetails").textContent=JSON.stringify(e,null,2)}catch{yn("statusDetails").textContent=he(t)}else yn("statusDetails").textContent=""}function En(e,t={}){const{duration:n=2600}=t,o=yn("statusToast");o&&(o.textContent=e||"",o.classList.add("is-visible"),lo&&(clearTimeout(lo),lo=null),lo=setTimeout(()=>{o.classList.remove("is-visible")},n))}function Tn(e){const t=Number(e);return Number.isFinite(t)?Math.round(t).toLocaleString("en-US"):"0"}const In="€";function An(e){const t=Number(e);return Number.isFinite(t)?`${In}${t.toFixed(4)}`:`${In}0.0000`}function wn(e){const t=Number(e);return Number.isFinite(t)?`${t.toFixed(2).replace(".",",")}${In}`:`0,00${In}`}function vn(e){const t=Number(e);if(!Number.isFinite(t)||t<=0)return"00c";const n=Math.max(0,Math.round(100*t));return`${String(n).padStart(2,"0")}c`}function Nn(e){const t=Number(e);return Number.isFinite(t)?`${(t/1e3).toFixed(2)}s`:"0.00s"}function _n(e){try{return new Date(e).toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"})}catch{return"--:--"}}function bn(e){try{return new Date(e).toLocaleString("fr-FR",{year:"numeric",month:"short",day:"2-digit",hour:"2-digit",minute:"2-digit"})}catch{return""}}function Sn(e){return String(e?.dataset?.section||"").trim()}function Mn(e){return"true"===e?.dataset?.sectionLocked}function Cn(e){if(co||(co=document.querySelector(".app__main")),!co)return;const t=document.querySelector(Un);for(const n of e){const e=ao.get(n);e&&(t?co.insertBefore(e,t):co.appendChild(e))}}function xn(e){ao.forEach((t,n)=>{const o=Mn(t),i=e.has(n)&&!o;t.classList.toggle(jn,i)})}function On(){let e=!1;for(const t of Array.from(so)){const n=ao.get(t);n&&!Mn(n)||(so.delete(t),e=!0)}e&&ue(Array.from(so))}function Ln(e,t={}){const{persist:o=!0}=t;oo=e.slice(),Cn(oo),Dn(),o&&async function(e){const t=ce(e);await C(n.SECTION_ORDER,JSON.stringify(t))}(oo)}function Pn(e,t={}){const{persist:n=!0}=t;so=new Set(e),On(),xn(so),Dn(),n&&ue(Array.from(so)),Uo()}function Rn(e,t){const n=oo.indexOf(e);if(n<0)return;const o=n+t;if(o<0||o>=oo.length)return;const i=oo.slice();i.splice(n,1),i.splice(o,0,e),Ln(i)}function Gn(e){e.querySelectorAll(".section-row").forEach(e=>{e.classList.remove("is-drop-before","is-drop-after","is-dragging")})}function Dn(){const e=yn("sectionManagerList");if(!e)return;e.innerHTML="";const t=oo.length?oo:Array.from(ao.keys());t.forEach((n,o)=>{const i=ao.get(n);if(!i)return;const s=function(e){const t=e?.dataset?.sectionTitle;if(t)return t;const n=e?.querySelector?.(".card__title");return n?n.textContent.trim():Sn(e)}(i),a=Mn(i),r=!so.has(n)||a,c=document.createElement("div");c.className="section-row",c.dataset.sectionKey=n,c.setAttribute("role","listitem");const u=document.createElement("button");u.type="button",u.className="section-row__handle",u.draggable=!0,u.setAttribute("title","Glisser pour déplacer"),u.setAttribute("aria-label",`Déplacer ${s}`);const l=document.createElement("div");l.className="section-row__label",l.textContent=s;const d=document.createElement("div");d.className="section-row__controls";const m=document.createElement("button");m.type="button",m.className="move-btn move-btn--up",m.disabled=0===o,m.setAttribute("title","Monter"),m.setAttribute("aria-label",`Monter ${s}`),m.addEventListener("click",()=>Rn(n,-1));const p=document.createElement("button");p.type="button",p.className="move-btn move-btn--down",p.disabled=o===t.length-1,p.setAttribute("title","Descendre"),p.setAttribute("aria-label",`Descendre ${s}`),p.addEventListener("click",()=>Rn(n,1));const f=document.createElement("label");f.className="visibility-toggle",f.setAttribute("title",a?"Toujours visible":r?"Masquer":"Afficher");const g=document.createElement("input");g.type="checkbox",g.checked=r,g.disabled=a,g.setAttribute("aria-label",a?`${s} toujours visible`:`Afficher ${s}`);const h=document.createElement("span");if(h.className="visibility-toggle__slider",f.appendChild(g),f.appendChild(h),g.addEventListener("change",()=>{a||(g.checked?so.delete(n):so.add(n),xn(so),ue(Array.from(so)),Dn())}),d.appendChild(m),d.appendChild(p),a){const e=document.createElement("span");e.className="section-row__lock",e.textContent="Fixe",e.setAttribute("title","Toujours visible"),d.appendChild(e)}d.appendChild(f),c.appendChild(u),c.appendChild(l),c.appendChild(d),e.appendChild(c)})}const qn=[4,8,16,32,64,128],Hn=["auto","minimal","low","medium","high"],Kn=["none","minimal","low","medium","high"],$n="[data-help]",Fn="[data-section]",Un="[data-section-settings]",jn="is-section-hidden",Vn="[data-key-input]",Yn="[data-key-save]",Bn="[data-license-input]",Jn="[data-license-status]";let zn={gemini:!1,openai:!1},Xn=null,Qn=null,Wn=!1,Zn=!1,eo=!1,to=!1,no=!1,oo=[],io=[],so=new Set,ao=new Map,ro="",co=null;const uo=new Set;let lo=null,mo=!1,po=[],fo=t.rpmLimit;const go={gemini:t.geminiModel,openai:t.openaiModel},ho={gemini:[{id:"gemini-3-pro-preview",label:"Gemini 3 Pro Preview",prices:{input:2,output:12,cachedInput:.2},costLevel:3,reasoningLevel:3,warning:!0},{id:"gemini-3-flash-preview",label:"Gemini 3 Flash Preview",prices:{input:.5,output:3,cachedInput:.05},costLevel:2,reasoningLevel:2,recommended:!0},{id:"gemini-2.5-flash-lite",label:"Gemini 2.5 Flash Lite",prices:{input:.1,output:.4,cachedInput:.01},costLevel:1,reasoningLevel:1}],openai:[{id:"gpt-5.2",label:"GPT-5.2",prices:{input:1.75,output:14,cachedInput:.175},costLevel:3,reasoningLevel:3,supportsReasoningNone:!0,warning:!0},{id:"gpt-5-mini",label:"GPT-5 Mini",prices:{input:.25,output:2,cachedInput:.025},costLevel:2,reasoningLevel:2,recommended:!0,supportsReasoningNone:!1},{id:"gpt-5-nano",label:"GPT-5 Nano",prices:{input:.05,output:.4,cachedInput:.005},costLevel:1,reasoningLevel:1,supportsReasoningNone:!1}]},yo={gemini:new Map(ho.gemini.map(e=>[e.id.toLowerCase(),e])),openai:new Map(ho.openai.map(e=>[e.id.toLowerCase(),e]))},ko={gemini:"Gemini",openai:"OpenAI"};function Eo(e,t){const n=Math.max(1,Number(t)||1);return new Array(n+1).join(e)}function To(e,t){const n=String(e||"").toLowerCase(),o=String(t||"").trim().toLowerCase(),i=yo[n];if(i&&o&&i.has(o))return i.get(o);const s=go[n];return i&&s&&i.has(s.toLowerCase())?i.get(s.toLowerCase()):null}function Io(e,t){const n=yn("geminiReasoningEffort");if(!n)return"";const o=function(e){const t=String(e||"").trim().toLowerCase();return t.includes("gemini-3")&&t.includes("flash")?["auto","minimal","low","medium","high"]:t.includes("gemini-3")?["auto","low","high"]:t.includes("gemini-2.5")?["auto","minimal","low","medium","high"]:["auto","low","high"]}(e);let i=Ao(t,Hn);i||(i=Hn[0]),o.includes(i)||("minimal"===i&&(i="low"),"medium"===i&&(i="high")),i=function(e,t,n){if(!e)return t[0]||"";if(t.includes(e))return e;const o=n.indexOf(e);if(o<0)return t[0]||"";let i=t[0]||"",s=Number.POSITIVE_INFINITY;for(const e of t){const t=n.indexOf(e);if(t<0)continue;const a=Math.abs(t-o);a<s&&(s=a,i=e)}return i}(i,o,Hn);const s=Hn.indexOf(i);return n.value=String(s>=0?s:0),n.setAttribute("aria-valuetext",i),i}function Ao(e,t=Kn){const n=String(e||"").trim().toLowerCase();if(!n)return"";const o=Number(n);return Number.isFinite(o)?t[Math.min(t.length-1,Math.max(0,Math.round(o)))]||"":n}function wo(e,t){const n=yn("openaiReasoningEffort");if(!n)return"";const o=function(e){const t=String(e||"").trim().toLowerCase(),n=yo.openai?.get(t);return!n||"boolean"!=typeof n.supportsReasoningNone||n.supportsReasoningNone}(e),i=n.closest(".reasoning");i&&i.classList.toggle("reasoning--no-none",!o),n.dataset.allowNone=o?"1":"0";const s=o?Kn:Kn.slice(1);let a=Ao(t);s.includes(a)||(a=s[0]||"minimal");const r=Kn.indexOf(a);return n.value=String(r>=0?r:0),n.setAttribute("aria-valuetext",a),a}function vo(e){const t=Number(e);if(!Number.isFinite(t))return`${In}0`;const n=t>=1?2:3;let o=t.toFixed(n);return o=o.replace(/\.?0+$/,""),`${In}${o}`}function No(e){return{cost:Eo("$",e.costLevel),reasoning:Eo("🧠",e.reasoningLevel)}}function _o(e){const t=No(e),n=e.recommended?"★ ":"";return`${e.warning?"! ":""}${n}${e.id} | ${t.cost} | ${t.reasoning}`}function bo(t,n){const o=t===e.GEMINI,i=yn(o?"geminiModel":"openaiModel"),s=yn(o?"geminiModelWarning":"openaiModelWarning");if(!i||!s)return;const a=To(t,n||i.value),r=!!a?.warning;s.classList.toggle("is-hidden",!r),i.classList.toggle("input--warning",r)}function So(t){if(!t)return 0;if("AI.BATCH"===t.fn){const n=String(t.provider||"").toLowerCase(),o=To(n,t.model);if(!o)return 0;const i=Math.max(0,Number(t.inputTokens||0)),s=Math.max(0,Number(t.cachedInputTokens||0)),a=Math.max(0,Number(t.outputTokens||0)),r=Math.max(0,Number(t.reasoningTokens||0)),c=Math.max(0,Number(t.cacheStorageTokenHours||0)),u=a+r,l=o.prices||{};let d=i/1e6*Number(l.input||0)+s/1e6*Number(l.cachedInput??l.input??0)+u/1e6*Number(l.output||0);return n===e.GEMINI&&c>0&&(d+=c/1e6*1),d}if(t.batch&&Array.isArray(t.batchModels))return t.batchModels.reduce((e,t)=>t?e+So({provider:t.provider,model:t.model,inputTokens:t.inputTokens,outputTokens:t.outputTokens,reasoningTokens:t.reasoningTokens,cachedInputTokens:t.cachedInputTokens,cacheStorageTokenHours:t.cacheStorageTokenHours}):e,0);const n=String(t.provider||"").toLowerCase(),o=To(n,t.model);if(!o)return 0;const i=Math.max(0,Number(t.inputTokens||0)),s=Math.max(0,Number(t.outputTokens||0)),a=Math.max(0,Number(t.reasoningTokens||0)),r=Math.max(0,Number(t.cachedInputTokens||0)),c=Math.max(0,Number(t.cacheStorageTokenHours||0)),u=s+a,l=Math.min(r,i),d=Math.max(0,i-l),m=o.prices||{};let p=d/1e6*Number(m.input||0)+l/1e6*Number(m.cachedInput??m.input??0)+u/1e6*Number(m.output||0);return n===e.GEMINI&&c>0&&(p+=c/1e6*1),p}function Mo(e){const t=Number(e);return!Number.isFinite(t)||t<=0?0:Math.floor(t)}function Co(e){const t=Number(e);return!Number.isFinite(t)||t<=0?0:t}function xo(e){return{provider:e?.provider||"",inputTokens:Number(e?.inputTokens||0),outputTokens:Number(e?.outputTokens||0),reasoningTokens:Number(e?.reasoningTokens||0),cachedInputTokens:Number(e?.cachedInputTokens||0),cacheStorageTokenHours:Number(e?.cacheStorageTokenHours||0),totalTokens:Number(e?.totalTokens||0),ok:!!e?.ok,cache:!!e?.cache,ms:Number(e?.ms||0),fn:e?.fn||"AI",model:e?.model||"",ts:Number(e?.ts||0),message:e?.message||"",reasoningEffort:e?.reasoningEffort||"",call:e?.call||"",formula:e?.formula||"",cacheHint:e?.cacheHint||""}}function Oo(e,t,n){if(!t)return;const o=ho[e]||[],i=String(n||"").trim(),s=i.toLowerCase(),a=go[e]||"";t.innerHTML="";let r=!1;for(const e of o){const n=document.createElement("option");n.value=e.id,n.textContent=_o(e),e.warning&&(n.dataset.warning="1",n.style.color="#b03524",n.style.fontWeight="700"),e.id.toLowerCase()===s&&(n.selected=!0,r=!0),t.appendChild(n)}if(i&&!r){const e=document.createElement("option");return e.value=i,e.textContent=`${i} | hors liste`,e.selected=!0,void t.appendChild(e)}!i&&a&&(t.value=a)}function Lo(e,t){const n=yn(e);n&&(n.classList.toggle("is-open",t),n.setAttribute("aria-hidden",t?"false":"true"))}function Po(e){const t=yn(e);return!!t&&t.classList.contains("is-open")}function Ro(e){Lo("settingsModal",e)}function Go(e){Lo("pricingModal",e)}function Do(e){Lo("onboardingModal",e)}function qo(e){Lo("onboardingKeysModal",e)}function Ho(){Go(!1)}function Ko(e,t){const n=!!t;document.querySelectorAll(`[data-key-status][data-key-status="${e}"]`).forEach(e=>{e.textContent=n?"Clé enregistrée":"Clé manquante",e.classList.toggle("key-status--ok",n),e.classList.toggle("key-status--missing",!n)})}function $o(){document.querySelectorAll(Vn).forEach(t=>{const n=String(t.dataset.keyInput||"").trim().toLowerCase();n===e.GEMINI?t.placeholder=zn.gemini?"Clé enregistrée (laisser vide pour conserver)":"AIza...":n===e.OPENAI&&(t.placeholder=zn.openai?"Clé enregistrée (laisser vide pour conserver)":"sk-...")})}function Fo(){return!!zn.gemini||!!zn.openai}function Uo(){const e=document.querySelector('[data-section="onboarding"]');if(!e)return;if(!Zn||!Wn||!to)return;const t=!(Xn&&Xn.key&&hn(Xn)&&(zn.gemini&&zn.openai||eo&&Fo()));e.classList.toggle("is-hidden",!t),t&&e.classList.contains(jn)&&(so.delete("onboarding"),Pn(Array.from(so)))}function jo(t,n){const o=t===e.GEMINI,i=yn(o?"geminiModel":"openaiModel"),s=yn(o?"geminiReasoningEffort":"openaiReasoningEffort"),a=yn(o?"geminiModelGate":"openaiModelGate"),r=!n;i&&(i.disabled=r),s&&(s.disabled=r),a&&a.classList.toggle("is-hidden",!r)}function Vo(){jo(e.GEMINI,!!zn.gemini),jo(e.OPENAI,!!zn.openai),function(){const e=yn("providerGemini"),t=yn("providerOpenAI"),n=!!zn.gemini,o=!!zn.openai;e&&(e.disabled=!n),t&&(t.disabled=!o);const i=yn("configProviderGate");if(!i)return;const s=yn("configProviderGateText");let a="";n||o||(a="Ajoutez une clé API pour activer Gemini ou OpenAI."),i.classList.toggle("is-hidden",!a),s&&(s.textContent=a)}()}function Yo(e){const t=String(e||"").trim();if(!t)return 0;const n=Date.parse(t);return Number.isFinite(n)?n:0}function Bo(e){const t=Yo(e);return t?function(e){try{return new Date(e).toLocaleDateString("fr-FR",{year:"numeric",month:"short",day:"2-digit"})}catch{return""}}(t):""}function Jo(e,t,n){e&&(e.textContent=t||"",e.title=t||"",e.setAttribute("aria-label",t||""),e.classList.toggle("key-status--ok",n),e.classList.toggle("key-status--missing",!n))}function zo(e,t){document.querySelectorAll(Jn).forEach(n=>{Jo(n,e,t)})}function Xo(e,t={}){const{focus:n=!1,persist:o=!0}=t,i=yn("licenseEntry"),s=yn("licenseSubscribe");if(!i)return;i.classList.toggle("is-hidden",!e),o&&(Qn=e),s&&s.classList.toggle("is-hidden",e);const a=yn("licenseModeSubscribe"),r=yn("licenseModeHave");if(a&&r&&(a.classList.toggle("segmented__btn--active",!e),r.classList.toggle("segmented__btn--active",e),a.setAttribute("aria-selected",e?"false":"true"),r.setAttribute("aria-selected",e?"true":"false")),e&&n){const e=yn("licenseKeyInput");e&&e.focus()}}async function Qo(e={}){const{silent:t=!1}=e,n=await fn();Xn=n,Zn=!0,function(e){const t=function(e){if(!e||!e.key)return{ok:!1,text:"Aucune licence enregistrée"};if(hn(e)){const t=Bo(e.expiresAt);return{ok:!0,text:"Licence active"+(t?` · renouvellement le ${t}`:"")}}const t=Yo(e.expiresAt);return{ok:!1,text:t&&t<=Date.now()?"Licence expirée":"Licence invalide"}}(e);document.querySelectorAll(Jn).forEach(e=>{Jo(e,t.text,t.ok)})}(n);const o=!(!n||!n.key||hn(n));Xo(null===Qn?o:Qn,{persist:!1}),function(e){const t=e?.key?"Clé enregistrée (laisser vide pour conserver)":"AAAA-BBBB-CCCC-DDDD";document.querySelectorAll(Bn).forEach(e=>{e.placeholder=t})}(n),function(e){const t=document.querySelectorAll("[data-license-meta]");if(!t.length)return;let n="Clé reçue par email après achat (mensuel ou annuel)";if(e&&hn(e)&&e.expiresAt){const t=Bo(e.expiresAt);n=t?`Renouvellement le ${t}`:"Licence active"}else if(e&&!hn(e)){const t=Bo(e.expiresAt);n=t?`Licence expirée le ${t}`:"Licence invalide"}t.forEach(e=>{e.textContent=n})}(n),function(e){const t=yn("setupLicenseStep");if(!t)return;const n=!(!e||!hn(e));t.classList.toggle("is-hidden",n)}(n),Uo(),!t&&n&&hn(n)&&kn("Licence active",{expiresAt:n.expiresAt||"n/a"})}function Wo(e){const t=Number(e);return Number.isFinite(t)?Math.min(17,Math.max(7,Math.round(t))):7}function Zo(e){const t=2**Wo(e);return Math.min(t,128e3)}function ei(t){const n=t===e.GEMINI;yn("providerGemini").classList.toggle("segmented__btn--active",n),yn("providerOpenAI").classList.toggle("segmented__btn--active",!n),yn("providerGemini").setAttribute("aria-pressed",n?"true":"false"),yn("providerOpenAI").setAttribute("aria-pressed",n?"false":"true"),function(e){const t=yn("configProviderBadge");if(!t)return;const n=ko[e]||(e?e.toUpperCase():"—");t.textContent=n,t.title=`Fournisseur: ${n}`,t.setAttribute("aria-label",`Fournisseur: ${n}`)}(t)}function ti(e){const t=Number(e);return Number.isFinite(t)?Math.max(0,Math.min(qn.length-1,Math.round(t))):0}function ni(e){return qn[ti(e)]}function oi(){const e=ni(ti(yn("concurrencyRange").value));return yn("concurrencyValue").textContent=Tn(e),e}function ii(e){const n=Number(e);return Number.isFinite(n)?Math.max(0,Math.min(1e5,Math.round(n))):t.rpmLimit}function si(e){const t="gemini"===e;yn("tabGemini").classList.toggle("tab--active",t),yn("tabOpenAI").classList.toggle("tab--active",!t),yn("tabGemini").setAttribute("aria-selected",t?"true":"false"),yn("tabOpenAI").setAttribute("aria-selected",t?"false":"true"),yn("panelGemini").classList.toggle("tab-panel--active",t),yn("panelOpenAI").classList.toggle("tab-panel--active",!t)}async function ai(t={}){const{preserveKeyInputs:n=!1,silent:o=!1}=t;yn("storageBackend").textContent=v().kind;const[i,s,a,r,c,u,l,d,m,p,f]=await Promise.all([q(),J(),W(),te(),U(e.GEMINI),U(e.OPENAI),$(e.GEMINI),$(e.OPENAI),j(),V(),oe()]);ei(i);const g=function(e){const t=Number(e);return!Number.isFinite(t)||t<=0?7:Wo(Math.log2(t))}(s),h=Zo(g);yn("maxTokensRange").value=String(g),yn("maxTokensValue").textContent=Tn(h),h!==s&&await z(h);const y=function(e){const t=Number(e);if(!Number.isFinite(t))return 0;let n=0,o=Math.abs(qn[0]-t);for(let e=1;e<qn.length;e+=1){const i=Math.abs(qn[e]-t);i<o&&(o=i,n=e)}return n}(a),k=ni(y);yn("concurrencyRange").value=String(y),yn("concurrencyValue").textContent=Tn(k),k!==a&&await Z(k);const E=ii(r);fo=E;const T=yn("rpmLimitInput");T&&(T.value=String(E),E!==r&&await ne(E));const I=yn("geminiModel"),A=yn("openaiModel");Oo(e.GEMINI,I,c),Oo(e.OPENAI,A,u);const w=I?I.value:c,N=A?A.value:u,_=Io(w,m);_&&_!==m&&await B(_);const b=wo(N,p),S=b||p;b&&b!==p&&await Y(b),bo(e.GEMINI,w),bo(e.OPENAI,N),n||document.querySelectorAll(Vn).forEach(e=>{e.value=""}),zn={gemini:!!l,openai:!!d},$o(),eo=!!f,to=!0,l||d||!f||(eo=!1,await ie(!1)),Wn=!0,Ko(e.GEMINI,l),Ko(e.OPENAI,d),Vo(),Uo(),o||kn("Configuration chargée",{defaultProvider:i,maxOutputTokens:h,gemini:{key:l?"set":"missing",model:c,reasoningEffort:_},openai:{key:d?"set":"missing",model:u,reasoningEffort:S}})}function ri(e,t,n,o){const i=document.createElement("div");i.className="breakdown__row "+(o?"breakdown__row--sub":"breakdown__row--total");const s=document.createElement("div");if(s.className="breakdown__name",o){const t=document.createElement("span");t.className="breakdown__model",t.textContent=e,s.appendChild(t)}else s.textContent=e;const a=document.createElement("div");a.className="breakdown__tokens",a.textContent=`${Tn(t)} tokens`;const r=document.createElement("div");return r.className="breakdown__cost",r.textContent=An(n),i.appendChild(s),i.appendChild(a),i.appendChild(r),i}async function ci(){!function(e){const t=yn("queueStatus");if(!t)return;const n=Number(e?.active||0),o=Number(e?.queued||0),i=Math.max(0,n)+Math.max(0,o),s=Number(e?.rpm||0),a=i>0,r=s>0,c=yn("queueStatusMain");c&&c.classList.toggle("is-hidden",!a);const u=yn("rpmStatus");if(u&&u.classList.toggle("is-hidden",!r),!a&&!r)return void t.classList.add("is-hidden");t.classList.remove("is-hidden");const l=yn("queueStatusText");l&&(l.textContent=function(e){const t=Number(e);return!Number.isFinite(t)||t<=0?"":`${Tn(t)} requete${t>1?"s":""} en cours`}(i));const d=yn("rpmStatusText");d&&(d.textContent=function(e,t){const n=Number(e);if(!Number.isFinite(n)||n<=0)return"";const o=Number(t);return Number.isFinite(o)&&o>0?`RPM ${Tn(n)}/${Tn(o)}`:`RPM ${Tn(n)}`}(s,fo));const m=yn("queueStop");m&&m.classList.toggle("is-hidden",o<=0)}(await async function(){const e=await M(n.RUNTIME_STATUS);if(!e)return se(null);try{return se(JSON.parse(e))}catch{return se(null)}}())}async function ui(){const t=(await async function(e={}){De.length&&await it();const t=!!e?.fresh,n=me();return t||!Pe||n-Re>1500?await Be(!0):await Be(!1),Oe.slice()}({fresh:!0})).map(xo).sort((e,t)=>t.ts-e.ts);po=t;const n=await async function(e={}){De.length&&await it();const t=!!e?.fresh,n=me();return t||!Fe||n-Ue>1500?await Ze(!0):await Ze(!1),function(e){try{return JSON.parse(JSON.stringify(e||Qe()))}catch{return Qe()}}(Ke)}({fresh:!0}),{total:o,breakdown:i}=function(t){const n=t&&"object"==typeof t?t:{},o={gemini:{tokens:0,cost:0,models:new Map},openai:{tokens:0,cost:0,models:new Map}},i={inputTokens:Mo(n.inputTokens),reasoningTokens:Mo(n.reasoningTokens),outputTokens:Mo(n.outputTokens),cachedInputTokens:Mo(n.cachedInputTokens),cacheStorageTokenHours:Co(n.cacheStorageTokenHours),cost:0,requests:Mo(n.requests),byProvider:{gemini:{tokens:0,cost:0},openai:{tokens:0,cost:0}}},s={gemini:{input:0,output:0,reasoning:0,cached:0,cacheStorageTokenHours:0},openai:{input:0,output:0,reasoning:0,cached:0,cacheStorageTokenHours:0}};for(const t of[e.GEMINI,e.OPENAI]){const a=n.byProvider&&"object"==typeof n.byProvider?n.byProvider[t]:null,r=Mo(a?.inputTokens),c=Mo(a?.outputTokens),u=Mo(a?.reasoningTokens),l=Mo(a?.cachedInputTokens),d=Co(a?.cacheStorageTokenHours);s[t]={input:r,output:c,reasoning:u,cached:l,cacheStorageTokenHours:d};const m=a?.models&&"object"==typeof a.models?a.models:{};let p=0,f=0,g=0;for(const[e,n]of Object.entries(m)){if(!n||"object"!=typeof n)continue;const i=Mo(n.inputTokens),s=Mo(n.outputTokens),a=Mo(n.reasoningTokens),r=Mo(n.cachedInputTokens),c=Co(n.cacheStorageTokenHours),u=i+s+a;if(u<=0&&r<=0)continue;const l="string"==typeof n.label?n.label:"",d=String(e||"").trim(),m=(l||d).trim(),h=!m||"unknown"===m.toLowerCase(),y=h?"modele inconnu":m,k=So({provider:t,model:h?"":m,inputTokens:i,outputTokens:s,reasoningTokens:a,cachedInputTokens:r,cacheStorageTokenHours:c}),E=y.toLowerCase(),T=o[t].models.get(E)||{label:y,tokens:0,cost:0};T.tokens+=u,T.cost+=k,o[t].models.set(E,T),p+=u,f+=k,g+=c}if(t===e.GEMINI){const e=Math.max(0,s[t].cacheStorageTokenHours-g);e>0&&(f+=e/1e6*1)}0===p&&(p=r+c+u),o[t].tokens=p,o[t].cost=f,i.byProvider[t].tokens=p,i.byProvider[t].cost=f}return i.inputTokens||(i.inputTokens=s.gemini.input+s.openai.input),i.outputTokens||(i.outputTokens=s.gemini.output+s.openai.output),i.reasoningTokens||(i.reasoningTokens=s.gemini.reasoning+s.openai.reasoning),i.cachedInputTokens||(i.cachedInputTokens=s.gemini.cached+s.openai.cached),i.cacheStorageTokenHours||(i.cacheStorageTokenHours=s.gemini.cacheStorageTokenHours+s.openai.cacheStorageTokenHours),i.cost=i.byProvider.gemini.cost+i.byProvider.openai.cost,{total:i,breakdown:o}}(n);yn("usageTokensTotal").textContent=Tn(o.inputTokens+o.reasoningTokens+o.outputTokens),yn("usageTokensInTotal").textContent=Tn(o.inputTokens),yn("usageTokensReasoningTotal").textContent=Tn(o.reasoningTokens),yn("usageTokensOutTotal").textContent=Tn(o.outputTokens),yn("usageCostTotal").textContent=wn(o.cost);const s=yn("usageSummary");s&&(s.textContent=wn(o.cost)),yn("usageCostGemini").textContent=An(o.byProvider.gemini.cost),yn("usageCostOpenAI").textContent=An(o.byProvider.openai.cost),function(t){const n=yn("usageBreakdown");if(!n)return;n.innerHTML="";const o=[e.GEMINI,e.OPENAI];for(const e of o){const o=t[e]||{tokens:0,cost:0,models:new Map};n.appendChild(ri(ko[e]||e,o.tokens,o.cost,!1));const i=Array.from(o.models.values()).filter(e=>(e.tokens||0)>0||(e.cost||0)>0).sort((e,t)=>t.tokens-e.tokens||e.label.localeCompare(t.label));for(const e of i)n.appendChild(ri(e.label,e.tokens,e.cost,!0))}}(i),Ti(t),function(e){const t=yn("usageChart");if(!t)return;const n=t.getContext("2d");if(!n)return;const o=t.clientWidth||320,i=t.clientHeight||140,s=window.devicePixelRatio||1;t.width=o*s,t.height=i*s,n.setTransform(s,0,0,s,0,0);const a=Date.now()-36e5,r=new Array(60).fill(0);for(const t of e){if(!t.ts||t.ts<a)continue;const e=Math.floor((t.ts-a)/6e4);e>=0&&e<r.length&&(r[e]+=Math.max(0,t.inputTokens+t.reasoningTokens+t.outputTokens))}const c=Math.max(...r,1),u=getComputedStyle(document.documentElement).getPropertyValue("--accent-2").trim()||"#2a9d8f";n.clearRect(0,0,o,i),n.strokeStyle="rgba(38, 70, 83, 0.12)",n.lineWidth=1;for(let e=1;e<=3;e++){const t=i/4*e;n.beginPath(),n.moveTo(0,t),n.lineTo(o,t),n.stroke()}n.beginPath(),r.forEach((e,t)=>{const s=t/(r.length-1)*o,a=i-e/c*(i-12)-6;0===t?n.moveTo(s,a):n.lineTo(s,a)});const l=n.createLinearGradient(0,0,0,i);l.addColorStop(0,"rgba(42, 157, 143, 0.35)"),l.addColorStop(1,"rgba(42, 157, 143, 0.02)"),n.lineWidth=2,n.strokeStyle=u,n.stroke(),n.lineTo(o,i),n.lineTo(0,i),n.closePath(),n.fillStyle=l,n.fill()}(t)}function li(){try{return"undefined"!=typeof document&&document.hidden}catch{return!1}}let di=null,mi=null,pi=null;async function fi(e={}){const{force:t=!1}=e;if(t||!li()){if(di)return di;di=(async()=>{await ui()})();try{return await di}finally{di=null}}}async function gi(t={}){const{force:n=!1}=t;if(n||!li()){if(mi)return mi;mi=(async()=>{await async function(){const t=await async function(){if(await re())return{entries:0,sizeBytes:0,providers:{gemini:{entries:0,sizeBytes:0},openai:{entries:0,sizeBytes:0}},oldestMs:null,newestMs:null};const t=Ne(await we(),await Ae());if(t.removedKeys.length){for(const e of t.removedKeys)await _e(e);await ve(t.list)}const n={entries:0,sizeBytes:0,providers:{gemini:{entries:0,sizeBytes:0},openai:{entries:0,sizeBytes:0}},oldestMs:null,newestMs:null};for(const o of t.list||[]){if(!o?.key)continue;n.entries+=1,n.sizeBytes+=Number(o.size||0);const t=String(o.provider||"").toLowerCase();t===e.GEMINI?(n.providers.gemini.entries+=1,n.providers.gemini.sizeBytes+=Number(o.size||0)):t===e.OPENAI&&(n.providers.openai.entries+=1,n.providers.openai.sizeBytes+=Number(o.size||0));const i=Number(o.savedAtMs||0);i&&(n.oldestMs=null==n.oldestMs?i:Math.min(n.oldestMs,i),n.newestMs=null==n.newestMs?i:Math.max(n.newestMs,i))}return n}();yn("cacheEntries").textContent=Tn(t.entries),yn("cacheSize").textContent=function(e){const t=Number(e);return!Number.isFinite(t)||t<=0?"0 KB":t<1024?`${t} B`:t<1048576?`${(t/1024).toFixed(1)} KB`:`${(t/1048576).toFixed(2)} MB`}(t.sizeBytes),yn("cacheGeminiEntries").textContent=Tn(t.providers.gemini.entries),yn("cacheOpenAIEntries").textContent=Tn(t.providers.openai.entries)}()})();try{return await mi}finally{mi=null}}}async function hi(e={}){const{force:t=!1}=e;if(t||!li()){if(pi)return pi;pi=(async()=>{await ci()})();try{return await pi}finally{pi=null}}}function yi(e){const t=Number(e||0);return t>=8e3?"token-heat--extreme":t>=4e3?"token-heat--hot":t>=1500?"token-heat--warm":"token-heat--cool"}function ki(e){const t=e.call||e.formula||"";return[e.ts||0,e.fn||"",e.provider||"",e.model||"",t].join("|")}function Ei(){const e=yn("logFilterErrors");e&&(e.classList.toggle("is-active",mo),e.setAttribute("aria-pressed",mo?"true":"false"))}function Ti(e){const t=yn("logList");t.innerHTML="";const n=function(e){return mo?e.filter(e=>!e.ok):e}(e||[]);if(!n.length){const e=document.createElement("div");return e.className="log-item log-item--empty",e.textContent=mo?"Aucune erreur enregistrée pour le moment":"Aucune activité enregistrée pour le moment",void t.appendChild(e)}const o=(e,t)=>{const n=document.createElement("span");n.className="token-flow";const o=document.createElement("span");o.className="token-flow__icon",o.textContent=e;const i=document.createElement("span");return i.className="token-flow__value",i.textContent=Tn(t),n.appendChild(o),n.appendChild(i),n},i=n.slice(0,40),s=new Set;for(const e of i){const n=document.createElement("div"),i=e.cache?" log-item--cache":"",a=e.batch?" log-item--batch":"";n.className=`log-item ${e.ok?"log-item--ok":"log-item--error"}${i}${a}`;const r=document.createElement("div");r.className="log-item__top";const c=document.createElement("div");c.className="log-item__title";const u=document.createElement("span");u.className="log-item__title-text",u.textContent=e.fn,c.appendChild(u);const l=String(e.call||e.formula||"").trim();let d=null;if(l){const t=ki(e);s.add(t);const o=document.createElement("button");o.className="log-item__toggle",o.type="button",o.setAttribute("aria-expanded","false"),o.setAttribute("aria-label","Afficher la fonction");const i=document.createElement("span");i.className="log-item__chevron",o.appendChild(i),uo.has(t)&&(n.classList.add("log-item--expanded"),o.setAttribute("aria-expanded","true"),o.setAttribute("aria-label","Masquer la fonction")),o.addEventListener("click",()=>{const e=n.classList.toggle("log-item--expanded");o.setAttribute("aria-expanded",e?"true":"false"),o.setAttribute("aria-label",e?"Masquer la fonction":"Afficher la fonction"),e?uo.add(t):uo.delete(t)}),c.appendChild(o),d=document.createElement("div"),d.className="log-item__detail",d.textContent=l}const m=document.createElement("div");m.style.display="flex",m.style.gap="6px";const p=document.createElement("span");p.className="tag",p.textContent=e.batch?"BATCH":e.provider?e.provider.toUpperCase():"—",m.appendChild(p);const f=document.createElement("span");f.className="tag "+(e.ok?"":"tag--error"),f.textContent=e.ok?"OK":"Erreur",m.appendChild(f);const g=document.createElement("span");if(g.className="tag tag--cost",e.batch?(g.textContent=An(So(e)),g.title="Coût estimé (EUR)"):(g.textContent=vn(So(e)),g.title="Coût estimé (centimes)"),m.appendChild(g),e.batch){const e=document.createElement("span");e.className="tag tag--cache",e.textContent="Lot",m.appendChild(e)}else if(e.cache){const e=document.createElement("span");e.className="tag tag--cache",e.textContent="Cache",m.appendChild(e)}if("AI.BATCH"===e.fn&&("gemini_cached_content"===e.cacheHint||Number(e.cachedInputTokens||0)>0)){const e=document.createElement("span");e.className="tag tag--cache",e.textContent="Cache Gemini",m.appendChild(e)}r.appendChild(c),r.appendChild(m);const h=document.createElement("div");h.className="log-item__meta";const y=Math.max(0,e.inputTokens+e.reasoningTokens+e.outputTokens),k=e.batch?"":e.model?e.model:"",E=e.reasoningEffort?e.reasoningEffort:"",T=Nn(e.ms),I=[k,E].filter(Boolean).join(" · "),A=document.createElement("div");A.className="log-item__info";const w=`${_n(e.ts)} · ${T}`,v=I?` · ${I}`:"";if(e.batch&&e.batchStats){const t=e.batchStats,n=[`Lot ${Tn(t.totalRequests)} req`,`OK ${Tn(t.ok)}`,`Err ${Tn(t.error)}`];t.cached&&n.push(`Cache ${Tn(t.cached)}`),t.avgMs&&n.push(`Moy ${Nn(t.avgMs)}`),t.peakQueued&&n.push(`Pic file ${Tn(t.peakQueued)}`),t.peakActive&&n.push(`Pic actif ${Tn(t.peakActive)}`),A.textContent=`${w}${v} · ${n.join(" · ")}`}else!e.ok&&e.message?A.textContent=`${w}${v} · ${e.message.slice(0,60)}`:A.textContent=`${w}${v}`;if(e.cache){const e=document.createElement("div");e.className="log-item__cache",e.textContent="Cache local",h.appendChild(e)}else{const t=document.createElement("div");t.className="log-item__tokens";const n=document.createElement("div");n.className="log-item__tokens-line";const i=document.createElement("span");i.className=`log-item__heat ${yi(y)}`;const s=document.createElement("span");s.className="log-item__tokens-total",s.textContent=`${Tn(y)} tokens`;const a=document.createElement("span");a.className="log-item__tokens-detail",a.appendChild(document.createTextNode("(")),a.appendChild(o("IN",e.inputTokens)),a.appendChild(document.createTextNode(" / ")),a.appendChild(o("REF",e.reasoningTokens)),a.appendChild(document.createTextNode(" / ")),a.appendChild(o("OUT",e.outputTokens)),"AI.BATCH"===e.fn&&Number(e.cachedInputTokens||0)>0&&(a.appendChild(document.createTextNode(" / ")),a.appendChild(o("CACHE",e.cachedInputTokens))),a.appendChild(document.createTextNode(")")),n.appendChild(i),n.appendChild(s),n.appendChild(a),t.appendChild(n),h.appendChild(t)}h.appendChild(A),n.appendChild(r),d&&n.appendChild(d),n.appendChild(h),t.appendChild(n)}uo.forEach(e=>{s.has(e)||uo.delete(e)})}function Ii(e){no=!!e;const t=yn("privacyModeToggle");t&&(t.checked=no);const n=yn("privacyModeStatus");n&&(n.textContent=no?"Activé":"Désactivé",n.classList.toggle("is-active",no));const o=yn("privacyModeHint");o&&(o.textContent=no?"Journal et cache persistants désactivés.":"Journal et cache persistants activés.");const i=yn("cacheStatus");i&&(i.textContent=no?"Désactivé":"Actif",i.classList.toggle("chip--success",!no),i.classList.toggle("chip--muted",no))}async function Ai(){Ii(await re())}function wi(e){const t=String(e||"").trim();if(!t)return 0;const n=Date.parse(t);return Number.isFinite(n)?n:0}function vi(e){const t=String(e?.name||"").trim(),n=String(e?.displayName||e?.display_name||"").trim(),o=String(e?.model||"").trim(),i=function(e){if(!e||"object"!=typeof e)return 0;const t=[e.cachedContentTokenCount,e.cached_content_token_count,e.totalTokenCount,e.total_token_count,e.promptTokenCount,e.prompt_token_count];for(const e of t){const t=Number(e);if(Number.isFinite(t)&&t>0)return Math.floor(t)}return 0}(e?.usageMetadata||e?.usage_metadata||null),s=wi(e?.createTime||e?.create_time),a=wi(e?.updateTime||e?.update_time),r=wi(e?.expireTime||e?.expire_time),c=document.createElement("div");c.className="explicit-cache__item";const u=document.createElement("div");u.className="explicit-cache__main";const l=document.createElement("div");l.className="explicit-cache__title",l.textContent=n||(t?"Cache Gemini":"Cache");const d=document.createElement("div");d.className="explicit-cache__meta";const m=[];o&&m.push(o.replace("models/","")),i>0&&m.push(`${Tn(i)} tokens`),s&&m.push(`Créé ${bn(s)}`),r&&m.push(`Expire ${bn(r)}`),!r&&a&&m.push(`MAJ ${bn(a)}`),d.textContent=m.join(" · ");const p=document.createElement("div");p.className="explicit-cache__name",p.textContent=t,u.appendChild(l),m.length&&u.appendChild(d),t&&u.appendChild(p);const f=document.createElement("div");f.className="explicit-cache__actions";const g=document.createElement("button");return g.className="explicit-cache__delete",g.type="button",g.textContent="Supprimer",g.dataset.cacheName=t,f.appendChild(g),c.appendChild(u),c.appendChild(f),c}let Ni=null;async function _i(t={}){const{force:n=!1}=t;if(n||!li()){if(Ni)return Ni;Ni=(async()=>{await async function(){const t=yn("geminiExplicitList"),n=yn("geminiExplicitEmpty"),o=yn("geminiExplicitSummary");if(!t||!n||!o)return;t.innerHTML="",n.textContent="Chargement...",n.classList.remove("is-hidden"),o.textContent="0 cache";const i=await async function(t={}){const n=await K(e.GEMINI);if(!n)return{ok:!1,code:"API_KEY_MISSING",message:"Clé API manquante pour Gemini."};const o=fe(t?.pageSize??50,1,100,50),i=fe(t?.maxPages??3,1,5,3),s=!!t?.all;let a=Kt(t?.pageToken)?String(t.pageToken):"",r=0;const c=[];for(;r<i;){r+=1;const e=new URL("https://generativelanguage.googleapis.com/v1beta/cachedContents");e.searchParams.set("pageSize",String(o)),a&&e.searchParams.set("pageToken",a);const t=await sn(e.toString(),{method:"GET",headers:{"Content-Type":"application/json","x-goog-api-key":n}},3e4),i=await an(t);if(!t.ok){const e=Zt(i)||`Gemini API error (${t.status}).`;return{ok:!1,status:t.status,code:"API_ERROR",message:he(e)}}const u=Array.isArray(i?.cachedContents)?i.cachedContents:Array.isArray(i?.cachedContent)?i.cachedContent:[];if(c.push(...u),a=Kt(i?.nextPageToken)?String(i.nextPageToken):"",!s||!a)break}return{ok:!0,caches:c,nextPageToken:a||"",pages:r}}({pageSize:50,all:!0,maxPages:3});if(!i.ok)return void(n.textContent=i.message||"Impossible de récupérer les caches Gemini.");const s=Array.isArray(i.caches)?i.caches:[];if(o.textContent=`${Tn(s.length)} cache${s.length>1?"s":""}`,s.length){n.classList.add("is-hidden");for(const e of s)t.appendChild(vi(e));t.querySelectorAll(".explicit-cache__delete").forEach(t=>{t.addEventListener("click",async()=>{const n=t.dataset.cacheName||"";if(!n)return;t.disabled=!0;const o=await async function(t){const n=await K(e.GEMINI);if(!n)return{ok:!1,code:"API_KEY_MISSING",message:"Clé API manquante pour Gemini."};const o=String(t||"").trim();if(!o)return{ok:!1,code:"INVALID_NAME",message:"Nom de cache invalide."};const i=`https://generativelanguage.googleapis.com/v1beta/${encodeURI(o)}`,s=await sn(i,{method:"DELETE",headers:{"Content-Type":"application/json","x-goog-api-key":n}},3e4),a=await an(s);if(!s.ok){const e=Zt(a)||`Gemini API error (${s.status}).`;return{ok:!1,status:s.status,code:"API_ERROR",message:he(e)}}for(const[e,t]of dt.entries())t?.name&&t.name===o&&dt.delete(e);return{ok:!0}}(n);o.ok?En("Cache supprimé"):En(o.message||"Suppression impossible."),await _i({force:!0})})})}else n.textContent="Aucun cache explicite actif."}()})();try{return await Ni}finally{Ni=null}}}async function bi(o={}){const{silent:i=!1,message:s="Configuration enregistrée"}=o,a=yn("providerGemini").classList.contains("segmented__btn--active")?e.GEMINI:e.OPENAI,r=Zo(Wo(yn("maxTokensRange").value)),c=await async function(e){const o=L(e)||t.provider;return await C(n.DEFAULT_PROVIDER,o),l=o,d=me(),o}(a),u=await z(r);return i||kn(s,{defaultProvider:c,maxOutputTokens:u}),{savedProvider:c,savedTokens:u}}function Si(e={}){const{focusKey:t=!1}=e,n=document.querySelector('[data-section="onboarding"]');if(n){if(n.classList.remove("is-hidden"),n.classList.contains(jn)&&(so.delete("onboarding"),Pn(Array.from(so))),n.classList.contains("is-collapsed")){n.classList.remove("is-collapsed");const e=n.querySelector("[data-collapse-toggle]");e&&e.setAttribute("aria-expanded","true")}if("function"==typeof n.scrollIntoView&&n.scrollIntoView({behavior:"smooth",block:"start"}),t){const e=n.querySelector(Vn);e&&e.focus()}}}function Mi(){document.querySelectorAll($n).forEach(e=>{e.classList.remove("is-open");const t=e.querySelector("button");t&&t.setAttribute("aria-expanded","false")})}async function Ci(e={}){const{silent:t=!1}=e;return Fo()?(eo=!0,to=!0,await ie(!0),Uo(),!0):(t||kn("Ajoutez au moins une clé API avant de valider",{ok:!1}),!1)}async function xi(t,n){const o=(n||"").trim();return!!o&&(await async function(t,n){const o=(n||"").trim(),i=L(t)===e.OPENAI?e.OPENAI:e.GEMINI;return await C(H(i),o),k[i]=o,E[i]=me(),o}(t,o),zn[t]=!0,Wn=!0,$o(),Vo(),Uo(),!0)}async function Oi(e,t){const n=await xi(e,t?.value||"");n&&(t&&(t.value=""),Ko(e,n),kn("Clé enregistrée",{provider:e}))}async function Li(n){const o=n===e.GEMINI,i=yn(o?"geminiModel":"openaiModel");if(!i)return;const s=(i.value||"").trim();await async function(n,o){const i=L(n)===e.OPENAI?e.OPENAI:e.GEMINI,s=String(o||"").trim();if(!s){const n=i===e.OPENAI?t.openaiModel:t.geminiModel;return await C(F(i),n),T[i]=n,void(I[i]=me())}await C(F(i),s),T[i]=s,I[i]=me()}(n,s);let a="";if(o){const e=yn("geminiReasoningEffort");a=Io(s,e?e.value:""),a&&await B(a)}else{const e=yn("openaiReasoningEffort");a=wo(s,e?e.value:""),a&&await Y(a)}kn("Configuration enregistrée",{provider:n,model:s,reasoningEffort:a||void 0}),bo(n,s)}function Pi(e,t){e&&e.classList.toggle("input--warning",t)}async function Ri(e,t){const n=(e?.value||"").trim();if(Pi(e,!1),!n)return Pi(e,!0),zo("Entrez votre clé de licence",!1),void kn("Clé de licence manquante",{ok:!1});const o=t?.textContent||"";t&&(t.disabled=!0,t.textContent="Activation...");const i=await async function(e,t={}){const n=cn(e);if(!n||n.length<5)return{success:!1,error:"Cle trop courte"};const o=await fn();if(!t.force&&o&&o.key===n&&hn(o))return{success:!0,license:o,cached:!0};try{const{ok:e,status:t,data:i}=await dn("https://api.lemonsqueezy.com/v1/licenses/activate",{license_key:n,instance_name:rn});if(!e)return{success:!1,error:ln(i,`Erreur API (${t})`)};if(i?.activated){const e=mn(n,i,{activatedAt:o?.activatedAt});return await le(e),{success:!0,license:e}}return{success:!1,error:ln(i,"Cle invalide")}}catch{return{success:!1,error:"Erreur de connexion internet"}}}(n);if(t&&(t.disabled=!1,t.textContent=o),i.success)return e&&(e.value=""),await Qo({silent:!0}),kn("Licence activée",{expiresAt:i.license?.expiresAt||"n/a"}),void En("Licence enregistrée");const s=i.error||"Clé invalide";Pi(e,!0),zo(s,!1),kn("Échec de l'activation",{error:s})}async function Gi(e=!0){e&&await async function(e=!0){return await C(n.ONBOARDING_SEEN,e?"1":"0"),e}(!0),qo(!1),Do(!1)}async function Di(t){await async function(t){const n=L(t)===e.OPENAI?e.OPENAI:e.GEMINI;await x(H(n)),k[n]="",E[n]=me()}(t),await ai({silent:!0}),kn("Clé effacée",{provider:t})}async function qi(e){kn("Test en cours…",{provider:e});const t=await async function(e){const t=L(e)||await q(),n=await U(t);return await K(t)?await Qt({provider:t,system:"You are a test endpoint. Reply with exactly: OK",user:"OK",maxOutputTokens:500,cache:!1,webSearch:!1,functionName:"AI.MINIMAL_TEST"}):{ok:!1,provider:t,model:n,code:"API_KEY_MISSING",message:`Clé API manquante pour le fournisseur ${t}.`}}(e);t.ok?kn("OK",{provider:t.provider,model:t.model,response:t.text}):kn("Échec",{provider:t.provider,model:t.model,error:t.message,code:t.code})}async function Hi(){document.querySelectorAll("[data-collapse-toggle]").forEach(e=>{const t=e.getAttribute("aria-controls"),n=e.closest("[data-collapsible]");if(!t||!n)return;if(!document.getElementById(t))return;const o=n.classList.contains("is-collapsed");e.setAttribute("aria-expanded",o?"false":"true"),e.addEventListener("click",()=>{const t=!n.classList.contains("is-collapsed");n.classList.toggle("is-collapsed",t),e.setAttribute("aria-expanded",t?"false":"true")})}),function(){let e=!1;const t=()=>{e||(e=!0,setTimeout(async()=>{e=!1,await fi(),await gi(),await hi(),await Ai(),await Qo({silent:!0})},250))};try{if("undefined"!=typeof OfficeRuntime&&OfficeRuntime?.storage?.onChanged){const e=OfficeRuntime.storage.onChanged;"function"==typeof e.add?e.add(()=>t()):"function"==typeof e.addListener?e.addListener(()=>t()):"function"==typeof e&&e(()=>t())}}catch{}try{window.addEventListener("storage",()=>t())}catch{}}(),document.querySelectorAll($n).forEach(e=>{const t=e.querySelector("button");t&&(t.setAttribute("aria-expanded","false"),t.addEventListener("click",n=>{n.stopPropagation();const o=e.classList.contains("is-open");Mi();const i=!o;e.classList.toggle("is-open",i),t.setAttribute("aria-expanded",i?"true":"false")}))}),document.addEventListener("click",e=>{e.target.closest($n)||Mi()}),await async function(){if(co=document.querySelector(".app__main"),!co)return;const e=Array.from(co.querySelectorAll(Fn));ao=new Map,e.forEach(e=>{const t=Sn(e);t&&ao.set(t,e)});const t=await async function(){await O();const e=await M(n.SECTION_ORDER);if(!e)return[];try{return ce(JSON.parse(e))}catch{return[]}}(),o=e.map(e=>Sn(e)).filter(Boolean);io=o.slice(),oo=function(e,t){const n=[],o=new Set;if(Array.isArray(e))for(const t of e)t&&!o.has(t)&&ao.has(t)&&(o.add(t),n.push(t));for(const e of t)e&&!o.has(e)&&(o.add(e),n.push(e));return n}(t,o),Cn(oo),so=new Set(await async function(){await O();const e=await M(n.SECTION_HIDDEN);if(!e)return[];try{return ce(JSON.parse(e))}catch{return[]}}()),On(),xn(so),Dn(),function(){const e=yn("sectionManagerList");e&&(e.addEventListener("dragstart",e=>{const t=e.target.closest(".section-row__handle");if(!t)return;const n=t.closest(".section-row");n&&(ro=n.dataset.sectionKey||"",n.classList.add("is-dragging"),e.dataTransfer&&(e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",ro)))}),e.addEventListener("dragover",t=>{if(!ro)return;t.preventDefault();const n=t.target.closest(".section-row");if(!n||n.dataset.sectionKey===ro)return;!function(e){e.querySelectorAll(".section-row").forEach(e=>{e.classList.remove("is-drop-before","is-drop-after")})}(e);const o=n.getBoundingClientRect(),i=t.clientY<o.top+o.height/2;n.classList.toggle("is-drop-before",i),n.classList.toggle("is-drop-after",!i)}),e.addEventListener("dragleave",e=>{const t=e.target.closest(".section-row");t&&t.classList.remove("is-drop-before","is-drop-after")}),e.addEventListener("drop",t=>{if(!ro)return;t.preventDefault();const n=t.target.closest(".section-row"),o=n&&n.dataset.sectionKey||"",i=ro;ro="",Gn(e);let s=oo.slice();if(o){const e=n.getBoundingClientRect();s=function(e,t,n,o){const i=e.filter(e=>e!==t),s=i.indexOf(n);if(s<0)return i.push(t),i;const a=o?s:s+1;return i.splice(a,0,t),i}(s,i,o,t.clientY<e.top+e.height/2)}else s=function(e,t){const n=e.filter(e=>e!==t);return n.push(t),n}(s,i);Ln(s)}),e.addEventListener("dragend",()=>{ro="",Gn(e)}))}()}(),await async function(){const e=yn("privacyModeToggle");e&&(await Ai(),e.addEventListener("change",async()=>{const t=!!e.checked;await async function(e=!1){const t=!!e;return r=t,c=me(),await C(n.PRIVACY_MODE,t?"1":"0"),t}(t),Ii(t),t&&(await at(),await nn()),await fi({force:!0}),await gi({force:!0}),kn(t?"Mode confidentialité activé":"Mode confidentialité désactivé",{privacyMode:t})}))}();const o=yn("settingsButton");o&&o.addEventListener("click",()=>Ro(!0)),document.querySelectorAll("[data-settings-open]").forEach(e=>{e.addEventListener("click",()=>Ro(!0))}),document.querySelectorAll("[data-settings-close]").forEach(e=>{e.addEventListener("click",()=>Ro(!1))});const i=yn("sectionManagerReset");i&&i.addEventListener("click",()=>{io.length&&Ln(io)});const s=yn("pricingHelp");s&&s.addEventListener("click",()=>(function(){const t=yn("pricingTableBodyGemini"),n=yn("pricingTableBodyOpenAI");if(!t&&!n)return;t&&(t.innerHTML=""),n&&(n.innerHTML="");const o=(e,t)=>{if(!t)return;const n=ho[e]||[];for(const e of n){const n=document.createElement("tr"),o=No(e),i=document.createElement("td");i.textContent=e.id;const s=document.createElement("td");s.className="pricing-table__col-price",s.textContent=vo(e.prices?.input);const a=document.createElement("td");a.className="pricing-table__col-price",a.textContent=vo(e.prices?.output);const r=document.createElement("td");r.className="pricing-table__col-icon",r.textContent=o.cost;const c=document.createElement("td");c.className="pricing-table__col-icon",c.textContent=o.reasoning,n.appendChild(i),n.appendChild(s),n.appendChild(a),n.appendChild(r),n.appendChild(c),t.appendChild(n)}};o(e.GEMINI,t),o(e.OPENAI,n)}(),void Go(!0))),document.querySelectorAll("[data-modal-close]").forEach(e=>{e.addEventListener("click",()=>Ho())}),document.querySelectorAll("[data-onboarding-close]").forEach(e=>{e.addEventListener("click",async()=>Gi(!0))}),document.querySelectorAll("[data-onboarding-keys-close]").forEach(e=>{e.addEventListener("click",()=>qo(!1))});const a=yn("onboardingClose");a&&a.addEventListener("click",async()=>Gi(!0));const u=yn("onboardingDone");u&&u.addEventListener("click",async()=>Gi(!0));const l=yn("onboardingKeysButton");l&&l.addEventListener("click",async()=>{await Gi(!0),Si({focusKey:!0})}),document.querySelectorAll("[data-onboarding-open]").forEach(e=>{e.addEventListener("click",()=>{Ro(!1),Si({focusKey:!0})})});const d=yn("onboardingKeysSave");d&&d.addEventListener("click",async()=>async function(){const t=yn("onboardingGeminiKey"),n=yn("onboardingOpenAIKey"),o=await xi(e.GEMINI,t?.value||""),i=await xi(e.OPENAI,n?.value||"");t&&(t.value=""),n&&(n.value=""),Ko(e.GEMINI,zn.gemini),Ko(e.OPENAI,zn.openai),(o||i)&&kn("Clés enregistrées",{gemini:!!o,openai:!!i}),(zn.gemini||zn.openai)&&(await Ci({silent:!0}),qo(!1))}());const m=yn("onboardingKeysLater");m&&m.addEventListener("click",()=>qo(!1)),document.addEventListener("keydown",async e=>{"Escape"===e.key&&(Mi(),Po("onboardingKeysModal")?qo(!1):Po("onboardingModal")?await Gi(!0):Po("settingsModal")?Ro(!1):Po("pricingModal")&&Ho())}),yn("tabGemini").addEventListener("click",()=>si("gemini")),yn("tabOpenAI").addEventListener("click",()=>si("openai")),yn("providerGemini").addEventListener("click",async()=>{ei(e.GEMINI),await bi()}),yn("providerOpenAI").addEventListener("click",async()=>{ei(e.OPENAI),await bi()}),yn("maxTokensRange").addEventListener("input",()=>{!function(){const e=Zo(Wo(yn("maxTokensRange").value));yn("maxTokensValue").textContent=Tn(e)}()}),yn("maxTokensRange").addEventListener("change",async()=>{await bi()}),yn("concurrencyRange").addEventListener("input",()=>{oi()}),yn("concurrencyRange").addEventListener("change",async()=>{await async function(e={}){const{silent:t=!1,message:n="Concurrence enregistrée"}=e,o=oi(),i=await Z(o);return t||kn(n,{concurrency:i}),i}()});const p=yn("rpmLimitInput");p&&p.addEventListener("change",async()=>{await async function(e={}){const{silent:n=!1,message:o="Limite RPM enregistrée"}=e,i=function(){const e=yn("rpmLimitInput");if(!e)return t.rpmLimit;const n=ii(e.value);return e.value=String(n),n}(),s=await ne(i);return fo=s,n||kn(o,{rpmLimit:s}),s}()});const f=yn("geminiReasoningEffort");f&&(f.addEventListener("input",()=>{const e=yn("geminiModel");Io(e?e.value:"",f.value)}),f.addEventListener("change",async()=>{await async function(){const e=yn("geminiModel"),t=yn("geminiReasoningEffort");if(!t)return;const n=Io(e?e.value:"",t.value);n&&await B(n),kn("Effort de raisonnement enregistré",{geminiReasoningEffort:n})}()}));const g=yn("openaiReasoningEffort");g&&(g.addEventListener("input",()=>{const e="0"!==g.dataset.allowNone;let t=Ao(g.value);e||"none"!==t||(g.value="1",t=Ao(g.value)),g.setAttribute("aria-valuetext",t)}),g.addEventListener("change",async()=>{await async function(){const e=yn("openaiModel"),t=yn("openaiReasoningEffort");if(!t)return;const n=wo(e?e.value:"",t.value);n&&await Y(n),kn("Effort de raisonnement enregistré",{openaiReasoningEffort:n})}()}));const h=yn("geminiModel");h&&h.addEventListener("change",async()=>{await Li(e.GEMINI)});const y=yn("openaiModel");y&&y.addEventListener("change",async()=>{await Li(e.OPENAI)}),document.querySelectorAll(Vn).forEach(e=>{const t=String(e.dataset.keyInput||"").trim().toLowerCase();t&&(e.addEventListener("input",()=>Pi(e,!1)),e.addEventListener("change",async()=>{await Oi(t,e)}),e.addEventListener("keydown",n=>{if("Enter"!==n.key)return;n.preventDefault();const o=e.closest(".input-action")?.querySelector(Yn);o?o.click():Oi(t,e)}))}),document.querySelectorAll(Yn).forEach(e=>{const t=String(e.dataset.keySave||"").trim().toLowerCase();t&&e.addEventListener("click",async()=>{const n=e.closest(".input-action")?.querySelector(Vn);await Oi(t,n),"true"===e.dataset.keyConfirm&&await Ci()})});const k=yn("licenseModeSubscribe"),E=yn("licenseModeHave");k&&k.addEventListener("click",()=>Xo(!1)),E&&E.addEventListener("click",()=>Xo(!0,{focus:!0})),document.querySelectorAll(Bn).forEach(e=>{e.addEventListener("input",()=>Pi(e,!1)),e.addEventListener("keydown",t=>{if("Enter"!==t.key)return;t.preventDefault();const n=document.querySelector(`[data-license-activate][data-license-target="${e.id}"]`)||e.closest(".input-action, .setup-license__row")?.querySelector("[data-license-activate]");n&&Ri(e,n)})}),document.querySelectorAll("[data-license-activate]").forEach(e=>{e.addEventListener("click",async()=>{const t=e.dataset.licenseTarget,n=(t?yn(t):null)||e.closest(".input-action, .setup-license__row")?.querySelector(Bn);await Ri(n,e)})}),document.querySelectorAll("[data-license-test]").forEach(e=>{e.addEventListener("click",async()=>{const t=e.dataset.licenseTarget,n=(t?yn(t):null)||e.closest(".input-action")?.querySelector(Bn);await async function(e,t){if(!e||!t)return;const n=(e.value||"").trim(),o=Xn||await fn(),i=n||o?.key||"";if(Pi(e,!1),!i)return Pi(e,!0),void kn("Clé de licence manquante",{ok:!1});const s=t.textContent;t.disabled=!0,t.textContent="Test...";const a=await async function(e,t={}){const n=cn(e);if(!n||n.length<5)return{success:!1,error:"Cle trop courte"};const o=await fn(),i=t.instanceId||o?.instanceId||"";try{const{ok:e,status:t,data:s}=await dn("https://api.lemonsqueezy.com/v1/licenses/validate",{license_key:n,instance_id:i||void 0});return e?s?.valid?{success:!0,license:mn(n,s,{instanceId:i,activatedAt:o?.activatedAt})}:{success:!1,error:ln(s,"Cle invalide")}:{success:!1,error:ln(s,`Erreur API (${t})`)}}catch{return{success:!1,error:"Erreur de connexion internet"}}}(i);if(t.disabled=!1,t.textContent=s,a.success){const e=a.license?.expiresAt||"n/a";return o&&i===o.key?(await gn({...o,...a.license,valid:!0,lastCheckedAt:(new Date).toISOString()}),await Qo({silent:!0})):o&&o.key||zo("Licence valide (non enregistrée)",!0),void(!n||o&&i===o.key?kn("Licence valide",{expiresAt:e}):kn("Licence valide. Cliquez sur Activer pour l'enregistrer.",{expiresAt:e}))}const r=a.error||"Clé invalide";kn("Licence invalide",{error:r}),o&&i===o.key?(await gn({...o,valid:!1,lastCheckedAt:(new Date).toISOString()}),await Qo({silent:!0})):o&&o.key||zo(r,!1)}(n,e)})}),document.querySelectorAll("[data-license-clear]").forEach(e=>{e.addEventListener("click",async()=>async function(){await async function(){await de()}(),Xn=null,document.querySelectorAll(Bn).forEach(e=>{e.value="",Pi(e,!1)}),await Qo({silent:!0}),kn("Licence effacée",{ok:!0})}())});const T=yn("clearGemini");T&&T.addEventListener("click",async()=>Di(e.GEMINI));const I=yn("clearOpenAI");I&&I.addEventListener("click",async()=>Di(e.OPENAI));const A=yn("testGemini");A&&A.addEventListener("click",async()=>qi(e.GEMINI));const w=yn("testOpenAI");w&&w.addEventListener("click",async()=>qi(e.OPENAI));const v=yn("clearUsageTotals");v&&v.addEventListener("click",async()=>{await async function(){Ke=Qe(),Fe=!0,$e=null,Ue=me(),je=!1,await x(n.USAGE_TOTALS)}(),await fi({force:!0}),kn("Utilisation réinitialisée",{ok:!0})});const N=yn("logFilterErrors");N&&N.addEventListener("click",()=>{mo=!mo,Ei(),Ti(po)}),Ei(),yn("clearLogs").addEventListener("click",async()=>{await at(),await fi({force:!0}),kn("Journal effacé",{ok:!0})}),yn("refreshCache").addEventListener("click",async()=>{await gi({force:!0}),kn("Cache actualisé",{ok:!0})});const _=yn("refreshGeminiExplicit");_&&_.addEventListener("click",async()=>{await _i({force:!0}),kn("Caches Gemini actualisés",{ok:!0})}),yn("clearCache").addEventListener("click",async()=>{await nn(),await gi({force:!0}),kn("Cache vidé",{ok:!0})});const b=yn("queueStop");b&&b.addEventListener("click",async()=>{!function(){if(!wt.length)return 0;const e=wt.drain();for(const t of e)t(pt);Gt(),e.length}(),await hi({force:!0})}),si("gemini"),await ai(),await Qo({silent:!0}),await fi({force:!0}),await gi({force:!0}),await _i({force:!0}),await hi({force:!0}),await async function(){await async function(){return await O(),"1"===await M(n.ONBOARDING_SEEN)}()||Do(!0)}(),document.addEventListener("visibilitychange",()=>{li()||(fi(),gi(),_i(),hi())}),setInterval(()=>{fi()},2e3),setInterval(()=>{gi()},12e3),setInterval(()=>{_i()},15e3),setInterval(()=>{hi()},1e3)}document.addEventListener("DOMContentLoaded",async()=>{await async function(){try{"undefined"!=typeof Office&&Office?.onReady&&await Office.onReady()}catch{}}(),await Hi()})})();
//# sourceMappingURL=taskpane.js.map