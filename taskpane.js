(()=>{"use strict";const e=Object.freeze({GEMINI:"gemini",OPENAI:"openai"}),t=Object.freeze({provider:e.GEMINI,geminiModel:"gemini-3-flash-preview",openaiModel:"gpt-5-mini",geminiReasoningEffort:"minimal",openaiReasoningEffort:"low",maxOutputTokens:4096,concurrencyLimit:4,rpmLimit:0,retry:2,timeoutMs:12e4,cache:!0,cacheTtlSec:604800}),n=Object.freeze({DEFAULT_PROVIDER:"AI_DEFAULT_PROVIDER_V3",GEMINI_API_KEY:"AI_GEMINI_API_KEY_V3",OPENAI_API_KEY:"AI_OPENAI_API_KEY_V3",GEMINI_MODEL:"AI_GEMINI_MODEL_V3",OPENAI_MODEL:"AI_OPENAI_MODEL_V3",GEMINI_REASONING_EFFORT:"AI_GEMINI_REASONING_EFFORT_V3",OPENAI_REASONING_EFFORT:"AI_OPENAI_REASONING_EFFORT_V3",MAX_OUTPUT_TOKENS:"AI_MAX_OUTPUT_TOKENS_V3",CONCURRENCY_LIMIT:"AI_CONCURRENCY_LIMIT_V1",RPM_LIMIT:"AI_RPM_LIMIT_V1",ONBOARDING_SEEN:"AI_ONBOARDING_SEEN_V1",ONBOARDING_KEYS_CONFIRMED:"AI_ONBOARDING_KEYS_CONFIRMED_V1",SECTION_ORDER:"AI_SECTION_ORDER_V1",SECTION_HIDDEN:"AI_SECTION_HIDDEN_V1",LICENSE:"AI_LICENSE_V1",PRIVACY_MODE:"AI_PRIVACY_MODE_V1",MIGRATION_DONE:"AI_MIGRATION_DONE_V3",REQUEST_LOG:"AI_REQUEST_LOG_V1",REQUEST_LOG_CLEAR_AT:"AI_REQUEST_LOG_CLEAR_AT_V1",USAGE_TOTALS:"AI_USAGE_TOTALS_V1",CACHE_INDEX:"AI_CACHE_INDEX_V1",CACHE_CLEAR_AT:"AI_CACHE_CLEAR_AT_V1",RUNTIME_STATUS:"AI_RUNTIME_STATUS_V1"}),o=new Set([n.GEMINI_API_KEY,n.OPENAI_API_KEY,n.LICENSE]),i=Object.freeze({GEMINI_API_KEY:"GEMINI_API_KEY",MAX_OUTPUT_TOKENS:"MAX_OUTPUT_TOKENS",DEFAULT_PROVIDER_V2:"AI_DEFAULT_PROVIDER_V2",GEMINI_API_KEY_V2:"AI_GEMINI_API_KEY_V2",OPENAI_API_KEY_V2:"AI_OPENAI_API_KEY_V2",GEMINI_MODEL_V2:"AI_GEMINI_MODEL_V2",OPENAI_MODEL_V2:"AI_OPENAI_MODEL_V2",GEMINI_MAX_TOKENS_V2:"AI_GEMINI_MAX_OUTPUT_TOKENS_V2",OPENAI_MAX_TOKENS_V2:"AI_OPENAI_MAX_OUTPUT_TOKENS_V2"});let a=null,s=!1,r=null,c=0;const u=1500;let l=null,d=0,m=null,f=0,p=null,g=0,h=null,E=0;const I={gemini:null,openai:null},y={gemini:0,openai:0},k={gemini:null,openai:null},T={gemini:0,openai:0};function N(){s=!0}const b={kind:"memory",storage:(()=>{const e=new Map;return{getItem:async t=>e.has(t)?e.get(t):null,async setItem(t,n){e.set(t,String(n))},async removeItem(t){e.delete(t)}}})()};function _(){if(!s)try{if("undefined"!=typeof OfficeRuntime&&OfficeRuntime?.storage?.getItem)return{kind:"office",storage:OfficeRuntime.storage}}catch{}try{if("undefined"!=typeof window&&window?.localStorage?.getItem)return{kind:"local",storage:window.localStorage}}catch{}return b}function A(){try{if("undefined"!=typeof window&&window?.localStorage?.getItem)return window.localStorage}catch{return null}return null}function w(e,t){try{return e.getItem(t)}catch{return null}}function v(e,t,n){try{return e.setItem(t,n),!0}catch{return!1}}function S(e,t){try{return e.removeItem(t),!0}catch{return!1}}async function M(e,t={}){const{kind:n,storage:i}=_(),a=t.sensitive??function(e){return o.has(e)}(e),r=!1!==t.allowLocalFallback;if("local"===n)return w(i,e);if("office"===n){let t=null;try{t=await i.getItem(e)}catch{N()}if(null!=t){if(a){const t=A();t&&S(t,e)}return t}if(!r)return null;const n=A();if(!n)return null;const o=w(n,e);if(null==o)return null;if(!s)try{await i.setItem(e,String(o)),S(n,e)}catch{N()}return o}try{return await i.getItem(e)}catch{return null}}async function C(e,t,n={}){const{kind:o,storage:i}=_(),a=null==t?"":String(t),s=!1!==n.allowLocalFallback;if("local"!==o){if("office"===o){let t=!1;try{await i.setItem(e,a),t=!0}catch{N()}const n=A();if(t)return void(n&&S(n,e));if(!s||!n)return;return void v(n,e,a)}try{await i.setItem(e,a)}catch{}}else v(i,e,a)}async function L(e){const{kind:t,storage:n}=_();if("local"!==t){if("office"===t){let t=!1;try{await n.removeItem(e),t=!0}catch{N()}const o=A();return void(o&&S(o,e))}try{await n.removeItem(e)}catch{}}else S(n,e)}async function O(){if(a)return a;a=(async()=>{if("1"!==await M(n.MIGRATION_DONE)){if(!x(await M(n.DEFAULT_PROVIDER))){const e=x(await M(i.DEFAULT_PROVIDER_V2));await C(n.DEFAULT_PROVIDER,e||t.provider)}if(!await M(n.GEMINI_API_KEY)){const e=await M(i.GEMINI_API_KEY_V2)||await M(i.GEMINI_API_KEY);e&&await C(n.GEMINI_API_KEY,e)}if(!await M(n.OPENAI_API_KEY)){const e=await M(i.OPENAI_API_KEY_V2);e&&await C(n.OPENAI_API_KEY,e)}if(!await M(n.GEMINI_MODEL)){const e=await M(i.GEMINI_MODEL_V2);await C(n.GEMINI_MODEL,e||t.geminiModel)}if(!await M(n.OPENAI_MODEL)){const e=await M(i.OPENAI_MODEL_V2);await C(n.OPENAI_MODEL,e||t.openaiModel)}if(!await M(n.MAX_OUTPUT_TOKENS)){const e=[await M(i.MAX_OUTPUT_TOKENS),await M(i.GEMINI_MAX_TOKENS_V2),await M(i.OPENAI_MAX_TOKENS_V2)].map(e=>parseInt(String(e||"").trim(),10)).filter(e=>Number.isFinite(e)&&e>0),o=e.length?Math.max(...e):t.maxOutputTokens;await C(n.MAX_OUTPUT_TOKENS,String(o))}await C(n.MIGRATION_DONE,"1")}})();try{await a}finally{a=null}}function x(t){if(!t)return"";const n=String(t).trim().toLowerCase();return n===e.GEMINI?e.GEMINI:n===e.OPENAI?e.OPENAI:"google"===n||"gem"===n?e.GEMINI:"oai"===n||"chatgpt"===n?e.OPENAI:""}const P=new Set(["auto","minimal","low","medium","high"]),R=new Set(["none","minimal","low","medium","high"]);function G(e){const n=String(e||"").trim().toLowerCase();return n&&P.has(n)?n:t.geminiReasoningEffort}function D(e){const n=String(e||"").trim().toLowerCase();return n&&R.has(n)?n:t.openaiReasoningEffort}async function q(){const e=le();if(l&&e-d<u)return l;await O();const o=x(await M(n.DEFAULT_PROVIDER))||t.provider;return l=o,d=e,o}function F(t){return x(t)===e.OPENAI?n.OPENAI_API_KEY:n.GEMINI_API_KEY}async function H(t){const n=x(t)===e.OPENAI?e.OPENAI:e.GEMINI,o=le();if(null!=I[n]&&o-y[n]<u)return(I[n]||"").trim();await O();const i=await M(F(n))||"",a=String(i).trim();return I[n]=a,y[n]=o,a}async function $(e){return!!await H(e)}function K(t){return x(t)===e.OPENAI?n.OPENAI_MODEL:n.GEMINI_MODEL}async function V(n){const o=x(n)===e.OPENAI?e.OPENAI:e.GEMINI,i=le(),a=k[o];if(a&&i-T[o]<u)return a;await O();const s=await M(K(o)),r=s&&String(s).trim()?String(s).trim():o===e.OPENAI?t.openaiModel:t.geminiModel;return k[o]=r,T[o]=i,r}async function U(){const e=le();if(p&&e-g<u)return p;await O();const o=G(await M(n.GEMINI_REASONING_EFFORT)||t.geminiReasoningEffort);return p=o,g=e,o}async function j(){const e=le();if(h&&e-E<u)return h;await O();const o=D(await M(n.OPENAI_REASONING_EFFORT)||t.openaiReasoningEffort);return h=o,E=e,o}async function B(e){const t=D(e);return await C(n.OPENAI_REASONING_EFFORT,t),h=t,E=le(),t}async function Y(e){const t=G(e);return await C(n.GEMINI_REASONING_EFFORT,t),p=t,g=le(),t}async function z(){const e=le();if(m&&e-f<u)return m;await O();const o=await M(n.MAX_OUTPUT_TOKENS),i=de(parseInt(String(o||"").trim(),10),1,128e3,t.maxOutputTokens);return m=i,f=e,i}async function J(e){const o=de(e,1,128e3,t.maxOutputTokens);return await C(n.MAX_OUTPUT_TOKENS,String(o)),m=o,f=le(),o}const X=[4,8,16,32,64,128];function Q(e){const n=de(e,X[0],X[X.length-1],t.concurrencyLimit);if(X.includes(n))return n;let o=X[0],i=Math.abs(n-o);for(const e of X.slice(1)){const t=Math.abs(n-e);t<i&&(o=e,i=t)}return o}async function W(){return await O(),Q(await M(n.CONCURRENCY_LIMIT))}async function Z(e){const t=Q(e);return await C(n.CONCURRENCY_LIMIT,String(t)),t}function ee(e){return de("string"==typeof e?parseInt(e.trim(),10):Number(e),0,1e5,t.rpmLimit)}async function te(){return await O(),ee(await M(n.RPM_LIMIT))}async function ne(e){const t=ee(e);return await C(n.RPM_LIMIT,String(t)),t}async function oe(){return await O(),"1"===await M(n.ONBOARDING_KEYS_CONFIRMED)}async function ie(e=!0){return await C(n.ONBOARDING_KEYS_CONFIRMED,e?"1":"0"),e}function ae(e){return e&&"object"==typeof e?{active:de(e.active,0,1e5,0),queued:de(e.queued,0,1e5,0),rpm:de(e.rpm,0,1e6,0),ts:de(e.ts,0,Number.MAX_SAFE_INTEGER,0)}:{active:0,queued:0,rpm:0,ts:0}}async function se(e){const t=ae(e);return await C(n.RUNTIME_STATUS,JSON.stringify(t)),t}async function re(){return await async function(){const e=le();if(null!=r&&e-c<2e3)return r;const t="1"===await M(n.PRIVACY_MODE);return r=t,c=e,t}()}function ce(e){if(!Array.isArray(e))return[];const t=[],n=new Set;for(const o of e){const e=String(o||"").trim();e&&!n.has(e)&&(n.add(e),t.push(e))}return t}async function ue(e){const t=ce(e);return await C(n.SECTION_HIDDEN,JSON.stringify(t)),t}function le(){return Date.now()}function de(e,t,n,o=t){const i=parseInt(String(e),10);return Number.isFinite(i)?Math.max(t,Math.min(n,i)):o}const me=[/\bsk-[A-Za-z0-9-_]{1,}\b/gi,/\bAIza[0-9A-Za-z_-]{1,}\b/gi,/\b[A-Z0-9]{4}(?:-[A-Z0-9]{4}){1,3}\b/gi];function fe(e){if(null==e)return"";let t=String(e);for(const e of me)t=t.replace(e,"[REDACTED]");return t}function pe(e){if(null==e)return e;if("string"==typeof e)return fe(e);if(Array.isArray(e))return e.map(pe);if("object"==typeof e){const t={};for(const[n,o]of Object.entries(e))t[n]=pe(o);return t}return e}function ge(e){const t=parseInt(String(e||"").trim(),10);return Number.isFinite(t)&&t>0?t:0}const he=5242880;let Ee=0;async function Ie(){const e=await M(n.CACHE_INDEX);if(!e)return[];try{const t=JSON.parse(e);return Array.isArray(t)?t:[]}catch{return[]}}async function ye(e){e&&await L("AI_CACHE_ENTRY_V1:"+e)}const ke=1/0;let Te=[],Ne=null,be=!1,_e=0,Ae=0,we=[],ve=null,Se=null,Me=He(),Ce=null,Le=!1,Oe=0,xe=!1;async function Pe(e={}){const t=ge(await M(n.REQUEST_LOG_CLEAR_AT));return t>Ae&&(Ae=t,Te=[],e.reset?(be=!0,Ne=null,_e=le()):be=!1),Ae}function Re(e){return!!e&&!1===e.ok}async function Ge(e=!1){if(Ne)return Ne;Ne=(async()=>{if(await re())return!e&&be||(be=!0,_e=le()),Te;const t=await Pe();if(!e&&be)return Te;const o=await M(n.REQUEST_LOG);let i=[];if(o)try{i=function(e){if(Array.isArray(e))return e;if(e&&"object"==typeof e){const t=Array.isArray(e.normal)?e.normal:[],n=Array.isArray(e.errors)?e.errors:[];return t.concat(n)}return[]}(JSON.parse(o))}catch{i=[]}const a=le();return i=i.map(e=>{if(!e)return null;let t=e.ts;if("string"==typeof t){const e=Date.parse(t);Number.isFinite(e)&&(t=e)}return"number"!=typeof t?null:{...e,ts:t}}).filter(e=>e&&"number"==typeof e.ts&&e.ts>t&&a-e.ts<=ke).map(e=>{return(t=e)&&"object"==typeof t?pe(t):t;var t}),Te=i,De(),be=!0,_e=le(),Te})();try{return await Ne}finally{Ne=null}}function De(){const e=le(),t=Ae||0,n=(Te||[]).filter(n=>n&&"number"==typeof n.ts&&n.ts>t&&e-n.ts<=ke),o=[],i=[];for(const e of n)Re(e)?i.push(e):o.push(e);o.sort((e,t)=>e.ts-t.ts),i.sort((e,t)=>e.ts-t.ts);const a=o.slice(-50).concat(i.slice(-50));a.sort((e,t)=>e.ts-t.ts),Te=a}function qe(e){const t=Number(e);return!Number.isFinite(t)||t<=0?0:Math.floor(t)}function Fe(e){const t=Number(e);return!Number.isFinite(t)||t<=0?0:t}function He(){return{inputTokens:0,outputTokens:0,reasoningTokens:0,cachedInputTokens:0,cacheStorageTokenHours:0,requests:0,batchApplied:{},byProvider:{[e.GEMINI]:{inputTokens:0,outputTokens:0,reasoningTokens:0,cachedInputTokens:0,cacheStorageTokenHours:0,requests:0,models:{}},[e.OPENAI]:{inputTokens:0,outputTokens:0,reasoningTokens:0,cachedInputTokens:0,cacheStorageTokenHours:0,requests:0,models:{}}}}}function $e(e){if(!e||"object"!=typeof e)return{};const t=le(),n=Object.entries(e).filter(([,e])=>e&&"object"==typeof e).filter(([,e])=>{const n=Number(e.ts)||0;return!n||t-n<=864e5}).sort((e,t)=>(Number(e[1].ts)||0)-(Number(t[1].ts)||0)).slice(-80),o={};for(const[e,t]of n)o[e]=t;return o}async function Ke(t=!1){if(Ce)return Ce;Ce=(async()=>{if(await re())return!t&&Le||(Le=!0,Oe=le()),Me;if(!t&&Le)return Me;const o=await M(n.USAGE_TOTALS);let i=null;if(o)try{i=JSON.parse(o)}catch{i=null}return Me=function(t){const n=He();if(!t||"object"!=typeof t)return n;n.inputTokens=qe(t.inputTokens),n.outputTokens=qe(t.outputTokens),n.reasoningTokens=qe(t.reasoningTokens),n.cachedInputTokens=qe(t.cachedInputTokens),n.cacheStorageTokenHours=Fe(t.cacheStorageTokenHours),n.requests=qe(t.requests),n.batchApplied=function(t){if(!t||"object"!=typeof t)return{};const n={};for(const[o,i]of Object.entries(t)){if(!i||"object"!=typeof i)continue;const t=i.models&&"object"==typeof i.models?i.models:{},a={};for(const[n,o]of Object.entries(t)){if(!o||"object"!=typeof o)continue;const t=String(o.provider||"").toLowerCase();if(t!==e.GEMINI&&t!==e.OPENAI)continue;const i=String(o.modelKey||o.model||n||"").toLowerCase();i&&(a[n]={provider:t,modelKey:i,label:"string"==typeof o.label?o.label:"",inputTokens:qe(o.inputTokens),outputTokens:qe(o.outputTokens),reasoningTokens:qe(o.reasoningTokens),cachedInputTokens:qe(o.cachedInputTokens),cacheStorageTokenHours:Fe(o.cacheStorageTokenHours),requests:qe(o.requests)})}n[o]={ts:Number(i.ts)||0,models:a}}return $e(n)}(t.batchApplied);const o=t.byProvider&&"object"==typeof t.byProvider?t.byProvider:{};for(const t of[e.GEMINI,e.OPENAI]){const e=o[t];if(!e||"object"!=typeof e)continue;const i=n.byProvider[t];i.inputTokens=qe(e.inputTokens),i.outputTokens=qe(e.outputTokens),i.reasoningTokens=qe(e.reasoningTokens),i.cachedInputTokens=qe(e.cachedInputTokens),i.cacheStorageTokenHours=Fe(e.cacheStorageTokenHours),i.requests=qe(e.requests);const a=e.models&&"object"==typeof e.models?e.models:{};for(const[e,t]of Object.entries(a)){if(!t||"object"!=typeof t)continue;const n="string"==typeof t.label?t.label:String(e||""),o=String(e||n||"").toLowerCase();o&&(i.models[o]={label:n,inputTokens:qe(t.inputTokens),outputTokens:qe(t.outputTokens),reasoningTokens:qe(t.reasoningTokens),cachedInputTokens:qe(t.cachedInputTokens),cacheStorageTokenHours:Fe(t.cacheStorageTokenHours),requests:qe(t.requests)})}}return n}(i),Le=!0,Oe=le(),Me})();try{return await Ce}finally{Ce=null}}function Ve(t){if(!t||"object"!=typeof t)return!1;if(t.batch&&Array.isArray(t.batchModels)){const n=t.batchId?String(t.batchId):"",o=le(),i={};for(const n of t.batchModels){if(!n||"object"!=typeof n)continue;const t=String(n.provider||"").toLowerCase();if(t!==e.GEMINI&&t!==e.OPENAI)continue;const o=String(n.model||"").trim(),a=(o||"unknown").toLowerCase(),s=`${t}|${a}`,r=i[s]||{provider:t,modelKey:a,label:o,inputTokens:0,outputTokens:0,reasoningTokens:0,cachedInputTokens:0,cacheStorageTokenHours:0,requests:0};r.inputTokens+=qe(n.inputTokens),r.outputTokens+=qe(n.outputTokens),r.reasoningTokens+=qe(n.reasoningTokens),r.cachedInputTokens+=qe(n.cachedInputTokens),r.cacheStorageTokenHours+=Fe(n.cacheStorageTokenHours),r.requests+=qe(n.requests),!r.label&&o&&(r.label=o),i[s]=r}if(!n){let e=!1;for(const t of Object.values(i))je(t.provider,t.modelKey,t.label,t)&&(e=!0);return e}const a=Me.batchApplied||{},s=a[n]?.models||{},r=new Set([...Object.keys(s),...Object.keys(i)]);let c=!1;for(const t of r){const n=i[t]||null,o=s[t]||null;if(!n&&!o)continue;const a=(n?.provider||o?.provider||"").toLowerCase(),r=(n?.modelKey||o?.modelKey||"").toLowerCase();if(a!==e.GEMINI&&a!==e.OPENAI)continue;if(!r)continue;const u={inputTokens:(n?.inputTokens||0)-(o?.inputTokens||0),outputTokens:(n?.outputTokens||0)-(o?.outputTokens||0),reasoningTokens:(n?.reasoningTokens||0)-(o?.reasoningTokens||0),cachedInputTokens:(n?.cachedInputTokens||0)-(o?.cachedInputTokens||0),cacheStorageTokenHours:(n?.cacheStorageTokenHours||0)-(o?.cacheStorageTokenHours||0),requests:(n?.requests||0)-(o?.requests||0),label:n?.label||o?.label||""};Ue(u)&&je(a,r,u.label,u)&&(c=!0)}return a[n]={ts:Number(t.ts)||o,models:i},Me.batchApplied=$e(a),c}const n=qe(t.inputTokens),o=qe(t.outputTokens),i=qe(t.reasoningTokens),a=qe(t.cachedInputTokens),s=Fe(t.cacheStorageTokenHours);if(!(n+o+i+a>0||s>0))return!1;const r=String(t.provider||"").toLowerCase();if(r!==e.GEMINI&&r!==e.OPENAI)return!1;const c=String(t.model||"").trim();return je(r,(c||"unknown").toLowerCase(),c,{inputTokens:n,outputTokens:o,reasoningTokens:i,cachedInputTokens:a,cacheStorageTokenHours:s,requests:1})}function Ue(e){return 0!==Number(e?.inputTokens||0)||0!==Number(e?.outputTokens||0)||0!==Number(e?.reasoningTokens||0)||0!==Number(e?.cachedInputTokens||0)||0!==Number(e?.cacheStorageTokenHours||0)||0!==Number(e?.requests||0)}function je(e,t,n,o){if(!o)return!1;const i=Number(o.inputTokens||0),a=Number(o.outputTokens||0),s=Number(o.reasoningTokens||0),r=Number(o.cachedInputTokens||0),c=Number(o.cacheStorageTokenHours||0),u=Number(o.requests||0);if(!(i||a||s||r||c||u))return!1;Me.inputTokens=Math.max(0,Me.inputTokens+i),Me.outputTokens=Math.max(0,Me.outputTokens+a),Me.reasoningTokens=Math.max(0,Me.reasoningTokens+s),Me.cachedInputTokens=Math.max(0,Me.cachedInputTokens+r),Me.cacheStorageTokenHours=Math.max(0,Me.cacheStorageTokenHours+c),Me.requests=Math.max(0,Me.requests+u);const l=Me.byProvider[e];l.inputTokens=Math.max(0,l.inputTokens+i),l.outputTokens=Math.max(0,l.outputTokens+a),l.reasoningTokens=Math.max(0,l.reasoningTokens+s),l.cachedInputTokens=Math.max(0,l.cachedInputTokens+r),l.cacheStorageTokenHours=Math.max(0,l.cacheStorageTokenHours+c),l.requests=Math.max(0,l.requests+u);const d=l.models||{},m=d[t]||{label:n,inputTokens:0,outputTokens:0,reasoningTokens:0,cachedInputTokens:0,cacheStorageTokenHours:0,requests:0};return!m.label&&n&&(m.label=n),m.inputTokens=Math.max(0,m.inputTokens+i),m.outputTokens=Math.max(0,m.outputTokens+a),m.reasoningTokens=Math.max(0,m.reasoningTokens+s),m.cachedInputTokens=Math.max(0,m.cachedInputTokens+r),m.cacheStorageTokenHours=Math.max(0,m.cacheStorageTokenHours+c),m.requests=Math.max(0,m.requests+u),d[t]=m,l.models=d,!0}async function Be(){if(Se)return Se;if(we.length){Se=(async()=>{try{const e=we;if(we=[],!e.length)return;await Ke();let t=!1;for(const n of e)Ve(n)&&(t=!0);if(t&&(Oe=le(),xe=!0),await re())return Te.push(...e),De(),be=!0,void(_e=le());await Pe({reset:!0}),be||await Ge();for(const t of e)if(t?.batch&&t?.batchId){const e=Te.findIndex(e=>e?.batch&&e?.batchId===t.batchId);e>=0?Te[e]=t:Te.push(t)}else Te.push(t);De(),_e=le(),await async function(){try{if(await re())return;De(),await C(n.REQUEST_LOG,JSON.stringify(Te.slice(-100)))}catch{}}(),xe&&(await async function(){try{if(await re())return;await C(n.USAGE_TOTALS,JSON.stringify(Me))}catch{}}(),xe=!1)}catch{}})();try{await Se}finally{Se=null}}}async function Ye(){const e=le();we=[],ve&&(clearTimeout(ve),ve=null),Te=[],be=!0,Ne=null,Ae=e,_e=e,await C(n.REQUEST_LOG_CLEAR_AT,String(e)),await L(n.REQUEST_LOG)}const ze=new class{constructor(e=500){this.maxEntries=e,this.map=new Map}get(e){if(!this.map.has(e))return null;const t=this.map.get(e);return t?.expiresAtMs&&t.expiresAtMs<=le()?(this.map.delete(e),null):(this.map.delete(e),this.map.set(e,t),t.value)}set(e,t,n){const o="number"==typeof n&&n>0?le()+n:null;for(this.map.has(e)&&this.map.delete(e),this.map.set(e,{value:t,expiresAtMs:o});this.map.size>this.maxEntries;){const e=this.map.keys().next().value;this.map.delete(e)}}clear(){this.map.clear()}}(800);new Map;const Je=new Map,Xe=(new Map,Symbol("queue_cancelled"));t.concurrencyLimit,t.rpmLimit;let Qe=[];Promise.resolve();const We=new class{constructor(){this._items=[],this._head=0}get length(){return this._items.length-this._head}push(e){this._items.push(e)}shift(){if(this._head>=this._items.length)return;const e=this._items[this._head++];return this._head>1024&&2*this._head>this._items.length&&(this._items=this._items.slice(this._head),this._head=0),e}drain(){const e=this._items.slice(this._head);return this._items=[],this._head=0,e}};let Ze=null,et=null,tt="";function nt(){return function(e){const t=e-6e4;for(;Qe.length&&Qe[0]<=t;)Qe.shift()}(le()),Qe.length}function ot(e){return"string"==typeof e&&e.trim().length>0}function it(e){try{const t=e?.error?.message;return t?String(t):""}catch{return""}}async function at(){ze.clear(),await async function(){const e=le();Ee=e,await C(n.CACHE_CLEAR_AT,String(e));const t=await Ie();for(const e of t||[])e?.key&&await ye(e.key);await L(n.CACHE_INDEX)}()}async function st(e,n,o){const i=de(o,1e3,12e4,t.timeoutMs);if("undefined"==typeof AbortController)return await fetch(e,n);const a=new AbortController,s=setTimeout(()=>a.abort(),i);try{return await fetch(e,{...n,signal:a.signal})}finally{clearTimeout(s)}}async function rt(e){try{return await e.json()}catch{return{}}}Number.POSITIVE_INFINITY,se({active:0,queued:0,rpm:0,ts:le()});const ct="Neurow Add-in";function ut(e){return String(e||"").trim()}function lt(e){const t=String(e||"").trim();if(!t)return"";const n=Date.parse(t);return Number.isFinite(n)?new Date(n).toISOString():""}function dt(e,t){if(!e)return t;if("string"==typeof e.error&&e.error.trim())return e.error.trim();if("string"==typeof e.message&&e.message.trim())return e.message.trim();if(Array.isArray(e.errors)&&e.errors.length){const t=e.errors[0]||{},n=t.detail||t.title||t.message;if(n)return String(n).trim()}return t}async function mt(){return function(e){if(!e||"object"!=typeof e)return null;const t=ut(e.key);return t?{key:t,instanceId:String(e.instanceId||"").trim(),instanceName:String(e.instanceName||ct).trim(),expiresAt:lt(e.expiresAt),valid:!1!==e.valid,activatedAt:String(e.activatedAt||"").trim(),lastCheckedAt:String(e.lastCheckedAt||"").trim()}:null}(await async function(){await O();const e=await M(n.LICENSE);if(!e)return null;try{return JSON.parse(e)}catch{return null}}())}function ft(e){if(!e||!e.key)return!1;if(!1===e.valid)return!1;if(e.expiresAt){const t=Date.parse(e.expiresAt);if(Number.isFinite(t)&&t<=Date.now())return!1}return!0}async function pt(e,t={}){const o=ut(e);if(!o||o.length<5)return{success:!1,error:"Cle trop courte"};const i=await mt();if(!t.force&&i&&i.key===o&&ft(i))return{success:!0,license:i,cached:!0};try{const{ok:e,status:t,data:a}=await async function(e,t){const n=new FormData;Object.entries(t||{}).forEach(([e,t])=>{null!=t&&""!==t&&n.append(e,t)});const o=await fetch(e,{method:"POST",body:n});let i=null;try{i=await o.json()}catch{i=null}return{ok:o.ok,status:o.status,data:i}}("https://api.lemonsqueezy.com/v1/licenses/activate",{license_key:o,instance_name:ct});if(!e)return{success:!1,error:dt(a,`Erreur API (${t})`)};if(a?.activated){const e=function(e,t,n={}){const o=n.instanceId||t?.instance?.id||t?.instance_id||"",i=t?.instance?.name||n.instanceName||ct,a=lt(t?.license_key?.expires_at||n.expiresAt),s=(new Date).toISOString();return{key:e,instanceId:o,instanceName:i,expiresAt:a,valid:!0,activatedAt:n.activatedAt||s,lastCheckedAt:s}}(o,a,{activatedAt:i?.activatedAt});return await async function(e){return e?(await C(n.LICENSE,JSON.stringify(e)),e):(await L(n.LICENSE),null)}(e),{success:!0,license:e}}return{success:!1,error:dt(a,"Cle invalide")}}catch{return{success:!1,error:"Erreur de connexion internet"}}}function gt(e){return document.getElementById(e)}function ht(e,t){const n=fe(e||"");if(gt("statusLine").textContent=n,t)try{const e=pe(t);gt("statusDetails").textContent=JSON.stringify(e,null,2)}catch{gt("statusDetails").textContent=fe(t)}else gt("statusDetails").textContent=""}function Et(e,t={}){const{duration:n=2600}=t,o=gt("statusToast");o&&(o.textContent=e||"",o.classList.add("is-visible"),gn&&(clearTimeout(gn),gn=null),gn=setTimeout(()=>{o.classList.remove("is-visible")},n))}function It(e){const t=Number(e);return Number.isFinite(t)?Math.round(t).toLocaleString("en-US"):"0"}const yt="â‚¬";function kt(e){const t=Number(e);return Number.isFinite(t)?`${yt}${t.toFixed(4)}`:`${yt}0.0000`}function Tt(e){const t=Number(e);return Number.isFinite(t)?`${t.toFixed(2).replace(".",",")}${yt}`:`0,00${yt}`}function Nt(e){const t=Number(e);if(!Number.isFinite(t)||t<=0)return"00c";const n=Math.max(0,Math.round(100*t));return`${String(n).padStart(2,"0")}c`}function bt(t){return String(t||"").toLowerCase()===e.GEMINI}function _t(e){return!!e?.cacheAdjusted||"AI.BATCH"===e?.fn}function At(e){const t=Number(e?.cachedInputTokens||0);return!(!Number.isFinite(t)||t<=0)&&("AI.BATCH"===e?.fn||bt(e?.provider))}function wt(e){const t=Math.max(0,Number(e?.inputTokens||0));if(!At(e))return t;if(_t(e))return t;const n=Math.max(0,Number(e?.cachedInputTokens||0));return Math.max(0,t-n)}function vt(e){return wt(e)+Math.max(0,Number(e?.reasoningTokens||0))+Math.max(0,Number(e?.outputTokens||0))}function St(e){const t=Math.max(0,Number(e?.inputTokens||0)),n=Math.max(0,Number(e?.cachedInputTokens||0));if(_t(e))return{uncachedInputTokens:t,cachedInputTokens:n};const o=Math.min(n,t);return{uncachedInputTokens:Math.max(0,t-o),cachedInputTokens:o}}function Mt(e){const t=Number(e);return Number.isFinite(t)?`${(t/1e3).toFixed(2)}s`:"0.00s"}function Ct(e){try{return new Date(e).toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"})}catch{return"--:--"}}function Lt(e){try{return new Date(e).toLocaleString("fr-FR",{year:"numeric",month:"short",day:"2-digit",hour:"2-digit",minute:"2-digit"})}catch{return""}}function Ot(e){return String(e?.dataset?.section||"").trim()}function xt(e){return"true"===e?.dataset?.sectionLocked}function Pt(e){if(fn||(fn=document.querySelector(".app__main")),!fn)return;const t=document.querySelector(Yt);for(const n of e){const e=dn.get(n);e&&(t?fn.insertBefore(e,t):fn.appendChild(e))}}function Rt(e){dn.forEach((t,n)=>{const o=xt(t),i=e.has(n)&&!o;t.classList.toggle(zt,i)})}function Gt(){let e=!1;for(const t of Array.from(ln)){const n=dn.get(t);n&&!xt(n)||(ln.delete(t),e=!0)}e&&ue(Array.from(ln))}function Dt(e,t={}){const{persist:o=!0}=t;cn=e.slice(),Pt(cn),$t(),o&&async function(e){const t=ce(e);await C(n.SECTION_ORDER,JSON.stringify(t))}(cn)}function qt(e,t={}){const{persist:n=!0}=t;ln=new Set(e),Gt(),Rt(ln),$t(),n&&ue(Array.from(ln)),zn()}function Ft(e,t){const n=cn.indexOf(e);if(n<0)return;const o=n+t;if(o<0||o>=cn.length)return;const i=cn.slice();i.splice(n,1),i.splice(o,0,e),Dt(i)}function Ht(e){e.querySelectorAll(".section-row").forEach(e=>{e.classList.remove("is-drop-before","is-drop-after","is-dragging")})}function $t(){const e=gt("sectionManagerList");if(!e)return;e.innerHTML="";const t=cn.length?cn:Array.from(dn.keys());t.forEach((n,o)=>{const i=dn.get(n);if(!i)return;const a=function(e){const t=e?.dataset?.sectionTitle;if(t)return t;const n=e?.querySelector?.(".card__title");return n?n.textContent.trim():Ot(e)}(i),s=xt(i),r=!ln.has(n)||s,c=document.createElement("div");c.className="section-row",c.dataset.sectionKey=n,c.setAttribute("role","listitem");const u=document.createElement("button");u.type="button",u.className="section-row__handle",u.draggable=!0,u.setAttribute("title","Glisser pour dÃ©placer"),u.setAttribute("aria-label",`DÃ©placer ${a}`);const l=document.createElement("div");l.className="section-row__label",l.textContent=a;const d=document.createElement("div");d.className="section-row__controls";const m=document.createElement("button");m.type="button",m.className="move-btn move-btn--up",m.disabled=0===o,m.setAttribute("title","Monter"),m.setAttribute("aria-label",`Monter ${a}`),m.addEventListener("click",()=>Ft(n,-1));const f=document.createElement("button");f.type="button",f.className="move-btn move-btn--down",f.disabled=o===t.length-1,f.setAttribute("title","Descendre"),f.setAttribute("aria-label",`Descendre ${a}`),f.addEventListener("click",()=>Ft(n,1));const p=document.createElement("label");p.className="visibility-toggle",p.setAttribute("title",s?"Toujours visible":r?"Masquer":"Afficher");const g=document.createElement("input");g.type="checkbox",g.checked=r,g.disabled=s,g.setAttribute("aria-label",s?`${a} toujours visible`:`Afficher ${a}`);const h=document.createElement("span");if(h.className="visibility-toggle__slider",p.appendChild(g),p.appendChild(h),g.addEventListener("change",()=>{s||(g.checked?ln.delete(n):ln.add(n),Rt(ln),ue(Array.from(ln)),$t())}),d.appendChild(m),d.appendChild(f),s){const e=document.createElement("span");e.className="section-row__lock",e.textContent="Fixe",e.setAttribute("title","Toujours visible"),d.appendChild(e)}d.appendChild(p),c.appendChild(u),c.appendChild(l),c.appendChild(d),e.appendChild(c)})}const Kt=[4,8,16,32,64,128],Vt=["auto","minimal","low","medium","high"],Ut=["none","minimal","low","medium","high"],jt="[data-help]",Bt="[data-section]",Yt="[data-section-settings]",zt="is-section-hidden",Jt="[data-key-input]",Xt="[data-key-save]",Qt="[data-license-input]",Wt="[data-license-status]";let Zt={gemini:!1,openai:!1},en=null,tn=null,nn=!1,on=!1,an=!1,sn=!1,rn=!1,cn=[],un=[],ln=new Set,dn=new Map,mn="",fn=null;const pn=new Set;let gn=null,hn=!1,En=[],In=t.rpmLimit;const yn={gemini:t.geminiModel,openai:t.openaiModel},kn={gemini:[{id:"gemini-3-pro-preview",label:"Gemini 3 Pro Preview",prices:{input:2,output:12,cachedInput:.2},costLevel:3,reasoningLevel:3,warning:!0},{id:"gemini-3-flash-preview",label:"Gemini 3 Flash Preview",prices:{input:.5,output:3,cachedInput:.05},costLevel:2,reasoningLevel:2,recommended:!0},{id:"gemini-2.5-flash-lite",label:"Gemini 2.5 Flash Lite",prices:{input:.1,output:.4,cachedInput:.01},costLevel:1,reasoningLevel:1}],openai:[{id:"gpt-5.2",label:"GPT-5.2",prices:{input:1.75,output:14,cachedInput:.175},costLevel:3,reasoningLevel:3,supportsReasoningNone:!0,warning:!0},{id:"gpt-5-mini",label:"GPT-5 Mini",prices:{input:.25,output:2,cachedInput:.025},costLevel:2,reasoningLevel:2,recommended:!0,supportsReasoningNone:!1},{id:"gpt-5-nano",label:"GPT-5 Nano",prices:{input:.05,output:.4,cachedInput:.005},costLevel:1,reasoningLevel:1,supportsReasoningNone:!1}]},Tn={gemini:new Map(kn.gemini.map(e=>[e.id.toLowerCase(),e])),openai:new Map(kn.openai.map(e=>[e.id.toLowerCase(),e]))},Nn={gemini:"Gemini",openai:"OpenAI"};function bn(e,t){const n=Math.max(1,Number(t)||1);return new Array(n+1).join(e)}function _n(e,t){const n=String(e||"").toLowerCase(),o=String(t||"").trim().toLowerCase(),i=Tn[n];if(i&&o&&i.has(o))return i.get(o);const a=yn[n];return i&&a&&i.has(a.toLowerCase())?i.get(a.toLowerCase()):null}function An(e,t){const n=gt("geminiReasoningEffort");if(!n)return"";const o=function(e){const t=String(e||"").trim().toLowerCase();return t.includes("gemini-3")&&t.includes("flash")?["auto","minimal","low","medium","high"]:t.includes("gemini-3")?["auto","low","high"]:t.includes("gemini-2.5")?["auto","minimal","low","medium","high"]:["auto","low","high"]}(e);let i=wn(t,Vt);i||(i=Vt[0]),o.includes(i)||("minimal"===i&&(i="low"),"medium"===i&&(i="high")),i=function(e,t,n){if(!e)return t[0]||"";if(t.includes(e))return e;const o=n.indexOf(e);if(o<0)return t[0]||"";let i=t[0]||"",a=Number.POSITIVE_INFINITY;for(const e of t){const t=n.indexOf(e);if(t<0)continue;const s=Math.abs(t-o);s<a&&(a=s,i=e)}return i}(i,o,Vt);const a=Vt.indexOf(i);return n.value=String(a>=0?a:0),n.setAttribute("aria-valuetext",i),i}function wn(e,t=Ut){const n=String(e||"").trim().toLowerCase();if(!n)return"";const o=Number(n);return Number.isFinite(o)?t[Math.min(t.length-1,Math.max(0,Math.round(o)))]||"":n}function vn(e,t){const n=gt("openaiReasoningEffort");if(!n)return"";const o=function(e){const t=String(e||"").trim().toLowerCase(),n=Tn.openai?.get(t);return!n||"boolean"!=typeof n.supportsReasoningNone||n.supportsReasoningNone}(e),i=n.closest(".reasoning");i&&i.classList.toggle("reasoning--no-none",!o),n.dataset.allowNone=o?"1":"0";const a=o?Ut:Ut.slice(1);let s=wn(t);a.includes(s)||(s=a[0]||"minimal");const r=Ut.indexOf(s);return n.value=String(r>=0?r:0),n.setAttribute("aria-valuetext",s),s}function Sn(e){const t=Number(e);if(!Number.isFinite(t))return`${yt}0`;const n=t>=1?2:3;let o=t.toFixed(n);return o=o.replace(/\.?0+$/,""),`${yt}${o}`}function Mn(e){return{cost:bn("$",e.costLevel),reasoning:bn("ðŸ§ ",e.reasoningLevel)}}function Cn(e){const t=Mn(e),n=e.recommended?"â˜… ":"";return`${e.warning?"! ":""}${n}${e.id} | ${t.cost} | ${t.reasoning}`}function Ln(t,n){const o=t===e.GEMINI,i=gt(o?"geminiModel":"openaiModel"),a=gt(o?"geminiModelWarning":"openaiModelWarning");if(!i||!a)return;const s=_n(t,n||i.value),r=!!s?.warning;a.classList.toggle("is-hidden",!r),i.classList.toggle("input--warning",r)}function On(t){if(!t)return 0;if("AI.BATCH"===t.fn){const n=String(t.provider||"").toLowerCase(),o=_n(n,t.model);if(!o)return 0;const{uncachedInputTokens:i,cachedInputTokens:a}=St(t),s=Math.max(0,Number(t.outputTokens||0)),r=Math.max(0,Number(t.reasoningTokens||0)),c=Math.max(0,Number(t.cacheStorageTokenHours||0)),u=s+r,l=o.prices||{};let d=i/1e6*Number(l.input||0)+a/1e6*Number(l.cachedInput??l.input??0)+u/1e6*Number(l.output||0);return n===e.GEMINI&&c>0&&(d+=c/1e6*1),d}if(t.batch&&Array.isArray(t.batchModels))return t.batchModels.reduce((e,t)=>t?e+On({provider:t.provider,model:t.model,inputTokens:t.inputTokens,outputTokens:t.outputTokens,reasoningTokens:t.reasoningTokens,cachedInputTokens:t.cachedInputTokens,cacheStorageTokenHours:t.cacheStorageTokenHours,cacheAdjusted:!!t.cacheAdjusted}):e,0);const n=String(t.provider||"").toLowerCase(),o=_n(n,t.model);if(!o)return 0;const i=Math.max(0,Number(t.outputTokens||0)),a=Math.max(0,Number(t.reasoningTokens||0)),s=Math.max(0,Number(t.cacheStorageTokenHours||0)),r=i+a,{uncachedInputTokens:c,cachedInputTokens:u}=St(t),l=o.prices||{};let d=c/1e6*Number(l.input||0)+u/1e6*Number(l.cachedInput??l.input??0)+r/1e6*Number(l.output||0);return n===e.GEMINI&&s>0&&(d+=s/1e6*1),d}function xn(e){const t=Number(e);return!Number.isFinite(t)||t<=0?0:Math.floor(t)}function Pn(e){const t=Number(e);return!Number.isFinite(t)||t<=0?0:t}function Rn(e){const t=Array.isArray(e?.batchModels)?e.batchModels.map(e=>({provider:String(e?.provider||"").toLowerCase(),model:String(e?.model||"").trim(),inputTokens:Number(e?.inputTokens||0),outputTokens:Number(e?.outputTokens||0),reasoningTokens:Number(e?.reasoningTokens||0),cachedInputTokens:Number(e?.cachedInputTokens||0),cacheStorageTokenHours:Number(e?.cacheStorageTokenHours||0),requests:Number(e?.requests||0),cacheAdjusted:!!e?.cacheAdjusted})):[],n=e?.batchStats&&"object"==typeof e.batchStats?{totalRequests:Number(e.batchStats.totalRequests||0),ok:Number(e.batchStats.ok||0),error:Number(e.batchStats.error||0),cached:Number(e.batchStats.cached||0),avgMs:Number(e.batchStats.avgMs||0),maxMs:Number(e.batchStats.maxMs||0),minMs:Number(e.batchStats.minMs||0),peakQueued:Number(e.batchStats.peakQueued||0),peakActive:Number(e.batchStats.peakActive||0)}:null;return{provider:e?.provider||"",inputTokens:Number(e?.inputTokens||0),outputTokens:Number(e?.outputTokens||0),reasoningTokens:Number(e?.reasoningTokens||0),cachedInputTokens:Number(e?.cachedInputTokens||0),cacheStorageTokenHours:Number(e?.cacheStorageTokenHours||0),totalTokens:Number(e?.totalTokens||0),ok:!!e?.ok,cache:!!e?.cache,cacheAdjusted:!!e?.cacheAdjusted,ms:Number(e?.ms||0),fn:e?.fn||"AI",model:e?.model||"",ts:Number(e?.ts||0),message:e?.message||"",reasoningEffort:e?.reasoningEffort||"",call:e?.call||"",formula:e?.formula||"",cacheHint:e?.cacheHint||"",batch:!!e?.batch,batchId:String(e?.batchId||""),batchLive:!!e?.batchLive,batchModels:t,batchStats:n}}function Gn(e,t,n){if(!t)return;const o=kn[e]||[],i=String(n||"").trim(),a=i.toLowerCase(),s=yn[e]||"";t.innerHTML="";let r=!1;for(const e of o){const n=document.createElement("option");n.value=e.id,n.textContent=Cn(e),e.warning&&(n.dataset.warning="1",n.style.color="#b03524",n.style.fontWeight="700"),e.id.toLowerCase()===a&&(n.selected=!0,r=!0),t.appendChild(n)}if(i&&!r){const e=document.createElement("option");return e.value=i,e.textContent=`${i} | hors liste`,e.selected=!0,void t.appendChild(e)}!i&&s&&(t.value=s)}function Dn(e,t){const n=gt(e);n&&(n.classList.toggle("is-open",t),n.setAttribute("aria-hidden",t?"false":"true"))}function qn(e){const t=gt(e);return!!t&&t.classList.contains("is-open")}function Fn(e){Dn("settingsModal",e)}function Hn(e){Dn("pricingModal",e)}function $n(e){Dn("onboardingModal",e)}function Kn(e){Dn("onboardingKeysModal",e)}function Vn(){Hn(!1)}function Un(e,t){const n=!!t;document.querySelectorAll(`[data-key-status][data-key-status="${e}"]`).forEach(e=>{e.textContent=n?"ClÃ© enregistrÃ©e":"ClÃ© manquante",e.classList.toggle("key-status--ok",n),e.classList.toggle("key-status--missing",!n)})}function jn(){document.querySelectorAll(Jt).forEach(t=>{const n=String(t.dataset.keyInput||"").trim().toLowerCase();n===e.GEMINI?t.placeholder=Zt.gemini?"ClÃ© enregistrÃ©e (laisser vide pour conserver)":"AIza...":n===e.OPENAI&&(t.placeholder=Zt.openai?"ClÃ© enregistrÃ©e (laisser vide pour conserver)":"sk-...")})}function Bn(){return!!Zt.gemini||!!Zt.openai}function Yn(){return!!Zt.gemini&&!!Zt.openai}function zn(){const e=document.querySelector('[data-section="onboarding"]');if(!e)return;if(!on||!nn||!sn)return;const t=!(en&&en.key&&ft(en)&&(Yn()||an&&Bn()));e.classList.toggle("is-hidden",!t),t&&e.classList.contains(zt)&&(ln.delete("onboarding"),qt(Array.from(ln)))}function Jn(t,n){const o=t===e.GEMINI,i=gt(o?"geminiModel":"openaiModel"),a=gt(o?"geminiReasoningEffort":"openaiReasoningEffort"),s=gt(o?"geminiModelGate":"openaiModelGate"),r=!n;i&&(i.disabled=r),a&&(a.disabled=r),s&&s.classList.toggle("is-hidden",!r)}function Xn(){Jn(e.GEMINI,!!Zt.gemini),Jn(e.OPENAI,!!Zt.openai),function(){const e=gt("providerGemini"),t=gt("providerOpenAI"),n=!!Zt.gemini,o=!!Zt.openai;e&&(e.disabled=!n),t&&(t.disabled=!o);const i=gt("configProviderGate");if(!i)return;const a=gt("configProviderGateText");let s="";n||o||(s="Ajoutez une clÃ© API pour activer Gemini ou OpenAI."),i.classList.toggle("is-hidden",!s),a&&(a.textContent=s)}()}function Qn(e){const t=String(e||"").trim();if(!t)return 0;const n=Date.parse(t);return Number.isFinite(n)?n:0}function Wn(e){const t=Qn(e);return t?function(e){try{return new Date(e).toLocaleDateString("fr-FR",{year:"numeric",month:"short",day:"2-digit"})}catch{return""}}(t):""}function Zn(e,t,n){e&&(e.textContent=t||"",e.title=t||"",e.setAttribute("aria-label",t||""),e.classList.toggle("key-status--ok",n),e.classList.toggle("key-status--missing",!n))}function eo(e,t){document.querySelectorAll(Wt).forEach(n=>{Zn(n,e,t)})}function to(e,t={}){const{focus:n=!1,persist:o=!0}=t,i=gt("licenseEntry"),a=gt("licenseSubscribe");if(!i)return;i.classList.toggle("is-hidden",!e),o&&(tn=e),a&&a.classList.toggle("is-hidden",e);const s=gt("licenseModeSubscribe"),r=gt("licenseModeHave");if(s&&r&&(s.classList.toggle("segmented__btn--active",!e),r.classList.toggle("segmented__btn--active",e),s.setAttribute("aria-selected",e?"false":"true"),r.setAttribute("aria-selected",e?"true":"false")),e&&n){const e=gt("licenseKeyInput");e&&e.focus()}}function no(){const e=gt("setupKeysStep");if(!e)return;const t=Yn();e.classList.toggle("is-hidden",t)}async function oo(e={}){const{silent:t=!1}=e,n=await mt();en=n,on=!0,function(e){const t=function(e){if(!e||!e.key)return{ok:!1,text:"Aucune licence enregistrÃ©e"};if(ft(e)){const t=Wn(e.expiresAt);return{ok:!0,text:"Licence active"+(t?` Â· renouvellement le ${t}`:"")}}const t=Qn(e.expiresAt);return{ok:!1,text:t&&t<=Date.now()?"Licence expirÃ©e":"Licence invalide"}}(e);document.querySelectorAll(Wt).forEach(e=>{Zn(e,t.text,t.ok)})}(n);const o=!(!n||!n.key||ft(n));to(null===tn?o:tn,{persist:!1}),function(e){const t=e?.key?"ClÃ© enregistrÃ©e (laisser vide pour conserver)":"AAAA-BBBB-CCCC-DDDD";document.querySelectorAll(Qt).forEach(e=>{e.placeholder=t})}(n),function(e){const t=document.querySelectorAll("[data-license-meta]");if(!t.length)return;let n="ClÃ© reÃ§ue par email aprÃ¨s achat (mensuel ou annuel)";if(e&&ft(e)&&e.expiresAt){const t=Wn(e.expiresAt);n=t?`Renouvellement le ${t}`:"Licence active"}else if(e&&!ft(e)){const t=Wn(e.expiresAt);n=t?`Licence expirÃ©e le ${t}`:"Licence invalide"}t.forEach(e=>{e.textContent=n})}(n),function(e=en){const t=gt("setupLicenseStep");if(!t)return;const n=!(!e||!ft(e));t.classList.toggle("is-hidden",n)}(n),zn(),!t&&n&&ft(n)&&ht("Licence active",{expiresAt:n.expiresAt||"n/a"})}function io(e){const t=Number(e);return Number.isFinite(t)?Math.min(17,Math.max(7,Math.round(t))):7}function ao(e){const t=2**io(e);return Math.min(t,128e3)}function so(t){const n=t===e.GEMINI;gt("providerGemini").classList.toggle("segmented__btn--active",n),gt("providerOpenAI").classList.toggle("segmented__btn--active",!n),gt("providerGemini").setAttribute("aria-pressed",n?"true":"false"),gt("providerOpenAI").setAttribute("aria-pressed",n?"false":"true"),function(e){const t=gt("configProviderBadge");if(!t)return;const n=Nn[e]||(e?e.toUpperCase():"â€”");t.textContent=n,t.title=`Fournisseur: ${n}`,t.setAttribute("aria-label",`Fournisseur: ${n}`)}(t)}function ro(e){const t=Number(e);return Number.isFinite(t)?Math.max(0,Math.min(Kt.length-1,Math.round(t))):0}function co(e){return Kt[ro(e)]}function uo(){const e=co(ro(gt("concurrencyRange").value));return gt("concurrencyValue").textContent=It(e),e}function lo(e){const n=Number(e);return Number.isFinite(n)?Math.max(0,Math.min(1e5,Math.round(n))):t.rpmLimit}function mo(e){const t="gemini"===e;gt("tabGemini").classList.toggle("tab--active",t),gt("tabOpenAI").classList.toggle("tab--active",!t),gt("tabGemini").setAttribute("aria-selected",t?"true":"false"),gt("tabOpenAI").setAttribute("aria-selected",t?"false":"true"),gt("panelGemini").classList.toggle("tab-panel--active",t),gt("panelOpenAI").classList.toggle("tab-panel--active",!t);const n=gt("settingsProviderName");n&&(n.textContent=t?"Gemini":"OpenAI");const o=gt("settingsProvider");o&&(o.dataset.activeProvider=t?"gemini":"openai")}function fo(e,t,n,o){const i=document.createElement("div");i.className="breakdown__row "+(o?"breakdown__row--sub":"breakdown__row--total");const a=document.createElement("div");if(a.className="breakdown__name",o){const t=document.createElement("span");t.className="breakdown__model",t.textContent=e,a.appendChild(t)}else a.textContent=e;const s=document.createElement("div");s.className="breakdown__tokens",s.textContent=`${It(t)} tokens`;const r=document.createElement("div");return r.className="breakdown__cost",r.textContent=kt(n),i.appendChild(a),i.appendChild(s),i.appendChild(r),i}async function po(){!function(e){const t=gt("queueStatus");if(!t)return;const n=Number(e?.active||0),o=Number(e?.queued||0),i=Math.max(0,n)+Math.max(0,o),a=Number(e?.rpm||0),s=i>0,r=a>0,c=gt("queueStatusMain");c&&c.classList.toggle("is-hidden",!s);const u=gt("rpmStatus");if(u&&u.classList.toggle("is-hidden",!r),!s&&!r)return void t.classList.add("is-hidden");t.classList.remove("is-hidden");const l=gt("queueStatusText");l&&(l.textContent=function(e){const t=Number(e);return!Number.isFinite(t)||t<=0?"":`${It(t)} requete${t>1?"s":""} en cours`}(i));const d=gt("rpmStatusText");d&&(d.textContent=function(e,t){const n=Number(e);if(!Number.isFinite(n)||n<=0)return"";const o=Number(t);return Number.isFinite(o)&&o>0?`RPM ${It(n)}/${It(o)}`:`RPM ${It(n)}`}(a,In));const m=gt("queueStop");m&&m.classList.toggle("is-hidden",o<=0)}(await async function(){const e=await M(n.RUNTIME_STATUS);if(!e)return ae(null);try{return ae(JSON.parse(e))}catch{return ae(null)}}())}async function go(){const t=(await async function(e={}){we.length&&await Be();const t=!!e?.fresh,n=le();return t||!be||n-_e>1500?await Ge(!0):await Ge(!1),Te.slice()}({fresh:!0})).map(Rn).sort((e,t)=>t.ts-e.ts);En=t;const n=await async function(e={}){we.length&&await Be();const t=!!e?.fresh,n=le();return t||!Le||n-Oe>1500?await Ke(!0):await Ke(!1),function(e){try{return JSON.parse(JSON.stringify(e||He()))}catch{return He()}}(Me)}({fresh:!0}),{total:o,breakdown:i}=function(t){const n=t&&"object"==typeof t?t:{},o={gemini:{tokens:0,cost:0,models:new Map},openai:{tokens:0,cost:0,models:new Map}},i={inputTokens:xn(n.inputTokens),reasoningTokens:xn(n.reasoningTokens),outputTokens:xn(n.outputTokens),cachedInputTokens:xn(n.cachedInputTokens),cacheStorageTokenHours:Pn(n.cacheStorageTokenHours),cost:0,requests:xn(n.requests),byProvider:{gemini:{tokens:0,cost:0},openai:{tokens:0,cost:0}}},a={gemini:{input:0,output:0,reasoning:0,cached:0,cacheStorageTokenHours:0},openai:{input:0,output:0,reasoning:0,cached:0,cacheStorageTokenHours:0}};for(const t of[e.GEMINI,e.OPENAI]){const s=n.byProvider&&"object"==typeof n.byProvider?n.byProvider[t]:null,r=xn(s?.inputTokens),c=xn(s?.outputTokens),u=xn(s?.reasoningTokens),l=xn(s?.cachedInputTokens),d=Pn(s?.cacheStorageTokenHours);a[t]={input:r,output:c,reasoning:u,cached:l,cacheStorageTokenHours:d};const m=s?.models&&"object"==typeof s.models?s.models:{};let f=0,p=0,g=0;for(const[n,i]of Object.entries(m)){if(!i||"object"!=typeof i)continue;const a=xn(i.inputTokens),s=xn(i.outputTokens),r=xn(i.reasoningTokens),c=xn(i.cachedInputTokens),u=Pn(i.cacheStorageTokenHours),l=a+s+r;if(l<=0&&c<=0)continue;const d="string"==typeof i.label?i.label:"",m=String(n||"").trim(),h=(d||m).trim(),E=!h||"unknown"===h.toLowerCase(),I=E?"modele inconnu":h,y=On({provider:t,model:E?"":h,inputTokens:a,outputTokens:s,reasoningTokens:r,cachedInputTokens:c,cacheStorageTokenHours:u,cacheAdjusted:t===e.GEMINI}),k=I.toLowerCase(),T=o[t].models.get(k)||{label:I,tokens:0,cost:0};T.tokens+=l,T.cost+=y,o[t].models.set(k,T),f+=l,p+=y,g+=u}if(t===e.GEMINI){const e=Math.max(0,a[t].cacheStorageTokenHours-g);e>0&&(p+=e/1e6*1)}0===f&&(f=r+c+u),o[t].tokens=f,o[t].cost=p,i.byProvider[t].tokens=f,i.byProvider[t].cost=p}return i.inputTokens||(i.inputTokens=a.gemini.input+a.openai.input),i.outputTokens||(i.outputTokens=a.gemini.output+a.openai.output),i.reasoningTokens||(i.reasoningTokens=a.gemini.reasoning+a.openai.reasoning),i.cachedInputTokens||(i.cachedInputTokens=a.gemini.cached+a.openai.cached),i.cacheStorageTokenHours||(i.cacheStorageTokenHours=a.gemini.cacheStorageTokenHours+a.openai.cacheStorageTokenHours),i.cost=i.byProvider.gemini.cost+i.byProvider.openai.cost,{total:i,breakdown:o}}(n);gt("usageTokensTotal").textContent=It(o.inputTokens+o.reasoningTokens+o.outputTokens),gt("usageTokensInTotal").textContent=It(o.inputTokens),gt("usageTokensCacheTotal").textContent=It(o.cachedInputTokens),gt("usageTokensReasoningTotal").textContent=It(o.reasoningTokens),gt("usageTokensOutTotal").textContent=It(o.outputTokens),gt("usageCostTotal").textContent=Tt(o.cost);const a=gt("usageSummary");a&&(a.textContent=Tt(o.cost)),gt("usageCostGemini").textContent=kt(o.byProvider.gemini.cost),gt("usageCostOpenAI").textContent=kt(o.byProvider.openai.cost),function(t){const n=gt("usageBreakdown");if(!n)return;n.innerHTML="";const o=[e.GEMINI,e.OPENAI];for(const e of o){const o=t[e]||{tokens:0,cost:0,models:new Map};n.appendChild(fo(Nn[e]||e,o.tokens,o.cost,!1));const i=Array.from(o.models.values()).filter(e=>(e.tokens||0)>0||(e.cost||0)>0).sort((e,t)=>t.tokens-e.tokens||e.label.localeCompare(t.label));for(const e of i)n.appendChild(fo(e.label,e.tokens,e.cost,!0))}}(i),wo(t),function(e){const t=gt("usageChart");if(!t)return;const n=t.getContext("2d");if(!n)return;const o=t.clientWidth||320,i=t.clientHeight||140,a=window.devicePixelRatio||1;t.width=o*a,t.height=i*a,n.setTransform(a,0,0,a,0,0);const s=Date.now()-36e5,r=new Array(60).fill(0);for(const t of e){if(!t.ts||t.ts<s)continue;const e=Math.floor((t.ts-s)/6e4);e>=0&&e<r.length&&(r[e]+=Math.max(0,vt(t)))}const c=Math.max(...r,1),u=getComputedStyle(document.documentElement).getPropertyValue("--accent-2").trim()||"#2a9d8f";n.clearRect(0,0,o,i),n.strokeStyle="rgba(38, 70, 83, 0.12)",n.lineWidth=1;for(let e=1;e<=3;e++){const t=i/4*e;n.beginPath(),n.moveTo(0,t),n.lineTo(o,t),n.stroke()}n.beginPath(),r.forEach((e,t)=>{const a=t/(r.length-1)*o,s=i-e/c*(i-12)-6;0===t?n.moveTo(a,s):n.lineTo(a,s)});const l=n.createLinearGradient(0,0,0,i);l.addColorStop(0,"rgba(42, 157, 143, 0.35)"),l.addColorStop(1,"rgba(42, 157, 143, 0.02)"),n.lineWidth=2,n.strokeStyle=u,n.stroke(),n.lineTo(o,i),n.lineTo(0,i),n.closePath(),n.fillStyle=l,n.fill()}(t)}function ho(){try{return"undefined"!=typeof document&&document.hidden}catch{return!1}}let Eo=null,Io=null,yo=null;async function ko(e={}){const{force:t=!1}=e;if(t||!ho()){if(Eo)return Eo;Eo=(async()=>{await go()})();try{return await Eo}finally{Eo=null}}}async function To(t={}){const{force:o=!1}=t;if(o||!ho()){if(Io)return Io;Io=(async()=>{await async function(){const t=await async function(){if(await re())return{entries:0,sizeBytes:0,providers:{gemini:{entries:0,sizeBytes:0},openai:{entries:0,sizeBytes:0}},oldestMs:null,newestMs:null};const t=function(e,t=0){const n=le(),o=[],i=[];for(const a of e||[]){if(!a||!a.key)continue;const e=Number(a.savedAtMs||0);t&&(!Number.isFinite(e)||e<=t)||a.expiresAtMs&&a.expiresAtMs<=n?i.push(a.key):o.push(a)}let a=0;for(const e of o)a+=Number(e?.size||0);if(o.length>5e3||a>he){o.sort((e,t)=>(e.savedAtMs||0)-(t.savedAtMs||0));let e=0;for(;o.length-e>5e3||a>he;){const t=o[e];if(!t)break;i.push(t.key),a-=Number(t?.size||0),e+=1}return{list:o.slice(e),removedKeys:i}}return{list:o,removedKeys:i}}(await Ie(),await async function(){const e=ge(await M(n.CACHE_CLEAR_AT));return e>Ee&&(Ee=e),Ee}());if(t.removedKeys.length){for(const e of t.removedKeys)await ye(e);await async function(e){try{await C(n.CACHE_INDEX,JSON.stringify(e))}catch{}}(t.list)}const o={entries:0,sizeBytes:0,providers:{gemini:{entries:0,sizeBytes:0},openai:{entries:0,sizeBytes:0}},oldestMs:null,newestMs:null};for(const n of t.list||[]){if(!n?.key)continue;o.entries+=1,o.sizeBytes+=Number(n.size||0);const t=String(n.provider||"").toLowerCase();t===e.GEMINI?(o.providers.gemini.entries+=1,o.providers.gemini.sizeBytes+=Number(n.size||0)):t===e.OPENAI&&(o.providers.openai.entries+=1,o.providers.openai.sizeBytes+=Number(n.size||0));const i=Number(n.savedAtMs||0);i&&(o.oldestMs=null==o.oldestMs?i:Math.min(o.oldestMs,i),o.newestMs=null==o.newestMs?i:Math.max(o.newestMs,i))}return o}(),o=gt("cacheEntries");o&&(o.textContent=It(t.entries));const i=gt("cacheSize");i&&(i.textContent=function(e){const t=Number(e);return!Number.isFinite(t)||t<=0?"0 KB":t<1024?`${t} B`:t<1048576?`${(t/1024).toFixed(1)} KB`:`${(t/1048576).toFixed(2)} MB`}(t.sizeBytes));const a=gt("cacheGeminiEntries");a&&(a.textContent=It(t.providers.gemini.entries));const s=gt("cacheOpenAIEntries");s&&(s.textContent=It(t.providers.openai.entries))}()})();try{return await Io}finally{Io=null}}}async function No(e={}){const{force:t=!1}=e;if(t||!ho()){if(yo)return yo;yo=(async()=>{await po()})();try{return await yo}finally{yo=null}}}function bo(e){const t=Number(e||0);return t>=8e3?"token-heat--extreme":t>=4e3?"token-heat--hot":t>=1500?"token-heat--warm":"token-heat--cool"}function _o(e){if(e?.batch&&e?.batchId)return`batch:${e.batchId}`;const t=e.call||e.formula||"";return[e.ts||0,e.fn||"",e.provider||"",e.model||"",t].join("|")}function Ao(){const e=gt("logFilterErrors");e&&(e.classList.toggle("is-active",hn),e.setAttribute("aria-pressed",hn?"true":"false"))}function wo(e){const t=gt("logList");t.innerHTML="";const n=function(e){return hn?e.filter(e=>!e.ok):e}(e||[]);if(!n.length){const e=document.createElement("div");return e.className="log-item log-item--empty",e.textContent=hn?"Aucune erreur enregistrÃ©e pour le moment":"Aucune activitÃ© enregistrÃ©e pour le moment",void t.appendChild(e)}const o=(e,t)=>{const n=document.createElement("span");n.className="token-flow";const o=document.createElement("span");o.className="token-flow__icon",o.textContent=e;const i=document.createElement("span");return i.className="token-flow__value",i.textContent=It(t),n.appendChild(o),n.appendChild(i),n},i=n.slice(0,40),a=new Set;for(const e of i){const n=document.createElement("div"),i=e.cache?" log-item--cache":"",s=e.batch?" log-item--batch":"";n.className=`log-item ${e.ok?"log-item--ok":"log-item--error"}${i}${s}`;const r=document.createElement("div");r.className="log-item__top";const c=document.createElement("div");c.className="log-item__title";const u=document.createElement("span");u.className="log-item__title-text",u.textContent=e.fn,c.appendChild(u);const l=String(e.call||e.formula||"").trim();let d=null;if(l){const t=_o(e);a.add(t);const o=document.createElement("button");o.className="log-item__toggle",o.type="button",o.setAttribute("aria-expanded","false"),o.setAttribute("aria-label","Afficher la fonction");const i=document.createElement("span");i.className="log-item__chevron",o.appendChild(i),pn.has(t)&&(n.classList.add("log-item--expanded"),o.setAttribute("aria-expanded","true"),o.setAttribute("aria-label","Masquer la fonction")),o.addEventListener("click",()=>{const e=n.classList.toggle("log-item--expanded");o.setAttribute("aria-expanded",e?"true":"false"),o.setAttribute("aria-label",e?"Masquer la fonction":"Afficher la fonction"),e?pn.add(t):pn.delete(t)}),c.appendChild(o),d=document.createElement("div"),d.className="log-item__detail",d.textContent=l}const m=document.createElement("div");m.style.display="flex",m.style.gap="6px";const f=document.createElement("span");f.className="tag",f.textContent=e.batch?"BATCH":e.provider?e.provider.toUpperCase():"â€”",m.appendChild(f);const p=document.createElement("span");p.className="tag "+(e.ok?"":"tag--error"),p.textContent=e.ok?"OK":"Erreur",m.appendChild(p);const g=document.createElement("span");if(g.className="tag tag--cost",e.batch?(g.textContent=kt(On(e)),g.title="CoÃ»t estimÃ© (EUR)"):(g.textContent=Nt(On(e)),g.title="CoÃ»t estimÃ© (centimes)"),m.appendChild(g),e.batch){const e=document.createElement("span");e.className="tag tag--cache",e.textContent="Lot",m.appendChild(e)}else if(e.cache){const e=document.createElement("span");e.className="tag tag--cache",e.textContent="Cache",m.appendChild(e)}if(bt(e.provider)&&("gemini_cached_content"===e.cacheHint||Number(e.cachedInputTokens||0)>0)){const e=document.createElement("span");e.className="tag tag--cache",e.textContent="Cache Gemini",m.appendChild(e)}r.appendChild(c),r.appendChild(m);const h=document.createElement("div");h.className="log-item__meta";const E=Math.max(0,vt(e)),I=e.batch?"":e.model?e.model:"",y=e.reasoningEffort?e.reasoningEffort:"",k=Mt(e.ms),T=[I,y].filter(Boolean).join(" Â· "),N=document.createElement("div");N.className="log-item__info";const b=`${Ct(e.ts)} Â· ${k}`,_=T?` Â· ${T}`:"";if(e.batch&&e.batchStats){const t=e.batchStats,n=[`Lot ${It(t.totalRequests)} req`,`OK ${It(t.ok)}`,`Err ${It(t.error)}`];t.cached&&n.push(`Cache ${It(t.cached)}`),t.avgMs&&n.push(`Moy ${Mt(t.avgMs)}`),t.peakQueued&&n.push(`Pic file ${It(t.peakQueued)}`),t.peakActive&&n.push(`Pic actif ${It(t.peakActive)}`),N.textContent=`${b}${_} Â· ${n.join(" Â· ")}`}else!e.ok&&e.message?N.textContent=`${b}${_} Â· ${e.message.slice(0,60)}`:N.textContent=`${b}${_}`;if(e.cache){const e=document.createElement("div");e.className="log-item__cache",e.textContent="Cache local",h.appendChild(e)}else{const t=document.createElement("div");t.className="log-item__tokens";const n=document.createElement("div");n.className="log-item__tokens-line";const i=document.createElement("span");i.className=`log-item__heat ${bo(E)}`;const a=document.createElement("span");a.className="log-item__tokens-total",a.textContent=`${It(E)} tokens`;const s=document.createElement("span");s.className="log-item__tokens-detail",s.appendChild(document.createTextNode("(")),s.appendChild(o("IN",wt(e))),s.appendChild(document.createTextNode(" / ")),s.appendChild(o("REF",e.reasoningTokens)),s.appendChild(document.createTextNode(" / ")),s.appendChild(o("OUT",e.outputTokens)),At(e)&&(s.appendChild(document.createTextNode(" / ")),s.appendChild(o("CACHE",e.cachedInputTokens))),s.appendChild(document.createTextNode(")")),n.appendChild(i),n.appendChild(a),n.appendChild(s),t.appendChild(n),h.appendChild(t)}h.appendChild(N),n.appendChild(r),d&&n.appendChild(d),n.appendChild(h),t.appendChild(n)}pn.forEach(e=>{a.has(e)||pn.delete(e)})}function vo(e){rn=!!e;const t=gt("privacyModeToggle");t&&(t.checked=rn);const n=gt("privacyModeStatus");n&&(n.textContent=rn?"ActivÃ©":"DÃ©sactivÃ©",n.classList.toggle("is-active",rn));const o=gt("privacyModeHint");o&&(o.textContent=rn?"Journal et cache persistants dÃ©sactivÃ©s.":"Journal et cache persistants activÃ©s.");const i=gt("cacheStatus");i&&(i.textContent=rn?"DÃ©sactivÃ©":"Actif",i.classList.toggle("chip--success",!rn),i.classList.toggle("chip--muted",rn))}async function So(){vo(await re())}function Mo(e){const t=String(e||"").trim();if(!t)return 0;const n=Date.parse(t);return Number.isFinite(n)?n:0}function Co(e){const t=String(e?.name||"").trim(),n=String(e?.displayName||e?.display_name||"").trim(),o=String(e?.model||"").trim(),i=function(e){if(!e||"object"!=typeof e)return 0;const t=[e.cachedContentTokenCount,e.cached_content_token_count,e.totalTokenCount,e.total_token_count,e.promptTokenCount,e.prompt_token_count];for(const e of t){const t=Number(e);if(Number.isFinite(t)&&t>0)return Math.floor(t)}return 0}(e?.usageMetadata||e?.usage_metadata||null),a=Mo(e?.createTime||e?.create_time),s=Mo(e?.updateTime||e?.update_time),r=Mo(e?.expireTime||e?.expire_time),c=document.createElement("div");c.className="explicit-cache__item";const u=document.createElement("div");u.className="explicit-cache__main";const l=document.createElement("div");l.className="explicit-cache__title",l.textContent=n||(t?"Cache Gemini":"Cache");const d=document.createElement("div");d.className="explicit-cache__meta";const m=[];o&&m.push(o.replace("models/","")),i>0&&m.push(`${It(i)} tokens`),a&&m.push(`CrÃ©Ã© ${Lt(a)}`),r&&m.push(`Expire ${Lt(r)}`),!r&&s&&m.push(`MAJ ${Lt(s)}`),d.textContent=m.join(" Â· ");const f=document.createElement("div");f.className="explicit-cache__name",f.textContent=t,u.appendChild(l),m.length&&u.appendChild(d),t&&u.appendChild(f);const p=document.createElement("div");p.className="explicit-cache__actions";const g=document.createElement("button");return g.className="explicit-cache__delete",g.type="button",g.textContent="Supprimer",g.dataset.cacheName=t,p.appendChild(g),c.appendChild(u),c.appendChild(p),c}let Lo=null;function Oo(e,t={}){const{forceShow:n=!1}=t,o=document.querySelector('[data-section="gemini-explicit"]');if(!o)return;const i=!n&&!e;o.classList.toggle("is-hidden",i)}async function xo(t={}){const{force:n=!1}=t;if(n||!ho()){if(Lo)return Lo;Lo=(async()=>{await async function(){const t=gt("geminiExplicitList"),n=gt("geminiExplicitEmpty"),o=gt("geminiExplicitSummary");if(!t||!n||!o)return;t.innerHTML="",n.textContent="Chargement...",n.classList.remove("is-hidden"),o.textContent="0 cache";const i=await async function(t={}){const n=await H(e.GEMINI);if(!n)return{ok:!1,code:"API_KEY_MISSING",message:"ClÃ© API manquante pour Gemini."};const o=de(t?.pageSize??50,1,100,50),i=de(t?.maxPages??3,1,5,3),a=!!t?.all;let s=ot(t?.pageToken)?String(t.pageToken):"",r=0;const c=[];for(;r<i;){r+=1;const e=new URL("https://generativelanguage.googleapis.com/v1beta/cachedContents");e.searchParams.set("pageSize",String(o)),s&&e.searchParams.set("pageToken",s);const t=await st(e.toString(),{method:"GET",headers:{"Content-Type":"application/json","x-goog-api-key":n}},3e4),i=await rt(t);if(!t.ok){const e=it(i)||`Gemini API error (${t.status}).`;return{ok:!1,status:t.status,code:"API_ERROR",message:fe(e)}}const u=Array.isArray(i?.cachedContents)?i.cachedContents:Array.isArray(i?.cachedContent)?i.cachedContent:[];if(c.push(...u),s=ot(i?.nextPageToken)?String(i.nextPageToken):"",!a||!s)break}return{ok:!0,caches:c,nextPageToken:s||"",pages:r}}({pageSize:50,all:!0,maxPages:3});if(!i.ok)return n.textContent=i.message||"Impossible de rÃ©cupÃ©rer les caches Gemini.",void Oo(!0,{forceShow:!0});const a=Array.isArray(i.caches)?i.caches:[];if(o.textContent=`${It(a.length)} cache${a.length>1?"s":""}`,!a.length)return n.textContent="Aucun cache explicite actif.",void Oo(!1);n.classList.add("is-hidden"),Oo(!0);for(const e of a)t.appendChild(Co(e));t.querySelectorAll(".explicit-cache__delete").forEach(t=>{t.addEventListener("click",async()=>{const n=t.dataset.cacheName||"";if(!n)return;t.disabled=!0;const o=await async function(t){const n=await H(e.GEMINI);if(!n)return{ok:!1,code:"API_KEY_MISSING",message:"ClÃ© API manquante pour Gemini."};const o=String(t||"").trim();if(!o)return{ok:!1,code:"INVALID_NAME",message:"Nom de cache invalide."};const i=`https://generativelanguage.googleapis.com/v1beta/${encodeURI(o)}`,a=await st(i,{method:"DELETE",headers:{"Content-Type":"application/json","x-goog-api-key":n}},3e4),s=await rt(a);if(!a.ok){const e=it(s)||`Gemini API error (${a.status}).`;return{ok:!1,status:a.status,code:"API_ERROR",message:fe(e)}}for(const[e,t]of Je.entries())t?.name&&t.name===o&&Je.delete(e);return{ok:!0}}(n);o.ok?Et("Cache supprimÃ©"):Et(o.message||"Suppression impossible."),await xo({force:!0})})})}()})();try{return await Lo}finally{Lo=null}}}async function Po(o={}){const{silent:i=!1,message:a="Configuration enregistrÃ©e"}=o,s=gt("providerGemini").classList.contains("segmented__btn--active")?e.GEMINI:e.OPENAI,r=ao(io(gt("maxTokensRange").value)),c=await async function(e){const o=x(e)||t.provider;return await C(n.DEFAULT_PROVIDER,o),l=o,d=le(),o}(s),u=await J(r);return i||ht(a,{defaultProvider:c,maxOutputTokens:u}),{savedProvider:c,savedTokens:u}}function Ro(e={}){const{focusKey:t=!1}=e,n=document.querySelector('[data-section="onboarding"]');if(n){if(n.classList.remove("is-hidden"),n.classList.contains(zt)&&(ln.delete("onboarding"),qt(Array.from(ln))),n.classList.contains("is-collapsed")){n.classList.remove("is-collapsed");const e=n.querySelector("[data-collapse-toggle]");e&&e.setAttribute("aria-expanded","true")}if("function"==typeof n.scrollIntoView&&n.scrollIntoView({behavior:"smooth",block:"start"}),t){const e=n.querySelector(Jt);e&&e.focus()}}}function Go(){document.querySelectorAll(jt).forEach(e=>{e.classList.remove("is-open");const t=e.querySelector("button");t&&t.setAttribute("aria-expanded","false")})}async function Do(e={}){const{silent:t=!1}=e;return Bn()?(an=!0,sn=!0,await ie(!0),zn(),!0):(t||ht("Ajoutez au moins une clÃ© API avant de valider",{ok:!1}),!1)}async function qo(t,n){const o=(n||"").trim();return!!o&&(await async function(t,n){const o=(n||"").trim(),i=x(t)===e.OPENAI?e.OPENAI:e.GEMINI;return await C(F(i),o),I[i]=o,y[i]=le(),o}(t,o),Zt[t]=!0,nn=!0,jn(),Xn(),no(),zn(),!0)}async function Fo(e,t){const n=await qo(e,t?.value||"");n&&(t&&(t.value=""),Un(e,n),ht("ClÃ© enregistrÃ©e",{provider:e}))}async function Ho(n){const o=n===e.GEMINI,i=gt(o?"geminiModel":"openaiModel");if(!i)return;const a=(i.value||"").trim();await async function(n,o){const i=x(n)===e.OPENAI?e.OPENAI:e.GEMINI,a=String(o||"").trim();if(!a){const n=i===e.OPENAI?t.openaiModel:t.geminiModel;return await C(K(i),n),k[i]=n,void(T[i]=le())}await C(K(i),a),k[i]=a,T[i]=le()}(n,a);let s="";if(o){const e=gt("geminiReasoningEffort");s=An(a,e?e.value:""),s&&await Y(s)}else{const e=gt("openaiReasoningEffort");s=vn(a,e?e.value:""),s&&await B(s)}ht("Configuration enregistrÃ©e",{provider:n,model:a,reasoningEffort:s||void 0}),Ln(n,a)}function $o(e,t){e&&e.classList.toggle("input--warning",t)}async function Ko(e,t){const n=(e?.value||"").trim();if($o(e,!1),!n)return $o(e,!0),eo("Entrez votre clÃ© de licence",!1),void ht("ClÃ© de licence manquante",{ok:!1});const o=t?.textContent||"";t&&(t.disabled=!0,t.textContent="Activation...");const i=await pt(n);if(t&&(t.disabled=!1,t.textContent=o),i.success)return e&&(e.value=""),await oo({silent:!0}),ht("Licence activÃ©e",{expiresAt:i.license?.expiresAt||"n/a"}),void Et("Licence enregistrÃ©e");const a=i.error||"ClÃ© invalide";$o(e,!0),eo(a,!1),ht("Ã‰chec de l'activation",{error:a})}async function Vo(e=!0){e&&await async function(e=!0){return await C(n.ONBOARDING_SEEN,e?"1":"0"),e}(!0),Kn(!1),$n(!1)}async function Uo(){document.querySelectorAll("[data-collapse-toggle]").forEach(e=>{const t=e.getAttribute("aria-controls"),n=e.closest("[data-collapsible]");if(!t||!n)return;if(!document.getElementById(t))return;const o=n.classList.contains("is-collapsed");e.setAttribute("aria-expanded",o?"false":"true"),e.addEventListener("click",()=>{const t=!n.classList.contains("is-collapsed");n.classList.toggle("is-collapsed",t),e.setAttribute("aria-expanded",t?"false":"true")})}),function(){let e=!1;const t=()=>{e||(e=!0,setTimeout(async()=>{e=!1,await ko(),await To(),await No(),await So(),await oo({silent:!0})},250))};try{if("undefined"!=typeof OfficeRuntime&&OfficeRuntime?.storage?.onChanged){const e=OfficeRuntime.storage.onChanged;"function"==typeof e.add?e.add(()=>t()):"function"==typeof e.addListener?e.addListener(()=>t()):"function"==typeof e&&e(()=>t())}}catch{}try{window.addEventListener("storage",()=>t())}catch{}}(),document.querySelectorAll(jt).forEach(e=>{const t=e.querySelector("button");t&&(t.setAttribute("aria-expanded","false"),t.addEventListener("click",n=>{n.stopPropagation();const o=e.classList.contains("is-open");Go();const i=!o;e.classList.toggle("is-open",i),t.setAttribute("aria-expanded",i?"true":"false")}))}),document.addEventListener("click",e=>{e.target.closest(jt)||Go()}),await async function(){if(fn=document.querySelector(".app__main"),!fn)return;const e=Array.from(fn.querySelectorAll(Bt));dn=new Map,e.forEach(e=>{const t=Ot(e);t&&dn.set(t,e)});const t=await async function(){await O();const e=await M(n.SECTION_ORDER);if(!e)return[];try{return ce(JSON.parse(e))}catch{return[]}}(),o=e.map(e=>Ot(e)).filter(Boolean);un=o.slice(),cn=function(e,t){const n=[],o=new Set;if(Array.isArray(e))for(const t of e)t&&!o.has(t)&&dn.has(t)&&(o.add(t),n.push(t));for(const e of t)e&&!o.has(e)&&(o.add(e),n.push(e));return n}(t,o),Pt(cn),ln=new Set(await async function(){await O();const e=await M(n.SECTION_HIDDEN);if(!e)return[];try{return ce(JSON.parse(e))}catch{return[]}}()),Gt(),Rt(ln),$t(),function(){const e=gt("sectionManagerList");e&&(e.addEventListener("dragstart",e=>{const t=e.target.closest(".section-row__handle");if(!t)return;const n=t.closest(".section-row");n&&(mn=n.dataset.sectionKey||"",n.classList.add("is-dragging"),e.dataTransfer&&(e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",mn)))}),e.addEventListener("dragover",t=>{if(!mn)return;t.preventDefault();const n=t.target.closest(".section-row");if(!n||n.dataset.sectionKey===mn)return;!function(e){e.querySelectorAll(".section-row").forEach(e=>{e.classList.remove("is-drop-before","is-drop-after")})}(e);const o=n.getBoundingClientRect(),i=t.clientY<o.top+o.height/2;n.classList.toggle("is-drop-before",i),n.classList.toggle("is-drop-after",!i)}),e.addEventListener("dragleave",e=>{const t=e.target.closest(".section-row");t&&t.classList.remove("is-drop-before","is-drop-after")}),e.addEventListener("drop",t=>{if(!mn)return;t.preventDefault();const n=t.target.closest(".section-row"),o=n&&n.dataset.sectionKey||"",i=mn;mn="",Ht(e);let a=cn.slice();if(o){const e=n.getBoundingClientRect();a=function(e,t,n,o){const i=e.filter(e=>e!==t),a=i.indexOf(n);if(a<0)return i.push(t),i;const s=o?a:a+1;return i.splice(s,0,t),i}(a,i,o,t.clientY<e.top+e.height/2)}else a=function(e,t){const n=e.filter(e=>e!==t);return n.push(t),n}(a,i);Dt(a)}),e.addEventListener("dragend",()=>{mn="",Ht(e)}))}()}(),await async function(){const e=gt("privacyModeToggle");e&&(await So(),e.addEventListener("change",async()=>{const t=!!e.checked;await async function(e=!1){const t=!!e;return r=t,c=le(),await C(n.PRIVACY_MODE,t?"1":"0"),t}(t),vo(t),t&&(await Ye(),await at()),await ko({force:!0}),await To({force:!0}),ht(t?"Mode confidentialitÃ© activÃ©":"Mode confidentialitÃ© dÃ©sactivÃ©",{privacyMode:t})}))}();const o=gt("settingsButton");o&&o.addEventListener("click",()=>Fn(!0)),document.querySelectorAll("[data-settings-open]").forEach(e=>{e.addEventListener("click",()=>Fn(!0))}),document.querySelectorAll("[data-settings-close]").forEach(e=>{e.addEventListener("click",()=>Fn(!1))});const i=gt("sectionManagerReset");i&&i.addEventListener("click",()=>{un.length&&Dt(un)});const a=gt("pricingHelp");a&&a.addEventListener("click",()=>(function(){const t=gt("pricingTableBodyGemini"),n=gt("pricingTableBodyOpenAI");if(!t&&!n)return;t&&(t.innerHTML=""),n&&(n.innerHTML="");const o=(e,t)=>{if(!t)return;const n=kn[e]||[];for(const e of n){const n=document.createElement("tr"),o=Mn(e),i=document.createElement("td");i.textContent=e.id;const a=document.createElement("td");a.className="pricing-table__col-price",a.textContent=Sn(e.prices?.input);const s=document.createElement("td");s.className="pricing-table__col-price",s.textContent=Sn(e.prices?.output);const r=document.createElement("td");r.className="pricing-table__col-icon",r.textContent=o.cost;const c=document.createElement("td");c.className="pricing-table__col-icon",c.textContent=o.reasoning,n.appendChild(i),n.appendChild(a),n.appendChild(s),n.appendChild(r),n.appendChild(c),t.appendChild(n)}};o(e.GEMINI,t),o(e.OPENAI,n)}(),void Hn(!0))),document.querySelectorAll("[data-modal-close]").forEach(e=>{e.addEventListener("click",()=>Vn())}),document.querySelectorAll("[data-onboarding-close]").forEach(e=>{e.addEventListener("click",async()=>Vo(!0))}),document.querySelectorAll("[data-onboarding-keys-close]").forEach(e=>{e.addEventListener("click",()=>Kn(!1))});const s=gt("onboardingClose");s&&s.addEventListener("click",async()=>Vo(!0));const u=gt("onboardingDone");u&&u.addEventListener("click",async()=>Vo(!0));const l=gt("onboardingKeysButton");l&&l.addEventListener("click",async()=>{await Vo(!0),Ro({focusKey:!0})}),document.querySelectorAll("[data-onboarding-open]").forEach(e=>{e.addEventListener("click",()=>{Fn(!1),Ro({focusKey:!0})})});const d=gt("onboardingKeysSave");d&&d.addEventListener("click",async()=>async function(){const t=gt("onboardingGeminiKey"),n=gt("onboardingOpenAIKey"),o=await qo(e.GEMINI,t?.value||""),i=await qo(e.OPENAI,n?.value||"");t&&(t.value=""),n&&(n.value=""),Un(e.GEMINI,Zt.gemini),Un(e.OPENAI,Zt.openai),(o||i)&&ht("ClÃ©s enregistrÃ©es",{gemini:!!o,openai:!!i}),(Zt.gemini||Zt.openai)&&(await Do({silent:!0}),Kn(!1))}());const m=gt("onboardingKeysLater");m&&m.addEventListener("click",()=>Kn(!1)),document.addEventListener("keydown",async e=>{"Escape"===e.key&&(Go(),qn("onboardingKeysModal")?Kn(!1):qn("onboardingModal")?await Vo(!0):qn("settingsModal")?Fn(!1):qn("pricingModal")&&Vn())}),gt("tabGemini").addEventListener("click",()=>mo("gemini")),gt("tabOpenAI").addEventListener("click",()=>mo("openai")),gt("providerGemini").addEventListener("click",async()=>{so(e.GEMINI),await Po()}),gt("providerOpenAI").addEventListener("click",async()=>{so(e.OPENAI),await Po()}),gt("maxTokensRange").addEventListener("input",()=>{!function(){const e=ao(io(gt("maxTokensRange").value));gt("maxTokensValue").textContent=It(e)}()}),gt("maxTokensRange").addEventListener("change",async()=>{await Po()}),gt("concurrencyRange").addEventListener("input",()=>{uo()}),gt("concurrencyRange").addEventListener("change",async()=>{await async function(e={}){const{silent:t=!1,message:n="Concurrence enregistrÃ©e"}=e,o=uo(),i=await Z(o);return t||ht(n,{concurrency:i}),i}()});const f=gt("rpmLimitInput");f&&f.addEventListener("change",async()=>{await async function(e={}){const{silent:n=!1,message:o="Limite RPM enregistrÃ©e"}=e,i=function(){const e=gt("rpmLimitInput");if(!e)return t.rpmLimit;const n=lo(e.value);return e.value=String(n),n}(),a=await ne(i);return In=a,n||ht(o,{rpmLimit:a}),a}()});const p=gt("geminiReasoningEffort");p&&(p.addEventListener("input",()=>{const e=gt("geminiModel");An(e?e.value:"",p.value)}),p.addEventListener("change",async()=>{await async function(){const e=gt("geminiModel"),t=gt("geminiReasoningEffort");if(!t)return;const n=An(e?e.value:"",t.value);n&&await Y(n),ht("Effort de raisonnement enregistrÃ©",{geminiReasoningEffort:n})}()}));const g=gt("openaiReasoningEffort");g&&(g.addEventListener("input",()=>{const e="0"!==g.dataset.allowNone;let t=wn(g.value);e||"none"!==t||(g.value="1",t=wn(g.value)),g.setAttribute("aria-valuetext",t)}),g.addEventListener("change",async()=>{await async function(){const e=gt("openaiModel"),t=gt("openaiReasoningEffort");if(!t)return;const n=vn(e?e.value:"",t.value);n&&await B(n),ht("Effort de raisonnement enregistrÃ©",{openaiReasoningEffort:n})}()}));const h=gt("geminiModel");h&&h.addEventListener("change",async()=>{await Ho(e.GEMINI)});const E=gt("openaiModel");E&&E.addEventListener("change",async()=>{await Ho(e.OPENAI)}),document.querySelectorAll(Jt).forEach(e=>{const t=String(e.dataset.keyInput||"").trim().toLowerCase();t&&(e.addEventListener("input",()=>$o(e,!1)),e.addEventListener("change",async()=>{await Fo(t,e)}),e.addEventListener("keydown",n=>{if("Enter"!==n.key)return;n.preventDefault();const o=e.closest(".input-action")?.querySelector(Xt);o?o.click():Fo(t,e)}))}),document.querySelectorAll(Xt).forEach(e=>{const t=String(e.dataset.keySave||"").trim().toLowerCase();t&&e.addEventListener("click",async()=>{const n=e.closest(".input-action")?.querySelector(Jt);await Fo(t,n),"true"===e.dataset.keyConfirm&&await Do()})});const I=gt("licenseModeSubscribe"),y=gt("licenseModeHave");I&&I.addEventListener("click",()=>to(!1)),y&&y.addEventListener("click",()=>to(!0,{focus:!0})),document.querySelectorAll(Qt).forEach(e=>{e.addEventListener("input",()=>$o(e,!1)),e.addEventListener("keydown",t=>{if("Enter"!==t.key)return;t.preventDefault();const n=document.querySelector(`[data-license-activate][data-license-target="${e.id}"]`)||e.closest(".input-action, .setup-license__row")?.querySelector("[data-license-activate]");n&&Ko(e,n)})}),document.querySelectorAll("[data-license-activate]").forEach(e=>{e.addEventListener("click",async()=>{const t=e.dataset.licenseTarget,n=(t?gt(t):null)||e.closest(".input-action, .setup-license__row")?.querySelector(Qt);await Ko(n,e)})});const k=gt("clearUsageTotals");k&&k.addEventListener("click",async()=>{await async function(){Me=He(),Le=!0,Ce=null,Oe=le(),xe=!1,await L(n.USAGE_TOTALS)}(),await ko({force:!0}),ht("Utilisation rÃ©initialisÃ©e",{ok:!0})});const T=gt("logFilterErrors");T&&T.addEventListener("click",()=>{hn=!hn,Ao(),wo(En)}),Ao(),gt("clearLogs").addEventListener("click",async()=>{await Ye(),await ko({force:!0}),ht("Journal effacÃ©",{ok:!0})}),gt("clearCache").addEventListener("click",async()=>{await at(),await To({force:!0}),ht("Cache vidÃ©",{ok:!0})});const N=gt("queueStop");N&&N.addEventListener("click",async()=>{!function(){if(!We.length)return 0;const e=We.drain();for(const t of e)t(Xe);(function(){const e={active:0,queued:We.length,rpm:nt()};et=e,Ze||(Ze=setTimeout(()=>{Ze=null;const e=et;if(et=null,!e)return;const t=`${e.active}:${e.queued}:${e.rpm}`;t!==tt&&(tt=t,se({...e,ts:le()}))},120))})(),e.length}(),await No({force:!0})}),mo("gemini"),await async function(t={}){const{preserveKeyInputs:n=!1,silent:o=!1}=t;gt("storageBackend").textContent=_().kind;const[i,a,s,r,c,u,l,d,m,f,p]=await Promise.all([q(),z(),W(),te(),V(e.GEMINI),V(e.OPENAI),$(e.GEMINI),$(e.OPENAI),U(),j(),oe()]);so(i);const g=function(e){const t=Number(e);return!Number.isFinite(t)||t<=0?7:io(Math.log2(t))}(a),h=ao(g);gt("maxTokensRange").value=String(g),gt("maxTokensValue").textContent=It(h),h!==a&&await J(h);const E=function(e){const t=Number(e);if(!Number.isFinite(t))return 0;let n=0,o=Math.abs(Kt[0]-t);for(let e=1;e<Kt.length;e+=1){const i=Math.abs(Kt[e]-t);i<o&&(o=i,n=e)}return n}(s),I=co(E);gt("concurrencyRange").value=String(E),gt("concurrencyValue").textContent=It(I),I!==s&&await Z(I);const y=lo(r);In=y;const k=gt("rpmLimitInput");k&&(k.value=String(y),y!==r&&await ne(y));const T=gt("geminiModel"),N=gt("openaiModel");Gn(e.GEMINI,T,c),Gn(e.OPENAI,N,u);const b=T?T.value:c,A=N?N.value:u,w=An(b,m);w&&w!==m&&await Y(w);const v=vn(A,f),S=v||f;v&&v!==f&&await B(v),Ln(e.GEMINI,b),Ln(e.OPENAI,A),n||document.querySelectorAll(Jt).forEach(e=>{e.value=""}),Zt={gemini:!!l,openai:!!d},jn(),an=!!p,sn=!0,l||d||!p||(an=!1,await ie(!1)),nn=!0,Un(e.GEMINI,l),Un(e.OPENAI,d),Xn(),no(),zn(),o||ht("Configuration chargÃ©e",{defaultProvider:i,maxOutputTokens:h,gemini:{key:l?"set":"missing",model:c,reasoningEffort:w},openai:{key:d?"set":"missing",model:u,reasoningEffort:S}})}(),await oo({silent:!0}),await ko({force:!0}),await To({force:!0}),await xo({force:!0}),await No({force:!0}),await async function(){await async function(){return await O(),"1"===await M(n.ONBOARDING_SEEN)}()||$n(!0)}(),document.addEventListener("visibilitychange",()=>{ho()||(ko(),To(),xo(),No())}),setInterval(()=>{ko()},2e3),setInterval(()=>{To()},12e3),setInterval(()=>{xo()},15e3),setInterval(()=>{No()},1e3)}document.addEventListener("DOMContentLoaded",async()=>{await async function(){try{"undefined"!=typeof Office&&Office?.onReady&&await Office.onReady()}catch{}}(),await Uo()})})();
//# sourceMappingURL=taskpane.js.map