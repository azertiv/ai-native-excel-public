(()=>{"use strict";const e=Object.freeze({GEMINI:"gemini",OPENAI:"openai"}),t=Object.freeze({provider:e.GEMINI,geminiModel:"gemini-3-flash-preview",openaiModel:"gpt-5-mini",geminiReasoningEffort:"minimal",openaiReasoningEffort:"low",maxOutputTokens:4096,concurrencyLimit:4,retry:2,timeoutMs:12e4,cache:!0,cacheTtlSec:604800,webCacheTtlSec:3600}),n=Object.freeze({DEFAULT_PROVIDER:"AI_DEFAULT_PROVIDER_V3",GEMINI_API_KEY:"AI_GEMINI_API_KEY_V3",OPENAI_API_KEY:"AI_OPENAI_API_KEY_V3",GEMINI_MODEL:"AI_GEMINI_MODEL_V3",OPENAI_MODEL:"AI_OPENAI_MODEL_V3",GEMINI_REASONING_EFFORT:"AI_GEMINI_REASONING_EFFORT_V3",OPENAI_REASONING_EFFORT:"AI_OPENAI_REASONING_EFFORT_V3",MAX_OUTPUT_TOKENS:"AI_MAX_OUTPUT_TOKENS_V3",CONCURRENCY_LIMIT:"AI_CONCURRENCY_LIMIT_V1",ONBOARDING_SEEN:"AI_ONBOARDING_SEEN_V1",ONBOARDING_KEYS_CONFIRMED:"AI_ONBOARDING_KEYS_CONFIRMED_V1",SECTION_ORDER:"AI_SECTION_ORDER_V1",SECTION_HIDDEN:"AI_SECTION_HIDDEN_V1",LICENSE:"AI_LICENSE_V1",PRIVACY_MODE:"AI_PRIVACY_MODE_V1",MIGRATION_DONE:"AI_MIGRATION_DONE_V3",REQUEST_LOG:"AI_REQUEST_LOG_V1",REQUEST_LOG_CLEAR_AT:"AI_REQUEST_LOG_CLEAR_AT_V1",USAGE_TOTALS:"AI_USAGE_TOTALS_V1",CACHE_INDEX:"AI_CACHE_INDEX_V1",CACHE_CLEAR_AT:"AI_CACHE_CLEAR_AT_V1",RUNTIME_STATUS:"AI_RUNTIME_STATUS_V1"}),o=new Set([n.GEMINI_API_KEY,n.OPENAI_API_KEY,n.LICENSE]),i=Object.freeze({GEMINI_API_KEY:"GEMINI_API_KEY",MAX_OUTPUT_TOKENS:"MAX_OUTPUT_TOKENS",DEFAULT_PROVIDER_V2:"AI_DEFAULT_PROVIDER_V2",GEMINI_API_KEY_V2:"AI_GEMINI_API_KEY_V2",OPENAI_API_KEY_V2:"AI_OPENAI_API_KEY_V2",GEMINI_MODEL_V2:"AI_GEMINI_MODEL_V2",OPENAI_MODEL_V2:"AI_OPENAI_MODEL_V2",GEMINI_MAX_TOKENS_V2:"AI_GEMINI_MAX_OUTPUT_TOKENS_V2",OPENAI_MAX_TOKENS_V2:"AI_OPENAI_MAX_OUTPUT_TOKENS_V2"});let s=null,a=!1,r=null,c=0;function u(){a=!0}function l(){if(!a)try{if("undefined"!=typeof OfficeRuntime&&OfficeRuntime?.storage?.getItem)return{kind:"office",storage:OfficeRuntime.storage}}catch{}try{if("undefined"!=typeof window&&window?.localStorage?.getItem)return{kind:"local",storage:window.localStorage}}catch{}const e=new Map;return{kind:"memory",storage:{getItem:async t=>e.has(t)?e.get(t):null,async setItem(t,n){e.set(t,String(n))},async removeItem(t){e.delete(t)}}}}function d(){try{if("undefined"!=typeof window&&window?.localStorage?.getItem)return window.localStorage}catch{return null}return null}function f(e,t){try{return e.getItem(t)}catch{return null}}function p(e,t,n){try{return e.setItem(t,n),!0}catch{return!1}}function m(e,t){try{return e.removeItem(t),!0}catch{return!1}}async function g(e,t={}){const{kind:n,storage:i}=l(),s=t.sensitive??function(e){return o.has(e)}(e),r=!1!==t.allowLocalFallback;if("local"===n)return f(i,e);if("office"===n){let t=null;try{t=await i.getItem(e)}catch{u()}if(null!=t){if(s){const t=d();t&&m(t,e)}return t}if(!r)return null;const n=d();if(!n)return null;const o=f(n,e);if(null==o)return null;if(!a)try{await i.setItem(e,String(o)),m(n,e)}catch{u()}return o}try{return await i.getItem(e)}catch{return null}}async function y(e,t,n={}){const{kind:o,storage:i}=l(),s=null==t?"":String(t),a=!1!==n.allowLocalFallback;if("local"!==o){if("office"===o){let t=!1;try{await i.setItem(e,s),t=!0}catch{u()}const n=d();if(t)return void(n&&m(n,e));if(!a||!n)return;return void p(n,e,s)}try{await i.setItem(e,s)}catch{}}else p(i,e,s)}async function E(e){const{kind:t,storage:n}=l();if("local"!==t){if("office"===t){let t=!1;try{await n.removeItem(e),t=!0}catch{u()}const o=d();return void(o&&m(o,e))}try{await n.removeItem(e)}catch{}}else m(n,e)}async function h(){if(s)return s;s=(async()=>{if("1"!==await g(n.MIGRATION_DONE)){if(!I(await g(n.DEFAULT_PROVIDER))){const e=I(await g(i.DEFAULT_PROVIDER_V2));await y(n.DEFAULT_PROVIDER,e||t.provider)}if(!await g(n.GEMINI_API_KEY)){const e=await g(i.GEMINI_API_KEY_V2)||await g(i.GEMINI_API_KEY);e&&await y(n.GEMINI_API_KEY,e)}if(!await g(n.OPENAI_API_KEY)){const e=await g(i.OPENAI_API_KEY_V2);e&&await y(n.OPENAI_API_KEY,e)}if(!await g(n.GEMINI_MODEL)){const e=await g(i.GEMINI_MODEL_V2);await y(n.GEMINI_MODEL,e||t.geminiModel)}if(!await g(n.OPENAI_MODEL)){const e=await g(i.OPENAI_MODEL_V2);await y(n.OPENAI_MODEL,e||t.openaiModel)}if(!await g(n.MAX_OUTPUT_TOKENS)){const e=[await g(i.MAX_OUTPUT_TOKENS),await g(i.GEMINI_MAX_TOKENS_V2),await g(i.OPENAI_MAX_TOKENS_V2)].map(e=>parseInt(String(e||"").trim(),10)).filter(e=>Number.isFinite(e)&&e>0),o=e.length?Math.max(...e):t.maxOutputTokens;await y(n.MAX_OUTPUT_TOKENS,String(o))}await y(n.MIGRATION_DONE,"1")}})();try{await s}finally{s=null}}function I(t){if(!t)return"";const n=String(t).trim().toLowerCase();return n===e.GEMINI?e.GEMINI:n===e.OPENAI?e.OPENAI:"google"===n||"gem"===n?e.GEMINI:"oai"===n||"chatgpt"===n?e.OPENAI:""}const w=new Set(["auto","minimal","low","medium","high"]),A=new Set(["none","minimal","low","medium","high"]);function v(e){const n=String(e||"").trim().toLowerCase();return n&&w.has(n)?n:t.geminiReasoningEffort}function k(e){const n=String(e||"").trim().toLowerCase();return n&&A.has(n)?n:t.openaiReasoningEffort}async function _(){return await h(),I(await g(n.DEFAULT_PROVIDER))||t.provider}function T(t){return I(t)===e.OPENAI?n.OPENAI_API_KEY:n.GEMINI_API_KEY}async function N(e){return await h(),(await g(T(e))||"").trim()}async function b(e){return!!await N(e)}function S(t){return I(t)===e.OPENAI?n.OPENAI_MODEL:n.GEMINI_MODEL}async function C(n){await h();const o=I(n),i=await g(S(o));return i&&String(i).trim()?String(i).trim():o===e.OPENAI?t.openaiModel:t.geminiModel}async function O(){return await h(),v(await g(n.GEMINI_REASONING_EFFORT)||t.geminiReasoningEffort)}async function M(){return await h(),k(await g(n.OPENAI_REASONING_EFFORT)||t.openaiReasoningEffort)}async function L(e){const t=k(e);return await y(n.OPENAI_REASONING_EFFORT,t),t}async function x(e){const t=v(e);return await y(n.GEMINI_REASONING_EFFORT,t),t}async function R(){await h();const e=await g(n.MAX_OUTPUT_TOKENS);return Q(parseInt(String(e||"").trim(),10),1,128e3,t.maxOutputTokens)}async function P(e){const o=Q(e,1,128e3,t.maxOutputTokens);return await y(n.MAX_OUTPUT_TOKENS,String(o)),o}const G=[4,8,16,32,64];function D(e){const n=Q(e,G[0],G[G.length-1],t.concurrencyLimit);if(G.includes(n))return n;let o=G[0],i=Math.abs(n-o);for(const e of G.slice(1)){const t=Math.abs(n-e);t<i&&(o=e,i=t)}return o}async function q(){return await h(),D(await g(n.CONCURRENCY_LIMIT))}async function K(e){const t=D(e);return await y(n.CONCURRENCY_LIMIT,String(t)),t}async function F(){return await h(),"1"===await g(n.ONBOARDING_KEYS_CONFIRMED)}async function U(e=!0){return await y(n.ONBOARDING_KEYS_CONFIRMED,e?"1":"0"),e}function V(e){return e&&"object"==typeof e?{active:Q(e.active,0,1e5,0),queued:Q(e.queued,0,1e5,0),ts:Q(e.ts,0,Number.MAX_SAFE_INTEGER,0)}:{active:0,queued:0,ts:0}}async function $(e){const t=V(e);return await y(n.RUNTIME_STATUS,JSON.stringify(t)),t}async function j(){return await async function(){const e=H();if(null!=r&&e-c<2e3)return r;const t="1"===await g(n.PRIVACY_MODE);return r=t,c=e,t}()}function Y(e){if(!Array.isArray(e))return[];const t=[],n=new Set;for(const o of e){const e=String(o||"").trim();e&&!n.has(e)&&(n.add(e),t.push(e))}return t}async function B(e){const t=Y(e);return await y(n.SECTION_HIDDEN,JSON.stringify(t)),t}async function J(e){return e?(await y(n.LICENSE,JSON.stringify(e)),e):(await E(n.LICENSE),null)}async function z(){await E(n.LICENSE)}function H(){return Date.now()}function X(e){return new Promise(t=>setTimeout(t,e))}function Q(e,t,n,o=t){const i=parseInt(String(e),10);return Number.isFinite(i)?Math.max(t,Math.min(n,i)):o}const W=[/\bsk-[A-Za-z0-9-_]{1,}\b/gi,/\bAIza[0-9A-Za-z_-]{1,}\b/gi,/\b[A-Z0-9]{4}(?:-[A-Z0-9]{4}){1,3}\b/gi];function Z(e){if(null==e)return"";let t=String(e);for(const e of W)t=t.replace(e,"[REDACTED]");return t}function ee(e){if(null==e)return e;if("string"==typeof e)return Z(e);if(Array.isArray(e))return e.map(ee);if("object"==typeof e){const t={};for(const[n,o]of Object.entries(e))t[n]=ee(o);return t}return e}function te(e){const t=parseInt(String(e||"").trim(),10);return Number.isFinite(t)&&t>0?t:0}const ne="AI_CACHE_ENTRY_V1:";let oe=0;async function ie(){const e=te(await g(n.CACHE_CLEAR_AT));return e>oe&&(oe=e),oe}async function se(){const e=await g(n.CACHE_INDEX);if(!e)return[];try{const t=JSON.parse(e);return Array.isArray(t)?t:[]}catch{return[]}}async function ae(e){try{await y(n.CACHE_INDEX,JSON.stringify(e))}catch{}}function re(e,t=0){const n=H(),o=[],i=[];for(const s of e||[]){if(!s||!s.key)continue;const e=Number(s.savedAtMs||0);t&&(!Number.isFinite(e)||e<=t)||s.expiresAtMs&&s.expiresAtMs<=n?i.push(s.key):o.push(s)}if(o.length>250){o.sort((e,t)=>(e.savedAtMs||0)-(t.savedAtMs||0));const e=o.length-250,t=o.slice(0,e);for(const e of t)i.push(e.key);return{list:o.slice(e),removedKeys:i}}return{list:o,removedKeys:i}}async function ce(e){e&&await E(ne+e)}async function ue(e){const t=await se(),n=(t||[]).filter(t=>t?.key!==e);n.length!==t.length&&await ae(n)}async function le(e,t,n,o={}){if(!e)return;if(await j())return;const i=H(),s=await ie(),a=s&&i<=s?s+1:i,r="number"==typeof n&&n>0?a+n:null,c={v:1,savedAtMs:a,expiresAtMs:r,value:t},u=JSON.stringify(c);await y(ne+e,u);const l=await se(),d=o.provider||t?.provider||"",f=o.model||t?.model||"",p=u.length;let m=!1;const g=(l||[]).map(t=>t?.key!==e?t:(m=!0,{key:e,provider:d,model:f,size:p,savedAtMs:a,expiresAtMs:r}));m||g.push({key:e,provider:d,model:f,size:p,savedAtMs:a,expiresAtMs:r});const E=re(g,s);for(const e of E.removedKeys)await ce(e);await ae(E.list)}function de(e){if(Array.isArray(e))return e.map(de);if(t=e,"[object Object]"===Object.prototype.toString.call(t)){const t={};for(const n of Object.keys(e).sort())t[n]=de(e[n]);return t}var t;return e}const fe=1/0;let pe=[],me=null,ge=!1,ye=0,Ee=0,he=Se(),Ie=null,we=!1,Ae=0;async function ve(e={}){const t=te(await g(n.REQUEST_LOG_CLEAR_AT));return t>Ee&&(Ee=t,pe=[],e.reset?(ge=!0,me=null,ye=H()):ge=!1),Ee}function ke(e){return!!e&&!1===e.ok}async function _e(e=!1){if(me)return me;me=(async()=>{if(await j())return!e&&ge||(ge=!0,ye=H()),pe;const t=await ve();if(!e&&ge)return pe;const o=await g(n.REQUEST_LOG);let i=[];if(o)try{i=function(e){if(Array.isArray(e))return e;if(e&&"object"==typeof e){const t=Array.isArray(e.normal)?e.normal:[],n=Array.isArray(e.errors)?e.errors:[];return t.concat(n)}return[]}(JSON.parse(o))}catch{i=[]}const s=H();return i=i.map(e=>{if(!e)return null;let t=e.ts;if("string"==typeof t){const e=Date.parse(t);Number.isFinite(e)&&(t=e)}return"number"!=typeof t?null:{...e,ts:t}}).filter(e=>e&&"number"==typeof e.ts&&e.ts>t&&s-e.ts<=fe).map(e=>Me(e)),pe=i,Ne(),ge=!0,ye=H(),pe})();try{return await me}finally{me=null}}async function Te(){try{if(await j())return;Ne(),await y(n.REQUEST_LOG,JSON.stringify(pe.slice(-100)))}catch{}}function Ne(){const e=H(),t=Ee||0,n=(pe||[]).filter(n=>n&&"number"==typeof n.ts&&n.ts>t&&e-n.ts<=fe),o=[],i=[];for(const e of n)ke(e)?i.push(e):o.push(e);o.sort((e,t)=>e.ts-t.ts),i.sort((e,t)=>e.ts-t.ts);const s=o.slice(-50).concat(i.slice(-50));s.sort((e,t)=>e.ts-t.ts),pe=s}function be(e){const t=Number(e);return!Number.isFinite(t)||t<=0?0:Math.floor(t)}function Se(){return{inputTokens:0,outputTokens:0,reasoningTokens:0,cachedInputTokens:0,requests:0,byProvider:{[e.GEMINI]:{inputTokens:0,outputTokens:0,reasoningTokens:0,cachedInputTokens:0,requests:0,models:{}},[e.OPENAI]:{inputTokens:0,outputTokens:0,reasoningTokens:0,cachedInputTokens:0,requests:0,models:{}}}}}async function Ce(t=!1){if(Ie)return Ie;Ie=(async()=>{if(await j())return!t&&we||(we=!0,Ae=H()),he;if(!t&&we)return he;const o=await g(n.USAGE_TOTALS);let i=null;if(o)try{i=JSON.parse(o)}catch{i=null}return he=function(t){const n=Se();if(!t||"object"!=typeof t)return n;n.inputTokens=be(t.inputTokens),n.outputTokens=be(t.outputTokens),n.reasoningTokens=be(t.reasoningTokens),n.cachedInputTokens=be(t.cachedInputTokens),n.requests=be(t.requests);const o=t.byProvider&&"object"==typeof t.byProvider?t.byProvider:{};for(const t of[e.GEMINI,e.OPENAI]){const e=o[t];if(!e||"object"!=typeof e)continue;const i=n.byProvider[t];i.inputTokens=be(e.inputTokens),i.outputTokens=be(e.outputTokens),i.reasoningTokens=be(e.reasoningTokens),i.cachedInputTokens=be(e.cachedInputTokens),i.requests=be(e.requests);const s=e.models&&"object"==typeof e.models?e.models:{};for(const[e,t]of Object.entries(s)){if(!t||"object"!=typeof t)continue;const n="string"==typeof t.label?t.label:String(e||""),o=String(e||n||"").toLowerCase();o&&(i.models[o]={label:n,inputTokens:be(t.inputTokens),outputTokens:be(t.outputTokens),reasoningTokens:be(t.reasoningTokens),cachedInputTokens:be(t.cachedInputTokens),requests:be(t.requests)})}}return n}(i),we=!0,Ae=H(),he})();try{return await Ie}finally{Ie=null}}function Oe(t){!async function(t){try{const o=Me({ts:H(),...t});if(await async function(t){try{if(!t||"object"!=typeof t)return;const o=be(t.inputTokens),i=be(t.outputTokens),s=be(t.reasoningTokens),a=be(t.cachedInputTokens);if(!(o+i+s+a>0))return;const r=String(t.provider||"").toLowerCase();if(r!==e.GEMINI&&r!==e.OPENAI)return;const c=String(t.model||"").trim(),u=(c||"unknown").toLowerCase();await Ce(),he.inputTokens+=o,he.outputTokens+=i,he.reasoningTokens+=s,he.cachedInputTokens+=a,he.requests+=1;const l=he.byProvider[r];l.inputTokens+=o,l.outputTokens+=i,l.reasoningTokens+=s,l.cachedInputTokens+=a,l.requests+=1;const d=l.models||{},f=d[u]||{label:c,inputTokens:0,outputTokens:0,reasoningTokens:0,cachedInputTokens:0,requests:0};!f.label&&c&&(f.label=c),f.inputTokens+=o,f.outputTokens+=i,f.reasoningTokens+=s,f.cachedInputTokens+=a,f.requests+=1,d[u]=f,l.models=d,Ae=H(),await async function(){try{if(await j())return;await y(n.USAGE_TOTALS,JSON.stringify(he))}catch{}}()}catch{}}(o),await j())return pe.push(o),Ne(),ge=!0,void(ye=H());if(await ve({reset:!0}),ge)return pe.push(o),Ne(),ye=H(),void await Te();await _e(),pe.push(o),Ne(),ye=H(),await Te()}catch{}}(t)}function Me(e){return e&&"object"==typeof e?ee(e):e}async function Le(){const e=H();pe=[],ge=!0,me=null,Ee=e,ye=e,await y(n.REQUEST_LOG_CLEAR_AT,String(e)),await E(n.REQUEST_LOG)}const xe=new class{constructor(e=500){this.maxEntries=e,this.map=new Map}get(e){if(!this.map.has(e))return null;const t=this.map.get(e);return t?.expiresAtMs&&t.expiresAtMs<=H()?(this.map.delete(e),null):(this.map.delete(e),this.map.set(e,t),t.value)}set(e,t,n){const o="number"==typeof n&&n>0?H()+n:null;for(this.map.has(e)&&this.map.delete(e),this.map.set(e,{value:t,expiresAtMs:o});this.map.size>this.maxEntries;){const e=this.map.keys().next().value;this.map.delete(e)}}clear(){this.map.clear()}}(800);let Re=0;const Pe=new Map,Ge=Symbol("queue_cancelled"),De={ok:!1,code:"QUEUE_CANCELLED",message:"File d'attente arrÃªtÃ©e."};let qe=t.concurrencyLimit,Ke=0,Fe=0;const Ue=[];let Ve=null,$e=null,je="";function Ye(){const e={active:Fe,queued:Ue.length};$e=e,Ve||(Ve=setTimeout(()=>{Ve=null;const e=$e;if($e=null,!e)return;const t=`${e.active}:${e.queued}`;t!==je&&(je=t,$({...e,ts:H()}))},120))}async function Be(){const e=H();if(e-Ke<1500)return qe;const t=await q();return qe=t,Ke=e,t}function Je(e){return"string"==typeof e&&e.trim().length>0}function ze(e,t=!1){if("boolean"==typeof e)return e;if("number"==typeof e)return 0!==e;if("string"==typeof e){const t=e.trim().toLowerCase();if(["1","true","yes","y","on"].includes(t))return!0;if(["0","false","no","n","off"].includes(t))return!1}return t}function He(e){return Q(e,1e3,12e4,t.timeoutMs)}function Xe(e){return String(e||"").toLowerCase()}function Qe(e){const t=Xe(e);return!!t&&(t.includes("responseschema")||t.includes("response schema")||t.includes("response_schema")||t.includes("responsemime")||t.includes("response mime")||t.includes("response_mime")||t.includes("response_mime_type")||t.includes("json_schema")||t.includes("response_format")||t.includes("text.format"))}function We(e){const t=Xe(e);return!!t&&!!(t.includes("web_search")||t.includes("google_search")||t.includes("web search")||t.includes("google search"))&&(t.includes("not supported")||t.includes("unsupported")||t.includes("unknown")||t.includes("unrecognized")||t.includes("invalid")||t.includes("not enabled")||t.includes("not available"))}function Ze(e){if(!Je(e))return"Return valid JSON only.";const t=String(e).trim();return/json/i.test(t)?t:t+" Return valid JSON only."}function et(e,t){return"AI.FORMULA"!==e?"":function(e){if(!Je(e))return"";const t=String(e).trim(),n=t.match(/=[^\n\r]+/),o=(n?n[0]:t).trim();return o.startsWith("=")?o:""}(t)}async function tt(n){const o=H(),i=I(n?.provider)||await _(),s=await C(i),a=await N(i),r=n?.functionName||"aiGenerate",c=Je(n?.functionCall)?String(n.functionCall):"",u=i===e.OPENAI?await M():"",l=i===e.GEMINI?await O():"",d=i===e.OPENAI?u:l;if(!a)return Oe({fn:r,provider:i,model:s,ok:!1,ms:H()-o,cache:!1,reasoningEffort:d||void 0,call:c||void 0,code:"API_KEY_MISSING",message:`ClÃ© API manquante pour le fournisseur ${i}.`}),{ok:!1,provider:i,model:s,code:"API_KEY_MISSING",message:`ClÃ© API manquante pour le fournisseur ${i}.`};const f=String(n?.user||""),p=Je(n?.system)?String(n.system):"",m=ze(n?.webSearch,!1),y=He(n?.timeoutMs),E=(h=n?.retry,Q(h,0,5,t.retry));var h;const w=await R(),A=function(e){return Q(e,1,128e3,t.maxOutputTokens)}(n?.maxOutputTokens??w),v=i===e.GEMINI?function(e,t){const n=String(t||"").trim().toLowerCase();if(!n||"auto"===n||"none"===n)return null;const o=String(e||"").trim().toLowerCase();if(!o.includes("gemini"))return null;if(o.includes("gemini-3"))return o.includes("flash")?{thinkingLevel:(new Set(["minimal","low","medium","high"]).has(n)?n:"low").toUpperCase()}:{thinkingLevel:("high"===n||"medium"===n?"high":"low").toUpperCase()};if(o.includes("gemini-2.5")){let e={minimal:512,low:2048,medium:8192,high:24576}[n];return e?(o.includes("flash-lite")&&(e=Math.max(512,e)),o.includes("pro")&&(e=Math.max(128,e)),{thinkingBudget:e}):null}return null}(s,l):null,k=ze(n?.cache,t.cache),T=Q(n?.cacheTtlSec??(m?t.webCacheTtlSec:t.cacheTtlSec),1,31536e3,m?t.webCacheTtlSec:t.cacheTtlSec);await async function(){const e=await async function(){return await ie()}();e>Re&&(Re=e,xe.clear())}();const b={v:3,provider:i,model:s,maxOutputTokens:A,reasoningEffort:u,geminiReasoningEffort:l,webSearch:m,system:p,user:f,responseMimeType:n?.responseMimeType||"",responseJsonSchema:n?.responseJsonSchema||null},S=await async function(e){const t="string"==typeof e?e:(n=e,JSON.stringify(de(n)));var n;try{if("undefined"!=typeof crypto&&crypto?.subtle?.digest&&"undefined"!=typeof TextEncoder){const e=(new TextEncoder).encode(t),n=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(n)).map(e=>e.toString(16).padStart(2,"0")).join("")}}catch{}return`fnv1a:${function(e){let t=2166136261;for(let n=0;n<e.length;n++)t^=e.charCodeAt(n),t=Math.imul(t,16777619);return(t>>>0).toString(16).padStart(8,"0")}(t)}`}(b);if(k){const e=xe.get(S);if(e){const t=et(r,e?.text);return Oe({fn:r,provider:i,model:s,ok:!0,ms:H()-o,cache:!0,cacheKind:"memory",reasoningEffort:d||void 0,call:c||void 0,inputTokens:0,outputTokens:0,reasoningTokens:0,totalTokens:0,formula:t||void 0}),{...e,cached:!0,cacheKind:"memory"}}const t=await async function(e){if(!e)return null;if(await j())return null;const t=await ie(),n=await g(ne+e);if(!n)return await ue(e),null;try{const o=JSON.parse(n);if(!o||"object"!=typeof o)throw new Error("Invalid entry");const i=Number(o.savedAtMs||0);return t&&(!Number.isFinite(i)||i<=t)||o.expiresAtMs&&o.expiresAtMs<=H()?(await ce(e),await ue(e),null):o.value||null}catch{return await ce(e),await ue(e),null}}(S);if(t){const e=et(r,t?.text);return xe.set(S,t,1e3*T),Oe({fn:r,provider:i,model:s,ok:!0,ms:H()-o,cache:!0,cacheKind:"persistent",reasoningEffort:d||void 0,call:c||void 0,inputTokens:0,outputTokens:0,reasoningTokens:0,totalTokens:0,formula:e||void 0}),{...t,cached:!0,cacheKind:"persistent"}}}if(Pe.has(S))return Pe.get(S);const L=async function(){for(;;){const e=await Be();if(Fe<e)break;if(await new Promise(e=>{Ue.push(e),Ye()})===Ge)return{...De}}Fe++,Ye();try{return await(async()=>{let t=0,l=null;const g=async t=>i===e.OPENAI?async function({apiKey:t,model:n,system:o,user:i,maxOutputTokens:s,reasoningEffort:a,timeoutMs:r,webSearch:c,responseMimeType:u,responseJsonSchema:l}){const d="https://api.openai.com/v1/responses",f={model:n,input:i,max_output_tokens:s,store:!1};if(Je(a)&&(f.reasoning={effort:a}),Je(o)){const e="application/json"===u||l?o+" You must return valid JSON.":o;f.instructions=e}l?f.text={format:{type:"json_schema",name:"excel_ai_schema",strict:!0,schema:l}}:"application/json"===u&&(f.text={format:{type:"json_object"}}),c&&(f.tools=[{type:"web_search"}],f.include=["web_search_call.action.sources"]);const p=await at(d,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify(f)},r),m=await rt(p);if(!p.ok){const t=function(e){try{const t=e?.error?.message;return t?String(t):""}catch{return""}}(m)||`OpenAI API error (${p.status}).`;return{ok:!1,provider:e.OPENAI,model:n,code:"API_ERROR",message:Z(t)}}const g=function(e){try{if("string"==typeof e?.output_text&&e.output_text.trim())return e.output_text}catch{}try{const t=e?.output;if(Array.isArray(t)){const e=[];for(const n of t){if("string"==typeof n?.text&&n.text.trim()&&e.push(n.text),"string"==typeof n?.output_text&&n.output_text.trim()&&e.push(n.output_text),"output_text"===n?.type&&"string"==typeof n?.text&&e.push(n.text),"text"===n?.type&&"string"==typeof n?.text&&e.push(n.text),"message"===n?.type){const t=n?.content;if(Array.isArray(t))for(const n of t)"text"===n?.type&&n?.text&&e.push(n.text),"output_text"===n?.type&&n?.text&&e.push(n.text);else"string"==typeof t&&e.push(t)}if("message"!==n?.type){const t=n?.content;if(Array.isArray(t))for(const n of t)"text"===n?.type&&n?.text&&e.push(n.text),"output_text"===n?.type&&n?.text&&e.push(n.text);else"string"==typeof t&&e.push(t)}}if(e.length>0)return e.join("\n").trim()}}catch{}try{return e?.choices?.[0]?.message?.content||""}catch{return""}}(m),y=c?function(e){try{const t=e?.output;if(!Array.isArray(t))return[];const n=[];for(const e of t){if("web_search_call"!==e?.type)continue;const t=e?.action?.sources;if(Array.isArray(t))for(const e of t)e?.url&&n.push({title:e?.title||"",url:e.url})}return st(n)}catch{return[]}}(m):[],E=function(e){try{const t=e?.usage;if(!t)return null;const n=ot(t?.output_tokens),o=ot(t?.output_tokens_details?.reasoning_tokens),i=Math.max(0,n-o);return{inputTokens:ot(t?.input_tokens),outputTokens:i,reasoningTokens:o,totalTokens:ot(t?.total_tokens),cachedInputTokens:ot(t?.input_tokens_details?.cached_tokens)}}catch{return null}}(m);return Je(g)?{ok:!0,provider:e.OPENAI,model:n,text:g.trim(),sources:y,usage:E}:{ok:!1,provider:e.OPENAI,model:n,code:"EMPTY_RESPONSE",message:"RÃ©ponse vide d'OpenAI."}}(t):async function({apiKey:t,model:n,system:o,user:i,maxOutputTokens:s,thinkingConfig:a,timeoutMs:r,webSearch:c,responseMimeType:u,responseJsonSchema:l}){const d=function(e){return`https://generativelanguage.googleapis.com/v1beta/models/${encodeURIComponent(e)}:generateContent`}(n),f={contents:[{role:"user",parts:[{text:i}]}],generationConfig:{maxOutputTokens:s}};if(a&&"object"==typeof a&&(f.generationConfig.thinkingConfig=a),Je(o)){const e="application/json"===u||l?o+" You must return valid JSON.":o;f.systemInstruction={role:"system",parts:[{text:e}]}}u&&(f.generationConfig.responseMimeType=u),l&&(f.generationConfig.responseSchema=l),c&&(f.tools=[{google_search:{}}]);const p=await at(d,{method:"POST",headers:{"Content-Type":"application/json","x-goog-api-key":t},body:JSON.stringify(f)},r),m=await rt(p);if(!p.ok){const t=function(e){try{const t=e?.error?.message;return t?String(t):""}catch{return""}}(m)||`Gemini API error (${p.status}).`;return{ok:!1,provider:e.GEMINI,model:n,code:"API_ERROR",message:Z(t)}}const g=function(e){try{const t=e?.candidates?.[0],n=t?.content?.parts;return Array.isArray(n)?n.map(e=>e?.text||"").join(""):""}catch{return""}}(m),y=function(e){try{const t=e?.candidates?.[0],n=t?.groundingMetadata,o=n?.groundingChunks;if(!Array.isArray(o))return[];const i=[];for(const e of o){const t=e?.web;t?.uri&&i.push({title:t?.title||"",url:t.uri})}return st(i)}catch{return[]}}(m),E=function(e){try{const t=e?.usageMetadata;return t?{inputTokens:ot(t?.promptTokenCount),outputTokens:ot(t?.candidatesTokenCount),reasoningTokens:ot(t?.thoughtsTokenCount),totalTokens:ot(t?.totalTokenCount),cachedInputTokens:ot(t?.cachedContentTokenCount)}:null}catch{return null}}(m);return Je(g)?{ok:!0,provider:e.GEMINI,model:n,text:g.trim(),sources:y,usage:E}:{ok:!1,provider:e.GEMINI,model:n,code:"EMPTY_RESPONSE",message:"RÃ©ponse vide de Gemini."}}(t);for(;t<=E;){t++;try{const e={apiKey:a,model:s,system:p,user:f,maxOutputTokens:A,reasoningEffort:u,thinkingConfig:v,timeoutMs:y,webSearch:m,responseMimeType:n?.responseMimeType,responseJsonSchema:n?.responseJsonSchema};let l=await g(e);if(!l.ok){let t=e;t.webSearch&&(We(l.message)||"API_ERROR"===l.code||"EMPTY_RESPONSE"===l.code)&&(t={...t,webSearch:!1},l=await g(t));const n=t.responseMimeType||t.responseJsonSchema;!l.ok&&n&&(Qe(l.message)||"API_ERROR"===l.code||"EMPTY_RESPONSE"===l.code)&&(t={...t,responseMimeType:void 0,responseJsonSchema:void 0,system:Ze(t.system)},l=await g(t))}const E=nt(l?.usage),h=l.ok?et(r,l.text):"";return Oe({fn:r,provider:i,model:s,ok:l.ok,ms:H()-o,attempt:t,cache:!1,reasoningEffort:d||void 0,call:c||void 0,inputTokens:E.inputTokens,outputTokens:E.outputTokens,reasoningTokens:E.reasoningTokens,cachedInputTokens:E.cachedInputTokens,totalTokens:E.totalTokens,code:l.code,message:l.message,formula:h||void 0}),l.ok&&k&&(xe.set(S,l,1e3*T),await le(S,l,1e3*T,{provider:i,model:s})),l}catch(e){l=e,t<=E&&await X(250*t)}}const h=Z(l?.message?String(l.message):"Erreur inconnue.");return Oe({fn:r,provider:i,model:s,ok:!1,ms:H()-o,cache:!1,reasoningEffort:d||void 0,call:c||void 0,code:"API_ERROR",message:h}),{ok:!1,provider:i,model:s,code:"API_ERROR",message:h}})()}finally{Fe--;const e=Ue.shift();e&&e(),Ye()}}();Pe.set(S,L);try{const e=await L;return"QUEUE_CANCELLED"===e?.code&&Oe({fn:r,provider:i,model:s,ok:!1,ms:H()-o,cache:!1,reasoningEffort:d||void 0,call:c||void 0,inputTokens:0,outputTokens:0,reasoningTokens:0,cachedInputTokens:0,totalTokens:0,code:e.code,message:e.message}),e}finally{Pe.delete(S)}}function nt(e){if(!e||"object"!=typeof e)return{inputTokens:0,outputTokens:0,reasoningTokens:0,totalTokens:0,cachedInputTokens:0};const t=ot(e.inputTokens),n=ot(e.outputTokens),o=ot(e.reasoningTokens),i=ot(e.cachedInputTokens),s=ot(e.totalTokens),a=t+n+o;return{inputTokens:t,outputTokens:n,reasoningTokens:o,totalTokens:Math.max(s,a),cachedInputTokens:i}}function ot(e){const t=Number(e);return!Number.isFinite(t)||t<=0?0:Math.floor(t)}async function it(){xe.clear(),await async function(){const e=H();oe=e,await y(n.CACHE_CLEAR_AT,String(e));const t=await se();for(const e of t||[])e?.key&&await ce(e.key);await E(n.CACHE_INDEX)}()}function st(e){const t=new Set,n=[];for(const o of e||[]){const e=String(o?.url||"").trim();if(!e)continue;const i=e.toLowerCase();t.has(i)||(t.add(i),n.push({title:String(o?.title||"").trim(),url:e}))}return n}async function at(e,t,n){const o=He(n);if("undefined"==typeof AbortController)return await fetch(e,t);const i=new AbortController,s=setTimeout(()=>i.abort(),o);try{return await fetch(e,{...t,signal:i.signal})}finally{clearTimeout(s)}}async function rt(e){try{return await e.json()}catch{return{}}}$({active:0,queued:0,ts:H()});const ct="Neurow Add-in";function ut(e){return String(e||"").trim()}function lt(e){const t=String(e||"").trim();if(!t)return"";const n=Date.parse(t);return Number.isFinite(n)?new Date(n).toISOString():""}function dt(e,t){if(!e)return t;if("string"==typeof e.error&&e.error.trim())return e.error.trim();if("string"==typeof e.message&&e.message.trim())return e.message.trim();if(Array.isArray(e.errors)&&e.errors.length){const t=e.errors[0]||{},n=t.detail||t.title||t.message;if(n)return String(n).trim()}return t}async function ft(e,t){const n=new FormData;Object.entries(t||{}).forEach(([e,t])=>{null!=t&&""!==t&&n.append(e,t)});const o=await fetch(e,{method:"POST",body:n});let i=null;try{i=await o.json()}catch{i=null}return{ok:o.ok,status:o.status,data:i}}function pt(e,t,n={}){const o=n.instanceId||t?.instance?.id||t?.instance_id||"",i=t?.instance?.name||n.instanceName||ct,s=lt(t?.license_key?.expires_at||n.expiresAt),a=(new Date).toISOString();return{key:e,instanceId:o,instanceName:i,expiresAt:s,valid:!0,activatedAt:n.activatedAt||a,lastCheckedAt:a}}function mt(e){if(!e||"object"!=typeof e)return null;const t=ut(e.key);return t?{key:t,instanceId:String(e.instanceId||"").trim(),instanceName:String(e.instanceName||ct).trim(),expiresAt:lt(e.expiresAt),valid:!1!==e.valid,activatedAt:String(e.activatedAt||"").trim(),lastCheckedAt:String(e.lastCheckedAt||"").trim()}:null}async function gt(){return mt(await async function(){await h();const e=await g(n.LICENSE);if(!e)return null;try{return JSON.parse(e)}catch{return null}}())}async function yt(e){const t=mt(e);return t?(await J(t),t):(await z(),null)}function Et(e){if(!e||!e.key)return!1;if(!1===e.valid)return!1;if(e.expiresAt){const t=Date.parse(e.expiresAt);if(Number.isFinite(t)&&t<=Date.now())return!1}return!0}function ht(e){return document.getElementById(e)}function It(e,t){const n=Z(e||"");if(ht("statusLine").textContent=n,t)try{const e=ee(t);ht("statusDetails").textContent=JSON.stringify(e,null,2)}catch{ht("statusDetails").textContent=Z(t)}else ht("statusDetails").textContent=""}function wt(e){const t=Number(e);return Number.isFinite(t)?Math.round(t).toLocaleString("en-US"):"0"}const At="â‚¬";function vt(e){const t=Number(e);return Number.isFinite(t)?`${At}${t.toFixed(4)}`:`${At}0.0000`}function kt(e){const t=Number(e);return Number.isFinite(t)?`${(t/1e3).toFixed(2)}s`:"0.00s"}function _t(e){try{return new Date(e).toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"})}catch{return"--:--"}}function Tt(e){return String(e?.dataset?.section||"").trim()}function Nt(e){return"true"===e?.dataset?.sectionLocked}function bt(e){if(an||(an=document.querySelector(".app__main")),!an)return;const t=document.querySelector(Ft);for(const n of e){const e=on.get(n);e&&(t?an.insertBefore(e,t):an.appendChild(e))}}function St(e){on.forEach((t,n)=>{const o=Nt(t),i=e.has(n)&&!o;t.classList.toggle(Ut,i)})}function Ct(){let e=!1;for(const t of Array.from(nn)){const n=on.get(t);n&&!Nt(n)||(nn.delete(t),e=!0)}e&&B(Array.from(nn))}function Ot(e,t={}){const{persist:o=!0}=t;en=e.slice(),bt(en),Rt(),o&&async function(e){const t=Y(e);await y(n.SECTION_ORDER,JSON.stringify(t))}(en)}function Mt(e,t={}){const{persist:n=!0}=t;nn=new Set(e),Ct(),St(nn),Rt(),n&&B(Array.from(nn)),qn()}function Lt(e,t){const n=en.indexOf(e);if(n<0)return;const o=n+t;if(o<0||o>=en.length)return;const i=en.slice();i.splice(n,1),i.splice(o,0,e),Ot(i)}function xt(e){e.querySelectorAll(".section-row").forEach(e=>{e.classList.remove("is-drop-before","is-drop-after","is-dragging")})}function Rt(){const e=ht("sectionManagerList");if(!e)return;e.innerHTML="";const t=en.length?en:Array.from(on.keys());t.forEach((n,o)=>{const i=on.get(n);if(!i)return;const s=function(e){const t=e?.dataset?.sectionTitle;if(t)return t;const n=e?.querySelector?.(".card__title");return n?n.textContent.trim():Tt(e)}(i),a=Nt(i),r=!nn.has(n)||a,c=document.createElement("div");c.className="section-row",c.dataset.sectionKey=n,c.setAttribute("role","listitem");const u=document.createElement("button");u.type="button",u.className="section-row__handle",u.draggable=!0,u.setAttribute("title","Glisser pour dÃ©placer"),u.setAttribute("aria-label",`DÃ©placer ${s}`);const l=document.createElement("div");l.className="section-row__label",l.textContent=s;const d=document.createElement("div");d.className="section-row__controls";const f=document.createElement("button");f.type="button",f.className="move-btn move-btn--up",f.disabled=0===o,f.setAttribute("title","Monter"),f.setAttribute("aria-label",`Monter ${s}`),f.addEventListener("click",()=>Lt(n,-1));const p=document.createElement("button");p.type="button",p.className="move-btn move-btn--down",p.disabled=o===t.length-1,p.setAttribute("title","Descendre"),p.setAttribute("aria-label",`Descendre ${s}`),p.addEventListener("click",()=>Lt(n,1));const m=document.createElement("label");m.className="visibility-toggle",m.setAttribute("title",a?"Toujours visible":r?"Masquer":"Afficher");const g=document.createElement("input");g.type="checkbox",g.checked=r,g.disabled=a,g.setAttribute("aria-label",a?`${s} toujours visible`:`Afficher ${s}`);const y=document.createElement("span");if(y.className="visibility-toggle__slider",m.appendChild(g),m.appendChild(y),g.addEventListener("change",()=>{a||(g.checked?nn.delete(n):nn.add(n),St(nn),B(Array.from(nn)),Rt())}),d.appendChild(f),d.appendChild(p),a){const e=document.createElement("span");e.className="section-row__lock",e.textContent="Fixe",e.setAttribute("title","Toujours visible"),d.appendChild(e)}d.appendChild(m),c.appendChild(u),c.appendChild(l),c.appendChild(d),e.appendChild(c)})}const Pt=[4,8,16,32,64],Gt=["auto","minimal","low","medium","high"],Dt=["none","minimal","low","medium","high"],qt="[data-help]",Kt="[data-section]",Ft="[data-section-settings]",Ut="is-section-hidden",Vt="[data-key-input]",$t="[data-key-save]",jt="[data-license-input]",Yt="[data-license-status]";let Bt={gemini:!1,openai:!1},Jt=null,zt=null,Ht=!1,Xt=!1,Qt=!1,Wt=!1,Zt=!1,en=[],tn=[],nn=new Set,on=new Map,sn="",an=null;const rn=new Set;let cn=null,un=!1,ln=[];const dn={gemini:t.geminiModel,openai:t.openaiModel},fn={gemini:[{id:"gemini-3-pro-preview",label:"Gemini 3 Pro Preview",prices:{input:2,output:12,cachedInput:.2},costLevel:3,reasoningLevel:3,warning:!0},{id:"gemini-3-flash-preview",label:"Gemini 3 Flash Preview",prices:{input:.5,output:3,cachedInput:.05},costLevel:2,reasoningLevel:2,recommended:!0},{id:"gemini-2.5-flash-lite",label:"Gemini 2.5 Flash Lite",prices:{input:.1,output:.4,cachedInput:.01},costLevel:1,reasoningLevel:1}],openai:[{id:"gpt-5.2",label:"GPT-5.2",prices:{input:1.75,output:14,cachedInput:.175},costLevel:3,reasoningLevel:3,supportsReasoningNone:!0,warning:!0},{id:"gpt-5-mini",label:"GPT-5 Mini",prices:{input:.25,output:2,cachedInput:.025},costLevel:2,reasoningLevel:2,recommended:!0,supportsReasoningNone:!1},{id:"gpt-5-nano",label:"GPT-5 Nano",prices:{input:.05,output:.4,cachedInput:.005},costLevel:1,reasoningLevel:1,supportsReasoningNone:!1}]},pn={gemini:new Map(fn.gemini.map(e=>[e.id.toLowerCase(),e])),openai:new Map(fn.openai.map(e=>[e.id.toLowerCase(),e]))},mn={gemini:"Gemini",openai:"OpenAI"};function gn(e,t){const n=Math.max(1,Number(t)||1);return new Array(n+1).join(e)}function yn(e,t){const n=String(e||"").toLowerCase(),o=String(t||"").trim().toLowerCase(),i=pn[n];if(i&&o&&i.has(o))return i.get(o);const s=dn[n];return i&&s&&i.has(s.toLowerCase())?i.get(s.toLowerCase()):null}function En(e,t){const n=ht("geminiReasoningEffort");if(!n)return"";const o=function(e){const t=String(e||"").trim().toLowerCase();return t.includes("gemini-3")&&t.includes("flash")?["auto","minimal","low","medium","high"]:t.includes("gemini-3")?["auto","low","high"]:t.includes("gemini-2.5")?["auto","minimal","low","medium","high"]:["auto","low","high"]}(e);let i=hn(t,Gt);i||(i=Gt[0]),o.includes(i)||("minimal"===i&&(i="low"),"medium"===i&&(i="high")),i=function(e,t,n){if(!e)return t[0]||"";if(t.includes(e))return e;const o=n.indexOf(e);if(o<0)return t[0]||"";let i=t[0]||"",s=Number.POSITIVE_INFINITY;for(const e of t){const t=n.indexOf(e);if(t<0)continue;const a=Math.abs(t-o);a<s&&(s=a,i=e)}return i}(i,o,Gt);const s=Gt.indexOf(i);return n.value=String(s>=0?s:0),n.setAttribute("aria-valuetext",i),i}function hn(e,t=Dt){const n=String(e||"").trim().toLowerCase();if(!n)return"";const o=Number(n);return Number.isFinite(o)?t[Math.min(t.length-1,Math.max(0,Math.round(o)))]||"":n}function In(e,t){const n=ht("openaiReasoningEffort");if(!n)return"";const o=function(e){const t=String(e||"").trim().toLowerCase(),n=pn.openai?.get(t);return!n||"boolean"!=typeof n.supportsReasoningNone||n.supportsReasoningNone}(e),i=n.closest(".reasoning");i&&i.classList.toggle("reasoning--no-none",!o),n.dataset.allowNone=o?"1":"0";const s=o?Dt:Dt.slice(1);let a=hn(t);s.includes(a)||(a=s[0]||"minimal");const r=Dt.indexOf(a);return n.value=String(r>=0?r:0),n.setAttribute("aria-valuetext",a),a}function wn(e){const t=Number(e);if(!Number.isFinite(t))return`${At}0`;const n=t>=1?2:3;let o=t.toFixed(n);return o=o.replace(/\.?0+$/,""),`${At}${o}`}function An(e){return{cost:gn("$",e.costLevel),reasoning:gn("ðŸ§ ",e.reasoningLevel)}}function vn(e){const t=An(e),n=e.recommended?"â˜… ":"";return`${e.warning?"! ":""}${n}${e.id} | ${t.cost} | ${t.reasoning}`}function kn(t,n){const o=t===e.GEMINI,i=ht(o?"geminiModel":"openaiModel"),s=ht(o?"geminiModelWarning":"openaiModelWarning");if(!i||!s)return;const a=yn(t,n||i.value),r=!!a?.warning;s.classList.toggle("is-hidden",!r),i.classList.toggle("input--warning",r)}function _n(e){if(!e)return 0;const t=yn(String(e.provider||"").toLowerCase(),e.model);if(!t)return 0;const n=Math.max(0,Number(e.inputTokens||0)),o=Math.max(0,Number(e.outputTokens||0)),i=Math.max(0,Number(e.reasoningTokens||0)),s=Math.max(0,Number(e.cachedInputTokens||0)),a=o+i,r=Math.min(s,n),c=Math.max(0,n-r),u=t.prices||{};return c/1e6*Number(u.input||0)+r/1e6*Number(u.cachedInput??u.input??0)+a/1e6*Number(u.output||0)}function Tn(e){const t=Number(e);return!Number.isFinite(t)||t<=0?0:Math.floor(t)}function Nn(e){return{provider:e?.provider||"",inputTokens:Number(e?.inputTokens||0),outputTokens:Number(e?.outputTokens||0),reasoningTokens:Number(e?.reasoningTokens||0),cachedInputTokens:Number(e?.cachedInputTokens||0),totalTokens:Number(e?.totalTokens||0),ok:!!e?.ok,cache:!!e?.cache,ms:Number(e?.ms||0),fn:e?.fn||"AI",model:e?.model||"",ts:Number(e?.ts||0),message:e?.message||"",reasoningEffort:e?.reasoningEffort||"",call:e?.call||"",formula:e?.formula||""}}function bn(e,t,n){if(!t)return;const o=fn[e]||[],i=String(n||"").trim(),s=i.toLowerCase(),a=dn[e]||"";t.innerHTML="";let r=!1;for(const e of o){const n=document.createElement("option");n.value=e.id,n.textContent=vn(e),e.warning&&(n.dataset.warning="1",n.style.color="#b03524",n.style.fontWeight="700"),e.id.toLowerCase()===s&&(n.selected=!0,r=!0),t.appendChild(n)}if(i&&!r){const e=document.createElement("option");return e.value=i,e.textContent=`${i} | hors liste`,e.selected=!0,void t.appendChild(e)}!i&&a&&(t.value=a)}function Sn(e,t){const n=ht(e);n&&(n.classList.toggle("is-open",t),n.setAttribute("aria-hidden",t?"false":"true"))}function Cn(e){const t=ht(e);return!!t&&t.classList.contains("is-open")}function On(e){Sn("settingsModal",e)}function Mn(e){Sn("pricingModal",e)}function Ln(e){Sn("onboardingModal",e)}function xn(e){Sn("onboardingKeysModal",e)}function Rn(){Mn(!1)}function Pn(e,t){const n=!!t;document.querySelectorAll(`[data-key-status][data-key-status="${e}"]`).forEach(e=>{e.textContent=n?"ClÃ© enregistrÃ©e":"ClÃ© manquante",e.classList.toggle("key-status--ok",n),e.classList.toggle("key-status--missing",!n)})}function Gn(){document.querySelectorAll(Vt).forEach(t=>{const n=String(t.dataset.keyInput||"").trim().toLowerCase();n===e.GEMINI?t.placeholder=Bt.gemini?"ClÃ© enregistrÃ©e (laisser vide pour conserver)":"AIza...":n===e.OPENAI&&(t.placeholder=Bt.openai?"ClÃ© enregistrÃ©e (laisser vide pour conserver)":"sk-...")})}function Dn(){return!!Bt.gemini||!!Bt.openai}function qn(){const e=document.querySelector('[data-section="onboarding"]');if(!e)return;if(!Xt||!Ht||!Wt)return;const t=!(Jt&&Jt.key&&Et(Jt)&&(Bt.gemini&&Bt.openai||Qt&&Dn()));e.classList.toggle("is-hidden",!t),t&&e.classList.contains(Ut)&&(nn.delete("onboarding"),Mt(Array.from(nn)))}function Kn(t,n){const o=t===e.GEMINI,i=ht(o?"geminiModel":"openaiModel"),s=ht(o?"geminiReasoningEffort":"openaiReasoningEffort"),a=ht(o?"geminiModelGate":"openaiModelGate"),r=!n;i&&(i.disabled=r),s&&(s.disabled=r),a&&a.classList.toggle("is-hidden",!r)}function Fn(){Kn(e.GEMINI,!!Bt.gemini),Kn(e.OPENAI,!!Bt.openai),function(){const e=ht("providerGemini"),t=ht("providerOpenAI"),n=!!Bt.gemini,o=!!Bt.openai;e&&(e.disabled=!n),t&&(t.disabled=!o);const i=ht("configProviderGate");if(!i)return;const s=ht("configProviderGateText");let a="";n||o||(a="Ajoutez une clÃ© API pour activer Gemini ou OpenAI."),i.classList.toggle("is-hidden",!a),s&&(s.textContent=a)}()}function Un(e){const t=String(e||"").trim();if(!t)return 0;const n=Date.parse(t);return Number.isFinite(n)?n:0}function Vn(e){const t=Un(e);return t?function(e){try{return new Date(e).toLocaleDateString("fr-FR",{year:"numeric",month:"short",day:"2-digit"})}catch{return""}}(t):""}function $n(e,t,n){e&&(e.textContent=t||"",e.classList.toggle("key-status--ok",n),e.classList.toggle("key-status--missing",!n))}function jn(e,t){document.querySelectorAll(Yt).forEach(n=>{$n(n,e,t)})}function Yn(e,t={}){const{focus:n=!1,persist:o=!0}=t,i=ht("licenseEntry"),s=ht("licenseSubscribe");if(!i)return;i.classList.toggle("is-hidden",!e),o&&(zt=e),s&&s.classList.toggle("is-hidden",e);const a=ht("licenseModeSubscribe"),r=ht("licenseModeHave");if(a&&r&&(a.classList.toggle("segmented__btn--active",!e),r.classList.toggle("segmented__btn--active",e),a.setAttribute("aria-selected",e?"false":"true"),r.setAttribute("aria-selected",e?"true":"false")),e&&n){const e=ht("licenseKeyInput");e&&e.focus()}}async function Bn(e={}){const{silent:t=!1}=e,n=await gt();Jt=n,Xt=!0,function(e){const t=function(e){if(!e||!e.key)return{ok:!1,text:"Aucune licence enregistrÃ©e"};if(Et(e)){const t=Vn(e.expiresAt);return{ok:!0,text:"Licence active"+(t?` Â· renouvellement le ${t}`:"")}}const t=Un(e.expiresAt);return{ok:!1,text:t&&t<=Date.now()?"Licence expirÃ©e":"Licence invalide"}}(e);document.querySelectorAll(Yt).forEach(e=>{$n(e,t.text,t.ok)})}(n);const o=!(!n||!n.key||Et(n));Yn(null===zt?o:zt,{persist:!1}),function(e){const t=e?.key?"ClÃ© enregistrÃ©e (laisser vide pour conserver)":"AAAA-BBBB-CCCC-DDDD";document.querySelectorAll(jt).forEach(e=>{e.placeholder=t})}(n),function(e){const t=document.querySelectorAll("[data-license-meta]");if(!t.length)return;let n="ClÃ© reÃ§ue par email aprÃ¨s achat (mensuel ou annuel)";if(e&&Et(e)&&e.expiresAt){const t=Vn(e.expiresAt);n=t?`Renouvellement le ${t}`:"Licence active"}else if(e&&!Et(e)){const t=Vn(e.expiresAt);n=t?`Licence expirÃ©e le ${t}`:"Licence invalide"}t.forEach(e=>{e.textContent=n})}(n),function(e){const t=ht("setupLicenseStep");if(!t)return;const n=!(!e||!Et(e));t.classList.toggle("is-hidden",n)}(n),qn(),!t&&n&&Et(n)&&It("Licence active",{expiresAt:n.expiresAt||"n/a"})}function Jn(e){const t=Number(e);return Number.isFinite(t)?Math.min(17,Math.max(7,Math.round(t))):7}function zn(e){return 2**Jn(e)}function Hn(t){const n=t===e.GEMINI;ht("providerGemini").classList.toggle("segmented__btn--active",n),ht("providerOpenAI").classList.toggle("segmented__btn--active",!n),ht("providerGemini").setAttribute("aria-pressed",n?"true":"false"),ht("providerOpenAI").setAttribute("aria-pressed",n?"false":"true")}function Xn(e){const t=Number(e);return Number.isFinite(t)?Math.max(0,Math.min(Pt.length-1,Math.round(t))):0}function Qn(e){return Pt[Xn(e)]}function Wn(){const e=Qn(Xn(ht("concurrencyRange").value));return ht("concurrencyValue").textContent=wt(e),e}function Zn(e){const t="gemini"===e;ht("tabGemini").classList.toggle("tab--active",t),ht("tabOpenAI").classList.toggle("tab--active",!t),ht("tabGemini").setAttribute("aria-selected",t?"true":"false"),ht("tabOpenAI").setAttribute("aria-selected",t?"false":"true"),ht("panelGemini").classList.toggle("tab-panel--active",t),ht("panelOpenAI").classList.toggle("tab-panel--active",!t)}async function eo(t={}){const{preserveKeyInputs:n=!1,silent:o=!1}=t;ht("storageBackend").textContent=l().kind;const[i,s,a,r,c,u,d,f,p,m]=await Promise.all([_(),R(),q(),C(e.GEMINI),C(e.OPENAI),b(e.GEMINI),b(e.OPENAI),O(),M(),F()]);Hn(i);const g=function(e){const t=Number(e);return!Number.isFinite(t)||t<=0?7:Jn(Math.log2(t))}(s),y=zn(g);ht("maxTokensRange").value=String(g),ht("maxTokensValue").textContent=wt(y),y!==s&&await P(y);const E=function(e){const t=Number(e);if(!Number.isFinite(t))return 0;let n=0,o=Math.abs(Pt[0]-t);for(let e=1;e<Pt.length;e+=1){const i=Math.abs(Pt[e]-t);i<o&&(o=i,n=e)}return n}(a),h=Qn(E);ht("concurrencyRange").value=String(E),ht("concurrencyValue").textContent=wt(h),h!==a&&await K(h);const I=ht("geminiModel"),w=ht("openaiModel");bn(e.GEMINI,I,r),bn(e.OPENAI,w,c);const A=I?I.value:r,v=w?w.value:c,k=En(A,f);k&&k!==f&&await x(k);const T=In(v,p),N=T||p;T&&T!==p&&await L(T),kn(e.GEMINI,A),kn(e.OPENAI,v),n||document.querySelectorAll(Vt).forEach(e=>{e.value=""}),Bt={gemini:!!u,openai:!!d},Gn(),Qt=!!m,Wt=!0,u||d||!m||(Qt=!1,await U(!1)),Ht=!0,Pn(e.GEMINI,u),Pn(e.OPENAI,d),Fn(),qn(),o||It("Configuration chargÃ©e",{defaultProvider:i,maxOutputTokens:y,gemini:{key:u?"set":"missing",model:r,reasoningEffort:k},openai:{key:d?"set":"missing",model:c,reasoningEffort:N}})}function to(e,t,n,o){const i=document.createElement("div");i.className="breakdown__row "+(o?"breakdown__row--sub":"breakdown__row--total");const s=document.createElement("div");if(s.className="breakdown__name",o){const t=document.createElement("span");t.className="breakdown__model",t.textContent=e,s.appendChild(t)}else s.textContent=e;const a=document.createElement("div");a.className="breakdown__tokens",a.textContent=`${wt(t)} tokens`;const r=document.createElement("div");return r.className="breakdown__cost",r.textContent=vt(n),i.appendChild(s),i.appendChild(a),i.appendChild(r),i}async function no(){!function(e){const t=ht("queueStatus");if(!t)return;const n=Number(e?.active||0),o=Number(e?.queued||0),i=Math.max(0,n)+Math.max(0,o);if(i<=0)return void t.classList.add("is-hidden");t.classList.remove("is-hidden");const s=ht("queueStatusText");s&&(s.textContent=function(e){const t=Number(e);return!Number.isFinite(t)||t<=0?"":`${wt(t)} requete${t>1?"s":""} en cours`}(i));const a=ht("queueStop");a&&a.classList.toggle("is-hidden",o<=0)}(await async function(){const e=await g(n.RUNTIME_STATUS);if(!e)return V(null);try{return V(JSON.parse(e))}catch{return V(null)}}())}async function oo(){const t=(await async function(e={}){const t=!!e?.fresh,n=H();return t||!ge||n-ye>1500?await _e(!0):await _e(!1),pe.slice()}({fresh:!0})).map(Nn).sort((e,t)=>t.ts-e.ts);ln=t;const n=await async function(e={}){const t=!!e?.fresh,n=H();return t||!we||n-Ae>1500?await Ce(!0):await Ce(!1),function(e){try{return JSON.parse(JSON.stringify(e||Se()))}catch{return Se()}}(he)}({fresh:!0}),{total:o,breakdown:i}=function(t){const n=t&&"object"==typeof t?t:{},o={gemini:{tokens:0,cost:0,models:new Map},openai:{tokens:0,cost:0,models:new Map}},i={inputTokens:Tn(n.inputTokens),reasoningTokens:Tn(n.reasoningTokens),outputTokens:Tn(n.outputTokens),cachedInputTokens:Tn(n.cachedInputTokens),cost:0,requests:Tn(n.requests),byProvider:{gemini:{tokens:0,cost:0},openai:{tokens:0,cost:0}}},s={gemini:{input:0,output:0,reasoning:0,cached:0},openai:{input:0,output:0,reasoning:0,cached:0}};for(const t of[e.GEMINI,e.OPENAI]){const e=n.byProvider&&"object"==typeof n.byProvider?n.byProvider[t]:null,a=Tn(e?.inputTokens),r=Tn(e?.outputTokens),c=Tn(e?.reasoningTokens),u=Tn(e?.cachedInputTokens);s[t]={input:a,output:r,reasoning:c,cached:u};const l=e?.models&&"object"==typeof e.models?e.models:{};let d=0,f=0;for(const[e,n]of Object.entries(l)){if(!n||"object"!=typeof n)continue;const i=Tn(n.inputTokens),s=Tn(n.outputTokens),a=Tn(n.reasoningTokens),r=Tn(n.cachedInputTokens),c=i+s+a;if(c<=0&&r<=0)continue;const u="string"==typeof n.label?n.label:"",l=String(e||"").trim(),p=(u||l).trim(),m=!p||"unknown"===p.toLowerCase(),g=m?"modele inconnu":p,y=_n({provider:t,model:m?"":p,inputTokens:i,outputTokens:s,reasoningTokens:a,cachedInputTokens:r}),E=g.toLowerCase(),h=o[t].models.get(E)||{label:g,tokens:0,cost:0};h.tokens+=c,h.cost+=y,o[t].models.set(E,h),d+=c,f+=y}0===d&&(d=a+r+c),o[t].tokens=d,o[t].cost=f,i.byProvider[t].tokens=d,i.byProvider[t].cost=f}return i.inputTokens||(i.inputTokens=s.gemini.input+s.openai.input),i.outputTokens||(i.outputTokens=s.gemini.output+s.openai.output),i.reasoningTokens||(i.reasoningTokens=s.gemini.reasoning+s.openai.reasoning),i.cachedInputTokens||(i.cachedInputTokens=s.gemini.cached+s.openai.cached),i.cost=i.byProvider.gemini.cost+i.byProvider.openai.cost,{total:i,breakdown:o}}(n);ht("usageTokensTotal").textContent=wt(o.inputTokens+o.reasoningTokens+o.outputTokens),ht("usageTokensInTotal").textContent=wt(o.inputTokens),ht("usageTokensReasoningTotal").textContent=wt(o.reasoningTokens),ht("usageTokensOutTotal").textContent=wt(o.outputTokens),ht("usageCostTotal").textContent=vt(o.cost);const s=ht("usageSummary");s&&(s.textContent=vt(o.cost)),ht("usageCostGemini").textContent=vt(o.byProvider.gemini.cost),ht("usageCostOpenAI").textContent=vt(o.byProvider.openai.cost),function(t){const n=ht("usageBreakdown");if(!n)return;n.innerHTML="";const o=[e.GEMINI,e.OPENAI];for(const e of o){const o=t[e]||{tokens:0,cost:0,models:new Map};n.appendChild(to(mn[e]||e,o.tokens,o.cost,!1));const i=Array.from(o.models.values()).filter(e=>(e.tokens||0)>0||(e.cost||0)>0).sort((e,t)=>t.tokens-e.tokens||e.label.localeCompare(t.label));for(const e of i)n.appendChild(to(e.label,e.tokens,e.cost,!0))}}(i),ro(t),function(e){const t=ht("usageChart");if(!t)return;const n=t.getContext("2d");if(!n)return;const o=t.clientWidth||320,i=t.clientHeight||140,s=window.devicePixelRatio||1;t.width=o*s,t.height=i*s,n.setTransform(s,0,0,s,0,0);const a=Date.now()-36e5,r=new Array(60).fill(0);for(const t of e){if(!t.ts||t.ts<a)continue;const e=Math.floor((t.ts-a)/6e4);e>=0&&e<r.length&&(r[e]+=Math.max(0,t.inputTokens+t.reasoningTokens+t.outputTokens))}const c=Math.max(...r,1),u=getComputedStyle(document.documentElement).getPropertyValue("--accent-2").trim()||"#2a9d8f";n.clearRect(0,0,o,i),n.strokeStyle="rgba(38, 70, 83, 0.12)",n.lineWidth=1;for(let e=1;e<=3;e++){const t=i/4*e;n.beginPath(),n.moveTo(0,t),n.lineTo(o,t),n.stroke()}n.beginPath(),r.forEach((e,t)=>{const s=t/(r.length-1)*o,a=i-e/c*(i-12)-6;0===t?n.moveTo(s,a):n.lineTo(s,a)});const l=n.createLinearGradient(0,0,0,i);l.addColorStop(0,"rgba(42, 157, 143, 0.35)"),l.addColorStop(1,"rgba(42, 157, 143, 0.02)"),n.lineWidth=2,n.strokeStyle=u,n.stroke(),n.lineTo(o,i),n.lineTo(0,i),n.closePath(),n.fillStyle=l,n.fill()}(t)}function io(e){const t=Number(e||0);return t>=8e3?"token-heat--extreme":t>=4e3?"token-heat--hot":t>=1500?"token-heat--warm":"token-heat--cool"}function so(e){const t=e.call||e.formula||"";return[e.ts||0,e.fn||"",e.provider||"",e.model||"",t].join("|")}function ao(){const e=ht("logFilterErrors");e&&(e.classList.toggle("is-active",un),e.setAttribute("aria-pressed",un?"true":"false"))}function ro(e){const t=ht("logList");t.innerHTML="";const n=function(e){return un?e.filter(e=>!e.ok):e}(e||[]);if(!n.length){const e=document.createElement("div");return e.className="log-item log-item--empty",e.textContent=un?"Aucune erreur enregistrÃ©e pour le moment":"Aucune activitÃ© enregistrÃ©e pour le moment",void t.appendChild(e)}const o=(e,t)=>{const n=document.createElement("span");n.className="token-flow";const o=document.createElement("span");o.className="token-flow__icon",o.textContent=e;const i=document.createElement("span");return i.className="token-flow__value",i.textContent=wt(t),n.appendChild(o),n.appendChild(i),n},i=n.slice(0,40),s=new Set;for(const e of i){const n=document.createElement("div"),i=e.cache?" log-item--cache":"";n.className=`log-item ${e.ok?"log-item--ok":"log-item--error"}${i}`;const a=document.createElement("div");a.className="log-item__top";const r=document.createElement("div");r.className="log-item__title";const c=document.createElement("span");c.className="log-item__title-text",c.textContent=e.fn,r.appendChild(c);const u=String(e.call||e.formula||"").trim();let l=null;if(u){const t=so(e);s.add(t);const o=document.createElement("button");o.className="log-item__toggle",o.type="button",o.setAttribute("aria-expanded","false"),o.setAttribute("aria-label","Afficher la fonction");const i=document.createElement("span");i.className="log-item__chevron",o.appendChild(i),rn.has(t)&&(n.classList.add("log-item--expanded"),o.setAttribute("aria-expanded","true"),o.setAttribute("aria-label","Masquer la fonction")),o.addEventListener("click",()=>{const e=n.classList.toggle("log-item--expanded");o.setAttribute("aria-expanded",e?"true":"false"),o.setAttribute("aria-label",e?"Masquer la fonction":"Afficher la fonction"),e?rn.add(t):rn.delete(t)}),r.appendChild(o),l=document.createElement("div"),l.className="log-item__detail",l.textContent=u}const d=document.createElement("div");d.style.display="flex",d.style.gap="6px";const f=document.createElement("span");f.className="tag",f.textContent=e.provider?e.provider.toUpperCase():"â€”",d.appendChild(f);const p=document.createElement("span");if(p.className="tag "+(e.ok?"":"tag--error"),p.textContent=e.ok?"OK":"Erreur",d.appendChild(p),e.cache){const e=document.createElement("span");e.className="tag tag--cache",e.textContent="Cache",d.appendChild(e)}a.appendChild(r),a.appendChild(d);const m=document.createElement("div");m.className="log-item__meta";const g=Math.max(0,e.inputTokens+e.reasoningTokens+e.outputTokens),y=e.model?e.model:"",E=e.reasoningEffort?e.reasoningEffort:"",h=kt(e.ms),I=[y,E].filter(Boolean).join(" Â· "),w=document.createElement("div");w.className="log-item__info";const A=`${_t(e.ts)} Â· ${h}`,v=I?` Â· ${I}`:"";if(!e.ok&&e.message?w.textContent=`${A}${v} Â· ${e.message.slice(0,60)}`:w.textContent=`${A}${v}`,e.cache){const e=document.createElement("div");e.className="log-item__cache",e.textContent="Cache local",m.appendChild(e)}else{const t=document.createElement("div");t.className="log-item__tokens";const n=document.createElement("div");n.className="log-item__tokens-line";const i=document.createElement("span");i.className=`log-item__heat ${io(g)}`;const s=document.createElement("span");s.className="log-item__tokens-total",s.textContent=`${wt(g)} tokens`;const a=document.createElement("span");a.className="log-item__tokens-detail",a.appendChild(document.createTextNode("(")),a.appendChild(o("IN",e.inputTokens)),a.appendChild(document.createTextNode(" / ")),a.appendChild(o("REF",e.reasoningTokens)),a.appendChild(document.createTextNode(" / ")),a.appendChild(o("OUT",e.outputTokens)),a.appendChild(document.createTextNode(")")),n.appendChild(i),n.appendChild(s),n.appendChild(a),t.appendChild(n),m.appendChild(t)}m.appendChild(w),n.appendChild(a),l&&n.appendChild(l),n.appendChild(m),t.appendChild(n)}rn.forEach(e=>{s.has(e)||rn.delete(e)})}function co(e){Zt=!!e;const t=ht("privacyModeToggle");t&&(t.checked=Zt);const n=ht("privacyModeStatus");n&&(n.textContent=Zt?"ActivÃ©":"DÃ©sactivÃ©",n.classList.toggle("is-active",Zt));const o=ht("privacyModeHint");o&&(o.textContent=Zt?"Journal et cache persistants dÃ©sactivÃ©s.":"Journal et cache persistants activÃ©s.");const i=ht("cacheStatus");i&&(i.textContent=Zt?"DÃ©sactivÃ©":"Actif",i.classList.toggle("chip--success",!Zt),i.classList.toggle("chip--muted",Zt))}async function uo(){co(await j())}async function lo(){const t=await async function(){if(await j())return{entries:0,sizeBytes:0,providers:{gemini:{entries:0,sizeBytes:0},openai:{entries:0,sizeBytes:0}},oldestMs:null,newestMs:null};const t=re(await se(),await ie());if(t.removedKeys.length){for(const e of t.removedKeys)await ce(e);await ae(t.list)}const n={entries:0,sizeBytes:0,providers:{gemini:{entries:0,sizeBytes:0},openai:{entries:0,sizeBytes:0}},oldestMs:null,newestMs:null};for(const o of t.list||[]){if(!o?.key)continue;n.entries+=1,n.sizeBytes+=Number(o.size||0);const t=String(o.provider||"").toLowerCase();t===e.GEMINI?(n.providers.gemini.entries+=1,n.providers.gemini.sizeBytes+=Number(o.size||0)):t===e.OPENAI&&(n.providers.openai.entries+=1,n.providers.openai.sizeBytes+=Number(o.size||0));const i=Number(o.savedAtMs||0);i&&(n.oldestMs=null==n.oldestMs?i:Math.min(n.oldestMs,i),n.newestMs=null==n.newestMs?i:Math.max(n.newestMs,i))}return n}();ht("cacheEntries").textContent=wt(t.entries),ht("cacheSize").textContent=function(e){const t=Number(e);return!Number.isFinite(t)||t<=0?"0 KB":t<1024?`${t} B`:t<1048576?`${(t/1024).toFixed(1)} KB`:`${(t/1048576).toFixed(2)} MB`}(t.sizeBytes),ht("cacheGeminiEntries").textContent=wt(t.providers.gemini.entries),ht("cacheOpenAIEntries").textContent=wt(t.providers.openai.entries)}async function fo(o={}){const{silent:i=!1,message:s="Configuration enregistrÃ©e"}=o,a=ht("providerGemini").classList.contains("segmented__btn--active")?e.GEMINI:e.OPENAI,r=zn(Jn(ht("maxTokensRange").value)),c=await async function(e){const o=I(e)||t.provider;return await y(n.DEFAULT_PROVIDER,o),o}(a),u=await P(r);return i||It(s,{defaultProvider:c,maxOutputTokens:u}),{savedProvider:c,savedTokens:u}}function po(e={}){const{focusKey:t=!1}=e,n=document.querySelector('[data-section="onboarding"]');if(n){if(n.classList.remove("is-hidden"),n.classList.contains(Ut)&&(nn.delete("onboarding"),Mt(Array.from(nn))),n.classList.contains("is-collapsed")){n.classList.remove("is-collapsed");const e=n.querySelector("[data-collapse-toggle]");e&&e.setAttribute("aria-expanded","true")}if("function"==typeof n.scrollIntoView&&n.scrollIntoView({behavior:"smooth",block:"start"}),t){const e=n.querySelector(Vt);e&&e.focus()}}}function mo(){document.querySelectorAll(qt).forEach(e=>{e.classList.remove("is-open");const t=e.querySelector("button");t&&t.setAttribute("aria-expanded","false")})}async function go(e={}){const{silent:t=!1}=e;return Dn()?(Qt=!0,Wt=!0,await U(!0),qn(),!0):(t||It("Ajoutez au moins une clÃ© API avant de valider",{ok:!1}),!1)}async function yo(e,t){const n=(t||"").trim();return!!n&&(await async function(e,t){const n=(t||"").trim();return await y(T(e),n),n}(e,n),Bt[e]=!0,Ht=!0,Gn(),Fn(),qn(),!0)}async function Eo(e,t){const n=await yo(e,t?.value||"");n&&(t&&(t.value=""),Pn(e,n),It("ClÃ© enregistrÃ©e",{provider:e}))}async function ho(n){const o=n===e.GEMINI,i=ht(o?"geminiModel":"openaiModel");if(!i)return;const s=(i.value||"").trim();await async function(n,o){const i=I(n),s=String(o||"").trim();s?await y(S(i),s):await y(S(i),i===e.OPENAI?t.openaiModel:t.geminiModel)}(n,s);let a="";if(o){const e=ht("geminiReasoningEffort");a=En(s,e?e.value:""),a&&await x(a)}else{const e=ht("openaiReasoningEffort");a=In(s,e?e.value:""),a&&await L(a)}It("Configuration enregistrÃ©e",{provider:n,model:s,reasoningEffort:a||void 0}),kn(n,s)}function Io(e,t){e&&e.classList.toggle("input--warning",t)}async function wo(e,t){const n=(e?.value||"").trim();if(Io(e,!1),!n)return Io(e,!0),jn("Entrez votre clÃ© de licence",!1),void It("ClÃ© de licence manquante",{ok:!1});const o=t?.textContent||"";t&&(t.disabled=!0,t.textContent="Activation...");const i=await async function(e,t={}){const n=ut(e);if(!n||n.length<5)return{success:!1,error:"Cle trop courte"};const o=await gt();if(!t.force&&o&&o.key===n&&Et(o))return{success:!0,license:o,cached:!0};try{const{ok:e,status:t,data:i}=await ft("https://api.lemonsqueezy.com/v1/licenses/activate",{license_key:n,instance_name:ct});if(!e)return{success:!1,error:dt(i,`Erreur API (${t})`)};if(i?.activated){const e=pt(n,i,{activatedAt:o?.activatedAt});return await J(e),{success:!0,license:e}}return{success:!1,error:dt(i,"Cle invalide")}}catch{return{success:!1,error:"Erreur de connexion internet"}}}(n);if(t&&(t.disabled=!1,t.textContent=o),i.success)return e&&(e.value=""),await Bn({silent:!0}),It("Licence activÃ©e",{expiresAt:i.license?.expiresAt||"n/a"}),void function(e,t={}){const{duration:n=2600}=t,o=ht("statusToast");o&&(o.textContent=e||"",o.classList.add("is-visible"),cn&&(clearTimeout(cn),cn=null),cn=setTimeout(()=>{o.classList.remove("is-visible")},n))}("Licence enregistrÃ©e");const s=i.error||"ClÃ© invalide";Io(e,!0),jn(s,!1),It("Ã‰chec de l'activation",{error:s})}async function Ao(e=!0){e&&await async function(e=!0){return await y(n.ONBOARDING_SEEN,e?"1":"0"),e}(!0),xn(!1),Ln(!1)}async function vo(e){await async function(e){await E(T(e))}(e),await eo({silent:!0}),It("ClÃ© effacÃ©e",{provider:e})}async function ko(e){It("Test en coursâ€¦",{provider:e});const t=await async function(e){const t=I(e)||await _(),n=await C(t);return await N(t)?await tt({provider:t,system:"You are a test endpoint. Reply with exactly: OK",user:"OK",maxOutputTokens:500,cache:!1,webSearch:!1,functionName:"AI.MINIMAL_TEST"}):{ok:!1,provider:t,model:n,code:"API_KEY_MISSING",message:`ClÃ© API manquante pour le fournisseur ${t}.`}}(e);t.ok?It("OK",{provider:t.provider,model:t.model,response:t.text}):It("Ã‰chec",{provider:t.provider,model:t.model,error:t.message,code:t.code})}async function _o(){document.querySelectorAll("[data-collapse-toggle]").forEach(e=>{const t=e.getAttribute("aria-controls"),n=e.closest("[data-collapsible]");if(!t||!n)return;if(!document.getElementById(t))return;const o=n.classList.contains("is-collapsed");e.setAttribute("aria-expanded",o?"false":"true"),e.addEventListener("click",()=>{const t=!n.classList.contains("is-collapsed");n.classList.toggle("is-collapsed",t),e.setAttribute("aria-expanded",t?"false":"true")})}),function(){let e=!1;const t=()=>{e||(e=!0,setTimeout(async()=>{e=!1,await oo(),await lo(),await no(),await uo(),await Bn({silent:!0})},250))};try{if("undefined"!=typeof OfficeRuntime&&OfficeRuntime?.storage?.onChanged){const e=OfficeRuntime.storage.onChanged;"function"==typeof e.add?e.add(()=>t()):"function"==typeof e.addListener?e.addListener(()=>t()):"function"==typeof e&&e(()=>t())}}catch{}try{window.addEventListener("storage",()=>t())}catch{}}(),document.querySelectorAll(qt).forEach(e=>{const t=e.querySelector("button");t&&(t.setAttribute("aria-expanded","false"),t.addEventListener("click",n=>{n.stopPropagation();const o=e.classList.contains("is-open");mo();const i=!o;e.classList.toggle("is-open",i),t.setAttribute("aria-expanded",i?"true":"false")}))}),document.addEventListener("click",e=>{e.target.closest(qt)||mo()}),await async function(){if(an=document.querySelector(".app__main"),!an)return;const e=Array.from(an.querySelectorAll(Kt));on=new Map,e.forEach(e=>{const t=Tt(e);t&&on.set(t,e)});const t=await async function(){await h();const e=await g(n.SECTION_ORDER);if(!e)return[];try{return Y(JSON.parse(e))}catch{return[]}}(),o=e.map(e=>Tt(e)).filter(Boolean);tn=o.slice(),en=function(e,t){const n=[],o=new Set;if(Array.isArray(e))for(const t of e)t&&!o.has(t)&&on.has(t)&&(o.add(t),n.push(t));for(const e of t)e&&!o.has(e)&&(o.add(e),n.push(e));return n}(t,o),bt(en),nn=new Set(await async function(){await h();const e=await g(n.SECTION_HIDDEN);if(!e)return[];try{return Y(JSON.parse(e))}catch{return[]}}()),Ct(),St(nn),Rt(),function(){const e=ht("sectionManagerList");e&&(e.addEventListener("dragstart",e=>{const t=e.target.closest(".section-row__handle");if(!t)return;const n=t.closest(".section-row");n&&(sn=n.dataset.sectionKey||"",n.classList.add("is-dragging"),e.dataTransfer&&(e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",sn)))}),e.addEventListener("dragover",t=>{if(!sn)return;t.preventDefault();const n=t.target.closest(".section-row");if(!n||n.dataset.sectionKey===sn)return;!function(e){e.querySelectorAll(".section-row").forEach(e=>{e.classList.remove("is-drop-before","is-drop-after")})}(e);const o=n.getBoundingClientRect(),i=t.clientY<o.top+o.height/2;n.classList.toggle("is-drop-before",i),n.classList.toggle("is-drop-after",!i)}),e.addEventListener("dragleave",e=>{const t=e.target.closest(".section-row");t&&t.classList.remove("is-drop-before","is-drop-after")}),e.addEventListener("drop",t=>{if(!sn)return;t.preventDefault();const n=t.target.closest(".section-row"),o=n&&n.dataset.sectionKey||"",i=sn;sn="",xt(e);let s=en.slice();if(o){const e=n.getBoundingClientRect();s=function(e,t,n,o){const i=e.filter(e=>e!==t),s=i.indexOf(n);if(s<0)return i.push(t),i;const a=o?s:s+1;return i.splice(a,0,t),i}(s,i,o,t.clientY<e.top+e.height/2)}else s=function(e,t){const n=e.filter(e=>e!==t);return n.push(t),n}(s,i);Ot(s)}),e.addEventListener("dragend",()=>{sn="",xt(e)}))}()}(),await async function(){const e=ht("privacyModeToggle");e&&(await uo(),e.addEventListener("change",async()=>{const t=!!e.checked;await async function(e=!1){const t=!!e;return r=t,c=H(),await y(n.PRIVACY_MODE,t?"1":"0"),t}(t),co(t),t&&(await Le(),await it()),await oo(),await lo(),It(t?"Mode confidentialitÃ© activÃ©":"Mode confidentialitÃ© dÃ©sactivÃ©",{privacyMode:t})}))}();const t=ht("settingsButton");t&&t.addEventListener("click",()=>On(!0)),document.querySelectorAll("[data-settings-open]").forEach(e=>{e.addEventListener("click",()=>On(!0))}),document.querySelectorAll("[data-settings-close]").forEach(e=>{e.addEventListener("click",()=>On(!1))});const o=ht("sectionManagerReset");o&&o.addEventListener("click",()=>{tn.length&&Ot(tn)});const i=ht("pricingHelp");i&&i.addEventListener("click",()=>(function(){const t=ht("pricingTableBodyGemini"),n=ht("pricingTableBodyOpenAI");if(!t&&!n)return;t&&(t.innerHTML=""),n&&(n.innerHTML="");const o=(e,t)=>{if(!t)return;const n=fn[e]||[];for(const e of n){const n=document.createElement("tr"),o=An(e),i=document.createElement("td");i.textContent=e.id;const s=document.createElement("td");s.className="pricing-table__col-price",s.textContent=wn(e.prices?.input);const a=document.createElement("td");a.className="pricing-table__col-price",a.textContent=wn(e.prices?.output);const r=document.createElement("td");r.className="pricing-table__col-icon",r.textContent=o.cost;const c=document.createElement("td");c.className="pricing-table__col-icon",c.textContent=o.reasoning,n.appendChild(i),n.appendChild(s),n.appendChild(a),n.appendChild(r),n.appendChild(c),t.appendChild(n)}};o(e.GEMINI,t),o(e.OPENAI,n)}(),void Mn(!0))),document.querySelectorAll("[data-modal-close]").forEach(e=>{e.addEventListener("click",()=>Rn())}),document.querySelectorAll("[data-onboarding-close]").forEach(e=>{e.addEventListener("click",async()=>Ao(!0))}),document.querySelectorAll("[data-onboarding-keys-close]").forEach(e=>{e.addEventListener("click",()=>xn(!1))});const s=ht("onboardingClose");s&&s.addEventListener("click",async()=>Ao(!0));const a=ht("onboardingDone");a&&a.addEventListener("click",async()=>Ao(!0));const u=ht("onboardingKeysButton");u&&u.addEventListener("click",async()=>{await Ao(!0),po({focusKey:!0})}),document.querySelectorAll("[data-onboarding-open]").forEach(e=>{e.addEventListener("click",()=>{On(!1),po({focusKey:!0})})});const l=ht("onboardingKeysSave");l&&l.addEventListener("click",async()=>async function(){const t=ht("onboardingGeminiKey"),n=ht("onboardingOpenAIKey"),o=await yo(e.GEMINI,t?.value||""),i=await yo(e.OPENAI,n?.value||"");t&&(t.value=""),n&&(n.value=""),Pn(e.GEMINI,Bt.gemini),Pn(e.OPENAI,Bt.openai),(o||i)&&It("ClÃ©s enregistrÃ©es",{gemini:!!o,openai:!!i}),(Bt.gemini||Bt.openai)&&(await go({silent:!0}),xn(!1))}());const d=ht("onboardingKeysLater");d&&d.addEventListener("click",()=>xn(!1)),document.addEventListener("keydown",async e=>{"Escape"===e.key&&(mo(),Cn("onboardingKeysModal")?xn(!1):Cn("onboardingModal")?await Ao(!0):Cn("settingsModal")?On(!1):Cn("pricingModal")&&Rn())}),ht("tabGemini").addEventListener("click",()=>Zn("gemini")),ht("tabOpenAI").addEventListener("click",()=>Zn("openai")),ht("providerGemini").addEventListener("click",async()=>{Hn(e.GEMINI),await fo()}),ht("providerOpenAI").addEventListener("click",async()=>{Hn(e.OPENAI),await fo()}),ht("maxTokensRange").addEventListener("input",()=>{!function(){const e=zn(Jn(ht("maxTokensRange").value));ht("maxTokensValue").textContent=wt(e)}()}),ht("maxTokensRange").addEventListener("change",async()=>{await fo()}),ht("concurrencyRange").addEventListener("input",()=>{Wn()}),ht("concurrencyRange").addEventListener("change",async()=>{await async function(e={}){const{silent:t=!1,message:n="Concurrence enregistrÃ©e"}=e,o=Wn(),i=await K(o);return t||It(n,{concurrency:i}),i}()});const f=ht("geminiReasoningEffort");f&&(f.addEventListener("input",()=>{const e=ht("geminiModel");En(e?e.value:"",f.value)}),f.addEventListener("change",async()=>{await async function(){const e=ht("geminiModel"),t=ht("geminiReasoningEffort");if(!t)return;const n=En(e?e.value:"",t.value);n&&await x(n),It("Effort de raisonnement enregistrÃ©",{geminiReasoningEffort:n})}()}));const p=ht("openaiReasoningEffort");p&&(p.addEventListener("input",()=>{const e="0"!==p.dataset.allowNone;let t=hn(p.value);e||"none"!==t||(p.value="1",t=hn(p.value)),p.setAttribute("aria-valuetext",t)}),p.addEventListener("change",async()=>{await async function(){const e=ht("openaiModel"),t=ht("openaiReasoningEffort");if(!t)return;const n=In(e?e.value:"",t.value);n&&await L(n),It("Effort de raisonnement enregistrÃ©",{openaiReasoningEffort:n})}()}));const m=ht("geminiModel");m&&m.addEventListener("change",async()=>{await ho(e.GEMINI)});const I=ht("openaiModel");I&&I.addEventListener("change",async()=>{await ho(e.OPENAI)}),document.querySelectorAll(Vt).forEach(e=>{const t=String(e.dataset.keyInput||"").trim().toLowerCase();t&&(e.addEventListener("input",()=>Io(e,!1)),e.addEventListener("change",async()=>{await Eo(t,e)}),e.addEventListener("keydown",n=>{if("Enter"!==n.key)return;n.preventDefault();const o=e.closest(".input-action")?.querySelector($t);o?o.click():Eo(t,e)}))}),document.querySelectorAll($t).forEach(e=>{const t=String(e.dataset.keySave||"").trim().toLowerCase();t&&e.addEventListener("click",async()=>{const n=e.closest(".input-action")?.querySelector(Vt);await Eo(t,n),"true"===e.dataset.keyConfirm&&await go()})});const w=ht("licenseModeSubscribe"),A=ht("licenseModeHave");w&&w.addEventListener("click",()=>Yn(!1)),A&&A.addEventListener("click",()=>Yn(!0,{focus:!0})),document.querySelectorAll(jt).forEach(e=>{e.addEventListener("input",()=>Io(e,!1)),e.addEventListener("keydown",t=>{if("Enter"!==t.key)return;t.preventDefault();const n=document.querySelector(`[data-license-activate][data-license-target="${e.id}"]`)||e.closest(".input-action, .setup-license__row")?.querySelector("[data-license-activate]");n&&wo(e,n)})}),document.querySelectorAll("[data-license-activate]").forEach(e=>{e.addEventListener("click",async()=>{const t=e.dataset.licenseTarget,n=(t?ht(t):null)||e.closest(".input-action, .setup-license__row")?.querySelector(jt);await wo(n,e)})}),document.querySelectorAll("[data-license-test]").forEach(e=>{e.addEventListener("click",async()=>{const t=e.dataset.licenseTarget,n=(t?ht(t):null)||e.closest(".input-action")?.querySelector(jt);await async function(e,t){if(!e||!t)return;const n=(e.value||"").trim(),o=Jt||await gt(),i=n||o?.key||"";if(Io(e,!1),!i)return Io(e,!0),void It("ClÃ© de licence manquante",{ok:!1});const s=t.textContent;t.disabled=!0,t.textContent="Test...";const a=await async function(e,t={}){const n=ut(e);if(!n||n.length<5)return{success:!1,error:"Cle trop courte"};const o=await gt(),i=t.instanceId||o?.instanceId||"";try{const{ok:e,status:t,data:s}=await ft("https://api.lemonsqueezy.com/v1/licenses/validate",{license_key:n,instance_id:i||void 0});return e?s?.valid?{success:!0,license:pt(n,s,{instanceId:i,activatedAt:o?.activatedAt})}:{success:!1,error:dt(s,"Cle invalide")}:{success:!1,error:dt(s,`Erreur API (${t})`)}}catch{return{success:!1,error:"Erreur de connexion internet"}}}(i);if(t.disabled=!1,t.textContent=s,a.success){const e=a.license?.expiresAt||"n/a";return o&&i===o.key?(await yt({...o,...a.license,valid:!0,lastCheckedAt:(new Date).toISOString()}),await Bn({silent:!0})):o&&o.key||jn("Licence valide (non enregistrÃ©e)",!0),void(!n||o&&i===o.key?It("Licence valide",{expiresAt:e}):It("Licence valide. Cliquez sur Activer pour l'enregistrer.",{expiresAt:e}))}const r=a.error||"ClÃ© invalide";It("Licence invalide",{error:r}),o&&i===o.key?(await yt({...o,valid:!1,lastCheckedAt:(new Date).toISOString()}),await Bn({silent:!0})):o&&o.key||jn(r,!1)}(n,e)})}),document.querySelectorAll("[data-license-clear]").forEach(e=>{e.addEventListener("click",async()=>async function(){await async function(){await z()}(),Jt=null,document.querySelectorAll(jt).forEach(e=>{e.value="",Io(e,!1)}),await Bn({silent:!0}),It("Licence effacÃ©e",{ok:!0})}())});const v=ht("clearGemini");v&&v.addEventListener("click",async()=>vo(e.GEMINI));const k=ht("clearOpenAI");k&&k.addEventListener("click",async()=>vo(e.OPENAI));const _=ht("testGemini");_&&_.addEventListener("click",async()=>ko(e.GEMINI));const T=ht("testOpenAI");T&&T.addEventListener("click",async()=>ko(e.OPENAI));const N=ht("clearUsageTotals");N&&N.addEventListener("click",async()=>{await async function(){he=Se(),we=!0,Ie=null,Ae=H(),await E(n.USAGE_TOTALS)}(),await oo(),It("Utilisation rÃ©initialisÃ©e",{ok:!0})});const b=ht("logFilterErrors");b&&b.addEventListener("click",()=>{un=!un,ao(),ro(ln)}),ao(),ht("clearLogs").addEventListener("click",async()=>{await Le(),await oo(),It("Journal effacÃ©",{ok:!0})}),ht("refreshCache").addEventListener("click",async()=>{await lo(),It("Cache actualisÃ©",{ok:!0})}),ht("clearCache").addEventListener("click",async()=>{await it(),await lo(),It("Cache vidÃ©",{ok:!0})});const S=ht("queueStop");S&&S.addEventListener("click",async()=>{!function(){if(!Ue.length)return 0;const e=Ue.splice(0,Ue.length);for(const t of e)t(Ge);Ye(),e.length}(),await no()}),Zn("gemini"),await eo(),await Bn({silent:!0}),await oo(),await lo(),await no(),await async function(){await async function(){return await h(),"1"===await g(n.ONBOARDING_SEEN)}()||Ln(!0)}(),setInterval(oo,2e3),setInterval(lo,12e3),setInterval(no,1e3)}document.addEventListener("DOMContentLoaded",async()=>{await async function(){try{"undefined"!=typeof Office&&Office?.onReady&&await Office.onReady()}catch{}}(),await _o()})})();
//# sourceMappingURL=taskpane.js.map