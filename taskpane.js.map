{"version":3,"file":"taskpane.js","mappings":"mBASO,MAAMA,EAAYC,OAAOC,OAAO,CACrCC,OAAQ,SACRC,OAAQ,WAGGC,EAAWJ,OAAOC,OAAO,CACpCI,SAAUN,EAAUG,OAEpBI,YAAa,yBACbC,YAAa,aACbC,sBAAuB,UACvBC,sBAAuB,MACvBC,gBAAiB,KACjBC,iBAAkB,EAClBC,SAAU,EAGVC,MAAO,EACPC,UAAW,KAGXC,OAAO,EACPC,YAAa,SAGTC,EAAejB,OAAOC,OAAO,CACjCiB,iBAAkB,yBAClBC,eAAgB,uBAChBC,eAAgB,uBAChBC,aAAc,qBACdC,aAAc,qBACdC,wBAAyB,gCACzBC,wBAAyB,gCACzBC,kBAAmB,0BACnBC,kBAAmB,0BACnBC,UAAW,kBACXC,gBAAiB,wBACjBC,0BAA2B,kCAC3BC,cAAe,sBACfC,eAAgB,uBAChBC,QAAS,gBACTC,aAAc,qBAGdC,eAAgB,uBAGhBC,YAAa,oBACbC,qBAAsB,6BACtBC,aAAc,qBACdC,YAAa,oBACbC,eAAgB,uBAChBC,eAAgB,uBAChBC,sBAAuB,gCAGnBC,EAAiB,IAAIC,IAAI,CAAC1B,EAAaE,eAAgBF,EAAaG,eAAgBH,EAAae,UAGjGY,EAAc5C,OAAOC,OAAO,CAChCkB,eAAgB,iBAChBM,kBAAmB,oBAEnBoB,oBAAqB,yBACrBC,kBAAmB,uBACnBC,kBAAmB,uBACnBC,gBAAiB,qBACjBC,gBAAiB,qBAEjBC,qBAAsB,iCACtBC,qBAAsB,mCAGxB,IAAIC,EAAoB,KACpBC,GAAuB,EACvBC,EAAoB,KACpBC,EAAsB,EAC1B,MAAMC,EAAwB,KAC9B,IAAIC,EAAwB,KACxBC,EAA0B,EAC1BC,EAAwB,KACxBC,EAA0B,EAC1BC,EAAwB,KACxBC,EAA0B,EAC1BC,EAAwB,KACxBC,EAA0B,EAC9B,MAAMC,EAAe,CAAEC,OAAQ,KAAMC,OAAQ,MACvCC,EAAiB,CAAEF,OAAQ,EAAGC,OAAQ,GACtCE,EAAc,CAAEH,OAAQ,KAAMC,OAAQ,MACtCG,EAAgB,CAAEJ,OAAQ,EAAGC,OAAQ,GAE3C,SAASI,IACPlB,GAAuB,CACzB,CAMA,MAAMmB,EAAiB,CACrBC,KAAM,SACNC,QAAS,MACP,MAAMC,EAAM,IAAIC,IAChB,MAAO,CACLC,QAAaC,MAACC,GACLJ,EAAIK,IAAID,GAAKJ,EAAIM,IAAIF,GAAK,KAEnC,aAAMG,CAAQH,EAAGI,GACfR,EAAIS,IAAIL,EAAGM,OAAOF,GACpB,EACA,gBAAMG,CAAWP,GACfJ,EAAIY,OAAOR,EACb,EAEH,EAbQ,IAgBX,SAASS,IACP,IAAKnC,EACH,IACE,GAA6B,oBAAlBoC,eAAiCA,eAAef,SAASI,QAClE,MAAO,CAAEL,KAAM,SAAUC,QAASe,cAAcf,QAEpD,CAAE,MACA,CAIJ,IACE,GAAsB,oBAAXgB,QAA0BA,QAAQC,cAAcb,QACzD,MAAO,CAAEL,KAAM,QAASC,QAASgB,OAAOC,aAE5C,CAAE,MACA,CAIF,OAAOnB,CACT,CAEA,SAASoB,IACP,IACE,GAAsB,oBAAXF,QAA0BA,QAAQC,cAAcb,QACzD,OAAOY,OAAOC,YAElB,CAAE,MACA,OAAO,IACT,CACA,OAAO,IACT,CAEA,SAASE,EAASC,EAAOC,GACvB,IACE,OAAOD,EAAMhB,QAAQiB,EACvB,CAAE,MACA,OAAO,IACT,CACF,CAEA,SAASC,EAASF,EAAOC,EAAKE,GAC5B,IAEE,OADAH,EAAMZ,QAAQa,EAAKE,IACZ,CACT,CAAE,MACA,OAAO,CACT,CACF,CAEA,SAASC,EAAYJ,EAAOC,GAC1B,IAEE,OADAD,EAAMR,WAAWS,IACV,CACT,CAAE,MACA,OAAO,CACT,CACF,CAMAlB,eAAesB,EAAOJ,EAAKK,EAAU,CAAC,GACpC,MAAM,KAAE3B,EAAI,QAAEC,GAAYc,IACpBa,EAAYD,EAAQC,WAxF5B,SAAwBN,GACtB,OAAOrD,EAAesC,IAAIe,EAC5B,CAsFyCO,CAAeP,GAChDQ,GAAoD,IAA/BH,EAAQG,mBAEnC,GAAa,UAAT9B,EACF,OAAOoB,EAASnB,EAASqB,GAG3B,GAAa,WAATtB,EAAmB,CACrB,IAAI+B,EAAS,KACb,IACEA,QAAe9B,EAAQI,QAAQiB,EACjC,CAAE,MACAxB,GACF,CACA,GAAc,MAAViC,EAAgB,CAClB,GAAIH,EAAW,CACb,MAAMP,EAAQF,IACVE,GAAOI,EAAYJ,EAAOC,EAChC,CACA,OAAOS,CACT,CACA,IAAKD,EAAoB,OAAO,KAEhC,MAAMT,EAAQF,IACd,IAAKE,EAAO,OAAO,KACnB,MAAMW,EAAaZ,EAASC,EAAOC,GACnC,GAAkB,MAAdU,EAAoB,OAAO,KAE/B,IAAKpD,EACH,UACQqB,EAAQQ,QAAQa,EAAKV,OAAOoB,IAClCP,EAAYJ,EAAOC,EACrB,CAAE,MACAxB,GACF,CAGF,OAAOkC,CACT,CAEA,IACE,aAAa/B,EAAQI,QAAQiB,EAC/B,CAAE,MACA,OAAO,IACT,CACF,CAEAlB,eAAe6B,EAAOX,EAAKE,EAAOG,EAAU,CAAC,GAC3C,MAAM,KAAE3B,EAAI,QAAEC,GAAYc,IACpBL,EAAa,MAATc,EAAgB,GAAKZ,OAAOY,GAChCM,GAAoD,IAA/BH,EAAQG,mBAEnC,GAAa,UAAT9B,EAAJ,CAKA,GAAa,WAATA,EAAmB,CACrB,IAAIkC,GAAS,EACb,UACQjC,EAAQQ,QAAQa,EAAKZ,GAC3BwB,GAAS,CACX,CAAE,MACApC,GACF,CAEA,MAAMuB,EAAQF,IACd,GAAIe,EAEF,YADIb,GAAOI,EAAYJ,EAAOC,IAIhC,IAAKQ,IAAuBT,EAAO,OAEnC,YADAE,EAASF,EAAOC,EAAKZ,EAEvB,CAEA,UACQT,EAAQQ,QAAQa,EAAKZ,EAC7B,CAAE,MACA,CAzBF,MAFEa,EAAStB,EAASqB,EAAKZ,EA6B3B,CAEAN,eAAe+B,EAAUb,GACvB,MAAM,KAAEtB,EAAI,QAAEC,GAAYc,IAE1B,GAAa,UAATf,EAAJ,CAKA,GAAa,WAATA,EAAmB,CACrB,IAAIoC,GAAU,EACd,UACQnC,EAAQY,WAAWS,GACzBc,GAAU,CACZ,CAAE,MACAtC,GACF,CAEA,MAAMuB,EAAQF,IAEd,YADIE,GAAOI,EAAYJ,EAAOC,GAEhC,CAEA,UACQrB,EAAQY,WAAWS,EAC3B,CAAE,MACA,CAnBF,MAFEG,EAAYxB,EAASqB,EAuBzB,CAEAlB,eAAeiC,IACb,GAAI1D,EAAmB,OAAOA,EAE9BA,EAAoB,WAGlB,GAAa,YADM+C,EAAOlF,EAAaiB,gBACvC,CAIA,IADwB6E,QAAwBZ,EAAOlF,EAAaC,mBAC9C,CACpB,MAAM8F,EAAiBD,QAAwBZ,EAAOvD,EAAYC,4BAC5D6D,EAAOzF,EAAaC,iBAAkB8F,GAAkB5G,EAASC,SACzE,CAIA,UADmB8F,EAAOlF,EAAaE,gBAC5B,CACT,MAAM8F,QAAgBd,EAAOvD,EAAYE,0BAA8BqD,EAAOvD,EAAYzB,gBACtF8F,SAAcP,EAAOzF,EAAaE,eAAgB8F,EACxD,CAGA,UADmBd,EAAOlF,EAAaG,gBAC5B,CACT,MAAM6F,QAAed,EAAOvD,EAAYG,mBACpCkE,SAAcP,EAAOzF,EAAaG,eAAgB6F,EACxD,CAIA,UADqBd,EAAOlF,EAAaI,cAC5B,CACX,MAAM4F,QAAed,EAAOvD,EAAYI,uBAClC0D,EAAOzF,EAAaI,aAAc4F,GAAU7G,EAASE,YAC7D,CAGA,UADqB6F,EAAOlF,EAAaK,cAC5B,CACX,MAAM2F,QAAed,EAAOvD,EAAYK,uBAClCyD,EAAOzF,EAAaK,aAAc2F,GAAU7G,EAASG,YAC7D,CAIA,UADkB4F,EAAOlF,EAAaQ,mBAC5B,CACR,MAIMyF,EAAa,OAJSf,EAAOvD,EAAYnB,yBACvB0E,EAAOvD,EAAYM,4BACnBiD,EAAOvD,EAAYO,uBAGxCgE,IAAKC,GAAMC,SAAShC,OAAO+B,GAAK,IAAIE,OAAQ,KAC5CC,OAAQC,GAAMC,OAAOC,SAASF,IAAMA,EAAI,GAErCG,EAAWT,EAAWU,OAASC,KAAKC,OAAOZ,GAAc9G,EAASM,sBAClEgG,EAAOzF,EAAaQ,kBAAmB4D,OAAOsC,GACtD,OAEMjB,EAAOzF,EAAaiB,eAAgB,IAlDlB,CAmDzB,EAtDmB,GAwDpB,UACQkB,CACR,CAAE,QACAA,EAAoB,IACtB,CACF,CAEO,SAAS2D,EAAkBgB,GAChC,IAAKA,EAAG,MAAO,GACf,MAAMC,EAAI3C,OAAO0C,GAAGT,OAAOW,cAC3B,OAAID,IAAMjI,EAAUG,OAAeH,EAAUG,OACzC8H,IAAMjI,EAAUI,OAAeJ,EAAUI,OAEnC,WAAN6H,GAAwB,QAANA,EAAoBjI,EAAUG,OAC1C,QAAN8H,GAAqB,YAANA,EAAwBjI,EAAUI,OAC9C,EACT,CAEA,MAAM+H,EAA2B,IAAIvF,IAAI,CAAC,OAAQ,UAAW,MAAO,SAAU,SACxEwF,EAA2B,IAAIxF,IAAI,CAAC,OAAQ,UAAW,MAAO,SAAU,SAE9E,SAASyF,EAA+BnC,GACtC,MAAMd,EAAIE,OAAOY,GAAS,IAAIqB,OAAOW,cACrC,OAAK9C,GACE+C,EAAyBlD,IAAIG,GAAKA,EAD1B/E,EAASI,qBAE1B,CAEA,SAAS6H,EAAyBpC,GAChC,MAAMd,EAAIE,OAAOY,GAAS,IAAIqB,OAAOW,cACrC,OAAK9C,GACEgD,EAAyBnD,IAAIG,GAAKA,EAD1B/E,EAASK,qBAE1B,CAEOoE,eAAeyD,IACpB,MAAMC,EAAMC,KACZ,GAAI/E,GAAyB8E,EAAM7E,EAA0BF,EAC3D,OAAOC,QAEHqD,IACN,MAAMiB,EAAIhB,QAAwBZ,EAAOlF,EAAaC,oBAAsBd,EAASC,SAGrF,OAFAoD,EAAwBsE,EACxBrE,EAA0B6E,EACnBR,CACT,CAUA,SAASU,EAAOpI,GAEd,OADU0G,EAAkB1G,KAClBN,EAAUI,OAAec,EAAaG,eACzCH,EAAaE,cACtB,CAEO0D,eAAe6D,EAAUrI,GAC9B,MAAM0H,EAAIhB,EAAkB1G,KAAcN,EAAUI,OAASJ,EAAUI,OAASJ,EAAUG,OACpFqI,EAAMC,KACZ,GAAuB,MAAnBvE,EAAa8D,IAAcQ,EAAMnE,EAAe2D,GAAKvE,EACvD,OAAQS,EAAa8D,IAAM,IAAIT,aAE3BR,IACN,MAAM/B,QAAWoB,EAAOsC,EAAOV,KAAQ,GACjCY,EAAUtD,OAAON,GAAGuC,OAG1B,OAFArD,EAAa8D,GAAKY,EAClBvE,EAAe2D,GAAKQ,EACbI,CACT,CAEO9D,eAAe+D,EAAUvI,GAE9B,cADgBqI,EAAUrI,EAE5B,CAkBA,SAASwI,EAASxI,GAEhB,OADU0G,EAAkB1G,KAClBN,EAAUI,OAAec,EAAaK,aACzCL,EAAaI,YACtB,CAEOwD,eAAeiE,EAASzI,GAC7B,MAAM0H,EAAIhB,EAAkB1G,KAAcN,EAAUI,OAASJ,EAAUI,OAASJ,EAAUG,OACpFqI,EAAMC,KACNO,EAAS1E,EAAY0D,GAC3B,GAAIgB,GAAUR,EAAMjE,EAAcyD,GAAKvE,EAAuB,OAAOuF,QAC/DjC,IACN,MAAMkC,QAAY7C,EAAO0C,EAASd,IAC5BkB,EAAYD,GAAO3D,OAAO2D,GAAK1B,OACjCjC,OAAO2D,GAAK1B,OACXS,IAAMhI,EAAUI,OAASC,EAASG,YAAcH,EAASE,YAG9D,OAFA+D,EAAY0D,GAAKkB,EACjB3E,EAAcyD,GAAKQ,EACZU,CACT,CAEOpE,eAAeqE,IACpB,MAAMX,EAAMC,KACZ,GAAI3E,GAAyB0E,EAAMzE,EAA0BN,EAC3D,OAAOK,QAEHiD,IACN,MACM3B,EAAIiD,QADQjC,EAAOlF,EAAaM,0BACUnB,EAASI,uBAGzD,OAFAqD,EAAwBsB,EACxBrB,EAA0ByE,EACnBpD,CACT,CAEON,eAAesE,IACpB,MAAMZ,EAAMC,KACZ,GAAIzE,GAAyBwE,EAAMvE,EAA0BR,EAC3D,OAAOO,QAEH+C,IACN,MACM3B,EAAIkD,QADQlC,EAAOlF,EAAaO,0BACIpB,EAASK,uBAGnD,OAFAsD,EAAwBoB,EACxBnB,EAA0BuE,EACnBpD,CACT,CAkBON,eAAeuE,EAAyBnD,GAC7C,MAAMd,EAAIkD,EAAyBpC,GAInC,aAHMS,EAAOzF,EAAaO,wBAAyB2D,GACnDpB,EAAwBoB,EACxBnB,EAA0BwE,KACnBrD,CACT,CAEON,eAAewE,EAAyBpD,GAC7C,MAAMd,EAAIiD,EAA+BnC,GAIzC,aAHMS,EAAOzF,EAAaM,wBAAyB4D,GACnDtB,EAAwBsB,EACxBrB,EAA0B0E,KACnBrD,CACT,CAEON,eAAeyE,IACpB,MAAMf,EAAMC,KACZ,GAAI7E,GAAyB4E,EAAM3E,EAA0BJ,EAC3D,OAAOG,QAEHmD,IACN,MAAMkC,QAAY7C,EAAOlF,EAAaQ,mBAEhC0D,EAAIoE,GADAlC,SAAShC,OAAO2D,GAAO,IAAI1B,OAAQ,IACvB,EAAG,MAAQlH,EAASM,iBAG1C,OAFAiD,EAAwBwB,EACxBvB,EAA0B2E,EACnBpD,CACT,CAEON,eAAe2E,EAAmBvD,GACvC,MAAMuB,EAAI+B,GAAStD,EAAO,EAAG,MAAQ7F,EAASM,iBAI9C,aAHMgG,EAAOzF,EAAaQ,kBAAmB4D,OAAOmC,IACpD7D,EAAwB6D,EACxB5D,EAA0B4E,KACnBhB,CACT,CAEA,MAAMiC,EAAsB,CAAC,EAAG,EAAG,GAAI,GAAI,GAAI,KAE/C,SAASC,EAA0BzD,GACjC,MAAM0D,EAAOJ,GACXtD,EACAwD,EAAoB,GACpBA,EAAoBA,EAAoB7B,OAAS,GACjDxH,EAASO,kBAEX,GAAI8I,EAAoBG,SAASD,GAAO,OAAOA,EAC/C,IAAIE,EAAOJ,EAAoB,GAC3BK,EAAWjC,KAAKkC,IAAIJ,EAAOE,GAC/B,IAAK,MAAMG,KAAUP,EAAoBQ,MAAM,GAAI,CACjD,MAAMC,EAAOrC,KAAKkC,IAAIJ,EAAOK,GACzBE,EAAOJ,IACTD,EAAOG,EACPF,EAAWI,EAEf,CACA,OAAOL,CACT,CAEOhF,eAAesF,IAGpB,aAFMrD,IAEC4C,QADWvD,EAAOlF,EAAaS,mBAExC,CAEOmD,eAAeuF,EAAoBnE,GACxC,MAAMoE,EAAaX,EAA0BzD,GAE7C,aADMS,EAAOzF,EAAaS,kBAAmB2D,OAAOgF,IAC7CA,CACT,CAKA,SAASC,GAAkBrE,GAEzB,OAAOsD,GADoB,iBAAVtD,EAAqBoB,SAASpB,EAAMqB,OAAQ,IAAMG,OAAOxB,GAJ5D,EACA,IAIuB7F,EAASQ,SAChD,CAEOiE,eAAe0F,KAGpB,aAFMzD,IAECwD,SADWnE,EAAOlF,EAAaU,WAExC,CAEOkD,eAAe2F,GAAYvE,GAChC,MAAMoE,EAAaC,GAAkBrE,GAErC,aADMS,EAAOzF,EAAaU,UAAW0D,OAAOgF,IACrCA,CACT,CAaOxF,eAAe4F,KAGpB,aAFM3D,IAES,YADGX,EAAOlF,EAAaY,0BAExC,CAEOgD,eAAe6F,GAA2BC,GAAY,GAE3D,aADMjE,EAAOzF,EAAaY,0BAA2B8I,EAAY,IAAM,KAChEA,CACT,CAEA,SAASC,GAAuB5B,GAE9B,OAAKA,GAAsB,iBAARA,EAKZ,CAAE6B,OAJMtB,GAASP,EAAI6B,OAAQ,EAAG,IAAQ,GAI9BC,OAHFvB,GAASP,EAAI8B,OAAQ,EAAG,IAAQ,GAGtBC,IAFbxB,GAASP,EAAI+B,IAAK,EAAG,IAAS,GAEZC,GADnBzB,GAASP,EAAIgC,GAAI,EAAGvD,OAAOwD,iBAAkB,IAL3C,CAAEJ,OAAQ,EAAGC,OAAQ,EAAGC,IAAK,EAAGC,GAAI,EAOnD,CAYOnG,eAAeqG,GAAiBC,GACrC,MAAMd,EAAaO,GAAuBO,GAE1C,aADMzE,EAAOzF,EAAauB,eAAgB4I,KAAKC,UAAUhB,IAClDA,CACT,CAgBOxF,eAAeyG,KACpB,aAbFzG,iBACE,MAAM0D,EAAMC,KACZ,GAAyB,MAArBlF,GAA6BiF,EAAMhF,EAJP,IAK9B,OAAOD,EAET,MACMiI,EAAkB,YADNpF,EAAOlF,EAAagB,cAItC,OAFAqB,EAAoBiI,EACpBhI,EAAsBgF,EACfgD,CACT,CAGeC,EACf,CAUA,SAASC,GAAqBxF,GAC5B,IAAKyF,MAAMC,QAAQ1F,GAAQ,MAAO,GAClC,MAAM2F,EAAM,GACNC,EAAO,IAAIlJ,IACjB,IAAK,MAAMmJ,KAAQ7F,EAAO,CACxB,MAAMF,EAAMV,OAAOyG,GAAQ,IAAIxE,OAC1BvB,IAAO8F,EAAK7G,IAAIe,KACrB8F,EAAKE,IAAIhG,GACT6F,EAAII,KAAKjG,GACX,CACA,OAAO6F,CACT,CA8BO/G,eAAeoH,GAAkBC,GACtC,MAAM7B,EAAaoB,GAAqBS,GAExC,aADMxF,EAAOzF,EAAac,eAAgBqJ,KAAKC,UAAUhB,IAClDA,CACT,CAaOxF,eAAesH,GAAWC,GAC/B,OAAKA,SAIC1F,EAAOzF,EAAae,QAASoJ,KAAKC,UAAUe,IAC3CA,UAJCxF,EAAU3F,EAAae,SACtB,KAIX,CAEO6C,eAAewH,WACdzF,EAAU3F,EAAae,QAC/B,CAGO,SAASwG,KACd,OAAO8D,KAAK/D,KACd,CAEO,SAASgE,GAAMC,GACpB,OAAO,IAAIC,QAASC,GAAYC,WAAWD,EAASF,GACtD,CAQO,SAASjD,GAAStD,EAAO2G,EAAK9E,EAAK+E,EAAWD,GACnD,MAAMpF,EAAIH,SAAShC,OAAOY,GAAQ,IAClC,OAAKwB,OAAOC,SAASF,GACdK,KAAKC,IAAI8E,EAAK/E,KAAK+E,IAAI9E,EAAKN,IADHqF,CAElC,CAEA,MAAMC,GAAkB,CACtB,6BACA,8BACA,0CAGK,SAASC,GAAoB9G,GAClC,GAAa,MAATA,EAAe,MAAO,GAC1B,IAAI+G,EAAO3H,OAAOY,GAClB,IAAK,MAAMgH,KAAWH,GACpBE,EAAOA,EAAKE,QAAQD,EAAS,cAE/B,OAAOD,CACT,CAEO,SAASG,GAAqBlH,GACnC,GAAa,MAATA,EAAe,OAAOA,EAC1B,GAAqB,iBAAVA,EAAoB,OAAO8G,GAAoB9G,GAC1D,GAAIyF,MAAMC,QAAQ1F,GAAQ,OAAOA,EAAMkB,IAAIgG,IAC3C,GAAqB,iBAAVlH,EAAoB,CAC7B,MAAM2F,EAAM,CAAC,EACb,IAAK,MAAO7F,EAAKqH,KAAUpN,OAAOqN,QAAQpH,GACxC2F,EAAI7F,GAAOoH,GAAqBC,GAElC,OAAOxB,CACT,CACA,OAAO3F,CACT,CAEA,SAASqH,GAAiBtE,GACxB,MAAMxB,EAAIH,SAAShC,OAAO2D,GAAO,IAAI1B,OAAQ,IAC7C,OAAOG,OAAOC,SAASF,IAAMA,EAAI,EAAIA,EAAI,CAC3C,CA0CA,MAAM+F,GAAqB,qBAErBC,GAAwB,QAE9B,IAAIC,GAAgB,EAChBC,GAAuB,IAAI9I,IAC3B+I,IAA6B,EAC7BC,GAA8B,KAclC/I,eAAegJ,KACb,MAAMC,EAAYR,SAAuBnH,EAAOlF,EAAasB,iBAE7D,OADIuL,EAAYL,KAAeA,GAAgBK,GACxCL,EACT,CAMA5I,eAAekJ,KACb,MAAM/E,QAAY7C,EAAOlF,EAAaqB,aACtC,IAAK0G,EAAK,MAAO,GACjB,IACE,MAAMgF,EAAM5C,KAAK6C,MAAMjF,GACvB,OAAO0C,MAAMC,QAAQqC,GAAOA,EAAM,EACpC,CAAE,MACA,MAAO,EACT,CACF,CAEAnJ,eAAeqJ,GAAeb,GAC5B,UACQ3G,EAAOzF,EAAaqB,YAAa8I,KAAKC,UAAUgC,GACxD,CAAE,MACA,CAEJ,CAEA,SAASc,GAAgBd,EAASS,EAAY,GAC5C,MAAMvF,EAAMC,KACN4F,EAAO,GACPC,EAAc,GAEpB,IAAK,MAAMjB,KAASC,GAAW,GAAI,CACjC,IAAKD,IAAUA,EAAMrH,IAAK,SAC1B,MAAMuI,EAAU7G,OAAO2F,EAAMmB,WAAa,GACtCT,KAAerG,OAAOC,SAAS4G,IAAYA,GAAWR,IAItDV,EAAMoB,aAAepB,EAAMoB,aAAejG,EAH5C8F,EAAYrC,KAAKoB,EAAMrH,KAOzBqI,EAAKpC,KAAKoB,EACZ,CAEA,IAAIqB,EAAY,EAChB,IAAK,MAAMrB,KAASgB,EAAMK,GAAahH,OAAO2F,GAAOsB,MAAQ,GAE7D,GAAIN,EAAKxG,OAvEqB,KAuEe6G,EAAYjB,GAAuB,CAC9EY,EAAKO,KAAK,CAACC,EAAGC,KAAOD,EAAEL,WAAa,IAAMM,EAAEN,WAAa,IACzD,IAAIO,EAAY,EAChB,KAAOV,EAAKxG,OAASkH,EA1EO,KA0EgCL,EAAYjB,IAAuB,CAC7F,MAAMJ,EAAQgB,EAAKU,GACnB,IAAK1B,EAAO,MACZiB,EAAYrC,KAAKoB,EAAMrH,KACvB0I,GAAahH,OAAO2F,GAAOsB,MAAQ,GACnCI,GAAa,CACf,CACA,MAAO,CAAE5C,KAAMkC,EAAKnE,MAAM6E,GAAYT,cACxC,CAEA,MAAO,CAAEnC,KAAMkC,EAAMC,cACvB,CAEAxJ,eAAekK,GAAiBhJ,GACzBA,SACCa,EAAU2G,GAAqBxH,EACvC,CAEAlB,eAAemK,GAAqBjJ,GAClC,MAAMkJ,QAAclB,KACdmB,GAAQD,GAAS,IAAI1H,OAAQuE,GAASA,GAAM/F,MAAQA,GACtDmJ,EAAKtH,SAAWqH,EAAMrH,cAAcsG,GAAegB,EACzD,CAkCOrK,eAAesK,GAAmBC,EAAUnJ,EAAOoJ,EAAOC,EAAO,CAAC,GACvE,IAAKF,EAAU,OACf,SAAU9D,KAAkB,OAC5B,MAAM/C,EAAMC,KACNsF,QAAkBD,KAClBU,EAAYT,GAAavF,GAAOuF,EAAYA,EAAY,EAAIvF,EAC5DiG,EAA+B,iBAAVa,GAAsBA,EAAQ,EAAId,EAAYc,EAAQ,KAC3EjC,EAAQ,CACZjI,EAAG,EACHoJ,YACAC,cACAvI,SAGI+C,EAAMoC,KAAKC,UAAU+B,GACrBsB,EAzIR,SAA2BzI,GACzB,GAAqB,iBAAVA,EAAoB,OAAO,EACtC,IACE,GAA2B,oBAAhBsJ,YACT,OAAO,IAAIA,aAAcC,OAAOvJ,GAAO2B,MAE3C,CAAE,MACA,CAEF,OAAO3B,EAAM2B,MACf,CA+He6H,CAAkBzG,GAC/B,GAAI0F,EAAOlB,GAGT,aAFMuB,GAAiBK,cACjBJ,GAAqBI,SAGvB1I,EAAO6G,GAAqB6B,EAAUpG,GAE5C,MAAMiG,QAAclB,KACd1N,EAAWiP,EAAKjP,UAAY4F,GAAO5F,UAAY,GAC/CqP,EAAQJ,EAAKI,OAASzJ,GAAOyJ,OAAS,GAE5C,IAAIC,GAAU,EACd,MAAMT,GAAQD,GAAS,IAAI9H,IAAK2E,GAC1BA,GAAM/F,MAAQqJ,EAAiBtD,GACnC6D,GAAU,EACH,CACL5J,IAAKqJ,EACL/O,WACAqP,QACAhB,OACAH,YACAC,iBAICmB,GACHT,EAAKlD,KAAK,CACRjG,IAAKqJ,EACL/O,WACAqP,QACAhB,OACAH,YACAC,gBAIJ,MAAMoB,EAASzB,GAAgBe,EAAMpB,GACrC,IAAK,MAAM/H,KAAO6J,EAAOvB,kBAAmBU,GAAiBhJ,SACvDmI,GAAe0B,EAAO1D,KAC9B,CAsEA,SAAS2D,GAA2BzC,GAClC,IAAKA,GAA0B,iBAAVA,EAAoB,OAAO,KAChD,MAAMrH,EAAMV,OAAO+H,EAAMrH,KAAO,IAAIuB,OAC9BwI,EAAOzK,OAAO+H,EAAM0C,MAAQ,IAAIxI,OACtC,OAAKvB,GAAQ+J,EAGN,CAAE/J,MAAK+J,OAAMvB,UAFF9G,OAAO2F,EAAMmB,WAAa,GAEbC,YADX/G,OAAO2F,EAAMoB,aAAe,IAFtB,IAI5B,CAEA3J,eAAekL,GAAwBC,GAAQ,GAC7C,GAAIpC,GAA6B,OAAOA,GAExCA,GAA8B,WAC5B,IAAKoC,GAASrC,GAA4B,OAAOD,GAIjD,GAHAA,GAAuB,IAAI9I,IAC3B+I,IAA6B,QAEnBrC,KAAkB,OAAOoC,GAEnC,MAAM1E,QAAY7C,EAAOlF,EAAawB,uBACtC,IAAKuG,EAAK,OAAO0E,GACjB,IAAIM,EAAM,GACV,IACE,MAAMiC,EAAS7E,KAAK6C,MAAMjF,GACtB0C,MAAMC,QAAQsE,KAASjC,EAAMiC,EACnC,CAAE,MACAjC,EAAM,EACR,CAEA,MAAMzF,EAAMC,KACZ,IAAK,MAAMsD,KAAQkC,EAAK,CACtB,MAAMZ,EAAQyC,GAA2B/D,GACpCsB,IACDA,EAAMoB,aAAepB,EAAMoB,aAAejG,GAC9CmF,GAAqBtI,IAAIgI,EAAMrH,IAAKqH,GACtC,CACA,OAAOM,EACR,EAzB6B,GA2B9B,IACE,aAAaE,EACf,CAAE,QACAA,GAA8B,IAChC,CACF,CAEA,SAASsC,KACP,MAAMC,EAASzC,GAAqBgB,KAC9BnG,EAAMC,KACZ,IAAI6E,EAAU3B,MAAM0E,KAAK1C,GAAqB2C,UAAU9I,OACrD6F,IAAWA,EAAMoB,aAAepB,EAAMoB,YAAcjG,GAQvD,OANA8E,EAAQsB,KAAK,CAACC,EAAGC,KAAOA,EAAEN,WAAa,IAAMK,EAAEL,WAAa,IACxDlB,EAAQzF,OAnT4B,KAoTtCyF,EAAUA,EAAQpD,MAAM,EApTc,KAsTxCyD,GAAuB,IAAI9I,IAAIyI,EAAQlG,IAAKiG,GAAU,CAACA,EAAMrH,IAAKqH,KAE3D,CAAElB,KAAMmB,EAASxG,QADRsJ,IAAW9C,EAAQzF,OAErC,CAEA/C,eAAeyL,GAA2BpE,GACxC,IACE,SAAUZ,KAAkB,aACtB5E,EAAOzF,EAAawB,sBAAuB2I,KAAKC,UAAUa,GAClE,CAAE,MACA,CAEJ,CA2BOrH,eAAe0L,GAA+BnB,GACnD,GAAKA,UACCW,KACFrC,GAAqBnI,OAAO6J,IAAW,CACzC,MAAMQ,EAASM,WACTI,GAA2BV,EAAO1D,KAC1C,CACF,CAkBA,SAASsE,GAAavK,GACpB,GAAIyF,MAAMC,QAAQ1F,GAAQ,OAAOA,EAAMkB,IAAIqJ,IAC3C,GAVqBrL,EAUHc,EAT2B,oBAAtCjG,OAAOyQ,UAAUC,SAASC,KAAKxL,GASZ,CACxB,MAAMyG,EAAM,CAAC,EACb,IAAK,MAAM7G,KAAK/E,OAAO4Q,KAAK3K,GAAO0I,OAAQ/C,EAAI7G,GAAKyL,GAAavK,EAAMlB,IACvE,OAAO6G,CACT,CAdF,IAAuBzG,EAerB,OAAOc,CACT,CAYOpB,eAAegM,GAAQC,GAC5B,MAAM9D,EAAwB,iBAAV8D,EAAqBA,GAzBX7K,EAyBmC6K,EAxB1D1F,KAAKC,UAAUmF,GAAavK,KAD9B,IAAyBA,EA4B9B,IACE,GAAsB,oBAAX8K,QAA0BA,QAAQC,QAAQC,QAAiC,oBAAhB1B,YAA6B,CACjG,MACM2B,GADM,IAAI3B,aACEC,OAAOxC,GACnBiE,QAAeF,OAAOC,OAAOC,OAAO,UAAWC,GAErD,OADYxF,MAAM0E,KAAK,IAAIe,WAAWF,IAC3B9J,IAAK0H,GAAMA,EAAE6B,SAAS,IAAIU,SAAS,EAAG,MAAMC,KAAK,GAC9D,CACF,CAAE,MACA,CAGF,MAAO,SA1BT,SAAiBC,GACf,IAAIC,EAAI,WACR,IAAK,IAAIC,EAAI,EAAGA,EAAIF,EAAI1J,OAAQ4J,IAC9BD,GAAKD,EAAIG,WAAWD,GACpBD,EAAI1J,KAAK6J,KAAKH,EAAG,UAGnB,OAAQA,IAAM,GAAGb,SAAS,IAAIU,SAAS,EAAG,IAC5C,CAkBkBO,CAAQ3E,IAC1B,CAGA,MAEM4E,GAAqBC,IAG3B,IAAIC,GAAc,GACdC,GAAqB,KACrBC,IAAoB,EACpBC,GAA0B,EAC1BC,GAAqB,EACrBC,GAAa,GACbC,GAAiB,KACjBC,GAAmB,KAInBC,GAAeC,KACfC,GAAsB,KACtBC,IAAqB,EACrBC,GAA2B,EAC3BC,IAAoB,EAExB9N,eAAe+N,GAA0BxM,EAAU,CAAC,GAClD,MAAM0H,EAAYR,SAAuBnH,EAAOlF,EAAamB,uBAY7D,OAXI0L,EAAYoE,KACdA,GAAqBpE,EACrBgE,GAAc,GACV1L,EAAQyM,OACVb,IAAoB,EACpBD,GAAqB,KACrBE,GAA0BzJ,MAE1BwJ,IAAoB,GAGjBE,EACT,CAYA,SAASY,GAAgB1F,GACvB,QAASA,IAAsB,IAAbA,EAAM2F,EAC1B,CAEAlO,eAAemO,GAAehD,GAAQ,GACpC,GAAI+B,GAAoB,OAAOA,GAE/BA,GAAqB,WAEnB,SAD0BzG,KAMxB,OAJI0E,GAAUgC,KACZA,IAAoB,EACpBC,GAA0BzJ,MAErBsJ,GAET,MAAMhE,QAAkB8E,KACxB,IAAK5C,GAASgC,GAAmB,OAAOF,GACxC,MAAM9I,QAAY7C,EAAOlF,EAAakB,aACtC,IAAI6L,EAAM,GACV,GAAIhF,EACF,IAEEgF,EAjCR,SAA+B/H,GAC7B,GAAIyF,MAAMC,QAAQ1F,GAAQ,OAAOA,EACjC,GAAIA,GAA0B,iBAAVA,EAAoB,CACtC,MAAMgN,EAASvH,MAAMC,QAAQ1F,EAAMgN,QAAUhN,EAAMgN,OAAS,GACtDC,EAASxH,MAAMC,QAAQ1F,EAAMiN,QAAUjN,EAAMiN,OAAS,GAC5D,OAAOD,EAAOE,OAAOD,EACvB,CACA,MAAO,EACT,CAyBcE,CADShI,KAAK6C,MAAMjF,GAE5B,CAAE,MACAgF,EAAM,EACR,CAEF,MAAMzF,EAAMC,KAkBZ,OAjBAwF,EAAMA,EACH7G,IAAKkM,IACJ,IAAKA,EAAG,OAAO,KACf,IAAIrI,EAAKqI,EAAErI,GACX,GAAkB,iBAAPA,EAAiB,CAC1B,MAAMiF,EAAS3D,KAAK2B,MAAMjD,GACtBvD,OAAOC,SAASuI,KAASjF,EAAKiF,EACpC,CACA,MAAkB,iBAAPjF,EAAwB,KAC5B,IAAKqI,EAAGrI,QAEhBzD,OAAQ8L,GAAMA,GAAqB,iBAATA,EAAErI,IAAmBqI,EAAErI,GAAK8C,GAAavF,EAAM8K,EAAErI,IAAM4G,IACjFzK,IAAKkM,GAAMC,GAAiBD,IAC/BvB,GAAc9D,EACduF,KACAvB,IAAoB,EACpBC,GAA0BzJ,KACnBsJ,EACR,EAxCoB,GA0CrB,IACE,aAAaC,EACf,CAAE,QACAA,GAAqB,IACvB,CACF,CAYA,SAASwB,KACP,MAAMhL,EAAMC,KACNsF,EAAYoE,IAAsB,EAClCsB,GAAS1B,IAAe,IAAIvK,OAC/B8L,GAAMA,GAAqB,iBAATA,EAAErI,IAAmBqI,EAAErI,GAAK8C,GAAavF,EAAM8K,EAAErI,IAAM4G,IAEtE6B,EAAU,GACVP,EAAS,GACf,IAAK,MAAM9F,KAASoG,EACdV,GAAgB1F,GAAQ8F,EAAOlH,KAAKoB,GACnCqG,EAAQzH,KAAKoB,GAEpBqG,EAAQ9E,KAAK,CAACC,EAAGC,IAAMD,EAAE5D,GAAK6D,EAAE7D,IAChCkI,EAAOvE,KAAK,CAACC,EAAGC,IAAMD,EAAE5D,GAAK6D,EAAE7D,IAC/B,MAAM4E,EAAS6D,EAAQxJ,OAhIQ,IAgIyBkJ,OAAOD,EAAOjJ,OAhIvC,KAiI/B2F,EAAOjB,KAAK,CAACC,EAAGC,IAAMD,EAAE5D,GAAK6D,EAAE7D,IAC/B8G,GAAclC,CAChB,CAGA,SAAS8D,GAAYzN,GACnB,MAAMuB,EAAIC,OAAOxB,GACjB,OAAKwB,OAAOC,SAASF,IAAMA,GAAK,EAAU,EACnCK,KAAK8L,MAAMnM,EACpB,CAEA,SAAS+K,KACP,MAAO,CACLqB,YAAa,EACbC,aAAc,EACdC,gBAAiB,EACjBC,kBAAmB,EACnBC,SAAU,EACVC,aAAc,CAAC,EACfC,WAAY,CACV,CAACnU,EAAUG,QAAS,CAClB0T,YAAa,EACbC,aAAc,EACdC,gBAAiB,EACjBC,kBAAmB,EACnBC,SAAU,EACVG,OAAQ,CAAC,GAEX,CAACpU,EAAUI,QAAS,CAClByT,YAAa,EACbC,aAAc,EACdC,gBAAiB,EACjBC,kBAAmB,EACnBC,SAAU,EACVG,OAAQ,CAAC,IAIjB,CA4EA,SAASC,GAAkBjN,GACzB,IAAKA,GAAsB,iBAARA,EAAkB,MAAO,CAAC,EAC7C,MAAMoB,EAAMC,KAQNG,EAPU3I,OAAOqN,QAAQlG,GAC5BI,OAAO,EAAE,CAAEtB,KAAWA,GAA0B,iBAAVA,GACtCsB,OAAO,EAAE,CAAEtB,MACV,MAAM+E,EAAKvD,OAAOxB,EAAM+E,KAAO,EAC/B,OAAQA,GAAMzC,EAAMyC,GA3OG,QA6OxB2D,KAAK,CAACC,EAAGC,KAAOpH,OAAOmH,EAAE,GAAG5D,KAAO,IAAMvD,OAAOoH,EAAE,GAAG7D,KAAO,IACvCf,OA/OA,IAgPlB2B,EAAM,CAAC,EACb,IAAK,MAAO7F,EAAKE,KAAU0C,EACzBiD,EAAI7F,GAAOE,EAEb,OAAO2F,CACT,CAUA/G,eAAewP,GAAgBrE,GAAQ,GACrC,GAAIwC,GAAqB,OAAOA,GAEhCA,GAAsB,WAEpB,SAD0BlH,KAMxB,OAJI0E,GAAUyC,KACZA,IAAqB,EACrBC,GAA2BlK,MAEtB8J,GAGT,IAAKtC,GAASyC,GAAoB,OAAOH,GAEzC,MAAMtJ,QAAY7C,EAAOlF,EAAaoB,cACtC,IAAI4N,EAAS,KACb,GAAIjH,EACF,IACEiH,EAAS7E,KAAK6C,MAAMjF,EACtB,CAAE,MACAiH,EAAS,IACX,CAMF,OAHAqC,GA7HJ,SAA8BtJ,GAC5B,MAAMW,EAAO4I,KACb,IAAKvJ,GAAsB,iBAARA,EAAkB,OAAOW,EAE5CA,EAAKiK,YAAcF,GAAY1K,EAAI4K,aACnCjK,EAAKkK,aAAeH,GAAY1K,EAAI6K,cACpClK,EAAKmK,gBAAkBJ,GAAY1K,EAAI8K,iBACvCnK,EAAKoK,kBAAoBL,GAAY1K,EAAI+K,mBACzCpK,EAAKqK,SAAWN,GAAY1K,EAAIgL,UAChCrK,EAAKsK,aAiCP,SAA+BjL,GAC7B,IAAKA,GAAsB,iBAARA,EAAkB,MAAO,CAAC,EAC7C,MAAM4C,EAAM,CAAC,EACb,IAAK,MAAO0I,EAASrO,KAAUjG,OAAOqN,QAAQrE,GAAM,CAClD,IAAK/C,GAA0B,iBAAVA,EAAoB,SACzC,MAAMkO,EAASlO,EAAMkO,QAAkC,iBAAjBlO,EAAMkO,OAAsBlO,EAAMkO,OAAS,CAAC,EAC5EI,EAAmB,CAAC,EAC1B,IAAK,MAAOxO,EAAK2J,KAAU1P,OAAOqN,QAAQ8G,GAAS,CACjD,IAAKzE,GAA0B,iBAAVA,EAAoB,SACzC,MAAMrP,EAAWgF,OAAOqK,EAAMrP,UAAY,IAAI4H,cAC9C,GAAI5H,IAAaN,EAAUG,QAAUG,IAAaN,EAAUI,OAAQ,SACpE,MAAM0I,EAAWxD,OAAOqK,EAAM7G,UAAY6G,EAAMA,OAAS3J,GAAO,IAAIkC,cAC/DY,IACL0L,EAAiBxO,GAAO,CACtB1F,WACAwI,WACA2L,MAA8B,iBAAhB9E,EAAM8E,MAAqB9E,EAAM8E,MAAQ,GACvDZ,YAAaF,GAAYhE,EAAMkE,aAC/BC,aAAcH,GAAYhE,EAAMmE,cAChCC,gBAAiBJ,GAAYhE,EAAMoE,iBACnCC,kBAAmBL,GAAYhE,EAAMqE,mBACrCC,SAAUN,GAAYhE,EAAMsE,WAEhC,CACApI,EAAI0I,GAAW,CACbtJ,GAAIvD,OAAOxB,EAAM+E,KAAO,EACxBmJ,OAAQI,EAEZ,CACA,OAAOH,GAAkBxI,EAC3B,CA/DsB6I,CAAsBzL,EAAIiL,cAE9C,MAAMS,EAAY1L,EAAIkL,YAAwC,iBAAnBlL,EAAIkL,WAA0BlL,EAAIkL,WAAa,CAAC,EAC3F,IAAK,MAAM7T,IAAY,CAACN,EAAUG,OAAQH,EAAUI,QAAS,CAC3D,MAAMwU,EAAcD,EAAUrU,GAC9B,IAAKsU,GAAsC,iBAAhBA,EAA0B,SACrD,MAAMC,EAASjL,EAAKuK,WAAW7T,GAC/BuU,EAAOhB,YAAcF,GAAYiB,EAAYf,aAC7CgB,EAAOf,aAAeH,GAAYiB,EAAYd,cAC9Ce,EAAOd,gBAAkBJ,GAAYiB,EAAYb,iBACjDc,EAAOb,kBAAoBL,GAAYiB,EAAYZ,mBACnDa,EAAOZ,SAAWN,GAAYiB,EAAYX,UAE1C,MAAMa,EAAYF,EAAYR,QAAwC,iBAAvBQ,EAAYR,OAAsBQ,EAAYR,OAAS,CAAC,EACvG,IAAK,MAAOpO,EAAKE,KAAUjG,OAAOqN,QAAQwH,GAAY,CACpD,IAAK5O,GAA0B,iBAAVA,EAAoB,SACzC,MAAMuO,EAA+B,iBAAhBvO,EAAMuO,MAAqBvO,EAAMuO,MAAQnP,OAAOU,GAAO,IACtE8C,EAAWxD,OAAOU,GAAOyO,GAAS,IAAIvM,cACvCY,IACL+L,EAAOT,OAAOtL,GAAY,CACxB2L,QACAZ,YAAaF,GAAYzN,EAAM2N,aAC/BC,aAAcH,GAAYzN,EAAM4N,cAChCC,gBAAiBJ,GAAYzN,EAAM6N,iBACnCC,kBAAmBL,GAAYzN,EAAM8N,mBACrCC,SAAUN,GAAYzN,EAAM+N,WAEhC,CACF,CAEA,OAAOrK,CACT,CAqFmBmL,CAAqB7E,GACpCwC,IAAqB,EACrBC,GAA2BlK,KACpB8J,EACR,EA1BqB,GA4BtB,IACE,aAAaE,EACf,CAAE,QACAA,GAAsB,IACxB,CACF,CAWA,SAASuC,GAA0B3H,GACjC,IAAKA,GAA0B,iBAAVA,EAAoB,OAAO,EAEhD,GAAIA,EAAM4H,OAAStJ,MAAMC,QAAQyB,EAAM6H,aAAc,CACnD,MAAMX,EAAUlH,EAAMkH,QAAUjP,OAAO+H,EAAMkH,SAAW,GAClD/L,EAAMC,KACN0M,EAAgB,CAAC,EACvB,IAAK,MAAMpJ,KAAQsB,EAAM6H,YAAa,CACpC,IAAKnJ,GAAwB,iBAATA,EAAmB,SACvC,MAAMzL,EAAWgF,OAAOyG,EAAKzL,UAAY,IAAI4H,cAC7C,GAAI5H,IAAaN,EAAUG,QAAUG,IAAaN,EAAUI,OAAQ,SACpE,MAAMgV,EAAa9P,OAAOyG,EAAK4D,OAAS,IAAIpI,OACtCuB,GAAYsM,GAAc,WAAWlN,cACrCmN,EAAS,GAAG/U,KAAYwI,IACxBwM,EAAWH,EAAcE,IAAW,CACxC/U,WACAwI,WACA2L,MAAOW,EACPvB,YAAa,EACbC,aAAc,EACdC,gBAAiB,EACjBC,kBAAmB,EACnBC,SAAU,GAEZqB,EAASzB,aAAeF,GAAY5H,EAAK8H,aACzCyB,EAASxB,cAAgBH,GAAY5H,EAAK+H,cAC1CwB,EAASvB,iBAAmBJ,GAAY5H,EAAKgI,iBAC7CuB,EAAStB,mBAAqBL,GAAY5H,EAAKiI,mBAC/CsB,EAASrB,UAAYN,GAAY5H,EAAKkI,WACjCqB,EAASb,OAASW,IAAYE,EAASb,MAAQW,GACpDD,EAAcE,GAAUC,CAC1B,CAEA,IAAKf,EAAS,CACZ,IAAIgB,GAAU,EACd,IAAK,MAAM5F,KAAS1P,OAAOqQ,OAAO6E,GAC5BK,GAAgB7F,EAAMrP,SAAUqP,EAAM7G,SAAU6G,EAAM8E,MAAO9E,KAAQ4F,GAAU,GAErF,OAAOA,CACT,CAEA,MAAMrB,EAAe3B,GAAa2B,cAAgB,CAAC,EAC7CuB,EAAWvB,EAAaK,IAAUH,QAAU,CAAC,EAC7CvD,EAAO,IAAIjO,IAAI,IAAI3C,OAAO4Q,KAAK4E,MAAcxV,OAAO4Q,KAAKsE,KAC/D,IAAII,GAAU,EACd,IAAK,MAAMvP,KAAO6K,EAAM,CACtB,MAAM6E,EAAOP,EAAcnP,IAAQ,KAC7B2P,EAAOF,EAASzP,IAAQ,KAC9B,IAAK0P,IAASC,EAAM,SACpB,MAAMrV,GAAYoV,GAAMpV,UAAYqV,GAAMrV,UAAY,IAAI4H,cACpDY,GAAY4M,GAAM5M,UAAY6M,GAAM7M,UAAY,IAAIZ,cAC1D,GAAI5H,IAAaN,EAAUG,QAAUG,IAAaN,EAAUI,OAAQ,SACpE,IAAK0I,EAAU,SACf,MAAM8M,EAAQ,CACZ/B,aAAc6B,GAAM7B,aAAe,IAAM8B,GAAM9B,aAAe,GAC9DC,cAAe4B,GAAM5B,cAAgB,IAAM6B,GAAM7B,cAAgB,GACjEC,iBAAkB2B,GAAM3B,iBAAmB,IAAM4B,GAAM5B,iBAAmB,GAC1EC,mBAAoB0B,GAAM1B,mBAAqB,IAAM2B,GAAM3B,mBAAqB,GAChFC,UAAWyB,GAAMzB,UAAY,IAAM0B,GAAM1B,UAAY,GACrDQ,MAAOiB,GAAMjB,OAASkB,GAAMlB,OAAS,IAElCoB,GAAcD,IACfJ,GAAgBlV,EAAUwI,EAAU8M,EAAMnB,MAAOmB,KAAQL,GAAU,EACzE,CAIA,OAFArB,EAAaK,GAAW,CAAEtJ,GAAIvD,OAAO2F,EAAMpC,KAAOzC,EAAK4L,OAAQe,GAC/D5C,GAAa2B,aAAeG,GAAkBH,GACvCqB,CACT,CAEA,MAAM1B,EAAcF,GAAYtG,EAAMwG,aAChCC,EAAeH,GAAYtG,EAAMyG,cACjCC,EAAkBJ,GAAYtG,EAAM0G,iBACpCC,EAAoBL,GAAYtG,EAAM2G,mBAE5C,KADiBH,EAAcC,EAAeC,EAAkBC,EAAoB,GACrE,OAAO,EAEtB,MAAM1T,EAAWgF,OAAO+H,EAAM/M,UAAY,IAAI4H,cAC9C,GAAI5H,IAAaN,EAAUG,QAAUG,IAAaN,EAAUI,OAAQ,OAAO,EAE3E,MAAMgV,EAAa9P,OAAO+H,EAAMsC,OAAS,IAAIpI,OAG7C,OAAOiO,GAAgBlV,GAFL8U,GAAc,WAAWlN,cAEAkN,EAAY,CACrDvB,cACAC,eACAC,kBACAC,oBACAC,SAAU,GAEd,CAEA,SAAS4B,GAAcD,GACrB,OACsC,IAApClO,OAAOkO,GAAO/B,aAAe,IACQ,IAArCnM,OAAOkO,GAAO9B,cAAgB,IACU,IAAxCpM,OAAOkO,GAAO7B,iBAAmB,IACS,IAA1CrM,OAAOkO,GAAO5B,mBAAqB,IACF,IAAjCtM,OAAOkO,GAAO3B,UAAY,EAE9B,CAEA,SAASuB,GAAgBlV,EAAUwI,EAAUsM,EAAYQ,GACvD,IAAKA,EAAO,OAAO,EACnB,MAAM/B,EAAcnM,OAAOkO,EAAM/B,aAAe,GAC1CC,EAAepM,OAAOkO,EAAM9B,cAAgB,GAC5CC,EAAkBrM,OAAOkO,EAAM7B,iBAAmB,GAClDC,EAAoBtM,OAAOkO,EAAM5B,mBAAqB,GACtDC,EAAWvM,OAAOkO,EAAM3B,UAAY,GAE1C,KADiBJ,GAAeC,GAAgBC,GAAmBC,GAAqBC,GACzE,OAAO,EAEtB1B,GAAasB,YAAc/L,KAAKC,IAAI,EAAGwK,GAAasB,YAAcA,GAClEtB,GAAauB,aAAehM,KAAKC,IAAI,EAAGwK,GAAauB,aAAeA,GACpEvB,GAAawB,gBAAkBjM,KAAKC,IAAI,EAAGwK,GAAawB,gBAAkBA,GAC1ExB,GAAayB,kBAAoBlM,KAAKC,IAAI,EAAGwK,GAAayB,kBAAoBA,GAC9EzB,GAAa0B,SAAWnM,KAAKC,IAAI,EAAGwK,GAAa0B,SAAWA,GAE5D,MAAM6B,EAAiBvD,GAAa4B,WAAW7T,GAC/CwV,EAAejC,YAAc/L,KAAKC,IAAI,EAAG+N,EAAejC,YAAcA,GACtEiC,EAAehC,aAAehM,KAAKC,IAAI,EAAG+N,EAAehC,aAAeA,GACxEgC,EAAe/B,gBAAkBjM,KAAKC,IAAI,EAAG+N,EAAe/B,gBAAkBA,GAC9E+B,EAAe9B,kBAAoBlM,KAAKC,IAAI,EAAG+N,EAAe9B,kBAAoBA,GAClF8B,EAAe7B,SAAWnM,KAAKC,IAAI,EAAG+N,EAAe7B,SAAWA,GAEhE,MAAMG,EAAS0B,EAAe1B,QAAU,CAAC,EACnCkB,EAAWlB,EAAOtL,IAAa,CACnC2L,MAAOW,EACPvB,YAAa,EACbC,aAAc,EACdC,gBAAiB,EACjBC,kBAAmB,EACnBC,SAAU,GAUZ,OARKqB,EAASb,OAASW,IAAYE,EAASb,MAAQW,GACpDE,EAASzB,YAAc/L,KAAKC,IAAI,EAAGuN,EAASzB,YAAcA,GAC1DyB,EAASxB,aAAehM,KAAKC,IAAI,EAAGuN,EAASxB,aAAeA,GAC5DwB,EAASvB,gBAAkBjM,KAAKC,IAAI,EAAGuN,EAASvB,gBAAkBA,GAClEuB,EAAStB,kBAAoBlM,KAAKC,IAAI,EAAGuN,EAAStB,kBAAoBA,GACtEsB,EAASrB,SAAWnM,KAAKC,IAAI,EAAGuN,EAASrB,SAAWA,GACpDG,EAAOtL,GAAYwM,EACnBQ,EAAe1B,OAASA,GACjB,CACT,CAyBO,SAAS2B,GAAW1I,GACzB,IAAKA,GAA0B,iBAAVA,EAAoB,OACzC,MAAM2I,EAAWzC,GAAiB,CAAEtI,GAAIxC,QAAY4E,IACpD,GAAI2I,EAASf,OAASe,EAASzB,QAAS,CACtC,IAAI0B,GAAW,EACf,IAAK,IAAIxE,EAAIW,GAAWvK,OAAS,EAAG4J,GAAK,EAAGA,GAAK,EAAG,CAClD,MAAM6D,EAAWlD,GAAWX,GAC5B,GAAI6D,GAAYA,EAASL,OAASK,EAASf,UAAYyB,EAASzB,QAAS,CACvEnC,GAAWX,GAAKuE,EAChBC,GAAW,EACX,KACF,CACF,CACKA,GAAU7D,GAAWnG,KAAK+J,EACjC,MACE5D,GAAWnG,KAAK+J,GAGd5D,GAAWvK,QAlfY,GAmfpBqO,KAIH7D,KACJA,GAAiBzF,WAAW,KAC1ByF,GAAiB,KACZ6D,MA3fqB,KA6f9B,CACApR,eAAeoR,KACb,GAAI5D,GAAkB,OAAOA,GAC7B,GAAKF,GAAWvK,OAAhB,CAEAyK,GAAmB,WACjB,IACE,MAAMhF,EAAU8E,GAGhB,GAFAA,GAAa,IAER9E,EAAQzF,OAAQ,aAEfyM,KACN,IAAI6B,GAAe,EACnB,IAAK,MAAM9I,KAASC,EACd0H,GAA0B3H,KAAQ8I,GAAe,GAQvD,GANIA,IACFxD,GAA2BlK,KAC3BmK,IAAoB,SAGIrH,KAMxB,OAJAwG,GAAY9F,QAAQqB,GACpBkG,KACAvB,IAAoB,OACpBC,GAA0BzJ,YAItBoK,GAA0B,CAAEC,OAAO,IACpCb,UACGgB,KAER,IAAK,MAAM5F,KAASC,EAClB,GAAID,GAAO4H,OAAS5H,GAAOkH,QAAS,CAClC,MAAM6B,EAAMrE,GAAYsE,UAAW/C,GAAMA,GAAG2B,OAAS3B,GAAGiB,UAAYlH,EAAMkH,SACtE6B,GAAO,EAAGrE,GAAYqE,GAAO/I,EAC5B0E,GAAY9F,KAAKoB,EACxB,MACE0E,GAAY9F,KAAKoB,GAGrBmG,KACAtB,GAA0BzJ,WArchC3D,iBACE,IACE,SAAUyG,KAAkB,OAC5BiI,WACM7M,EAAOzF,EAAakB,YAAaiJ,KAAKC,UAAUyG,GAAY7H,OA3GxCoM,MA4G5B,CAAE,MACA,CAEJ,CA8bYC,GAEF3D,WA7PV9N,iBACE,IACE,SAAUyG,KAAkB,aACtB5E,EAAOzF,EAAaoB,aAAc+I,KAAKC,UAAUiH,IACzD,CAAE,MACA,CAEJ,CAuPciE,GACN5D,IAAoB,EAExB,CAAE,MACA,CAEH,EAlDkB,GAoDnB,UACQN,EACR,CAAE,QACAA,GAAmB,IACrB,CA1D8B,CA2DhC,CAEA,SAASiB,GAAiBlG,GACxB,OAAKA,GAA0B,iBAAVA,EACdD,GAAqBC,GADoBA,CAElD,CAgBOvI,eAAe2R,KACpB,MAAM1I,EAAYtF,KAClB2J,GAAa,GACTC,KACFqE,aAAarE,IACbA,GAAiB,MAEnBN,GAAc,GACdE,IAAoB,EACpBD,GAAqB,KACrBG,GAAqBpE,EACrBmE,GAA0BnE,QACpBpH,EAAOzF,EAAamB,qBAAsBiD,OAAOyI,UACjDlH,EAAU3F,EAAakB,YAC/B,CC5yDA,MAAMuU,GAAQ,IDmwBP,MACLC,WAAAA,CAAYC,EAAa,KACvBC,KAAKD,WAAaA,EAClBC,KAAK1P,IAAM,IAAIvC,GACjB,CAEAK,GAAAA,CAAIc,GACF,IAAK8Q,KAAK1P,IAAInC,IAAIe,GAAM,OAAO,KAC/B,MAAMqH,EAAQyJ,KAAK1P,IAAIlC,IAAIc,GAE3B,OAAIqH,GAAOoB,aAAepB,EAAMoB,aAAehG,MAC7CqO,KAAK1P,IAAI5B,OAAOQ,GACT,OAIT8Q,KAAK1P,IAAI5B,OAAOQ,GAChB8Q,KAAK1P,IAAI/B,IAAIW,EAAKqH,GACXA,EAAMnH,MACf,CAEAb,GAAAA,CAAIW,EAAKE,EAAOoJ,GACd,MAAMb,EAA+B,iBAAVa,GAAsBA,EAAQ,EAAI7G,KAAU6G,EAAQ,KAK/E,IAJIwH,KAAK1P,IAAInC,IAAIe,IAAM8Q,KAAK1P,IAAI5B,OAAOQ,GACvC8Q,KAAK1P,IAAI/B,IAAIW,EAAK,CAAEE,QAAOuI,gBAGpBqI,KAAK1P,IAAIuH,KAAOmI,KAAKD,YAAY,CACtC,MAAME,EAAYD,KAAK1P,IAAIyJ,OAAO1B,OAAOjJ,MACzC4Q,KAAK1P,IAAI5B,OAAOuR,EAClB,CACF,CAEAC,KAAAA,GACEF,KAAK1P,IAAI4P,OACX,GCtyByB,KAC3B,IAAIC,GAAqB,EAWzB,MAAMC,GAAW,IAAIrS,IAIfsS,GAA+B,KAG/BC,GAAyB,IAAIvS,IAG7BwS,GAAkBC,OAAO,mBACzBC,GAAyB,CAAEvE,IAAI,EAAOwE,KAAM,kBAAmBC,QAAS,2BAE9E,IAAIC,GAAyBrX,EAASO,iBAClC+W,GAA2B,EAK3BC,GAAiBvX,EAASQ,SAC1BgX,GAAmB,EACnBC,GAAY,GACZC,GAAUrL,QAAQC,UAClBqL,GAAiB,KAkCjBlN,GAAS,EACb,MAAMmN,GAAQ,IAjCd,MACErB,WAAAA,GACEE,KAAKoB,OAAS,GACdpB,KAAKqB,MAAQ,CACf,CAEA,UAAItQ,GACF,OAAOiP,KAAKoB,OAAOrQ,OAASiP,KAAKqB,KACnC,CAEAlM,IAAAA,CAAK/F,GACH4Q,KAAKoB,OAAOjM,KAAK/F,EACnB,CAEAkS,KAAAA,GACE,GAAItB,KAAKqB,OAASrB,KAAKoB,OAAOrQ,OAAQ,OACtC,MAAM3B,EAAQ4Q,KAAKoB,OAAOpB,KAAKqB,SAK/B,OAJIrB,KAAKqB,MAAQ,MAAqB,EAAbrB,KAAKqB,MAAYrB,KAAKoB,OAAOrQ,SACpDiP,KAAKoB,OAASpB,KAAKoB,OAAOhO,MAAM4M,KAAKqB,OACrCrB,KAAKqB,MAAQ,GAERjS,CACT,CAEAmS,KAAAA,GACE,MAAMC,EAAUxB,KAAKoB,OAAOhO,MAAM4M,KAAKqB,OAGvC,OAFArB,KAAKoB,OAAS,GACdpB,KAAKqB,MAAQ,EACNG,CACT,GAKF,IAAIC,GAAc,KACdC,GAAgB,KAChBC,GAAgB,GAGhBC,GAAa,KA0BjB,SAASC,KACP,OAAO7N,GAASmN,GAAMpQ,MACxB,CAEA,SAAS+Q,KACP,QAAIF,MACAC,KAlC0B,OAmC9BD,GA/BF,WACE,MAAMG,EAAYpQ,KAClB,MAAO,CACLqQ,GAAI,SAASD,KAAa/Q,KAAKiR,SAASpI,SAAS,IAAIzG,MAAM,EAAG,KAC9D2O,YACAG,QAAS,EACTC,cAAe,EACfC,QAAS,EACTC,WAAY,EACZC,YAAa,EACbvF,YAAa,EACbC,aAAc,EACdC,gBAAiB,EACjBC,kBAAmB,EACnBqF,MAAO,EACPC,MAAO,EACPC,MAAO,EACPC,WAAY,EACZC,WAAY,EACZrF,OAAQ,IAAIvP,IACZ6U,UAAW,EAEf,CASeC,IACN,EACT,CAEA,SAASC,KACFlB,KACLA,GAAWc,WAAa1R,KAAKC,IAAI2Q,GAAWc,WAAYvB,GAAMpQ,QAC9D6Q,GAAWe,WAAa3R,KAAKC,IAAI2Q,GAAWe,WAAY3O,IAC1D,CAEA,SAAS+O,IAAkB,SAAEvZ,EAAQ,MAAEqP,EAAK,GAAEqD,EAAE,OAAEhK,EAAM,UAAE8Q,EAAS,MAAEC,EAAK,GAAEtN,IAC1E,IAAKiM,GAAY,OAAO,EACxBA,GAAWO,eAAiB,EACxBjG,EAAI0F,GAAWQ,SAAW,EACzBR,GAAWS,YAAc,GAC1BnQ,GAAU8Q,KAAWpB,GAAWU,aAAe,GAEnD,MAAMvF,EAAcnM,OAAOqS,GAAOlG,aAAe,IAAM,EACjDC,EAAepM,OAAOqS,GAAOjG,cAAgB,IAAM,EACnDC,EAAkBrM,OAAOqS,GAAOhG,iBAAmB,IAAM,EACzDC,EAAoBtM,OAAOqS,GAAO/F,mBAAqB,IAAM,EAEnE0E,GAAW7E,aAAeA,EAC1B6E,GAAW5E,cAAgBA,EAC3B4E,GAAW3E,iBAAmBA,EAC9B2E,GAAW1E,mBAAqBA,EAEhC,MAAMgG,EAAWtS,OAAO+E,GAAM,IAAM,EAOpC,GANIuN,EAAW,IACbtB,GAAWW,OAASW,EACpBtB,GAAWY,MAAQxR,KAAKC,IAAI2Q,GAAWY,MAAOU,GAC9CtB,GAAWa,MAAQb,GAAWa,MAAQzR,KAAK+E,IAAI6L,GAAWa,MAAOS,GAAYA,GAG3EnG,EAAcC,EAAeC,EAAkBC,EAAoB,EAAG,CACxE,MAAMhO,EAAM,GAAGV,OAAOhF,GAAY,IAAI4H,iBAAiB5C,OAAOqK,GAAS,IAAIpI,SACrE+N,EAAWoD,GAAWtE,OAAOlP,IAAIc,IAAQ,CAC7C1F,SAAUgF,OAAOhF,GAAY,IAAI4H,cACjCyH,MAAOrK,OAAOqK,GAAS,IAAIpI,OAC3BsM,YAAa,EACbC,aAAc,EACdC,gBAAiB,EACjBC,kBAAmB,EACnBC,SAAU,GAEZqB,EAASzB,aAAeA,EACxByB,EAASxB,cAAgBA,EACzBwB,EAASvB,iBAAmBA,EAC5BuB,EAAStB,mBAAqBA,EAC9BsB,EAASrB,UAAY,EACrByE,GAAWtE,OAAO/O,IAAIW,EAAKsP,EAC7B,CAGA,OA8CF,WACE,IAAKoD,GAAY,OACjB,MAAMlQ,EAAMC,KACZ,GAAcD,EAAMkQ,GAAWgB,UAzIH,IAyIsC,OAClEhB,GAAWgB,UAAYlR,EACvB,MAAM6E,EAAQ4M,IAAmB,GAC7B5M,GAAO0I,GAAW1I,EACxB,CAtDE6M,IACO,CACT,CAQA,SAASD,GAAmBE,GAC1B,IAAKzB,GAAY,OAAO,KACxB,MAAMtE,EAASzI,MAAM0E,KAAKqI,GAAWtE,OAAO9D,UACtC8J,EAAc1B,GAAW7E,YAAc6E,GAAW5E,aAAe4E,GAAW3E,gBAC5EsG,EAAavS,KAAKC,IAAI,GAAI2Q,GAAWM,SAAWvQ,MAAWiQ,GAAWG,WACtEyB,EAAQ5B,GAAWO,cAAgB,EAAInR,KAAKyS,MAAM7B,GAAWW,MAAQX,GAAWO,eAAiB,EAEvG,MAAO,CACLuB,GAAI,WACJla,SAAU,QACVqP,MAAO,GACPqD,GAA8B,IAA1B0F,GAAWS,WACfnY,OAAO,EACPyL,GAAI4N,EACJxG,YAAa6E,GAAW7E,YACxBC,aAAc4E,GAAW5E,aACzBC,gBAAiB2E,GAAW3E,gBAC5BC,kBAAmB0E,GAAW1E,kBAC9BoG,cACAnF,OAAO,EACPV,QAASmE,GAAWI,GACpB2B,WAAYN,EACZjF,YAAad,EACbsG,WAAY,CACVzB,cAAeP,GAAWO,cAC1BjG,GAAI0F,GAAWQ,QACfyB,MAAOjC,GAAWS,WAClBnQ,OAAQ0P,GAAWU,YACnBkB,QACAM,MAAOlC,GAAWY,MAClBuB,MAAOnC,GAAWa,MAClBC,WAAYd,GAAWc,WACvBC,WAAYf,GAAWe,YAG7B,CAWA,SAASqB,KACP,IAAKpC,GAAY,OACjB,GAAI5N,GAAS,GAAKmN,GAAMpQ,OAAS,EAAG,OACpC6Q,GAAWM,QAAUvQ,KACrB,MAAM4E,EAAQ4M,IAAmB,GACjCvB,GAAa,KACTrL,GAAO0I,GAAW1I,EACxB,CAEA,SAAS0N,KAGP,OADAC,GADYvS,MAELqP,GAAUjQ,MACnB,CAMA,SAASoT,KACP,MAAMC,EAJC,CAAEpQ,UAAQC,OAAQkN,GAAMpQ,OAAQmD,IAAK+P,MAK5CvC,GAAgB0C,EACZ3C,KACJA,GAAc3L,WAAW,KACvB2L,GAAc,KACd,MAAMnN,EAASoN,GAEf,GADAA,GAAgB,MACXpN,EAAQ,OACb,MAAMpF,EAAM,GAAGoF,EAAON,UAAUM,EAAOL,UAAUK,EAAOJ,MACpDhF,IAAQyS,KACZA,GAAgBzS,EACXmF,GAAiB,IAAKC,EAAQH,GAAIxC,SACtC,KACL,CAEA3D,eAAeqW,KACb,MAAM3S,EAAMC,KACZ,GAAID,EAAMmP,GAvOqB,KAuOgC,OAAOD,GACtE,MAAMxR,QAAckE,IAGpB,OAFAsN,GAAyBxR,EACzByR,GAA2BnP,EACpBtC,CACT,CAWA,SAAS8U,GAAexS,GACtB,MAAM4S,EAAS5S,EAnPK,IAoPpB,KAAOsP,GAAUjQ,QAAUiQ,GAAU,IAAMsD,GACzCtD,GAAUM,OAEd,CAEA,SAASiD,KACHrD,KACJA,GAAiBsD,YAAY,KAC3B,MAAMC,EAAQR,KACdE,KACIM,GAAS,IACXC,cAAcxD,IACdA,GAAiB,OAElB,KACL,CAqEA,SAASyD,GAAiBxT,GACxB,MAAoB,iBAANA,GAAkBA,EAAEV,OAAOM,OAAS,CACpD,CAEA,SAAS6T,GAAiBtW,EAAGuW,GAAM,GACjC,GAAiB,kBAANvW,EAAiB,OAAOA,EACnC,GAAiB,iBAANA,EAAgB,OAAa,IAANA,EAClC,GAAiB,iBAANA,EAAgB,CACzB,MAAM6C,EAAI7C,EAAEmC,OAAOW,cACnB,GAAI,CAAC,IAAK,OAAQ,MAAO,IAAK,MAAM2B,SAAS5B,GAAI,OAAO,EACxD,GAAI,CAAC,IAAK,QAAS,KAAM,IAAK,OAAO4B,SAAS5B,GAAI,OAAO,CAC3D,CACA,OAAO0T,CACT,CAEA,SAASC,GAAmBxW,GAC1B,OAAOoE,GAASpE,EAAG,IAAM,KAAQ/E,EAASU,UAC5C,CAUA,SAAS8a,GAAWzW,GAClB,OAAOE,OAAOF,GAAK,IAAI8C,aACzB,CASA,SAAS4T,GAAiBnM,GACxB,MAAMmJ,EAAKxT,OAAOqK,GAAS,IAAIpI,OAC/B,OAAKuR,EACEA,EAAGiD,WAAW,WAAajD,EAAK,UAAUA,IADjC,EAElB,CA4FA,SAASkD,GAAqCvE,GAC5C,MAAMxP,EAAI4T,GAAWpE,GACrB,QAAKxP,IAEHA,EAAE4B,SAAS,mBACX5B,EAAE4B,SAAS,oBACX5B,EAAE4B,SAAS,oBACX5B,EAAE4B,SAAS,iBACX5B,EAAE4B,SAAS,kBACX5B,EAAE4B,SAAS,kBACX5B,EAAE4B,SAAS,uBACX5B,EAAE4B,SAAS,gBACX5B,EAAE4B,SAAS,oBACX5B,EAAE4B,SAAS,eAEf,CAEA,SAASoS,GAA8BxE,GACrC,MAAMxP,EAAI4T,GAAWpE,GACrB,QAAKxP,MACCA,EAAE4B,SAAS,eAAiB5B,EAAE4B,SAAS,kBAAoB5B,EAAE4B,SAAS,eAAiB5B,EAAE4B,SAAS,oBAItG5B,EAAE4B,SAAS,kBACX5B,EAAE4B,SAAS,gBACX5B,EAAE4B,SAAS,YACX5B,EAAE4B,SAAS,iBACX5B,EAAE4B,SAAS,YACX5B,EAAE4B,SAAS,gBACX5B,EAAE4B,SAAS,iBAEf,CAEA,SAASqS,GAA8BzE,GACrC,MAAMxP,EAAI4T,GAAWpE,GACrB,QAAKxP,KACAA,EAAE4B,SAAS,YAEd5B,EAAE4B,SAAS,cACX5B,EAAE4B,SAAS,YACX5B,EAAE4B,SAAS,YACX5B,EAAE4B,SAAS,cACX5B,EAAE4B,SAAS,kBAEf,CAEA,SAASsS,GAA2B7b,EAAUmG,GAC5C,GAAInG,IAAaN,EAAUG,QAAUsG,GAAQuM,GAAI,OAAO,EACxD,GAAuB,MAAnBvM,GAAQ2E,OAAgB,OAAO,EACnC,GAAqB,cAAjB3E,GAAQ+Q,KAAsB,OAAO,EACzC,MAAM4E,EAAMP,GAAWpV,GAAQgR,SAC/B,QAAK2E,IACEA,EAAIvS,SAAS,eAAiBuS,EAAIvS,SAAS,wBAA0BuS,EAAIvS,SAAS,eAC3F,CAEA,SAASwS,GAAsBC,GAE7B,IAAKb,GAAiBa,GAAS,MAAO,0BACtC,MAAMrU,EAAI3C,OAAOgX,GAAQ/U,OACzB,MAAI,QAAQgV,KAAKtU,GAAWA,EACrBA,EAJQ,0BAKjB,CAWA,SAASuU,GAAiBC,EAAQxP,GAChC,MAAe,eAAXwP,EAAgC,GAVtC,SAAgCxP,GAC9B,IAAKwO,GAAiBxO,GAAO,MAAO,GACpC,MAAMhE,EAAM3D,OAAO2H,GAAM1F,OACnBmV,EAAQzT,EAAIyT,MAAM,aAClBC,GAAWD,EAAQA,EAAM,GAAKzT,GAAK1B,OACzC,OAAKoV,EAAQZ,WAAW,KACjBY,EAD8B,EAEvC,CAISC,CAAuB3P,EAChC,CAqEOnI,eAAe+X,GAAWC,GAC/B,MAAMC,EAAQtU,KACRnI,EAAW0G,EAAkB8V,GAAKxc,iBAAoBiI,IACtDoH,QAAc5G,EAASzI,GACvB0c,QAAerU,EAAUrI,GACzBmc,EAASK,GAAKG,cAAgB,aAC9BC,EAAezB,GAAiBqB,GAAKI,cAAgB5X,OAAOwX,EAAII,cAAgB,GAChFC,EAAkB7c,IAAaN,EAAUI,aAAegJ,IAA6B,GACrF3I,EAAwBH,IAAaN,EAAUG,aAAegJ,IAA6B,GAC3FiU,EAAuB9c,IAAaN,EAAUI,OAAS+c,EAAkB1c,EAE/E,IAAKuc,EAaH,OAZAjH,GAAW,CACTyE,GAAIiC,EACJnc,WACAqP,QACAqD,IAAI,EACJvG,GAAIhE,KAAUsU,EACd/b,OAAO,EACPmc,gBAAiBC,QAAwBC,EACzCzM,KAAMsM,QAAgBG,EACtB7F,KAAM,kBACNC,QAAS,yCAAyCnX,OAE7C,CACL0S,IAAI,EACJ1S,WACAqP,QACA6H,KAAM,kBACNC,QAAS,yCAAyCnX,MAItD,MAAMgd,EAAOhY,OAAOwX,GAAKQ,MAAQ,IAC3BhB,EAASb,GAAiBqB,GAAKR,QAAUhX,OAAOwX,EAAIR,QAAU,GAE9DiB,EAAY7B,GAAiBoB,GAAKS,WAAW,GAC7Cxc,EAAY6a,GAAmBkB,GAAK/b,WACpCD,GA1SgBsE,EA0SO0X,GAAKhc,MAzS3B0I,GAASpE,EAAG,EAAG,EAAG/E,EAASS,QADpC,IAAwBsE,EA2StB,MAAMoY,EAAoB1V,KAAK+E,IAAI/L,EAppBN,GAspBvB2c,QAAelU,IACf5I,EA1SR,SAAkCyE,GAChC,OAAOoE,GAASpE,EAAG,EAAG,MAAQ/E,EAASM,gBACzC,CAwS0B+c,CAAyBZ,GAAKnc,iBAAmB8c,GACnEE,EAAiBrd,IAAaN,EAAUG,OA9GhD,SAAqCwP,EAAOiO,GAC1C,MAAMC,EAAQvY,OAAOsY,GAAU,IAAIrW,OAAOW,cAC1C,IAAK2V,GAAmB,SAAVA,GAA8B,SAAVA,EAAkB,OAAO,KAE3D,MAAMC,EAAUxY,OAAOqK,GAAS,IAAIpI,OAAOW,cAC3C,IAAK4V,EAAQjU,SAAS,UAAW,OAAO,KAExC,GAAIiU,EAAQjU,SAAS,YACnB,OAAIiU,EAAQjU,SAAS,SAGZ,CAAEkU,eAFO,IAAInb,IAAI,CAAC,UAAW,MAAO,SAAU,SAC1BqC,IAAI4Y,GAASA,EAAQ,OACbG,eAG9B,CAAED,eADoB,SAAVF,GAA8B,WAAVA,EAAqB,OAAS,OAClCG,eAGrC,GAAIF,EAAQjU,SAAS,cAAe,CAOlC,IAAIoU,EANY,CACdC,QAAS,IACTC,IAAK,KACLC,OAAQ,KACRC,KAAM,OAEaR,GACrB,OAAKI,GACDH,EAAQjU,SAAS,gBAAeoU,EAASnW,KAAKC,IAAI,IAAKkW,IACvDH,EAAQjU,SAAS,SAAQoU,EAASnW,KAAKC,IAAI,IAAKkW,IAC7C,CAAEK,eAAgBL,IAHL,IAItB,CAEA,OAAO,IACT,CA8EyDM,CAA4B5O,EAAOlP,GAAyB,KAE7G+d,EAAe9C,GAAiBoB,GAAK9b,MAAOX,EAASW,OACrDyd,EAASjV,GACbsT,GAAK7b,aAAeZ,EAASY,YAC7B,EACA,QACAZ,EAASY,aAELyd,EAAuBF,KAzgBzB9F,IACAC,MA9F0B,WAvEhC7T,iBACE,MAAMiJ,QDi0BDjJ,iBACL,aAAagJ,IACf,CCn0B0B6Q,GACpB5Q,EAAYkJ,KACdA,GAAqBlJ,EACrB4I,GAAMK,QAEV,CAyqBQlJ,GAGN,MAAM8Q,EAAkB,CACtBxZ,EAAG,EACH9E,WACAqP,QACAhP,kBACAwc,kBACA1c,wBACA8c,YACAjB,SACAgB,OACAuB,iBAAkB/B,GAAK+B,kBAAoB,GAC3CC,mBAAoBhC,GAAKgC,oBAAsB,MAG3CzP,QAAiByB,GAAQ8N,GAE/B,GAAIJ,EAAc,CAChB,MAAMxV,EAAS2N,GAAMzR,IAAImK,GACzB,GAAIrG,EAAQ,CACV,MAAM2T,EAAUH,GAAiBC,EAAQzT,GAAQiE,MAC3C8R,EAAWlF,GAAkB,CACjCvZ,WACAqP,QACAqD,IAAI,EACJhK,QAAQ,EACR8Q,UAAW,KACXC,MAAO,KACPtN,GAAIhE,KAAUsU,IAqBhB,OAnBKgC,GACHhJ,GAAW,CACTyE,GAAIiC,EACJnc,WACAqP,QACAqD,IAAI,EACJvG,GAAIhE,KAAUsU,EACd/b,OAAO,EACPge,UAAW,SACX7B,gBAAiBC,QAAwBC,EACzCzM,KAAMsM,QAAgBG,EACtBxJ,YAAa,EACbC,aAAc,EACdC,gBAAiB,EACjBqG,YAAa,EACbuC,QAASA,QAAWU,IAGpB0B,GAAUjE,KACP,IAAK9R,EAAQA,QAAQ,EAAMgW,UAAW,SAC/C,CACA,GAAIN,EAAsB,CACxB,MAAMO,QDqKLna,eAAkCuK,GACvC,IAAKA,EAAU,OAAO,KACtB,SAAU9D,KAAkB,OAAO,KACnC,MAAMwC,QAAkBD,KAClB7E,QAAY7C,EAAOoH,GAAqB6B,GAC9C,IAAKpG,EAEH,aADMgG,GAAqBI,GACpB,KAGT,IACE,MAAMhC,EAAQhC,KAAK6C,MAAMjF,GACzB,IAAKoE,GAA0B,iBAAVA,EAAoB,MAAM,IAAI6R,MAAM,iBACzD,MAAM3Q,EAAU7G,OAAO2F,EAAMmB,WAAa,GAC1C,OAAIT,KAAerG,OAAOC,SAAS4G,IAAYA,GAAWR,IAKtDV,EAAMoB,aAAepB,EAAMoB,aAAehG,YAJtCuG,GAAiBK,SACjBJ,GAAqBI,GACpB,MAOFhC,EAAMnH,OAAS,IACxB,CAAE,MAGA,aAFM8I,GAAiBK,SACjBJ,GAAqBI,GACpB,IACT,CACF,CCnM8B8P,CAAmB9P,GAC3C,GAAI4P,EAAW,CACb,MAAMtC,EAAUH,GAAiBC,EAAQwC,GAAWhS,MACpD0J,GAAMtR,IAAIgK,EAAU4P,EAAoB,IAATR,GAC/B,MAAMM,EAAWlF,GAAkB,CACjCvZ,WACAqP,QACAqD,IAAI,EACJhK,QAAQ,EACR8Q,UAAW,KACXC,MAAO,KACPtN,GAAIhE,KAAUsU,IAqBhB,OAnBKgC,GACHhJ,GAAW,CACTyE,GAAIiC,EACJnc,WACAqP,QACAqD,IAAI,EACJvG,GAAIhE,KAAUsU,EACd/b,OAAO,EACPge,UAAW,aACX7B,gBAAiBC,QAAwBC,EACzCzM,KAAMsM,QAAgBG,EACtBxJ,YAAa,EACbC,aAAc,EACdC,gBAAiB,EACjBqG,YAAa,EACbuC,QAASA,QAAWU,IAGpB0B,GAAUjE,KACP,IAAKmE,EAAWjW,QAAQ,EAAMgW,UAAW,aAClD,CACF,CACF,CAEA,GAAI9H,GAASjS,IAAIoK,GAAW,OAAO6H,GAAShS,IAAImK,GAEhD,MAAMrH,EAzcRlD,iBACE,OAAa,CACX,MAAMsa,QAAcjE,KACpB,GAAIrQ,GAASsU,EAAO,MAOpB,SANmB,IAAI1S,QAASC,IAC9BsL,GAAMhM,KAAKU,GACXiM,KACAgB,KACAqB,SAEW5D,GAAiB,MAAO,IAAKE,GAC5C,CACAzM,KACA8N,KACAgB,KACAqB,KACA,IAEE,aAnCJnW,iBACE,MAAMsa,QAhDRta,iBACE,MAAM0D,EAAMC,KACZ,GAAID,EAAMqP,GA1Oa,KA0OwB,OAAOD,GACtD,MAAM1R,QAAcsE,KAGpB,OAFAoN,GAAiB1R,EACjB2R,GAAmBrP,EACZtC,CACT,CAyCsBmZ,GACpB,GAAKD,KAASA,GAAS,GAEvB,OADArH,GAAUA,GAAQuH,KAAK,IAtBzBxa,eAA8Bsa,GAC5B,OAAa,CACX,MAAM5W,EAAMC,KAEZ,GADAuS,GAAexS,IACV4W,GAASA,GAAS,GAAKtH,GAAUjQ,OAASuX,EAI7C,OAHAtH,GAAU7L,KAAKzD,GACf6S,UACAJ,KAGF,MAAMsE,EAASzX,KAAKC,IAAI,EAAG+P,GAAU,GA/QnB,IA+QwCtP,GACtD+W,EAAS,QACL/S,GAAM+S,SAEN/S,GAAM,EAEhB,CACF,CAK+BgT,CAAeJ,IACrCrH,EACT,CA6BU0H,QAwbuB3a,WAC7B,IAAI4a,EAAU,EACVC,EAAU,KAEd,MAAMC,EAAe9a,SACnBxE,IAAaN,EAAUI,OA2Z7B0E,gBAA0B,OACxBkY,EAAM,MACNrN,EAAK,OACL2M,EAAM,KACNgB,EAAI,gBACJ3c,EAAe,gBACfwc,EAAe,UACfpc,EAAS,UACTwc,EAAS,iBACTsB,EAAgB,mBAChBC,IAEA,MAAMe,EAAM,sCAENC,EAAO,CACXnQ,QACAoB,MAAOuM,EACPyC,kBAAmBpf,EACnBqf,OAAO,GAQT,GALIvE,GAAiB0B,KACnB2C,EAAKG,UAAY,CAAErC,OAAQT,IAIzB1B,GAAiBa,GAAS,CAC5B,MAAM4D,EAAgC,qBAArBrB,GAA2CC,EACxDxC,EAAS,+BACTA,EACJwD,EAAKK,aAAeD,CACtB,CAKIpB,EAIFgB,EAAK7S,KAAO,CACVmT,OAAQ,CACNC,KAAM,cACNtQ,KAAM,kBACNuQ,QAAQ,EACRC,OAAQzB,IAGkB,qBAArBD,IACTiB,EAAK7S,KAAO,CAAEmT,OAAQ,CAAEC,KAAM,iBAI5B9C,IACFuC,EAAKU,MAAQ,CAAC,CAAEH,KAAM,eACtBP,EAAKW,QAAU,CAAC,mCAGlB,MAAMC,QAAYC,GAAiBd,EAAK,CACtCe,OAAQ,OACRC,QAAS,CACP,eAAgB,mBAChBC,cAAe,UAAU9D,KAE3B8C,KAAMzU,KAAKC,UAAUwU,IACpB/e,GAEGggB,QAAaC,GAASN,GAE5B,IAAKA,EAAI1N,GAAI,CACX,MAAMoJ,EAiFV,SAA4B2E,GAC1B,IACE,MAAM3E,EAAM2E,GAAMpG,OAAOlD,QACzB,OAAO2E,EAAM9W,OAAO8W,GAAO,EAC7B,CAAE,MACA,MAAO,EACT,CACF,CAxFgB6E,CAAmBF,IAAS,qBAAqBL,EAAItV,WACjE,MAAO,CAAE4H,IAAI,EAAO1S,SAAUN,EAAUI,OAAQuP,QAAO6H,KAAM,YAAaC,QAASzK,GAAoBoP,GACzG,CAEA,MAAMnP,EAiBR,SAA2B8T,GAEzB,IACE,GAAiC,iBAAtBA,GAAMG,aAA4BH,EAAKG,YAAY3Z,OAC5D,OAAOwZ,EAAKG,WAEhB,CAAE,MACA,CAIF,IACE,MAAMrV,EAAMkV,GAAMI,OAClB,GAAIxV,MAAMC,QAAQC,GAAM,CACtB,MAAMuV,EAAQ,GACd,IAAK,MAAMrV,KAAQF,EAAK,CAOtB,GAN0B,iBAAfE,GAAMkB,MAAqBlB,EAAKkB,KAAK1F,QAAQ6Z,EAAMnV,KAAKF,EAAKkB,MACvC,iBAAtBlB,GAAMmV,aAA4BnV,EAAKmV,YAAY3Z,QAAQ6Z,EAAMnV,KAAKF,EAAKmV,aACnE,gBAAfnV,GAAMsU,MAAgD,iBAAftU,GAAMkB,MAAmBmU,EAAMnV,KAAKF,EAAKkB,MACjE,SAAflB,GAAMsU,MAAyC,iBAAftU,GAAMkB,MAAmBmU,EAAMnV,KAAKF,EAAKkB,MAG1D,YAAflB,GAAMsU,KAAoB,CAC5B,MAAMgB,EAAUtV,GAAMsV,QACtB,GAAI1V,MAAMC,QAAQyV,GAChB,IAAK,MAAMC,KAAQD,EACE,SAAfC,GAAMjB,MAAmBiB,GAAMrU,MAAMmU,EAAMnV,KAAKqV,EAAKrU,MACtC,gBAAfqU,GAAMjB,MAA0BiB,GAAMrU,MAAMmU,EAAMnV,KAAKqV,EAAKrU,UAEtC,iBAAZoU,GAChBD,EAAMnV,KAAKoV,EAEf,CAEA,GAAmB,YAAftV,GAAMsU,KAAoB,CAC5B,MAAMgB,EAAUtV,GAAMsV,QACtB,GAAI1V,MAAMC,QAAQyV,GAChB,IAAK,MAAMC,KAAQD,EACE,SAAfC,GAAMjB,MAAmBiB,GAAMrU,MAAMmU,EAAMnV,KAAKqV,EAAKrU,MACtC,gBAAfqU,GAAMjB,MAA0BiB,GAAMrU,MAAMmU,EAAMnV,KAAKqV,EAAKrU,UAEtC,iBAAZoU,GAChBD,EAAMnV,KAAKoV,EAEf,CACF,CACA,GAAID,EAAMvZ,OAAS,EAAG,OAAOuZ,EAAM9P,KAAK,MAAM/J,MAChD,CACF,CAAE,MACA,CAIF,IACE,OAAOwZ,GAAMQ,UAAU,IAAI9J,SAAS4J,SAAW,EACjD,CAAE,MACA,MAAO,EACT,CACF,CA3EeG,CAAkBT,GACzBU,EAAUlE,EAqFlB,SAA8BwD,GAC5B,IACE,MAAMlV,EAAMkV,GAAMI,OAClB,IAAKxV,MAAMC,QAAQC,GAAM,MAAO,GAEhC,MAAM4V,EAAU,GAChB,IAAK,MAAM1V,KAAQF,EAAK,CACtB,GAAmB,oBAAfE,GAAMsU,KAA4B,SACtC,MAAMpY,EAAI8D,GAAM2V,QAAQD,QACxB,GAAK9V,MAAMC,QAAQ3D,GACnB,IAAK,MAAM0Z,KAAO1Z,EACX0Z,GAAK9B,KACV4B,EAAQxV,KAAK,CAAE2V,MAAOD,GAAKC,OAAS,GAAI/B,IAAK8B,EAAI9B,KAErD,CAEA,OAAOgC,GAAcJ,EACvB,CAAE,MACA,MAAO,EACT,CACF,CAzG8BK,CAAqBf,GAAQ,GACnDhH,EA0HR,SAA4BgH,GAC1B,IACE,MAAMgB,EAAIhB,GAAMhH,MAChB,IAAKgI,EAAG,OAAO,KACf,MAAMC,EAAkBC,GAAMF,GAAGG,eAC3BnO,EAAkBkO,GAAMF,GAAGI,uBAAuBC,kBAClDtO,EAAehM,KAAKC,IAAI,EAAGia,EAAkBjO,GACnD,MAAO,CACLF,YAAaoO,GAAMF,GAAGM,cACtBvO,eACAC,kBACAqG,YAAa6H,GAAMF,GAAGO,cACtBtO,kBAAmBiO,GAAMF,GAAGQ,sBAAsBC,eAEtD,CAAE,MACA,OAAO,IACT,CACF,CA3IgBC,CAAmB1B,GAEjC,OAAKtF,GAAiBxO,GAUf,CAAE+F,IAAI,EAAM1S,SAAUN,EAAUI,OAAQuP,QAAO1C,KAAMA,EAAK1F,OAAQka,UAAS1H,SATzE,CACL/G,IAAI,EACJ1S,SAAUN,EAAUI,OACpBuP,QACA6H,KAAM,iBACNC,QAAS,yBAKf,CApfsCiL,CAAWC,GAyNjD7d,gBAA0B,OACxBkY,EAAM,MACNrN,EAAK,OACL2M,EAAM,KACNgB,EAAI,gBACJ3c,EAAe,eACfgd,EAAc,UACd5c,EAAS,UACTwc,EAAS,iBACTsB,EAAgB,mBAChBC,IAEA,MAAMe,EAhBR,SAAwBlQ,GACtB,MAAO,2DAA2DiT,mBAAmBjT,oBACvF,CAcckT,CAAelT,GAC3B,IAAImK,EAAY,GACZgJ,EAAoB,GACpBC,EAAmB,GACnBC,EAAW1F,EACf,MAAM2F,EAAaxH,GAAiBa,GACT,qBAArBuC,GAA2CC,EAC3CxC,EAAS,+BACTA,EACF,GACE4G,EAAa3F,EAAY,KAlnBjC,SAAiCD,GAC/B,IAAK7B,GAAiB6B,GAAO,OAAO,KACpC,MACMZ,EADS,qBACMyG,KAAK7F,GAC1B,IAAKZ,EAAO,OAAO,KACnB,MAAMtG,EAAMsG,EAAMxN,MAAQwN,EAAM,GAAG7U,OAC7Bub,EAAS9F,EAAKpT,MAAM,EAAGkM,GACvBiN,EAAS/F,EAAKpT,MAAMkM,GAC1B,OAAIgN,EAAOvb,OAxYkC,KAyYzCwb,EAAO9b,OAAOM,OAxY2B,EAuYsB,KAE5D,CAAEub,SAAQC,SACnB,CAumBwCC,CAAwBhG,GAC9D,GAAI4F,EAAY,CACd,MAAMla,QAhkBVlE,gBAAyC,OAAEkY,EAAM,MAAErN,EAAK,OAAE2M,EAAM,OAAE8G,EAAM,MAAE9T,EAAK,UAAEvO,IAC/E,IAAKic,IAAWvB,GAAiB2H,GAAS,OAAO,KACjD,MAAM/T,QAAiByB,GAAQ,CAC7B1L,EAAG,EACHuK,MAAOrK,OAAOqK,GAAS,IAAIpI,OAC3B+U,OAAQhX,OAAOgX,GAAU,IAAI/U,OAC7B6b,WAGI9N,QDmqBDxQ,eAA2CuK,GAChD,IAAKA,EAAU,OAAO,WAChBW,KACN,MAAM3C,EAAQM,GAAqBzI,IAAImK,GACjCQ,EAASM,KACf,OAAI9C,IAAUM,GAAqB1I,IAAIoK,UAC/BkB,GAA2BV,EAAO1D,MACjC,OAEL0D,EAAO/I,eACHyJ,GAA2BV,EAAO1D,MAEnCkB,GAAS,KAClB,CChrByBkW,CAA4BlU,GACnD,GAAIiG,GAAUvF,KAAM,MAAO,CAAEA,KAAMuF,EAASvF,KAAMV,YAElD,GAAI+H,GAAuBnS,IAAIoK,GAAW,OAAO+H,GAAuBlS,IAAImK,GAE5E,MAAMrH,EAAI,WACR,IACE,MAAMwb,QAhDZ1e,gBAAyC,OAAEkY,EAAM,MAAErN,EAAK,OAAE2M,EAAM,OAAE8G,EAAM,MAAE9T,EAAK,UAAEvO,IAC/E,MACM+e,EAAO,CACXnQ,MAAOmM,GAAiBnM,GACxB8T,SAAU,CAAC,CAAEC,KAAM,OAAQC,MAAO,CAAC,CAAE1W,KAAMmW,MAC3CQ,IAAK,GAAG9b,KAAKC,IAAI,GAAID,KAAK8L,OAAOtE,GAAS6H,IAAgC,UAGxEsE,GAAiBa,KACnBwD,EAAK+D,kBAAoB,CAAEH,KAAM,SAAUC,MAAO,CAAC,CAAE1W,KAAMqP,MAG7D,MAAMoE,QAAYC,GAXN,kEAaV,CACEC,OAAQ,OACRC,QAAS,CACP,eAAgB,mBAChB,iBAAkB7D,GAEpB8C,KAAMzU,KAAKC,UAAUwU,IAEvBhY,KAAKC,IAAI,IAAOD,KAAK+E,IAAI,IAAO9L,GAAa,OAGzCggB,QAAaC,GAASN,GAC5B,IAAKA,EAAI1N,GAAI,MAAO,CAAEA,IAAI,EAAO5H,OAAQsV,EAAItV,OAAQ2V,QACrD,MAAMhR,EAAOzK,OAAOyb,GAAMhR,MAAQ,IAAIxI,OACtC,OAAKwI,EACE,CAAEiD,IAAI,EAAMjD,OAAM+T,WAAY/C,GAAM+C,YADzB,CAAE9Q,IAAI,EAAO5H,OAAQsV,EAAItV,OAAQ2V,OAErD,CAkB4BgD,CAA0B,CAAE/G,SAAQrN,QAAO2M,SAAQ8G,SAAQ9T,QAAOvO,cACxF,IAAKyiB,GAASxQ,KAAOwQ,GAASzT,KAAM,OAAO,KAC3C,MAAMtB,EAzDZ,SAA2BqV,EAAYE,GACrC,IAAKF,EAAY,OAAOE,EACxB,MAAM9T,EAAS3D,KAAK2B,MAAM5I,OAAOwe,IACjC,OAAIpc,OAAOC,SAASuI,IAAWA,EAAS,EAAUA,EAC3C8T,CACT,CAoD0BC,CAAkBT,EAAQM,WAAYrb,MAAW6G,GAAS6H,KAM9E,aDmqBCrS,eAA2CuK,EAAU6U,GAC1D,IAAK7U,IAAa6U,EAAkC,aAC9ClU,KACN,MAAM3C,EAAQyC,GAA2B,CAAE9J,IAAKqJ,KAAa6U,EAAM1V,UAAW0V,EAAK1V,WAAa/F,OAChG,IAAK4E,EAAO,OACZM,GAAqBtI,IAAIgK,EAAUhC,GACnC,MAAMwC,EAASM,WACTI,GAA2BV,EAAO1D,KAC1C,CChrBYgY,CAA4B9U,EAAU,CAC1CU,KAAMyT,EAAQzT,KACdvB,UAAW/F,KACXgG,gBAEK,CAAEsB,KAAMyT,EAAQzT,KAAMV,WAC/B,CAAE,MACA,OAAO,IACT,CACD,EAdS,GAgBV+H,GAAuB/R,IAAIgK,EAAUrH,GACrC,IACE,aAAaA,CACf,CAAE,QACAoP,GAAuB5R,OAAO6J,EAChC,CACF,CA4hByB+U,CAA0B,CAC7CpH,SACArN,QACA2M,OAAQ2G,EACRG,OAAQF,EAAWE,OACnB9T,MAAO6H,GACPpW,cAEEiI,GAAQ+G,OACV+S,EAAoB9Z,EAAO+G,KAC3BgT,EAAmB/Z,EAAOqG,UAAY,GACtC2T,EAAWE,EAAWG,OACtBvJ,EAAY,wBAEhB,CAEA,MAAMgG,EAAO,CACX2D,SAAU,CAAC,CAAEC,KAAM,OAAQC,MAAO,CAAC,CAAE1W,KAAM+V,MAC3CqB,iBAAkB,CAChB1jB,oBAIAgd,GAA4C,iBAAnBA,IAC3BmC,EAAKuE,iBAAiB1G,eAAiBA,GAGrClC,GAAiBwH,KAAgBH,IAEnChD,EAAK+D,kBAAoB,CAAEH,KAAM,SAAUC,MAAO,CAAC,CAAE1W,KAAMgW,MAIzDpE,IACFiB,EAAKuE,iBAAiBxF,iBAAmBA,GAEvCC,IACFgB,EAAKuE,iBAAiBC,eAAiBxF,GAIrCvB,IAGFuC,EAAKU,MAAQ,CAAC,CAAE+D,cAAe,CAAC,KAE9BzB,IACFhD,EAAK0E,cAAgB1B,GAGvB,MAAMpC,QAAYC,GAAiBd,EAAK,CACtCe,OAAQ,OACRC,QAAS,CACP,eAAgB,mBAChB,iBAAkB7D,GAEpB8C,KAAMzU,KAAKC,UAAUwU,IACpB/e,GAEGggB,QAAaC,GAASN,GACtB+D,EAyER,SAAgC1D,GAC9B,IACE,MAAM2D,EAAM3D,GAAMpG,MAClB,IAAK+J,EAAK,OAAO,KACjB,MAAMtI,EAAMsI,GAAKjN,QACXkN,EAAajd,OAAOgd,GAAKlN,MAC/B,MAAO,CACLC,QAAS2E,EAAM9W,OAAO8W,GAAO,GAC7BhR,OAAQ1D,OAAOC,SAASgd,GAAcA,OAAatH,EAEvD,CAAE,MACA,OAAO,IACT,CACF,CAtFkBuH,CAAuB7D,GAEvC,GAAI0D,GAAShN,QAIX,OAHIsL,GAAoB7G,GAA8BuI,EAAQhN,gBACtDjH,GAA+BuS,GAEhC,CACL/P,IAAI,EACJ1S,SAAUN,EAAUG,OACpBwP,QACAvE,OAAQqZ,EAAQrZ,QAAUsV,EAAItV,OAC9BoM,KAAM,YACNC,QAASzK,GAAoByX,EAAQhN,SACrCqC,aAIJ,IAAK4G,EAAI1N,GAAI,CACX,MAAMoJ,EA8CV,SAA4B2E,GAC1B,IACE,MAAM3E,EAAM2E,GAAMpG,OAAOlD,QACzB,OAAO2E,EAAM9W,OAAO8W,GAAO,EAC7B,CAAE,MACA,MAAO,EACT,CACF,CArDgByI,CAAmB9D,IAAS,qBAAqBL,EAAItV,WAIjE,OAHI2X,GAAoB7G,GAA8BE,UAC9C5L,GAA+BuS,GAEhC,CACL/P,IAAI,EACJ1S,SAAUN,EAAUG,OACpBwP,QACAvE,OAAQsV,EAAItV,OACZoM,KAAM,YACNC,QAASzK,GAAoBoP,GAC7BtC,YAEJ,CAEA,MAAM7M,EAkBR,SAA2B8T,GACzB,IACE,MAAM+D,EAAI/D,GAAM5Z,aAAa,GACvBwc,EAAQmB,GAAGzD,SAASsC,MAC1B,OAAIhY,MAAMC,QAAQ+X,GACTA,EAAMvc,IAAKY,GAAMA,GAAGiF,MAAQ,IAAIqE,KAAK,IAEvC,EACT,CAAE,MACA,MAAO,EACT,CACF,CA7BeyT,CAAkBhE,GACzBU,EAsDR,SAA8BV,GAC5B,IACE,MAAM+D,EAAI/D,GAAM5Z,aAAa,GACvB6d,EAAKF,GAAGG,kBACRC,EAASF,GAAIG,gBACnB,IAAKxZ,MAAMC,QAAQsZ,GAAS,MAAO,GAEnC,MAAMrZ,EAAM,GACZ,IAAK,MAAMuZ,KAAMF,EAAQ,CACvB,MAAMG,EAAMD,GAAIC,IACXA,GAAKC,KACVzZ,EAAII,KAAK,CAAE2V,MAAOyD,GAAKzD,OAAS,GAAI/B,IAAKwF,EAAIC,KAC/C,CAEA,OAAOzD,GAAchW,EACvB,CAAE,MACA,MAAO,EACT,CACF,CAxEkB0Z,CAAqBxE,GAC/BhH,EAiQR,SAA4BgH,GAC1B,IACE,MAAMgB,EAAIhB,GAAMyE,cAChB,OAAKzD,EACE,CACLlO,YAAaoO,GAAMF,GAAG0D,kBACtB3R,aAAcmO,GAAMF,GAAG2D,sBACvB3R,gBAAiBkO,GAAMF,GAAG4D,oBAC1BvL,YAAa6H,GAAMF,GAAG6D,iBACtB5R,kBAAmBiO,GAAMF,GAAG8D,0BANf,IAQjB,CAAE,MACA,OAAO,IACT,CACF,CA/QgBC,CAAmB/E,GAEjC,OAAKtF,GAAiBxO,GAWf,CAAE+F,IAAI,EAAM1S,SAAUN,EAAUG,OAAQwP,QAAO1C,KAAMA,EAAK1F,OAAQka,UAAS1H,QAAOD,aAVhF,CACL9G,IAAI,EACJ1S,SAAUN,EAAUG,OACpBwP,QACA6H,KAAM,iBACNC,QAAS,0BACTqC,YAKN,CA9VyDiM,CAAWpD,GAEhE,KAAOjD,GAAW5e,GAAO,CACvB4e,IACA,IACE,MAAMsG,EAAW,CACfhJ,SACArN,QACA2M,SACAgB,OACA3c,kBACAwc,kBACAQ,iBACA5c,YACAwc,YACAsB,iBAAkB/B,GAAK+B,iBACvBC,mBAAoBhC,GAAKgC,oBAG3B,IAAIrY,QAAemZ,EAAaoG,GAEhC,IAAKvf,EAAOuM,KAAOmJ,GAA2B7b,EAAUmG,GAAS,CAC/D,IAAIkc,EAAOqD,EAGPrD,EAAKpF,YAELtB,GAA8BxV,EAAOgR,UAA4B,cAAhBhR,EAAO+Q,MAAwC,mBAAhB/Q,EAAO+Q,QAEvFmL,EAAO,IAAKA,EAAMpF,WAAW,GAC7B9W,QAAemZ,EAAa+C,IAKhC,MAAMsD,EAAkBtD,EAAK9D,kBAAoB8D,EAAK7D,oBACjDrY,EAAOuM,IAAMiT,IAEdjK,GAAqCvV,EAAOgR,UAC5B,cAAhBhR,EAAO+Q,MACS,mBAAhB/Q,EAAO+Q,QAEPmL,EAAO,IACFA,EACH9D,sBAAkBxB,EAClByB,wBAAoBzB,EACpBf,OAAQD,GAAsBsG,EAAKrG,SAErC7V,QAAemZ,EAAa+C,GAGlC,CAEA,MAAMuD,EACJ/J,GAA2B7b,EAAUmG,IAAWiZ,GAAWlC,EAGvDzD,EAAQoM,GAAe1f,GAAQsT,OAC/B4C,EAAUlW,EAAOuM,GAAKwJ,GAAiBC,EAAQhW,EAAOwG,MAAQ,GAEpE,GAAIiZ,EAA+B,OAC3B1Z,GAn0BkB,KAo0BxB,QACF,CAyCA,OAvCiBqN,GAAkB,CACjCvZ,WACAqP,QACAqD,GAAIvM,EAAOuM,GACXhK,QAAQ,EACR8Q,UAAWrT,EAAOqT,WAAa,KAC/BC,QACAtN,GAAIhE,KAAUsU,KAGdhH,GAAW,CACTyE,GAAIiC,EACJnc,WACAqP,QACAqD,GAAIvM,EAAOuM,GACXvG,GAAIhE,KAAUsU,EACd2C,UACA1e,OAAO,EACPmc,gBAAiBC,QAAwBC,EACzCzM,KAAMsM,QAAgBG,EACtBxJ,YAAakG,EAAMlG,YACnBC,aAAciG,EAAMjG,aACpBC,gBAAiBgG,EAAMhG,gBACvBC,kBAAmB+F,EAAM/F,kBACzBoG,YAAaL,EAAMK,YACnB5C,KAAM/Q,EAAO+Q,KACbC,QAAShR,EAAOgR,QAChBkF,QAASA,QAAWU,EACpBvD,UAAWrT,EAAOqT,gBAAauD,IAI/B5W,EAAOuM,IAAMwL,IACf7H,GAAMtR,IAAIgK,EAAU5I,EAAiB,IAATgY,GACxBC,SACItP,GAAmBC,EAAU5I,EAAiB,IAATgY,EAAe,CAAEne,WAAUqP,WAInElJ,CACT,CAAE,MAAO6M,GACPqM,EAAUrM,EACNoM,GAAW5e,SAAa0L,GAAM,IAAMkT,EAC1C,CACF,CAEA,MAAM0G,EA/fV,SAAwB1B,GACtB,IAAKA,EAAK,OAAO,EACjB,GAAiB,eAAbA,EAAI3U,KAAuB,OAAO,EACtC,MAAMqM,EAAM9W,OAAOof,EAAIjN,SAAW,IAAIvP,cACtC,OAAOkU,EAAIvS,SAAS,YAAcuS,EAAIvS,SAAS,UACjD,CA0foBwc,CAAe1G,GACzBnI,EAAO4O,EAAU,UAAY,YAE7BhK,EAAMpP,GADGoZ,EAAU,2BAA8BzG,GAASlI,QAAUnS,OAAOqa,EAAQlI,SAAW,oBAyBpG,OAvBiBoC,GAAkB,CACjCvZ,WACAqP,QACAqD,IAAI,EACJhK,QAAQ,EACR8Q,UAAW,KACXC,MAAO,KACPtN,GAAIhE,KAAUsU,KAGdhH,GAAW,CACTyE,GAAIiC,EACJnc,WACAqP,QACAqD,IAAI,EACJvG,GAAIhE,KAAUsU,EACd/b,OAAO,EACPmc,gBAAiBC,QAAwBC,EACzCzM,KAAMsM,QAAgBG,EACtB7F,OACAC,QAAS2E,IAGN,CAAEpJ,IAAI,EAAO1S,WAAUqP,QAAO6H,OAAMC,QAAS2E,IAtkBvC5B,EACf,CAAE,QACA1P,KACA,MAAMqE,EAAO8I,GAAMG,QACfjJ,GAAMA,IACV8L,KACAH,IACF,CACF,CA+aYwL,GAkJVpP,GAAS7R,IAAIgK,EAAUrH,GAEvB,IACE,MAAMvB,QAAeuB,EA+BrB,MA9BqB,oBAAjBvB,GAAQ+Q,OACOqC,GAAkB,CACjCvZ,WACAqP,QACAqD,IAAI,EACJhK,QAAQ,EACR8Q,UAAW,KACXC,MAAO,KACPtN,GAAIhE,KAAUsU,KAGdhH,GAAW,CACTyE,GAAIiC,EACJnc,WACAqP,QACAqD,IAAI,EACJvG,GAAIhE,KAAUsU,EACd/b,OAAO,EACPmc,gBAAiBC,QAAwBC,EACzCzM,KAAMsM,QAAgBG,EACtBxJ,YAAa,EACbC,aAAc,EACdC,gBAAiB,EACjBC,kBAAmB,EACnBoG,YAAa,EACb5C,KAAM/Q,EAAO+Q,KACbC,QAAShR,EAAOgR,WAIfhR,CACT,CAAE,QACAyQ,GAAS1R,OAAO6J,EAClB,CACF,CAicA,SAAS8W,GAAepM,GACtB,IAAKA,GAA0B,iBAAVA,EACnB,MAAO,CAAElG,YAAa,EAAGC,aAAc,EAAGC,gBAAiB,EAAGqG,YAAa,EAAGpG,kBAAmB,GAEnG,MAAMH,EAAcoO,GAAMlI,EAAMlG,aAC1BC,EAAemO,GAAMlI,EAAMjG,cAC3BC,EAAkBkO,GAAMlI,EAAMhG,iBAC9BC,EAAoBiO,GAAMlI,EAAM/F,mBAChCuS,EAAgBtE,GAAMlI,EAAMK,aAC5BoM,EAAgB3S,EAAcC,EAAeC,EAEnD,MAAO,CACLF,cACAC,eACAC,kBACAqG,YALkBtS,KAAKC,IAAIwe,EAAeC,GAM1CxS,oBAEJ,CAEA,SAASiO,GAAM/b,GACb,MAAMuB,EAAIC,OAAOxB,GACjB,OAAKwB,OAAOC,SAASF,IAAMA,GAAK,EAAU,EACnCK,KAAK8L,MAAMnM,EACpB,CAEO3C,eAAe2hB,KACpB9P,GAAMK,cD7bDlS,iBACL,MAAMiJ,EAAYtF,KAClBiF,GAAgBK,QACVpH,EAAOzF,EAAasB,eAAgB8C,OAAOyI,IACjD,MAAMmB,QAAclB,KACpB,IAAK,MAAMjC,KAAQmD,GAAS,GACrBnD,GAAM/F,WACLgJ,GAAiBjD,EAAK/F,WAExBa,EAAU3F,EAAaqB,YAC/B,CCobQmkB,SDjRD5hB,iBACL6I,GAAuB,IAAI9I,IAC3B+I,IAA6B,EAC7BC,GAA8B,WACxBhH,EAAU3F,EAAawB,sBAC/B,CC6QQikB,EACR,CAEA,SAAS9E,GAAc1V,GACrB,MAAML,EAAO,IAAIlJ,IACXiJ,EAAM,GACZ,IAAK,MAAM5D,KAAKkE,GAAQ,GAAI,CAC1B,MAAM0T,EAAMva,OAAO2C,GAAG4X,KAAO,IAAItY,OACjC,IAAKsY,EAAK,SACV,MAAM7Z,EAAM6Z,EAAI3X,cACZ4D,EAAK7G,IAAIe,KACb8F,EAAKE,IAAIhG,GACT6F,EAAII,KAAK,CAAE2V,MAAOtc,OAAO2C,GAAG2Z,OAAS,IAAIra,OAAQsY,QACnD,CACA,OAAOhU,CACT,CAIA/G,eAAe6b,GAAiBd,EAAKxZ,EAAStF,GAC5C,MAAM6lB,EAAIhL,GAAmB7a,GAE7B,GAA+B,oBAApB8lB,gBAET,aAAaC,MAAMjH,EAAKxZ,GAG1B,MAAM0gB,EAAO,IAAIF,gBACX/N,EAAKlM,WAAW,IAAMma,EAAKC,QAASJ,GAE1C,IACE,aAAaE,MAAMjH,EAAK,IAAKxZ,EAAS4gB,OAAQF,EAAKE,QACrD,CAAE,QACAvQ,aAAaoC,EACf,CACF,CAEAhU,eAAekc,GAASN,GACtB,IACE,aAAaA,EAAIK,MACnB,CAAE,MACA,MAAO,CAAC,CACV,CACF,CA7mCK5V,GAAiB,CAAEL,OAAQ,EAAGC,OAAQ,EAAGC,IAAK,EAAGC,GAAIxC,OCzY1D,MAEMye,GAAgB,gBAGtB,SAASC,GAAanhB,GACpB,OAAOV,OAAOU,GAAO,IAAIuB,MAC3B,CAEA,SAAS6f,GAAmBlhB,GAC1B,MAAM+C,EAAM3D,OAAOY,GAAS,IAAIqB,OAChC,IAAK0B,EAAK,MAAO,GACjB,MAAMgC,EAAKsB,KAAK2B,MAAMjF,GACtB,OAAKvB,OAAOC,SAASsD,GACd,IAAIsB,KAAKtB,GAAIoc,cADa,EAEnC,CAEA,SAASC,GAAapD,EAAMpX,GAC1B,IAAKoX,EAAM,OAAOpX,EAClB,GAA0B,iBAAfoX,EAAKvJ,OAAsBuJ,EAAKvJ,MAAMpT,OAAQ,OAAO2c,EAAKvJ,MAAMpT,OAC3E,GAA4B,iBAAjB2c,EAAKzM,SAAwByM,EAAKzM,QAAQlQ,OAAQ,OAAO2c,EAAKzM,QAAQlQ,OACjF,GAAIoE,MAAMC,QAAQsY,EAAK/Q,SAAW+Q,EAAK/Q,OAAOtL,OAAQ,CACpD,MAAM0f,EAAQrD,EAAK/Q,OAAO,IAAM,CAAC,EAC3BqU,EAASD,EAAMC,QAAUD,EAAM3F,OAAS2F,EAAM9P,QACpD,GAAI+P,EAAQ,OAAOliB,OAAOkiB,GAAQjgB,MACpC,CACA,OAAOuF,CACT,CAEAhI,eAAe2iB,GAAYC,EAAUC,GACnC,MAAMC,EAAW,IAAIC,SACrB5nB,OAAOqN,QAAQqa,GAAW,CAAC,GAAGG,QAAQ,EAAE9hB,EAAKE,MAC9B,MAATA,GAA2B,KAAVA,GACrB0hB,EAASG,OAAO/hB,EAAKE,KAGvB,MAAM8hB,QAAiBlB,MAAMY,EAAU,CAAE9G,OAAQ,OAAQd,KAAM8H,IAC/D,IAAI1D,EAAO,KACX,IACEA,QAAa8D,EAASjH,MACxB,CAAE,MACAmD,EAAO,IACT,CACA,MAAO,CAAElR,GAAIgV,EAAShV,GAAI5H,OAAQ4c,EAAS5c,OAAQ8Y,OACrD,CAEA,SAAS+D,GAAajiB,EAAKke,EAAMgE,EAAY,CAAC,GAC5C,MAAMC,EAAaD,EAAUC,YAAcjE,GAAMkE,UAAUtP,IAAMoL,GAAMmE,aAAe,GAChFC,EAAepE,GAAMkE,UAAUrY,MAAQmY,EAAUI,cAAgBpB,GACjEqB,EAAYnB,GAAmBlD,GAAMsE,aAAaC,YAAcP,EAAUK,WAC1E/f,GAAM,IAAI+D,MAAO8a,cAEvB,MAAO,CACLrhB,MACAmiB,aACAG,eACAC,YACA9U,OAAO,EACPiV,YAAaR,EAAUQ,aAAelgB,EACtCmgB,cAAengB,EAEnB,CAEA,SAASogB,GAAiB3f,GACxB,IAAKA,GAAsB,iBAARA,EAAkB,OAAO,KAC5C,MAAMjD,EAAMmhB,GAAale,EAAIjD,KAC7B,OAAKA,EAEE,CACLA,MACAmiB,WAAY7iB,OAAO2D,EAAIkf,YAAc,IAAI5gB,OACzC+gB,aAAchjB,OAAO2D,EAAIqf,cAAgBpB,IAAe3f,OACxDghB,UAAWnB,GAAmBne,EAAIsf,WAClC9U,OAAqB,IAAdxK,EAAIwK,MACXiV,YAAapjB,OAAO2D,EAAIyf,aAAe,IAAInhB,OAC3CohB,cAAerjB,OAAO2D,EAAI0f,eAAiB,IAAIphB,QAThC,IAWnB,CAEOzC,eAAe+jB,KAEpB,OAAOD,SFwoBF9jB,uBACCiC,IACN,MAAMkC,QAAY7C,EAAOlF,EAAae,SACtC,IAAKgH,EAAK,OAAO,KACjB,IACE,OAAOoC,KAAK6C,MAAMjF,EACpB,CAAE,MACA,OAAO,IACT,CACF,CElpBuB6f,GAEvB,CAEOhkB,eAAeikB,GAAkB1c,GACtC,MAAM/B,EAAase,GAAiBvc,GACpC,OAAK/B,SAIC8B,GAAW9B,GACVA,UAJCgC,KACC,KAIX,CAMO,SAAS0c,GAAe3c,GAC7B,IAAKA,IAAYA,EAAQrG,IAAK,OAAO,EACrC,IAAsB,IAAlBqG,EAAQoH,MAAiB,OAAO,EACpC,GAAIpH,EAAQkc,UAAW,CACrB,MAAMtd,EAAKsB,KAAK2B,MAAM7B,EAAQkc,WAC9B,GAAI7gB,OAAOC,SAASsD,IAAOA,GAAMsB,KAAK/D,MAAO,OAAO,CACtD,CACA,OAAO,CACT,CClDA,SAASygB,GAAGnQ,GACV,OAAOoQ,SAASC,eAAerQ,EACjC,CAEA,SAASsQ,GAAUC,EAAMC,GACvB,MAAMC,EAAWvc,GAAoBqc,GAAQ,IAE7C,GADAJ,GAAG,cAAcO,YAAcD,EAC3BD,EACF,IACE,MAAMG,EAAcrc,GAAqBkc,GACzCL,GAAG,iBAAiBO,YAAcne,KAAKC,UAAUme,EAAa,KAAM,EACtE,CAAE,MACAR,GAAG,iBAAiBO,YAAcxc,GAAoBsc,EACxD,MAEAL,GAAG,iBAAiBO,YAAc,EAEtC,CAiBA,SAASE,GAAaxjB,GACpB,MAAMuB,EAAIC,OAAOxB,GACjB,OAAKwB,OAAOC,SAASF,GACdK,KAAKyS,MAAM9S,GAAGkiB,eAAe,SADJ,GAElC,CAEA,MAAMC,GAAkB,IAWxB,SAASC,GAAW3jB,GAClB,MAAMuB,EAAIC,OAAOxB,GACjB,OAAKwB,OAAOC,SAASF,GACd,GAAGmiB,KAAkBniB,EAAEqiB,QAAQ,KADN,GAAGF,UAErC,CAEA,SAASG,GAAgB7jB,GACvB,MAAMuB,EAAIC,OAAOxB,GACjB,OAAKwB,OAAOC,SAASF,GACd,GAAGA,EAAEqiB,QAAQ,GAAG3c,QAAQ,IAAK,OAAOyc,KADX,OAAOA,IAEzC,CAEA,SAASI,GAAgB9jB,GACvB,MAAMuB,EAAIC,OAAOxB,GACjB,IAAKwB,OAAOC,SAASF,IAAMA,GAAK,EAAG,MAAO,MAC1C,MAAMwiB,EAAQniB,KAAKC,IAAI,EAAGD,KAAKyS,MAAU,IAAJ9S,IACrC,MAAO,GAAGnC,OAAO2kB,GAAO5Y,SAAS,EAAG,OACtC,CAEA,SAAS6Y,GAAezd,GACtB,MAAMhF,EAAIC,OAAO+E,GACjB,OAAK/E,OAAOC,SAASF,GACd,IAAIA,EAAI,KAAMqiB,QAAQ,MADG,OAElC,CAEA,SAASK,GAAWlf,GAClB,IAEE,OADU,IAAIsB,KAAKtB,GACVmf,mBAAmB,QAAS,CAAEC,KAAM,UAAWC,OAAQ,WAClE,CAAE,MACA,MAAO,OACT,CACF,CAmBA,SAASC,GAAcC,GACrB,OAAOllB,OAAOklB,GAASC,SAASD,SAAW,IAAIjjB,MACjD,CASA,SAASmjB,GAAgBF,GACvB,MAA2C,SAApCA,GAASC,SAASE,aAC3B,CAoBA,SAASC,GAAkBC,GAEzB,GADKC,KAAaA,GAAc5B,SAAS6B,cAAc,gBAClDD,GAAa,OAClB,MAAME,EAAe9B,SAAS6B,cAAcE,IAC5C,IAAK,MAAMjlB,KAAO6kB,EAAO,CACvB,MAAML,EAAUU,GAAgBhmB,IAAIc,GAC/BwkB,IACDQ,EAAcF,GAAYK,aAAaX,EAASQ,GAC/CF,GAAYM,YAAYZ,GAC/B,CACF,CAEA,SAASa,GAAuBC,GAC9BJ,GAAgBpD,QAAQ,CAAC0C,EAASxkB,KAChC,MAAMulB,EAASb,GAAgBF,GACzBgB,EAAaF,EAAOrmB,IAAIe,KAASulB,EACvCf,EAAQiB,UAAUC,OAAOC,GAAsBH,IAEnD,CAEA,SAASI,KACP,IAAIC,GAAU,EACd,IAAK,MAAM7lB,KAAO2F,MAAM0E,KAAKyb,IAAiB,CAC5C,MAAMtB,EAAUU,GAAgBhmB,IAAIc,GAC/BwkB,IAAWE,GAAgBF,KAC9BsB,GAAetmB,OAAOQ,GACtB6lB,GAAU,EAEd,CACIA,GAAc3f,GAAkBP,MAAM0E,KAAKyb,IACjD,CAEA,SAASC,GAAmBC,EAAW3lB,EAAU,CAAC,GAChD,MAAM,QAAE4lB,GAAU,GAAS5lB,EAC3B6lB,GAAeF,EAAU9hB,QACzB0gB,GAAkBsB,IAClBC,KACIF,GH8dCnnB,eAA+B+lB,GACpC,MAAMvgB,EAAaoB,GAAqBmf,SAClClkB,EAAOzF,EAAaa,cAAesJ,KAAKC,UAAUhB,GAE1D,CGleoB8hB,CAAgBF,GACpC,CAOA,SAASG,GAAqBC,EAAYjmB,EAAU,CAAC,GACnD,MAAM,QAAE4lB,GAAU,GAAS5lB,EAC3BylB,GAAiB,IAAIlpB,IAAI0pB,GACzBV,KACAP,GAAuBS,IACvBK,KACIF,GAAc/f,GAAkBP,MAAM0E,KAAKyb,KAC/CS,IACF,CAEA,SAASC,GAAYxmB,EAAK4P,GACxB,MAAMQ,EAAM8V,GAAaO,QAAQzmB,GACjC,GAAIoQ,EAAM,EAAG,OACb,MAAMsW,EAAUtW,EAAMR,EACtB,GAAI8W,EAAU,GAAKA,GAAWR,GAAarkB,OAAQ,OACnD,MAAMsH,EAAO+c,GAAahiB,QAC1BiF,EAAKwd,OAAOvW,EAAK,GACjBjH,EAAKwd,OAAOD,EAAS,EAAG1mB,GACxB+lB,GAAmB5c,EACrB,CA0BA,SAASyd,GAAezgB,GACtBA,EAAK0gB,iBAAiB,gBAAgB/E,QAASgF,IAC7CA,EAAIrB,UAAUsB,OAAO,iBAAkB,gBAAiB,gBAE5D,CAEA,SAASZ,KACP,MAAMhgB,EAAO8c,GAAG,sBAChB,IAAK9c,EAAM,OACXA,EAAK6gB,UAAY,GAEjB,MAAMnC,EAAQqB,GAAarkB,OAASqkB,GAAevgB,MAAM0E,KAAK6a,GAAgBra,QAC9Ega,EAAM/C,QAAQ,CAAC9hB,EAAKkJ,KAClB,MAAMsb,EAAUU,GAAgBhmB,IAAIc,GACpC,IAAKwkB,EAAS,OAEd,MAAM/V,EAvIV,SAAyB+V,GACvB,MAAM/V,EAAQ+V,GAASC,SAASwC,aAChC,GAAIxY,EAAO,OAAOA,EAClB,MAAMmN,EAAQ4I,GAASO,gBAAgB,gBACvC,OAAOnJ,EAAQA,EAAM4H,YAAYjiB,OAASgjB,GAAcC,EAC1D,CAkIkB0C,CAAgB1C,GACxBe,EAASb,GAAgBF,GACzB2C,GAAWrB,GAAe7mB,IAAIe,IAAQulB,EAEtCuB,EAAM5D,SAASkE,cAAc,OACnCN,EAAIO,UAAY,cAChBP,EAAIrC,QAAQ6C,WAAatnB,EACzB8mB,EAAIS,aAAa,OAAQ,YAEzB,MAAMC,EAAStE,SAASkE,cAAc,UACtCI,EAAOnN,KAAO,SACdmN,EAAOH,UAAY,sBACnBG,EAAOC,WAAY,EACnBD,EAAOD,aAAa,QAAS,yBAC7BC,EAAOD,aAAa,aAAc,YAAY9Y,KAE9C,MAAMiZ,EAAUxE,SAASkE,cAAc,OACvCM,EAAQL,UAAY,qBACpBK,EAAQlE,YAAc/U,EAEtB,MAAMkZ,EAAWzE,SAASkE,cAAc,OACxCO,EAASN,UAAY,wBAErB,MAAMO,EAAQ1E,SAASkE,cAAc,UACrCQ,EAAMvN,KAAO,SACbuN,EAAMP,UAAY,wBAClBO,EAAMC,SAAqB,IAAV3e,EACjB0e,EAAML,aAAa,QAAS,UAC5BK,EAAML,aAAa,aAAc,UAAU9Y,KAC3CmZ,EAAME,iBAAiB,QAAS,IAAMtB,GAAYxmB,GAAM,IAExD,MAAM+nB,EAAU7E,SAASkE,cAAc,UACvCW,EAAQ1N,KAAO,SACf0N,EAAQV,UAAY,0BACpBU,EAAQF,SAAW3e,IAAU2b,EAAMhjB,OAAS,EAC5CkmB,EAAQR,aAAa,QAAS,aAC9BQ,EAAQR,aAAa,aAAc,aAAa9Y,KAChDsZ,EAAQD,iBAAiB,QAAS,IAAMtB,GAAYxmB,EAAK,IAEzD,MAAMgoB,EAAa9E,SAASkE,cAAc,SAC1CY,EAAWX,UAAY,oBACvBW,EAAWT,aAAa,QAAShC,EAAS,mBAAqB4B,EAAU,UAAY,YACrF,MAAMc,EAAc/E,SAASkE,cAAc,SAC3Ca,EAAY5N,KAAO,WACnB4N,EAAYC,QAAUf,EACtBc,EAAYJ,SAAWtC,EACvB0C,EAAYV,aAAa,aAAchC,EAAS,GAAG9W,qBAA2B,YAAYA,KAC1F,MAAM0Z,EAAejF,SAASkE,cAAc,QAe5C,GAdAe,EAAad,UAAY,4BACzBW,EAAW5C,YAAY6C,GACvBD,EAAW5C,YAAY+C,GACvBF,EAAYH,iBAAiB,SAAU,KACjCvC,IACA0C,EAAYC,QAASpC,GAAetmB,OAAOQ,GAC1C8lB,GAAe9f,IAAIhG,GACxBqlB,GAAuBS,IAClB5f,GAAkBP,MAAM0E,KAAKyb,KAClCK,QAGFwB,EAASvC,YAAYwC,GACrBD,EAASvC,YAAY2C,GACjBxC,EAAQ,CACV,MAAM6C,EAAUlF,SAASkE,cAAc,QACvCgB,EAAQf,UAAY,oBACpBe,EAAQ5E,YAAc,OACtB4E,EAAQb,aAAa,QAAS,oBAC9BI,EAASvC,YAAYgD,EACvB,CACAT,EAASvC,YAAY4C,GAErBlB,EAAI1B,YAAYoC,GAChBV,EAAI1B,YAAYsC,GAChBZ,EAAI1B,YAAYuC,GAChBxhB,EAAKif,YAAY0B,IAErB,CAuFA,MAGMuB,GAAqB,CAAC,EAAG,EAAG,GAAI,GAAI,GAAI,KAIxCC,GAA0B,CAAC,OAAQ,UAAW,MAAO,SAAU,QAC/DC,GAA0B,CAAC,OAAQ,UAAW,MAAO,SAAU,QAC/DC,GAAgB,cAChBC,GAAmB,iBACnBxD,GAA4B,0BAC5BU,GAAuB,oBACvB+C,GAAqB,mBAErBC,GAAoB,kBACpBC,GAAyB,uBACzBC,GAA0B,wBAGhC,IAAIC,GAAW,CAAE3qB,QAAQ,EAAOC,QAAQ,GACpC2qB,GAAe,KACfC,GAAqB,KACrBC,IAAa,EACbC,IAAgB,EAChBC,IAA0B,EAC1BC,IAAuB,EACvBC,IAAqB,EACrBnD,GAAe,GACfoD,GAAsB,GACtBxD,GAAiB,IAAIlpB,IACrBsoB,GAAkB,IAAIrmB,IACtB0qB,GAAqB,GACrBzE,GAAc,KAClB,MAAM0E,GAAkB,IAAI5sB,IAC5B,IAAI6sB,GAAa,KACbC,IAAgB,EAChBC,GAAgB,GAChBC,GAAgBvvB,EAASQ,SAE7B,MAAMgvB,GAAiB,CACrB1rB,OAAQ9D,EAASE,YACjB6D,OAAQ/D,EAASG,aAGbsvB,GAAgB,CACpB3rB,OAAQ,CACN,CACE2U,GAAI,uBACJrE,MAAO,uBACPsb,OAAQ,CAAEhf,MAAO,EAAGoQ,OAAQ,GAAI6O,YAAa,IAC7CC,UAAW,EACXC,eAAgB,EAChBC,SAAS,GAEX,CACErX,GAAI,yBACJrE,MAAO,yBACPsb,OAAQ,CAAEhf,MAAO,GAAKoQ,OAAQ,EAAG6O,YAAa,KAC9CC,UAAW,EACXC,eAAgB,EAChBE,aAAa,GAEf,CACEtX,GAAI,wBACJrE,MAAO,wBACPsb,OAAQ,CAAEhf,MAAO,GAAKoQ,OAAQ,GAAK6O,YAAa,KAChDC,UAAW,EACXC,eAAgB,IAGpB9rB,OAAQ,CACN,CACE0U,GAAI,UACJrE,MAAO,UACPsb,OAAQ,CAAEhf,MAAO,KAAMoQ,OAAQ,GAAI6O,YAAa,MAChDC,UAAW,EACXC,eAAgB,EAChBG,uBAAuB,EACvBF,SAAS,GAEX,CACErX,GAAI,aACJrE,MAAO,aACPsb,OAAQ,CAAEhf,MAAO,IAAMoQ,OAAQ,EAAG6O,YAAa,MAC/CC,UAAW,EACXC,eAAgB,EAChBE,aAAa,EACbC,uBAAuB,GAEzB,CACEvX,GAAI,aACJrE,MAAO,aACPsb,OAAQ,CAAEhf,MAAO,IAAMoQ,OAAQ,GAAK6O,YAAa,MACjDC,UAAW,EACXC,eAAgB,EAChBG,uBAAuB,KAKvBC,GAAe,CACnBnsB,OAAQ,IAAIU,IAAIirB,GAAc3rB,OAAOiD,IAAKmpB,GAAM,CAACA,EAAEzX,GAAG5Q,cAAeqoB,KACrEnsB,OAAQ,IAAIS,IAAIirB,GAAc1rB,OAAOgD,IAAKmpB,GAAM,CAACA,EAAEzX,GAAG5Q,cAAeqoB,MAGjEC,GAAkB,CACtBrsB,OAAQ,SACRC,OAAQ,UAGV,SAASqsB,GAAWC,EAAM7S,GACxB,MAAMtC,EAAQzT,KAAKC,IAAI,EAAGL,OAAOmW,IAAU,GAC3C,OAAO,IAAIlS,MAAM4P,EAAQ,GAAGjK,KAAKof,EACnC,CAEA,SAASC,GAAarwB,EAAUqP,GAC9B,MAAM3H,EAAI1C,OAAOhF,GAAY,IAAI4H,cAC3BlC,EAAMV,OAAOqK,GAAS,IAAIpI,OAAOW,cACjCd,EAAMkpB,GAAatoB,GACzB,GAAIZ,GAAOpB,GAAOoB,EAAInC,IAAIe,GAAM,OAAOoB,EAAIlC,IAAIc,GAC/C,MAAM8G,EAAW+iB,GAAe7nB,GAChC,OAAIZ,GAAO0F,GAAY1F,EAAInC,IAAI6H,EAAS5E,eAAuBd,EAAIlC,IAAI4H,EAAS5E,eACzE,IACT,CA0CA,SAAS0oB,GAA0B9S,EAAS+S,GAC1C,MAAMC,EAAW7H,GAAG,yBACpB,IAAK6H,EAAU,MAAO,GACtB,MAAMC,EApCR,SAAyCjT,GACvC,MAAM9X,EAAMV,OAAOwY,GAAW,IAAIvW,OAAOW,cACzC,OAAIlC,EAAI6D,SAAS,aAAe7D,EAAI6D,SAAS,SACpC,CAAC,OAAQ,UAAW,MAAO,SAAU,QAE1C7D,EAAI6D,SAAS,YACR,CAAC,OAAQ,MAAO,QAErB7D,EAAI6D,SAAS,cACR,CAAC,OAAQ,UAAW,MAAO,SAAU,QAEvC,CAAC,OAAQ,MAAO,OACzB,CAwBkBmnB,CAAgClT,GAChD,IAAIrJ,EAAQwc,GAAwBJ,EAAWvC,IAC1C7Z,IAAOA,EAAQ6Z,GAAwB,IACvCyC,EAAQlnB,SAAS4K,KACN,YAAVA,IAAqBA,EAAQ,OACnB,WAAVA,IAAoBA,EAAQ,SAElCA,EA7BF,SAA8BA,EAAOsc,EAASG,GAC5C,IAAKzc,EAAO,OAAOsc,EAAQ,IAAM,GACjC,GAAIA,EAAQlnB,SAAS4K,GAAQ,OAAOA,EACpC,MAAM2B,EAAM8a,EAAOzE,QAAQhY,GAC3B,GAAI2B,EAAM,EAAG,OAAO2a,EAAQ,IAAM,GAClC,IAAIjnB,EAAOinB,EAAQ,IAAM,GACrBI,EAAWzpB,OAAO0pB,kBACtB,IAAK,MAAMnnB,KAAU8mB,EAAS,CAC5B,MAAMM,EAASH,EAAOzE,QAAQxiB,GAC9B,GAAIonB,EAAS,EAAG,SAChB,MAAMC,EAAOxpB,KAAKkC,IAAIqnB,EAASjb,GAC3Bkb,EAAOH,IACTA,EAAWG,EACXxnB,EAAOG,EAEX,CACA,OAAOH,CACT,CAYUynB,CAAqB9c,EAAOsc,EAASzC,IAC7C,MAAMpf,EAAQof,GAAwB7B,QAAQhY,GAG9C,OAFAqc,EAAS5qB,MAAQZ,OAAO4J,GAAS,EAAIA,EAAQ,GAC7C4hB,EAASvD,aAAa,iBAAkB9Y,GACjCA,CACT,CAEA,SAASwc,GAAwB/qB,EAAOgrB,EAAS3C,IAC/C,MAAMtlB,EAAM3D,OAAOY,GAAS,IAAIqB,OAAOW,cACvC,IAAKe,EAAK,MAAO,GACjB,MAAMmN,EAAM1O,OAAOuB,GACnB,OAAIvB,OAAOC,SAASyO,GAEX8a,EADSppB,KAAK+E,IAAIqkB,EAAOrpB,OAAS,EAAGC,KAAKC,IAAI,EAAGD,KAAKyS,MAAMnE,OACzC,GAErBnN,CACT,CAEA,SAASuoB,GAA0B1T,EAAS+S,GAC1C,MAAMC,EAAW7H,GAAG,yBACpB,IAAK6H,EAAU,MAAO,GACtB,MAAMW,EAvER,SAA+B9hB,GAC7B,MAAM3J,EAAMV,OAAOqK,GAAS,IAAIpI,OAAOW,cACjCqH,EAAO+gB,GAAalsB,QAAQc,IAAIc,GACtC,OAAIuJ,GAA8C,kBAA/BA,EAAK8gB,uBAA4C9gB,EAAK8gB,qBAE3E,CAkEoBqB,CAAsB5T,GAClC6T,EAAOb,EAASc,QAAQ,cAC1BD,GAAMA,EAAKlG,UAAUC,OAAO,sBAAuB+F,GACvDX,EAASrG,QAAQgH,UAAYA,EAAY,IAAM,IAE/C,MAAMV,EAAUU,EAAYlD,GAA0BA,GAAwBrkB,MAAM,GACpF,IAAIiF,EAAO8hB,GAAwBJ,GAC9BE,EAAQlnB,SAASsF,KACpBA,EAAO4hB,EAAQ,IAAM,WAEvB,MAAM7hB,EAAQqf,GAAwB9B,QAAQtd,GAG9C,OAFA2hB,EAAS5qB,MAAQZ,OAAO4J,GAAS,EAAIA,EAAQ,GAC7C4hB,EAASvD,aAAa,iBAAkBpe,GACjCA,CACT,CAEA,SAAS0iB,GAAW3rB,GAClB,MAAMuB,EAAIC,OAAOxB,GACjB,IAAKwB,OAAOC,SAASF,GAAI,MAAO,GAAGmiB,MACnC,MAAMkI,EAAWrqB,GAAK,EAAI,EAAI,EAC9B,IAAIwF,EAAOxF,EAAEqiB,QAAQgI,GAErB,OADA7kB,EAAOA,EAAKE,QAAQ,SAAU,IACvB,GAAGyc,KAAkB3c,GAC9B,CAEA,SAAS8kB,GAAgBxiB,GACvB,MAAO,CACLyiB,KAAMvB,GA3kBQ,IA2kBclhB,EAAK0gB,WACjChQ,UAAWwQ,GA3kBK,KA2kBmBlhB,EAAK2gB,gBAE5C,CAEA,SAAS+B,GAAiB1iB,GACxB,MAAM2iB,EAAaH,GAAgBxiB,GAC7B4iB,EAAW5iB,EAAK6gB,YAAc,KAAsB,GAE1D,MAAO,GADS7gB,EAAK4gB,QAAU,KAAO,KAClBgC,IAAW5iB,EAAKuJ,QAAQoZ,EAAWF,UAAUE,EAAWjS,WAC9E,CAEA,SAASmS,GAAwB9xB,EAAUwd,GACzC,MAAMuU,EAAW/xB,IAAaN,EAAUG,OAClCmyB,EAAsBrJ,GAAXoJ,EAAc,cAAoB,eAC7CE,EAAuBtJ,GAAXoJ,EAAc,qBAA2B,sBAC3D,IAAKC,IAAaC,EAAW,OAC7B,MAAMhjB,EAAOohB,GAAarwB,EAAUwd,GAAWwU,EAASpsB,OAClDssB,IAASjjB,GAAM4gB,QACrBoC,EAAU9G,UAAUC,OAAO,aAAc8G,GACzCF,EAAS7G,UAAUC,OAAO,iBAAkB8G,EAC9C,CAEA,SAASC,GAAaplB,GACpB,IAAKA,EAAO,OAAO,EACnB,GAAIA,EAAM4H,OAAStJ,MAAMC,QAAQyB,EAAM6H,aACrC,OAAO7H,EAAM6H,YAAYwd,OAAO,CAACC,EAAK5mB,IAC/BA,EACE4mB,EAAMF,GAAa,CACxBnyB,SAAUyL,EAAKzL,SACfqP,MAAO5D,EAAK4D,MACZkE,YAAa9H,EAAK8H,YAClBC,aAAc/H,EAAK+H,aACnBC,gBAAiBhI,EAAKgI,gBACtBC,kBAAmBjI,EAAKiI,oBAPR2e,EASjB,GAEL,MACMpjB,EAAOohB,GADIrrB,OAAO+H,EAAM/M,UAAY,IAAI4H,cACVmF,EAAMsC,OAC1C,IAAKJ,EAAM,OAAO,EAElB,MAAMsE,EAAc/L,KAAKC,IAAI,EAAGL,OAAO2F,EAAMwG,aAAe,IACtDC,EAAehM,KAAKC,IAAI,EAAGL,OAAO2F,EAAMyG,cAAgB,IACxDC,EAAkBjM,KAAKC,IAAI,EAAGL,OAAO2F,EAAM0G,iBAAmB,IAC9DC,EAAoBlM,KAAKC,IAAI,EAAGL,OAAO2F,EAAM2G,mBAAqB,IAClE4e,EAAuB9e,EAAeC,EAEtC/K,EAASlB,KAAK+E,IAAImH,EAAmBH,GACrCgf,EAAW/qB,KAAKC,IAAI,EAAG8L,EAAc7K,GAErC+mB,EAASxgB,EAAKwgB,QAAU,CAAC,EAK/B,OAAQ8C,EAAW,IAJDnrB,OAAOqoB,EAAOhf,OAAS,GAIF/H,EAAS,IAH7BtB,OAAOqoB,EAAOC,aAAeD,EAAOhf,OAAS,GAGK6hB,EAAuB,IAFzElrB,OAAOqoB,EAAO5O,QAAU,EAG7C,CAEA,SAAS2R,GAAY5sB,GACnB,MAAMuB,EAAIC,OAAOxB,GACjB,OAAKwB,OAAOC,SAASF,IAAMA,GAAK,EAAU,EACnCK,KAAK8L,MAAMnM,EACpB,CAmGA,SAASsrB,GAAoB1lB,GAC3B,MAAO,CACL/M,SAAU+M,GAAO/M,UAAY,GAC7BuT,YAAanM,OAAO2F,GAAOwG,aAAe,GAC1CC,aAAcpM,OAAO2F,GAAOyG,cAAgB,GAC5CC,gBAAiBrM,OAAO2F,GAAO0G,iBAAmB,GAClDC,kBAAmBtM,OAAO2F,GAAO2G,mBAAqB,GACtDoG,YAAa1S,OAAO2F,GAAO+M,aAAe,GAC1CpH,KAAM3F,GAAO2F,GACbhS,QAASqM,GAAOrM,MAChByL,GAAI/E,OAAO2F,GAAOZ,IAAM,GACxB+N,GAAInN,GAAOmN,IAAM,KACjB7K,MAAOtC,GAAOsC,OAAS,GACvB1E,GAAIvD,OAAO2F,GAAOpC,IAAM,GACxBwM,QAASpK,GAAOoK,SAAW,GAC3B0F,gBAAiB9P,GAAO8P,iBAAmB,GAC3CvM,KAAMvD,GAAOuD,MAAQ,GACrB+L,QAAStP,GAAOsP,SAAW,GAE/B,CAEA,SAASqW,GAAoB1yB,EAAUgyB,EAAUW,GAC/C,IAAKX,EAAU,OACf,MAAMnmB,EAAO2jB,GAAcxvB,IAAa,GAClC4yB,EAAY5tB,OAAO2tB,GAAgB,IAAI1rB,OACvC4rB,EAAeD,EAAUhrB,cACzB4E,EAAW+iB,GAAevvB,IAAa,GAE7CgyB,EAAStF,UAAY,GACrB,IAAIoG,GAAU,EAEd,IAAK,MAAM7jB,KAAQpD,EAAM,CACvB,MAAMlC,EAASif,SAASkE,cAAc,UACtCnjB,EAAO/D,MAAQqJ,EAAKuJ,GACpB7O,EAAOuf,YAAcyI,GAAiB1iB,GAClCA,EAAK4gB,UACPlmB,EAAOwgB,QAAQ0F,QAAU,IACzBlmB,EAAOopB,MAAMC,MAAQ,UACrBrpB,EAAOopB,MAAME,WAAa,OAExBhkB,EAAKuJ,GAAG5Q,gBAAkBirB,IAC5BlpB,EAAOupB,UAAW,EAClBJ,GAAU,GAEZd,EAASlH,YAAYnhB,EACvB,CAEA,GAAIipB,IAAcE,EAAS,CACzB,MAAMnpB,EAASif,SAASkE,cAAc,UAKtC,OAJAnjB,EAAO/D,MAAQgtB,EACfjpB,EAAOuf,YAAc,GAAG0J,iBACxBjpB,EAAOupB,UAAW,OAClBlB,EAASlH,YAAYnhB,EAEvB,EAEKipB,GAAapmB,IAChBwlB,EAASpsB,MAAQ4G,EAErB,CAgDA,SAAS2mB,GAAa3a,EAAI4a,GACxB,MAAMC,EAAQ1K,GAAGnQ,GACZ6a,IACLA,EAAMlI,UAAUC,OAAO,UAAWgI,GAClCC,EAAMpG,aAAa,cAAemG,EAAS,QAAU,QACvD,CAEA,SAASE,GAAY9a,GACnB,MAAM6a,EAAQ1K,GAAGnQ,GACjB,QAAS6a,GAASA,EAAMlI,UAAUoI,SAAS,UAC7C,CAEA,SAASC,GAAqBJ,GAC5BD,GAAa,gBAAiBC,EAChC,CAEA,SAASK,GAAoBL,GAC3BD,GAAa,eAAgBC,EAC/B,CAEA,SAASM,GAAuBN,GAC9BD,GAAa,kBAAmBC,EAClC,CAEA,SAASO,GAA2BP,GAClCD,GAAa,sBAAuBC,EACtC,CAOA,SAASQ,KACPH,IAAoB,EACtB,CAEA,SAASI,GAAa7zB,EAAU8zB,GAC9B,MAAMphB,IAAOohB,EACblL,SAAS2D,iBAAiB,sCAA2CvsB,OAAcwnB,QAASuM,IAC1FA,EAAK7K,YAAcxW,EAAK,kBAAoB,gBAC5CqhB,EAAK5I,UAAUC,OAAO,iBAAkB1Y,GACxCqhB,EAAK5I,UAAUC,OAAO,uBAAwB1Y,IAElD,CAEA,SAASshB,KACPpL,SAAS2D,iBAAiB6B,IAAoB5G,QAAS/W,IACrD,MAAMzQ,EAAWgF,OAAOyL,EAAM0Z,QAAQ8J,UAAY,IAAIhtB,OAAOW,cACzD5H,IAAaN,EAAUG,OACzB4Q,EAAMyjB,YAAc1F,GAAS3qB,OAAS,gDAAkD,UAC/E7D,IAAaN,EAAUI,SAChC2Q,EAAMyjB,YAAc1F,GAAS1qB,OAAS,gDAAkD,WAG9F,CAUA,SAASqwB,KACP,QAAS3F,GAAS3qB,UAAY2qB,GAAS1qB,MACzC,CAcA,SAASmoB,KACP,MAAM/B,EAAUtB,SAAS6B,cAAc,+BACvC,IAAKP,EAAS,OACd,IAAK0E,KAAkBD,KAAeG,GAAsB,OAC5D,MAAMsF,IAPI3F,IAAgBA,GAAa/oB,KAAOgjB,GAAe+F,MARpDD,GAAS3qB,QAAY2qB,GAAS1qB,QAIX+qB,IAA2BsF,OAYvDjK,EAAQiB,UAAUC,OAAO,aAAcgJ,GACnCA,GAAclK,EAAQiB,UAAUoI,SAASlI,MAC3CG,GAAetmB,OAAO,cACtB6mB,GAAqB1gB,MAAM0E,KAAKyb,KAEpC,CAEA,SAAS6I,GAAar0B,EAAU8zB,GAC9B,MAAM/B,EAAW/xB,IAAaN,EAAUG,OAClCy0B,EAAU3L,GAAGoJ,EAAW,cAAgB,eACxCvB,EAAW7H,GAAGoJ,EAAW,wBAA0B,yBACnDwC,EAAS5L,GAAGoJ,EAAW,kBAAoB,mBAC3CxE,GAAYuG,EACdQ,IAASA,EAAQ/G,SAAWA,GAC5BiD,IAAUA,EAASjD,SAAWA,GAC9BgH,GAAQA,EAAOpJ,UAAUC,OAAO,aAAcmC,EACpD,CAwBA,SAASiH,KACPH,GAAa30B,EAAUG,SAAU2uB,GAAS3qB,QAC1CwwB,GAAa30B,EAAUI,SAAU0uB,GAAS1qB,QAxB5C,WACE,MAAM2wB,EAAY9L,GAAG,kBACf+L,EAAY/L,GAAG,kBACfgM,IAAcnG,GAAS3qB,OACvB+wB,IAAcpG,GAAS1qB,OAEzB2wB,IAAWA,EAAUlH,UAAYoH,GACjCD,IAAWA,EAAUnH,UAAYqH,GAErC,MAAML,EAAS5L,GAAG,sBAClB,IAAK4L,EAAQ,OACb,MAAMM,EAASlM,GAAG,0BAElB,IAAIxR,EAAU,GACTwd,GAAcC,IACjBzd,EAAU,sDAGZod,EAAOpJ,UAAUC,OAAO,aAAcjU,GAClC0d,IAAQA,EAAO3L,YAAc/R,EACnC,CAKE2d,EACF,CAEA,SAASC,GAAqB9M,GAC5B,MAAMtf,EAAM3D,OAAOijB,GAAa,IAAIhhB,OACpC,IAAK0B,EAAK,OAAO,EACjB,MAAMgC,EAAKsB,KAAK2B,MAAMjF,GACtB,OAAOvB,OAAOC,SAASsD,GAAMA,EAAK,CACpC,CAEA,SAASqqB,GAAoB/M,GAC3B,MAAMtd,EAAKoqB,GAAqB9M,GAChC,OAAKtd,EAz7BP,SAAoBA,GAClB,IAEE,OADU,IAAIsB,KAAKtB,GACVsqB,mBAAmB,QAAS,CAAEC,KAAM,UAAWC,MAAO,QAASC,IAAK,WAC/E,CAAE,MACA,MAAO,EACT,CACF,CAm7BSC,CAAW1qB,GADF,EAElB,CAkBA,SAAS2qB,GAAiBvB,EAAMpnB,EAAM+F,GAC/BqhB,IACLA,EAAK7K,YAAcvc,GAAQ,GAC3BonB,EAAKzS,MAAQ3U,GAAQ,GACrBonB,EAAK9G,aAAa,aAActgB,GAAQ,IACxConB,EAAK5I,UAAUC,OAAO,iBAAkB1Y,GACxCqhB,EAAK5I,UAAUC,OAAO,uBAAwB1Y,GAChD,CAEA,SAAS6iB,GAAoB5oB,EAAM+F,GACjCkW,SAAS2D,iBAAiBgC,IAAyB/G,QAASuM,IAC1DuB,GAAiBvB,EAAMpnB,EAAM+F,IAEjC,CASA,SAAS8iB,GAAuBC,EAAW1vB,EAAU,CAAC,GACpD,MAAM,MAAE2vB,GAAQ,EAAK,QAAE/J,GAAU,GAAS5lB,EACpCgH,EAAQ4b,GAAG,gBACXgN,EAAYhN,GAAG,oBACrB,IAAK5b,EAAO,OACZA,EAAMoe,UAAUC,OAAO,aAAcqK,GACjC9J,IAAS+C,GAAqB+G,GAC9BE,GAAWA,EAAUxK,UAAUC,OAAO,YAAaqK,GACvD,MAAMG,EAAejN,GAAG,wBAClBkN,EAAUlN,GAAG,mBAOnB,GANIiN,GAAgBC,IAClBD,EAAazK,UAAUC,OAAO,0BAA2BqK,GACzDI,EAAQ1K,UAAUC,OAAO,yBAA0BqK,GACnDG,EAAa3I,aAAa,gBAAkBwI,EAAqB,QAAT,QACxDI,EAAQ5I,aAAa,gBAAiBwI,EAAY,OAAS,UAEzDA,GAAaC,EAAO,CACtB,MAAMjlB,EAAQkY,GAAG,mBACblY,GAAOA,EAAMilB,OACnB,CACF,CAgCAlxB,eAAesxB,GAAiB/vB,EAAU,CAAC,GACzC,MAAM,OAAEgwB,GAAS,GAAUhwB,EACrBO,QAAeiiB,KACrBkG,GAAenoB,EACfsoB,IAAgB,EA/DlB,SAAkC7iB,GAChC,MAAMiqB,EAhCR,SAA8BjqB,GAC5B,IAAKA,IAAYA,EAAQrG,IACvB,MAAO,CAAEgN,IAAI,EAAO/F,KAAM,8BAG5B,GAAI+b,GAAe3c,GAAU,CAC3B,MAAMkqB,EAASjB,GAAoBjpB,EAAQkc,WAE3C,MAAO,CAAEvV,IAAI,EAAM/F,KAAM,kBADVspB,EAAS,wBAAwBA,IAAW,IAE7D,CAEA,MAAMhO,EAAY8M,GAAqBhpB,EAAQkc,WAE/C,MAAO,CAAEvV,IAAI,EAAO/F,KADJsb,GAAaA,GAAahc,KAAK/D,MACX,kBAAoB,mBAC1D,CAkBkBguB,CAAqBnqB,GACrC6c,SAAS2D,iBAAiBgC,IAAyB/G,QAASuM,IAC1DuB,GAAiBvB,EAAMiC,EAAQrpB,KAAMqpB,EAAQtjB,KAEjD,CA2DEyjB,CAAyB7vB,GACzB,MAAM8vB,KAAiB9vB,IAAUA,EAAOZ,KAAQgjB,GAAepiB,IAE/DkvB,GAD0C,OAAvB9G,GAA8B0H,EAAc1H,GAC5B,CAAE/C,SAAS,IAtChD,SAAmC5f,GACjC,MAAMmoB,EAAcnoB,GAASrG,IAAM,gDAhiCT,sBAiiC1BkjB,SAAS2D,iBAAiB+B,IAAwB9G,QAAS/W,IACzDA,EAAMyjB,YAAcA,GAExB,CAkCEmC,CAA0B/vB,GAhC5B,SAA2ByF,GACzB,MAAMuqB,EAAQ1N,SAAS2D,iBAhrBK,uBAirB5B,IAAK+J,EAAM/uB,OAAQ,OACnB,IAAIoF,EAAO,sDACX,GAAIZ,GAAW2c,GAAe3c,IAAYA,EAAQkc,UAAW,CAC3D,MAAMgO,EAASjB,GAAoBjpB,EAAQkc,WAC3Ctb,EAAOspB,EAAS,qBAAqBA,IAAW,gBAClD,MAAO,GAAIlqB,IAAY2c,GAAe3c,GAAU,CAC9C,MAAMkqB,EAASjB,GAAoBjpB,EAAQkc,WAC3Ctb,EAAOspB,EAAS,sBAAsBA,IAAW,kBACnD,CACAK,EAAM9O,QAASvY,IACbA,EAAKia,YAAcvc,GAEvB,CAmBE4pB,CAAkBjwB,GAjBpB,SAAqCyF,GACnC,MAAMyqB,EAAO7N,GAAG,oBAChB,IAAK6N,EAAM,OACX,MAAMtL,KAAgBnf,IAAW2c,GAAe3c,IAChDyqB,EAAKrL,UAAUC,OAAO,YAAaF,EACrC,CAaEuL,CAA4BnwB,GAC5B2lB,MACK8J,GAAUzvB,GAAUoiB,GAAepiB,IACtCwiB,GAAU,iBAAkB,CAAEb,UAAW3hB,EAAO2hB,WAAa,OAEjE,CAEA,SAASyO,GAAS9wB,GAChB,MAAMuB,EAAIC,OAAOxB,GACjB,OAAKwB,OAAOC,SAASF,GACdK,KAAK+E,IA5uBQ,GA4uBW/E,KAAKC,IA7uBhB,EA6uBmCD,KAAKyS,MAAM9S,KA7uB9C,CA8uBtB,CAEA,SAASwvB,GAAYC,GACnB,MAAMC,EAAS,GAAKH,GAASE,GAC7B,OAAOpvB,KAAK+E,IAAIsqB,EAhvBQ,MAivB1B,CAiBA,SAASC,GAAmB92B,GAC1B,MAAM+xB,EAAW/xB,IAAaN,EAAUG,OACxC8oB,GAAG,kBAAkBwC,UAAUC,OAAO,yBAA0B2G,GAChEpJ,GAAG,kBAAkBwC,UAAUC,OAAO,0BAA2B2G,GACjEpJ,GAAG,kBAAkBsE,aAAa,eAAgB8E,EAAW,OAAS,SACtEpJ,GAAG,kBAAkBsE,aAAa,eAAiB8E,EAAoB,QAAT,QAdhE,SAA6B/xB,GAC3B,MAAM+2B,EAAQpO,GAAG,uBACjB,IAAKoO,EAAO,OACZ,MAAM5iB,EAAQ+b,GAAgBlwB,KAAcA,EAAWA,EAAS0d,cAAgB,KAChFqZ,EAAM7N,YAAc/U,EACpB4iB,EAAMzV,MAAQ,gBAAgBnN,IAC9B4iB,EAAM9J,aAAa,aAAc,gBAAgB9Y,IACnD,CAQE6iB,CAAoBh3B,EACtB,CAcA,SAASi3B,GAAsBrxB,GAC7B,MAAMuB,EAAIC,OAAOxB,GACjB,OAAKwB,OAAOC,SAASF,GACdK,KAAKC,IAAI,EAAGD,KAAK+E,IAAIwhB,GAAmBxmB,OAAS,EAAGC,KAAKyS,MAAM9S,KADtC,CAElC,CAEA,SAAS+vB,GAAwBtoB,GAC/B,OAAOmf,GAAmBkJ,GAAsBroB,GAClD,CAiBA,SAASuoB,KACP,MACMvxB,EAAQsxB,GADAD,GAAsBtO,GAAG,oBAAoB/iB,QAG3D,OADA+iB,GAAG,oBAAoBO,YAAcE,GAAaxjB,GAC3CA,CACT,CAEA,SAASwxB,GAAuBxxB,GAC9B,MAAMuB,EAAIC,OAAOxB,GACjB,OAAKwB,OAAOC,SAASF,GACdK,KAAKC,IAxzBE,EAwzBWD,KAAK+E,IAvzBhB,IAuzB6B/E,KAAKyS,MAAM9S,KADtBpH,EAASQ,QAE3C,CAUA,SAAS82B,GAAYC,GACnB,MAAMvF,EAAmB,WAARuF,EACjB3O,GAAG,aAAawC,UAAUC,OAAO,cAAe2G,GAChDpJ,GAAG,aAAawC,UAAUC,OAAO,eAAgB2G,GAEjDpJ,GAAG,aAAasE,aAAa,gBAAiB8E,EAAW,OAAS,SAClEpJ,GAAG,aAAasE,aAAa,gBAAkB8E,EAAoB,QAAT,QAE1DpJ,GAAG,eAAewC,UAAUC,OAAO,oBAAqB2G,GACxDpJ,GAAG,eAAewC,UAAUC,OAAO,qBAAsB2G,EAC3D,CAEAvtB,eAAe+yB,GAAUxxB,EAAU,CAAC,GAClC,MAAM,kBAAEyxB,GAAoB,EAAK,OAAEzB,GAAS,GAAUhwB,EACtD4iB,GAAG,kBAAkBO,YH3mCd/jB,IAAoBf,KG6mC3B,MACEpE,EACAy3B,EACAn3B,EACAC,EACAm3B,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,SACQ5rB,QAAQ6rB,IAAI,CACpBhwB,IACAgB,IACAa,IACAI,KACAzB,EAAS/I,EAAUG,QACnB4I,EAAS/I,EAAUI,QACnByI,EAAU7I,EAAUG,QACpB0I,EAAU7I,EAAUI,QACpB+I,IACAC,IACAsB,OAGF0sB,GAAmB92B,GAEnB,MAAM42B,EA9HR,SAAqBC,GACnB,MAAM1vB,EAAIC,OAAOyvB,GACjB,OAAKzvB,OAAOC,SAASF,IAAMA,GAAK,EAvvBZ,EAwvBbuvB,GAASlvB,KAAK0wB,KAAK/wB,GAC5B,CA0HcgxB,CAAYV,GAClBW,EAAmBzB,GAAYC,GACrCjO,GAAG,kBAAkB/iB,MAAQZ,OAAO4xB,GACpCjO,GAAG,kBAAkBO,YAAcE,GAAagP,GAC5CA,IAAqBX,SACjBtuB,EAAmBivB,GAG3B,MAAMC,EAxFR,SAAiCzyB,GAC/B,MAAMuB,EAAIC,OAAOxB,GACjB,IAAKwB,OAAOC,SAASF,GAAI,OAAO,EAChC,IAAImxB,EAAY,EACZ7uB,EAAWjC,KAAKkC,IAAIqkB,GAAmB,GAAK5mB,GAChD,IAAK,IAAIgK,EAAI,EAAGA,EAAI4c,GAAmBxmB,OAAQ4J,GAAK,EAAG,CACrD,MAAMtH,EAAOrC,KAAKkC,IAAIqkB,GAAmB5c,GAAKhK,GAC1C0C,EAAOJ,IACTA,EAAWI,EACXyuB,EAAYnnB,EAEhB,CACA,OAAOmnB,CACT,CA2E2BC,CAAwBj4B,GAC3Ck4B,EAAwBtB,GAAwBmB,GACtD1P,GAAG,oBAAoB/iB,MAAQZ,OAAOqzB,GACtC1P,GAAG,oBAAoBO,YAAcE,GAAaoP,GAC9CA,IAA0Bl4B,SACtByJ,EAAoByuB,GAG5B,MAAMC,EAAgBrB,GAAuB72B,GAC7C+uB,GAAgBmJ,EAChB,MAAMC,EAAW/P,GAAG,iBAChB+P,IACFA,EAAS9yB,MAAQZ,OAAOyzB,GACpBA,IAAkBl4B,SACd4J,GAAYsuB,IAKtB,MAAME,EAAgBhQ,GAAG,eACnBiQ,EAAgBjQ,GAAG,eACzB+J,GAAoBhzB,EAAUG,OAAQ84B,EAAejB,GACrDhF,GAAoBhzB,EAAUI,OAAQ84B,EAAejB,GACrD,MAAMkB,EAAsBF,EAAgBA,EAAc/yB,MAAQ8xB,EAC5DoB,EAAsBF,EAAgBA,EAAchzB,MAAQ+xB,EAC5DoB,EAAmBzI,GAA0BuI,EAAqBf,GACpEiB,GAAoBA,IAAqBjB,SACrC9uB,EAAyB+vB,GAEjC,MAAMC,EAAa9H,GAA0B4H,EAAqBf,GAC5DkB,EAAkBD,GAAcjB,EAClCiB,GAAcA,IAAejB,SACzBhvB,EAAyBiwB,GAGjClH,GAAwBpyB,EAAUG,OAAQg5B,GAC1C/G,GAAwBpyB,EAAUI,OAAQg5B,GAGrCtB,GACH5O,SAAS2D,iBAAiB6B,IAAoB5G,QAAS/W,IACrDA,EAAM7K,MAAQ,KA7XlB4oB,GAAW,CACT3qB,SAgYU+zB,EA/XV9zB,SA+XyB+zB,GA7X3B7D,KA8XAnF,KAA4BmJ,EAC5BlJ,IAAuB,EAClB8I,GAAkBC,IAAiBG,IACtCnJ,IAA0B,QACpBxkB,IAA2B,IAEnCskB,IAAa,EAEbkF,GAAan0B,EAAUG,OAAQ+3B,GAC/B/D,GAAan0B,EAAUI,OAAQ+3B,GAC/BrD,KACAvI,KAEK8J,GACHjN,GAAU,wBAAyB,CACjCoQ,gBAAiBl5B,EACjBK,gBAAiB+3B,EACjBv0B,OAAQ,CAAE6B,IAAKkyB,EAAgB,MAAQ,UAAWvoB,MAAOqoB,EAAU7a,gBAAiBkc,GACpFj1B,OAAQ,CAAE4B,IAAKmyB,EAAgB,MAAQ,UAAWxoB,MAAOsoB,EAAU9a,gBAAiBoc,IAG1F,CAEA,SAASE,GAAkBhlB,EAAO0iB,EAAQnF,EAAM0H,GAC9C,MAAM5M,EAAM5D,SAASkE,cAAc,OACnCN,EAAIO,UAAY,mBAAkBqM,EAAQ,sBAAwB,yBAElE,MAAM3pB,EAAOmZ,SAASkE,cAAc,OAEpC,GADArd,EAAKsd,UAAY,kBACbqM,EAAO,CACT,MAAM/pB,EAAQuZ,SAASkE,cAAc,QACrCzd,EAAM0d,UAAY,mBAClB1d,EAAM6Z,YAAc/U,EACpB1E,EAAKqb,YAAYzb,EACnB,MACEI,EAAKyZ,YAAc/U,EAGrB,MAAMklB,EAAWzQ,SAASkE,cAAc,OACxCuM,EAAStM,UAAY,oBACrBsM,EAASnQ,YAAc,GAAGE,GAAayN,YAEvC,MAAMyC,EAAS1Q,SAASkE,cAAc,OAOtC,OANAwM,EAAOvM,UAAY,kBACnBuM,EAAOpQ,YAAcK,GAAWmI,GAEhClF,EAAI1B,YAAYrb,GAChB+c,EAAI1B,YAAYuO,GAChB7M,EAAI1B,YAAYwO,GACT9M,CACT,CAmEAhoB,eAAe+0B,MA7Bf,SAA4BzuB,GAC1B,MAAM0uB,EAAY7Q,GAAG,eACrB,IAAK6Q,EAAW,OAChB,MAAMhvB,EAASpD,OAAO0D,GAAQN,QAAU,GAClCC,EAASrD,OAAO0D,GAAQL,QAAU,GAClCgvB,EAAQjyB,KAAKC,IAAI,EAAG+C,GAAUhD,KAAKC,IAAI,EAAGgD,GAC1CC,EAAMtD,OAAO0D,GAAQJ,KAAO,GAC5BgvB,EAAYD,EAAQ,EACpBE,EAAUjvB,EAAM,EAEhBkvB,EAAOjR,GAAG,mBACZiR,GAAMA,EAAKzO,UAAUC,OAAO,aAAcsO,GAC9C,MAAMG,EAAQlR,GAAG,aAGjB,GAFIkR,GAAOA,EAAM1O,UAAUC,OAAO,aAAcuO,IAE3CD,IAAcC,EAEjB,YADAH,EAAUrO,UAAUzf,IAAI,aAG1B8tB,EAAUrO,UAAUsB,OAAO,aAE3B,MAAMoI,EAASlM,GAAG,mBACdkM,IAAQA,EAAO3L,YAtCrB,SAA+BuQ,GAC7B,MAAMtyB,EAAIC,OAAOqyB,GACjB,OAAKryB,OAAOC,SAASF,IAAMA,GAAK,EAAU,GACnC,GAAGiiB,GAAajiB,aAAaA,EAAI,EAAI,IAAM,aACpD,CAkCmC2yB,CAAsBL,IACvD,MAAMM,EAAYpR,GAAG,iBACjBoR,IAAWA,EAAU7Q,YAlC3B,SAA6BjO,EAAO6D,GAClC,MAAM3X,EAAIC,OAAO6T,GACjB,IAAK7T,OAAOC,SAASF,IAAMA,GAAK,EAAG,MAAO,GAC1C,MAAM6yB,EAAM5yB,OAAO0X,GACnB,OAAI1X,OAAOC,SAAS2yB,IAAQA,EAAM,EACzB,OAAO5Q,GAAajiB,MAAMiiB,GAAa4Q,KAEzC,OAAO5Q,GAAajiB,IAC7B,CA0ByC8yB,CAAoBvvB,EAAK4kB,KAChE,MAAM4K,EAAUvR,GAAG,aACfuR,GAASA,EAAQ/O,UAAUC,OAAO,YAAa3gB,GAAU,EAC/D,CAIE0vB,OH52BK31B,iBACL,MAAMmE,QAAY7C,EAAOlF,EAAauB,gBACtC,IAAKwG,EAAK,OAAO4B,GAAuB,MACxC,IACE,OAAOA,GAAuBQ,KAAK6C,MAAMjF,GAC3C,CAAE,MACA,OAAO4B,GAAuB,KAChC,CACF,CGm2BuB6vB,GAEvB,CAEA51B,eAAe61B,KACb,MACMC,SHqUD91B,eAA6BuB,EAAU,CAAC,GACzC+L,GAAWvK,cACPqO,KAER,MAAMjG,IAAU5J,GAASw0B,MACnBryB,EAAMC,KAMZ,OALIwH,IAAUgC,IAAqBzJ,EAAM0J,GAA0B,WAC3De,IAAe,SAEfA,IAAe,GAEhBlB,GAAY7H,OACrB,CGlVwB4wB,CAAc,CAAED,OAAO,KACxBzzB,IAAI2rB,IAAqBnkB,KAAK,CAACC,EAAGC,IAAMA,EAAE7D,GAAK4D,EAAE5D,IACtE0kB,GAAgBiL,EAEhB,MAAMG,QH0MDj2B,eAA8BuB,EAAU,CAAC,GAC1C+L,GAAWvK,cACPqO,KAER,MAAMjG,IAAU5J,GAASw0B,MACnBryB,EAAMC,KAMZ,OALIwH,IAAUyC,IAAsBlK,EAAMmK,GAtcV,WAucxB2B,IAAgB,SAEhBA,IAAgB,GAjN1B,SAA0BpO,GACxB,IACE,OAAOmF,KAAK6C,MAAM7C,KAAKC,UAAUpF,GAASsM,MAC5C,CAAE,MACA,OAAOA,IACT,CACF,CA6MSwoB,CAAiBzoB,GAC1B,CGtN4B0oB,CAAe,CAAEJ,OAAO,KAC5C,MAAEd,EAAK,UAAEmB,GAxwBjB,SAA8BC,GAC5B,MAAMC,EAAaD,GAA4B,iBAAXA,EAAsBA,EAAS,CAAC,EAC9DD,EAAY,CAChB/2B,OAAQ,CAAEgzB,OAAQ,EAAGnF,KAAM,EAAG5d,OAAQ,IAAIvP,KAC1CT,OAAQ,CAAE+yB,OAAQ,EAAGnF,KAAM,EAAG5d,OAAQ,IAAIvP,MAGtCk1B,EAAQ,CACZlmB,YAAaif,GAAYsI,EAAWvnB,aACpCE,gBAAiB+e,GAAYsI,EAAWrnB,iBACxCD,aAAcgf,GAAYsI,EAAWtnB,cACrCE,kBAAmB8e,GAAYsI,EAAWpnB,mBAC1Cge,KAAM,EACN/d,SAAU6e,GAAYsI,EAAWnnB,UACjCE,WAAY,CACVhQ,OAAQ,CAAEgzB,OAAQ,EAAGnF,KAAM,GAC3B5tB,OAAQ,CAAE+yB,OAAQ,EAAGnF,KAAM,KAIzBqJ,EAAe,CACnBl3B,OAAQ,CAAE4M,MAAO,EAAGoQ,OAAQ,EAAGlB,UAAW,EAAGjX,OAAQ,GACrD5E,OAAQ,CAAE2M,MAAO,EAAGoQ,OAAQ,EAAGlB,UAAW,EAAGjX,OAAQ,IAGvD,IAAK,MAAM1I,IAAY,CAACN,EAAUG,OAAQH,EAAUI,QAAS,CAC3D,MAAM0V,EAAiBslB,EAAWjnB,YAA+C,iBAA1BinB,EAAWjnB,WAA0BinB,EAAWjnB,WAAW7T,GAAY,KACxHuT,EAAcif,GAAYhd,GAAgBjC,aAC1CC,EAAegf,GAAYhd,GAAgBhC,cAC3CC,EAAkB+e,GAAYhd,GAAgB/B,iBAC9CC,EAAoB8e,GAAYhd,GAAgB9B,mBACtDqnB,EAAa/6B,GAAY,CAAEyQ,MAAO8C,EAAasN,OAAQrN,EAAcmM,UAAWlM,EAAiB/K,OAAQgL,GAEzG,MAAMI,EAAS0B,GAAgB1B,QAA2C,iBAA1B0B,EAAe1B,OAAsB0B,EAAe1B,OAAS,CAAC,EAC9G,IAAIknB,EAAiB,EACjBC,EAAe,EAEnB,IAAK,MAAOv1B,EAAKE,KAAUjG,OAAOqN,QAAQ8G,GAAS,CACjD,IAAKlO,GAA0B,iBAAVA,EAAoB,SACzC,MAAMs1B,EAAa1I,GAAY5sB,EAAM2N,aAC/B4nB,EAAc3I,GAAY5sB,EAAM4N,cAChC4nB,EAAiB5I,GAAY5sB,EAAM6N,iBACnC4nB,EAAc7I,GAAY5sB,EAAM8N,mBAChCmjB,EAASqE,EAAaC,EAAcC,EAC1C,GAAIvE,GAAU,GAAKwE,GAAe,EAAG,SAErC,MAAMC,EAAkC,iBAAhB11B,EAAMuO,MAAqBvO,EAAMuO,MAAQ,GAC3D3L,EAAWxD,OAAOU,GAAO,IAAIuB,OAC7BuW,GAAW8d,GAAY9yB,GAAUvB,OACjCs0B,GAAa/d,GAAqC,YAA1BA,EAAQ5V,cAChCuM,EAAQonB,EA7UQ,iBA6U0B/d,EAC1CkU,EAAOS,GAAa,CACxBnyB,WACAqP,MAAOksB,EAAY,GAAK/d,EACxBjK,YAAa2nB,EACb1nB,aAAc2nB,EACd1nB,gBAAiB2nB,EACjB1nB,kBAAmB2nB,IAGftmB,EAASZ,EAAMvM,cACf4zB,EAAaZ,EAAU56B,GAAU8T,OAAOlP,IAAImQ,IAAW,CAAEZ,QAAO0iB,OAAQ,EAAGnF,KAAM,GACvF8J,EAAW3E,QAAUA,EACrB2E,EAAW9J,MAAQA,EACnBkJ,EAAU56B,GAAU8T,OAAO/O,IAAIgQ,EAAQymB,GAEvCR,GAAkBnE,EAClBoE,GAAgBvJ,CAClB,CAEuB,IAAnBsJ,IACFA,EAAiBznB,EAAcC,EAAeC,GAGhDmnB,EAAU56B,GAAU62B,OAASmE,EAC7BJ,EAAU56B,GAAU0xB,KAAOuJ,EAC3BxB,EAAM5lB,WAAW7T,GAAU62B,OAASmE,EACpCvB,EAAM5lB,WAAW7T,GAAU0xB,KAAOuJ,CACpC,CAgBA,OAdKxB,EAAMlmB,cACTkmB,EAAMlmB,YAAcwnB,EAAal3B,OAAO4M,MAAQsqB,EAAaj3B,OAAO2M,OAEjEgpB,EAAMjmB,eACTimB,EAAMjmB,aAAeunB,EAAal3B,OAAOgd,OAASka,EAAaj3B,OAAO+c,QAEnE4Y,EAAMhmB,kBACTgmB,EAAMhmB,gBAAkBsnB,EAAal3B,OAAO8b,UAAYob,EAAaj3B,OAAO6b,WAEzE8Z,EAAM/lB,oBACT+lB,EAAM/lB,kBAAoBqnB,EAAal3B,OAAO6E,OAASqyB,EAAaj3B,OAAO4E,QAG7E+wB,EAAM/H,KAAO+H,EAAM5lB,WAAWhQ,OAAO6tB,KAAO+H,EAAM5lB,WAAW/P,OAAO4tB,KAC7D,CAAE+H,QAAOmB,YAClB,CAyqB+Ba,CAAqBhB,GAElD9R,GAAG,oBAAoBO,YAAcE,GAAaqQ,EAAMlmB,YAAckmB,EAAMhmB,gBAAkBgmB,EAAMjmB,cACpGmV,GAAG,sBAAsBO,YAAcE,GAAaqQ,EAAMlmB,aAC1DoV,GAAG,6BAA6BO,YAAcE,GAAaqQ,EAAMhmB,iBACjEkV,GAAG,uBAAuBO,YAAcE,GAAaqQ,EAAMjmB,cAC3DmV,GAAG,kBAAkBO,YAAcO,GAAgBgQ,EAAM/H,MACzD,MAAMsE,EAAUrN,GAAG,gBACfqN,IAASA,EAAQ9M,YAAcO,GAAgBgQ,EAAM/H,OACzD/I,GAAG,mBAAmBO,YAAcK,GAAWkQ,EAAM5lB,WAAWhQ,OAAO6tB,MACvE/I,GAAG,mBAAmBO,YAAcK,GAAWkQ,EAAM5lB,WAAW/P,OAAO4tB,MAtFzE,SAA8BkJ,GAC5B,MAAMpB,EAAY7Q,GAAG,kBACrB,IAAK6Q,EAAW,OAChBA,EAAU9M,UAAY,GAEtB,MAAMrY,EAAY,CAAC3U,EAAUG,OAAQH,EAAUI,QAC/C,IAAK,MAAME,KAAYqU,EAAW,CAChC,MAAMuP,EAAOgX,EAAU56B,IAAa,CAAE62B,OAAQ,EAAGnF,KAAM,EAAG5d,OAAQ,IAAIvP,KACtEi1B,EAAU1O,YAAYqO,GAAkBjJ,GAAgBlwB,IAAaA,EAAU4jB,EAAKiT,OAAQjT,EAAK8N,MAAM,IAEvG,MAAM5d,EAASzI,MAAM0E,KAAK6T,EAAK9P,OAAO9D,UACnC9I,OAAQmI,IAAWA,EAAMwnB,QAAU,GAAK,IAAMxnB,EAAMqiB,MAAQ,GAAK,GACjEpjB,KAAK,CAACC,EAAGC,IAAMA,EAAEqoB,OAAStoB,EAAEsoB,QAAUtoB,EAAE4F,MAAMunB,cAAcltB,EAAE2F,QAEjE,IAAK,MAAM9E,KAASyE,EAClB0lB,EAAU1O,YAAYqO,GAAkB9pB,EAAM8E,MAAO9E,EAAMwnB,OAAQxnB,EAAMqiB,MAAM,GAEnF,CACF,CAsEEiK,CAAqBf,GACrBgB,GAActB,GAmThB,SAAwBA,GACtB,MAAMuB,EAASlT,GAAG,cAClB,IAAKkT,EAAQ,OACb,MAAMC,EAAMD,EAAOE,WAAW,MAC9B,IAAKD,EAAK,OAEV,MAAME,EAAQH,EAAOI,aAAe,IAC9BC,EAASL,EAAOM,cAAgB,IAChCC,EAAM/2B,OAAOg3B,kBAAoB,EACvCR,EAAOG,MAAQA,EAAQI,EACvBP,EAAOK,OAASA,EAASE,EACzBN,EAAIQ,aAAaF,EAAK,EAAG,EAAGA,EAAK,EAAG,GAEpC,MACM3f,EADMxQ,KAAK/D,MACG,KACdq0B,EAAU,IAAIlxB,MAAM,IAAImxB,KAAK,GAEnC,IAAK,MAAMzvB,KAASutB,EAAM,CACxB,IAAKvtB,EAAMpC,IAAMoC,EAAMpC,GAAK8R,EAAO,SACnC,MAAM7N,EAAQpH,KAAK8L,OAAOvG,EAAMpC,GAAK8R,GAAS,KAC1C7N,GAAS,GAAKA,EAAQ2tB,EAAQh1B,SAChCg1B,EAAQ3tB,IAAUpH,KAAKC,IAAI,EAAGsF,EAAMwG,YAAcxG,EAAM0G,gBAAkB1G,EAAMyG,cAEpF,CAEA,MAAMipB,EAAWj1B,KAAKC,OAAO80B,EAAS,GAEhCG,EADSC,iBAAiB/T,SAASgU,iBAChBC,iBAAiB,cAAc51B,QAAU,UAGlE60B,EAAIgB,UAAU,EAAG,EAAGd,EAAOE,GAE3BJ,EAAIiB,YAJc,yBAKlBjB,EAAIkB,UAAY,EAChB,IAAK,IAAI7rB,EAAI,EAAGA,GAAK,EAAGA,IAAK,CAC3B,MAAM8rB,EAAKf,EAAS,EAAK/qB,EACzB2qB,EAAIoB,YACJpB,EAAIqB,OAAO,EAAGF,GACdnB,EAAIsB,OAAOpB,EAAOiB,GAClBnB,EAAIuB,QACN,CAEAvB,EAAIoB,YACJX,EAAQ/U,QAAQ,CAAC5hB,EAAOuL,KACtB,MAAMpK,EAAKoK,GAAKorB,EAAQh1B,OAAS,GAAMy0B,EACjCiB,EAAIf,EAAUt2B,EAAQ62B,GAAaP,EAAS,IAAM,EAC9C,IAAN/qB,EAAS2qB,EAAIqB,OAAOp2B,EAAGk2B,GACtBnB,EAAIsB,OAAOr2B,EAAGk2B,KAGrB,MAAMK,EAAWxB,EAAIyB,qBAAqB,EAAG,EAAG,EAAGrB,GACnDoB,EAASE,aAAa,EAAG,4BACzBF,EAASE,aAAa,EAAG,4BAEzB1B,EAAIkB,UAAY,EAChBlB,EAAIiB,YAAcL,EAClBZ,EAAIuB,SAEJvB,EAAIsB,OAAOpB,EAAOE,GAClBJ,EAAIsB,OAAO,EAAGlB,GACdJ,EAAI2B,YACJ3B,EAAI4B,UAAYJ,EAChBxB,EAAIU,MACN,CAjXEmB,CAAerD,EACjB,CAEA,SAASsD,KACP,IACE,MAA2B,oBAAbhV,UAA4BA,SAASoC,MACrD,CAAE,MACA,OAAO,CACT,CACF,CAEA,IAAI6S,GAAsB,KACtBC,GAAsB,KACtBC,GAAwB,KAE5Bv5B,eAAew5B,GAAoBj4B,EAAU,CAAC,GAC5C,MAAM,MAAE4J,GAAQ,GAAU5J,EAC1B,GAAK4J,IAASiuB,KAAd,CACA,GAAIC,GAAqB,OAAOA,GAChCA,GAAsB,iBACdxD,IACP,EAFqB,GAGtB,IACE,aAAawD,EACf,CAAE,QACAA,GAAsB,IACxB,CATwC,CAU1C,CAEAr5B,eAAey5B,GAAyBl4B,EAAU,CAAC,GACjD,MAAM,MAAE4J,GAAQ,GAAU5J,EAC1B,GAAK4J,IAASiuB,KAAd,CACA,GAAIE,GAAqB,OAAOA,GAChCA,GAAsB,iBAmYxBt5B,iBACE,MAAM05B,QHh5BD15B,iBACL,SAAUyG,KACR,MAAO,CACL+B,QAAS,EACTmxB,UAAW,EACX9pB,UAAW,CACTxQ,OAAQ,CAAEmJ,QAAS,EAAGmxB,UAAW,GACjCr6B,OAAQ,CAAEkJ,QAAS,EAAGmxB,UAAW,IAEnCC,SAAU,KACVC,SAAU,MAGd,MAEM9uB,EAASzB,SAFKJ,WACIF,MAExB,GAAI+B,EAAOvB,YAAYzG,OAAQ,CAC7B,IAAK,MAAM7B,KAAO6J,EAAOvB,kBAAmBU,GAAiBhJ,SACvDmI,GAAe0B,EAAO1D,KAC9B,CAEA,MAAMqyB,EAAQ,CACZlxB,QAAS,EACTmxB,UAAW,EACX9pB,UAAW,CACTxQ,OAAQ,CAAEmJ,QAAS,EAAGmxB,UAAW,GACjCr6B,OAAQ,CAAEkJ,QAAS,EAAGmxB,UAAW,IAEnCC,SAAU,KACVC,SAAU,MAGZ,IAAK,MAAM5yB,KAAQ8D,EAAO1D,MAAQ,GAAI,CACpC,IAAKJ,GAAM/F,IAAK,SAChBw4B,EAAMlxB,SAAW,EACjBkxB,EAAMC,WAAa/2B,OAAOqE,EAAK4C,MAAQ,GACvC,MAAMrO,EAAWgF,OAAOyG,EAAKzL,UAAY,IAAI4H,cACzC5H,IAAaN,EAAUG,QACzBq+B,EAAM7pB,UAAUxQ,OAAOmJ,SAAW,EAClCkxB,EAAM7pB,UAAUxQ,OAAOs6B,WAAa/2B,OAAOqE,EAAK4C,MAAQ,IAC/CrO,IAAaN,EAAUI,SAChCo+B,EAAM7pB,UAAUvQ,OAAOkJ,SAAW,EAClCkxB,EAAM7pB,UAAUvQ,OAAOq6B,WAAa/2B,OAAOqE,EAAK4C,MAAQ,IAG1D,MAAMJ,EAAU7G,OAAOqE,EAAKyC,WAAa,GACrCD,IACFiwB,EAAME,SAA6B,MAAlBF,EAAME,SAAmBnwB,EAAUzG,KAAK+E,IAAI2xB,EAAME,SAAUnwB,GAC7EiwB,EAAMG,SAA6B,MAAlBH,EAAMG,SAAmBpwB,EAAUzG,KAAKC,IAAIy2B,EAAMG,SAAUpwB,GAEjF,CAEA,OAAOiwB,CACT,CG21BsBI,GACpB3V,GAAG,gBAAgBO,YAAcE,GAAa8U,EAAMlxB,SACpD2b,GAAG,aAAaO,YApxDlB,SAAqBrY,GACnB,MAAM1J,EAAIC,OAAOyJ,GACjB,OAAKzJ,OAAOC,SAASF,IAAMA,GAAK,EAAU,OACtCA,EAAI,KAAa,GAAGA,MACpBA,EAAI,QAAoB,IAAIA,EAAI,MAAMqiB,QAAQ,QAC3C,IAAIriB,EAAI,SAAeqiB,QAAQ,OACxC,CA8wDgC+U,CAAYL,EAAMC,WAChDxV,GAAG,sBAAsBO,YAAcE,GAAa8U,EAAM7pB,UAAUxQ,OAAOmJ,SAC3E2b,GAAG,sBAAsBO,YAAcE,GAAa8U,EAAM7pB,UAAUvQ,OAAOkJ,QAC7E,CAxYUwxB,EACP,EAFqB,GAGtB,IACE,aAAaV,EACf,CAAE,QACAA,GAAsB,IACxB,CATwC,CAU1C,CAEAt5B,eAAei6B,GAA4B14B,EAAU,CAAC,GACpD,MAAM,MAAE4J,GAAQ,GAAU5J,EAC1B,GAAK4J,IAASiuB,KAAd,CACA,GAAIG,GAAuB,OAAOA,GAClCA,GAAwB,iBAChBxE,IACP,EAFuB,GAGxB,IACE,aAAawE,EACf,CAAE,QACAA,GAAwB,IAC1B,CATwC,CAU1C,CAEA,SAASW,GAAkBC,GACzB,MAAMx3B,EAAIC,OAAOu3B,GAAe,GAChC,OAAIx3B,GAAK,IAAa,sBAClBA,GAAK,IAAa,kBAClBA,GAAK,KAAa,mBACf,kBACT,CAEA,SAASy3B,GAAY7xB,GACnB,MAAM8xB,EAAc9xB,EAAMuD,MAAQvD,EAAMsP,SAAW,GACnD,MAAO,CAACtP,EAAMpC,IAAM,EAAGoC,EAAMmN,IAAM,GAAInN,EAAM/M,UAAY,GAAI+M,EAAMsC,OAAS,GAAIwvB,GAAa7tB,KAAK,IACpG,CAEA,SAAS8tB,KACP,MAAMC,EAAYpW,GAAG,mBAChBoW,IACLA,EAAU5T,UAAUC,OAAO,YAAagE,IACxC2P,EAAU9R,aAAa,eAAgBmC,GAAgB,OAAS,SAClE,CAOA,SAASwM,GAActB,GACrB,MAAMzuB,EAAO8c,GAAG,WAChB9c,EAAK6gB,UAAY,GAEjB,MAAMsS,EATR,SAA0B1E,GACxB,OAAKlL,GACEkL,EAAKpzB,OAAQ6F,IAAWA,EAAM2F,IADV4nB,CAE7B,CAMuB2E,CAAiB3E,GAAQ,IAE9C,IAAK0E,EAAaz3B,OAAQ,CACxB,MAAM23B,EAAQtW,SAASkE,cAAc,OAMrC,OALAoS,EAAMnS,UAAY,2BAClBmS,EAAMhW,YAAckG,GAChB,2CACA,kDACJvjB,EAAKif,YAAYoU,EAEnB,CAEA,MAAMC,EAAiBA,CAACC,EAAUx5B,KAChC,MAAMyrB,EAAOzI,SAASkE,cAAc,QACpCuE,EAAKtE,UAAY,aAEjB,MAAMqD,EAAOxH,SAASkE,cAAc,QACpCsD,EAAKrD,UAAY,mBACjBqD,EAAKlH,YAAckW,EAEnB,MAAMC,EAAMzW,SAASkE,cAAc,QAMnC,OALAuS,EAAItS,UAAY,oBAChBsS,EAAInW,YAAcE,GAAaxjB,GAE/ByrB,EAAKvG,YAAYsF,GACjBiB,EAAKvG,YAAYuU,GACVhO,GAGHznB,EAAQo1B,EAAap1B,MAAM,EAAG,IAC9B01B,EAAa,IAAIh9B,IACvB,IAAK,MAAMyK,KAASnD,EAAO,CACzB,MAAM6B,EAAOmd,SAASkE,cAAc,OAC9ByS,EAAaxyB,EAAMrM,MAAQ,mBAAqB,GAChD8+B,EAAazyB,EAAM4H,MAAQ,mBAAqB,GACtDlJ,EAAKshB,UAAY,YAAYhgB,EAAM2F,GAAK,eAAiB,oBAAoB6sB,IAAaC,IAE1F,MAAMC,EAAM7W,SAASkE,cAAc,OACnC2S,EAAI1S,UAAY,gBAEhB,MAAMzL,EAAQsH,SAASkE,cAAc,OACrCxL,EAAMyL,UAAY,kBAElB,MAAM2S,EAAY9W,SAASkE,cAAc,QACzC4S,EAAU3S,UAAY,uBACtB2S,EAAUxW,YAAcnc,EAAMmN,GAC9BoH,EAAMwJ,YAAY4U,GAElB,MAAMb,EAAc75B,OAAO+H,EAAMuD,MAAQvD,EAAMsP,SAAW,IAAIpV,OAC9D,IAAIigB,EAAS,KACb,GAAI2X,EAAa,CACf,MAAMc,EAAWf,GAAY7xB,GAC7BuyB,EAAW5zB,IAAIi0B,GACf,MAAMvU,EAASxC,SAASkE,cAAc,UACtC1B,EAAO2B,UAAY,mBACnB3B,EAAOrL,KAAO,SACdqL,EAAO6B,aAAa,gBAAiB,SACrC7B,EAAO6B,aAAa,aAAc,wBAElC,MAAM2S,EAAUhX,SAASkE,cAAc,QACvC8S,EAAQ7S,UAAY,oBACpB3B,EAAON,YAAY8U,GAEC1Q,GAAgBvqB,IAAIg7B,KAEtCl0B,EAAK0f,UAAUzf,IAAI,sBACnB0f,EAAO6B,aAAa,gBAAiB,QACrC7B,EAAO6B,aAAa,aAAc,wBAGpC7B,EAAOoC,iBAAiB,QAAS,KAC/B,MAAM4F,EAAS3nB,EAAK0f,UAAUC,OAAO,sBACrCA,EAAO6B,aAAa,gBAAiBmG,EAAS,OAAS,SACvDhI,EAAO6B,aAAa,aAAcmG,EAAS,sBAAwB,wBAC/DA,EAAQlE,GAAgBxjB,IAAIi0B,GAC3BzQ,GAAgBhqB,OAAOy6B,KAG9Bre,EAAMwJ,YAAYM,GAElBlE,EAAS0B,SAASkE,cAAc,OAChC5F,EAAO6F,UAAY,mBACnB7F,EAAOgC,YAAc2V,CACvB,CAEA,MAAMgB,EAAOjX,SAASkE,cAAc,OACpC+S,EAAK9M,MAAM+M,QAAU,OACrBD,EAAK9M,MAAMgN,IAAM,MAEjB,MAAMC,EAAcpX,SAASkE,cAAc,QAC3CkT,EAAYjT,UAAY,MACxBiT,EAAY9W,YAAcnc,EAAM4H,MAAQ,QAAW5H,EAAM/M,SAAW+M,EAAM/M,SAAS0d,cAAgB,IACnGmiB,EAAK/U,YAAYkV,GAEjB,MAAMC,EAAYrX,SAASkE,cAAc,QACzCmT,EAAUlT,UAAY,QAAOhgB,EAAM2F,GAAK,GAAK,cAC7CutB,EAAU/W,YAAcnc,EAAM2F,GAAK,KAAO,SAC1CmtB,EAAK/U,YAAYmV,GAEjB,MAAMC,EAAUtX,SAASkE,cAAc,QAWvC,GAVAoT,EAAQnT,UAAY,gBAChBhgB,EAAM4H,OACRurB,EAAQhX,YAAcK,GAAW4I,GAAaplB,IAC9CmzB,EAAQ5e,MAAQ,sBAEhB4e,EAAQhX,YAAcQ,GAAgByI,GAAaplB,IACnDmzB,EAAQ5e,MAAQ,0BAElBue,EAAK/U,YAAYoV,GAEbnzB,EAAM4H,MAAO,CACf,MAAMwrB,EAAWvX,SAASkE,cAAc,QACxCqT,EAASpT,UAAY,iBACrBoT,EAASjX,YAAc,MACvB2W,EAAK/U,YAAYqV,EACnB,MAAO,GAAIpzB,EAAMrM,MAAO,CACtB,MAAM0/B,EAAWxX,SAASkE,cAAc,QACxCsT,EAASrT,UAAY,iBACrBqT,EAASlX,YAAc,QACvB2W,EAAK/U,YAAYsV,EACnB,CAEA,GACsB,0BAApBrzB,EAAMyM,WAC0C,WAA/CxU,OAAO+H,EAAM/M,UAAY,IAAI4H,eAA8BR,OAAO2F,EAAM2G,mBAAqB,GAAK,GAClG3G,EAAM4H,QAAUvN,OAAO2F,EAAM2G,mBAAqB,GAAK,GAAKtM,OAAO2F,EAAMqN,YAAY1R,QAAU,GAAK,GACrG,CACA,MAAM23B,EAAczX,SAASkE,cAAc,QAC3CuT,EAAYtT,UAAY,iBACxBsT,EAAYnX,YAAc,eAC1B2W,EAAK/U,YAAYuV,EACnB,CAEAZ,EAAI3U,YAAYxJ,GAChBme,EAAI3U,YAAY+U,GAEhB,MAAM5wB,EAAO2Z,SAASkE,cAAc,OACpC7d,EAAK8d,UAAY,iBAEjB,MAAM4R,EAAcn3B,KAAKC,IAAI,EAAGsF,EAAMwG,YAAcxG,EAAM0G,gBAAkB1G,EAAMyG,cAC5EsB,EAAa/H,EAAM4H,MAAQ,GAAM5H,EAAMsC,MAAQtC,EAAMsC,MAAQ,GAC7DixB,EAAcvzB,EAAM8P,gBAAkB9P,EAAM8P,gBAAkB,GAC9D0jB,EAAgB3W,GAAe7c,EAAMZ,IACrCq0B,EAAmB,CAAC1rB,EAAYwrB,GAAap5B,OAAOu5B,SAASzvB,KAAK,OAElE0vB,EAAQ9X,SAASkE,cAAc,OACrC4T,EAAM3T,UAAY,iBAClB,MAAM4T,EAAW,GAAG9W,GAAW9c,EAAMpC,SAAS41B,IACxCK,EAAaJ,EAAmB,MAAMA,IAAqB,GACjE,GAAIzzB,EAAM4H,OAAS5H,EAAMqN,WAAY,CACnC,MAAM8jB,EAAQnxB,EAAMqN,WACdiJ,EAAQ,CACZ,OAAO+F,GAAa8U,EAAMvlB,qBAC1B,MAAMyQ,GAAa8U,EAAMxrB,MACzB,OAAO0W,GAAa8U,EAAM7jB,UAExB6jB,EAAMx1B,QAAQ2a,EAAM1X,KAAK,SAASyd,GAAa8U,EAAMx1B,WACrDw1B,EAAMlkB,OAAOqJ,EAAM1X,KAAK,OAAOie,GAAesU,EAAMlkB,UACpDkkB,EAAMhlB,YAAYmK,EAAM1X,KAAK,YAAYyd,GAAa8U,EAAMhlB,eAC5DglB,EAAM/kB,YAAYkK,EAAM1X,KAAK,aAAayd,GAAa8U,EAAM/kB,eACjEunB,EAAMxX,YAAc,GAAGyX,IAAWC,OAAgBvd,EAAMrS,KAAK,QAC/D,MAAYjE,EAAM2F,IAAM3F,EAAMoK,QAC5BupB,EAAMxX,YAAc,GAAGyX,IAAWC,OAAgB7zB,EAAMoK,QAAQvN,MAAM,EAAG,MAEzE82B,EAAMxX,YAAc,GAAGyX,IAAWC,IAGpC,GAAI7zB,EAAMrM,MAAO,CACf,MAAMmgC,EAAYjY,SAASkE,cAAc,OACzC+T,EAAU9T,UAAY,kBACtB8T,EAAU3X,YAAc,cACxBja,EAAK6b,YAAY+V,EACnB,KAAO,CACL,MAAMC,EAAalY,SAASkE,cAAc,OAC1CgU,EAAW/T,UAAY,mBAEvB,MAAMgU,EAAanY,SAASkE,cAAc,OAC1CiU,EAAWhU,UAAY,wBAEvB,MAAMiU,EAAUpY,SAASkE,cAAc,QACvCkU,EAAQjU,UAAY,kBAAkB2R,GAAkBC,KAExD,MAAMsC,EAAgBrY,SAASkE,cAAc,QAC7CmU,EAAclU,UAAY,yBAC1BkU,EAAc/X,YAAc,GAAGE,GAAauV,YAE5C,MAAMuC,EAAiBtY,SAASkE,cAAc,QAC9CoU,EAAenU,UAAY,0BAC3BmU,EAAepW,YAAYlC,SAASuY,eAAe,MACnDD,EAAepW,YAAYqU,EAnrDX,KAmrDyCpyB,EAAMwG,cAC/D2tB,EAAepW,YAAYlC,SAASuY,eAAe,QACnDD,EAAepW,YAAYqU,EAprDP,MAorDyCpyB,EAAM0G,kBACnEytB,EAAepW,YAAYlC,SAASuY,eAAe,QACnDD,EAAepW,YAAYqU,EArrDV,MAqrDyCpyB,EAAMyG,eAC5DpM,OAAO2F,EAAM2G,mBAAqB,GAAK,IACzCwtB,EAAepW,YAAYlC,SAASuY,eAAe,QACnDD,EAAepW,YAAYqU,EAvrDT,QAurD2CpyB,EAAM2G,qBAErEwtB,EAAepW,YAAYlC,SAASuY,eAAe,MAEnDJ,EAAWjW,YAAYkW,GACvBD,EAAWjW,YAAYmW,GACvBF,EAAWjW,YAAYoW,GACvBJ,EAAWhW,YAAYiW,GACvB9xB,EAAK6b,YAAYgW,EACnB,CAEA7xB,EAAK6b,YAAY4V,GAEjBj1B,EAAKqf,YAAY2U,GACbvY,GAAQzb,EAAKqf,YAAY5D,GAC7Bzb,EAAKqf,YAAY7b,GACjBpD,EAAKif,YAAYrf,EACnB,CAEAyjB,GAAgB1H,QAAS9hB,IAClB45B,EAAW36B,IAAIe,IAAMwpB,GAAgBhqB,OAAOQ,IAErD,CAmEA,SAAS07B,GAAoBl2B,GAC3B6jB,KAAuB7jB,EACvB,MAAMkgB,EAASzC,GAAG,qBACdyC,IAAQA,EAAOwC,QAAUmB,IAE7B,MAAMjkB,EAAS6d,GAAG,qBACd7d,IACFA,EAAOoe,YAAc6F,GAAqB,SAAW,YACrDjkB,EAAOqgB,UAAUC,OAAO,YAAa2D,KAGvC,MAAMsS,EAAO1Y,GAAG,mBACZ0Y,IACFA,EAAKnY,YAAc6F,GACf,2CACA,yCAGN,MAAMuS,EAAc3Y,GAAG,eACnB2Y,IACFA,EAAYpY,YAAc6F,GAAqB,YAAc,QAC7DuS,EAAYnW,UAAUC,OAAO,iBAAkB2D,IAC/CuS,EAAYnW,UAAUC,OAAO,cAAe2D,IAEhD,CAEAvqB,eAAe+8B,KAEbH,SADsBn2B,KAExB,CA4BAzG,eAAeg9B,GAAWz7B,EAAU,CAAC,GACnC,MAAM,OAAEgwB,GAAS,EAAK,QAAE5e,EAAU,6BAAgCpR,EAC5D/F,EAvtBe2oB,GAAG,kBAAkBwC,UAAUoI,SAAS,0BACvC7zB,EAAUG,OAASH,EAAUI,OAwtB7C23B,EAASd,GADHD,GAAS/N,GAAG,kBAAkB/iB,QAGpC67B,QHjiDDj9B,eAAkCxE,GACvC,MAAM0H,EAAIhB,EAAkB1G,IAAaD,EAASC,SAIlD,aAHMqG,EAAOzF,EAAaC,iBAAkB6G,GAC5CtE,EAAwBsE,EACxBrE,EAA0B8E,KACnBT,CACT,CG2hD8Bg6B,CAAmB1hC,GACzC2hC,QAAoBx4B,EAAmBsuB,GAM7C,OAJK1B,GACHjN,GAAU3R,EAAS,CAAE+hB,gBAAiBuI,EAAephC,gBAAiBshC,IAGjE,CAAEF,gBAAeE,cAC1B,CA2CA,SAASC,GAAsB77B,EAAU,CAAC,GACxC,MAAM,SAAE87B,GAAW,GAAU97B,EACvBmkB,EAAUtB,SAAS6B,cAAc,+BACvC,GAAKP,EAAL,CAMA,GALAA,EAAQiB,UAAUsB,OAAO,aACrBvC,EAAQiB,UAAUoI,SAASlI,MAC7BG,GAAetmB,OAAO,cACtB6mB,GAAqB1gB,MAAM0E,KAAKyb,MAE9BtB,EAAQiB,UAAUoI,SAAS,gBAAiB,CAC9CrJ,EAAQiB,UAAUsB,OAAO,gBACzB,MAAMrB,EAASlB,EAAQO,cAAc,0BACjCW,GAAQA,EAAO6B,aAAa,gBAAiB,OACnD,CAIA,GAHsC,mBAA3B/C,EAAQ4X,gBACjB5X,EAAQ4X,eAAe,CAAEC,SAAU,SAAUC,MAAO,UAElDH,EAAU,CACZ,MAAMpxB,EAAQyZ,EAAQO,cAAc2D,IAChC3d,GAAOA,EAAMilB,OACnB,CAjBoB,CAkBtB,CAmCA,SAASuM,KACPrZ,SAAS2D,iBAAiB2B,IAAe1G,QAAS0a,IAChDA,EAAK/W,UAAUsB,OAAO,WACtB,MAAM0V,EAAMD,EAAKzX,cAAc,UAC3B0X,GAAKA,EAAIlV,aAAa,gBAAiB,UAE/C,CAuBAzoB,eAAe49B,GAAsBr8B,EAAU,CAAC,GAC9C,MAAM,OAAEgwB,GAAS,GAAUhwB,EAC3B,OAAKouB,MAMLtF,IAA0B,EAC1BC,IAAuB,QACjBzkB,IAA2B,GACjC4hB,MACO,IATA8J,GACHjN,GAAU,gDAAiD,CAAEpW,IAAI,KAE5D,EAOX,CAEAlO,eAAe69B,GAAcriC,EAAU4F,GACrC,MAAM0C,GAAW1C,GAAS,IAAIqB,OAC9B,QAAKqB,UHzpDA9D,eAAyBxE,EAAU0c,GACxC,MAAMhY,GAAKgY,GAAU,IAAIzV,OACnBS,EAAIhB,EAAkB1G,KAAcN,EAAUI,OAASJ,EAAUI,OAASJ,EAAUG,OAI1F,aAHMwG,EAAO+B,EAAOV,GAAIhD,GACxBd,EAAa8D,GAAKhD,EAClBX,EAAe2D,GAAKS,KACbzD,CACT,CGmpDQ49B,CAAUtiC,EAAUsI,GAC1BkmB,GAASxuB,IAAY,EACrB2uB,IAAa,EACbqF,KACAQ,KACAvI,MACO,EACT,CAEAznB,eAAe+9B,GAAgBviC,EAAUwiC,GACvC,MAAM98B,QAAY28B,GAAcriC,EAAUwiC,GAAS58B,OAAS,IACvDF,IACD88B,IAASA,EAAQ58B,MAAQ,IAC7BiuB,GAAa7zB,EAAU0F,GACvBojB,GAAU,kBAAmB,CAAE9oB,aACjC,CAEAwE,eAAei+B,GAAkBziC,GAC/B,MAAM+xB,EAAW/xB,IAAaN,EAAUG,OAClCy0B,EAAqB3L,GAAXoJ,EAAc,cAAoB,eAClD,IAAKuC,EAAS,OACd,MAAMoO,GAAYpO,EAAQ1uB,OAAS,IAAIqB,aHhnDlCzC,eAAwBxE,EAAUqP,GACvC,MAAM3H,EAAIhB,EAAkB1G,KAAcN,EAAUI,OAASJ,EAAUI,OAASJ,EAAUG,OACpFiF,EAAIE,OAAOqK,GAAS,IAAIpI,OAC9B,IAAKnC,EAAG,CAEN,MAAM0H,EAAW9E,IAAMhI,EAAUI,OAASC,EAASG,YAAcH,EAASE,YAI1E,aAHMoG,EAAOmC,EAASd,GAAI8E,GAC1BxI,EAAY0D,GAAK8E,OACjBvI,EAAcyD,GAAKS,KAErB,OACM9B,EAAOmC,EAASd,GAAI5C,GAC1Bd,EAAY0D,GAAK5C,EACjBb,EAAcyD,GAAKS,IACrB,CGmmDQw6B,CAAS3iC,EAAU0iC,GAEzB,IAAIplB,EAAS,GACb,GAAIyU,EAAU,CACZ,MAAMvB,EAAW7H,GAAG,yBAEpBrL,EAASgT,GAA0BoS,EADjBlS,EAAWA,EAAS5qB,MAAQ,IAE1C0X,SAActU,EAAyBsU,EAC7C,KAAO,CACL,MAAMkT,EAAW7H,GAAG,yBAEpBrL,EAAS4T,GAA0BwR,EADjBlS,EAAWA,EAAS5qB,MAAQ,IAE1C0X,SAAcvU,EAAyBuU,EAC7C,CAEAwL,GAAU,4BAA6B,CACrC9oB,WACAqP,MAAOqzB,EACP7lB,gBAAiBS,QAAUP,IAG7B+U,GAAwB9xB,EAAU0iC,EACpC,CAoBA,SAASE,GAAgBJ,EAASK,GAC3BL,GACLA,EAAQrX,UAAUC,OAAO,iBAAkByX,EAC7C,CAEAr+B,eAAes+B,GAAsBN,EAASO,GAC5C,MAAMr9B,GAAO88B,GAAS58B,OAAS,IAAIqB,OAGnC,GAFA27B,GAAgBJ,GAAS,IAEpB98B,EAIH,OAHAk9B,GAAgBJ,GAAS,GACzBjN,GAAoB,+BAA+B,QACnDzM,GAAU,2BAA4B,CAAEpW,IAAI,IAI9C,MAAMswB,EAAgBD,GAAU7Z,aAAe,GAC3C6Z,IACFA,EAASxV,UAAW,EACpBwV,EAAS7Z,YAAc,iBAGzB,MAAM/iB,QDpjED3B,eAA+BkB,EAAKK,EAAU,CAAC,GACpD,MAAMuC,EAAUue,GAAanhB,GAC7B,IAAK4C,GAAWA,EAAQf,OAhHC,EAiHvB,MAAO,CAAE07B,SAAS,EAAO5oB,MAAO,mBAGlC,MAAM/T,QAAeiiB,KACrB,IAAKxiB,EAAQ4J,OAASrJ,GAAUA,EAAOZ,MAAQ4C,GAAWogB,GAAepiB,GACvE,MAAO,CAAE28B,SAAS,EAAMl3B,QAASzF,EAAQoC,QAAQ,GAGnD,IACE,MAAM,GAAEgK,EAAE,OAAE5H,EAAM,KAAE8Y,SAAeuD,GA7HV,oDA6H4C,CACnEe,YAAa5f,EACb46B,cAAetc,KAGjB,IAAKlU,EACH,MAAO,CAAEuwB,SAAS,EAAO5oB,MAAO2M,GAAapD,EAAM,eAAe9Y,OAGpE,GAAI8Y,GAAMuf,UAAW,CACnB,MAAMp3B,EAAU4b,GAAarf,EAASsb,EAAM,CAAEwE,YAAa9hB,GAAQ8hB,cAEnE,aADMtc,GAAWC,GACV,CAAEk3B,SAAS,EAAMl3B,UAC1B,CAEA,MAAO,CAAEk3B,SAAS,EAAO5oB,MAAO2M,GAAapD,EAAM,gBACrD,CAAE,MACA,MAAO,CAAEqf,SAAS,EAAO5oB,MAAO,+BAClC,CACF,CCqhEuB+oB,CAAgB19B,GAOrC,GALIq9B,IACFA,EAASxV,UAAW,EACpBwV,EAAS7Z,YAAc8Z,GAGrB78B,EAAO88B,QAKT,OAJIT,IAASA,EAAQ58B,MAAQ,UACvBkwB,GAAiB,CAAEC,QAAQ,IACjCjN,GAAU,kBAAmB,CAAEb,UAAW9hB,EAAO4F,SAASkc,WAAa,aApmE3E,SAAmB9Q,EAASpR,EAAU,CAAC,GACrC,MAAM,SAAE2T,EAAW,MAAS3T,EACtBs9B,EAAQ1a,GAAG,eACZ0a,IACLA,EAAMna,YAAc/R,GAAW,GAC/BksB,EAAMlY,UAAUzf,IAAI,cAChByjB,KACF/Y,aAAa+Y,IACbA,GAAa,MAEfA,GAAa7iB,WAAW,KACtB+2B,EAAMlY,UAAUsB,OAAO,eACtB/S,GACL,CAwlEI4pB,CAAU,uBAIZ,MAAMC,EAAYp9B,EAAOkU,OAAS,eAClCuoB,GAAgBJ,GAAS,GACzBjN,GAAoBgO,GAAW,GAC/Bza,GAAU,wBAAyB,CAAEzO,MAAOkpB,GAC9C,CA+FA/+B,eAAeg/B,GAAkBC,GAAW,GACtCA,SHlrDCj/B,eAAiCgH,GAAO,GAE7C,aADMnF,EAAOzF,EAAaW,gBAAiBiK,EAAO,IAAM,KACjDA,CACT,CG+qDsBk4B,EAAkB,GACtC/P,IAA2B,GAC3BD,IAAuB,EACzB,CAQAlvB,eAAem/B,GAAc3jC,SHr2DtBwE,eAA2BxE,GAChC,MAAM0H,EAAIhB,EAAkB1G,KAAcN,EAAUI,OAASJ,EAAUI,OAASJ,EAAUG,aACpF0G,EAAU6B,EAAOV,IACvB9D,EAAa8D,GAAK,GAClB3D,EAAe2D,GAAKS,IACtB,CGi2DQy7B,CAAY5jC,SACZu3B,GAAU,CAAExB,QAAQ,IAC1BjN,GAAU,cAAe,CAAE9oB,YAC7B,CAEAwE,eAAeq/B,GAAa7jC,GAC1B8oB,GAAU,iBAAkB,CAAE9oB,aAE9B,MAAM8jC,QF1zCDt/B,eAA6Bu/B,GAClC,MAAM/jC,EAAW0G,EAAkBq9B,UAA4B97B,IACzDoH,QAAc5G,EAASzI,GAG7B,aAFqBqI,EAAUrI,SAalBuc,GAAW,CACtBvc,WACAgc,OAAQ,kDACRgB,KAAM,KACN3c,gBAAiB,IACjBK,OAAO,EACPuc,WAAW,EACXN,aAAc,oBAjBP,CACLjK,IAAI,EACJ1S,WACAqP,QACA6H,KAAM,kBACNC,QAAS,yCAAyCnX,KAcxD,CEiyCkBgkC,CAAchkC,GAC1B8jC,EAAEpxB,GACJoW,GAAU,KAAM,CAAE9oB,SAAU8jC,EAAE9jC,SAAUqP,MAAOy0B,EAAEz0B,MAAOqY,SAAUoc,EAAEn3B,OAEpEmc,GAAU,QAAS,CAAE9oB,SAAU8jC,EAAE9jC,SAAUqP,MAAOy0B,EAAEz0B,MAAOgL,MAAOypB,EAAE3sB,QAASD,KAAM4sB,EAAE5sB,MAEzF,CAYA1S,eAAey/B,KAzWGrb,SAAS2D,iBAAiB,0BAClC/E,QAAS2a,IACf,MAAM+B,EAAW/B,EAAIgC,aAAa,iBAC5B3K,EAAY2I,EAAI7Q,QAAQ,sBAC9B,IAAK4S,IAAa1K,EAAW,OAE7B,IADa5Q,SAASC,eAAeqb,GAC1B,OAEX,MAAME,EAAY5K,EAAUrO,UAAUoI,SAAS,gBAC/C4O,EAAIlV,aAAa,gBAAiBmX,EAAY,QAAU,QAExDjC,EAAI3U,iBAAiB,QAAS,KAC5B,MAAM6W,GAAiB7K,EAAUrO,UAAUoI,SAAS,gBACpDiG,EAAUrO,UAAUC,OAAO,eAAgBiZ,GAC3ClC,EAAIlV,aAAa,gBAAiBoX,EAAgB,QAAU,YA4BlE,WACE,IAAI55B,GAAS,EACb,MAAM65B,EAAiBA,KACjB75B,IACJA,GAAS,EACT6B,WAAW9H,UACTiG,GAAS,QACHuzB,WACAC,WACAQ,WACA8C,WACAzL,GAAiB,CAAEC,QAAQ,KAChC,OAGL,IACE,GAA6B,oBAAlB3wB,eAAiCA,eAAef,SAASkgC,UAAW,CAC7E,MAAMA,EAAYn/B,cAAcf,QAAQkgC,UACX,mBAAlBA,EAAU74B,IAAoB64B,EAAU74B,IAAI,IAAM44B,KACnB,mBAA1BC,EAAUC,YAA4BD,EAAUC,YAAY,IAAMF,KACpD,mBAAdC,GAA0BA,EAAU,IAAMD,IAC5D,CACF,CAAE,MACA,CAGF,IACEj/B,OAAOmoB,iBAAiB,UAAW,IAAM8W,IAC3C,CAAE,MACA,CAEJ,CAkSEG,GAvRA7b,SAAS2D,iBAAiB2B,IAAe1G,QAAS0a,IAChD,MAAMC,EAAMD,EAAKzX,cAAc,UAC1B0X,IACLA,EAAIlV,aAAa,gBAAiB,SAClCkV,EAAI3U,iBAAiB,QAAUkX,IAC7BA,EAAMC,kBACN,MAAMC,EAAU1C,EAAK/W,UAAUoI,SAAS,WACxC0O,KACA,MAAM4C,GAAYD,EAClB1C,EAAK/W,UAAUC,OAAO,UAAWyZ,GACjC1C,EAAIlV,aAAa,gBAAiB4X,EAAW,OAAS,cAI1Djc,SAAS4E,iBAAiB,QAAUkX,IAC9BA,EAAMnwB,OAAO+c,QAAQpD,KACzB+T,aAroDJz9B,iBAEE,GADAgmB,GAAc5B,SAAS6B,cAAc,eAChCD,GAAa,OAClB,MAAMsa,EAAWz5B,MAAM0E,KAAKya,GAAY+B,iBAAiB4B,KACzDvD,GAAkB,IAAIrmB,IACtBugC,EAAStd,QAAS0C,IAChB,MAAMxkB,EAAMukB,GAAcC,GACtBxkB,GAAKklB,GAAgB7lB,IAAIW,EAAKwkB,KAGpC,MAAM6a,QHyPDvgC,uBACCiC,IACN,MAAMkC,QAAY7C,EAAOlF,EAAaa,eACtC,IAAKkH,EAAK,MAAO,GACjB,IACE,OAAOyC,GAAqBL,KAAK6C,MAAMjF,GACzC,CAAE,MACA,MAAO,EACT,CACF,CGlQ4Bq8B,GACpBC,EAAUH,EAASh+B,IAAKojB,GAAYD,GAAcC,IAAUhjB,OAAOu5B,SACzEzR,GAAsBiW,EAAQr7B,QAC9BgiB,GApRF,SAA+BmZ,EAAaG,GAC1C,MAAM3a,EAAQ,GACR/e,EAAO,IAAIlJ,IACjB,GAAI+I,MAAMC,QAAQy5B,GAChB,IAAK,MAAMr/B,KAAOq/B,EACXr/B,IAAO8F,EAAK7G,IAAIe,IAASklB,GAAgBjmB,IAAIe,KAClD8F,EAAKE,IAAIhG,GACT6kB,EAAM5e,KAAKjG,IAGf,IAAK,MAAMA,KAAOw/B,EACXx/B,IAAO8F,EAAK7G,IAAIe,KACrB8F,EAAKE,IAAIhG,GACT6kB,EAAM5e,KAAKjG,IAEb,OAAO6kB,CACT,CAoQiB4a,CAAsBJ,EAAaE,GAClD3a,GAAkBsB,IAElBJ,GAAiB,IAAIlpB,UHoQhBkC,uBACCiC,IACN,MAAMkC,QAAY7C,EAAOlF,EAAac,gBACtC,IAAKiH,EAAK,MAAO,GACjB,IACE,OAAOyC,GAAqBL,KAAK6C,MAAMjF,GACzC,CAAE,MACA,MAAO,EACT,CACF,CG7QiCy8B,IAC/B9Z,KACAP,GAAuBS,IAEvBK,KAjFF,WACE,MAAMhgB,EAAO8c,GAAG,sBACX9c,IAELA,EAAK2hB,iBAAiB,YAAckX,IAClC,MAAMxX,EAASwX,EAAMnwB,OAAO+c,QAAQ,wBACpC,IAAKpE,EAAQ,OACb,MAAMV,EAAMU,EAAOoE,QAAQ,gBACtB9E,IACLyC,GAAqBzC,EAAIrC,QAAQ6C,YAAc,GAC/CR,EAAIrB,UAAUzf,IAAI,eACdg5B,EAAMW,eACRX,EAAMW,aAAaC,cAAgB,OACnCZ,EAAMW,aAAaE,QAAQ,aAActW,QAI7CpjB,EAAK2hB,iBAAiB,WAAakX,IACjC,IAAKzV,GAAoB,OACzByV,EAAMc,iBACN,MAAMhZ,EAAMkY,EAAMnwB,OAAO+c,QAAQ,gBACjC,IAAK9E,GAAOA,EAAIrC,QAAQ6C,aAAeiC,GAAoB,QAzH/D,SAA6BpjB,GAC3BA,EAAK0gB,iBAAiB,gBAAgB/E,QAASgF,IAC7CA,EAAIrB,UAAUsB,OAAO,iBAAkB,kBAE3C,CAsHIgZ,CAAoB55B,GACpB,MAAM65B,EAAOlZ,EAAImZ,wBACX71B,EAAS40B,EAAMkB,QAAUF,EAAKjG,IAAMiG,EAAKxJ,OAAS,EACxD1P,EAAIrB,UAAUC,OAAO,iBAAkBtb,GACvC0c,EAAIrB,UAAUC,OAAO,iBAAkBtb,KAGzCjE,EAAK2hB,iBAAiB,YAAckX,IAClC,MAAMlY,EAAMkY,EAAMnwB,OAAO+c,QAAQ,gBAC5B9E,GACLA,EAAIrB,UAAUsB,OAAO,iBAAkB,mBAGzC5gB,EAAK2hB,iBAAiB,OAASkX,IAC7B,IAAKzV,GAAoB,OACzByV,EAAMc,iBACN,MAAMhZ,EAAMkY,EAAMnwB,OAAO+c,QAAQ,gBAC3BuU,EAAYrZ,GAAMA,EAAIrC,QAAQ6C,YAAmB,GACjDtnB,EAAMupB,GACZA,GAAqB,GACrB3C,GAAezgB,GAEf,IAAI6f,EAAYE,GAAahiB,QAC7B,GAAKi8B,EAEE,CACL,MAAMH,EAAOlZ,EAAImZ,wBAEjBja,EAxKN,SAA4BnB,EAAOub,EAAYD,EAAW/1B,GACxD,MAAMjB,EAAO0b,EAAMrjB,OAAQxB,GAAQA,IAAQogC,GACrCC,EAAcl3B,EAAKsd,QAAQ0Z,GACjC,GAAIE,EAAc,EAEhB,OADAl3B,EAAKlD,KAAKm6B,GACHj3B,EAET,MAAMm3B,EAAcl2B,EAASi2B,EAAcA,EAAc,EAEzD,OADAl3B,EAAKwd,OAAO2Z,EAAa,EAAGF,GACrBj3B,CACT,CA8JkBo3B,CAAmBva,EAAWhmB,EAAKmgC,EADhCnB,EAAMkB,QAAUF,EAAKjG,IAAMiG,EAAKxJ,OAAS,EAE1D,MALExQ,EAxJN,SAA0BnB,EAAO7kB,GAC/B,MAAMmJ,EAAO0b,EAAMrjB,OAAQuE,GAASA,IAAS/F,GAE7C,OADAmJ,EAAKlD,KAAKjG,GACHmJ,CACT,CAoJkBq3B,CAAiBxa,EAAWhmB,GAM1C+lB,GAAmBC,KAGrB7f,EAAK2hB,iBAAiB,UAAW,KAC/ByB,GAAqB,GACrB3C,GAAezgB,KAEnB,CAuBEs6B,EACF,CAw3DQC,SA7aR5hC,iBACE,MAAM4mB,EAASzC,GAAG,qBACbyC,UACCmW,KACNnW,EAAOoC,iBAAiB,SAAUhpB,UAChC,MAAMqK,IAASuc,EAAOwC,cHxvCnBppB,eAA8B0G,GAAU,GAC7C,MAAM2D,IAAS3D,EAIf,OAHAjI,EAAoB4L,EACpB3L,EAAsBiF,WAChB9B,EAAOzF,EAAagB,aAAciN,EAAO,IAAM,KAC9CA,CACT,CGmvCUw3B,CAAex3B,GACrBuyB,GAAoBvyB,GAChBA,UACIsH,WACAgQ,YAEF6X,GAAoB,CAAEruB,OAAO,UAC7BsuB,GAAyB,CAAEtuB,OAAO,IACxCmZ,GAAUja,EAAO,8BAAgC,iCAAkC,CAAEy3B,YAAaz3B,MAEtG,CA8ZQ03B,GAEN,MAAMC,EAAiB7d,GAAG,kBACtB6d,GACFA,EAAehZ,iBAAiB,QAAS,IAAMgG,IAAqB,IAGtE5K,SAAS2D,iBAAiB,wBAAwB/E,QAAS2a,IACzDA,EAAI3U,iBAAiB,QAAS,IAAMgG,IAAqB,MAG3D5K,SAAS2D,iBAAiB,yBAAyB/E,QAAS2a,IAC1DA,EAAI3U,iBAAiB,QAAS,IAAMgG,IAAqB,MAG3D,MAAMiT,EAAe9d,GAAG,uBACpB8d,GACFA,EAAajZ,iBAAiB,QAAS,KA5mEpCwB,GAAoBznB,QACzBkkB,GAAmBuD,MA8mEnB,MAAM0X,EAAc/d,GAAG,eACnB+d,GACFA,EAAYlZ,iBAAiB,QAAS,KA98C1C,WACE,MAAMmZ,EAAUhe,GAAG,0BACbie,EAAUje,GAAG,0BACnB,IAAKge,IAAYC,EAAS,OACtBD,IAASA,EAAQja,UAAY,IAC7Bka,IAASA,EAAQla,UAAY,IAEjC,MAAMma,EAAiBA,CAAC7mC,EAAUwf,KAChC,IAAKA,EAAM,OACX,MAAM3T,EAAO2jB,GAAcxvB,IAAa,GACxC,IAAK,MAAMiP,KAAQpD,EAAM,CACvB,MAAM2gB,EAAM5D,SAASkE,cAAc,MAC7B8E,EAAaH,GAAgBxiB,GAE7B63B,EAAYle,SAASkE,cAAc,MACzCga,EAAU5d,YAAcja,EAAKuJ,GAE7B,MAAMuuB,EAAYne,SAASkE,cAAc,MACzCia,EAAUha,UAAY,2BACtBga,EAAU7d,YAAcqI,GAAWtiB,EAAKwgB,QAAQhf,OAEhD,MAAMu2B,EAAape,SAASkE,cAAc,MAC1Cka,EAAWja,UAAY,2BACvBia,EAAW9d,YAAcqI,GAAWtiB,EAAKwgB,QAAQ5O,QAEjD,MAAMomB,EAAWre,SAASkE,cAAc,MACxCma,EAASla,UAAY,0BACrBka,EAAS/d,YAAc0I,EAAWF,KAElC,MAAMwV,EAAate,SAASkE,cAAc,MAC1Coa,EAAWna,UAAY,0BACvBma,EAAWhe,YAAc0I,EAAWjS,UAEpC6M,EAAI1B,YAAYgc,GAChBta,EAAI1B,YAAYic,GAChBva,EAAI1B,YAAYkc,GAChBxa,EAAI1B,YAAYmc,GAChBza,EAAI1B,YAAYoc,GAChB1nB,EAAKsL,YAAY0B,EACnB,GAGFqa,EAAennC,EAAUG,OAAQ8mC,GACjCE,EAAennC,EAAUI,OAAQ8mC,EACnC,CA+BEO,QACA1T,IAAoB,KAq4CpB7K,SAAS2D,iBAAiB,sBAAsB/E,QAAS2a,IACvDA,EAAI3U,iBAAiB,QAAS,IAAMoG,QAGtChL,SAAS2D,iBAAiB,2BAA2B/E,QAAS2a,IAC5DA,EAAI3U,iBAAiB,QAAShpB,SAAYg/B,IAAkB,MAG9D5a,SAAS2D,iBAAiB,gCAAgC/E,QAAS2a,IACjEA,EAAI3U,iBAAiB,QAAS,IAAMmG,IAA2B,MAGjE,MAAMyT,EAAkBze,GAAG,mBACvBye,GACFA,EAAgB5Z,iBAAiB,QAAShpB,SAAYg/B,IAAkB,IAG1E,MAAM6D,EAAiB1e,GAAG,kBACtB0e,GACFA,EAAe7Z,iBAAiB,QAAShpB,SAAYg/B,IAAkB,IAGzE,MAAM8D,EAAuB3e,GAAG,wBAC5B2e,GACFA,EAAqB9Z,iBAAiB,QAAShpB,gBACvCg/B,IAAkB,GACxB5B,GAAsB,CAAEC,UAAU,MAItCjZ,SAAS2D,iBAAiB,0BAA0B/E,QAAS2a,IAC3DA,EAAI3U,iBAAiB,QAAS,KAC5BgG,IAAqB,GACrBoO,GAAsB,CAAEC,UAAU,QAItC,MAAM0F,EAAqB5e,GAAG,sBAC1B4e,GACFA,EAAmB/Z,iBAAiB,QAAShpB,SAnIjDA,iBACE,MAAMgjC,EAAc7e,GAAG,uBACjB8e,EAAc9e,GAAG,uBAEjB+e,QAAkBrF,GAAc3iC,EAAUG,OAAQ2nC,GAAa5hC,OAAS,IACxE+hC,QAAkBtF,GAAc3iC,EAAUI,OAAQ2nC,GAAa7hC,OAAS,IAE1E4hC,IAAaA,EAAY5hC,MAAQ,IACjC6hC,IAAaA,EAAY7hC,MAAQ,IAErCiuB,GAAan0B,EAAUG,OAAQ2uB,GAAS3qB,QACxCgwB,GAAan0B,EAAUI,OAAQ0uB,GAAS1qB,SAEpC4jC,GAAaC,IACf7e,GAAU,oBAAqB,CAAEjlB,SAAU6jC,EAAW5jC,SAAU6jC,KAG9DnZ,GAAS3qB,QAAU2qB,GAAS1qB,gBACxBs+B,GAAsB,CAAErM,QAAQ,IACtCpC,IAA2B,GAE/B,CA8G6DiU,IAG3D,MAAMC,EAAsBlf,GAAG,uBAC3Bkf,GACFA,EAAoBra,iBAAiB,QAAS,IAAMmG,IAA2B,IAGjF/K,SAAS4E,iBAAiB,UAAWhpB,UACrB,WAAVwO,EAAEtN,MACNu8B,KACI3O,GAAY,uBACdK,IAA2B,GAGzBL,GAAY,yBACRkQ,IAAkB,GAGtBlQ,GAAY,iBACdE,IAAqB,GAGnBF,GAAY,iBACdM,QAKJjL,GAAG,aAAa6E,iBAAiB,QAAS,IAAM6J,GAAY,WAC5D1O,GAAG,aAAa6E,iBAAiB,QAAS,IAAM6J,GAAY,WAG5D1O,GAAG,kBAAkB6E,iBAAiB,QAAShpB,UAC7CsyB,GAAmBp3B,EAAUG,cACvB2hC,OAGR7Y,GAAG,kBAAkB6E,iBAAiB,QAAShpB,UAC7CsyB,GAAmBp3B,EAAUI,cACvB0hC,OAIR7Y,GAAG,kBAAkB6E,iBAAiB,QAAS,MAjtCjD,WACE,MACMqJ,EAASF,GADHD,GAAS/N,GAAG,kBAAkB/iB,QAE1C+iB,GAAG,kBAAkBO,YAAcE,GAAayN,EAElD,CA6sCIiR,KAGFnf,GAAG,kBAAkB6E,iBAAiB,SAAUhpB,gBACxCg9B,OAIR7Y,GAAG,oBAAoB6E,iBAAiB,QAAS,KAC/C2J,OAGFxO,GAAG,oBAAoB6E,iBAAiB,SAAUhpB,gBA7fpDA,eAA+BuB,EAAU,CAAC,GACxC,MAAM,OAAEgwB,GAAS,EAAK,QAAE5e,EAAU,2BAA8BpR,EAC1DH,EAAQuxB,KACR4Q,QAAch+B,EAAoBnE,GAIxC,OAHKmwB,GACHjN,GAAU3R,EAAS,CAAE6wB,YAAaD,IAE7BA,CACT,CAsfUE,KAGR,MAAMvP,EAAW/P,GAAG,iBAChB+P,GACFA,EAASlL,iBAAiB,SAAUhpB,gBAzfxCA,eAA4BuB,EAAU,CAAC,GACrC,MAAM,OAAEgwB,GAAS,EAAK,QAAE5e,EAAU,0BAA6BpR,EACzDH,EAhsBR,WACE,MAAM6K,EAAQkY,GAAG,iBACjB,IAAKlY,EAAO,OAAO1Q,EAASQ,SAC5B,MAAMqF,EAAQwxB,GAAuB3mB,EAAM7K,OAE3C,OADA6K,EAAM7K,MAAQZ,OAAOY,GACdA,CACT,CA0rBgBsiC,GACRH,QAAc59B,GAAYvE,GAKhC,OAJA0pB,GAAgByY,EACXhS,GACHjN,GAAU3R,EAAS,CAAE5W,SAAUwnC,IAE1BA,CACT,CAifYI,KAIV,MAAMC,EAAiBzf,GAAG,yBACtByf,IACFA,EAAe5a,iBAAiB,QAAS,KACvC,MAAM8G,EAAU3L,GAAG,eACnB2H,GAA0BgE,EAAUA,EAAQ1uB,MAAQ,GAAIwiC,EAAexiC,SAEzEwiC,EAAe5a,iBAAiB,SAAUhpB,gBAhV9CA,iBACE,MAAM8vB,EAAU3L,GAAG,eACb6H,EAAW7H,GAAG,yBACpB,IAAK6H,EAAU,OACf,MAAMrc,EAAQmc,GAA0BgE,EAAUA,EAAQ1uB,MAAQ,GAAI4qB,EAAS5qB,OAC3EuO,SAAanL,EAAyBmL,GAC1C2U,GAAU,oCAAqC,CAAE3oB,sBAAuBgU,GAC1E,CA0UYk0B,MAIV,MAAM7X,EAAW7H,GAAG,yBAChB6H,IACFA,EAAShD,iBAAiB,QAAS,KACjC,MAAM2D,EAA2C,MAA/BX,EAASrG,QAAQgH,UACnC,IAAIhd,EAAQwc,GAAwBH,EAAS5qB,OACxCurB,GAAuB,SAAVhd,IAChBqc,EAAS5qB,MAAQ,IACjBuO,EAAQwc,GAAwBH,EAAS5qB,QAE3C4qB,EAASvD,aAAa,iBAAkB9Y,KAE1Cqc,EAAShD,iBAAiB,SAAUhpB,gBAvVxCA,iBACE,MAAM8vB,EAAU3L,GAAG,eACb6H,EAAW7H,GAAG,yBACpB,IAAK6H,EAAU,OACf,MAAMrc,EAAQ+c,GAA0BoD,EAAUA,EAAQ1uB,MAAQ,GAAI4qB,EAAS5qB,OAC3EuO,SAAapL,EAAyBoL,GAC1C2U,GAAU,oCAAqC,CAAE1oB,sBAAuB+T,GAC1E,CAiVYm0B,MAIV,MAAM3P,EAAgBhQ,GAAG,eACrBgQ,GACFA,EAAcnL,iBAAiB,SAAUhpB,gBACjCi+B,GAAkB/iC,EAAUG,UAItC,MAAM+4B,EAAgBjQ,GAAG,eACrBiQ,GACFA,EAAcpL,iBAAiB,SAAUhpB,gBACjCi+B,GAAkB/iC,EAAUI,UAItC8oB,SAAS2D,iBAAiB6B,IAAoB5G,QAAS/W,IACrD,MAAMzQ,EAAWgF,OAAOyL,EAAM0Z,QAAQ8J,UAAY,IAAIhtB,OAAOW,cACxD5H,IACLyQ,EAAM+c,iBAAiB,QAAS,IAAMoV,GAAgBnyB,GAAO,IAC7DA,EAAM+c,iBAAiB,SAAUhpB,gBACzB+9B,GAAgBviC,EAAUyQ,KAElCA,EAAM+c,iBAAiB,UAAYkX,IACjC,GAAkB,UAAdA,EAAMh/B,IAAiB,OAC3Bg/B,EAAMc,iBACN,MAAM+C,EAAY93B,EAAM6gB,QAAQ,kBAAkB7G,cAAc4D,IAC5Dka,EAAWA,EAAUC,QACfjG,GAAgBviC,EAAUyQ,QAIxCmY,SAAS2D,iBAAiB8B,IAAmB7G,QAAS2a,IACpD,MAAMniC,EAAWgF,OAAOm9B,EAAIhY,QAAQse,SAAW,IAAIxhC,OAAOW,cACrD5H,GACLmiC,EAAI3U,iBAAiB,QAAShpB,UAC5B,MAAMiM,EAAQ0xB,EAAI7Q,QAAQ,kBAAkB7G,cAAc2D,UACpDmU,GAAgBviC,EAAUyQ,GACD,SAA3B0xB,EAAIhY,QAAQue,kBACRtG,SAKZ,MAAMuG,EAAuBhgB,GAAG,wBAC1BigB,EAAkBjgB,GAAG,mBACvBggB,GACFA,EAAqBnb,iBAAiB,QAAS,IAAMgI,IAAuB,IAE1EoT,GACFA,EAAgBpb,iBAAiB,QAAS,IAAMgI,IAAuB,EAAM,CAAEE,OAAO,KAGxF9M,SAAS2D,iBAAiB+B,IAAwB9G,QAAS/W,IACzDA,EAAM+c,iBAAiB,QAAS,IAAMoV,GAAgBnyB,GAAO,IAC7DA,EAAM+c,iBAAiB,UAAYkX,IACjC,GAAkB,UAAdA,EAAMh/B,IAAiB,OAC3Bg/B,EAAMc,iBACN,MAAMqD,EACJjgB,SAAS6B,cAAc,gDAAgDha,EAAM+H,SAC7E/H,EAAM6gB,QAAQ,uCAAuC7G,cAAc,2BACjEoe,GACG/F,GAAsBryB,EAAOo4B,OAKxCjgB,SAAS2D,iBAAiB,2BAA2B/E,QAAS2a,IAC5DA,EAAI3U,iBAAiB,QAAShpB,UAC5B,MAAM0/B,EAAW/B,EAAIhY,QAAQ2e,cACvBr4B,GACHyzB,EAAWvb,GAAGub,GAAY,OAC3B/B,EAAI7Q,QAAQ,uCAAuC7G,cAAc6D,UAC7DwU,GAAsBryB,EAAO0xB,OAIvCvZ,SAAS2D,iBAAiB,uBAAuB/E,QAAS2a,IACxDA,EAAI3U,iBAAiB,QAAShpB,UAC5B,MAAM0/B,EAAW/B,EAAIhY,QAAQ2e,cACvBr4B,GACHyzB,EAAWvb,GAAGub,GAAY,OAC3B/B,EAAI7Q,QAAQ,kBAAkB7G,cAAc6D,UAxXpD9pB,eAAiCg+B,EAASO,GACxC,IAAKP,IAAYO,EAAU,OAE3B,MAAMgG,GAAYvG,EAAQ58B,OAAS,IAAIqB,OACjCX,EAASmoB,UAAuBlG,KAChCygB,EAAYD,GAAYziC,GAAQZ,KAAO,GAI7C,GAFAk9B,GAAgBJ,GAAS,IAEpBwG,EAGH,OAFApG,GAAgBJ,GAAS,QACzB1Z,GAAU,2BAA4B,CAAEpW,IAAI,IAI9C,MAAMswB,EAAgBD,EAAS7Z,YAC/B6Z,EAASxV,UAAW,EACpBwV,EAAS7Z,YAAc,UAEvB,MAAM/iB,QD3jED3B,eAA+BkB,EAAKK,EAAU,CAAC,GACpD,MAAMuC,EAAUue,GAAanhB,GAC7B,IAAK4C,GAAWA,EAAQf,OAjJC,EAkJvB,MAAO,CAAE07B,SAAS,EAAO5oB,MAAO,mBAGlC,MAAM/T,QAAeiiB,KACfV,EAAa9hB,EAAQ8hB,YAAcvhB,GAAQuhB,YAAc,GAE/D,IACE,MAAM,GAAEnV,EAAE,OAAE5H,EAAM,KAAE8Y,SAAeuD,GA3JV,oDA2J4C,CACnEe,YAAa5f,EACbyf,YAAaF,QAAc9K,IAG7B,OAAKrK,EAIDkR,GAAMzQ,MAED,CAAE8vB,SAAS,EAAMl3B,QADR4b,GAAarf,EAASsb,EAAM,CAAEiE,aAAYO,YAAa9hB,GAAQ8hB,eAI1E,CAAE6a,SAAS,EAAO5oB,MAAO2M,GAAapD,EAAM,iBAR1C,CAAEqf,SAAS,EAAO5oB,MAAO2M,GAAapD,EAAM,eAAe9Y,MAStE,CAAE,MACA,MAAO,CAAEm4B,SAAS,EAAO5oB,MAAO,+BAClC,CACF,CC+hEuB4uB,CAAgBD,GAKrC,GAHAjG,EAASxV,UAAW,EACpBwV,EAAS7Z,YAAc8Z,EAEnB78B,EAAO88B,QAAS,CAClB,MAAMhN,EAAS9vB,EAAO4F,SAASkc,WAAa,MAiB5C,OAhBI3hB,GAAU0iC,IAAc1iC,EAAOZ,WAC3B+iB,GAAkB,IACnBniB,KACAH,EAAO4F,QACVoH,OAAO,EACPkV,eAAe,IAAIpc,MAAO8a,sBAEtB+O,GAAiB,CAAEC,QAAQ,KACvBzvB,GAAWA,EAAOZ,KAC5B6vB,GAAoB,oCAAoC,SAEtDwT,GAAcziC,GAAU0iC,IAAc1iC,EAAOZ,IAG/CojB,GAAU,iBAAkB,CAAEb,UAAWgO,IAFzCnN,GAAU,0DAA2D,CAAEb,UAAWgO,IAKtF,CAEA,MAAMsN,EAAYp9B,EAAOkU,OAAS,eAClCyO,GAAU,mBAAoB,CAAEzO,MAAOkpB,IACnCj9B,GAAU0iC,IAAc1iC,EAAOZ,WAC3B+iB,GAAkB,IACnBniB,EACH6M,OAAO,EACPkV,eAAe,IAAIpc,MAAO8a,sBAEtB+O,GAAiB,CAAEC,QAAQ,KACvBzvB,GAAWA,EAAOZ,KAC5B6vB,GAAoBgO,GAAW,EAEnC,CAgUY2F,CAAkBz4B,EAAO0xB,OAInCvZ,SAAS2D,iBAAiB,wBAAwB/E,QAAS2a,IACzDA,EAAI3U,iBAAiB,QAAShpB,SAnUlCA,uBDvpEOA,uBACCwH,IACR,CCspEQm9B,GACN1a,GAAe,KACf7F,SAAS2D,iBAAiB+B,IAAwB9G,QAAS/W,IACzDA,EAAM7K,MAAQ,GACdg9B,GAAgBnyB,GAAO,WAEnBqlB,GAAiB,CAAEC,QAAQ,IACjCjN,GAAU,kBAAmB,CAAEpW,IAAI,GACrC,CA0T8C02B,MAI5C,MAAMC,EAAiB1gB,GAAG,eACtB0gB,GACFA,EAAe7b,iBAAiB,QAAShpB,SAAYm/B,GAAcjkC,EAAUG,SAE/E,MAAMypC,EAAiB3gB,GAAG,eACtB2gB,GACFA,EAAe9b,iBAAiB,QAAShpB,SAAYm/B,GAAcjkC,EAAUI,SAG/E,MAAMypC,EAAgB5gB,GAAG,cACrB4gB,GACFA,EAAc/b,iBAAiB,QAAShpB,SAAYq/B,GAAankC,EAAUG,SAE7E,MAAM2pC,EAAgB7gB,GAAG,cACrB6gB,GACFA,EAAchc,iBAAiB,QAAShpB,SAAYq/B,GAAankC,EAAUI,SAG7E,MAAM2pC,EAAgB9gB,GAAG,oBACrB8gB,GACFA,EAAcjc,iBAAiB,QAAShpB,gBHp4BrCA,iBACLyN,GAAeC,KACfE,IAAqB,EACrBD,GAAsB,KACtBE,GAA2BlK,KAC3BmK,IAAoB,QACd/L,EAAU3F,EAAaoB,aAC/B,CG83BY0nC,SACA1L,GAAoB,CAAEruB,OAAO,IACnCmZ,GAAU,4BAA6B,CAAEpW,IAAI,MAIjD,MAAMi3B,EAAkBhhB,GAAG,mBACvBghB,GACFA,EAAgBnc,iBAAiB,QAAS,KACxC4B,IAAiBA,GACjB0P,KACAlD,GAAcvM,MAGlByP,KAEAnW,GAAG,aAAa6E,iBAAiB,QAAShpB,gBAClC2R,WACA6nB,GAAoB,CAAEruB,OAAO,IACnCmZ,GAAU,iBAAkB,CAAEpW,IAAI,MAGpCiW,GAAG,gBAAgB6E,iBAAiB,QAAShpB,gBACrCy5B,GAAyB,CAAEtuB,OAAO,IACxCmZ,GAAU,kBAAmB,CAAEpW,IAAI,MAGrCiW,GAAG,cAAc6E,iBAAiB,QAAShpB,gBACnC2hB,WACA8X,GAAyB,CAAEtuB,OAAO,IACxCmZ,GAAU,aAAc,CAAEpW,IAAI,MAGhC,MAAMk3B,EAAYjhB,GAAG,aACjBihB,GACFA,EAAUpc,iBAAiB,QAAShpB,WFlxEjC,WACL,IAAKmT,GAAMpQ,OAAQ,OAAO,EAC1B,MAAMyQ,EAAUL,GAAMI,QACtB,IAAK,MAAM1L,KAAW2L,EACpB3L,EAAQ0K,IAEV4D,KACO3C,EAAQzQ,MACjB,CE2wEMsiC,SACMpL,GAA4B,CAAE9uB,OAAO,MAK/C0nB,GAAY,gBAENE,WACAzB,GAAiB,CAAEC,QAAQ,UAC3BiI,GAAoB,CAAEruB,OAAO,UAC7BsuB,GAAyB,CAAEtuB,OAAO,UAClC8uB,GAA4B,CAAE9uB,OAAO,UApW7CnL,uBH7rDOA,iBAGL,aAFMiC,IAES,YADGX,EAAOlF,EAAaW,gBAExC,CG0rDqBuoC,IAEnBpW,IAAuB,EACzB,CAiWQqW,GAQNnhB,SAAS4E,iBAAiB,mBAAoB,KACvCoQ,OANAI,KACAC,KACAQ,QAOPzjB,YAAY,KAAWgjB,MAAuB,KAC9ChjB,YAAY,KAAWijB,MAA4B,MACnDjjB,YAAY,KAAWyjB,MAA+B,IACxD,CAEA7V,SAAS4E,iBAAiB,mBAAoBhpB,gBA/V9CA,iBACE,IACwB,oBAAXwlC,QAA0BA,QAAQC,eACrCD,OAAOC,SAEjB,CAAE,MACA,CAEJ,CAwVQC,SACAjG,M","sources":["webpack://excel-ai-gemini-addin/./src/shared/core.js","webpack://excel-ai-gemini-addin/./src/shared/providers.js","webpack://excel-ai-gemini-addin/./src/license.js","webpack://excel-ai-gemini-addin/./src/taskpane/taskpane.js"],"sourcesContent":["// src/shared/core.js\n// Shared utilities + persisted configuration for the Neurow add-in.\n//\n// Key design goals:\n// - Two providers (Gemini + OpenAI) can coexist.\n// - The default provider is chosen in the taskpane (not in formulas).\n// - No temperature / sampling controls anywhere (per requirements).\n// - A single \"max output tokens\" setting applies to both providers.\n\nexport const PROVIDERS = Object.freeze({\n  GEMINI: \"gemini\",\n  OPENAI: \"openai\"\n});\n\nexport const DEFAULTS = Object.freeze({\n  provider: PROVIDERS.GEMINI,\n  // Default models (User specified future versions)\n  geminiModel: \"gemini-3-flash-preview\",\n  openaiModel: \"gpt-5-mini\",\n  geminiReasoningEffort: \"minimal\",\n  openaiReasoningEffort: \"low\",\n  maxOutputTokens: 4096,\n  concurrencyLimit: 4,\n  rpmLimit: 0,\n\n  // Execution / UX\n  retry: 2,\n  timeoutMs: 120000,\n\n  // In-memory cache (per runtime). Note: Office custom functions can run in a long-lived runtime.\n  cache: true,\n  cacheTtlSec: 7 * 24 * 3600 // 7 days\n});\n\nconst STORAGE_KEYS = Object.freeze({\n  DEFAULT_PROVIDER: \"AI_DEFAULT_PROVIDER_V3\",\n  GEMINI_API_KEY: \"AI_GEMINI_API_KEY_V3\",\n  OPENAI_API_KEY: \"AI_OPENAI_API_KEY_V3\",\n  GEMINI_MODEL: \"AI_GEMINI_MODEL_V3\",\n  OPENAI_MODEL: \"AI_OPENAI_MODEL_V3\",\n  GEMINI_REASONING_EFFORT: \"AI_GEMINI_REASONING_EFFORT_V3\",\n  OPENAI_REASONING_EFFORT: \"AI_OPENAI_REASONING_EFFORT_V3\",\n  MAX_OUTPUT_TOKENS: \"AI_MAX_OUTPUT_TOKENS_V3\",\n  CONCURRENCY_LIMIT: \"AI_CONCURRENCY_LIMIT_V1\",\n  RPM_LIMIT: \"AI_RPM_LIMIT_V1\",\n  ONBOARDING_SEEN: \"AI_ONBOARDING_SEEN_V1\",\n  ONBOARDING_KEYS_CONFIRMED: \"AI_ONBOARDING_KEYS_CONFIRMED_V1\",\n  SECTION_ORDER: \"AI_SECTION_ORDER_V1\",\n  SECTION_HIDDEN: \"AI_SECTION_HIDDEN_V1\",\n  LICENSE: \"AI_LICENSE_V1\",\n  PRIVACY_MODE: \"AI_PRIVACY_MODE_V1\",\n\n  // Prevent re-running migrations each time.\n  MIGRATION_DONE: \"AI_MIGRATION_DONE_V3\",\n\n  // Diagnostics + cache metadata\n  REQUEST_LOG: \"AI_REQUEST_LOG_V1\",\n  REQUEST_LOG_CLEAR_AT: \"AI_REQUEST_LOG_CLEAR_AT_V1\",\n  USAGE_TOTALS: \"AI_USAGE_TOTALS_V1\",\n  CACHE_INDEX: \"AI_CACHE_INDEX_V1\",\n  CACHE_CLEAR_AT: \"AI_CACHE_CLEAR_AT_V1\",\n  RUNTIME_STATUS: \"AI_RUNTIME_STATUS_V1\",\n  GEMINI_CACHED_CONTENT: \"AI_GEMINI_CACHED_CONTENT_V1\"\n});\n\nconst SENSITIVE_KEYS = new Set([STORAGE_KEYS.GEMINI_API_KEY, STORAGE_KEYS.OPENAI_API_KEY, STORAGE_KEYS.LICENSE]);\n\n// Older keys used by previous versions (best-effort migration).\nconst LEGACY_KEYS = Object.freeze({\n  GEMINI_API_KEY: \"GEMINI_API_KEY\",\n  MAX_OUTPUT_TOKENS: \"MAX_OUTPUT_TOKENS\",\n\n  DEFAULT_PROVIDER_V2: \"AI_DEFAULT_PROVIDER_V2\",\n  GEMINI_API_KEY_V2: \"AI_GEMINI_API_KEY_V2\",\n  OPENAI_API_KEY_V2: \"AI_OPENAI_API_KEY_V2\",\n  GEMINI_MODEL_V2: \"AI_GEMINI_MODEL_V2\",\n  OPENAI_MODEL_V2: \"AI_OPENAI_MODEL_V2\",\n\n  GEMINI_MAX_TOKENS_V2: \"AI_GEMINI_MAX_OUTPUT_TOKENS_V2\",\n  OPENAI_MAX_TOKENS_V2: \"AI_OPENAI_MAX_OUTPUT_TOKENS_V2\"\n});\n\nlet _migrationPromise = null;\nlet _officeStorageFailed = false;\nlet _privacyModeCache = null;\nlet _privacyModeCacheAt = 0;\nconst SETTINGS_CACHE_TTL_MS = 1500;\nlet _defaultProviderCache = null;\nlet _defaultProviderCacheAt = 0;\nlet _maxOutputTokensCache = null;\nlet _maxOutputTokensCacheAt = 0;\nlet _geminiReasoningCache = null;\nlet _geminiReasoningCacheAt = 0;\nlet _openaiReasoningCache = null;\nlet _openaiReasoningCacheAt = 0;\nconst _apiKeyCache = { gemini: null, openai: null };\nconst _apiKeyCacheAt = { gemini: 0, openai: 0 };\nconst _modelCache = { gemini: null, openai: null };\nconst _modelCacheAt = { gemini: 0, openai: 0 };\n\nfunction markOfficeStorageFailed() {\n  _officeStorageFailed = true;\n}\n\nfunction isSensitiveKey(key) {\n  return SENSITIVE_KEYS.has(key);\n}\n\nconst MEMORY_STORAGE = {\n  kind: \"memory\",\n  storage: (() => {\n    const mem = new Map();\n    return {\n      async getItem(k) {\n        return mem.has(k) ? mem.get(k) : null;\n      },\n      async setItem(k, v) {\n        mem.set(k, String(v));\n      },\n      async removeItem(k) {\n        mem.delete(k);\n      }\n    };\n  })()\n};\n\nfunction getRuntimeStorage() {\n  if (!_officeStorageFailed) {\n    try {\n      if (typeof OfficeRuntime !== \"undefined\" && OfficeRuntime?.storage?.getItem) {\n        return { kind: \"office\", storage: OfficeRuntime.storage };\n      }\n    } catch {\n      // ignore\n    }\n  }\n\n  try {\n    if (typeof window !== \"undefined\" && window?.localStorage?.getItem) {\n      return { kind: \"local\", storage: window.localStorage };\n    }\n  } catch {\n    // ignore\n  }\n\n  // Extremely defensive fallback (in-memory only, persisted for this session).\n  return MEMORY_STORAGE;\n}\n\nfunction getLocalStorageSafe() {\n  try {\n    if (typeof window !== \"undefined\" && window?.localStorage?.getItem) {\n      return window.localStorage;\n    }\n  } catch {\n    return null;\n  }\n  return null;\n}\n\nfunction localGet(local, key) {\n  try {\n    return local.getItem(key);\n  } catch {\n    return null;\n  }\n}\n\nfunction localSet(local, key, value) {\n  try {\n    local.setItem(key, value);\n    return true;\n  } catch {\n    return false;\n  }\n}\n\nfunction localRemove(local, key) {\n  try {\n    local.removeItem(key);\n    return true;\n  } catch {\n    return false;\n  }\n}\n\nexport function storageBackendName() {\n  return getRuntimeStorage().kind;\n}\n\nasync function rawGet(key, options = {}) {\n  const { kind, storage } = getRuntimeStorage();\n  const sensitive = options.sensitive ?? isSensitiveKey(key);\n  const allowLocalFallback = options.allowLocalFallback !== false;\n\n  if (kind === \"local\") {\n    return localGet(storage, key);\n  }\n\n  if (kind === \"office\") {\n    let result = null;\n    try {\n      result = await storage.getItem(key);\n    } catch {\n      markOfficeStorageFailed();\n    }\n    if (result != null) {\n      if (sensitive) {\n        const local = getLocalStorageSafe();\n        if (local) localRemove(local, key);\n      }\n      return result;\n    }\n    if (!allowLocalFallback) return null;\n\n    const local = getLocalStorageSafe();\n    if (!local) return null;\n    const localValue = localGet(local, key);\n    if (localValue == null) return null;\n\n    if (!_officeStorageFailed) {\n      try {\n        await storage.setItem(key, String(localValue));\n        localRemove(local, key);\n      } catch {\n        markOfficeStorageFailed();\n      }\n    }\n\n    return localValue;\n  }\n\n  try {\n    return await storage.getItem(key);\n  } catch {\n    return null;\n  }\n}\n\nasync function rawSet(key, value, options = {}) {\n  const { kind, storage } = getRuntimeStorage();\n  const v = value == null ? \"\" : String(value);\n  const allowLocalFallback = options.allowLocalFallback !== false;\n\n  if (kind === \"local\") {\n    localSet(storage, key, v);\n    return;\n  }\n\n  if (kind === \"office\") {\n    let stored = false;\n    try {\n      await storage.setItem(key, v);\n      stored = true;\n    } catch {\n      markOfficeStorageFailed();\n    }\n\n    const local = getLocalStorageSafe();\n    if (stored) {\n      if (local) localRemove(local, key);\n      return;\n    }\n\n    if (!allowLocalFallback || !local) return;\n    localSet(local, key, v);\n    return;\n  }\n\n  try {\n    await storage.setItem(key, v);\n  } catch {\n    // ignore\n  }\n}\n\nasync function rawRemove(key) {\n  const { kind, storage } = getRuntimeStorage();\n\n  if (kind === \"local\") {\n    localRemove(storage, key);\n    return;\n  }\n\n  if (kind === \"office\") {\n    let removed = false;\n    try {\n      await storage.removeItem(key);\n      removed = true;\n    } catch {\n      markOfficeStorageFailed();\n    }\n\n    const local = getLocalStorageSafe();\n    if (local) localRemove(local, key);\n    return;\n  }\n\n  try {\n    await storage.removeItem(key);\n  } catch {\n    // ignore\n  }\n}\n\nasync function ensureMigrated() {\n  if (_migrationPromise) return _migrationPromise;\n\n  _migrationPromise = (async () => {\n    // Fast exit if already migrated\n    const done = await rawGet(STORAGE_KEYS.MIGRATION_DONE);\n    if (done === \"1\") return;\n\n    // Migrate provider\n    const currentProvider = normalizeProvider(await rawGet(STORAGE_KEYS.DEFAULT_PROVIDER));\n    if (!currentProvider) {\n      const legacyProvider = normalizeProvider(await rawGet(LEGACY_KEYS.DEFAULT_PROVIDER_V2));\n      await rawSet(STORAGE_KEYS.DEFAULT_PROVIDER, legacyProvider || DEFAULTS.provider);\n    }\n\n    // Migrate keys\n    const gKey = await rawGet(STORAGE_KEYS.GEMINI_API_KEY);\n    if (!gKey) {\n      const legacy = (await rawGet(LEGACY_KEYS.GEMINI_API_KEY_V2)) || (await rawGet(LEGACY_KEYS.GEMINI_API_KEY));\n      if (legacy) await rawSet(STORAGE_KEYS.GEMINI_API_KEY, legacy);\n    }\n\n    const oKey = await rawGet(STORAGE_KEYS.OPENAI_API_KEY);\n    if (!oKey) {\n      const legacy = await rawGet(LEGACY_KEYS.OPENAI_API_KEY_V2);\n      if (legacy) await rawSet(STORAGE_KEYS.OPENAI_API_KEY, legacy);\n    }\n\n    // Migrate models\n    const gModel = await rawGet(STORAGE_KEYS.GEMINI_MODEL);\n    if (!gModel) {\n      const legacy = await rawGet(LEGACY_KEYS.GEMINI_MODEL_V2);\n      await rawSet(STORAGE_KEYS.GEMINI_MODEL, legacy || DEFAULTS.geminiModel);\n    }\n\n    const oModel = await rawGet(STORAGE_KEYS.OPENAI_MODEL);\n    if (!oModel) {\n      const legacy = await rawGet(LEGACY_KEYS.OPENAI_MODEL_V2);\n      await rawSet(STORAGE_KEYS.OPENAI_MODEL, legacy || DEFAULTS.openaiModel);\n    }\n\n    // Migrate max tokens (unified)\n    const tok = await rawGet(STORAGE_KEYS.MAX_OUTPUT_TOKENS);\n    if (!tok) {\n      const legacyUnified = await rawGet(LEGACY_KEYS.MAX_OUTPUT_TOKENS);\n      const legacyGem = await rawGet(LEGACY_KEYS.GEMINI_MAX_TOKENS_V2);\n      const legacyOai = await rawGet(LEGACY_KEYS.OPENAI_MAX_TOKENS_V2);\n\n      const candidates = [legacyUnified, legacyGem, legacyOai]\n        .map((x) => parseInt(String(x || \"\").trim(), 10))\n        .filter((n) => Number.isFinite(n) && n > 0);\n\n      const migrated = candidates.length ? Math.max(...candidates) : DEFAULTS.maxOutputTokens;\n      await rawSet(STORAGE_KEYS.MAX_OUTPUT_TOKENS, String(migrated));\n    }\n\n    await rawSet(STORAGE_KEYS.MIGRATION_DONE, \"1\");\n  })();\n\n  try {\n    await _migrationPromise;\n  } finally {\n    _migrationPromise = null;\n  }\n}\n\nexport function normalizeProvider(p) {\n  if (!p) return \"\";\n  const s = String(p).trim().toLowerCase();\n  if (s === PROVIDERS.GEMINI) return PROVIDERS.GEMINI;\n  if (s === PROVIDERS.OPENAI) return PROVIDERS.OPENAI;\n  // Common aliases (defensive)\n  if (s === \"google\" || s === \"gem\") return PROVIDERS.GEMINI;\n  if (s === \"oai\" || s === \"chatgpt\") return PROVIDERS.OPENAI;\n  return \"\";\n}\n\nconst GEMINI_REASONING_EFFORTS = new Set([\"auto\", \"minimal\", \"low\", \"medium\", \"high\"]);\nconst OPENAI_REASONING_EFFORTS = new Set([\"none\", \"minimal\", \"low\", \"medium\", \"high\"]);\n\nfunction normalizeGeminiReasoningEffort(value) {\n  const v = String(value || \"\").trim().toLowerCase();\n  if (!v) return DEFAULTS.geminiReasoningEffort;\n  return GEMINI_REASONING_EFFORTS.has(v) ? v : DEFAULTS.geminiReasoningEffort;\n}\n\nfunction normalizeReasoningEffort(value) {\n  const v = String(value || \"\").trim().toLowerCase();\n  if (!v) return DEFAULTS.openaiReasoningEffort;\n  return OPENAI_REASONING_EFFORTS.has(v) ? v : DEFAULTS.openaiReasoningEffort;\n}\n\nexport async function getDefaultProvider() {\n  const now = nowMs();\n  if (_defaultProviderCache && now - _defaultProviderCacheAt < SETTINGS_CACHE_TTL_MS) {\n    return _defaultProviderCache;\n  }\n  await ensureMigrated();\n  const p = normalizeProvider(await rawGet(STORAGE_KEYS.DEFAULT_PROVIDER)) || DEFAULTS.provider;\n  _defaultProviderCache = p;\n  _defaultProviderCacheAt = now;\n  return p;\n}\n\nexport async function setDefaultProvider(provider) {\n  const p = normalizeProvider(provider) || DEFAULTS.provider;\n  await rawSet(STORAGE_KEYS.DEFAULT_PROVIDER, p);\n  _defaultProviderCache = p;\n  _defaultProviderCacheAt = nowMs();\n  return p;\n}\n\nfunction keyKey(provider) {\n  const p = normalizeProvider(provider);\n  if (p === PROVIDERS.OPENAI) return STORAGE_KEYS.OPENAI_API_KEY;\n  return STORAGE_KEYS.GEMINI_API_KEY;\n}\n\nexport async function getApiKey(provider) {\n  const p = normalizeProvider(provider) === PROVIDERS.OPENAI ? PROVIDERS.OPENAI : PROVIDERS.GEMINI;\n  const now = nowMs();\n  if (_apiKeyCache[p] != null && now - _apiKeyCacheAt[p] < SETTINGS_CACHE_TTL_MS) {\n    return (_apiKeyCache[p] || \"\").trim();\n  }\n  await ensureMigrated();\n  const k = (await rawGet(keyKey(p))) || \"\";\n  const trimmed = String(k).trim();\n  _apiKeyCache[p] = trimmed;\n  _apiKeyCacheAt[p] = now;\n  return trimmed;\n}\n\nexport async function hasApiKey(provider) {\n  const k = await getApiKey(provider);\n  return !!k;\n}\n\nexport async function setApiKey(provider, apiKey) {\n  const k = (apiKey || \"\").trim();\n  const p = normalizeProvider(provider) === PROVIDERS.OPENAI ? PROVIDERS.OPENAI : PROVIDERS.GEMINI;\n  await rawSet(keyKey(p), k);\n  _apiKeyCache[p] = k;\n  _apiKeyCacheAt[p] = nowMs();\n  return k;\n}\n\nexport async function clearApiKey(provider) {\n  const p = normalizeProvider(provider) === PROVIDERS.OPENAI ? PROVIDERS.OPENAI : PROVIDERS.GEMINI;\n  await rawRemove(keyKey(p));\n  _apiKeyCache[p] = \"\";\n  _apiKeyCacheAt[p] = nowMs();\n}\n\nfunction modelKey(provider) {\n  const p = normalizeProvider(provider);\n  if (p === PROVIDERS.OPENAI) return STORAGE_KEYS.OPENAI_MODEL;\n  return STORAGE_KEYS.GEMINI_MODEL;\n}\n\nexport async function getModel(provider) {\n  const p = normalizeProvider(provider) === PROVIDERS.OPENAI ? PROVIDERS.OPENAI : PROVIDERS.GEMINI;\n  const now = nowMs();\n  const cached = _modelCache[p];\n  if (cached && now - _modelCacheAt[p] < SETTINGS_CACHE_TTL_MS) return cached;\n  await ensureMigrated();\n  const raw = await rawGet(modelKey(p));\n  const resolved = (raw && String(raw).trim())\n    ? String(raw).trim()\n    : (p === PROVIDERS.OPENAI ? DEFAULTS.openaiModel : DEFAULTS.geminiModel);\n  _modelCache[p] = resolved;\n  _modelCacheAt[p] = now;\n  return resolved;\n}\n\nexport async function getGeminiReasoningEffort() {\n  const now = nowMs();\n  if (_geminiReasoningCache && now - _geminiReasoningCacheAt < SETTINGS_CACHE_TTL_MS) {\n    return _geminiReasoningCache;\n  }\n  await ensureMigrated();\n  const raw = await rawGet(STORAGE_KEYS.GEMINI_REASONING_EFFORT);\n  const v = normalizeGeminiReasoningEffort(raw || DEFAULTS.geminiReasoningEffort);\n  _geminiReasoningCache = v;\n  _geminiReasoningCacheAt = now;\n  return v;\n}\n\nexport async function getOpenAIReasoningEffort() {\n  const now = nowMs();\n  if (_openaiReasoningCache && now - _openaiReasoningCacheAt < SETTINGS_CACHE_TTL_MS) {\n    return _openaiReasoningCache;\n  }\n  await ensureMigrated();\n  const raw = await rawGet(STORAGE_KEYS.OPENAI_REASONING_EFFORT);\n  const v = normalizeReasoningEffort(raw || DEFAULTS.openaiReasoningEffort);\n  _openaiReasoningCache = v;\n  _openaiReasoningCacheAt = now;\n  return v;\n}\n\nexport async function setModel(provider, model) {\n  const p = normalizeProvider(provider) === PROVIDERS.OPENAI ? PROVIDERS.OPENAI : PROVIDERS.GEMINI;\n  const v = String(model || \"\").trim();\n  if (!v) {\n    // Reset to default if emptied\n    const fallback = p === PROVIDERS.OPENAI ? DEFAULTS.openaiModel : DEFAULTS.geminiModel;\n    await rawSet(modelKey(p), fallback);\n    _modelCache[p] = fallback;\n    _modelCacheAt[p] = nowMs();\n    return;\n  }\n  await rawSet(modelKey(p), v);\n  _modelCache[p] = v;\n  _modelCacheAt[p] = nowMs();\n}\n\nexport async function setOpenAIReasoningEffort(value) {\n  const v = normalizeReasoningEffort(value);\n  await rawSet(STORAGE_KEYS.OPENAI_REASONING_EFFORT, v);\n  _openaiReasoningCache = v;\n  _openaiReasoningCacheAt = nowMs();\n  return v;\n}\n\nexport async function setGeminiReasoningEffort(value) {\n  const v = normalizeGeminiReasoningEffort(value);\n  await rawSet(STORAGE_KEYS.GEMINI_REASONING_EFFORT, v);\n  _geminiReasoningCache = v;\n  _geminiReasoningCacheAt = nowMs();\n  return v;\n}\n\nexport async function getMaxOutputTokens() {\n  const now = nowMs();\n  if (_maxOutputTokensCache && now - _maxOutputTokensCacheAt < SETTINGS_CACHE_TTL_MS) {\n    return _maxOutputTokensCache;\n  }\n  await ensureMigrated();\n  const raw = await rawGet(STORAGE_KEYS.MAX_OUTPUT_TOKENS);\n  const n = parseInt(String(raw || \"\").trim(), 10);\n  const v = clampInt(n, 1, 128000, DEFAULTS.maxOutputTokens);\n  _maxOutputTokensCache = v;\n  _maxOutputTokensCacheAt = now;\n  return v;\n}\n\nexport async function setMaxOutputTokens(value) {\n  const n = clampInt(value, 1, 128000, DEFAULTS.maxOutputTokens);\n  await rawSet(STORAGE_KEYS.MAX_OUTPUT_TOKENS, String(n));\n  _maxOutputTokensCache = n;\n  _maxOutputTokensCacheAt = nowMs();\n  return n;\n}\n\nconst CONCURRENCY_OPTIONS = [4, 8, 16, 32, 64, 128];\n\nfunction normalizeConcurrencyLimit(value) {\n  const base = clampInt(\n    value,\n    CONCURRENCY_OPTIONS[0],\n    CONCURRENCY_OPTIONS[CONCURRENCY_OPTIONS.length - 1],\n    DEFAULTS.concurrencyLimit\n  );\n  if (CONCURRENCY_OPTIONS.includes(base)) return base;\n  let best = CONCURRENCY_OPTIONS[0];\n  let bestDiff = Math.abs(base - best);\n  for (const option of CONCURRENCY_OPTIONS.slice(1)) {\n    const diff = Math.abs(base - option);\n    if (diff < bestDiff) {\n      best = option;\n      bestDiff = diff;\n    }\n  }\n  return best;\n}\n\nexport async function getConcurrencyLimit() {\n  await ensureMigrated();\n  const raw = await rawGet(STORAGE_KEYS.CONCURRENCY_LIMIT);\n  return normalizeConcurrencyLimit(raw);\n}\n\nexport async function setConcurrencyLimit(value) {\n  const normalized = normalizeConcurrencyLimit(value);\n  await rawSet(STORAGE_KEYS.CONCURRENCY_LIMIT, String(normalized));\n  return normalized;\n}\n\nconst RPM_MIN = 0;\nconst RPM_MAX = 100000;\n\nfunction normalizeRpmLimit(value) {\n  const n = typeof value === \"string\" ? parseInt(value.trim(), 10) : Number(value);\n  return clampInt(n, RPM_MIN, RPM_MAX, DEFAULTS.rpmLimit);\n}\n\nexport async function getRpmLimit() {\n  await ensureMigrated();\n  const raw = await rawGet(STORAGE_KEYS.RPM_LIMIT);\n  return normalizeRpmLimit(raw);\n}\n\nexport async function setRpmLimit(value) {\n  const normalized = normalizeRpmLimit(value);\n  await rawSet(STORAGE_KEYS.RPM_LIMIT, String(normalized));\n  return normalized;\n}\n\nexport async function getOnboardingSeen() {\n  await ensureMigrated();\n  const raw = await rawGet(STORAGE_KEYS.ONBOARDING_SEEN);\n  return raw === \"1\";\n}\n\nexport async function setOnboardingSeen(seen = true) {\n  await rawSet(STORAGE_KEYS.ONBOARDING_SEEN, seen ? \"1\" : \"0\");\n  return seen;\n}\n\nexport async function getOnboardingKeysConfirmed() {\n  await ensureMigrated();\n  const raw = await rawGet(STORAGE_KEYS.ONBOARDING_KEYS_CONFIRMED);\n  return raw === \"1\";\n}\n\nexport async function setOnboardingKeysConfirmed(confirmed = true) {\n  await rawSet(STORAGE_KEYS.ONBOARDING_KEYS_CONFIRMED, confirmed ? \"1\" : \"0\");\n  return confirmed;\n}\n\nfunction normalizeRuntimeStatus(raw) {\n  const base = { active: 0, queued: 0, rpm: 0, ts: 0 };\n  if (!raw || typeof raw !== \"object\") return base;\n  const active = clampInt(raw.active, 0, 100000, 0);\n  const queued = clampInt(raw.queued, 0, 100000, 0);\n  const rpm = clampInt(raw.rpm, 0, 1000000, 0);\n  const ts = clampInt(raw.ts, 0, Number.MAX_SAFE_INTEGER, 0);\n  return { active, queued, rpm, ts };\n}\n\nexport async function getRuntimeStatus() {\n  const raw = await rawGet(STORAGE_KEYS.RUNTIME_STATUS);\n  if (!raw) return normalizeRuntimeStatus(null);\n  try {\n    return normalizeRuntimeStatus(JSON.parse(raw));\n  } catch {\n    return normalizeRuntimeStatus(null);\n  }\n}\n\nexport async function setRuntimeStatus(status) {\n  const normalized = normalizeRuntimeStatus(status);\n  await rawSet(STORAGE_KEYS.RUNTIME_STATUS, JSON.stringify(normalized));\n  return normalized;\n}\n\nconst PRIVACY_MODE_CACHE_TTL_MS = 2000;\n\nasync function loadPrivacyMode() {\n  const now = nowMs();\n  if (_privacyModeCache != null && now - _privacyModeCacheAt < PRIVACY_MODE_CACHE_TTL_MS) {\n    return _privacyModeCache;\n  }\n  const raw = await rawGet(STORAGE_KEYS.PRIVACY_MODE);\n  const enabled = raw === \"1\";\n  _privacyModeCache = enabled;\n  _privacyModeCacheAt = now;\n  return enabled;\n}\n\nexport async function getPrivacyMode() {\n  return await loadPrivacyMode();\n}\n\nexport async function setPrivacyMode(enabled = false) {\n  const next = !!enabled;\n  _privacyModeCache = next;\n  _privacyModeCacheAt = nowMs();\n  await rawSet(STORAGE_KEYS.PRIVACY_MODE, next ? \"1\" : \"0\");\n  return next;\n}\n\nfunction normalizeSectionList(value) {\n  if (!Array.isArray(value)) return [];\n  const out = [];\n  const seen = new Set();\n  for (const item of value) {\n    const key = String(item || \"\").trim();\n    if (!key || seen.has(key)) continue;\n    seen.add(key);\n    out.push(key);\n  }\n  return out;\n}\n\nexport async function getSectionOrder() {\n  await ensureMigrated();\n  const raw = await rawGet(STORAGE_KEYS.SECTION_ORDER);\n  if (!raw) return [];\n  try {\n    return normalizeSectionList(JSON.parse(raw));\n  } catch {\n    return [];\n  }\n}\n\nexport async function setSectionOrder(order) {\n  const normalized = normalizeSectionList(order);\n  await rawSet(STORAGE_KEYS.SECTION_ORDER, JSON.stringify(normalized));\n  return normalized;\n}\n\nexport async function getHiddenSections() {\n  await ensureMigrated();\n  const raw = await rawGet(STORAGE_KEYS.SECTION_HIDDEN);\n  if (!raw) return [];\n  try {\n    return normalizeSectionList(JSON.parse(raw));\n  } catch {\n    return [];\n  }\n}\n\nexport async function setHiddenSections(list) {\n  const normalized = normalizeSectionList(list);\n  await rawSet(STORAGE_KEYS.SECTION_HIDDEN, JSON.stringify(normalized));\n  return normalized;\n}\n\nexport async function getLicense() {\n  await ensureMigrated();\n  const raw = await rawGet(STORAGE_KEYS.LICENSE);\n  if (!raw) return null;\n  try {\n    return JSON.parse(raw);\n  } catch {\n    return null;\n  }\n}\n\nexport async function setLicense(license) {\n  if (!license) {\n    await rawRemove(STORAGE_KEYS.LICENSE);\n    return null;\n  }\n  await rawSet(STORAGE_KEYS.LICENSE, JSON.stringify(license));\n  return license;\n}\n\nexport async function clearLicense() {\n  await rawRemove(STORAGE_KEYS.LICENSE);\n}\n\n// ---------- Small utilities ----------\nexport function nowMs() {\n  return Date.now();\n}\n\nexport function sleep(ms) {\n  return new Promise((resolve) => setTimeout(resolve, ms));\n}\n\nexport function clamp(value, min, max, fallback = min) {\n  const n = Number(value);\n  if (!Number.isFinite(n)) return fallback;\n  return Math.max(min, Math.min(max, n));\n}\n\nexport function clampInt(value, min, max, fallback = min) {\n  const n = parseInt(String(value), 10);\n  if (!Number.isFinite(n)) return fallback;\n  return Math.max(min, Math.min(max, n));\n}\n\nconst REDACT_PATTERNS = [\n  /\\bsk-[A-Za-z0-9-_]{1,}\\b/gi,\n  /\\bAIza[0-9A-Za-z_-]{1,}\\b/gi,\n  /\\b[A-Z0-9]{4}(?:-[A-Z0-9]{4}){1,3}\\b/gi\n];\n\nexport function redactSensitiveText(value) {\n  if (value == null) return \"\";\n  let text = String(value);\n  for (const pattern of REDACT_PATTERNS) {\n    text = text.replace(pattern, \"[REDACTED]\");\n  }\n  return text;\n}\n\nexport function redactSensitiveValue(value) {\n  if (value == null) return value;\n  if (typeof value === \"string\") return redactSensitiveText(value);\n  if (Array.isArray(value)) return value.map(redactSensitiveValue);\n  if (typeof value === \"object\") {\n    const out = {};\n    for (const [key, entry] of Object.entries(value)) {\n      out[key] = redactSensitiveValue(entry);\n    }\n    return out;\n  }\n  return value;\n}\n\nfunction parseTimestampMs(raw) {\n  const n = parseInt(String(raw || \"\").trim(), 10);\n  return Number.isFinite(n) && n > 0 ? n : 0;\n}\n\n// ---------- LRU cache with TTL ----------\nexport class LRUCache {\n  constructor(maxEntries = 500) {\n    this.maxEntries = maxEntries;\n    this.map = new Map(); // key => {value, expiresAtMs}\n  }\n\n  get(key) {\n    if (!this.map.has(key)) return null;\n    const entry = this.map.get(key);\n\n    if (entry?.expiresAtMs && entry.expiresAtMs <= nowMs()) {\n      this.map.delete(key);\n      return null;\n    }\n\n    // Refresh key order (most recent)\n    this.map.delete(key);\n    this.map.set(key, entry);\n    return entry.value;\n  }\n\n  set(key, value, ttlMs) {\n    const expiresAtMs = typeof ttlMs === \"number\" && ttlMs > 0 ? nowMs() + ttlMs : null;\n    if (this.map.has(key)) this.map.delete(key);\n    this.map.set(key, { value, expiresAtMs });\n\n    // Evict LRU\n    while (this.map.size > this.maxEntries) {\n      const oldestKey = this.map.keys().next().value;\n      this.map.delete(oldestKey);\n    }\n  }\n\n  clear() {\n    this.map.clear();\n  }\n}\n\n// ---------- Persistent cache (survives reloads) ----------\nconst CACHE_ENTRY_PREFIX = \"AI_CACHE_ENTRY_V1:\";\nconst CACHE_INDEX_MAX_ENTRIES = 5000;\nconst CACHE_INDEX_MAX_BYTES = 5 * 1024 * 1024;\nconst GEMINI_CACHED_CONTENT_MAX_ENTRIES = 50;\nlet _cacheClearMs = 0;\nlet _geminiCachedContent = new Map();\nlet _geminiCachedContentLoaded = false;\nlet _geminiCachedContentLoading = null;\n\nfunction estimateSizeBytes(value) {\n  if (typeof value !== \"string\") return 0;\n  try {\n    if (typeof TextEncoder !== \"undefined\") {\n      return new TextEncoder().encode(value).length;\n    }\n  } catch {\n    // ignore and fallback\n  }\n  return value.length;\n}\n\nasync function syncCacheClearMarker() {\n  const clearedAt = parseTimestampMs(await rawGet(STORAGE_KEYS.CACHE_CLEAR_AT));\n  if (clearedAt > _cacheClearMs) _cacheClearMs = clearedAt;\n  return _cacheClearMs;\n}\n\nexport async function getCacheClearAt() {\n  return await syncCacheClearMarker();\n}\n\nasync function loadCacheIndex() {\n  const raw = await rawGet(STORAGE_KEYS.CACHE_INDEX);\n  if (!raw) return [];\n  try {\n    const arr = JSON.parse(raw);\n    return Array.isArray(arr) ? arr : [];\n  } catch {\n    return [];\n  }\n}\n\nasync function saveCacheIndex(entries) {\n  try {\n    await rawSet(STORAGE_KEYS.CACHE_INDEX, JSON.stringify(entries));\n  } catch {\n    // ignore\n  }\n}\n\nfunction pruneCacheIndex(entries, clearedAt = 0) {\n  const now = nowMs();\n  const kept = [];\n  const removedKeys = [];\n\n  for (const entry of entries || []) {\n    if (!entry || !entry.key) continue;\n    const savedAt = Number(entry.savedAtMs || 0);\n    if (clearedAt && (!Number.isFinite(savedAt) || savedAt <= clearedAt)) {\n      removedKeys.push(entry.key);\n      continue;\n    }\n    if (entry.expiresAtMs && entry.expiresAtMs <= now) {\n      removedKeys.push(entry.key);\n      continue;\n    }\n    kept.push(entry);\n  }\n\n  let totalSize = 0;\n  for (const entry of kept) totalSize += Number(entry?.size || 0);\n\n  if (kept.length > CACHE_INDEX_MAX_ENTRIES || totalSize > CACHE_INDEX_MAX_BYTES) {\n    kept.sort((a, b) => (a.savedAtMs || 0) - (b.savedAtMs || 0));\n    let dropCount = 0;\n    while (kept.length - dropCount > CACHE_INDEX_MAX_ENTRIES || totalSize > CACHE_INDEX_MAX_BYTES) {\n      const entry = kept[dropCount];\n      if (!entry) break;\n      removedKeys.push(entry.key);\n      totalSize -= Number(entry?.size || 0);\n      dropCount += 1;\n    }\n    return { list: kept.slice(dropCount), removedKeys };\n  }\n\n  return { list: kept, removedKeys };\n}\n\nasync function removeCacheEntry(key) {\n  if (!key) return;\n  await rawRemove(CACHE_ENTRY_PREFIX + key);\n}\n\nasync function removeFromCacheIndex(key) {\n  const index = await loadCacheIndex();\n  const next = (index || []).filter((item) => item?.key !== key);\n  if (next.length !== index.length) await saveCacheIndex(next);\n}\n\nexport async function getPersistentCache(cacheKey) {\n  if (!cacheKey) return null;\n  if (await getPrivacyMode()) return null;\n  const clearedAt = await syncCacheClearMarker();\n  const raw = await rawGet(CACHE_ENTRY_PREFIX + cacheKey);\n  if (!raw) {\n    await removeFromCacheIndex(cacheKey);\n    return null;\n  }\n\n  try {\n    const entry = JSON.parse(raw);\n    if (!entry || typeof entry !== \"object\") throw new Error(\"Invalid entry\");\n    const savedAt = Number(entry.savedAtMs || 0);\n    if (clearedAt && (!Number.isFinite(savedAt) || savedAt <= clearedAt)) {\n      await removeCacheEntry(cacheKey);\n      await removeFromCacheIndex(cacheKey);\n      return null;\n    }\n    if (entry.expiresAtMs && entry.expiresAtMs <= nowMs()) {\n      await removeCacheEntry(cacheKey);\n      await removeFromCacheIndex(cacheKey);\n      return null;\n    }\n    return entry.value || null;\n  } catch {\n    await removeCacheEntry(cacheKey);\n    await removeFromCacheIndex(cacheKey);\n    return null;\n  }\n}\n\nexport async function setPersistentCache(cacheKey, value, ttlMs, meta = {}) {\n  if (!cacheKey) return;\n  if (await getPrivacyMode()) return;\n  const now = nowMs();\n  const clearedAt = await syncCacheClearMarker();\n  const savedAtMs = clearedAt && now <= clearedAt ? clearedAt + 1 : now;\n  const expiresAtMs = typeof ttlMs === \"number\" && ttlMs > 0 ? savedAtMs + ttlMs : null;\n  const entry = {\n    v: 1,\n    savedAtMs,\n    expiresAtMs,\n    value\n  };\n\n  const raw = JSON.stringify(entry);\n  const size = estimateSizeBytes(raw);\n  if (size > CACHE_INDEX_MAX_BYTES) {\n    await removeCacheEntry(cacheKey);\n    await removeFromCacheIndex(cacheKey);\n    return;\n  }\n  await rawSet(CACHE_ENTRY_PREFIX + cacheKey, raw);\n\n  const index = await loadCacheIndex();\n  const provider = meta.provider || value?.provider || \"\";\n  const model = meta.model || value?.model || \"\";\n\n  let updated = false;\n  const next = (index || []).map((item) => {\n    if (item?.key !== cacheKey) return item;\n    updated = true;\n    return {\n      key: cacheKey,\n      provider,\n      model,\n      size,\n      savedAtMs,\n      expiresAtMs\n    };\n  });\n\n  if (!updated) {\n    next.push({\n      key: cacheKey,\n      provider,\n      model,\n      size,\n      savedAtMs,\n      expiresAtMs\n    });\n  }\n\n  const pruned = pruneCacheIndex(next, clearedAt);\n  for (const key of pruned.removedKeys) await removeCacheEntry(key);\n  await saveCacheIndex(pruned.list);\n}\n\nexport async function clearPersistentCache() {\n  const clearedAt = nowMs();\n  _cacheClearMs = clearedAt;\n  await rawSet(STORAGE_KEYS.CACHE_CLEAR_AT, String(clearedAt));\n  const index = await loadCacheIndex();\n  for (const item of index || []) {\n    if (!item?.key) continue;\n    await removeCacheEntry(item.key);\n  }\n  await rawRemove(STORAGE_KEYS.CACHE_INDEX);\n}\n\nexport async function getPersistentCacheStats() {\n  if (await getPrivacyMode()) {\n    return {\n      entries: 0,\n      sizeBytes: 0,\n      providers: {\n        gemini: { entries: 0, sizeBytes: 0 },\n        openai: { entries: 0, sizeBytes: 0 }\n      },\n      oldestMs: null,\n      newestMs: null\n    };\n  }\n  const index = await loadCacheIndex();\n  const clearedAt = await syncCacheClearMarker();\n  const pruned = pruneCacheIndex(index, clearedAt);\n  if (pruned.removedKeys.length) {\n    for (const key of pruned.removedKeys) await removeCacheEntry(key);\n    await saveCacheIndex(pruned.list);\n  }\n\n  const stats = {\n    entries: 0,\n    sizeBytes: 0,\n    providers: {\n      gemini: { entries: 0, sizeBytes: 0 },\n      openai: { entries: 0, sizeBytes: 0 }\n    },\n    oldestMs: null,\n    newestMs: null\n  };\n\n  for (const item of pruned.list || []) {\n    if (!item?.key) continue;\n    stats.entries += 1;\n    stats.sizeBytes += Number(item.size || 0);\n    const provider = String(item.provider || \"\").toLowerCase();\n    if (provider === PROVIDERS.GEMINI) {\n      stats.providers.gemini.entries += 1;\n      stats.providers.gemini.sizeBytes += Number(item.size || 0);\n    } else if (provider === PROVIDERS.OPENAI) {\n      stats.providers.openai.entries += 1;\n      stats.providers.openai.sizeBytes += Number(item.size || 0);\n    }\n\n    const savedAt = Number(item.savedAtMs || 0);\n    if (savedAt) {\n      stats.oldestMs = stats.oldestMs == null ? savedAt : Math.min(stats.oldestMs, savedAt);\n      stats.newestMs = stats.newestMs == null ? savedAt : Math.max(stats.newestMs, savedAt);\n    }\n  }\n\n  return stats;\n}\n\n// ---------- Gemini cached content (explicit prompt cache) ----------\nfunction normalizeGeminiCachedEntry(entry) {\n  if (!entry || typeof entry !== \"object\") return null;\n  const key = String(entry.key || \"\").trim();\n  const name = String(entry.name || \"\").trim();\n  if (!key || !name) return null;\n  const savedAtMs = Number(entry.savedAtMs || 0);\n  const expiresAtMs = Number(entry.expiresAtMs || 0);\n  return { key, name, savedAtMs, expiresAtMs };\n}\n\nasync function loadGeminiCachedContent(force = false) {\n  if (_geminiCachedContentLoading) return _geminiCachedContentLoading;\n\n  _geminiCachedContentLoading = (async () => {\n    if (!force && _geminiCachedContentLoaded) return _geminiCachedContent;\n    _geminiCachedContent = new Map();\n    _geminiCachedContentLoaded = true;\n\n    if (await getPrivacyMode()) return _geminiCachedContent;\n\n    const raw = await rawGet(STORAGE_KEYS.GEMINI_CACHED_CONTENT);\n    if (!raw) return _geminiCachedContent;\n    let arr = [];\n    try {\n      const parsed = JSON.parse(raw);\n      if (Array.isArray(parsed)) arr = parsed;\n    } catch {\n      arr = [];\n    }\n\n    const now = nowMs();\n    for (const item of arr) {\n      const entry = normalizeGeminiCachedEntry(item);\n      if (!entry) continue;\n      if (entry.expiresAtMs && entry.expiresAtMs <= now) continue;\n      _geminiCachedContent.set(entry.key, entry);\n    }\n    return _geminiCachedContent;\n  })();\n\n  try {\n    return await _geminiCachedContentLoading;\n  } finally {\n    _geminiCachedContentLoading = null;\n  }\n}\n\nfunction pruneGeminiCachedContent() {\n  const before = _geminiCachedContent.size;\n  const now = nowMs();\n  let entries = Array.from(_geminiCachedContent.values()).filter(\n    (entry) => !entry.expiresAtMs || entry.expiresAtMs > now\n  );\n  entries.sort((a, b) => (b.savedAtMs || 0) - (a.savedAtMs || 0));\n  if (entries.length > GEMINI_CACHED_CONTENT_MAX_ENTRIES) {\n    entries = entries.slice(0, GEMINI_CACHED_CONTENT_MAX_ENTRIES);\n  }\n  _geminiCachedContent = new Map(entries.map((entry) => [entry.key, entry]));\n  const removed = before !== entries.length;\n  return { list: entries, removed };\n}\n\nasync function persistGeminiCachedContent(list) {\n  try {\n    if (await getPrivacyMode()) return;\n    await rawSet(STORAGE_KEYS.GEMINI_CACHED_CONTENT, JSON.stringify(list));\n  } catch {\n    // ignore\n  }\n}\n\nexport async function getGeminiCachedContentEntry(cacheKey) {\n  if (!cacheKey) return null;\n  await loadGeminiCachedContent();\n  const entry = _geminiCachedContent.get(cacheKey);\n  const pruned = pruneGeminiCachedContent();\n  if (entry && !_geminiCachedContent.has(cacheKey)) {\n    await persistGeminiCachedContent(pruned.list);\n    return null;\n  }\n  if (pruned.removed) {\n    await persistGeminiCachedContent(pruned.list);\n  }\n  return entry || null;\n}\n\nexport async function setGeminiCachedContentEntry(cacheKey, data) {\n  if (!cacheKey || !data || typeof data !== \"object\") return;\n  await loadGeminiCachedContent();\n  const entry = normalizeGeminiCachedEntry({ key: cacheKey, ...data, savedAtMs: data.savedAtMs || nowMs() });\n  if (!entry) return;\n  _geminiCachedContent.set(cacheKey, entry);\n  const pruned = pruneGeminiCachedContent();\n  await persistGeminiCachedContent(pruned.list);\n}\n\nexport async function removeGeminiCachedContentEntry(cacheKey) {\n  if (!cacheKey) return;\n  await loadGeminiCachedContent();\n  if (_geminiCachedContent.delete(cacheKey)) {\n    const pruned = pruneGeminiCachedContent();\n    await persistGeminiCachedContent(pruned.list);\n  }\n}\n\nexport async function clearGeminiCachedContent() {\n  _geminiCachedContent = new Map();\n  _geminiCachedContentLoaded = true;\n  _geminiCachedContentLoading = null;\n  await rawRemove(STORAGE_KEYS.GEMINI_CACHED_CONTENT);\n}\n\n// ---------- Stable stringify + hashing (for cache keys) ----------\nfunction isPlainObject(v) {\n  return Object.prototype.toString.call(v) === \"[object Object]\";\n}\n\nexport function stableStringify(value) {\n  return JSON.stringify(sortKeysDeep(value));\n}\n\nfunction sortKeysDeep(value) {\n  if (Array.isArray(value)) return value.map(sortKeysDeep);\n  if (isPlainObject(value)) {\n    const out = {};\n    for (const k of Object.keys(value).sort()) out[k] = sortKeysDeep(value[k]);\n    return out;\n  }\n  return value;\n}\n\nfunction fnv1a32(str) {\n  let h = 2166136261;\n  for (let i = 0; i < str.length; i++) {\n    h ^= str.charCodeAt(i);\n    h = Math.imul(h, 16777619);\n  }\n  // Unsigned\n  return (h >>> 0).toString(16).padStart(8, \"0\");\n}\n\nexport async function hashKey(input) {\n  const text = typeof input === \"string\" ? input : stableStringify(input);\n\n  // Prefer SHA-256 when available (browser/Office runtime)\n  try {\n    if (typeof crypto !== \"undefined\" && crypto?.subtle?.digest && typeof TextEncoder !== \"undefined\") {\n      const enc = new TextEncoder();\n      const bytes = enc.encode(text);\n      const digest = await crypto.subtle.digest(\"SHA-256\", bytes);\n      const arr = Array.from(new Uint8Array(digest));\n      return arr.map((b) => b.toString(16).padStart(2, \"0\")).join(\"\");\n    }\n  } catch {\n    // ignore and fallback\n  }\n\n  return `fnv1a:${fnv1a32(text)}`;\n}\n\n// ---------- Lightweight diagnostics log (persisted) ----------\nconst REQUEST_LOG_MAX_PER_TYPE = 50;\nconst REQUEST_LOG_MAX_TOTAL = REQUEST_LOG_MAX_PER_TYPE * 2;\nconst REQUEST_LOG_TTL_MS = Infinity; // Kept until manual reset (capped by count)\nconst LOG_FLUSH_INTERVAL_MS = 500;\nconst LOG_FLUSH_MAX_BUFFER = 80;\nlet _requestLog = [];\nlet _requestLogLoading = null;\nlet _requestLogLoaded = false;\nlet _requestLogLastLoadedMs = 0;\nlet _requestLogClearMs = 0;\nlet _logBuffer = [];\nlet _logFlushTimer = null;\nlet _logFlushPromise = null;\nconst USAGE_TOTALS_CACHE_TTL_MS = 1500;\nconst BATCH_APPLIED_MAX = 80;\nconst BATCH_APPLIED_TTL_MS = 24 * 60 * 60 * 1000;\nlet _usageTotals = createEmptyUsageTotals();\nlet _usageTotalsLoading = null;\nlet _usageTotalsLoaded = false;\nlet _usageTotalsLastLoadedMs = 0;\nlet _usageTotalsDirty = false;\n\nasync function syncRequestLogClearMarker(options = {}) {\n  const clearedAt = parseTimestampMs(await rawGet(STORAGE_KEYS.REQUEST_LOG_CLEAR_AT));\n  if (clearedAt > _requestLogClearMs) {\n    _requestLogClearMs = clearedAt;\n    _requestLog = [];\n    if (options.reset) {\n      _requestLogLoaded = true;\n      _requestLogLoading = null;\n      _requestLogLastLoadedMs = nowMs();\n    } else {\n      _requestLogLoaded = false;\n    }\n  }\n  return _requestLogClearMs;\n}\n\nfunction coerceRequestLogArray(value) {\n  if (Array.isArray(value)) return value;\n  if (value && typeof value === \"object\") {\n    const normal = Array.isArray(value.normal) ? value.normal : [];\n    const errors = Array.isArray(value.errors) ? value.errors : [];\n    return normal.concat(errors);\n  }\n  return [];\n}\n\nfunction isErrorLogEntry(entry) {\n  return !!entry && entry.ok === false;\n}\n\nasync function loadRequestLog(force = false) {\n  if (_requestLogLoading) return _requestLogLoading;\n\n  _requestLogLoading = (async () => {\n    const privacyMode = await getPrivacyMode();\n    if (privacyMode) {\n      if (force || !_requestLogLoaded) {\n        _requestLogLoaded = true;\n        _requestLogLastLoadedMs = nowMs();\n      }\n      return _requestLog;\n    }\n    const clearedAt = await syncRequestLogClearMarker();\n    if (!force && _requestLogLoaded) return _requestLog;\n    const raw = await rawGet(STORAGE_KEYS.REQUEST_LOG);\n    let arr = [];\n    if (raw) {\n      try {\n        const parsed = JSON.parse(raw);\n        arr = coerceRequestLogArray(parsed);\n      } catch {\n        arr = [];\n      }\n    }\n    const now = nowMs();\n    arr = arr\n      .map((e) => {\n        if (!e) return null;\n        let ts = e.ts;\n        if (typeof ts === \"string\") {\n          const parsed = Date.parse(ts);\n          if (Number.isFinite(parsed)) ts = parsed;\n        }\n        if (typeof ts !== \"number\") return null;\n        return { ...e, ts };\n      })\n      .filter((e) => e && typeof e.ts === \"number\" && e.ts > clearedAt && now - e.ts <= REQUEST_LOG_TTL_MS)\n      .map((e) => sanitizeLogEntry(e));\n    _requestLog = arr;\n    pruneRequestLog();\n    _requestLogLoaded = true;\n    _requestLogLastLoadedMs = nowMs();\n    return _requestLog;\n  })();\n\n  try {\n    return await _requestLogLoading;\n  } finally {\n    _requestLogLoading = null;\n  }\n}\n\nasync function persistRequestLog() {\n  try {\n    if (await getPrivacyMode()) return;\n    pruneRequestLog();\n    await rawSet(STORAGE_KEYS.REQUEST_LOG, JSON.stringify(_requestLog.slice(-REQUEST_LOG_MAX_TOTAL)));\n  } catch {\n    // ignore\n  }\n}\n\nfunction pruneRequestLog() {\n  const now = nowMs();\n  const clearedAt = _requestLogClearMs || 0;\n  const valid = (_requestLog || []).filter(\n    (e) => e && typeof e.ts === \"number\" && e.ts > clearedAt && now - e.ts <= REQUEST_LOG_TTL_MS\n  );\n  const normals = [];\n  const errors = [];\n  for (const entry of valid) {\n    if (isErrorLogEntry(entry)) errors.push(entry);\n    else normals.push(entry);\n  }\n  normals.sort((a, b) => a.ts - b.ts);\n  errors.sort((a, b) => a.ts - b.ts);\n  const pruned = normals.slice(-REQUEST_LOG_MAX_PER_TYPE).concat(errors.slice(-REQUEST_LOG_MAX_PER_TYPE));\n  pruned.sort((a, b) => a.ts - b.ts);\n  _requestLog = pruned;\n}\n\n// ---------- Persistent usage totals ----------\nfunction toNonNegInt(value) {\n  const n = Number(value);\n  if (!Number.isFinite(n) || n <= 0) return 0;\n  return Math.floor(n);\n}\n\nfunction createEmptyUsageTotals() {\n  return {\n    inputTokens: 0,\n    outputTokens: 0,\n    reasoningTokens: 0,\n    cachedInputTokens: 0,\n    requests: 0,\n    batchApplied: {},\n    byProvider: {\n      [PROVIDERS.GEMINI]: {\n        inputTokens: 0,\n        outputTokens: 0,\n        reasoningTokens: 0,\n        cachedInputTokens: 0,\n        requests: 0,\n        models: {}\n      },\n      [PROVIDERS.OPENAI]: {\n        inputTokens: 0,\n        outputTokens: 0,\n        reasoningTokens: 0,\n        cachedInputTokens: 0,\n        requests: 0,\n        models: {}\n      }\n    }\n  };\n}\n\nfunction normalizeUsageTotals(raw) {\n  const base = createEmptyUsageTotals();\n  if (!raw || typeof raw !== \"object\") return base;\n\n  base.inputTokens = toNonNegInt(raw.inputTokens);\n  base.outputTokens = toNonNegInt(raw.outputTokens);\n  base.reasoningTokens = toNonNegInt(raw.reasoningTokens);\n  base.cachedInputTokens = toNonNegInt(raw.cachedInputTokens);\n  base.requests = toNonNegInt(raw.requests);\n  base.batchApplied = normalizeBatchApplied(raw.batchApplied);\n\n  const providers = raw.byProvider && typeof raw.byProvider === \"object\" ? raw.byProvider : {};\n  for (const provider of [PROVIDERS.GEMINI, PROVIDERS.OPENAI]) {\n    const rawProvider = providers[provider];\n    if (!rawProvider || typeof rawProvider !== \"object\") continue;\n    const target = base.byProvider[provider];\n    target.inputTokens = toNonNegInt(rawProvider.inputTokens);\n    target.outputTokens = toNonNegInt(rawProvider.outputTokens);\n    target.reasoningTokens = toNonNegInt(rawProvider.reasoningTokens);\n    target.cachedInputTokens = toNonNegInt(rawProvider.cachedInputTokens);\n    target.requests = toNonNegInt(rawProvider.requests);\n\n    const rawModels = rawProvider.models && typeof rawProvider.models === \"object\" ? rawProvider.models : {};\n    for (const [key, value] of Object.entries(rawModels)) {\n      if (!value || typeof value !== \"object\") continue;\n      const label = typeof value.label === \"string\" ? value.label : String(key || \"\");\n      const modelKey = String(key || label || \"\").toLowerCase();\n      if (!modelKey) continue;\n      target.models[modelKey] = {\n        label,\n        inputTokens: toNonNegInt(value.inputTokens),\n        outputTokens: toNonNegInt(value.outputTokens),\n        reasoningTokens: toNonNegInt(value.reasoningTokens),\n        cachedInputTokens: toNonNegInt(value.cachedInputTokens),\n        requests: toNonNegInt(value.requests)\n      };\n    }\n  }\n\n  return base;\n}\n\nfunction normalizeBatchApplied(raw) {\n  if (!raw || typeof raw !== \"object\") return {};\n  const out = {};\n  for (const [batchId, value] of Object.entries(raw)) {\n    if (!value || typeof value !== \"object\") continue;\n    const models = value.models && typeof value.models === \"object\" ? value.models : {};\n    const normalizedModels = {};\n    for (const [key, model] of Object.entries(models)) {\n      if (!model || typeof model !== \"object\") continue;\n      const provider = String(model.provider || \"\").toLowerCase();\n      if (provider !== PROVIDERS.GEMINI && provider !== PROVIDERS.OPENAI) continue;\n      const modelKey = String(model.modelKey || model.model || key || \"\").toLowerCase();\n      if (!modelKey) continue;\n      normalizedModels[key] = {\n        provider,\n        modelKey,\n        label: typeof model.label === \"string\" ? model.label : \"\",\n        inputTokens: toNonNegInt(model.inputTokens),\n        outputTokens: toNonNegInt(model.outputTokens),\n        reasoningTokens: toNonNegInt(model.reasoningTokens),\n        cachedInputTokens: toNonNegInt(model.cachedInputTokens),\n        requests: toNonNegInt(model.requests)\n      };\n    }\n    out[batchId] = {\n      ts: Number(value.ts) || 0,\n      models: normalizedModels\n    };\n  }\n  return pruneBatchApplied(out);\n}\n\nfunction pruneBatchApplied(map) {\n  if (!map || typeof map !== \"object\") return {};\n  const now = nowMs();\n  const entries = Object.entries(map)\n    .filter(([, value]) => value && typeof value === \"object\")\n    .filter(([, value]) => {\n      const ts = Number(value.ts) || 0;\n      return !ts || now - ts <= BATCH_APPLIED_TTL_MS;\n    })\n    .sort((a, b) => (Number(a[1].ts) || 0) - (Number(b[1].ts) || 0));\n  const trimmed = entries.slice(-BATCH_APPLIED_MAX);\n  const out = {};\n  for (const [key, value] of trimmed) {\n    out[key] = value;\n  }\n  return out;\n}\n\nfunction cloneUsageTotals(value) {\n  try {\n    return JSON.parse(JSON.stringify(value || createEmptyUsageTotals()));\n  } catch {\n    return createEmptyUsageTotals();\n  }\n}\n\nasync function loadUsageTotals(force = false) {\n  if (_usageTotalsLoading) return _usageTotalsLoading;\n\n  _usageTotalsLoading = (async () => {\n    const privacyMode = await getPrivacyMode();\n    if (privacyMode) {\n      if (force || !_usageTotalsLoaded) {\n        _usageTotalsLoaded = true;\n        _usageTotalsLastLoadedMs = nowMs();\n      }\n      return _usageTotals;\n    }\n\n    if (!force && _usageTotalsLoaded) return _usageTotals;\n\n    const raw = await rawGet(STORAGE_KEYS.USAGE_TOTALS);\n    let parsed = null;\n    if (raw) {\n      try {\n        parsed = JSON.parse(raw);\n      } catch {\n        parsed = null;\n      }\n    }\n\n    _usageTotals = normalizeUsageTotals(parsed);\n    _usageTotalsLoaded = true;\n    _usageTotalsLastLoadedMs = nowMs();\n    return _usageTotals;\n  })();\n\n  try {\n    return await _usageTotalsLoading;\n  } finally {\n    _usageTotalsLoading = null;\n  }\n}\n\nasync function persistUsageTotals() {\n  try {\n    if (await getPrivacyMode()) return;\n    await rawSet(STORAGE_KEYS.USAGE_TOTALS, JSON.stringify(_usageTotals));\n  } catch {\n    // ignore\n  }\n}\n\nfunction applyUsageTotalsFromEntry(entry) {\n  if (!entry || typeof entry !== \"object\") return false;\n\n  if (entry.batch && Array.isArray(entry.batchModels)) {\n    const batchId = entry.batchId ? String(entry.batchId) : \"\";\n    const now = nowMs();\n    const currentModels = {};\n    for (const item of entry.batchModels) {\n      if (!item || typeof item !== \"object\") continue;\n      const provider = String(item.provider || \"\").toLowerCase();\n      if (provider !== PROVIDERS.GEMINI && provider !== PROVIDERS.OPENAI) continue;\n      const modelLabel = String(item.model || \"\").trim();\n      const modelKey = (modelLabel || \"unknown\").toLowerCase();\n      const mapKey = `${provider}|${modelKey}`;\n      const existing = currentModels[mapKey] || {\n        provider,\n        modelKey,\n        label: modelLabel,\n        inputTokens: 0,\n        outputTokens: 0,\n        reasoningTokens: 0,\n        cachedInputTokens: 0,\n        requests: 0\n      };\n      existing.inputTokens += toNonNegInt(item.inputTokens);\n      existing.outputTokens += toNonNegInt(item.outputTokens);\n      existing.reasoningTokens += toNonNegInt(item.reasoningTokens);\n      existing.cachedInputTokens += toNonNegInt(item.cachedInputTokens);\n      existing.requests += toNonNegInt(item.requests);\n      if (!existing.label && modelLabel) existing.label = modelLabel;\n      currentModels[mapKey] = existing;\n    }\n\n    if (!batchId) {\n      let touched = false;\n      for (const model of Object.values(currentModels)) {\n        if (applyUsageDelta(model.provider, model.modelKey, model.label, model)) touched = true;\n      }\n      return touched;\n    }\n\n    const batchApplied = _usageTotals.batchApplied || {};\n    const previous = batchApplied[batchId]?.models || {};\n    const keys = new Set([...Object.keys(previous), ...Object.keys(currentModels)]);\n    let touched = false;\n    for (const key of keys) {\n      const curr = currentModels[key] || null;\n      const prev = previous[key] || null;\n      if (!curr && !prev) continue;\n      const provider = (curr?.provider || prev?.provider || \"\").toLowerCase();\n      const modelKey = (curr?.modelKey || prev?.modelKey || \"\").toLowerCase();\n      if (provider !== PROVIDERS.GEMINI && provider !== PROVIDERS.OPENAI) continue;\n      if (!modelKey) continue;\n      const delta = {\n        inputTokens: (curr?.inputTokens || 0) - (prev?.inputTokens || 0),\n        outputTokens: (curr?.outputTokens || 0) - (prev?.outputTokens || 0),\n        reasoningTokens: (curr?.reasoningTokens || 0) - (prev?.reasoningTokens || 0),\n        cachedInputTokens: (curr?.cachedInputTokens || 0) - (prev?.cachedInputTokens || 0),\n        requests: (curr?.requests || 0) - (prev?.requests || 0),\n        label: curr?.label || prev?.label || \"\"\n      };\n      if (!hasUsageDelta(delta)) continue;\n      if (applyUsageDelta(provider, modelKey, delta.label, delta)) touched = true;\n    }\n\n    batchApplied[batchId] = { ts: Number(entry.ts) || now, models: currentModels };\n    _usageTotals.batchApplied = pruneBatchApplied(batchApplied);\n    return touched;\n  }\n\n  const inputTokens = toNonNegInt(entry.inputTokens);\n  const outputTokens = toNonNegInt(entry.outputTokens);\n  const reasoningTokens = toNonNegInt(entry.reasoningTokens);\n  const cachedInputTokens = toNonNegInt(entry.cachedInputTokens);\n  const hasUsage = inputTokens + outputTokens + reasoningTokens + cachedInputTokens > 0;\n  if (!hasUsage) return false;\n\n  const provider = String(entry.provider || \"\").toLowerCase();\n  if (provider !== PROVIDERS.GEMINI && provider !== PROVIDERS.OPENAI) return false;\n\n  const modelLabel = String(entry.model || \"\").trim();\n  const modelKey = (modelLabel || \"unknown\").toLowerCase();\n\n  return applyUsageDelta(provider, modelKey, modelLabel, {\n    inputTokens,\n    outputTokens,\n    reasoningTokens,\n    cachedInputTokens,\n    requests: 1\n  });\n}\n\nfunction hasUsageDelta(delta) {\n  return (\n    Number(delta?.inputTokens || 0) !== 0 ||\n    Number(delta?.outputTokens || 0) !== 0 ||\n    Number(delta?.reasoningTokens || 0) !== 0 ||\n    Number(delta?.cachedInputTokens || 0) !== 0 ||\n    Number(delta?.requests || 0) !== 0\n  );\n}\n\nfunction applyUsageDelta(provider, modelKey, modelLabel, delta) {\n  if (!delta) return false;\n  const inputTokens = Number(delta.inputTokens || 0);\n  const outputTokens = Number(delta.outputTokens || 0);\n  const reasoningTokens = Number(delta.reasoningTokens || 0);\n  const cachedInputTokens = Number(delta.cachedInputTokens || 0);\n  const requests = Number(delta.requests || 0);\n  const hasUsage = inputTokens || outputTokens || reasoningTokens || cachedInputTokens || requests;\n  if (!hasUsage) return false;\n\n  _usageTotals.inputTokens = Math.max(0, _usageTotals.inputTokens + inputTokens);\n  _usageTotals.outputTokens = Math.max(0, _usageTotals.outputTokens + outputTokens);\n  _usageTotals.reasoningTokens = Math.max(0, _usageTotals.reasoningTokens + reasoningTokens);\n  _usageTotals.cachedInputTokens = Math.max(0, _usageTotals.cachedInputTokens + cachedInputTokens);\n  _usageTotals.requests = Math.max(0, _usageTotals.requests + requests);\n\n  const providerTotals = _usageTotals.byProvider[provider];\n  providerTotals.inputTokens = Math.max(0, providerTotals.inputTokens + inputTokens);\n  providerTotals.outputTokens = Math.max(0, providerTotals.outputTokens + outputTokens);\n  providerTotals.reasoningTokens = Math.max(0, providerTotals.reasoningTokens + reasoningTokens);\n  providerTotals.cachedInputTokens = Math.max(0, providerTotals.cachedInputTokens + cachedInputTokens);\n  providerTotals.requests = Math.max(0, providerTotals.requests + requests);\n\n  const models = providerTotals.models || {};\n  const existing = models[modelKey] || {\n    label: modelLabel,\n    inputTokens: 0,\n    outputTokens: 0,\n    reasoningTokens: 0,\n    cachedInputTokens: 0,\n    requests: 0\n  };\n  if (!existing.label && modelLabel) existing.label = modelLabel;\n  existing.inputTokens = Math.max(0, existing.inputTokens + inputTokens);\n  existing.outputTokens = Math.max(0, existing.outputTokens + outputTokens);\n  existing.reasoningTokens = Math.max(0, existing.reasoningTokens + reasoningTokens);\n  existing.cachedInputTokens = Math.max(0, existing.cachedInputTokens + cachedInputTokens);\n  existing.requests = Math.max(0, existing.requests + requests);\n  models[modelKey] = existing;\n  providerTotals.models = models;\n  return true;\n}\n\nexport async function getUsageTotals(options = {}) {\n  if (_logBuffer.length) {\n    await flushLogBuffer();\n  }\n  const force = !!options?.fresh;\n  const now = nowMs();\n  if (force || !_usageTotalsLoaded || now - _usageTotalsLastLoadedMs > USAGE_TOTALS_CACHE_TTL_MS) {\n    await loadUsageTotals(true);\n  } else {\n    await loadUsageTotals(false);\n  }\n  return cloneUsageTotals(_usageTotals);\n}\n\nexport async function clearUsageTotals() {\n  _usageTotals = createEmptyUsageTotals();\n  _usageTotalsLoaded = true;\n  _usageTotalsLoading = null;\n  _usageTotalsLastLoadedMs = nowMs();\n  _usageTotalsDirty = false;\n  await rawRemove(STORAGE_KEYS.USAGE_TOTALS);\n}\n\nexport function logRequest(entry) {\n  if (!entry || typeof entry !== \"object\") return;\n  const logEntry = sanitizeLogEntry({ ts: nowMs(), ...entry });\n  if (logEntry.batch && logEntry.batchId) {\n    let replaced = false;\n    for (let i = _logBuffer.length - 1; i >= 0; i -= 1) {\n      const existing = _logBuffer[i];\n      if (existing && existing.batch && existing.batchId === logEntry.batchId) {\n        _logBuffer[i] = logEntry;\n        replaced = true;\n        break;\n      }\n    }\n    if (!replaced) _logBuffer.push(logEntry);\n  } else {\n    _logBuffer.push(logEntry);\n  }\n\n  if (_logBuffer.length >= LOG_FLUSH_MAX_BUFFER) {\n    void flushLogBuffer();\n    return;\n  }\n\n  if (_logFlushTimer) return;\n  _logFlushTimer = setTimeout(() => {\n    _logFlushTimer = null;\n    void flushLogBuffer();\n  }, LOG_FLUSH_INTERVAL_MS);\n}\nasync function flushLogBuffer() {\n  if (_logFlushPromise) return _logFlushPromise;\n  if (!_logBuffer.length) return;\n\n  _logFlushPromise = (async () => {\n    try {\n      const entries = _logBuffer;\n      _logBuffer = [];\n\n      if (!entries.length) return;\n\n      await loadUsageTotals();\n      let usageTouched = false;\n      for (const entry of entries) {\n        if (applyUsageTotalsFromEntry(entry)) usageTouched = true;\n      }\n      if (usageTouched) {\n        _usageTotalsLastLoadedMs = nowMs();\n        _usageTotalsDirty = true;\n      }\n\n      const privacyMode = await getPrivacyMode();\n      if (privacyMode) {\n        _requestLog.push(...entries);\n        pruneRequestLog();\n        _requestLogLoaded = true;\n        _requestLogLastLoadedMs = nowMs();\n        return;\n      }\n\n      await syncRequestLogClearMarker({ reset: true });\n      if (!_requestLogLoaded) {\n        await loadRequestLog();\n      }\n      for (const entry of entries) {\n        if (entry?.batch && entry?.batchId) {\n          const idx = _requestLog.findIndex((e) => e?.batch && e?.batchId === entry.batchId);\n          if (idx >= 0) _requestLog[idx] = entry;\n          else _requestLog.push(entry);\n        } else {\n          _requestLog.push(entry);\n        }\n      }\n      pruneRequestLog();\n      _requestLogLastLoadedMs = nowMs();\n      await persistRequestLog();\n\n      if (_usageTotalsDirty) {\n        await persistUsageTotals();\n        _usageTotalsDirty = false;\n      }\n    } catch {\n      // ignore\n    }\n  })();\n\n  try {\n    await _logFlushPromise;\n  } finally {\n    _logFlushPromise = null;\n  }\n}\n\nfunction sanitizeLogEntry(entry) {\n  if (!entry || typeof entry !== \"object\") return entry;\n  return redactSensitiveValue(entry);\n}\n\nexport async function getRequestLog(options = {}) {\n  if (_logBuffer.length) {\n    await flushLogBuffer();\n  }\n  const force = !!options?.fresh;\n  const now = nowMs();\n  if (force || !_requestLogLoaded || now - _requestLogLastLoadedMs > 1500) {\n    await loadRequestLog(true);\n  } else {\n    await loadRequestLog(false);\n  }\n  return _requestLog.slice();\n}\n\nexport async function clearRequestLog() {\n  const clearedAt = nowMs();\n  _logBuffer = [];\n  if (_logFlushTimer) {\n    clearTimeout(_logFlushTimer);\n    _logFlushTimer = null;\n  }\n  _requestLog = [];\n  _requestLogLoaded = true;\n  _requestLogLoading = null;\n  _requestLogClearMs = clearedAt;\n  _requestLogLastLoadedMs = clearedAt;\n  await rawSet(STORAGE_KEYS.REQUEST_LOG_CLEAR_AT, String(clearedAt));\n  await rawRemove(STORAGE_KEYS.REQUEST_LOG);\n}\n","// src/shared/providers.js\n// Provider implementations (Gemini + OpenAI) and shared request orchestration.\n//\n// Requirements implemented:\n// - Gemini 3 Flash (via Google Generative Language API)\n// - OpenAI GPT-5 Mini (via OpenAI Responses API)\n// - No temperature / sampling parameters are ever sent\n// - Provider selection happens via taskpane default provider (formulas cannot override)\n// - AI.WEB uses provider-native web search mechanisms:\n//   - Gemini: google_search tool\n//   - OpenAI: web_search tool\n\nimport {\n  PROVIDERS,\n  DEFAULTS,\n  normalizeProvider,\n  getDefaultProvider,\n  getApiKey,\n  getModel,\n  getGeminiReasoningEffort,\n  getOpenAIReasoningEffort,\n  getMaxOutputTokens,\n  getConcurrencyLimit,\n  getRpmLimit,\n  clampInt,\n  nowMs,\n  sleep,\n  LRUCache,\n  hashKey,\n  logRequest,\n  setRuntimeStatus,\n  getCacheClearAt,\n  getPersistentCache,\n  setPersistentCache,\n  clearPersistentCache,\n  getGeminiCachedContentEntry,\n  setGeminiCachedContentEntry,\n  removeGeminiCachedContentEntry,\n  clearGeminiCachedContent,\n  redactSensitiveText\n} from \"./core.js\";\n\n// ---- In-memory cache (per runtime) ----\nconst CACHE = new LRUCache(800);\nlet _cacheClearLocalMs = 0;\n\nasync function syncCacheClearMarker() {\n  const clearedAt = await getCacheClearAt();\n  if (clearedAt > _cacheClearLocalMs) {\n    _cacheClearLocalMs = clearedAt;\n    CACHE.clear();\n  }\n}\n\n// Deduplicate in-flight identical requests to avoid bursts (per runtime)\nconst INFLIGHT = new Map(); // key => Promise<AIResult>\n\nconst GEMINI_503_RETRY_DELAY_MS = 10000;\nconst GEMINI_503_MAX_RETRIES = 2;\nconst GEMINI_CACHED_CONTENT_TTL_MS = 2 * 60 * 60 * 1000;\nconst GEMINI_CACHED_CONTENT_MIN_PREFIX_CHARS = 600;\nconst GEMINI_CACHED_CONTENT_MIN_SUFFIX_CHARS = 2;\nconst GEMINI_CACHED_INFLIGHT = new Map(); // cacheKey => Promise<{name, cacheKey} | null>\n\n// Concurrency limiter (per runtime)\nconst QUEUE_CANCELLED = Symbol(\"queue_cancelled\");\nconst QUEUE_CANCELLED_RESULT = { ok: false, code: \"QUEUE_CANCELLED\", message: \"File d'attente arrte.\" };\nconst CONCURRENCY_CACHE_TTL_MS = 1500;\nlet concurrencyLimitCached = DEFAULTS.concurrencyLimit;\nlet concurrencyLimitCachedAt = 0;\n\n// RPM limiter (per runtime, global across providers)\nconst RPM_WINDOW_MS = 60000;\nconst RPM_CACHE_TTL_MS = 1500;\nlet rpmLimitCached = DEFAULTS.rpmLimit;\nlet rpmLimitCachedAt = 0;\nlet rpmWindow = [];\nlet rpmGate = Promise.resolve();\nlet rpmStatusTimer = null;\n\nclass FastQueue {\n  constructor() {\n    this._items = [];\n    this._head = 0;\n  }\n\n  get length() {\n    return this._items.length - this._head;\n  }\n\n  push(value) {\n    this._items.push(value);\n  }\n\n  shift() {\n    if (this._head >= this._items.length) return undefined;\n    const value = this._items[this._head++];\n    if (this._head > 1024 && this._head * 2 > this._items.length) {\n      this._items = this._items.slice(this._head);\n      this._head = 0;\n    }\n    return value;\n  }\n\n  drain() {\n    const pending = this._items.slice(this._head);\n    this._items = [];\n    this._head = 0;\n    return pending;\n  }\n}\n\nlet active = 0;\nconst queue = new FastQueue();\nlet statusTimer = null;\nlet pendingStatus = null;\nlet lastStatusKey = \"\";\nconst BATCH_REQUEST_THRESHOLD = 200;\nconst BATCH_LOG_THROTTLE_MS = 1000;\nlet batchState = null;\n\nfunction createBatchState() {\n  const startedAt = nowMs();\n  return {\n    id: `batch_${startedAt}_${Math.random().toString(36).slice(2, 8)}`,\n    startedAt,\n    endedAt: 0,\n    totalRequests: 0,\n    okCount: 0,\n    errorCount: 0,\n    cachedCount: 0,\n    inputTokens: 0,\n    outputTokens: 0,\n    reasoningTokens: 0,\n    cachedInputTokens: 0,\n    msSum: 0,\n    msMax: 0,\n    msMin: 0,\n    peakQueued: 0,\n    peakActive: 0,\n    models: new Map(),\n    lastLogAt: 0\n  };\n}\n\nfunction totalPendingRequests() {\n  return active + queue.length;\n}\n\nfunction ensureBatchState() {\n  if (batchState) return true;\n  if (totalPendingRequests() < BATCH_REQUEST_THRESHOLD) return false;\n  batchState = createBatchState();\n  return true;\n}\n\nfunction updateBatchPeaks() {\n  if (!batchState) return;\n  batchState.peakQueued = Math.max(batchState.peakQueued, queue.length);\n  batchState.peakActive = Math.max(batchState.peakActive, active);\n}\n\nfunction recordBatchResult({ provider, model, ok, cached, cacheHint, usage, ms }) {\n  if (!batchState) return false;\n  batchState.totalRequests += 1;\n  if (ok) batchState.okCount += 1;\n  else batchState.errorCount += 1;\n  if (cached || cacheHint) batchState.cachedCount += 1;\n\n  const inputTokens = Number(usage?.inputTokens || 0) || 0;\n  const outputTokens = Number(usage?.outputTokens || 0) || 0;\n  const reasoningTokens = Number(usage?.reasoningTokens || 0) || 0;\n  const cachedInputTokens = Number(usage?.cachedInputTokens || 0) || 0;\n\n  batchState.inputTokens += inputTokens;\n  batchState.outputTokens += outputTokens;\n  batchState.reasoningTokens += reasoningTokens;\n  batchState.cachedInputTokens += cachedInputTokens;\n\n  const duration = Number(ms || 0) || 0;\n  if (duration > 0) {\n    batchState.msSum += duration;\n    batchState.msMax = Math.max(batchState.msMax, duration);\n    batchState.msMin = batchState.msMin ? Math.min(batchState.msMin, duration) : duration;\n  }\n\n  if (inputTokens + outputTokens + reasoningTokens + cachedInputTokens > 0) {\n    const key = `${String(provider || \"\").toLowerCase()}|${String(model || \"\").trim()}`;\n    const existing = batchState.models.get(key) || {\n      provider: String(provider || \"\").toLowerCase(),\n      model: String(model || \"\").trim(),\n      inputTokens: 0,\n      outputTokens: 0,\n      reasoningTokens: 0,\n      cachedInputTokens: 0,\n      requests: 0\n    };\n    existing.inputTokens += inputTokens;\n    existing.outputTokens += outputTokens;\n    existing.reasoningTokens += reasoningTokens;\n    existing.cachedInputTokens += cachedInputTokens;\n    existing.requests += 1;\n    batchState.models.set(key, existing);\n  }\n\n  maybeEmitBatchLog(false);\n  return true;\n}\n\nfunction shouldUsePersistentCache() {\n  if (batchState) return false;\n  if (totalPendingRequests() >= BATCH_REQUEST_THRESHOLD) return false;\n  return true;\n}\n\nfunction buildBatchLogEntry(isFinal) {\n  if (!batchState) return null;\n  const models = Array.from(batchState.models.values());\n  const totalTokens = batchState.inputTokens + batchState.outputTokens + batchState.reasoningTokens;\n  const durationMs = Math.max(0, (batchState.endedAt || nowMs()) - batchState.startedAt);\n  const avgMs = batchState.totalRequests > 0 ? Math.round(batchState.msSum / batchState.totalRequests) : 0;\n\n  return {\n    fn: \"AI.BATCH\",\n    provider: \"batch\",\n    model: \"\",\n    ok: batchState.errorCount === 0,\n    cache: false,\n    ms: durationMs,\n    inputTokens: batchState.inputTokens,\n    outputTokens: batchState.outputTokens,\n    reasoningTokens: batchState.reasoningTokens,\n    cachedInputTokens: batchState.cachedInputTokens,\n    totalTokens,\n    batch: true,\n    batchId: batchState.id,\n    batchLive: !isFinal,\n    batchModels: models,\n    batchStats: {\n      totalRequests: batchState.totalRequests,\n      ok: batchState.okCount,\n      error: batchState.errorCount,\n      cached: batchState.cachedCount,\n      avgMs,\n      maxMs: batchState.msMax,\n      minMs: batchState.msMin,\n      peakQueued: batchState.peakQueued,\n      peakActive: batchState.peakActive\n    }\n  };\n}\n\nfunction maybeEmitBatchLog(force) {\n  if (!batchState) return;\n  const now = nowMs();\n  if (!force && now - batchState.lastLogAt < BATCH_LOG_THROTTLE_MS) return;\n  batchState.lastLogAt = now;\n  const entry = buildBatchLogEntry(false);\n  if (entry) logRequest(entry);\n}\n\nfunction finalizeBatchIfIdle() {\n  if (!batchState) return;\n  if (active > 0 || queue.length > 0) return;\n  batchState.endedAt = nowMs();\n  const entry = buildBatchLogEntry(true);\n  batchState = null;\n  if (entry) logRequest(entry);\n}\n\nfunction getRpmCount() {\n  const now = nowMs();\n  pruneRpmWindow(now);\n  return rpmWindow.length;\n}\n\nfunction snapshotQueueStatus() {\n  return { active, queued: queue.length, rpm: getRpmCount() };\n}\n\nfunction scheduleRuntimeStatusUpdate() {\n  const snapshot = snapshotQueueStatus();\n  pendingStatus = snapshot;\n  if (statusTimer) return;\n  statusTimer = setTimeout(() => {\n    statusTimer = null;\n    const status = pendingStatus;\n    pendingStatus = null;\n    if (!status) return;\n    const key = `${status.active}:${status.queued}:${status.rpm}`;\n    if (key === lastStatusKey) return;\n    lastStatusKey = key;\n    void setRuntimeStatus({ ...status, ts: nowMs() });\n  }, 120);\n}\n\nasync function getConcurrencyLimitCached() {\n  const now = nowMs();\n  if (now - concurrencyLimitCachedAt < CONCURRENCY_CACHE_TTL_MS) return concurrencyLimitCached;\n  const value = await getConcurrencyLimit();\n  concurrencyLimitCached = value;\n  concurrencyLimitCachedAt = now;\n  return value;\n}\n\nasync function getRpmLimitCached() {\n  const now = nowMs();\n  if (now - rpmLimitCachedAt < RPM_CACHE_TTL_MS) return rpmLimitCached;\n  const value = await getRpmLimit();\n  rpmLimitCached = value;\n  rpmLimitCachedAt = now;\n  return value;\n}\n\nfunction pruneRpmWindow(now) {\n  const cutoff = now - RPM_WINDOW_MS;\n  while (rpmWindow.length && rpmWindow[0] <= cutoff) {\n    rpmWindow.shift();\n  }\n}\n\nfunction ensureRpmStatusTimer() {\n  if (rpmStatusTimer) return;\n  rpmStatusTimer = setInterval(() => {\n    const count = getRpmCount();\n    scheduleRuntimeStatusUpdate();\n    if (count <= 0) {\n      clearInterval(rpmStatusTimer);\n      rpmStatusTimer = null;\n    }\n  }, 1000);\n}\n\nasync function reserveRpmSlot(limit) {\n  while (true) {\n    const now = nowMs();\n    pruneRpmWindow(now);\n    if (!limit || limit <= 0 || rpmWindow.length < limit) {\n      rpmWindow.push(now);\n      ensureRpmStatusTimer();\n      scheduleRuntimeStatusUpdate();\n      return;\n    }\n    const waitMs = Math.max(0, rpmWindow[0] + RPM_WINDOW_MS - now);\n    if (waitMs > 0) {\n      await sleep(waitMs);\n    } else {\n      await sleep(0);\n    }\n  }\n}\n\nasync function waitForRpmSlot() {\n  const limit = await getRpmLimitCached();\n  if (!limit || limit <= 0) return;\n  rpmGate = rpmGate.then(() => reserveRpmSlot(limit));\n  return rpmGate;\n}\n\nexport function stopQueuedRequests() {\n  if (!queue.length) return 0;\n  const pending = queue.drain();\n  for (const resolve of pending) {\n    resolve(QUEUE_CANCELLED);\n  }\n  scheduleRuntimeStatusUpdate();\n  return pending.length;\n}\n\nasync function withConcurrencyLimit(fn) {\n  while (true) {\n    const limit = await getConcurrencyLimitCached();\n    if (active < limit) break;\n    const gate = await new Promise((resolve) => {\n      queue.push(resolve);\n      ensureBatchState();\n      updateBatchPeaks();\n      scheduleRuntimeStatusUpdate();\n    });\n    if (gate === QUEUE_CANCELLED) return { ...QUEUE_CANCELLED_RESULT };\n  }\n  active++;\n  ensureBatchState();\n  updateBatchPeaks();\n  scheduleRuntimeStatusUpdate();\n  try {\n    await waitForRpmSlot();\n    return await fn();\n  } finally {\n    active--;\n    const next = queue.shift();\n    if (next) next();\n    scheduleRuntimeStatusUpdate();\n    finalizeBatchIfIdle();\n  }\n}\n\n// Reset runtime status on load to avoid stale UI.\nvoid setRuntimeStatus({ active: 0, queued: 0, rpm: 0, ts: nowMs() });\n\nfunction isNonEmptyString(s) {\n  return typeof s === \"string\" && s.trim().length > 0;\n}\n\nfunction normalizeBoolean(v, def = false) {\n  if (typeof v === \"boolean\") return v;\n  if (typeof v === \"number\") return v !== 0;\n  if (typeof v === \"string\") {\n    const s = v.trim().toLowerCase();\n    if ([\"1\", \"true\", \"yes\", \"y\", \"on\"].includes(s)) return true;\n    if ([\"0\", \"false\", \"no\", \"n\", \"off\"].includes(s)) return false;\n  }\n  return def;\n}\n\nfunction normalizeTimeoutMs(v) {\n  return clampInt(v, 1000, 120000, DEFAULTS.timeoutMs);\n}\n\nfunction normalizeRetry(v) {\n  return clampInt(v, 0, 5, DEFAULTS.retry);\n}\n\nfunction normalizeMaxOutputTokens(v) {\n  return clampInt(v, 1, 128000, DEFAULTS.maxOutputTokens);\n}\n\nfunction toLowerMsg(v) {\n  return String(v || \"\").toLowerCase();\n}\n\nfunction isTimeoutError(err) {\n  if (!err) return false;\n  if (err.name === \"AbortError\") return true;\n  const msg = String(err.message || \"\").toLowerCase();\n  return msg.includes(\"aborted\") || msg.includes(\"timeout\");\n}\n\nfunction toGeminiModelRef(model) {\n  const id = String(model || \"\").trim();\n  if (!id) return \"\";\n  return id.startsWith(\"models/\") ? id : `models/${id}`;\n}\n\nfunction extractGeminiCacheParts(user) {\n  if (!isNonEmptyString(user)) return null;\n  const marker = /(^|\\n)Product\\s*:/i;\n  const match = marker.exec(user);\n  if (!match) return null;\n  const idx = match.index + match[0].length;\n  const prefix = user.slice(0, idx);\n  const suffix = user.slice(idx);\n  if (prefix.length < GEMINI_CACHED_CONTENT_MIN_PREFIX_CHARS) return null;\n  if (suffix.trim().length < GEMINI_CACHED_CONTENT_MIN_SUFFIX_CHARS) return null;\n  return { prefix, suffix };\n}\n\nfunction parseExpireTimeMs(expireTime, fallbackMs) {\n  if (!expireTime) return fallbackMs;\n  const parsed = Date.parse(String(expireTime));\n  if (Number.isFinite(parsed) && parsed > 0) return parsed;\n  return fallbackMs;\n}\n\nasync function createGeminiCachedContent({ apiKey, model, system, prefix, ttlMs, timeoutMs }) {\n  const url = \"https://generativelanguage.googleapis.com/v1beta/cachedContents\";\n  const body = {\n    model: toGeminiModelRef(model),\n    contents: [{ role: \"user\", parts: [{ text: prefix }] }],\n    ttl: `${Math.max(60, Math.floor((ttlMs || GEMINI_CACHED_CONTENT_TTL_MS) / 1000))}s`\n  };\n\n  if (isNonEmptyString(system)) {\n    body.systemInstruction = { role: \"system\", parts: [{ text: system }] };\n  }\n\n  const res = await fetchWithTimeout(\n    url,\n    {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n        \"x-goog-api-key\": apiKey\n      },\n      body: JSON.stringify(body)\n    },\n    Math.max(10000, Math.min(60000, timeoutMs || 30000))\n  );\n\n  const json = await safeJson(res);\n  if (!res.ok) return { ok: false, status: res.status, json };\n  const name = String(json?.name || \"\").trim();\n  if (!name) return { ok: false, status: res.status, json };\n  return { ok: true, name, expireTime: json?.expireTime };\n}\n\nasync function ensureGeminiCachedContent({ apiKey, model, system, prefix, ttlMs, timeoutMs }) {\n  if (!apiKey || !isNonEmptyString(prefix)) return null;\n  const cacheKey = await hashKey({\n    v: 1,\n    model: String(model || \"\").trim(),\n    system: String(system || \"\").trim(),\n    prefix\n  });\n\n  const existing = await getGeminiCachedContentEntry(cacheKey);\n  if (existing?.name) return { name: existing.name, cacheKey };\n\n  if (GEMINI_CACHED_INFLIGHT.has(cacheKey)) return GEMINI_CACHED_INFLIGHT.get(cacheKey);\n\n  const p = (async () => {\n    try {\n      const created = await createGeminiCachedContent({ apiKey, model, system, prefix, ttlMs, timeoutMs });\n      if (!created?.ok || !created?.name) return null;\n      const expiresAtMs = parseExpireTimeMs(created.expireTime, nowMs() + (ttlMs || GEMINI_CACHED_CONTENT_TTL_MS));\n      await setGeminiCachedContentEntry(cacheKey, {\n        name: created.name,\n        savedAtMs: nowMs(),\n        expiresAtMs\n      });\n      return { name: created.name, cacheKey };\n    } catch {\n      return null;\n    }\n  })();\n\n  GEMINI_CACHED_INFLIGHT.set(cacheKey, p);\n  try {\n    return await p;\n  } finally {\n    GEMINI_CACHED_INFLIGHT.delete(cacheKey);\n  }\n}\n\nfunction looksLikeStructuredOutputUnsupported(message) {\n  const s = toLowerMsg(message);\n  if (!s) return false;\n  return (\n    s.includes(\"responseschema\") ||\n    s.includes(\"response schema\") ||\n    s.includes(\"response_schema\") ||\n    s.includes(\"responsemime\") ||\n    s.includes(\"response mime\") ||\n    s.includes(\"response_mime\") ||\n    s.includes(\"response_mime_type\") ||\n    s.includes(\"json_schema\") ||\n    s.includes(\"response_format\") ||\n    s.includes(\"text.format\")\n  );\n}\n\nfunction looksLikeWebSearchUnsupported(message) {\n  const s = toLowerMsg(message);\n  if (!s) return false;\n  if (!(s.includes(\"web_search\") || s.includes(\"google_search\") || s.includes(\"web search\") || s.includes(\"google search\"))) {\n    return false;\n  }\n  return (\n    s.includes(\"not supported\") ||\n    s.includes(\"unsupported\") ||\n    s.includes(\"unknown\") ||\n    s.includes(\"unrecognized\") ||\n    s.includes(\"invalid\") ||\n    s.includes(\"not enabled\") ||\n    s.includes(\"not available\")\n  );\n}\n\nfunction looksLikeCachedContentInvalid(message) {\n  const s = toLowerMsg(message);\n  if (!s) return false;\n  if (!s.includes(\"cached\")) return false;\n  return (\n    s.includes(\"not found\") ||\n    s.includes(\"invalid\") ||\n    s.includes(\"expired\") ||\n    s.includes(\"not exist\") ||\n    s.includes(\"does not exist\")\n  );\n}\n\nfunction isGeminiServiceUnavailable(provider, result) {\n  if (provider !== PROVIDERS.GEMINI || result?.ok) return false;\n  if (result?.status === 503) return true;\n  if (result?.code !== \"API_ERROR\") return false;\n  const msg = toLowerMsg(result?.message);\n  if (!msg) return false;\n  return msg.includes(\"overloaded\") || msg.includes(\"service unavailable\") || msg.includes(\"unavailable\");\n}\n\nfunction ensureJsonInstruction(system) {\n  const suffix = \" Return valid JSON only.\";\n  if (!isNonEmptyString(system)) return \"Return valid JSON only.\";\n  const s = String(system).trim();\n  if (/json/i.test(s)) return s;\n  return s + suffix;\n}\n\nfunction extractFormulaFromText(text) {\n  if (!isNonEmptyString(text)) return \"\";\n  const raw = String(text).trim();\n  const match = raw.match(/=[^\\n\\r]+/);\n  const formula = (match ? match[0] : raw).trim();\n  if (!formula.startsWith(\"=\")) return \"\";\n  return formula;\n}\n\nfunction getFormulaForLog(fnName, text) {\n  if (fnName !== \"AI.FORMULA\") return \"\";\n  return extractFormulaFromText(text);\n}\n\nfunction resolveGeminiThinkingConfig(model, effort) {\n  const level = String(effort || \"\").trim().toLowerCase();\n  if (!level || level === \"auto\" || level === \"none\") return null;\n\n  const modelId = String(model || \"\").trim().toLowerCase();\n  if (!modelId.includes(\"gemini\")) return null;\n\n  if (modelId.includes(\"gemini-3\")) {\n    if (modelId.includes(\"flash\")) {\n      const allowed = new Set([\"minimal\", \"low\", \"medium\", \"high\"]);\n      const normalized = allowed.has(level) ? level : \"low\";\n      return { thinkingLevel: normalized.toUpperCase() };\n    }\n    const normalized = level === \"high\" || level === \"medium\" ? \"high\" : \"low\";\n    return { thinkingLevel: normalized.toUpperCase() };\n  }\n\n  if (modelId.includes(\"gemini-2.5\")) {\n    const budgets = {\n      minimal: 512,\n      low: 2048,\n      medium: 8192,\n      high: 24576\n    };\n    let budget = budgets[level];\n    if (!budget) return null;\n    if (modelId.includes(\"flash-lite\")) budget = Math.max(512, budget);\n    if (modelId.includes(\"pro\")) budget = Math.max(128, budget);\n    return { thinkingBudget: budget };\n  }\n\n  return null;\n}\n\n// ---- Public API ----\n\n/**\n * @typedef {Object} AIGenerateRequest\n * @property {string=} provider Optional override (should only be used by taskpane tests, not formulas).\n * @property {string=} system System instruction.\n * @property {string} user User prompt.\n * @property {boolean=} webSearch Enable provider web search tool.\n * @property {number=} maxOutputTokens Override max tokens (optional; normally from panel).\n * @property {number=} timeoutMs\n * @property {number=} retry\n * @property {boolean=} cache\n * @property {number=} cacheTtlSec\n * @property {string=} responseMimeType e.g., \"application/json\"\n * @property {Object=} responseJsonSchema JSON schema (strict) for structured output.\n * @property {string=} functionName Name for diagnostics.\n * @property {string=} functionCall Excel-style function call for diagnostics.\n */\n\n/**\n * @typedef {Object} AIResult\n * @property {boolean} ok\n * @property {string=} text\n * @property {Array<{title?: string, url: string}>=} sources\n * @property {string=} provider\n * @property {string=} model\n * @property {Object=} usage\n * @property {number=} status\n * @property {string=} code\n * @property {string=} message\n * @property {string=} cacheHint\n */\n\nexport async function aiGenerate(req) {\n  const start = nowMs();\n  const provider = normalizeProvider(req?.provider) || (await getDefaultProvider());\n  const model = await getModel(provider);\n  const apiKey = await getApiKey(provider);\n  const fnName = req?.functionName || \"aiGenerate\";\n  const functionCall = isNonEmptyString(req?.functionCall) ? String(req.functionCall) : \"\";\n  const reasoningEffort = provider === PROVIDERS.OPENAI ? await getOpenAIReasoningEffort() : \"\";\n  const geminiReasoningEffort = provider === PROVIDERS.GEMINI ? await getGeminiReasoningEffort() : \"\";\n  const reasoningEffortLabel = provider === PROVIDERS.OPENAI ? reasoningEffort : geminiReasoningEffort;\n\n  if (!apiKey) {\n    logRequest({\n      fn: fnName,\n      provider,\n      model,\n      ok: false,\n      ms: nowMs() - start,\n      cache: false,\n      reasoningEffort: reasoningEffortLabel || undefined,\n      call: functionCall || undefined,\n      code: \"API_KEY_MISSING\",\n      message: `Cl API manquante pour le fournisseur ${provider}.`\n    });\n    return {\n      ok: false,\n      provider,\n      model,\n      code: \"API_KEY_MISSING\",\n      message: `Cl API manquante pour le fournisseur ${provider}.`\n    };\n  }\n\n  const user = String(req?.user || \"\");\n  const system = isNonEmptyString(req?.system) ? String(req.system) : \"\";\n\n  const webSearch = normalizeBoolean(req?.webSearch, false);\n  const timeoutMs = normalizeTimeoutMs(req?.timeoutMs);\n  const retry = normalizeRetry(req?.retry);\n  const gemini503RetryMax = Math.min(retry, GEMINI_503_MAX_RETRIES);\n\n  const cfgMax = await getMaxOutputTokens();\n  const maxOutputTokens = normalizeMaxOutputTokens(req?.maxOutputTokens ?? cfgMax);\n  const thinkingConfig = provider === PROVIDERS.GEMINI ? resolveGeminiThinkingConfig(model, geminiReasoningEffort) : null;\n\n  const cacheEnabled = normalizeBoolean(req?.cache, DEFAULTS.cache);\n  const ttlSec = clampInt(\n    req?.cacheTtlSec ?? DEFAULTS.cacheTtlSec,\n    1,\n    365 * 24 * 3600,\n    DEFAULTS.cacheTtlSec\n  );\n  const allowPersistentCache = cacheEnabled && shouldUsePersistentCache();\n\n  await syncCacheClearMarker();\n\n  // Cache key (no temperature anywhere)\n  const cacheKeyPayload = {\n    v: 3,\n    provider,\n    model,\n    maxOutputTokens,\n    reasoningEffort,\n    geminiReasoningEffort,\n    webSearch,\n    system,\n    user,\n    responseMimeType: req?.responseMimeType || \"\",\n    responseJsonSchema: req?.responseJsonSchema || null\n  };\n\n  const cacheKey = await hashKey(cacheKeyPayload);\n\n  if (cacheEnabled) {\n    const cached = CACHE.get(cacheKey);\n    if (cached) {\n      const formula = getFormulaForLog(fnName, cached?.text);\n      const recorded = recordBatchResult({\n        provider,\n        model,\n        ok: true,\n        cached: true,\n        cacheHint: null,\n        usage: null,\n        ms: nowMs() - start\n      });\n      if (!recorded) {\n        logRequest({\n          fn: fnName,\n          provider,\n          model,\n          ok: true,\n          ms: nowMs() - start,\n          cache: true,\n          cacheKind: \"memory\",\n          reasoningEffort: reasoningEffortLabel || undefined,\n          call: functionCall || undefined,\n          inputTokens: 0,\n          outputTokens: 0,\n          reasoningTokens: 0,\n          totalTokens: 0,\n          formula: formula || undefined\n        });\n      }\n      if (recorded) finalizeBatchIfIdle();\n      return { ...cached, cached: true, cacheKind: \"memory\" };\n    }\n    if (allowPersistentCache) {\n      const persisted = await getPersistentCache(cacheKey);\n      if (persisted) {\n        const formula = getFormulaForLog(fnName, persisted?.text);\n        CACHE.set(cacheKey, persisted, ttlSec * 1000);\n        const recorded = recordBatchResult({\n          provider,\n          model,\n          ok: true,\n          cached: true,\n          cacheHint: null,\n          usage: null,\n          ms: nowMs() - start\n        });\n        if (!recorded) {\n          logRequest({\n            fn: fnName,\n            provider,\n            model,\n            ok: true,\n            ms: nowMs() - start,\n            cache: true,\n            cacheKind: \"persistent\",\n            reasoningEffort: reasoningEffortLabel || undefined,\n            call: functionCall || undefined,\n            inputTokens: 0,\n            outputTokens: 0,\n            reasoningTokens: 0,\n            totalTokens: 0,\n            formula: formula || undefined\n          });\n        }\n        if (recorded) finalizeBatchIfIdle();\n        return { ...persisted, cached: true, cacheKind: \"persistent\" };\n      }\n    }\n  }\n\n  if (INFLIGHT.has(cacheKey)) return INFLIGHT.get(cacheKey);\n\n  const p = withConcurrencyLimit(async () => {\n    let attempt = 0;\n    let lastErr = null;\n\n    const callProvider = async (opts) =>\n      provider === PROVIDERS.OPENAI ? callOpenAI(opts) : callGemini(opts);\n\n    while (attempt <= retry) {\n      attempt++;\n      try {\n        const baseOpts = {\n          apiKey,\n          model,\n          system,\n          user,\n          maxOutputTokens,\n          reasoningEffort,\n          thinkingConfig,\n          timeoutMs,\n          webSearch,\n          responseMimeType: req?.responseMimeType,\n          responseJsonSchema: req?.responseJsonSchema\n        };\n\n        let result = await callProvider(baseOpts);\n\n        if (!result.ok && !isGeminiServiceUnavailable(provider, result)) {\n          let opts = baseOpts;\n\n          // Fallback #1: if web search fails, retry without tools.\n          if (opts.webSearch) {\n            const shouldRetryNoWeb =\n              looksLikeWebSearchUnsupported(result.message) || result.code === \"API_ERROR\" || result.code === \"EMPTY_RESPONSE\";\n            if (shouldRetryNoWeb) {\n              opts = { ...opts, webSearch: false };\n              result = await callProvider(opts);\n            }\n          }\n\n          // Fallback #2: if structured output fails, retry without schema/responseMimeType.\n          const wantsStructured = opts.responseMimeType || opts.responseJsonSchema;\n          if (!result.ok && wantsStructured) {\n            const shouldRetryPlainJson =\n              looksLikeStructuredOutputUnsupported(result.message) ||\n              result.code === \"API_ERROR\" ||\n              result.code === \"EMPTY_RESPONSE\";\n            if (shouldRetryPlainJson) {\n              opts = {\n                ...opts,\n                responseMimeType: undefined,\n                responseJsonSchema: undefined,\n                system: ensureJsonInstruction(opts.system)\n              };\n              result = await callProvider(opts);\n            }\n          }\n        }\n\n        const shouldRetryServiceUnavailable =\n          isGeminiServiceUnavailable(provider, result) && attempt <= gemini503RetryMax;\n\n        // Log (best-effort)\n        const usage = normalizeUsage(result?.usage);\n        const formula = result.ok ? getFormulaForLog(fnName, result.text) : \"\";\n\n        if (shouldRetryServiceUnavailable) {\n          await sleep(GEMINI_503_RETRY_DELAY_MS);\n          continue;\n        }\n\n        const recorded = recordBatchResult({\n          provider,\n          model,\n          ok: result.ok,\n          cached: false,\n          cacheHint: result.cacheHint || null,\n          usage,\n          ms: nowMs() - start\n        });\n        if (!recorded) {\n          logRequest({\n            fn: fnName,\n            provider,\n            model,\n            ok: result.ok,\n            ms: nowMs() - start,\n            attempt,\n            cache: false,\n            reasoningEffort: reasoningEffortLabel || undefined,\n            call: functionCall || undefined,\n            inputTokens: usage.inputTokens,\n            outputTokens: usage.outputTokens,\n            reasoningTokens: usage.reasoningTokens,\n            cachedInputTokens: usage.cachedInputTokens,\n            totalTokens: usage.totalTokens,\n            code: result.code,\n            message: result.message,\n            formula: formula || undefined,\n            cacheHint: result.cacheHint || undefined\n          });\n        }\n\n        if (result.ok && cacheEnabled) {\n          CACHE.set(cacheKey, result, ttlSec * 1000);\n          if (allowPersistentCache) {\n            await setPersistentCache(cacheKey, result, ttlSec * 1000, { provider, model });\n          }\n        }\n\n        return result;\n      } catch (e) {\n        lastErr = e;\n        if (attempt <= retry) await sleep(250 * attempt);\n      }\n    }\n\n    const timeout = isTimeoutError(lastErr);\n    const code = timeout ? \"TIMEOUT\" : \"API_ERROR\";\n    const rawMsg = timeout ? \"Dlai dpass (timeout).\" : (lastErr?.message ? String(lastErr.message) : \"Erreur inconnue.\");\n    const msg = redactSensitiveText(rawMsg);\n    const recorded = recordBatchResult({\n      provider,\n      model,\n      ok: false,\n      cached: false,\n      cacheHint: null,\n      usage: null,\n      ms: nowMs() - start\n    });\n    if (!recorded) {\n      logRequest({\n        fn: fnName,\n        provider,\n        model,\n        ok: false,\n        ms: nowMs() - start,\n        cache: false,\n        reasoningEffort: reasoningEffortLabel || undefined,\n        call: functionCall || undefined,\n        code,\n        message: msg\n      });\n    }\n    return { ok: false, provider, model, code, message: msg };\n  });\n\n  INFLIGHT.set(cacheKey, p);\n\n  try {\n    const result = await p;\n    if (result?.code === \"QUEUE_CANCELLED\") {\n      const recorded = recordBatchResult({\n        provider,\n        model,\n        ok: false,\n        cached: false,\n        cacheHint: null,\n        usage: null,\n        ms: nowMs() - start\n      });\n      if (!recorded) {\n        logRequest({\n          fn: fnName,\n          provider,\n          model,\n          ok: false,\n          ms: nowMs() - start,\n          cache: false,\n          reasoningEffort: reasoningEffortLabel || undefined,\n          call: functionCall || undefined,\n          inputTokens: 0,\n          outputTokens: 0,\n          reasoningTokens: 0,\n          cachedInputTokens: 0,\n          totalTokens: 0,\n          code: result.code,\n          message: result.message\n        });\n      }\n    }\n    return result;\n  } finally {\n    INFLIGHT.delete(cacheKey);\n  }\n}\n\n/**\n * Lightweight connectivity test for a provider (used from taskpane and AI.TEST()).\n */\nexport async function aiMinimalTest(providerOverride) {\n  const provider = normalizeProvider(providerOverride) || (await getDefaultProvider());\n  const model = await getModel(provider);\n  const apiKey = await getApiKey(provider);\n\n  if (!apiKey) {\n    return {\n      ok: false,\n      provider,\n      model,\n      code: \"API_KEY_MISSING\",\n      message: `Cl API manquante pour le fournisseur ${provider}.`\n    };\n  }\n\n  // Tiny request\n  return await aiGenerate({\n    provider,\n    system: \"You are a test endpoint. Reply with exactly: OK\",\n    user: \"OK\",\n    maxOutputTokens: 500,\n    cache: false,\n    webSearch: false,\n    functionName: \"AI.MINIMAL_TEST\"\n  });\n}\n\n// ---- Provider: Gemini (Google Generative Language API) ----\n\nfunction geminiEndpoint(model) {\n  return `https://generativelanguage.googleapis.com/v1beta/models/${encodeURIComponent(model)}:generateContent`;\n}\n\nasync function callGemini({\n  apiKey,\n  model,\n  system,\n  user,\n  maxOutputTokens,\n  thinkingConfig,\n  timeoutMs,\n  webSearch,\n  responseMimeType,\n  responseJsonSchema\n}) {\n  const url = geminiEndpoint(model);\n  let cacheHint = \"\";\n  let cachedContentName = \"\";\n  let cachedContentKey = \"\";\n  let userText = user;\n  const systemText = isNonEmptyString(system)\n    ? ((responseMimeType === \"application/json\" || responseJsonSchema)\n      ? system + \" You must return valid JSON.\"\n      : system)\n    : \"\";\n  const cacheParts = webSearch ? null : extractGeminiCacheParts(user);\n  if (cacheParts) {\n    const cached = await ensureGeminiCachedContent({\n      apiKey,\n      model,\n      system: systemText,\n      prefix: cacheParts.prefix,\n      ttlMs: GEMINI_CACHED_CONTENT_TTL_MS,\n      timeoutMs\n    });\n    if (cached?.name) {\n      cachedContentName = cached.name;\n      cachedContentKey = cached.cacheKey || \"\";\n      userText = cacheParts.suffix;\n      cacheHint = \"gemini_cached_content\";\n    }\n  }\n\n  const body = {\n    contents: [{ role: \"user\", parts: [{ text: userText }] }],\n    generationConfig: {\n      maxOutputTokens\n    }\n  };\n\n  if (thinkingConfig && typeof thinkingConfig === \"object\") {\n    body.generationConfig.thinkingConfig = thinkingConfig;\n  }\n\n  if (isNonEmptyString(systemText) && !cachedContentName) {\n    // API uses lowerCamelCase for this field in JSON representation\n    body.systemInstruction = { role: \"system\", parts: [{ text: systemText }] };\n  }\n\n  // Structured output (JSON) when requested\n  if (responseMimeType) {\n    body.generationConfig.responseMimeType = responseMimeType;\n  }\n  if (responseJsonSchema) {\n    body.generationConfig.responseSchema = responseJsonSchema;\n  }\n\n  // Web grounding tool\n  if (webSearch) {\n    // For REST v1beta, the tool name is usually google_search (snake_case).\n    // Note: Some newer endpoints might respect googleSearch, but snake_case is safer for REST.\n    body.tools = [{ google_search: {} }];\n  }\n  if (cachedContentName) {\n    body.cachedContent = cachedContentName;\n  }\n\n  const res = await fetchWithTimeout(url, {\n    method: \"POST\",\n    headers: {\n      \"Content-Type\": \"application/json\",\n      \"x-goog-api-key\": apiKey\n    },\n    body: JSON.stringify(body)\n  }, timeoutMs);\n\n  const json = await safeJson(res);\n  const errInfo = extractGeminiErrorInfo(json);\n\n  if (errInfo?.message) {\n    if (cachedContentKey && looksLikeCachedContentInvalid(errInfo.message)) {\n      await removeGeminiCachedContentEntry(cachedContentKey);\n    }\n    return {\n      ok: false,\n      provider: PROVIDERS.GEMINI,\n      model,\n      status: errInfo.status ?? res.status,\n      code: \"API_ERROR\",\n      message: redactSensitiveText(errInfo.message),\n      cacheHint\n    };\n  }\n\n  if (!res.ok) {\n    const msg = extractGeminiError(json) || `Gemini API error (${res.status}).`;\n    if (cachedContentKey && looksLikeCachedContentInvalid(msg)) {\n      await removeGeminiCachedContentEntry(cachedContentKey);\n    }\n    return {\n      ok: false,\n      provider: PROVIDERS.GEMINI,\n      model,\n      status: res.status,\n      code: \"API_ERROR\",\n      message: redactSensitiveText(msg),\n      cacheHint\n    };\n  }\n\n  const text = extractGeminiText(json);\n  const sources = extractGeminiSources(json);\n  const usage = extractGeminiUsage(json);\n\n  if (!isNonEmptyString(text)) {\n    return {\n      ok: false,\n      provider: PROVIDERS.GEMINI,\n      model,\n      code: \"EMPTY_RESPONSE\",\n      message: \"Rponse vide de Gemini.\",\n      cacheHint\n    };\n  }\n\n  return { ok: true, provider: PROVIDERS.GEMINI, model, text: text.trim(), sources, usage, cacheHint };\n}\n\nfunction extractGeminiText(json) {\n  try {\n    const c = json?.candidates?.[0];\n    const parts = c?.content?.parts;\n    if (Array.isArray(parts)) {\n      return parts.map((p) => p?.text || \"\").join(\"\");\n    }\n    return \"\";\n  } catch {\n    return \"\";\n  }\n}\n\nfunction extractGeminiError(json) {\n  try {\n    const msg = json?.error?.message;\n    return msg ? String(msg) : \"\";\n  } catch {\n    return \"\";\n  }\n}\n\nfunction extractGeminiErrorInfo(json) {\n  try {\n    const err = json?.error;\n    if (!err) return null;\n    const msg = err?.message;\n    const statusCode = Number(err?.code);\n    return {\n      message: msg ? String(msg) : \"\",\n      status: Number.isFinite(statusCode) ? statusCode : undefined\n    };\n  } catch {\n    return null;\n  }\n}\n\nfunction extractGeminiSources(json) {\n  try {\n    const c = json?.candidates?.[0];\n    const md = c?.groundingMetadata;\n    const chunks = md?.groundingChunks;\n    if (!Array.isArray(chunks)) return [];\n\n    const out = [];\n    for (const ch of chunks) {\n      const web = ch?.web;\n      if (!web?.uri) continue;\n      out.push({ title: web?.title || \"\", url: web.uri });\n    }\n\n    return dedupeSources(out);\n  } catch {\n    return [];\n  }\n}\n\n// ---- Provider: OpenAI (Responses API) ----\n\nasync function callOpenAI({\n  apiKey,\n  model,\n  system,\n  user,\n  maxOutputTokens,\n  reasoningEffort,\n  timeoutMs,\n  webSearch,\n  responseMimeType,\n  responseJsonSchema\n}) {\n  const url = \"https://api.openai.com/v1/responses\";\n\n  const body = {\n    model,\n    input: user, // Responses API uses 'input' (string or array of objects)\n    max_output_tokens: maxOutputTokens,\n    store: false\n  };\n\n  if (isNonEmptyString(reasoningEffort)) {\n    body.reasoning = { effort: reasoningEffort };\n  }\n\n  // System prompt\n  if (isNonEmptyString(system)) {\n    const sysText = (responseMimeType === \"application/json\" || responseJsonSchema)\n      ? system + \" You must return valid JSON.\"\n      : system;\n    body.instructions = sysText;\n  }\n\n  // Structured output (JSON)\n  // - If a JSON schema is provided: use json_schema strict mode.\n  // - Else if responseMimeType is JSON: request a json_object.\n  if (responseJsonSchema) {\n    // For GPT-5 Mini / v1/responses, we try to use the most standard way if possible.\n    // If body.text format fails, we rely on the prompt.\n    // We kept the previous implementation but added prompt reinforcement.\n    body.text = {\n      format: {\n        type: \"json_schema\",\n        name: \"excel_ai_schema\",\n        strict: true,\n        schema: responseJsonSchema\n      }\n    };\n  } else if (responseMimeType === \"application/json\") {\n    body.text = { format: { type: \"json_object\" } };\n  }\n\n  // Web search tool\n  if (webSearch) {\n    body.tools = [{ type: \"web_search\" }];\n    body.include = [\"web_search_call.action.sources\"];\n  }\n\n  const res = await fetchWithTimeout(url, {\n    method: \"POST\",\n    headers: {\n      \"Content-Type\": \"application/json\",\n      Authorization: `Bearer ${apiKey}`\n    },\n    body: JSON.stringify(body)\n  }, timeoutMs);\n\n  const json = await safeJson(res);\n\n  if (!res.ok) {\n    const msg = extractOpenAIError(json) || `OpenAI API error (${res.status}).`;\n    return { ok: false, provider: PROVIDERS.OPENAI, model, code: \"API_ERROR\", message: redactSensitiveText(msg) };\n  }\n\n  const text = extractOpenAIText(json);\n  const sources = webSearch ? extractOpenAISources(json) : [];\n  const usage = extractOpenAIUsage(json);\n\n  if (!isNonEmptyString(text)) {\n    return {\n      ok: false,\n      provider: PROVIDERS.OPENAI,\n      model,\n      code: \"EMPTY_RESPONSE\",\n      message: \"Rponse vide d'OpenAI.\"\n    };\n  }\n\n  return { ok: true, provider: PROVIDERS.OPENAI, model, text: text.trim(), sources, usage };\n}\n\nfunction extractOpenAIText(json) {\n  // 1. Try direct output_text (common in simple Responses)\n  try {\n    if (typeof json?.output_text === \"string\" && json.output_text.trim()) {\n      return json.output_text;\n    }\n  } catch {\n    // ignore\n  }\n\n  // 2. Try iterating over 'output' items (complex/agentic responses)\n  try {\n    const out = json?.output;\n    if (Array.isArray(out)) {\n      const texts = [];\n      for (const item of out) {\n        if (typeof item?.text === \"string\" && item.text.trim()) texts.push(item.text);\n        if (typeof item?.output_text === \"string\" && item.output_text.trim()) texts.push(item.output_text);\n        if (item?.type === \"output_text\" && typeof item?.text === \"string\") texts.push(item.text);\n        if (item?.type === \"text\" && typeof item?.text === \"string\") texts.push(item.text);\n\n        // Standard message output\n        if (item?.type === \"message\") {\n          const content = item?.content;\n          if (Array.isArray(content)) {\n            for (const part of content) {\n              if (part?.type === \"text\" && part?.text) texts.push(part.text);\n              if (part?.type === \"output_text\" && part?.text) texts.push(part.text);\n            }\n          } else if (typeof content === \"string\") {\n            texts.push(content);\n          }\n        }\n\n        if (item?.type !== \"message\") {\n          const content = item?.content;\n          if (Array.isArray(content)) {\n            for (const part of content) {\n              if (part?.type === \"text\" && part?.text) texts.push(part.text);\n              if (part?.type === \"output_text\" && part?.text) texts.push(part.text);\n            }\n          } else if (typeof content === \"string\") {\n            texts.push(content);\n          }\n        }\n      }\n      if (texts.length > 0) return texts.join(\"\\n\").trim();\n    }\n  } catch {\n    // ignore\n  }\n\n  // 3. Fallback: Chat Completions style (just in case model acts differently)\n  try {\n    return json?.choices?.[0]?.message?.content || \"\";\n  } catch {\n    return \"\";\n  }\n}\n\nfunction extractOpenAIError(json) {\n  try {\n    const msg = json?.error?.message;\n    return msg ? String(msg) : \"\";\n  } catch {\n    return \"\";\n  }\n}\n\nfunction extractOpenAISources(json) {\n  try {\n    const out = json?.output;\n    if (!Array.isArray(out)) return [];\n\n    const sources = [];\n    for (const item of out) {\n      if (item?.type !== \"web_search_call\") continue;\n      const s = item?.action?.sources;\n      if (!Array.isArray(s)) continue;\n      for (const src of s) {\n        if (!src?.url) continue;\n        sources.push({ title: src?.title || \"\", url: src.url });\n      }\n    }\n\n    return dedupeSources(sources);\n  } catch {\n    return [];\n  }\n}\n\nfunction extractGeminiUsage(json) {\n  try {\n    const u = json?.usageMetadata;\n    if (!u) return null;\n    return {\n      inputTokens: toInt(u?.promptTokenCount),\n      outputTokens: toInt(u?.candidatesTokenCount),\n      reasoningTokens: toInt(u?.thoughtsTokenCount),\n      totalTokens: toInt(u?.totalTokenCount),\n      cachedInputTokens: toInt(u?.cachedContentTokenCount)\n    };\n  } catch {\n    return null;\n  }\n}\n\nfunction extractOpenAIUsage(json) {\n  try {\n    const u = json?.usage;\n    if (!u) return null;\n    const rawOutputTokens = toInt(u?.output_tokens);\n    const reasoningTokens = toInt(u?.output_tokens_details?.reasoning_tokens);\n    const outputTokens = Math.max(0, rawOutputTokens - reasoningTokens);\n    return {\n      inputTokens: toInt(u?.input_tokens),\n      outputTokens,\n      reasoningTokens,\n      totalTokens: toInt(u?.total_tokens),\n      cachedInputTokens: toInt(u?.input_tokens_details?.cached_tokens)\n    };\n  } catch {\n    return null;\n  }\n}\n\nfunction normalizeUsage(usage) {\n  if (!usage || typeof usage !== \"object\") {\n    return { inputTokens: 0, outputTokens: 0, reasoningTokens: 0, totalTokens: 0, cachedInputTokens: 0 };\n  }\n  const inputTokens = toInt(usage.inputTokens);\n  const outputTokens = toInt(usage.outputTokens);\n  const reasoningTokens = toInt(usage.reasoningTokens);\n  const cachedInputTokens = toInt(usage.cachedInputTokens);\n  const reportedTotal = toInt(usage.totalTokens);\n  const computedTotal = inputTokens + outputTokens + reasoningTokens;\n  const totalTokens = Math.max(reportedTotal, computedTotal);\n  return {\n    inputTokens,\n    outputTokens,\n    reasoningTokens,\n    totalTokens,\n    cachedInputTokens\n  };\n}\n\nfunction toInt(value) {\n  const n = Number(value);\n  if (!Number.isFinite(n) || n <= 0) return 0;\n  return Math.floor(n);\n}\n\nexport async function clearAllCaches() {\n  CACHE.clear();\n  await clearPersistentCache();\n  await clearGeminiCachedContent();\n}\n\nfunction dedupeSources(list) {\n  const seen = new Set();\n  const out = [];\n  for (const s of list || []) {\n    const url = String(s?.url || \"\").trim();\n    if (!url) continue;\n    const key = url.toLowerCase();\n    if (seen.has(key)) continue;\n    seen.add(key);\n    out.push({ title: String(s?.title || \"\").trim(), url });\n  }\n  return out;\n}\n\n// ---- Helpers: fetch + timeout + JSON parsing ----\n\nasync function fetchWithTimeout(url, options, timeoutMs) {\n  const t = normalizeTimeoutMs(timeoutMs);\n\n  if (typeof AbortController === \"undefined\") {\n    // Basic fetch without cancellation (should be rare in modern Office runtimes)\n    return await fetch(url, options);\n  }\n\n  const ctrl = new AbortController();\n  const id = setTimeout(() => ctrl.abort(), t);\n\n  try {\n    return await fetch(url, { ...options, signal: ctrl.signal });\n  } finally {\n    clearTimeout(id);\n  }\n}\n\nasync function safeJson(res) {\n  try {\n    return await res.json();\n  } catch {\n    return {};\n  }\n}\n","// src/license.js\n// Lemon Squeezy license activation + validation helpers.\n\nimport { getLicense, setLicense, clearLicense } from \"./shared/core\";\n\nconst LS_ACTIVATE_ENDPOINT = \"https://api.lemonsqueezy.com/v1/licenses/activate\";\nconst LS_VALIDATE_ENDPOINT = \"https://api.lemonsqueezy.com/v1/licenses/validate\";\nconst INSTANCE_NAME = \"Neurow Add-in\";\nconst MIN_LICENSE_LENGTH = 5;\n\nfunction normalizeKey(key) {\n  return String(key || \"\").trim();\n}\n\nfunction normalizeExpiresAt(value) {\n  const raw = String(value || \"\").trim();\n  if (!raw) return \"\";\n  const ts = Date.parse(raw);\n  if (!Number.isFinite(ts)) return \"\";\n  return new Date(ts).toISOString();\n}\n\nfunction extractError(data, fallback) {\n  if (!data) return fallback;\n  if (typeof data.error === \"string\" && data.error.trim()) return data.error.trim();\n  if (typeof data.message === \"string\" && data.message.trim()) return data.message.trim();\n  if (Array.isArray(data.errors) && data.errors.length) {\n    const first = data.errors[0] || {};\n    const detail = first.detail || first.title || first.message;\n    if (detail) return String(detail).trim();\n  }\n  return fallback;\n}\n\nasync function postLicense(endpoint, payload) {\n  const formData = new FormData();\n  Object.entries(payload || {}).forEach(([key, value]) => {\n    if (value == null || value === \"\") return;\n    formData.append(key, value);\n  });\n\n  const response = await fetch(endpoint, { method: \"POST\", body: formData });\n  let data = null;\n  try {\n    data = await response.json();\n  } catch {\n    data = null;\n  }\n  return { ok: response.ok, status: response.status, data };\n}\n\nfunction buildLicense(key, data, overrides = {}) {\n  const instanceId = overrides.instanceId || data?.instance?.id || data?.instance_id || \"\";\n  const instanceName = data?.instance?.name || overrides.instanceName || INSTANCE_NAME;\n  const expiresAt = normalizeExpiresAt(data?.license_key?.expires_at || overrides.expiresAt);\n  const now = new Date().toISOString();\n\n  return {\n    key,\n    instanceId,\n    instanceName,\n    expiresAt,\n    valid: true,\n    activatedAt: overrides.activatedAt || now,\n    lastCheckedAt: now\n  };\n}\n\nfunction normalizeLicense(raw) {\n  if (!raw || typeof raw !== \"object\") return null;\n  const key = normalizeKey(raw.key);\n  if (!key) return null;\n\n  return {\n    key,\n    instanceId: String(raw.instanceId || \"\").trim(),\n    instanceName: String(raw.instanceName || INSTANCE_NAME).trim(),\n    expiresAt: normalizeExpiresAt(raw.expiresAt),\n    valid: raw.valid !== false,\n    activatedAt: String(raw.activatedAt || \"\").trim(),\n    lastCheckedAt: String(raw.lastCheckedAt || \"\").trim()\n  };\n}\n\nexport async function getStoredLicense() {\n  const stored = await getLicense();\n  return normalizeLicense(stored);\n}\n\nexport async function saveStoredLicense(license) {\n  const normalized = normalizeLicense(license);\n  if (!normalized) {\n    await clearLicense();\n    return null;\n  }\n  await setLicense(normalized);\n  return normalized;\n}\n\nexport async function clearStoredLicense() {\n  await clearLicense();\n}\n\nexport function isLicenseValid(license) {\n  if (!license || !license.key) return false;\n  if (license.valid === false) return false;\n  if (license.expiresAt) {\n    const ts = Date.parse(license.expiresAt);\n    if (Number.isFinite(ts) && ts <= Date.now()) return false;\n  }\n  return true;\n}\n\nexport async function hasValidLicense() {\n  const stored = await getStoredLicense();\n  return isLicenseValid(stored);\n}\n\nexport async function activateLicense(key, options = {}) {\n  const trimmed = normalizeKey(key);\n  if (!trimmed || trimmed.length < MIN_LICENSE_LENGTH) {\n    return { success: false, error: \"Cle trop courte\" };\n  }\n\n  const stored = await getStoredLicense();\n  if (!options.force && stored && stored.key === trimmed && isLicenseValid(stored)) {\n    return { success: true, license: stored, cached: true };\n  }\n\n  try {\n    const { ok, status, data } = await postLicense(LS_ACTIVATE_ENDPOINT, {\n      license_key: trimmed,\n      instance_name: INSTANCE_NAME\n    });\n\n    if (!ok) {\n      return { success: false, error: extractError(data, `Erreur API (${status})`) };\n    }\n\n    if (data?.activated) {\n      const license = buildLicense(trimmed, data, { activatedAt: stored?.activatedAt });\n      await setLicense(license);\n      return { success: true, license };\n    }\n\n    return { success: false, error: extractError(data, \"Cle invalide\") };\n  } catch {\n    return { success: false, error: \"Erreur de connexion internet\" };\n  }\n}\n\nexport async function validateLicense(key, options = {}) {\n  const trimmed = normalizeKey(key);\n  if (!trimmed || trimmed.length < MIN_LICENSE_LENGTH) {\n    return { success: false, error: \"Cle trop courte\" };\n  }\n\n  const stored = await getStoredLicense();\n  const instanceId = options.instanceId || stored?.instanceId || \"\";\n\n  try {\n    const { ok, status, data } = await postLicense(LS_VALIDATE_ENDPOINT, {\n      license_key: trimmed,\n      instance_id: instanceId || undefined\n    });\n\n    if (!ok) {\n      return { success: false, error: extractError(data, `Erreur API (${status})`) };\n    }\n\n    if (data?.valid) {\n      const license = buildLicense(trimmed, data, { instanceId, activatedAt: stored?.activatedAt });\n      return { success: true, license };\n    }\n\n    return { success: false, error: extractError(data, \"Cle invalide\") };\n  } catch {\n    return { success: false, error: \"Erreur de connexion internet\" };\n  }\n}\n","// src/taskpane/taskpane.js\n// Taskpane logic: provider selection + keys/models + shared max tokens.\n//\n// Requirements implemented:\n// - Default provider selection only in panel (not in formulas)\n// - Two tabs: Gemini and OpenAI\n// - Single max output tokens setting shared by both providers\n// - No temperature/top-p controls\n\nimport {\n  PROVIDERS,\n  DEFAULTS,\n  storageBackendName,\n  getDefaultProvider,\n  setDefaultProvider,\n  getMaxOutputTokens,\n  setMaxOutputTokens,\n  getConcurrencyLimit,\n  setConcurrencyLimit,\n  getRpmLimit,\n  setRpmLimit,\n  getOnboardingSeen,\n  setOnboardingSeen,\n  getOnboardingKeysConfirmed,\n  setOnboardingKeysConfirmed,\n  getSectionOrder,\n  setSectionOrder,\n  getHiddenSections,\n  setHiddenSections,\n  hasApiKey,\n  setApiKey,\n  clearApiKey,\n  getModel,\n  setModel,\n  getGeminiReasoningEffort,\n  setGeminiReasoningEffort,\n  getOpenAIReasoningEffort,\n  setOpenAIReasoningEffort,\n  getPrivacyMode,\n  setPrivacyMode,\n  getRequestLog,\n  clearRequestLog,\n  getUsageTotals,\n  clearUsageTotals,\n  getRuntimeStatus,\n  getPersistentCacheStats,\n  redactSensitiveText,\n  redactSensitiveValue\n} from \"../shared/core\";\n\nimport { aiMinimalTest, clearAllCaches, stopQueuedRequests } from \"../shared/providers\";\n\nimport {\n  activateLicense,\n  validateLicense,\n  getStoredLicense,\n  saveStoredLicense,\n  clearStoredLicense,\n  isLicenseValid\n} from \"../license\";\n\nfunction el(id) {\n  return document.getElementById(id);\n}\n\nfunction setStatus(line, detailsObj) {\n  const safeLine = redactSensitiveText(line || \"\");\n  el(\"statusLine\").textContent = safeLine;\n  if (detailsObj) {\n    try {\n      const safeDetails = redactSensitiveValue(detailsObj);\n      el(\"statusDetails\").textContent = JSON.stringify(safeDetails, null, 2);\n    } catch {\n      el(\"statusDetails\").textContent = redactSensitiveText(detailsObj);\n    }\n  } else {\n    el(\"statusDetails\").textContent = \"\";\n  }\n}\n\nfunction showToast(message, options = {}) {\n  const { duration = 2600 } = options;\n  const toast = el(\"statusToast\");\n  if (!toast) return;\n  toast.textContent = message || \"\";\n  toast.classList.add(\"is-visible\");\n  if (toastTimer) {\n    clearTimeout(toastTimer);\n    toastTimer = null;\n  }\n  toastTimer = setTimeout(() => {\n    toast.classList.remove(\"is-visible\");\n  }, duration);\n}\n\nfunction formatNumber(value) {\n  const n = Number(value);\n  if (!Number.isFinite(n)) return \"0\";\n  return Math.round(n).toLocaleString(\"en-US\");\n}\n\nconst CURRENCY_SYMBOL = \"\";\nconst COST_ICON = \"$\";\nconst REASON_ICON = \"\\uD83E\\uDDE0\";\nconst TOKEN_IN_ICON = \"IN\";\nconst TOKEN_REASON_ICON = \"REF\";\nconst TOKEN_OUT_ICON = \"OUT\";\nconst TOKEN_CACHED_ICON = \"CACHE\";\nconst LICENSE_PLACEHOLDER = \"AAAA-BBBB-CCCC-DDDD\";\n\nconst FAVORITE_ICON = \"\\u2605\";\n\nfunction formatCost(value) {\n  const n = Number(value);\n  if (!Number.isFinite(n)) return `${CURRENCY_SYMBOL}0.0000`;\n  return `${CURRENCY_SYMBOL}${n.toFixed(4)}`;\n}\n\nfunction formatCostTotal(value) {\n  const n = Number(value);\n  if (!Number.isFinite(n)) return `0,00${CURRENCY_SYMBOL}`;\n  return `${n.toFixed(2).replace(\".\", \",\")}${CURRENCY_SYMBOL}`;\n}\n\nfunction formatCostCents(value) {\n  const n = Number(value);\n  if (!Number.isFinite(n) || n <= 0) return \"00c\";\n  const cents = Math.max(0, Math.round(n * 100));\n  return `${String(cents).padStart(2, \"0\")}c`;\n}\n\nfunction formatDuration(ms) {\n  const n = Number(ms);\n  if (!Number.isFinite(n)) return \"0.00s\";\n  return `${(n / 1000).toFixed(2)}s`;\n}\n\nfunction formatTime(ts) {\n  try {\n    const d = new Date(ts);\n    return d.toLocaleTimeString(\"fr-FR\", { hour: \"2-digit\", minute: \"2-digit\" });\n  } catch {\n    return \"--:--\";\n  }\n}\n\nfunction formatDate(ts) {\n  try {\n    const d = new Date(ts);\n    return d.toLocaleDateString(\"fr-FR\", { year: \"numeric\", month: \"short\", day: \"2-digit\" });\n  } catch {\n    return \"\";\n  }\n}\n\nfunction formatBytes(bytes) {\n  const n = Number(bytes);\n  if (!Number.isFinite(n) || n <= 0) return \"0 KB\";\n  if (n < 1024) return `${n} B`;\n  if (n < 1024 * 1024) return `${(n / 1024).toFixed(1)} KB`;\n  return `${(n / (1024 * 1024)).toFixed(2)} MB`;\n}\n\nfunction getSectionKey(section) {\n  return String(section?.dataset?.section || \"\").trim();\n}\n\nfunction getSectionTitle(section) {\n  const label = section?.dataset?.sectionTitle;\n  if (label) return label;\n  const title = section?.querySelector?.(\".card__title\");\n  return title ? title.textContent.trim() : getSectionKey(section);\n}\n\nfunction isSectionLocked(section) {\n  return section?.dataset?.sectionLocked === \"true\";\n}\n\nfunction normalizeSectionOrder(storedOrder, keysInDom) {\n  const order = [];\n  const seen = new Set();\n  if (Array.isArray(storedOrder)) {\n    for (const key of storedOrder) {\n      if (!key || seen.has(key) || !sectionElements.has(key)) continue;\n      seen.add(key);\n      order.push(key);\n    }\n  }\n  for (const key of keysInDom) {\n    if (!key || seen.has(key)) continue;\n    seen.add(key);\n    order.push(key);\n  }\n  return order;\n}\n\nfunction applySectionOrder(order) {\n  if (!sectionMain) sectionMain = document.querySelector(\".app__main\");\n  if (!sectionMain) return;\n  const settingsCard = document.querySelector(SECTION_SETTINGS_SELECTOR);\n  for (const key of order) {\n    const section = sectionElements.get(key);\n    if (!section) continue;\n    if (settingsCard) sectionMain.insertBefore(section, settingsCard);\n    else sectionMain.appendChild(section);\n  }\n}\n\nfunction applySectionVisibility(hidden) {\n  sectionElements.forEach((section, key) => {\n    const locked = isSectionLocked(section);\n    const shouldHide = hidden.has(key) && !locked;\n    section.classList.toggle(SECTION_HIDDEN_CLASS, shouldHide);\n  });\n}\n\nfunction pruneHiddenSections() {\n  let changed = false;\n  for (const key of Array.from(hiddenSections)) {\n    const section = sectionElements.get(key);\n    if (!section || isSectionLocked(section)) {\n      hiddenSections.delete(key);\n      changed = true;\n    }\n  }\n  if (changed) void setHiddenSections(Array.from(hiddenSections));\n}\n\nfunction updateSectionOrder(nextOrder, options = {}) {\n  const { persist = true } = options;\n  sectionOrder = nextOrder.slice();\n  applySectionOrder(sectionOrder);\n  renderSectionManager();\n  if (persist) void setSectionOrder(sectionOrder);\n}\n\nfunction resetSectionOrder() {\n  if (!defaultSectionOrder.length) return;\n  updateSectionOrder(defaultSectionOrder);\n}\n\nfunction updateHiddenSections(nextHidden, options = {}) {\n  const { persist = true } = options;\n  hiddenSections = new Set(nextHidden);\n  pruneHiddenSections();\n  applySectionVisibility(hiddenSections);\n  renderSectionManager();\n  if (persist) void setHiddenSections(Array.from(hiddenSections));\n  updateOnboardingVisibility();\n}\n\nfunction moveSection(key, delta) {\n  const idx = sectionOrder.indexOf(key);\n  if (idx < 0) return;\n  const nextIdx = idx + delta;\n  if (nextIdx < 0 || nextIdx >= sectionOrder.length) return;\n  const next = sectionOrder.slice();\n  next.splice(idx, 1);\n  next.splice(nextIdx, 0, key);\n  updateSectionOrder(next);\n}\n\nfunction reorderSectionList(order, draggedKey, targetKey, before) {\n  const next = order.filter((key) => key !== draggedKey);\n  const targetIndex = next.indexOf(targetKey);\n  if (targetIndex < 0) {\n    next.push(draggedKey);\n    return next;\n  }\n  const insertIndex = before ? targetIndex : targetIndex + 1;\n  next.splice(insertIndex, 0, draggedKey);\n  return next;\n}\n\nfunction moveSectionToEnd(order, key) {\n  const next = order.filter((item) => item !== key);\n  next.push(key);\n  return next;\n}\n\nfunction clearDropIndicators(list) {\n  list.querySelectorAll(\".section-row\").forEach((row) => {\n    row.classList.remove(\"is-drop-before\", \"is-drop-after\");\n  });\n}\n\nfunction clearDragState(list) {\n  list.querySelectorAll(\".section-row\").forEach((row) => {\n    row.classList.remove(\"is-drop-before\", \"is-drop-after\", \"is-dragging\");\n  });\n}\n\nfunction renderSectionManager() {\n  const list = el(\"sectionManagerList\");\n  if (!list) return;\n  list.innerHTML = \"\";\n\n  const order = sectionOrder.length ? sectionOrder : Array.from(sectionElements.keys());\n  order.forEach((key, index) => {\n    const section = sectionElements.get(key);\n    if (!section) return;\n\n    const label = getSectionTitle(section);\n    const locked = isSectionLocked(section);\n    const visible = !hiddenSections.has(key) || locked;\n\n    const row = document.createElement(\"div\");\n    row.className = \"section-row\";\n    row.dataset.sectionKey = key;\n    row.setAttribute(\"role\", \"listitem\");\n\n    const handle = document.createElement(\"button\");\n    handle.type = \"button\";\n    handle.className = \"section-row__handle\";\n    handle.draggable = true;\n    handle.setAttribute(\"title\", \"Glisser pour dplacer\");\n    handle.setAttribute(\"aria-label\", `Dplacer ${label}`);\n\n    const labelEl = document.createElement(\"div\");\n    labelEl.className = \"section-row__label\";\n    labelEl.textContent = label;\n\n    const controls = document.createElement(\"div\");\n    controls.className = \"section-row__controls\";\n\n    const upBtn = document.createElement(\"button\");\n    upBtn.type = \"button\";\n    upBtn.className = \"move-btn move-btn--up\";\n    upBtn.disabled = index === 0;\n    upBtn.setAttribute(\"title\", \"Monter\");\n    upBtn.setAttribute(\"aria-label\", `Monter ${label}`);\n    upBtn.addEventListener(\"click\", () => moveSection(key, -1));\n\n    const downBtn = document.createElement(\"button\");\n    downBtn.type = \"button\";\n    downBtn.className = \"move-btn move-btn--down\";\n    downBtn.disabled = index === order.length - 1;\n    downBtn.setAttribute(\"title\", \"Descendre\");\n    downBtn.setAttribute(\"aria-label\", `Descendre ${label}`);\n    downBtn.addEventListener(\"click\", () => moveSection(key, 1));\n\n    const toggleWrap = document.createElement(\"label\");\n    toggleWrap.className = \"visibility-toggle\";\n    toggleWrap.setAttribute(\"title\", locked ? \"Toujours visible\" : visible ? \"Masquer\" : \"Afficher\");\n    const toggleInput = document.createElement(\"input\");\n    toggleInput.type = \"checkbox\";\n    toggleInput.checked = visible;\n    toggleInput.disabled = locked;\n    toggleInput.setAttribute(\"aria-label\", locked ? `${label} toujours visible` : `Afficher ${label}`);\n    const toggleSlider = document.createElement(\"span\");\n    toggleSlider.className = \"visibility-toggle__slider\";\n    toggleWrap.appendChild(toggleInput);\n    toggleWrap.appendChild(toggleSlider);\n    toggleInput.addEventListener(\"change\", () => {\n      if (locked) return;\n      if (toggleInput.checked) hiddenSections.delete(key);\n      else hiddenSections.add(key);\n      applySectionVisibility(hiddenSections);\n      void setHiddenSections(Array.from(hiddenSections));\n      renderSectionManager();\n    });\n\n    controls.appendChild(upBtn);\n    controls.appendChild(downBtn);\n    if (locked) {\n      const lockTag = document.createElement(\"span\");\n      lockTag.className = \"section-row__lock\";\n      lockTag.textContent = \"Fixe\";\n      lockTag.setAttribute(\"title\", \"Toujours visible\");\n      controls.appendChild(lockTag);\n    }\n    controls.appendChild(toggleWrap);\n\n    row.appendChild(handle);\n    row.appendChild(labelEl);\n    row.appendChild(controls);\n    list.appendChild(row);\n  });\n}\n\nfunction initSectionDrag() {\n  const list = el(\"sectionManagerList\");\n  if (!list) return;\n\n  list.addEventListener(\"dragstart\", (event) => {\n    const handle = event.target.closest(\".section-row__handle\");\n    if (!handle) return;\n    const row = handle.closest(\".section-row\");\n    if (!row) return;\n    draggingSectionKey = row.dataset.sectionKey || \"\";\n    row.classList.add(\"is-dragging\");\n    if (event.dataTransfer) {\n      event.dataTransfer.effectAllowed = \"move\";\n      event.dataTransfer.setData(\"text/plain\", draggingSectionKey);\n    }\n  });\n\n  list.addEventListener(\"dragover\", (event) => {\n    if (!draggingSectionKey) return;\n    event.preventDefault();\n    const row = event.target.closest(\".section-row\");\n    if (!row || row.dataset.sectionKey === draggingSectionKey) return;\n    clearDropIndicators(list);\n    const rect = row.getBoundingClientRect();\n    const before = event.clientY < rect.top + rect.height / 2;\n    row.classList.toggle(\"is-drop-before\", before);\n    row.classList.toggle(\"is-drop-after\", !before);\n  });\n\n  list.addEventListener(\"dragleave\", (event) => {\n    const row = event.target.closest(\".section-row\");\n    if (!row) return;\n    row.classList.remove(\"is-drop-before\", \"is-drop-after\");\n  });\n\n  list.addEventListener(\"drop\", (event) => {\n    if (!draggingSectionKey) return;\n    event.preventDefault();\n    const row = event.target.closest(\".section-row\");\n    const targetKey = row ? row.dataset.sectionKey || \"\" : \"\";\n    const key = draggingSectionKey;\n    draggingSectionKey = \"\";\n    clearDragState(list);\n\n    let nextOrder = sectionOrder.slice();\n    if (!targetKey) {\n      nextOrder = moveSectionToEnd(nextOrder, key);\n    } else {\n      const rect = row.getBoundingClientRect();\n      const before = event.clientY < rect.top + rect.height / 2;\n      nextOrder = reorderSectionList(nextOrder, key, targetKey, before);\n    }\n    updateSectionOrder(nextOrder);\n  });\n\n  list.addEventListener(\"dragend\", () => {\n    draggingSectionKey = \"\";\n    clearDragState(list);\n  });\n}\n\nasync function initSectionManager() {\n  sectionMain = document.querySelector(\".app__main\");\n  if (!sectionMain) return;\n  const sections = Array.from(sectionMain.querySelectorAll(SECTION_SELECTOR));\n  sectionElements = new Map();\n  sections.forEach((section) => {\n    const key = getSectionKey(section);\n    if (key) sectionElements.set(key, section);\n  });\n\n  const storedOrder = await getSectionOrder();\n  const domKeys = sections.map((section) => getSectionKey(section)).filter(Boolean);\n  defaultSectionOrder = domKeys.slice();\n  sectionOrder = normalizeSectionOrder(storedOrder, domKeys);\n  applySectionOrder(sectionOrder);\n\n  hiddenSections = new Set(await getHiddenSections());\n  pruneHiddenSections();\n  applySectionVisibility(hiddenSections);\n\n  renderSectionManager();\n  initSectionDrag();\n}\n\nconst TOKEN_EXP_MIN = 7;\nconst TOKEN_EXP_MAX = 17;\nconst MAX_OUTPUT_TOKENS = 128000;\nconst CONCURRENCY_LEVELS = [4, 8, 16, 32, 64, 128];\nconst RPM_MIN = 0;\nconst RPM_MAX = 100000;\nconst UNKNOWN_MODEL_LABEL = \"modele inconnu\";\nconst GEMINI_REASONING_LEVELS = [\"auto\", \"minimal\", \"low\", \"medium\", \"high\"];\nconst OPENAI_REASONING_LEVELS = [\"none\", \"minimal\", \"low\", \"medium\", \"high\"];\nconst HELP_SELECTOR = \"[data-help]\";\nconst SECTION_SELECTOR = \"[data-section]\";\nconst SECTION_SETTINGS_SELECTOR = \"[data-section-settings]\";\nconst SECTION_HIDDEN_CLASS = \"is-section-hidden\";\nconst KEY_INPUT_SELECTOR = \"[data-key-input]\";\nconst KEY_STATUS_SELECTOR = \"[data-key-status]\";\nconst KEY_SAVE_SELECTOR = \"[data-key-save]\";\nconst LICENSE_INPUT_SELECTOR = \"[data-license-input]\";\nconst LICENSE_STATUS_SELECTOR = \"[data-license-status]\";\nconst LICENSE_META_SELECTOR = \"[data-license-meta]\";\n\nlet keyState = { gemini: false, openai: false };\nlet licenseState = null;\nlet licenseEntryChoice = null;\nlet keysLoaded = false;\nlet licenseLoaded = false;\nlet onboardingKeysConfirmed = false;\nlet onboardingKeysLoaded = false;\nlet privacyModeEnabled = false;\nlet sectionOrder = [];\nlet defaultSectionOrder = [];\nlet hiddenSections = new Set();\nlet sectionElements = new Map();\nlet draggingSectionKey = \"\";\nlet sectionMain = null;\nconst expandedLogKeys = new Set();\nlet toastTimer = null;\nlet logErrorsOnly = false;\nlet lastUsageLogs = [];\nlet rpmLimitValue = DEFAULTS.rpmLimit;\n\nconst DEFAULT_MODELS = {\n  gemini: DEFAULTS.geminiModel,\n  openai: DEFAULTS.openaiModel\n};\n\nconst MODEL_CATALOG = {\n  gemini: [\n    {\n      id: \"gemini-3-pro-preview\",\n      label: \"Gemini 3 Pro Preview\",\n      prices: { input: 2, output: 12, cachedInput: 0.2 },\n      costLevel: 3,\n      reasoningLevel: 3,\n      warning: true\n    },\n    {\n      id: \"gemini-3-flash-preview\",\n      label: \"Gemini 3 Flash Preview\",\n      prices: { input: 0.5, output: 3, cachedInput: 0.05 },\n      costLevel: 2,\n      reasoningLevel: 2,\n      recommended: true\n    },\n    {\n      id: \"gemini-2.5-flash-lite\",\n      label: \"Gemini 2.5 Flash Lite\",\n      prices: { input: 0.1, output: 0.4, cachedInput: 0.01 },\n      costLevel: 1,\n      reasoningLevel: 1\n    }\n  ],\n  openai: [\n    {\n      id: \"gpt-5.2\",\n      label: \"GPT-5.2\",\n      prices: { input: 1.75, output: 14, cachedInput: 0.175 },\n      costLevel: 3,\n      reasoningLevel: 3,\n      supportsReasoningNone: true,\n      warning: true\n    },\n    {\n      id: \"gpt-5-mini\",\n      label: \"GPT-5 Mini\",\n      prices: { input: 0.25, output: 2, cachedInput: 0.025 },\n      costLevel: 2,\n      reasoningLevel: 2,\n      recommended: true,\n      supportsReasoningNone: false\n    },\n    {\n      id: \"gpt-5-nano\",\n      label: \"GPT-5 Nano\",\n      prices: { input: 0.05, output: 0.4, cachedInput: 0.005 },\n      costLevel: 1,\n      reasoningLevel: 1,\n      supportsReasoningNone: false\n    }\n  ]\n};\n\nconst MODEL_LOOKUP = {\n  gemini: new Map(MODEL_CATALOG.gemini.map((m) => [m.id.toLowerCase(), m])),\n  openai: new Map(MODEL_CATALOG.openai.map((m) => [m.id.toLowerCase(), m]))\n};\n\nconst PROVIDER_LABELS = {\n  gemini: \"Gemini\",\n  openai: \"OpenAI\"\n};\n\nfunction repeatIcon(icon, level) {\n  const count = Math.max(1, Number(level) || 1);\n  return new Array(count + 1).join(icon);\n}\n\nfunction getModelMeta(provider, model) {\n  const p = String(provider || \"\").toLowerCase();\n  const key = String(model || \"\").trim().toLowerCase();\n  const map = MODEL_LOOKUP[p];\n  if (map && key && map.has(key)) return map.get(key);\n  const fallback = DEFAULT_MODELS[p];\n  if (map && fallback && map.has(fallback.toLowerCase())) return map.get(fallback.toLowerCase());\n  return null;\n}\n\nfunction openaiModelAllowsNone(model) {\n  const key = String(model || \"\").trim().toLowerCase();\n  const meta = MODEL_LOOKUP.openai?.get(key);\n  if (meta && typeof meta.supportsReasoningNone === \"boolean\") return meta.supportsReasoningNone;\n  return true;\n}\n\nfunction getGeminiAllowedReasoningLevels(modelId) {\n  const key = String(modelId || \"\").trim().toLowerCase();\n  if (key.includes(\"gemini-3\") && key.includes(\"flash\")) {\n    return [\"auto\", \"minimal\", \"low\", \"medium\", \"high\"];\n  }\n  if (key.includes(\"gemini-3\")) {\n    return [\"auto\", \"low\", \"high\"];\n  }\n  if (key.includes(\"gemini-2.5\")) {\n    return [\"auto\", \"minimal\", \"low\", \"medium\", \"high\"];\n  }\n  return [\"auto\", \"low\", \"high\"];\n}\n\nfunction coerceReasoningLabel(label, allowed, levels) {\n  if (!label) return allowed[0] || \"\";\n  if (allowed.includes(label)) return label;\n  const idx = levels.indexOf(label);\n  if (idx < 0) return allowed[0] || \"\";\n  let best = allowed[0] || \"\";\n  let bestDist = Number.POSITIVE_INFINITY;\n  for (const option of allowed) {\n    const optIdx = levels.indexOf(option);\n    if (optIdx < 0) continue;\n    const dist = Math.abs(optIdx - idx);\n    if (dist < bestDist) {\n      bestDist = dist;\n      best = option;\n    }\n  }\n  return best;\n}\n\nfunction syncGeminiReasoningEffort(modelId, preferred) {\n  const effortEl = el(\"geminiReasoningEffort\");\n  if (!effortEl) return \"\";\n  const allowed = getGeminiAllowedReasoningLevels(modelId);\n  let label = getReasoningEffortLabel(preferred, GEMINI_REASONING_LEVELS);\n  if (!label) label = GEMINI_REASONING_LEVELS[0];\n  if (!allowed.includes(label)) {\n    if (label === \"minimal\") label = \"low\";\n    if (label === \"medium\") label = \"high\";\n  }\n  label = coerceReasoningLabel(label, allowed, GEMINI_REASONING_LEVELS);\n  const index = GEMINI_REASONING_LEVELS.indexOf(label);\n  effortEl.value = String(index >= 0 ? index : 0);\n  effortEl.setAttribute(\"aria-valuetext\", label);\n  return label;\n}\n\nfunction getReasoningEffortLabel(value, levels = OPENAI_REASONING_LEVELS) {\n  const raw = String(value || \"\").trim().toLowerCase();\n  if (!raw) return \"\";\n  const idx = Number(raw);\n  if (Number.isFinite(idx)) {\n    const clamped = Math.min(levels.length - 1, Math.max(0, Math.round(idx)));\n    return levels[clamped] || \"\";\n  }\n  return raw;\n}\n\nfunction syncOpenAIReasoningEffort(modelId, preferred) {\n  const effortEl = el(\"openaiReasoningEffort\");\n  if (!effortEl) return \"\";\n  const allowNone = openaiModelAllowsNone(modelId);\n  const wrap = effortEl.closest(\".reasoning\");\n  if (wrap) wrap.classList.toggle(\"reasoning--no-none\", !allowNone);\n  effortEl.dataset.allowNone = allowNone ? \"1\" : \"0\";\n\n  const allowed = allowNone ? OPENAI_REASONING_LEVELS : OPENAI_REASONING_LEVELS.slice(1);\n  let next = getReasoningEffortLabel(preferred);\n  if (!allowed.includes(next)) {\n    next = allowed[0] || \"minimal\";\n  }\n  const index = OPENAI_REASONING_LEVELS.indexOf(next);\n  effortEl.value = String(index >= 0 ? index : 0);\n  effortEl.setAttribute(\"aria-valuetext\", next);\n  return next;\n}\n\nfunction formatRate(value) {\n  const n = Number(value);\n  if (!Number.isFinite(n)) return `${CURRENCY_SYMBOL}0`;\n  const decimals = n >= 1 ? 2 : 3;\n  let text = n.toFixed(decimals);\n  text = text.replace(/\\.?0+$/, \"\");\n  return `${CURRENCY_SYMBOL}${text}`;\n}\n\nfunction modelIndicators(meta) {\n  return {\n    cost: repeatIcon(COST_ICON, meta.costLevel),\n    reasoning: repeatIcon(REASON_ICON, meta.reasoningLevel)\n  };\n}\n\nfunction modelOptionLabel(meta) {\n  const indicators = modelIndicators(meta);\n  const favorite = meta.recommended ? `${FAVORITE_ICON} ` : \"\";\n  const warning = meta.warning ? \"! \" : \"\";\n  return `${warning}${favorite}${meta.id} | ${indicators.cost} | ${indicators.reasoning}`;\n}\n\nfunction updateModelWarningBadge(provider, modelId) {\n  const isGemini = provider === PROVIDERS.GEMINI;\n  const selectEl = isGemini ? el(\"geminiModel\") : el(\"openaiModel\");\n  const warningEl = isGemini ? el(\"geminiModelWarning\") : el(\"openaiModelWarning\");\n  if (!selectEl || !warningEl) return;\n  const meta = getModelMeta(provider, modelId || selectEl.value);\n  const show = !!meta?.warning;\n  warningEl.classList.toggle(\"is-hidden\", !show);\n  selectEl.classList.toggle(\"input--warning\", show);\n}\n\nfunction estimateCost(entry) {\n  if (!entry) return 0;\n  if (entry.batch && Array.isArray(entry.batchModels)) {\n    return entry.batchModels.reduce((sum, item) => {\n      if (!item) return sum;\n      return sum + estimateCost({\n        provider: item.provider,\n        model: item.model,\n        inputTokens: item.inputTokens,\n        outputTokens: item.outputTokens,\n        reasoningTokens: item.reasoningTokens,\n        cachedInputTokens: item.cachedInputTokens\n      });\n    }, 0);\n  }\n  const provider = String(entry.provider || \"\").toLowerCase();\n  const meta = getModelMeta(provider, entry.model);\n  if (!meta) return 0;\n\n  const inputTokens = Math.max(0, Number(entry.inputTokens || 0));\n  const outputTokens = Math.max(0, Number(entry.outputTokens || 0));\n  const reasoningTokens = Math.max(0, Number(entry.reasoningTokens || 0));\n  const cachedInputTokens = Math.max(0, Number(entry.cachedInputTokens || 0));\n  const billableOutputTokens = outputTokens + reasoningTokens;\n\n  const cached = Math.min(cachedInputTokens, inputTokens);\n  const uncached = Math.max(0, inputTokens - cached);\n\n  const prices = meta.prices || {};\n  const inputRate = Number(prices.input || 0);\n  const cachedRate = Number(prices.cachedInput ?? prices.input ?? 0);\n  const outputRate = Number(prices.output || 0);\n\n  return (uncached / 1e6) * inputRate + (cached / 1e6) * cachedRate + (billableOutputTokens / 1e6) * outputRate;\n}\n\nfunction coerceCount(value) {\n  const n = Number(value);\n  if (!Number.isFinite(n) || n <= 0) return 0;\n  return Math.floor(n);\n}\n\nfunction buildUsageFromTotals(totals) {\n  const safeTotals = totals && typeof totals === \"object\" ? totals : {};\n  const breakdown = {\n    gemini: { tokens: 0, cost: 0, models: new Map() },\n    openai: { tokens: 0, cost: 0, models: new Map() }\n  };\n\n  const total = {\n    inputTokens: coerceCount(safeTotals.inputTokens),\n    reasoningTokens: coerceCount(safeTotals.reasoningTokens),\n    outputTokens: coerceCount(safeTotals.outputTokens),\n    cachedInputTokens: coerceCount(safeTotals.cachedInputTokens),\n    cost: 0,\n    requests: coerceCount(safeTotals.requests),\n    byProvider: {\n      gemini: { tokens: 0, cost: 0 },\n      openai: { tokens: 0, cost: 0 }\n    }\n  };\n\n  const providerSums = {\n    gemini: { input: 0, output: 0, reasoning: 0, cached: 0 },\n    openai: { input: 0, output: 0, reasoning: 0, cached: 0 }\n  };\n\n  for (const provider of [PROVIDERS.GEMINI, PROVIDERS.OPENAI]) {\n    const providerTotals = safeTotals.byProvider && typeof safeTotals.byProvider === \"object\" ? safeTotals.byProvider[provider] : null;\n    const inputTokens = coerceCount(providerTotals?.inputTokens);\n    const outputTokens = coerceCount(providerTotals?.outputTokens);\n    const reasoningTokens = coerceCount(providerTotals?.reasoningTokens);\n    const cachedInputTokens = coerceCount(providerTotals?.cachedInputTokens);\n    providerSums[provider] = { input: inputTokens, output: outputTokens, reasoning: reasoningTokens, cached: cachedInputTokens };\n\n    const models = providerTotals?.models && typeof providerTotals.models === \"object\" ? providerTotals.models : {};\n    let providerTokens = 0;\n    let providerCost = 0;\n\n    for (const [key, value] of Object.entries(models)) {\n      if (!value || typeof value !== \"object\") continue;\n      const modelInput = coerceCount(value.inputTokens);\n      const modelOutput = coerceCount(value.outputTokens);\n      const modelReasoning = coerceCount(value.reasoningTokens);\n      const modelCached = coerceCount(value.cachedInputTokens);\n      const tokens = modelInput + modelOutput + modelReasoning;\n      if (tokens <= 0 && modelCached <= 0) continue;\n\n      const rawLabel = typeof value.label === \"string\" ? value.label : \"\";\n      const modelKey = String(key || \"\").trim();\n      const modelId = (rawLabel || modelKey).trim();\n      const isUnknown = !modelId || modelId.toLowerCase() === \"unknown\";\n      const label = isUnknown ? UNKNOWN_MODEL_LABEL : modelId;\n      const cost = estimateCost({\n        provider,\n        model: isUnknown ? \"\" : modelId,\n        inputTokens: modelInput,\n        outputTokens: modelOutput,\n        reasoningTokens: modelReasoning,\n        cachedInputTokens: modelCached\n      });\n\n      const mapKey = label.toLowerCase();\n      const modelEntry = breakdown[provider].models.get(mapKey) || { label, tokens: 0, cost: 0 };\n      modelEntry.tokens += tokens;\n      modelEntry.cost += cost;\n      breakdown[provider].models.set(mapKey, modelEntry);\n\n      providerTokens += tokens;\n      providerCost += cost;\n    }\n\n    if (providerTokens === 0) {\n      providerTokens = inputTokens + outputTokens + reasoningTokens;\n    }\n\n    breakdown[provider].tokens = providerTokens;\n    breakdown[provider].cost = providerCost;\n    total.byProvider[provider].tokens = providerTokens;\n    total.byProvider[provider].cost = providerCost;\n  }\n\n  if (!total.inputTokens) {\n    total.inputTokens = providerSums.gemini.input + providerSums.openai.input;\n  }\n  if (!total.outputTokens) {\n    total.outputTokens = providerSums.gemini.output + providerSums.openai.output;\n  }\n  if (!total.reasoningTokens) {\n    total.reasoningTokens = providerSums.gemini.reasoning + providerSums.openai.reasoning;\n  }\n  if (!total.cachedInputTokens) {\n    total.cachedInputTokens = providerSums.gemini.cached + providerSums.openai.cached;\n  }\n\n  total.cost = total.byProvider.gemini.cost + total.byProvider.openai.cost;\n  return { total, breakdown };\n}\n\nfunction normalizeUsageEntry(entry) {\n  return {\n    provider: entry?.provider || \"\",\n    inputTokens: Number(entry?.inputTokens || 0),\n    outputTokens: Number(entry?.outputTokens || 0),\n    reasoningTokens: Number(entry?.reasoningTokens || 0),\n    cachedInputTokens: Number(entry?.cachedInputTokens || 0),\n    totalTokens: Number(entry?.totalTokens || 0),\n    ok: !!entry?.ok,\n    cache: !!entry?.cache,\n    ms: Number(entry?.ms || 0),\n    fn: entry?.fn || \"AI\",\n    model: entry?.model || \"\",\n    ts: Number(entry?.ts || 0),\n    message: entry?.message || \"\",\n    reasoningEffort: entry?.reasoningEffort || \"\",\n    call: entry?.call || \"\",\n    formula: entry?.formula || \"\"\n  };\n}\n\nfunction populateModelSelect(provider, selectEl, currentModel) {\n  if (!selectEl) return;\n  const list = MODEL_CATALOG[provider] || [];\n  const requested = String(currentModel || \"\").trim();\n  const requestedKey = requested.toLowerCase();\n  const fallback = DEFAULT_MODELS[provider] || \"\";\n\n  selectEl.innerHTML = \"\";\n  let matched = false;\n\n  for (const meta of list) {\n    const option = document.createElement(\"option\");\n    option.value = meta.id;\n    option.textContent = modelOptionLabel(meta);\n    if (meta.warning) {\n      option.dataset.warning = \"1\";\n      option.style.color = \"#b03524\";\n      option.style.fontWeight = \"700\";\n    }\n    if (meta.id.toLowerCase() === requestedKey) {\n      option.selected = true;\n      matched = true;\n    }\n    selectEl.appendChild(option);\n  }\n\n  if (requested && !matched) {\n    const option = document.createElement(\"option\");\n    option.value = requested;\n    option.textContent = `${requested} | hors liste`;\n    option.selected = true;\n    selectEl.appendChild(option);\n    return;\n  }\n\n  if (!requested && fallback) {\n    selectEl.value = fallback;\n  }\n}\n\nfunction renderPricingTable() {\n  const gemBody = el(\"pricingTableBodyGemini\");\n  const oaiBody = el(\"pricingTableBodyOpenAI\");\n  if (!gemBody && !oaiBody) return;\n  if (gemBody) gemBody.innerHTML = \"\";\n  if (oaiBody) oaiBody.innerHTML = \"\";\n\n  const renderProvider = (provider, body) => {\n    if (!body) return;\n    const list = MODEL_CATALOG[provider] || [];\n    for (const meta of list) {\n      const row = document.createElement(\"tr\");\n      const indicators = modelIndicators(meta);\n\n      const cellModel = document.createElement(\"td\");\n      cellModel.textContent = meta.id;\n\n      const cellInput = document.createElement(\"td\");\n      cellInput.className = \"pricing-table__col-price\";\n      cellInput.textContent = formatRate(meta.prices?.input);\n\n      const cellOutput = document.createElement(\"td\");\n      cellOutput.className = \"pricing-table__col-price\";\n      cellOutput.textContent = formatRate(meta.prices?.output);\n\n      const cellCost = document.createElement(\"td\");\n      cellCost.className = \"pricing-table__col-icon\";\n      cellCost.textContent = indicators.cost;\n\n      const cellReason = document.createElement(\"td\");\n      cellReason.className = \"pricing-table__col-icon\";\n      cellReason.textContent = indicators.reasoning;\n\n      row.appendChild(cellModel);\n      row.appendChild(cellInput);\n      row.appendChild(cellOutput);\n      row.appendChild(cellCost);\n      row.appendChild(cellReason);\n      body.appendChild(row);\n    }\n  };\n\n  renderProvider(PROVIDERS.GEMINI, gemBody);\n  renderProvider(PROVIDERS.OPENAI, oaiBody);\n}\n\nfunction setModalOpen(id, isOpen) {\n  const modal = el(id);\n  if (!modal) return;\n  modal.classList.toggle(\"is-open\", isOpen);\n  modal.setAttribute(\"aria-hidden\", isOpen ? \"false\" : \"true\");\n}\n\nfunction isModalOpen(id) {\n  const modal = el(id);\n  return !!modal && modal.classList.contains(\"is-open\");\n}\n\nfunction setSettingsModalOpen(isOpen) {\n  setModalOpen(\"settingsModal\", isOpen);\n}\n\nfunction setPricingModalOpen(isOpen) {\n  setModalOpen(\"pricingModal\", isOpen);\n}\n\nfunction setOnboardingModalOpen(isOpen) {\n  setModalOpen(\"onboardingModal\", isOpen);\n}\n\nfunction setOnboardingKeysModalOpen(isOpen) {\n  setModalOpen(\"onboardingKeysModal\", isOpen);\n}\n\nfunction openPricingModal() {\n  renderPricingTable();\n  setPricingModalOpen(true);\n}\n\nfunction closePricingModal() {\n  setPricingModalOpen(false);\n}\n\nfunction setKeyStatus(provider, hasKey) {\n  const ok = !!hasKey;\n  document.querySelectorAll(`${KEY_STATUS_SELECTOR}[data-key-status=\"${provider}\"]`).forEach((node) => {\n    node.textContent = ok ? \"Cl enregistre\" : \"Cl manquante\";\n    node.classList.toggle(\"key-status--ok\", ok);\n    node.classList.toggle(\"key-status--missing\", !ok);\n  });\n}\n\nfunction updateKeyPlaceholders() {\n  document.querySelectorAll(KEY_INPUT_SELECTOR).forEach((input) => {\n    const provider = String(input.dataset.keyInput || \"\").trim().toLowerCase();\n    if (provider === PROVIDERS.GEMINI) {\n      input.placeholder = keyState.gemini ? \"Cl enregistre (laisser vide pour conserver)\" : \"AIza...\";\n    } else if (provider === PROVIDERS.OPENAI) {\n      input.placeholder = keyState.openai ? \"Cl enregistre (laisser vide pour conserver)\" : \"sk-...\";\n    }\n  });\n}\n\nfunction setKeyState(geminiPresent, openaiPresent) {\n  keyState = {\n    gemini: !!geminiPresent,\n    openai: !!openaiPresent\n  };\n  updateKeyPlaceholders();\n}\n\nfunction hasAnyApiKey() {\n  return !!keyState.gemini || !!keyState.openai;\n}\n\nfunction hasBothApiKeys() {\n  return !!keyState.gemini && !!keyState.openai;\n}\n\nfunction hasCompletedApiSetup() {\n  return hasBothApiKeys() || (onboardingKeysConfirmed && hasAnyApiKey());\n}\n\nfunction hasStoredLicense() {\n  return !!(licenseState && licenseState.key && isLicenseValid(licenseState));\n}\n\nfunction updateOnboardingVisibility() {\n  const section = document.querySelector('[data-section=\"onboarding\"]');\n  if (!section) return;\n  if (!licenseLoaded || !keysLoaded || !onboardingKeysLoaded) return;\n  const shouldShow = !hasStoredLicense() || !hasCompletedApiSetup();\n  section.classList.toggle(\"is-hidden\", !shouldShow);\n  if (shouldShow && section.classList.contains(SECTION_HIDDEN_CLASS)) {\n    hiddenSections.delete(\"onboarding\");\n    updateHiddenSections(Array.from(hiddenSections));\n  }\n}\n\nfunction setModelGate(provider, hasKey) {\n  const isGemini = provider === PROVIDERS.GEMINI;\n  const modelEl = el(isGemini ? \"geminiModel\" : \"openaiModel\");\n  const effortEl = el(isGemini ? \"geminiReasoningEffort\" : \"openaiReasoningEffort\");\n  const gateEl = el(isGemini ? \"geminiModelGate\" : \"openaiModelGate\");\n  const disabled = !hasKey;\n  if (modelEl) modelEl.disabled = disabled;\n  if (effortEl) effortEl.disabled = disabled;\n  if (gateEl) gateEl.classList.toggle(\"is-hidden\", !disabled);\n}\n\nfunction updateConfigProviderGate() {\n  const geminiBtn = el(\"providerGemini\");\n  const openaiBtn = el(\"providerOpenAI\");\n  const hasGemini = !!keyState.gemini;\n  const hasOpenAI = !!keyState.openai;\n\n  if (geminiBtn) geminiBtn.disabled = !hasGemini;\n  if (openaiBtn) openaiBtn.disabled = !hasOpenAI;\n\n  const gateEl = el(\"configProviderGate\");\n  if (!gateEl) return;\n  const textEl = el(\"configProviderGateText\");\n\n  let message = \"\";\n  if (!hasGemini && !hasOpenAI) {\n    message = \"Ajoutez une cl API pour activer Gemini ou OpenAI.\";\n  }\n\n  gateEl.classList.toggle(\"is-hidden\", !message);\n  if (textEl) textEl.textContent = message;\n}\n\nfunction updateModelGates() {\n  setModelGate(PROVIDERS.GEMINI, !!keyState.gemini);\n  setModelGate(PROVIDERS.OPENAI, !!keyState.openai);\n  updateConfigProviderGate();\n}\n\nfunction parseLicenseExpiryMs(expiresAt) {\n  const raw = String(expiresAt || \"\").trim();\n  if (!raw) return 0;\n  const ts = Date.parse(raw);\n  return Number.isFinite(ts) ? ts : 0;\n}\n\nfunction formatLicenseExpiry(expiresAt) {\n  const ts = parseLicenseExpiryMs(expiresAt);\n  if (!ts) return \"\";\n  return formatDate(ts);\n}\n\nfunction licenseStatusSummary(license) {\n  if (!license || !license.key) {\n    return { ok: false, text: \"Aucune licence enregistre\" };\n  }\n\n  if (isLicenseValid(license)) {\n    const expiry = formatLicenseExpiry(license.expiresAt);\n    const suffix = expiry ? `  renouvellement le ${expiry}` : \"\";\n    return { ok: true, text: `Licence active${suffix}` };\n  }\n\n  const expiresAt = parseLicenseExpiryMs(license.expiresAt);\n  const expired = expiresAt && expiresAt <= Date.now();\n  return { ok: false, text: expired ? \"Licence expire\" : \"Licence invalide\" };\n}\n\nfunction setLicenseStatus(node, text, ok) {\n  if (!node) return;\n  node.textContent = text || \"\";\n  node.title = text || \"\";\n  node.setAttribute(\"aria-label\", text || \"\");\n  node.classList.toggle(\"key-status--ok\", ok);\n  node.classList.toggle(\"key-status--missing\", !ok);\n}\n\nfunction setLicenseStatusAll(text, ok) {\n  document.querySelectorAll(LICENSE_STATUS_SELECTOR).forEach((node) => {\n    setLicenseStatus(node, text, ok);\n  });\n}\n\nfunction updateLicenseStatusNodes(license) {\n  const summary = licenseStatusSummary(license);\n  document.querySelectorAll(LICENSE_STATUS_SELECTOR).forEach((node) => {\n    setLicenseStatus(node, summary.text, summary.ok);\n  });\n}\n\nfunction setLicenseEntryVisible(isVisible, options = {}) {\n  const { focus = false, persist = true } = options;\n  const entry = el(\"licenseEntry\");\n  const subscribe = el(\"licenseSubscribe\");\n  if (!entry) return;\n  entry.classList.toggle(\"is-hidden\", !isVisible);\n  if (persist) licenseEntryChoice = isVisible;\n  if (subscribe) subscribe.classList.toggle(\"is-hidden\", isVisible);\n  const subscribeBtn = el(\"licenseModeSubscribe\");\n  const haveBtn = el(\"licenseModeHave\");\n  if (subscribeBtn && haveBtn) {\n    subscribeBtn.classList.toggle(\"segmented__btn--active\", !isVisible);\n    haveBtn.classList.toggle(\"segmented__btn--active\", isVisible);\n    subscribeBtn.setAttribute(\"aria-selected\", !isVisible ? \"true\" : \"false\");\n    haveBtn.setAttribute(\"aria-selected\", isVisible ? \"true\" : \"false\");\n  }\n  if (isVisible && focus) {\n    const input = el(\"licenseKeyInput\");\n    if (input) input.focus();\n  }\n}\n\nfunction updateLicensePlaceholders(license) {\n  const placeholder = license?.key ? \"Cl enregistre (laisser vide pour conserver)\" : LICENSE_PLACEHOLDER;\n  document.querySelectorAll(LICENSE_INPUT_SELECTOR).forEach((input) => {\n    input.placeholder = placeholder;\n  });\n}\n\nfunction updateLicenseMeta(license) {\n  const nodes = document.querySelectorAll(LICENSE_META_SELECTOR);\n  if (!nodes.length) return;\n  let text = \"Cl reue par email aprs achat (mensuel ou annuel)\";\n  if (license && isLicenseValid(license) && license.expiresAt) {\n    const expiry = formatLicenseExpiry(license.expiresAt);\n    text = expiry ? `Renouvellement le ${expiry}` : \"Licence active\";\n  } else if (license && !isLicenseValid(license)) {\n    const expiry = formatLicenseExpiry(license.expiresAt);\n    text = expiry ? `Licence expire le ${expiry}` : \"Licence invalide\";\n  }\n  nodes.forEach((meta) => {\n    meta.textContent = text;\n  });\n}\n\nfunction updateLicenseStepVisibility(license) {\n  const step = el(\"setupLicenseStep\");\n  if (!step) return;\n  const shouldHide = !!(license && isLicenseValid(license));\n  step.classList.toggle(\"is-hidden\", shouldHide);\n}\n\nasync function refreshLicenseUI(options = {}) {\n  const { silent = false } = options;\n  const stored = await getStoredLicense();\n  licenseState = stored;\n  licenseLoaded = true;\n  updateLicenseStatusNodes(stored);\n  const autoVisible = !!(stored && stored.key && !isLicenseValid(stored));\n  const shouldShow = licenseEntryChoice === null ? autoVisible : licenseEntryChoice;\n  setLicenseEntryVisible(shouldShow, { persist: false });\n  updateLicensePlaceholders(stored);\n  updateLicenseMeta(stored);\n  updateLicenseStepVisibility(stored);\n  updateOnboardingVisibility();\n  if (!silent && stored && isLicenseValid(stored)) {\n    setStatus(\"Licence active\", { expiresAt: stored.expiresAt || \"n/a\" });\n  }\n}\n\nfunction clampExp(value) {\n  const n = Number(value);\n  if (!Number.isFinite(n)) return TOKEN_EXP_MIN;\n  return Math.min(TOKEN_EXP_MAX, Math.max(TOKEN_EXP_MIN, Math.round(n)));\n}\n\nfunction expToTokens(exp) {\n  const tokens = 2 ** clampExp(exp);\n  return Math.min(tokens, MAX_OUTPUT_TOKENS);\n}\n\nfunction tokensToExp(tokens) {\n  const n = Number(tokens);\n  if (!Number.isFinite(n) || n <= 0) return TOKEN_EXP_MIN;\n  return clampExp(Math.log2(n));\n}\n\nfunction updateProviderBadge(provider) {\n  const badge = el(\"configProviderBadge\");\n  if (!badge) return;\n  const label = PROVIDER_LABELS[provider] || (provider ? provider.toUpperCase() : \"\");\n  badge.textContent = label;\n  badge.title = `Fournisseur: ${label}`;\n  badge.setAttribute(\"aria-label\", `Fournisseur: ${label}`);\n}\n\nfunction setProviderButtons(provider) {\n  const isGemini = provider === PROVIDERS.GEMINI;\n  el(\"providerGemini\").classList.toggle(\"segmented__btn--active\", isGemini);\n  el(\"providerOpenAI\").classList.toggle(\"segmented__btn--active\", !isGemini);\n  el(\"providerGemini\").setAttribute(\"aria-pressed\", isGemini ? \"true\" : \"false\");\n  el(\"providerOpenAI\").setAttribute(\"aria-pressed\", !isGemini ? \"true\" : \"false\");\n  updateProviderBadge(provider);\n}\n\nfunction getSelectedProvider() {\n  const geminiActive = el(\"providerGemini\").classList.contains(\"segmented__btn--active\");\n  return geminiActive ? PROVIDERS.GEMINI : PROVIDERS.OPENAI;\n}\n\nfunction updateMaxTokensValue() {\n  const exp = clampExp(el(\"maxTokensRange\").value);\n  const tokens = expToTokens(exp);\n  el(\"maxTokensValue\").textContent = formatNumber(tokens);\n  return tokens;\n}\n\nfunction clampConcurrencyIndex(value) {\n  const n = Number(value);\n  if (!Number.isFinite(n)) return 0;\n  return Math.max(0, Math.min(CONCURRENCY_LEVELS.length - 1, Math.round(n)));\n}\n\nfunction concurrencyIndexToValue(index) {\n  return CONCURRENCY_LEVELS[clampConcurrencyIndex(index)];\n}\n\nfunction concurrencyValueToIndex(value) {\n  const n = Number(value);\n  if (!Number.isFinite(n)) return 0;\n  let bestIndex = 0;\n  let bestDiff = Math.abs(CONCURRENCY_LEVELS[0] - n);\n  for (let i = 1; i < CONCURRENCY_LEVELS.length; i += 1) {\n    const diff = Math.abs(CONCURRENCY_LEVELS[i] - n);\n    if (diff < bestDiff) {\n      bestDiff = diff;\n      bestIndex = i;\n    }\n  }\n  return bestIndex;\n}\n\nfunction updateConcurrencyValue() {\n  const index = clampConcurrencyIndex(el(\"concurrencyRange\").value);\n  const value = concurrencyIndexToValue(index);\n  el(\"concurrencyValue\").textContent = formatNumber(value);\n  return value;\n}\n\nfunction normalizeRpmLimitInput(value) {\n  const n = Number(value);\n  if (!Number.isFinite(n)) return DEFAULTS.rpmLimit;\n  return Math.max(RPM_MIN, Math.min(RPM_MAX, Math.round(n)));\n}\n\nfunction updateRpmLimitValue() {\n  const input = el(\"rpmLimitInput\");\n  if (!input) return DEFAULTS.rpmLimit;\n  const value = normalizeRpmLimitInput(input.value);\n  input.value = String(value);\n  return value;\n}\n\nfunction activateTab(tab) {\n  const isGemini = tab === \"gemini\";\n  el(\"tabGemini\").classList.toggle(\"tab--active\", isGemini);\n  el(\"tabOpenAI\").classList.toggle(\"tab--active\", !isGemini);\n\n  el(\"tabGemini\").setAttribute(\"aria-selected\", isGemini ? \"true\" : \"false\");\n  el(\"tabOpenAI\").setAttribute(\"aria-selected\", !isGemini ? \"true\" : \"false\");\n\n  el(\"panelGemini\").classList.toggle(\"tab-panel--active\", isGemini);\n  el(\"panelOpenAI\").classList.toggle(\"tab-panel--active\", !isGemini);\n}\n\nasync function refreshUI(options = {}) {\n  const { preserveKeyInputs = false, silent = false } = options;\n  el(\"storageBackend\").textContent = storageBackendName();\n\n  const [\n    provider,\n    maxTok,\n    concurrencyLimit,\n    rpmLimit,\n    gemModel,\n    oaiModel,\n    gemKeyPresent,\n    oaiKeyPresent,\n    gemReasoningEffort,\n    oaiReasoningEffort,\n    keysConfirmed\n  ] = await Promise.all([\n    getDefaultProvider(),\n    getMaxOutputTokens(),\n    getConcurrencyLimit(),\n    getRpmLimit(),\n    getModel(PROVIDERS.GEMINI),\n    getModel(PROVIDERS.OPENAI),\n    hasApiKey(PROVIDERS.GEMINI),\n    hasApiKey(PROVIDERS.OPENAI),\n    getGeminiReasoningEffort(),\n    getOpenAIReasoningEffort(),\n    getOnboardingKeysConfirmed()\n  ]);\n\n  setProviderButtons(provider);\n\n  const exp = tokensToExp(maxTok);\n  const normalizedTokens = expToTokens(exp);\n  el(\"maxTokensRange\").value = String(exp);\n  el(\"maxTokensValue\").textContent = formatNumber(normalizedTokens);\n  if (normalizedTokens !== maxTok) {\n    await setMaxOutputTokens(normalizedTokens);\n  }\n\n  const concurrencyIndex = concurrencyValueToIndex(concurrencyLimit);\n  const normalizedConcurrency = concurrencyIndexToValue(concurrencyIndex);\n  el(\"concurrencyRange\").value = String(concurrencyIndex);\n  el(\"concurrencyValue\").textContent = formatNumber(normalizedConcurrency);\n  if (normalizedConcurrency !== concurrencyLimit) {\n    await setConcurrencyLimit(normalizedConcurrency);\n  }\n\n  const normalizedRpm = normalizeRpmLimitInput(rpmLimit);\n  rpmLimitValue = normalizedRpm;\n  const rpmInput = el(\"rpmLimitInput\");\n  if (rpmInput) {\n    rpmInput.value = String(normalizedRpm);\n    if (normalizedRpm !== rpmLimit) {\n      await setRpmLimit(normalizedRpm);\n    }\n  }\n\n  // Models\n  const geminiModelEl = el(\"geminiModel\");\n  const openaiModelEl = el(\"openaiModel\");\n  populateModelSelect(PROVIDERS.GEMINI, geminiModelEl, gemModel);\n  populateModelSelect(PROVIDERS.OPENAI, openaiModelEl, oaiModel);\n  const selectedGeminiModel = geminiModelEl ? geminiModelEl.value : gemModel;\n  const selectedOpenAIModel = openaiModelEl ? openaiModelEl.value : oaiModel;\n  const safeGeminiEffort = syncGeminiReasoningEffort(selectedGeminiModel, gemReasoningEffort);\n  if (safeGeminiEffort && safeGeminiEffort !== gemReasoningEffort) {\n    await setGeminiReasoningEffort(safeGeminiEffort);\n  }\n  const safeEffort = syncOpenAIReasoningEffort(selectedOpenAIModel, oaiReasoningEffort);\n  const effectiveEffort = safeEffort || oaiReasoningEffort;\n  if (safeEffort && safeEffort !== oaiReasoningEffort) {\n    await setOpenAIReasoningEffort(safeEffort);\n  }\n\n  updateModelWarningBadge(PROVIDERS.GEMINI, selectedGeminiModel);\n  updateModelWarningBadge(PROVIDERS.OPENAI, selectedOpenAIModel);\n\n  // Keys are not displayed back (security / UX). Use placeholder to indicate presence.\n  if (!preserveKeyInputs) {\n    document.querySelectorAll(KEY_INPUT_SELECTOR).forEach((input) => {\n      input.value = \"\";\n    });\n  }\n\n  setKeyState(gemKeyPresent, oaiKeyPresent);\n  onboardingKeysConfirmed = !!keysConfirmed;\n  onboardingKeysLoaded = true;\n  if (!gemKeyPresent && !oaiKeyPresent && keysConfirmed) {\n    onboardingKeysConfirmed = false;\n    await setOnboardingKeysConfirmed(false);\n  }\n  keysLoaded = true;\n\n  setKeyStatus(PROVIDERS.GEMINI, gemKeyPresent);\n  setKeyStatus(PROVIDERS.OPENAI, oaiKeyPresent);\n  updateModelGates();\n  updateOnboardingVisibility();\n\n  if (!silent) {\n    setStatus(\"Configuration charge\", {\n      defaultProvider: provider,\n      maxOutputTokens: normalizedTokens,\n      gemini: { key: gemKeyPresent ? \"set\" : \"missing\", model: gemModel, reasoningEffort: safeGeminiEffort },\n      openai: { key: oaiKeyPresent ? \"set\" : \"missing\", model: oaiModel, reasoningEffort: effectiveEffort }\n    });\n  }\n}\n\nfunction buildBreakdownRow(label, tokens, cost, isSub) {\n  const row = document.createElement(\"div\");\n  row.className = `breakdown__row ${isSub ? \"breakdown__row--sub\" : \"breakdown__row--total\"}`;\n\n  const name = document.createElement(\"div\");\n  name.className = \"breakdown__name\";\n  if (isSub) {\n    const model = document.createElement(\"span\");\n    model.className = \"breakdown__model\";\n    model.textContent = label;\n    name.appendChild(model);\n  } else {\n    name.textContent = label;\n  }\n\n  const tokensEl = document.createElement(\"div\");\n  tokensEl.className = \"breakdown__tokens\";\n  tokensEl.textContent = `${formatNumber(tokens)} tokens`;\n\n  const costEl = document.createElement(\"div\");\n  costEl.className = \"breakdown__cost\";\n  costEl.textContent = formatCost(cost);\n\n  row.appendChild(name);\n  row.appendChild(tokensEl);\n  row.appendChild(costEl);\n  return row;\n}\n\nfunction renderUsageBreakdown(breakdown) {\n  const container = el(\"usageBreakdown\");\n  if (!container) return;\n  container.innerHTML = \"\";\n\n  const providers = [PROVIDERS.GEMINI, PROVIDERS.OPENAI];\n  for (const provider of providers) {\n    const data = breakdown[provider] || { tokens: 0, cost: 0, models: new Map() };\n    container.appendChild(buildBreakdownRow(PROVIDER_LABELS[provider] || provider, data.tokens, data.cost, false));\n\n    const models = Array.from(data.models.values())\n      .filter((model) => (model.tokens || 0) > 0 || (model.cost || 0) > 0)\n      .sort((a, b) => b.tokens - a.tokens || a.label.localeCompare(b.label));\n\n    for (const model of models) {\n      container.appendChild(buildBreakdownRow(model.label, model.tokens, model.cost, true));\n    }\n  }\n}\n\nfunction formatQueueStatusText(total) {\n  const n = Number(total);\n  if (!Number.isFinite(n) || n <= 0) return \"\";\n  return `${formatNumber(n)} requete${n > 1 ? \"s\" : \"\"} en cours`;\n}\n\nfunction formatRpmStatusText(count, limit) {\n  const n = Number(count);\n  if (!Number.isFinite(n) || n <= 0) return \"\";\n  const lim = Number(limit);\n  if (Number.isFinite(lim) && lim > 0) {\n    return `RPM ${formatNumber(n)}/${formatNumber(lim)}`;\n  }\n  return `RPM ${formatNumber(n)}`;\n}\n\nfunction applyRuntimeStatus(status) {\n  const container = el(\"queueStatus\");\n  if (!container) return;\n  const active = Number(status?.active || 0);\n  const queued = Number(status?.queued || 0);\n  const total = Math.max(0, active) + Math.max(0, queued);\n  const rpm = Number(status?.rpm || 0);\n  const showQueue = total > 0;\n  const showRpm = rpm > 0;\n\n  const main = el(\"queueStatusMain\");\n  if (main) main.classList.toggle(\"is-hidden\", !showQueue);\n  const rpmEl = el(\"rpmStatus\");\n  if (rpmEl) rpmEl.classList.toggle(\"is-hidden\", !showRpm);\n\n  if (!showQueue && !showRpm) {\n    container.classList.add(\"is-hidden\");\n    return;\n  }\n  container.classList.remove(\"is-hidden\");\n\n  const textEl = el(\"queueStatusText\");\n  if (textEl) textEl.textContent = formatQueueStatusText(total);\n  const rpmTextEl = el(\"rpmStatusText\");\n  if (rpmTextEl) rpmTextEl.textContent = formatRpmStatusText(rpm, rpmLimitValue);\n  const stopBtn = el(\"queueStop\");\n  if (stopBtn) stopBtn.classList.toggle(\"is-hidden\", queued <= 0);\n}\n\nasync function refreshRuntimeStatus() {\n  const status = await getRuntimeStatus();\n  applyRuntimeStatus(status);\n}\n\nasync function refreshUsage() {\n  const rawLogs = await getRequestLog({ fresh: true });\n  const logs = rawLogs.map(normalizeUsageEntry).sort((a, b) => b.ts - a.ts);\n  lastUsageLogs = logs;\n\n  const usageTotals = await getUsageTotals({ fresh: true });\n  const { total, breakdown } = buildUsageFromTotals(usageTotals);\n\n  el(\"usageTokensTotal\").textContent = formatNumber(total.inputTokens + total.reasoningTokens + total.outputTokens);\n  el(\"usageTokensInTotal\").textContent = formatNumber(total.inputTokens);\n  el(\"usageTokensReasoningTotal\").textContent = formatNumber(total.reasoningTokens);\n  el(\"usageTokensOutTotal\").textContent = formatNumber(total.outputTokens);\n  el(\"usageCostTotal\").textContent = formatCostTotal(total.cost);\n  const summary = el(\"usageSummary\");\n  if (summary) summary.textContent = formatCostTotal(total.cost);\n  el(\"usageCostGemini\").textContent = formatCost(total.byProvider.gemini.cost);\n  el(\"usageCostOpenAI\").textContent = formatCost(total.byProvider.openai.cost);\n\n  renderUsageBreakdown(breakdown);\n  renderLogList(logs);\n  drawUsageChart(logs);\n}\n\nfunction isDocumentHidden() {\n  try {\n    return typeof document !== \"undefined\" && document.hidden;\n  } catch {\n    return false;\n  }\n}\n\nlet refreshUsagePromise = null;\nlet refreshCachePromise = null;\nlet refreshRuntimePromise = null;\n\nasync function refreshUsageGuarded(options = {}) {\n  const { force = false } = options;\n  if (!force && isDocumentHidden()) return;\n  if (refreshUsagePromise) return refreshUsagePromise;\n  refreshUsagePromise = (async () => {\n    await refreshUsage();\n  })();\n  try {\n    return await refreshUsagePromise;\n  } finally {\n    refreshUsagePromise = null;\n  }\n}\n\nasync function refreshCacheStatsGuarded(options = {}) {\n  const { force = false } = options;\n  if (!force && isDocumentHidden()) return;\n  if (refreshCachePromise) return refreshCachePromise;\n  refreshCachePromise = (async () => {\n    await refreshCacheStats();\n  })();\n  try {\n    return await refreshCachePromise;\n  } finally {\n    refreshCachePromise = null;\n  }\n}\n\nasync function refreshRuntimeStatusGuarded(options = {}) {\n  const { force = false } = options;\n  if (!force && isDocumentHidden()) return;\n  if (refreshRuntimePromise) return refreshRuntimePromise;\n  refreshRuntimePromise = (async () => {\n    await refreshRuntimeStatus();\n  })();\n  try {\n    return await refreshRuntimePromise;\n  } finally {\n    refreshRuntimePromise = null;\n  }\n}\n\nfunction getTokenHeatClass(tokensTotal) {\n  const n = Number(tokensTotal || 0);\n  if (n >= 8000) return \"token-heat--extreme\";\n  if (n >= 4000) return \"token-heat--hot\";\n  if (n >= 1500) return \"token-heat--warm\";\n  return \"token-heat--cool\";\n}\n\nfunction logEntryKey(entry) {\n  const formulaText = entry.call || entry.formula || \"\";\n  return [entry.ts || 0, entry.fn || \"\", entry.provider || \"\", entry.model || \"\", formulaText].join(\"|\");\n}\n\nfunction updateLogFilterUI() {\n  const filterBtn = el(\"logFilterErrors\");\n  if (!filterBtn) return;\n  filterBtn.classList.toggle(\"is-active\", logErrorsOnly);\n  filterBtn.setAttribute(\"aria-pressed\", logErrorsOnly ? \"true\" : \"false\");\n}\n\nfunction filterLogEntries(logs) {\n  if (!logErrorsOnly) return logs;\n  return logs.filter((entry) => !entry.ok);\n}\n\nfunction renderLogList(logs) {\n  const list = el(\"logList\");\n  list.innerHTML = \"\";\n\n  const filteredLogs = filterLogEntries(logs || []);\n\n  if (!filteredLogs.length) {\n    const empty = document.createElement(\"div\");\n    empty.className = \"log-item log-item--empty\";\n    empty.textContent = logErrorsOnly\n      ? \"Aucune erreur enregistre pour le moment\"\n      : \"Aucune activit enregistre pour le moment\";\n    list.appendChild(empty);\n    return;\n  }\n\n  const buildTokenFlow = (iconText, value) => {\n    const wrap = document.createElement(\"span\");\n    wrap.className = \"token-flow\";\n\n    const icon = document.createElement(\"span\");\n    icon.className = \"token-flow__icon\";\n    icon.textContent = iconText;\n\n    const val = document.createElement(\"span\");\n    val.className = \"token-flow__value\";\n    val.textContent = formatNumber(value);\n\n    wrap.appendChild(icon);\n    wrap.appendChild(val);\n    return wrap;\n  };\n\n  const slice = filteredLogs.slice(0, 40);\n  const activeKeys = new Set();\n  for (const entry of slice) {\n    const item = document.createElement(\"div\");\n    const cacheClass = entry.cache ? \" log-item--cache\" : \"\";\n    const batchClass = entry.batch ? \" log-item--batch\" : \"\";\n    item.className = `log-item ${entry.ok ? \"log-item--ok\" : \"log-item--error\"}${cacheClass}${batchClass}`;\n\n    const top = document.createElement(\"div\");\n    top.className = \"log-item__top\";\n\n    const title = document.createElement(\"div\");\n    title.className = \"log-item__title\";\n\n    const titleText = document.createElement(\"span\");\n    titleText.className = \"log-item__title-text\";\n    titleText.textContent = entry.fn;\n    title.appendChild(titleText);\n\n    const formulaText = String(entry.call || entry.formula || \"\").trim();\n    let detail = null;\n    if (formulaText) {\n      const entryKey = logEntryKey(entry);\n      activeKeys.add(entryKey);\n      const toggle = document.createElement(\"button\");\n      toggle.className = \"log-item__toggle\";\n      toggle.type = \"button\";\n      toggle.setAttribute(\"aria-expanded\", \"false\");\n      toggle.setAttribute(\"aria-label\", \"Afficher la fonction\");\n\n      const chevron = document.createElement(\"span\");\n      chevron.className = \"log-item__chevron\";\n      toggle.appendChild(chevron);\n\n      const wasExpanded = expandedLogKeys.has(entryKey);\n      if (wasExpanded) {\n        item.classList.add(\"log-item--expanded\");\n        toggle.setAttribute(\"aria-expanded\", \"true\");\n        toggle.setAttribute(\"aria-label\", \"Masquer la fonction\");\n      }\n\n      toggle.addEventListener(\"click\", () => {\n        const isOpen = item.classList.toggle(\"log-item--expanded\");\n        toggle.setAttribute(\"aria-expanded\", isOpen ? \"true\" : \"false\");\n        toggle.setAttribute(\"aria-label\", isOpen ? \"Masquer la fonction\" : \"Afficher la fonction\");\n        if (isOpen) expandedLogKeys.add(entryKey);\n        else expandedLogKeys.delete(entryKey);\n      });\n\n      title.appendChild(toggle);\n\n      detail = document.createElement(\"div\");\n      detail.className = \"log-item__detail\";\n      detail.textContent = formulaText;\n    }\n\n    const tags = document.createElement(\"div\");\n    tags.style.display = \"flex\";\n    tags.style.gap = \"6px\";\n\n    const providerTag = document.createElement(\"span\");\n    providerTag.className = \"tag\";\n    providerTag.textContent = entry.batch ? \"BATCH\" : (entry.provider ? entry.provider.toUpperCase() : \"\");\n    tags.appendChild(providerTag);\n\n    const statusTag = document.createElement(\"span\");\n    statusTag.className = `tag ${entry.ok ? \"\" : \"tag--error\"}`;\n    statusTag.textContent = entry.ok ? \"OK\" : \"Erreur\";\n    tags.appendChild(statusTag);\n\n    const costTag = document.createElement(\"span\");\n    costTag.className = \"tag tag--cost\";\n    if (entry.batch) {\n      costTag.textContent = formatCost(estimateCost(entry));\n      costTag.title = \"Cot estim (EUR)\";\n    } else {\n      costTag.textContent = formatCostCents(estimateCost(entry));\n      costTag.title = \"Cot estim (centimes)\";\n    }\n    tags.appendChild(costTag);\n\n    if (entry.batch) {\n      const batchTag = document.createElement(\"span\");\n      batchTag.className = \"tag tag--cache\";\n      batchTag.textContent = \"Lot\";\n      tags.appendChild(batchTag);\n    } else if (entry.cache) {\n      const cacheTag = document.createElement(\"span\");\n      cacheTag.className = \"tag tag--cache\";\n      cacheTag.textContent = \"Cache\";\n      tags.appendChild(cacheTag);\n    }\n\n    if (\n      entry.cacheHint === \"gemini_cached_content\" ||\n      (String(entry.provider || \"\").toLowerCase() === \"gemini\" && Number(entry.cachedInputTokens || 0) > 0) ||\n      (entry.batch && (Number(entry.cachedInputTokens || 0) > 0 || Number(entry.batchStats?.cached || 0) > 0))\n    ) {\n      const gemCacheTag = document.createElement(\"span\");\n      gemCacheTag.className = \"tag tag--cache\";\n      gemCacheTag.textContent = \"Cache Gemini\";\n      tags.appendChild(gemCacheTag);\n    }\n\n    top.appendChild(title);\n    top.appendChild(tags);\n\n    const meta = document.createElement(\"div\");\n    meta.className = \"log-item__meta\";\n\n    const tokensTotal = Math.max(0, entry.inputTokens + entry.reasoningTokens + entry.outputTokens);\n    const modelLabel = entry.batch ? \"\" : (entry.model ? entry.model : \"\");\n    const effortLabel = entry.reasoningEffort ? entry.reasoningEffort : \"\";\n    const durationLabel = formatDuration(entry.ms);\n    const modelEffortLabel = [modelLabel, effortLabel].filter(Boolean).join(\"  \");\n\n    const right = document.createElement(\"div\");\n    right.className = \"log-item__info\";\n    const baseMeta = `${formatTime(entry.ts)}  ${durationLabel}`;\n    const detailMeta = modelEffortLabel ? `  ${modelEffortLabel}` : \"\";\n    if (entry.batch && entry.batchStats) {\n      const stats = entry.batchStats;\n      const parts = [\n        `Lot ${formatNumber(stats.totalRequests)} req`,\n        `OK ${formatNumber(stats.ok)}`,\n        `Err ${formatNumber(stats.error)}`\n      ];\n      if (stats.cached) parts.push(`Cache ${formatNumber(stats.cached)}`);\n      if (stats.avgMs) parts.push(`Moy ${formatDuration(stats.avgMs)}`);\n      if (stats.peakQueued) parts.push(`Pic file ${formatNumber(stats.peakQueued)}`);\n      if (stats.peakActive) parts.push(`Pic actif ${formatNumber(stats.peakActive)}`);\n      right.textContent = `${baseMeta}${detailMeta}  ${parts.join(\"  \")}`;\n    } else if (!entry.ok && entry.message) {\n      right.textContent = `${baseMeta}${detailMeta}  ${entry.message.slice(0, 60)}`;\n    } else {\n      right.textContent = `${baseMeta}${detailMeta}`;\n    }\n\n    if (entry.cache) {\n      const cacheNote = document.createElement(\"div\");\n      cacheNote.className = \"log-item__cache\";\n      cacheNote.textContent = \"Cache local\";\n      meta.appendChild(cacheNote);\n    } else {\n      const tokensWrap = document.createElement(\"div\");\n      tokensWrap.className = \"log-item__tokens\";\n\n      const tokensLine = document.createElement(\"div\");\n      tokensLine.className = \"log-item__tokens-line\";\n\n      const heatDot = document.createElement(\"span\");\n      heatDot.className = `log-item__heat ${getTokenHeatClass(tokensTotal)}`;\n\n      const tokensTotalEl = document.createElement(\"span\");\n      tokensTotalEl.className = \"log-item__tokens-total\";\n      tokensTotalEl.textContent = `${formatNumber(tokensTotal)} tokens`;\n\n      const tokensDetailEl = document.createElement(\"span\");\n      tokensDetailEl.className = \"log-item__tokens-detail\";\n      tokensDetailEl.appendChild(document.createTextNode(\"(\"));\n      tokensDetailEl.appendChild(buildTokenFlow(TOKEN_IN_ICON, entry.inputTokens));\n      tokensDetailEl.appendChild(document.createTextNode(\" / \"));\n      tokensDetailEl.appendChild(buildTokenFlow(TOKEN_REASON_ICON, entry.reasoningTokens));\n      tokensDetailEl.appendChild(document.createTextNode(\" / \"));\n      tokensDetailEl.appendChild(buildTokenFlow(TOKEN_OUT_ICON, entry.outputTokens));\n      if (Number(entry.cachedInputTokens || 0) > 0) {\n        tokensDetailEl.appendChild(document.createTextNode(\" / \"));\n        tokensDetailEl.appendChild(buildTokenFlow(TOKEN_CACHED_ICON, entry.cachedInputTokens));\n      }\n      tokensDetailEl.appendChild(document.createTextNode(\")\"));\n\n      tokensLine.appendChild(heatDot);\n      tokensLine.appendChild(tokensTotalEl);\n      tokensLine.appendChild(tokensDetailEl);\n      tokensWrap.appendChild(tokensLine);\n      meta.appendChild(tokensWrap);\n    }\n\n    meta.appendChild(right);\n\n    item.appendChild(top);\n    if (detail) item.appendChild(detail);\n    item.appendChild(meta);\n    list.appendChild(item);\n  }\n\n  expandedLogKeys.forEach((key) => {\n    if (!activeKeys.has(key)) expandedLogKeys.delete(key);\n  });\n}\n\nfunction drawUsageChart(logs) {\n  const canvas = el(\"usageChart\");\n  if (!canvas) return;\n  const ctx = canvas.getContext(\"2d\");\n  if (!ctx) return;\n\n  const width = canvas.clientWidth || 320;\n  const height = canvas.clientHeight || 140;\n  const dpr = window.devicePixelRatio || 1;\n  canvas.width = width * dpr;\n  canvas.height = height * dpr;\n  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);\n\n  const now = Date.now();\n  const start = now - 60 * 60 * 1000;\n  const buckets = new Array(60).fill(0);\n\n  for (const entry of logs) {\n    if (!entry.ts || entry.ts < start) continue;\n    const index = Math.floor((entry.ts - start) / 60000);\n    if (index >= 0 && index < buckets.length) {\n      buckets[index] += Math.max(0, entry.inputTokens + entry.reasoningTokens + entry.outputTokens);\n    }\n  }\n\n  const maxValue = Math.max(...buckets, 1);\n  const styles = getComputedStyle(document.documentElement);\n  const lineColor = styles.getPropertyValue(\"--accent-2\").trim() || \"#2a9d8f\";\n  const gridColor = \"rgba(38, 70, 83, 0.12)\";\n\n  ctx.clearRect(0, 0, width, height);\n\n  ctx.strokeStyle = gridColor;\n  ctx.lineWidth = 1;\n  for (let i = 1; i <= 3; i++) {\n    const y = (height / 4) * i;\n    ctx.beginPath();\n    ctx.moveTo(0, y);\n    ctx.lineTo(width, y);\n    ctx.stroke();\n  }\n\n  ctx.beginPath();\n  buckets.forEach((value, i) => {\n    const x = (i / (buckets.length - 1)) * width;\n    const y = height - (value / maxValue) * (height - 12) - 6;\n    if (i === 0) ctx.moveTo(x, y);\n    else ctx.lineTo(x, y);\n  });\n\n  const gradient = ctx.createLinearGradient(0, 0, 0, height);\n  gradient.addColorStop(0, \"rgba(42, 157, 143, 0.35)\");\n  gradient.addColorStop(1, \"rgba(42, 157, 143, 0.02)\");\n\n  ctx.lineWidth = 2;\n  ctx.strokeStyle = lineColor;\n  ctx.stroke();\n\n  ctx.lineTo(width, height);\n  ctx.lineTo(0, height);\n  ctx.closePath();\n  ctx.fillStyle = gradient;\n  ctx.fill();\n}\n\nfunction updatePrivacyModeUI(enabled) {\n  privacyModeEnabled = !!enabled;\n  const toggle = el(\"privacyModeToggle\");\n  if (toggle) toggle.checked = privacyModeEnabled;\n\n  const status = el(\"privacyModeStatus\");\n  if (status) {\n    status.textContent = privacyModeEnabled ? \"Activ\" : \"Dsactiv\";\n    status.classList.toggle(\"is-active\", privacyModeEnabled);\n  }\n\n  const hint = el(\"privacyModeHint\");\n  if (hint) {\n    hint.textContent = privacyModeEnabled\n      ? \"Journal et cache persistants dsactivs.\"\n      : \"Journal et cache persistants activs.\";\n  }\n\n  const cacheStatus = el(\"cacheStatus\");\n  if (cacheStatus) {\n    cacheStatus.textContent = privacyModeEnabled ? \"Dsactiv\" : \"Actif\";\n    cacheStatus.classList.toggle(\"chip--success\", !privacyModeEnabled);\n    cacheStatus.classList.toggle(\"chip--muted\", privacyModeEnabled);\n  }\n}\n\nasync function refreshPrivacyMode() {\n  const enabled = await getPrivacyMode();\n  updatePrivacyModeUI(enabled);\n}\n\nasync function initPrivacyMode() {\n  const toggle = el(\"privacyModeToggle\");\n  if (!toggle) return;\n  await refreshPrivacyMode();\n  toggle.addEventListener(\"change\", async () => {\n    const next = !!toggle.checked;\n    await setPrivacyMode(next);\n    updatePrivacyModeUI(next);\n    if (next) {\n      await clearRequestLog();\n      await clearAllCaches();\n    }\n    await refreshUsageGuarded({ force: true });\n    await refreshCacheStatsGuarded({ force: true });\n    setStatus(next ? \"Mode confidentialit activ\" : \"Mode confidentialit dsactiv\", { privacyMode: next });\n  });\n}\n\nasync function refreshCacheStats() {\n  const stats = await getPersistentCacheStats();\n  el(\"cacheEntries\").textContent = formatNumber(stats.entries);\n  el(\"cacheSize\").textContent = formatBytes(stats.sizeBytes);\n  el(\"cacheGeminiEntries\").textContent = formatNumber(stats.providers.gemini.entries);\n  el(\"cacheOpenAIEntries\").textContent = formatNumber(stats.providers.openai.entries);\n}\n\nasync function saveCommon(options = {}) {\n  const { silent = false, message = \"Configuration enregistre\" } = options;\n  const provider = getSelectedProvider();\n  const exp = clampExp(el(\"maxTokensRange\").value);\n  const maxTok = expToTokens(exp);\n\n  const savedProvider = await setDefaultProvider(provider);\n  const savedTokens = await setMaxOutputTokens(maxTok);\n\n  if (!silent) {\n    setStatus(message, { defaultProvider: savedProvider, maxOutputTokens: savedTokens });\n  }\n\n  return { savedProvider, savedTokens };\n}\n\nasync function saveConcurrency(options = {}) {\n  const { silent = false, message = \"Concurrence enregistre\" } = options;\n  const value = updateConcurrencyValue();\n  const saved = await setConcurrencyLimit(value);\n  if (!silent) {\n    setStatus(message, { concurrency: saved });\n  }\n  return saved;\n}\n\nasync function saveRpmLimit(options = {}) {\n  const { silent = false, message = \"Limite RPM enregistre\" } = options;\n  const value = updateRpmLimitValue();\n  const saved = await setRpmLimit(value);\n  rpmLimitValue = saved;\n  if (!silent) {\n    setStatus(message, { rpmLimit: saved });\n  }\n  return saved;\n}\n\nfunction initCollapsibles() {\n  const toggles = document.querySelectorAll(\"[data-collapse-toggle]\");\n  toggles.forEach((btn) => {\n    const targetId = btn.getAttribute(\"aria-controls\");\n    const container = btn.closest(\"[data-collapsible]\");\n    if (!targetId || !container) return;\n    const body = document.getElementById(targetId);\n    if (!body) return;\n\n    const collapsed = container.classList.contains(\"is-collapsed\");\n    btn.setAttribute(\"aria-expanded\", collapsed ? \"false\" : \"true\");\n\n    btn.addEventListener(\"click\", () => {\n      const nextCollapsed = !container.classList.contains(\"is-collapsed\");\n      container.classList.toggle(\"is-collapsed\", nextCollapsed);\n      btn.setAttribute(\"aria-expanded\", nextCollapsed ? \"false\" : \"true\");\n    });\n  });\n}\n\nfunction openOnboardingSection(options = {}) {\n  const { focusKey = false } = options;\n  const section = document.querySelector('[data-section=\"onboarding\"]');\n  if (!section) return;\n  section.classList.remove(\"is-hidden\");\n  if (section.classList.contains(SECTION_HIDDEN_CLASS)) {\n    hiddenSections.delete(\"onboarding\");\n    updateHiddenSections(Array.from(hiddenSections));\n  }\n  if (section.classList.contains(\"is-collapsed\")) {\n    section.classList.remove(\"is-collapsed\");\n    const toggle = section.querySelector(\"[data-collapse-toggle]\");\n    if (toggle) toggle.setAttribute(\"aria-expanded\", \"true\");\n  }\n  if (typeof section.scrollIntoView === \"function\") {\n    section.scrollIntoView({ behavior: \"smooth\", block: \"start\" });\n  }\n  if (focusKey) {\n    const input = section.querySelector(KEY_INPUT_SELECTOR);\n    if (input) input.focus();\n  }\n}\n\nfunction attachStorageListeners() {\n  let queued = false;\n  const triggerRefresh = () => {\n    if (queued) return;\n    queued = true;\n    setTimeout(async () => {\n      queued = false;\n      await refreshUsageGuarded();\n      await refreshCacheStatsGuarded();\n      await refreshRuntimeStatusGuarded();\n      await refreshPrivacyMode();\n      await refreshLicenseUI({ silent: true });\n    }, 250);\n  };\n\n  try {\n    if (typeof OfficeRuntime !== \"undefined\" && OfficeRuntime?.storage?.onChanged) {\n      const onChanged = OfficeRuntime.storage.onChanged;\n      if (typeof onChanged.add === \"function\") onChanged.add(() => triggerRefresh());\n      else if (typeof onChanged.addListener === \"function\") onChanged.addListener(() => triggerRefresh());\n      else if (typeof onChanged === \"function\") onChanged(() => triggerRefresh());\n    }\n  } catch {\n    // ignore\n  }\n\n  try {\n    window.addEventListener(\"storage\", () => triggerRefresh());\n  } catch {\n    // ignore\n  }\n}\n\nfunction closeAllHelpPopups() {\n  document.querySelectorAll(HELP_SELECTOR).forEach((help) => {\n    help.classList.remove(\"is-open\");\n    const btn = help.querySelector(\"button\");\n    if (btn) btn.setAttribute(\"aria-expanded\", \"false\");\n  });\n}\n\nfunction initHelpPopups() {\n  document.querySelectorAll(HELP_SELECTOR).forEach((help) => {\n    const btn = help.querySelector(\"button\");\n    if (!btn) return;\n    btn.setAttribute(\"aria-expanded\", \"false\");\n    btn.addEventListener(\"click\", (event) => {\n      event.stopPropagation();\n      const wasOpen = help.classList.contains(\"is-open\");\n      closeAllHelpPopups();\n      const nextOpen = !wasOpen;\n      help.classList.toggle(\"is-open\", nextOpen);\n      btn.setAttribute(\"aria-expanded\", nextOpen ? \"true\" : \"false\");\n    });\n  });\n\n  document.addEventListener(\"click\", (event) => {\n    if (event.target.closest(HELP_SELECTOR)) return;\n    closeAllHelpPopups();\n  });\n}\n\nasync function confirmOnboardingKeys(options = {}) {\n  const { silent = false } = options;\n  if (!hasAnyApiKey()) {\n    if (!silent) {\n      setStatus(\"Ajoutez au moins une cl API avant de valider\", { ok: false });\n    }\n    return false;\n  }\n  onboardingKeysConfirmed = true;\n  onboardingKeysLoaded = true;\n  await setOnboardingKeysConfirmed(true);\n  updateOnboardingVisibility();\n  return true;\n}\n\nasync function persistApiKey(provider, value) {\n  const trimmed = (value || \"\").trim();\n  if (!trimmed) return false;\n  await setApiKey(provider, trimmed);\n  keyState[provider] = true;\n  keysLoaded = true;\n  updateKeyPlaceholders();\n  updateModelGates();\n  updateOnboardingVisibility();\n  return true;\n}\n\nasync function saveProviderKey(provider, inputEl) {\n  const key = await persistApiKey(provider, inputEl?.value || \"\");\n  if (!key) return;\n  if (inputEl) inputEl.value = \"\";\n  setKeyStatus(provider, key);\n  setStatus(\"Cl enregistre\", { provider });\n}\n\nasync function saveProviderModel(provider) {\n  const isGemini = provider === PROVIDERS.GEMINI;\n  const modelEl = isGemini ? el(\"geminiModel\") : el(\"openaiModel\");\n  if (!modelEl) return;\n  const newModel = (modelEl.value || \"\").trim();\n  await setModel(provider, newModel);\n\n  let effort = \"\";\n  if (isGemini) {\n    const effortEl = el(\"geminiReasoningEffort\");\n    const rawEffort = effortEl ? effortEl.value : \"\";\n    effort = syncGeminiReasoningEffort(newModel, rawEffort);\n    if (effort) await setGeminiReasoningEffort(effort);\n  } else {\n    const effortEl = el(\"openaiReasoningEffort\");\n    const rawEffort = effortEl ? effortEl.value : \"\";\n    effort = syncOpenAIReasoningEffort(newModel, rawEffort);\n    if (effort) await setOpenAIReasoningEffort(effort);\n  }\n\n  setStatus(\"Configuration enregistre\", {\n    provider,\n    model: newModel,\n    reasoningEffort: effort || undefined\n  });\n\n  updateModelWarningBadge(provider, newModel);\n}\n\nasync function saveGeminiReasoningEffort() {\n  const modelEl = el(\"geminiModel\");\n  const effortEl = el(\"geminiReasoningEffort\");\n  if (!effortEl) return;\n  const label = syncGeminiReasoningEffort(modelEl ? modelEl.value : \"\", effortEl.value);\n  if (label) await setGeminiReasoningEffort(label);\n  setStatus(\"Effort de raisonnement enregistr\", { geminiReasoningEffort: label });\n}\n\nasync function saveOpenAIReasoningEffort() {\n  const modelEl = el(\"openaiModel\");\n  const effortEl = el(\"openaiReasoningEffort\");\n  if (!effortEl) return;\n  const label = syncOpenAIReasoningEffort(modelEl ? modelEl.value : \"\", effortEl.value);\n  if (label) await setOpenAIReasoningEffort(label);\n  setStatus(\"Effort de raisonnement enregistr\", { openaiReasoningEffort: label });\n}\n\nfunction setInputWarning(inputEl, isWarning) {\n  if (!inputEl) return;\n  inputEl.classList.toggle(\"input--warning\", isWarning);\n}\n\nasync function handleLicenseActivate(inputEl, buttonEl) {\n  const key = (inputEl?.value || \"\").trim();\n  setInputWarning(inputEl, false);\n\n  if (!key) {\n    setInputWarning(inputEl, true);\n    setLicenseStatusAll(\"Entrez votre cl de licence\", false);\n    setStatus(\"Cl de licence manquante\", { ok: false });\n    return;\n  }\n\n  const originalLabel = buttonEl?.textContent || \"\";\n  if (buttonEl) {\n    buttonEl.disabled = true;\n    buttonEl.textContent = \"Activation...\";\n  }\n\n  const result = await activateLicense(key);\n\n  if (buttonEl) {\n    buttonEl.disabled = false;\n    buttonEl.textContent = originalLabel;\n  }\n\n  if (result.success) {\n    if (inputEl) inputEl.value = \"\";\n    await refreshLicenseUI({ silent: true });\n    setStatus(\"Licence active\", { expiresAt: result.license?.expiresAt || \"n/a\" });\n    showToast(\"Licence enregistre\");\n    return;\n  }\n\n  const errorText = result.error || \"Cl invalide\";\n  setInputWarning(inputEl, true);\n  setLicenseStatusAll(errorText, false);\n  setStatus(\"chec de l'activation\", { error: errorText });\n}\n\nasync function handleLicenseTest(inputEl, buttonEl) {\n  if (!inputEl || !buttonEl) return;\n\n  const inputKey = (inputEl.value || \"\").trim();\n  const stored = licenseState || (await getStoredLicense());\n  const keyToTest = inputKey || stored?.key || \"\";\n\n  setInputWarning(inputEl, false);\n\n  if (!keyToTest) {\n    setInputWarning(inputEl, true);\n    setStatus(\"Cl de licence manquante\", { ok: false });\n    return;\n  }\n\n  const originalLabel = buttonEl.textContent;\n  buttonEl.disabled = true;\n  buttonEl.textContent = \"Test...\";\n\n  const result = await validateLicense(keyToTest);\n\n  buttonEl.disabled = false;\n  buttonEl.textContent = originalLabel;\n\n  if (result.success) {\n    const expiry = result.license?.expiresAt || \"n/a\";\n    if (stored && keyToTest === stored.key) {\n      await saveStoredLicense({\n        ...stored,\n        ...result.license,\n        valid: true,\n        lastCheckedAt: new Date().toISOString()\n      });\n      await refreshLicenseUI({ silent: true });\n    } else if (!stored || !stored.key) {\n      setLicenseStatusAll(\"Licence valide (non enregistre)\", true);\n    }\n    if (inputKey && (!stored || keyToTest !== stored.key)) {\n      setStatus(\"Licence valide. Cliquez sur Activer pour l'enregistrer.\", { expiresAt: expiry });\n    } else {\n      setStatus(\"Licence valide\", { expiresAt: expiry });\n    }\n    return;\n  }\n\n  const errorText = result.error || \"Cl invalide\";\n  setStatus(\"Licence invalide\", { error: errorText });\n  if (stored && keyToTest === stored.key) {\n    await saveStoredLicense({\n      ...stored,\n      valid: false,\n      lastCheckedAt: new Date().toISOString()\n    });\n    await refreshLicenseUI({ silent: true });\n  } else if (!stored || !stored.key) {\n    setLicenseStatusAll(errorText, false);\n  }\n}\n\nasync function handleLicenseClear() {\n  await clearStoredLicense();\n  licenseState = null;\n  document.querySelectorAll(LICENSE_INPUT_SELECTOR).forEach((input) => {\n    input.value = \"\";\n    setInputWarning(input, false);\n  });\n  await refreshLicenseUI({ silent: true });\n  setStatus(\"Licence efface\", { ok: true });\n}\n\nasync function saveOnboardingKeys() {\n  const geminiInput = el(\"onboardingGeminiKey\");\n  const openaiInput = el(\"onboardingOpenAIKey\");\n\n  const geminiKey = await persistApiKey(PROVIDERS.GEMINI, geminiInput?.value || \"\");\n  const openaiKey = await persistApiKey(PROVIDERS.OPENAI, openaiInput?.value || \"\");\n\n  if (geminiInput) geminiInput.value = \"\";\n  if (openaiInput) openaiInput.value = \"\";\n\n  setKeyStatus(PROVIDERS.GEMINI, keyState.gemini);\n  setKeyStatus(PROVIDERS.OPENAI, keyState.openai);\n\n  if (geminiKey || openaiKey) {\n    setStatus(\"Cls enregistres\", { gemini: !!geminiKey, openai: !!openaiKey });\n  }\n\n  if (keyState.gemini || keyState.openai) {\n    await confirmOnboardingKeys({ silent: true });\n    setOnboardingKeysModalOpen(false);\n  }\n}\n\nasync function dismissOnboarding(markSeen = true) {\n  if (markSeen) await setOnboardingSeen(true);\n  setOnboardingKeysModalOpen(false);\n  setOnboardingModalOpen(false);\n}\n\nasync function maybeShowOnboarding() {\n  const seen = await getOnboardingSeen();\n  if (seen) return;\n  setOnboardingModalOpen(true);\n}\n\nasync function clearProvider(provider) {\n  await clearApiKey(provider);\n  await refreshUI({ silent: true });\n  setStatus(\"Cl efface\", { provider });\n}\n\nasync function testProvider(provider) {\n  setStatus(\"Test en cours\", { provider });\n\n  const r = await aiMinimalTest(provider);\n  if (r.ok) {\n    setStatus(\"OK\", { provider: r.provider, model: r.model, response: r.text });\n  } else {\n    setStatus(\"chec\", { provider: r.provider, model: r.model, error: r.message, code: r.code });\n  }\n}\n\nasync function safeOfficeReady() {\n  try {\n    if (typeof Office !== \"undefined\" && Office?.onReady) {\n      await Office.onReady();\n    }\n  } catch {\n    // Running outside Office host (e.g., direct browser open)\n  }\n}\n\nasync function init() {\n  initCollapsibles();\n  attachStorageListeners();\n  initHelpPopups();\n  await initSectionManager();\n  await initPrivacyMode();\n\n  const settingsButton = el(\"settingsButton\");\n  if (settingsButton) {\n    settingsButton.addEventListener(\"click\", () => setSettingsModalOpen(true));\n  }\n\n  document.querySelectorAll(\"[data-settings-open]\").forEach((btn) => {\n    btn.addEventListener(\"click\", () => setSettingsModalOpen(true));\n  });\n\n  document.querySelectorAll(\"[data-settings-close]\").forEach((btn) => {\n    btn.addEventListener(\"click\", () => setSettingsModalOpen(false));\n  });\n\n  const sectionReset = el(\"sectionManagerReset\");\n  if (sectionReset) {\n    sectionReset.addEventListener(\"click\", () => resetSectionOrder());\n  }\n\n  const pricingHelp = el(\"pricingHelp\");\n  if (pricingHelp) {\n    pricingHelp.addEventListener(\"click\", () => openPricingModal());\n  }\n\n  document.querySelectorAll(\"[data-modal-close]\").forEach((btn) => {\n    btn.addEventListener(\"click\", () => closePricingModal());\n  });\n\n  document.querySelectorAll(\"[data-onboarding-close]\").forEach((btn) => {\n    btn.addEventListener(\"click\", async () => dismissOnboarding(true));\n  });\n\n  document.querySelectorAll(\"[data-onboarding-keys-close]\").forEach((btn) => {\n    btn.addEventListener(\"click\", () => setOnboardingKeysModalOpen(false));\n  });\n\n  const onboardingClose = el(\"onboardingClose\");\n  if (onboardingClose) {\n    onboardingClose.addEventListener(\"click\", async () => dismissOnboarding(true));\n  }\n\n  const onboardingDone = el(\"onboardingDone\");\n  if (onboardingDone) {\n    onboardingDone.addEventListener(\"click\", async () => dismissOnboarding(true));\n  }\n\n  const onboardingKeysButton = el(\"onboardingKeysButton\");\n  if (onboardingKeysButton) {\n    onboardingKeysButton.addEventListener(\"click\", async () => {\n      await dismissOnboarding(true);\n      openOnboardingSection({ focusKey: true });\n    });\n  }\n\n  document.querySelectorAll(\"[data-onboarding-open]\").forEach((btn) => {\n    btn.addEventListener(\"click\", () => {\n      setSettingsModalOpen(false);\n      openOnboardingSection({ focusKey: true });\n    });\n  });\n\n  const onboardingKeysSave = el(\"onboardingKeysSave\");\n  if (onboardingKeysSave) {\n    onboardingKeysSave.addEventListener(\"click\", async () => saveOnboardingKeys());\n  }\n\n  const onboardingKeysLater = el(\"onboardingKeysLater\");\n  if (onboardingKeysLater) {\n    onboardingKeysLater.addEventListener(\"click\", () => setOnboardingKeysModalOpen(false));\n  }\n\n  document.addEventListener(\"keydown\", async (e) => {\n    if (e.key !== \"Escape\") return;\n    closeAllHelpPopups();\n    if (isModalOpen(\"onboardingKeysModal\")) {\n      setOnboardingKeysModalOpen(false);\n      return;\n    }\n    if (isModalOpen(\"onboardingModal\")) {\n      await dismissOnboarding(true);\n      return;\n    }\n    if (isModalOpen(\"settingsModal\")) {\n      setSettingsModalOpen(false);\n      return;\n    }\n    if (isModalOpen(\"pricingModal\")) {\n      closePricingModal();\n    }\n  });\n\n  // Tabs\n  el(\"tabGemini\").addEventListener(\"click\", () => activateTab(\"gemini\"));\n  el(\"tabOpenAI\").addEventListener(\"click\", () => activateTab(\"openai\"));\n\n  // Provider selection buttons\n  el(\"providerGemini\").addEventListener(\"click\", async () => {\n    setProviderButtons(PROVIDERS.GEMINI);\n    await saveCommon();\n  });\n\n  el(\"providerOpenAI\").addEventListener(\"click\", async () => {\n    setProviderButtons(PROVIDERS.OPENAI);\n    await saveCommon();\n  });\n\n  // Max tokens slider\n  el(\"maxTokensRange\").addEventListener(\"input\", () => {\n    updateMaxTokensValue();\n  });\n\n  el(\"maxTokensRange\").addEventListener(\"change\", async () => {\n    await saveCommon();\n  });\n\n  // Concurrency slider\n  el(\"concurrencyRange\").addEventListener(\"input\", () => {\n    updateConcurrencyValue();\n  });\n\n  el(\"concurrencyRange\").addEventListener(\"change\", async () => {\n    await saveConcurrency();\n  });\n\n  const rpmInput = el(\"rpmLimitInput\");\n  if (rpmInput) {\n    rpmInput.addEventListener(\"change\", async () => {\n      await saveRpmLimit();\n    });\n  }\n\n  const geminiEffortEl = el(\"geminiReasoningEffort\");\n  if (geminiEffortEl) {\n    geminiEffortEl.addEventListener(\"input\", () => {\n      const modelEl = el(\"geminiModel\");\n      syncGeminiReasoningEffort(modelEl ? modelEl.value : \"\", geminiEffortEl.value);\n    });\n    geminiEffortEl.addEventListener(\"change\", async () => {\n      await saveGeminiReasoningEffort();\n    });\n  }\n\n  const effortEl = el(\"openaiReasoningEffort\");\n  if (effortEl) {\n    effortEl.addEventListener(\"input\", () => {\n      const allowNone = effortEl.dataset.allowNone !== \"0\";\n      let label = getReasoningEffortLabel(effortEl.value);\n      if (!allowNone && label === \"none\") {\n        effortEl.value = \"1\";\n        label = getReasoningEffortLabel(effortEl.value);\n      }\n      effortEl.setAttribute(\"aria-valuetext\", label);\n    });\n    effortEl.addEventListener(\"change\", async () => {\n      await saveOpenAIReasoningEffort();\n    });\n  }\n\n  const geminiModelEl = el(\"geminiModel\");\n  if (geminiModelEl) {\n    geminiModelEl.addEventListener(\"change\", async () => {\n      await saveProviderModel(PROVIDERS.GEMINI);\n    });\n  }\n\n  const openaiModelEl = el(\"openaiModel\");\n  if (openaiModelEl) {\n    openaiModelEl.addEventListener(\"change\", async () => {\n      await saveProviderModel(PROVIDERS.OPENAI);\n    });\n  }\n\n  document.querySelectorAll(KEY_INPUT_SELECTOR).forEach((input) => {\n    const provider = String(input.dataset.keyInput || \"\").trim().toLowerCase();\n    if (!provider) return;\n    input.addEventListener(\"input\", () => setInputWarning(input, false));\n    input.addEventListener(\"change\", async () => {\n      await saveProviderKey(provider, input);\n    });\n    input.addEventListener(\"keydown\", (event) => {\n      if (event.key !== \"Enter\") return;\n      event.preventDefault();\n      const actionBtn = input.closest(\".input-action\")?.querySelector(KEY_SAVE_SELECTOR);\n      if (actionBtn) actionBtn.click();\n      else void saveProviderKey(provider, input);\n    });\n  });\n\n  document.querySelectorAll(KEY_SAVE_SELECTOR).forEach((btn) => {\n    const provider = String(btn.dataset.keySave || \"\").trim().toLowerCase();\n    if (!provider) return;\n    btn.addEventListener(\"click\", async () => {\n      const input = btn.closest(\".input-action\")?.querySelector(KEY_INPUT_SELECTOR);\n      await saveProviderKey(provider, input);\n      if (btn.dataset.keyConfirm === \"true\") {\n        await confirmOnboardingKeys();\n      }\n    });\n  });\n\n  const licenseModeSubscribe = el(\"licenseModeSubscribe\");\n  const licenseModeHave = el(\"licenseModeHave\");\n  if (licenseModeSubscribe) {\n    licenseModeSubscribe.addEventListener(\"click\", () => setLicenseEntryVisible(false));\n  }\n  if (licenseModeHave) {\n    licenseModeHave.addEventListener(\"click\", () => setLicenseEntryVisible(true, { focus: true }));\n  }\n\n  document.querySelectorAll(LICENSE_INPUT_SELECTOR).forEach((input) => {\n    input.addEventListener(\"input\", () => setInputWarning(input, false));\n    input.addEventListener(\"keydown\", (event) => {\n      if (event.key !== \"Enter\") return;\n      event.preventDefault();\n      const targetBtn =\n        document.querySelector(`[data-license-activate][data-license-target=\"${input.id}\"]`) ||\n        input.closest(\".input-action, .setup-license__row\")?.querySelector(\"[data-license-activate]\");\n      if (targetBtn) {\n        void handleLicenseActivate(input, targetBtn);\n      }\n    });\n  });\n\n  document.querySelectorAll(\"[data-license-activate]\").forEach((btn) => {\n    btn.addEventListener(\"click\", async () => {\n      const targetId = btn.dataset.licenseTarget;\n      const input =\n        (targetId ? el(targetId) : null) ||\n        btn.closest(\".input-action, .setup-license__row\")?.querySelector(LICENSE_INPUT_SELECTOR);\n      await handleLicenseActivate(input, btn);\n    });\n  });\n\n  document.querySelectorAll(\"[data-license-test]\").forEach((btn) => {\n    btn.addEventListener(\"click\", async () => {\n      const targetId = btn.dataset.licenseTarget;\n      const input =\n        (targetId ? el(targetId) : null) ||\n        btn.closest(\".input-action\")?.querySelector(LICENSE_INPUT_SELECTOR);\n      await handleLicenseTest(input, btn);\n    });\n  });\n\n  document.querySelectorAll(\"[data-license-clear]\").forEach((btn) => {\n    btn.addEventListener(\"click\", async () => handleLicenseClear());\n  });\n\n  // Provider clear/test\n  const clearGeminiBtn = el(\"clearGemini\");\n  if (clearGeminiBtn) {\n    clearGeminiBtn.addEventListener(\"click\", async () => clearProvider(PROVIDERS.GEMINI));\n  }\n  const clearOpenAIBtn = el(\"clearOpenAI\");\n  if (clearOpenAIBtn) {\n    clearOpenAIBtn.addEventListener(\"click\", async () => clearProvider(PROVIDERS.OPENAI));\n  }\n\n  const testGeminiBtn = el(\"testGemini\");\n  if (testGeminiBtn) {\n    testGeminiBtn.addEventListener(\"click\", async () => testProvider(PROVIDERS.GEMINI));\n  }\n  const testOpenAIBtn = el(\"testOpenAI\");\n  if (testOpenAIBtn) {\n    testOpenAIBtn.addEventListener(\"click\", async () => testProvider(PROVIDERS.OPENAI));\n  }\n\n  const clearUsageBtn = el(\"clearUsageTotals\");\n  if (clearUsageBtn) {\n    clearUsageBtn.addEventListener(\"click\", async () => {\n      await clearUsageTotals();\n      await refreshUsageGuarded({ force: true });\n      setStatus(\"Utilisation rinitialise\", { ok: true });\n    });\n  }\n\n  const logFilterErrors = el(\"logFilterErrors\");\n  if (logFilterErrors) {\n    logFilterErrors.addEventListener(\"click\", () => {\n      logErrorsOnly = !logErrorsOnly;\n      updateLogFilterUI();\n      renderLogList(lastUsageLogs);\n    });\n  }\n  updateLogFilterUI();\n\n  el(\"clearLogs\").addEventListener(\"click\", async () => {\n    await clearRequestLog();\n    await refreshUsageGuarded({ force: true });\n    setStatus(\"Journal effac\", { ok: true });\n  });\n\n  el(\"refreshCache\").addEventListener(\"click\", async () => {\n    await refreshCacheStatsGuarded({ force: true });\n    setStatus(\"Cache actualis\", { ok: true });\n  });\n\n  el(\"clearCache\").addEventListener(\"click\", async () => {\n    await clearAllCaches();\n    await refreshCacheStatsGuarded({ force: true });\n    setStatus(\"Cache vid\", { ok: true });\n  });\n\n  const queueStop = el(\"queueStop\");\n  if (queueStop) {\n    queueStop.addEventListener(\"click\", async () => {\n      stopQueuedRequests();\n      await refreshRuntimeStatusGuarded({ force: true });\n    });\n  }\n\n  // Default tab\n  activateTab(\"gemini\");\n\n  await refreshUI();\n  await refreshLicenseUI({ silent: true });\n  await refreshUsageGuarded({ force: true });\n  await refreshCacheStatsGuarded({ force: true });\n  await refreshRuntimeStatusGuarded({ force: true });\n  await maybeShowOnboarding();\n\n  const scheduleRefresh = () => {\n    void refreshUsageGuarded();\n    void refreshCacheStatsGuarded();\n    void refreshRuntimeStatusGuarded();\n  };\n\n  document.addEventListener(\"visibilitychange\", () => {\n    if (!isDocumentHidden()) scheduleRefresh();\n  });\n\n  setInterval(() => void refreshUsageGuarded(), 2000);\n  setInterval(() => void refreshCacheStatsGuarded(), 12000);\n  setInterval(() => void refreshRuntimeStatusGuarded(), 1000);\n}\n\ndocument.addEventListener(\"DOMContentLoaded\", async () => {\n  await safeOfficeReady();\n  await init();\n});\n"],"names":["PROVIDERS","Object","freeze","GEMINI","OPENAI","DEFAULTS","provider","geminiModel","openaiModel","geminiReasoningEffort","openaiReasoningEffort","maxOutputTokens","concurrencyLimit","rpmLimit","retry","timeoutMs","cache","cacheTtlSec","STORAGE_KEYS","DEFAULT_PROVIDER","GEMINI_API_KEY","OPENAI_API_KEY","GEMINI_MODEL","OPENAI_MODEL","GEMINI_REASONING_EFFORT","OPENAI_REASONING_EFFORT","MAX_OUTPUT_TOKENS","CONCURRENCY_LIMIT","RPM_LIMIT","ONBOARDING_SEEN","ONBOARDING_KEYS_CONFIRMED","SECTION_ORDER","SECTION_HIDDEN","LICENSE","PRIVACY_MODE","MIGRATION_DONE","REQUEST_LOG","REQUEST_LOG_CLEAR_AT","USAGE_TOTALS","CACHE_INDEX","CACHE_CLEAR_AT","RUNTIME_STATUS","GEMINI_CACHED_CONTENT","SENSITIVE_KEYS","Set","LEGACY_KEYS","DEFAULT_PROVIDER_V2","GEMINI_API_KEY_V2","OPENAI_API_KEY_V2","GEMINI_MODEL_V2","OPENAI_MODEL_V2","GEMINI_MAX_TOKENS_V2","OPENAI_MAX_TOKENS_V2","_migrationPromise","_officeStorageFailed","_privacyModeCache","_privacyModeCacheAt","SETTINGS_CACHE_TTL_MS","_defaultProviderCache","_defaultProviderCacheAt","_maxOutputTokensCache","_maxOutputTokensCacheAt","_geminiReasoningCache","_geminiReasoningCacheAt","_openaiReasoningCache","_openaiReasoningCacheAt","_apiKeyCache","gemini","openai","_apiKeyCacheAt","_modelCache","_modelCacheAt","markOfficeStorageFailed","MEMORY_STORAGE","kind","storage","mem","Map","async","getItem","k","has","get","setItem","v","set","String","removeItem","delete","getRuntimeStorage","OfficeRuntime","window","localStorage","getLocalStorageSafe","localGet","local","key","localSet","value","localRemove","rawGet","options","sensitive","isSensitiveKey","allowLocalFallback","result","localValue","rawSet","stored","rawRemove","removed","ensureMigrated","normalizeProvider","legacyProvider","legacy","candidates","map","x","parseInt","trim","filter","n","Number","isFinite","migrated","length","Math","max","p","s","toLowerCase","GEMINI_REASONING_EFFORTS","OPENAI_REASONING_EFFORTS","normalizeGeminiReasoningEffort","normalizeReasoningEffort","getDefaultProvider","now","nowMs","keyKey","getApiKey","trimmed","hasApiKey","modelKey","getModel","cached","raw","resolved","getGeminiReasoningEffort","getOpenAIReasoningEffort","setOpenAIReasoningEffort","setGeminiReasoningEffort","getMaxOutputTokens","clampInt","setMaxOutputTokens","CONCURRENCY_OPTIONS","normalizeConcurrencyLimit","base","includes","best","bestDiff","abs","option","slice","diff","getConcurrencyLimit","setConcurrencyLimit","normalized","normalizeRpmLimit","getRpmLimit","setRpmLimit","getOnboardingKeysConfirmed","setOnboardingKeysConfirmed","confirmed","normalizeRuntimeStatus","active","queued","rpm","ts","MAX_SAFE_INTEGER","setRuntimeStatus","status","JSON","stringify","getPrivacyMode","enabled","loadPrivacyMode","normalizeSectionList","Array","isArray","out","seen","item","add","push","setHiddenSections","list","setLicense","license","clearLicense","Date","sleep","ms","Promise","resolve","setTimeout","min","fallback","REDACT_PATTERNS","redactSensitiveText","text","pattern","replace","redactSensitiveValue","entry","entries","parseTimestampMs","CACHE_ENTRY_PREFIX","CACHE_INDEX_MAX_BYTES","_cacheClearMs","_geminiCachedContent","_geminiCachedContentLoaded","_geminiCachedContentLoading","syncCacheClearMarker","clearedAt","loadCacheIndex","arr","parse","saveCacheIndex","pruneCacheIndex","kept","removedKeys","savedAt","savedAtMs","expiresAtMs","totalSize","size","sort","a","b","dropCount","removeCacheEntry","removeFromCacheIndex","index","next","setPersistentCache","cacheKey","ttlMs","meta","TextEncoder","encode","estimateSizeBytes","model","updated","pruned","normalizeGeminiCachedEntry","name","loadGeminiCachedContent","force","parsed","pruneGeminiCachedContent","before","from","values","persistGeminiCachedContent","removeGeminiCachedContentEntry","sortKeysDeep","prototype","toString","call","keys","hashKey","input","crypto","subtle","digest","bytes","Uint8Array","padStart","join","str","h","i","charCodeAt","imul","fnv1a32","REQUEST_LOG_TTL_MS","Infinity","_requestLog","_requestLogLoading","_requestLogLoaded","_requestLogLastLoadedMs","_requestLogClearMs","_logBuffer","_logFlushTimer","_logFlushPromise","_usageTotals","createEmptyUsageTotals","_usageTotalsLoading","_usageTotalsLoaded","_usageTotalsLastLoadedMs","_usageTotalsDirty","syncRequestLogClearMarker","reset","isErrorLogEntry","ok","loadRequestLog","normal","errors","concat","coerceRequestLogArray","e","sanitizeLogEntry","pruneRequestLog","valid","normals","toNonNegInt","floor","inputTokens","outputTokens","reasoningTokens","cachedInputTokens","requests","batchApplied","byProvider","models","pruneBatchApplied","loadUsageTotals","batchId","normalizedModels","label","normalizeBatchApplied","providers","rawProvider","target","rawModels","normalizeUsageTotals","applyUsageTotalsFromEntry","batch","batchModels","currentModels","modelLabel","mapKey","existing","touched","applyUsageDelta","previous","curr","prev","delta","hasUsageDelta","providerTotals","logRequest","logEntry","replaced","flushLogBuffer","usageTouched","idx","findIndex","REQUEST_LOG_MAX_PER_TYPE","persistRequestLog","persistUsageTotals","clearRequestLog","clearTimeout","CACHE","constructor","maxEntries","this","oldestKey","clear","_cacheClearLocalMs","INFLIGHT","GEMINI_CACHED_CONTENT_TTL_MS","GEMINI_CACHED_INFLIGHT","QUEUE_CANCELLED","Symbol","QUEUE_CANCELLED_RESULT","code","message","concurrencyLimitCached","concurrencyLimitCachedAt","rpmLimitCached","rpmLimitCachedAt","rpmWindow","rpmGate","rpmStatusTimer","queue","_items","_head","shift","drain","pending","statusTimer","pendingStatus","lastStatusKey","batchState","totalPendingRequests","ensureBatchState","startedAt","id","random","endedAt","totalRequests","okCount","errorCount","cachedCount","msSum","msMax","msMin","peakQueued","peakActive","lastLogAt","createBatchState","updateBatchPeaks","recordBatchResult","cacheHint","usage","duration","buildBatchLogEntry","maybeEmitBatchLog","isFinal","totalTokens","durationMs","avgMs","round","fn","batchLive","batchStats","error","maxMs","minMs","finalizeBatchIfIdle","getRpmCount","pruneRpmWindow","scheduleRuntimeStatusUpdate","snapshot","getConcurrencyLimitCached","cutoff","ensureRpmStatusTimer","setInterval","count","clearInterval","isNonEmptyString","normalizeBoolean","def","normalizeTimeoutMs","toLowerMsg","toGeminiModelRef","startsWith","looksLikeStructuredOutputUnsupported","looksLikeWebSearchUnsupported","looksLikeCachedContentInvalid","isGeminiServiceUnavailable","msg","ensureJsonInstruction","system","test","getFormulaForLog","fnName","match","formula","extractFormulaFromText","aiGenerate","req","start","apiKey","functionName","functionCall","reasoningEffort","reasoningEffortLabel","undefined","user","webSearch","gemini503RetryMax","cfgMax","normalizeMaxOutputTokens","thinkingConfig","effort","level","modelId","thinkingLevel","toUpperCase","budget","minimal","low","medium","high","thinkingBudget","resolveGeminiThinkingConfig","cacheEnabled","ttlSec","allowPersistentCache","getCacheClearAt","cacheKeyPayload","responseMimeType","responseJsonSchema","recorded","cacheKind","persisted","Error","getPersistentCache","limit","getRpmLimitCached","then","waitMs","reserveRpmSlot","waitForRpmSlot","attempt","lastErr","callProvider","url","body","max_output_tokens","store","reasoning","sysText","instructions","format","type","strict","schema","tools","include","res","fetchWithTimeout","method","headers","Authorization","json","safeJson","extractOpenAIError","output_text","output","texts","content","part","choices","extractOpenAIText","sources","action","src","title","dedupeSources","extractOpenAISources","u","rawOutputTokens","toInt","output_tokens","output_tokens_details","reasoning_tokens","input_tokens","total_tokens","input_tokens_details","cached_tokens","extractOpenAIUsage","callOpenAI","opts","encodeURIComponent","geminiEndpoint","cachedContentName","cachedContentKey","userText","systemText","cacheParts","exec","prefix","suffix","extractGeminiCacheParts","getGeminiCachedContentEntry","created","contents","role","parts","ttl","systemInstruction","expireTime","createGeminiCachedContent","fallbackMs","parseExpireTimeMs","data","setGeminiCachedContentEntry","ensureGeminiCachedContent","generationConfig","responseSchema","google_search","cachedContent","errInfo","err","statusCode","extractGeminiErrorInfo","extractGeminiError","c","extractGeminiText","md","groundingMetadata","chunks","groundingChunks","ch","web","uri","extractGeminiSources","usageMetadata","promptTokenCount","candidatesTokenCount","thoughtsTokenCount","totalTokenCount","cachedContentTokenCount","extractGeminiUsage","callGemini","baseOpts","wantsStructured","shouldRetryServiceUnavailable","normalizeUsage","timeout","isTimeoutError","withConcurrencyLimit","reportedTotal","computedTotal","clearAllCaches","clearPersistentCache","clearGeminiCachedContent","t","AbortController","fetch","ctrl","abort","signal","INSTANCE_NAME","normalizeKey","normalizeExpiresAt","toISOString","extractError","first","detail","postLicense","endpoint","payload","formData","FormData","forEach","append","response","buildLicense","overrides","instanceId","instance","instance_id","instanceName","expiresAt","license_key","expires_at","activatedAt","lastCheckedAt","normalizeLicense","getStoredLicense","getLicense","saveStoredLicense","isLicenseValid","el","document","getElementById","setStatus","line","detailsObj","safeLine","textContent","safeDetails","formatNumber","toLocaleString","CURRENCY_SYMBOL","formatCost","toFixed","formatCostTotal","formatCostCents","cents","formatDuration","formatTime","toLocaleTimeString","hour","minute","getSectionKey","section","dataset","isSectionLocked","sectionLocked","applySectionOrder","order","sectionMain","querySelector","settingsCard","SECTION_SETTINGS_SELECTOR","sectionElements","insertBefore","appendChild","applySectionVisibility","hidden","locked","shouldHide","classList","toggle","SECTION_HIDDEN_CLASS","pruneHiddenSections","changed","hiddenSections","updateSectionOrder","nextOrder","persist","sectionOrder","renderSectionManager","setSectionOrder","updateHiddenSections","nextHidden","updateOnboardingVisibility","moveSection","indexOf","nextIdx","splice","clearDragState","querySelectorAll","row","remove","innerHTML","sectionTitle","getSectionTitle","visible","createElement","className","sectionKey","setAttribute","handle","draggable","labelEl","controls","upBtn","disabled","addEventListener","downBtn","toggleWrap","toggleInput","checked","toggleSlider","lockTag","CONCURRENCY_LEVELS","GEMINI_REASONING_LEVELS","OPENAI_REASONING_LEVELS","HELP_SELECTOR","SECTION_SELECTOR","KEY_INPUT_SELECTOR","KEY_SAVE_SELECTOR","LICENSE_INPUT_SELECTOR","LICENSE_STATUS_SELECTOR","keyState","licenseState","licenseEntryChoice","keysLoaded","licenseLoaded","onboardingKeysConfirmed","onboardingKeysLoaded","privacyModeEnabled","defaultSectionOrder","draggingSectionKey","expandedLogKeys","toastTimer","logErrorsOnly","lastUsageLogs","rpmLimitValue","DEFAULT_MODELS","MODEL_CATALOG","prices","cachedInput","costLevel","reasoningLevel","warning","recommended","supportsReasoningNone","MODEL_LOOKUP","m","PROVIDER_LABELS","repeatIcon","icon","getModelMeta","syncGeminiReasoningEffort","preferred","effortEl","allowed","getGeminiAllowedReasoningLevels","getReasoningEffortLabel","levels","bestDist","POSITIVE_INFINITY","optIdx","dist","coerceReasoningLabel","syncOpenAIReasoningEffort","allowNone","openaiModelAllowsNone","wrap","closest","formatRate","decimals","modelIndicators","cost","modelOptionLabel","indicators","favorite","updateModelWarningBadge","isGemini","selectEl","warningEl","show","estimateCost","reduce","sum","billableOutputTokens","uncached","coerceCount","normalizeUsageEntry","populateModelSelect","currentModel","requested","requestedKey","matched","style","color","fontWeight","selected","setModalOpen","isOpen","modal","isModalOpen","contains","setSettingsModalOpen","setPricingModalOpen","setOnboardingModalOpen","setOnboardingKeysModalOpen","closePricingModal","setKeyStatus","hasKey","node","updateKeyPlaceholders","keyInput","placeholder","hasAnyApiKey","shouldShow","setModelGate","modelEl","gateEl","updateModelGates","geminiBtn","openaiBtn","hasGemini","hasOpenAI","textEl","updateConfigProviderGate","parseLicenseExpiryMs","formatLicenseExpiry","toLocaleDateString","year","month","day","formatDate","setLicenseStatus","setLicenseStatusAll","setLicenseEntryVisible","isVisible","focus","subscribe","subscribeBtn","haveBtn","refreshLicenseUI","silent","summary","expiry","licenseStatusSummary","updateLicenseStatusNodes","autoVisible","updateLicensePlaceholders","nodes","updateLicenseMeta","step","updateLicenseStepVisibility","clampExp","expToTokens","exp","tokens","setProviderButtons","badge","updateProviderBadge","clampConcurrencyIndex","concurrencyIndexToValue","updateConcurrencyValue","normalizeRpmLimitInput","activateTab","tab","refreshUI","preserveKeyInputs","maxTok","gemModel","oaiModel","gemKeyPresent","oaiKeyPresent","gemReasoningEffort","oaiReasoningEffort","keysConfirmed","all","log2","tokensToExp","normalizedTokens","concurrencyIndex","bestIndex","concurrencyValueToIndex","normalizedConcurrency","normalizedRpm","rpmInput","geminiModelEl","openaiModelEl","selectedGeminiModel","selectedOpenAIModel","safeGeminiEffort","safeEffort","effectiveEffort","defaultProvider","buildBreakdownRow","isSub","tokensEl","costEl","refreshRuntimeStatus","container","total","showQueue","showRpm","main","rpmEl","formatQueueStatusText","rpmTextEl","lim","formatRpmStatusText","stopBtn","applyRuntimeStatus","getRuntimeStatus","refreshUsage","logs","fresh","getRequestLog","usageTotals","cloneUsageTotals","getUsageTotals","breakdown","totals","safeTotals","providerSums","providerTokens","providerCost","modelInput","modelOutput","modelReasoning","modelCached","rawLabel","isUnknown","modelEntry","buildUsageFromTotals","localeCompare","renderUsageBreakdown","renderLogList","canvas","ctx","getContext","width","clientWidth","height","clientHeight","dpr","devicePixelRatio","setTransform","buckets","fill","maxValue","lineColor","getComputedStyle","documentElement","getPropertyValue","clearRect","strokeStyle","lineWidth","y","beginPath","moveTo","lineTo","stroke","gradient","createLinearGradient","addColorStop","closePath","fillStyle","drawUsageChart","isDocumentHidden","refreshUsagePromise","refreshCachePromise","refreshRuntimePromise","refreshUsageGuarded","refreshCacheStatsGuarded","stats","sizeBytes","oldestMs","newestMs","getPersistentCacheStats","formatBytes","refreshCacheStats","refreshRuntimeStatusGuarded","getTokenHeatClass","tokensTotal","logEntryKey","formulaText","updateLogFilterUI","filterBtn","filteredLogs","filterLogEntries","empty","buildTokenFlow","iconText","val","activeKeys","cacheClass","batchClass","top","titleText","entryKey","chevron","tags","display","gap","providerTag","statusTag","costTag","batchTag","cacheTag","gemCacheTag","effortLabel","durationLabel","modelEffortLabel","Boolean","right","baseMeta","detailMeta","cacheNote","tokensWrap","tokensLine","heatDot","tokensTotalEl","tokensDetailEl","createTextNode","updatePrivacyModeUI","hint","cacheStatus","refreshPrivacyMode","saveCommon","savedProvider","setDefaultProvider","savedTokens","openOnboardingSection","focusKey","scrollIntoView","behavior","block","closeAllHelpPopups","help","btn","confirmOnboardingKeys","persistApiKey","setApiKey","saveProviderKey","inputEl","saveProviderModel","newModel","setModel","setInputWarning","isWarning","handleLicenseActivate","buttonEl","originalLabel","success","instance_name","activated","activateLicense","toast","showToast","errorText","dismissOnboarding","markSeen","setOnboardingSeen","clearProvider","clearApiKey","testProvider","r","providerOverride","aiMinimalTest","init","targetId","getAttribute","collapsed","nextCollapsed","triggerRefresh","onChanged","addListener","attachStorageListeners","event","stopPropagation","wasOpen","nextOpen","sections","storedOrder","getSectionOrder","domKeys","keysInDom","normalizeSectionOrder","getHiddenSections","dataTransfer","effectAllowed","setData","preventDefault","clearDropIndicators","rect","getBoundingClientRect","clientY","targetKey","draggedKey","targetIndex","insertIndex","reorderSectionList","moveSectionToEnd","initSectionDrag","initSectionManager","setPrivacyMode","privacyMode","initPrivacyMode","settingsButton","sectionReset","pricingHelp","gemBody","oaiBody","renderProvider","cellModel","cellInput","cellOutput","cellCost","cellReason","renderPricingTable","onboardingClose","onboardingDone","onboardingKeysButton","onboardingKeysSave","geminiInput","openaiInput","geminiKey","openaiKey","saveOnboardingKeys","onboardingKeysLater","updateMaxTokensValue","saved","concurrency","saveConcurrency","updateRpmLimitValue","saveRpmLimit","geminiEffortEl","saveGeminiReasoningEffort","saveOpenAIReasoningEffort","actionBtn","click","keySave","keyConfirm","licenseModeSubscribe","licenseModeHave","targetBtn","licenseTarget","inputKey","keyToTest","validateLicense","handleLicenseTest","clearStoredLicense","handleLicenseClear","clearGeminiBtn","clearOpenAIBtn","testGeminiBtn","testOpenAIBtn","clearUsageBtn","clearUsageTotals","logFilterErrors","queueStop","stopQueuedRequests","getOnboardingSeen","maybeShowOnboarding","Office","onReady","safeOfficeReady"],"ignoreList":[],"sourceRoot":""}