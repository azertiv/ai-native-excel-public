{"version":3,"file":"taskpane.js","mappings":"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","sources":["webpack://excel-ai-gemini-addin/./src/shared/core.js","webpack://excel-ai-gemini-addin/./src/shared/providers.js","webpack://excel-ai-gemini-addin/./src/taskpane/taskpane.js"],"sourcesContent":["// src/shared/core.js\n// Shared utilities + persisted configuration for the AI.Native add-in.\n//\n// Key design goals:\n// - Two providers (Gemini + OpenAI) can coexist.\n// - The default provider is chosen in the taskpane (not in formulas).\n// - No temperature / sampling controls anywhere (per requirements).\n// - A single \"max output tokens\" setting applies to both providers.\n\nexport const PROVIDERS = Object.freeze({\n  GEMINI: \"gemini\",\n  OPENAI: \"openai\"\n});\n\nexport const DEFAULTS = Object.freeze({\n  provider: PROVIDERS.GEMINI,\n  // Default models (User specified future versions)\n  geminiModel: \"gemini-3-flash-preview\",\n  openaiModel: \"gpt-5-mini\",\n  openaiReasoningEffort: \"medium\",\n  maxOutputTokens: 1024,\n\n  // Execution / UX\n  retry: 2,\n  timeoutMs: 120000,\n\n  // In-memory cache (per runtime). Note: Office custom functions can run in a long-lived runtime.\n  cache: true,\n  cacheTtlSec: 7 * 24 * 3600, // 7 days\n  webCacheTtlSec: 3600 // 1 hour (web results change more often)\n});\n\nconst STORAGE_KEYS = Object.freeze({\n  DEFAULT_PROVIDER: \"AI_DEFAULT_PROVIDER_V3\",\n  GEMINI_API_KEY: \"AI_GEMINI_API_KEY_V3\",\n  OPENAI_API_KEY: \"AI_OPENAI_API_KEY_V3\",\n  GEMINI_MODEL: \"AI_GEMINI_MODEL_V3\",\n  OPENAI_MODEL: \"AI_OPENAI_MODEL_V3\",\n  OPENAI_REASONING_EFFORT: \"AI_OPENAI_REASONING_EFFORT_V3\",\n  MAX_OUTPUT_TOKENS: \"AI_MAX_OUTPUT_TOKENS_V3\",\n\n  // Prevent re-running migrations each time.\n  MIGRATION_DONE: \"AI_MIGRATION_DONE_V3\",\n\n  // Diagnostics + cache metadata\n  REQUEST_LOG: \"AI_REQUEST_LOG_V1\",\n  REQUEST_LOG_CLEAR_AT: \"AI_REQUEST_LOG_CLEAR_AT_V1\",\n  CACHE_INDEX: \"AI_CACHE_INDEX_V1\",\n  CACHE_CLEAR_AT: \"AI_CACHE_CLEAR_AT_V1\"\n});\n\n// Older keys used by previous versions (best-effort migration).\nconst LEGACY_KEYS = Object.freeze({\n  GEMINI_API_KEY: \"GEMINI_API_KEY\",\n  MAX_OUTPUT_TOKENS: \"MAX_OUTPUT_TOKENS\",\n\n  DEFAULT_PROVIDER_V2: \"AI_DEFAULT_PROVIDER_V2\",\n  GEMINI_API_KEY_V2: \"AI_GEMINI_API_KEY_V2\",\n  OPENAI_API_KEY_V2: \"AI_OPENAI_API_KEY_V2\",\n  GEMINI_MODEL_V2: \"AI_GEMINI_MODEL_V2\",\n  OPENAI_MODEL_V2: \"AI_OPENAI_MODEL_V2\",\n\n  GEMINI_MAX_TOKENS_V2: \"AI_GEMINI_MAX_OUTPUT_TOKENS_V2\",\n  OPENAI_MAX_TOKENS_V2: \"AI_OPENAI_MAX_OUTPUT_TOKENS_V2\"\n});\n\nlet _migrationPromise = null;\n\nfunction getRuntimeStorage() {\n  try {\n    if (typeof OfficeRuntime !== \"undefined\" && OfficeRuntime?.storage?.getItem) {\n      return { kind: \"office\", storage: OfficeRuntime.storage };\n    }\n  } catch {\n    // ignore\n  }\n\n  try {\n    if (typeof window !== \"undefined\" && window?.localStorage?.getItem) {\n      return { kind: \"local\", storage: window.localStorage };\n    }\n  } catch {\n    // ignore\n  }\n\n  // Extremely defensive fallback (in-memory only).\n  const mem = new Map();\n  return {\n    kind: \"memory\",\n    storage: {\n      async getItem(k) {\n        return mem.has(k) ? mem.get(k) : null;\n      },\n      async setItem(k, v) {\n        mem.set(k, String(v));\n      },\n      async removeItem(k) {\n        mem.delete(k);\n      }\n    }\n  };\n}\n\nfunction getLocalStorageSafe() {\n  try {\n    if (typeof window !== \"undefined\" && window?.localStorage?.getItem) {\n      return window.localStorage;\n    }\n  } catch {\n    return null;\n  }\n  return null;\n}\n\nexport function storageBackendName() {\n  return getRuntimeStorage().kind;\n}\n\nasync function rawGet(key) {\n  const { kind, storage } = getRuntimeStorage();\n  if (kind === \"local\") {\n    try {\n      return storage.getItem(key);\n    } catch {\n      return null;\n    }\n  }\n\n  if (kind === \"office\") {\n    try {\n      const result = await storage.getItem(key);\n      if (result == null) {\n        const local = getLocalStorageSafe();\n        if (!local) return null;\n        try {\n          const localValue = local.getItem(key);\n          return localValue == null ? null : localValue;\n        } catch {\n          return null;\n        }\n      }\n      return result;\n    } catch {\n      const local = getLocalStorageSafe();\n      if (!local) return null;\n      try {\n        return local.getItem(key);\n      } catch {\n        return null;\n      }\n    }\n  }\n\n  try {\n    return await storage.getItem(key);\n  } catch {\n    return null;\n  }\n}\n\nasync function rawSet(key, value) {\n  const { kind, storage } = getRuntimeStorage();\n  const v = value == null ? \"\" : String(value);\n  if (kind === \"local\") {\n    try {\n      storage.setItem(key, v);\n      return;\n    } catch {\n      return;\n    }\n  }\n\n  if (kind === \"office\") {\n    try {\n      await storage.setItem(key, v);\n    } catch {\n      // ignore and try local\n    }\n    const local = getLocalStorageSafe();\n    if (!local) return;\n    try {\n      local.setItem(key, v);\n    } catch {\n      // ignore\n    }\n    return;\n  }\n\n  try {\n    await storage.setItem(key, v);\n  } catch {\n    // ignore\n  }\n}\n\nasync function rawRemove(key) {\n  const { kind, storage } = getRuntimeStorage();\n  if (kind === \"local\") {\n    try {\n      storage.removeItem(key);\n      return;\n    } catch {\n      return;\n    }\n  }\n\n  if (kind === \"office\") {\n    try {\n      await storage.removeItem(key);\n    } catch {\n      // ignore and try local\n    }\n    const local = getLocalStorageSafe();\n    if (!local) return;\n    try {\n      local.removeItem(key);\n    } catch {\n      // ignore\n    }\n    return;\n  }\n\n  try {\n    await storage.removeItem(key);\n  } catch {\n    // ignore\n  }\n}\n\nasync function ensureMigrated() {\n  if (_migrationPromise) return _migrationPromise;\n\n  _migrationPromise = (async () => {\n    // Fast exit if already migrated\n    const done = await rawGet(STORAGE_KEYS.MIGRATION_DONE);\n    if (done === \"1\") return;\n\n    // Migrate provider\n    const currentProvider = normalizeProvider(await rawGet(STORAGE_KEYS.DEFAULT_PROVIDER));\n    if (!currentProvider) {\n      const legacyProvider = normalizeProvider(await rawGet(LEGACY_KEYS.DEFAULT_PROVIDER_V2));\n      await rawSet(STORAGE_KEYS.DEFAULT_PROVIDER, legacyProvider || DEFAULTS.provider);\n    }\n\n    // Migrate keys\n    const gKey = await rawGet(STORAGE_KEYS.GEMINI_API_KEY);\n    if (!gKey) {\n      const legacy = (await rawGet(LEGACY_KEYS.GEMINI_API_KEY_V2)) || (await rawGet(LEGACY_KEYS.GEMINI_API_KEY));\n      if (legacy) await rawSet(STORAGE_KEYS.GEMINI_API_KEY, legacy);\n    }\n\n    const oKey = await rawGet(STORAGE_KEYS.OPENAI_API_KEY);\n    if (!oKey) {\n      const legacy = await rawGet(LEGACY_KEYS.OPENAI_API_KEY_V2);\n      if (legacy) await rawSet(STORAGE_KEYS.OPENAI_API_KEY, legacy);\n    }\n\n    // Migrate models\n    const gModel = await rawGet(STORAGE_KEYS.GEMINI_MODEL);\n    if (!gModel) {\n      const legacy = await rawGet(LEGACY_KEYS.GEMINI_MODEL_V2);\n      await rawSet(STORAGE_KEYS.GEMINI_MODEL, legacy || DEFAULTS.geminiModel);\n    }\n\n    const oModel = await rawGet(STORAGE_KEYS.OPENAI_MODEL);\n    if (!oModel) {\n      const legacy = await rawGet(LEGACY_KEYS.OPENAI_MODEL_V2);\n      await rawSet(STORAGE_KEYS.OPENAI_MODEL, legacy || DEFAULTS.openaiModel);\n    }\n\n    // Migrate max tokens (unified)\n    const tok = await rawGet(STORAGE_KEYS.MAX_OUTPUT_TOKENS);\n    if (!tok) {\n      const legacyUnified = await rawGet(LEGACY_KEYS.MAX_OUTPUT_TOKENS);\n      const legacyGem = await rawGet(LEGACY_KEYS.GEMINI_MAX_TOKENS_V2);\n      const legacyOai = await rawGet(LEGACY_KEYS.OPENAI_MAX_TOKENS_V2);\n\n      const candidates = [legacyUnified, legacyGem, legacyOai]\n        .map((x) => parseInt(String(x || \"\").trim(), 10))\n        .filter((n) => Number.isFinite(n) && n > 0);\n\n      const migrated = candidates.length ? Math.max(...candidates) : DEFAULTS.maxOutputTokens;\n      await rawSet(STORAGE_KEYS.MAX_OUTPUT_TOKENS, String(migrated));\n    }\n\n    await rawSet(STORAGE_KEYS.MIGRATION_DONE, \"1\");\n  })();\n\n  try {\n    await _migrationPromise;\n  } finally {\n    _migrationPromise = null;\n  }\n}\n\nexport function normalizeProvider(p) {\n  if (!p) return \"\";\n  const s = String(p).trim().toLowerCase();\n  if (s === PROVIDERS.GEMINI) return PROVIDERS.GEMINI;\n  if (s === PROVIDERS.OPENAI) return PROVIDERS.OPENAI;\n  // Common aliases (defensive)\n  if (s === \"google\" || s === \"gem\") return PROVIDERS.GEMINI;\n  if (s === \"oai\" || s === \"chatgpt\") return PROVIDERS.OPENAI;\n  return \"\";\n}\n\nconst OPENAI_REASONING_EFFORTS = new Set([\"none\", \"minimal\", \"low\", \"medium\", \"high\"]);\n\nfunction normalizeReasoningEffort(value) {\n  const v = String(value || \"\").trim().toLowerCase();\n  if (!v) return DEFAULTS.openaiReasoningEffort;\n  return OPENAI_REASONING_EFFORTS.has(v) ? v : DEFAULTS.openaiReasoningEffort;\n}\n\nexport async function getDefaultProvider() {\n  await ensureMigrated();\n  const p = normalizeProvider(await rawGet(STORAGE_KEYS.DEFAULT_PROVIDER));\n  return p || DEFAULTS.provider;\n}\n\nexport async function setDefaultProvider(provider) {\n  const p = normalizeProvider(provider) || DEFAULTS.provider;\n  await rawSet(STORAGE_KEYS.DEFAULT_PROVIDER, p);\n  return p;\n}\n\nfunction keyKey(provider) {\n  const p = normalizeProvider(provider);\n  if (p === PROVIDERS.OPENAI) return STORAGE_KEYS.OPENAI_API_KEY;\n  return STORAGE_KEYS.GEMINI_API_KEY;\n}\n\nexport async function getApiKey(provider) {\n  await ensureMigrated();\n  const k = await rawGet(keyKey(provider));\n  return (k || \"\").trim();\n}\n\nexport async function setApiKey(provider, apiKey) {\n  const k = (apiKey || \"\").trim();\n  await rawSet(keyKey(provider), k);\n  return k;\n}\n\nexport async function clearApiKey(provider) {\n  await rawRemove(keyKey(provider));\n}\n\nfunction modelKey(provider) {\n  const p = normalizeProvider(provider);\n  if (p === PROVIDERS.OPENAI) return STORAGE_KEYS.OPENAI_MODEL;\n  return STORAGE_KEYS.GEMINI_MODEL;\n}\n\nexport async function getModel(provider) {\n  await ensureMigrated();\n  const p = normalizeProvider(provider);\n  const raw = await rawGet(modelKey(p));\n  if (raw && String(raw).trim()) return String(raw).trim();\n  return p === PROVIDERS.OPENAI ? DEFAULTS.openaiModel : DEFAULTS.geminiModel;\n}\n\nexport async function getOpenAIReasoningEffort() {\n  await ensureMigrated();\n  const raw = await rawGet(STORAGE_KEYS.OPENAI_REASONING_EFFORT);\n  return normalizeReasoningEffort(raw || DEFAULTS.openaiReasoningEffort);\n}\n\nexport async function setModel(provider, model) {\n  const p = normalizeProvider(provider);\n  const v = String(model || \"\").trim();\n  if (!v) {\n    // Reset to default if emptied\n    await rawSet(modelKey(p), p === PROVIDERS.OPENAI ? DEFAULTS.openaiModel : DEFAULTS.geminiModel);\n    return;\n  }\n  await rawSet(modelKey(p), v);\n}\n\nexport async function setOpenAIReasoningEffort(value) {\n  const v = normalizeReasoningEffort(value);\n  await rawSet(STORAGE_KEYS.OPENAI_REASONING_EFFORT, v);\n  return v;\n}\n\nexport async function getMaxOutputTokens() {\n  await ensureMigrated();\n  const raw = await rawGet(STORAGE_KEYS.MAX_OUTPUT_TOKENS);\n  const n = parseInt(String(raw || \"\").trim(), 10);\n  return clampInt(n, 1, 128000, DEFAULTS.maxOutputTokens);\n}\n\nexport async function setMaxOutputTokens(value) {\n  const n = clampInt(value, 1, 128000, DEFAULTS.maxOutputTokens);\n  await rawSet(STORAGE_KEYS.MAX_OUTPUT_TOKENS, String(n));\n  return n;\n}\n\n// ---------- Small utilities ----------\nexport function nowMs() {\n  return Date.now();\n}\n\nexport function sleep(ms) {\n  return new Promise((resolve) => setTimeout(resolve, ms));\n}\n\nexport function clamp(value, min, max, fallback = min) {\n  const n = Number(value);\n  if (!Number.isFinite(n)) return fallback;\n  return Math.max(min, Math.min(max, n));\n}\n\nexport function clampInt(value, min, max, fallback = min) {\n  const n = parseInt(String(value), 10);\n  if (!Number.isFinite(n)) return fallback;\n  return Math.max(min, Math.min(max, n));\n}\n\nfunction parseTimestampMs(raw) {\n  const n = parseInt(String(raw || \"\").trim(), 10);\n  return Number.isFinite(n) && n > 0 ? n : 0;\n}\n\n// ---------- LRU cache with TTL ----------\nexport class LRUCache {\n  constructor(maxEntries = 500) {\n    this.maxEntries = maxEntries;\n    this.map = new Map(); // key => {value, expiresAtMs}\n  }\n\n  get(key) {\n    if (!this.map.has(key)) return null;\n    const entry = this.map.get(key);\n\n    if (entry?.expiresAtMs && entry.expiresAtMs <= nowMs()) {\n      this.map.delete(key);\n      return null;\n    }\n\n    // Refresh key order (most recent)\n    this.map.delete(key);\n    this.map.set(key, entry);\n    return entry.value;\n  }\n\n  set(key, value, ttlMs) {\n    const expiresAtMs = typeof ttlMs === \"number\" && ttlMs > 0 ? nowMs() + ttlMs : null;\n    if (this.map.has(key)) this.map.delete(key);\n    this.map.set(key, { value, expiresAtMs });\n\n    // Evict LRU\n    while (this.map.size > this.maxEntries) {\n      const oldestKey = this.map.keys().next().value;\n      this.map.delete(oldestKey);\n    }\n  }\n\n  clear() {\n    this.map.clear();\n  }\n}\n\n// ---------- Persistent cache (survives reloads) ----------\nconst CACHE_ENTRY_PREFIX = \"AI_CACHE_ENTRY_V1:\";\nconst CACHE_INDEX_MAX = 250;\nlet _cacheClearMs = 0;\n\nasync function syncCacheClearMarker() {\n  const clearedAt = parseTimestampMs(await rawGet(STORAGE_KEYS.CACHE_CLEAR_AT));\n  if (clearedAt > _cacheClearMs) _cacheClearMs = clearedAt;\n  return _cacheClearMs;\n}\n\nexport async function getCacheClearAt() {\n  return await syncCacheClearMarker();\n}\n\nasync function loadCacheIndex() {\n  const raw = await rawGet(STORAGE_KEYS.CACHE_INDEX);\n  if (!raw) return [];\n  try {\n    const arr = JSON.parse(raw);\n    return Array.isArray(arr) ? arr : [];\n  } catch {\n    return [];\n  }\n}\n\nasync function saveCacheIndex(entries) {\n  try {\n    await rawSet(STORAGE_KEYS.CACHE_INDEX, JSON.stringify(entries));\n  } catch {\n    // ignore\n  }\n}\n\nfunction pruneCacheIndex(entries, clearedAt = 0) {\n  const now = nowMs();\n  const kept = [];\n  const removedKeys = [];\n\n  for (const entry of entries || []) {\n    if (!entry || !entry.key) continue;\n    const savedAt = Number(entry.savedAtMs || 0);\n    if (clearedAt && (!Number.isFinite(savedAt) || savedAt <= clearedAt)) {\n      removedKeys.push(entry.key);\n      continue;\n    }\n    if (entry.expiresAtMs && entry.expiresAtMs <= now) {\n      removedKeys.push(entry.key);\n      continue;\n    }\n    kept.push(entry);\n  }\n\n  if (kept.length > CACHE_INDEX_MAX) {\n    kept.sort((a, b) => (a.savedAtMs || 0) - (b.savedAtMs || 0));\n    const over = kept.length - CACHE_INDEX_MAX;\n    const toRemove = kept.slice(0, over);\n    for (const r of toRemove) removedKeys.push(r.key);\n    return { list: kept.slice(over), removedKeys };\n  }\n\n  return { list: kept, removedKeys };\n}\n\nasync function removeCacheEntry(key) {\n  if (!key) return;\n  await rawRemove(CACHE_ENTRY_PREFIX + key);\n}\n\nasync function removeFromCacheIndex(key) {\n  const index = await loadCacheIndex();\n  const next = (index || []).filter((item) => item?.key !== key);\n  if (next.length !== index.length) await saveCacheIndex(next);\n}\n\nexport async function getPersistentCache(cacheKey) {\n  if (!cacheKey) return null;\n  const clearedAt = await syncCacheClearMarker();\n  const raw = await rawGet(CACHE_ENTRY_PREFIX + cacheKey);\n  if (!raw) {\n    await removeFromCacheIndex(cacheKey);\n    return null;\n  }\n\n  try {\n    const entry = JSON.parse(raw);\n    if (!entry || typeof entry !== \"object\") throw new Error(\"Invalid entry\");\n    const savedAt = Number(entry.savedAtMs || 0);\n    if (clearedAt && (!Number.isFinite(savedAt) || savedAt <= clearedAt)) {\n      await removeCacheEntry(cacheKey);\n      await removeFromCacheIndex(cacheKey);\n      return null;\n    }\n    if (entry.expiresAtMs && entry.expiresAtMs <= nowMs()) {\n      await removeCacheEntry(cacheKey);\n      await removeFromCacheIndex(cacheKey);\n      return null;\n    }\n    return entry.value || null;\n  } catch {\n    await removeCacheEntry(cacheKey);\n    await removeFromCacheIndex(cacheKey);\n    return null;\n  }\n}\n\nexport async function setPersistentCache(cacheKey, value, ttlMs, meta = {}) {\n  if (!cacheKey) return;\n  const now = nowMs();\n  const clearedAt = await syncCacheClearMarker();\n  const savedAtMs = clearedAt && now <= clearedAt ? clearedAt + 1 : now;\n  const expiresAtMs = typeof ttlMs === \"number\" && ttlMs > 0 ? savedAtMs + ttlMs : null;\n  const entry = {\n    v: 1,\n    savedAtMs,\n    expiresAtMs,\n    value\n  };\n\n  const raw = JSON.stringify(entry);\n  await rawSet(CACHE_ENTRY_PREFIX + cacheKey, raw);\n\n  const index = await loadCacheIndex();\n  const provider = meta.provider || value?.provider || \"\";\n  const model = meta.model || value?.model || \"\";\n  const size = raw.length;\n\n  let updated = false;\n  const next = (index || []).map((item) => {\n    if (item?.key !== cacheKey) return item;\n    updated = true;\n    return {\n      key: cacheKey,\n      provider,\n      model,\n      size,\n      savedAtMs,\n      expiresAtMs\n    };\n  });\n\n  if (!updated) {\n    next.push({\n      key: cacheKey,\n      provider,\n      model,\n      size,\n      savedAtMs,\n      expiresAtMs\n    });\n  }\n\n  const pruned = pruneCacheIndex(next, clearedAt);\n  for (const key of pruned.removedKeys) await removeCacheEntry(key);\n  await saveCacheIndex(pruned.list);\n}\n\nexport async function clearPersistentCache() {\n  const clearedAt = nowMs();\n  _cacheClearMs = clearedAt;\n  await rawSet(STORAGE_KEYS.CACHE_CLEAR_AT, String(clearedAt));\n  const index = await loadCacheIndex();\n  for (const item of index || []) {\n    if (!item?.key) continue;\n    await removeCacheEntry(item.key);\n  }\n  await rawRemove(STORAGE_KEYS.CACHE_INDEX);\n}\n\nexport async function getPersistentCacheStats() {\n  const index = await loadCacheIndex();\n  const clearedAt = await syncCacheClearMarker();\n  const pruned = pruneCacheIndex(index, clearedAt);\n  if (pruned.removedKeys.length) {\n    for (const key of pruned.removedKeys) await removeCacheEntry(key);\n    await saveCacheIndex(pruned.list);\n  }\n\n  const stats = {\n    entries: 0,\n    sizeBytes: 0,\n    providers: {\n      gemini: { entries: 0, sizeBytes: 0 },\n      openai: { entries: 0, sizeBytes: 0 }\n    },\n    oldestMs: null,\n    newestMs: null\n  };\n\n  for (const item of pruned.list || []) {\n    if (!item?.key) continue;\n    stats.entries += 1;\n    stats.sizeBytes += Number(item.size || 0);\n    const provider = String(item.provider || \"\").toLowerCase();\n    if (provider === PROVIDERS.GEMINI) {\n      stats.providers.gemini.entries += 1;\n      stats.providers.gemini.sizeBytes += Number(item.size || 0);\n    } else if (provider === PROVIDERS.OPENAI) {\n      stats.providers.openai.entries += 1;\n      stats.providers.openai.sizeBytes += Number(item.size || 0);\n    }\n\n    const savedAt = Number(item.savedAtMs || 0);\n    if (savedAt) {\n      stats.oldestMs = stats.oldestMs == null ? savedAt : Math.min(stats.oldestMs, savedAt);\n      stats.newestMs = stats.newestMs == null ? savedAt : Math.max(stats.newestMs, savedAt);\n    }\n  }\n\n  return stats;\n}\n\n// ---------- Stable stringify + hashing (for cache keys) ----------\nfunction isPlainObject(v) {\n  return Object.prototype.toString.call(v) === \"[object Object]\";\n}\n\nexport function stableStringify(value) {\n  return JSON.stringify(sortKeysDeep(value));\n}\n\nfunction sortKeysDeep(value) {\n  if (Array.isArray(value)) return value.map(sortKeysDeep);\n  if (isPlainObject(value)) {\n    const out = {};\n    for (const k of Object.keys(value).sort()) out[k] = sortKeysDeep(value[k]);\n    return out;\n  }\n  return value;\n}\n\nfunction fnv1a32(str) {\n  let h = 2166136261;\n  for (let i = 0; i < str.length; i++) {\n    h ^= str.charCodeAt(i);\n    h = Math.imul(h, 16777619);\n  }\n  // Unsigned\n  return (h >>> 0).toString(16).padStart(8, \"0\");\n}\n\nexport async function hashKey(input) {\n  const text = typeof input === \"string\" ? input : stableStringify(input);\n\n  // Prefer SHA-256 when available (browser/Office runtime)\n  try {\n    if (typeof crypto !== \"undefined\" && crypto?.subtle?.digest && typeof TextEncoder !== \"undefined\") {\n      const enc = new TextEncoder();\n      const bytes = enc.encode(text);\n      const digest = await crypto.subtle.digest(\"SHA-256\", bytes);\n      const arr = Array.from(new Uint8Array(digest));\n      return arr.map((b) => b.toString(16).padStart(2, \"0\")).join(\"\");\n    }\n  } catch {\n    // ignore and fallback\n  }\n\n  return `fnv1a:${fnv1a32(text)}`;\n}\n\n// ---------- Lightweight diagnostics log (persisted) ----------\nconst REQUEST_LOG_MAX = 500;\nconst REQUEST_LOG_TTL_MS = 24 * 60 * 60 * 1000; // 24h\nlet _requestLog = [];\nlet _requestLogLoading = null;\nlet _requestLogLoaded = false;\nlet _requestLogLastLoadedMs = 0;\nlet _requestLogClearMs = 0;\n\nasync function syncRequestLogClearMarker(options = {}) {\n  const clearedAt = parseTimestampMs(await rawGet(STORAGE_KEYS.REQUEST_LOG_CLEAR_AT));\n  if (clearedAt > _requestLogClearMs) {\n    _requestLogClearMs = clearedAt;\n    _requestLog = [];\n    if (options.reset) {\n      _requestLogLoaded = true;\n      _requestLogLoading = null;\n      _requestLogLastLoadedMs = nowMs();\n    } else {\n      _requestLogLoaded = false;\n    }\n  }\n  return _requestLogClearMs;\n}\n\nasync function loadRequestLog(force = false) {\n  if (_requestLogLoading) return _requestLogLoading;\n\n  _requestLogLoading = (async () => {\n    const clearedAt = await syncRequestLogClearMarker();\n    if (!force && _requestLogLoaded) return _requestLog;\n    const raw = await rawGet(STORAGE_KEYS.REQUEST_LOG);\n    let arr = [];\n    if (raw) {\n      try {\n        const parsed = JSON.parse(raw);\n        if (Array.isArray(parsed)) arr = parsed;\n      } catch {\n        arr = [];\n      }\n    }\n    const now = nowMs();\n    arr = arr\n      .map((e) => {\n        if (!e) return null;\n        let ts = e.ts;\n        if (typeof ts === \"string\") {\n          const parsed = Date.parse(ts);\n          if (Number.isFinite(parsed)) ts = parsed;\n        }\n        if (typeof ts !== \"number\") return null;\n        return { ...e, ts };\n      })\n      .filter((e) => e && typeof e.ts === \"number\" && e.ts > clearedAt && now - e.ts <= REQUEST_LOG_TTL_MS);\n    _requestLog = arr.slice(-REQUEST_LOG_MAX);\n    _requestLogLoaded = true;\n    _requestLogLastLoadedMs = nowMs();\n    return _requestLog;\n  })();\n\n  try {\n    return await _requestLogLoading;\n  } finally {\n    _requestLogLoading = null;\n  }\n}\n\nasync function persistRequestLog() {\n  try {\n    await rawSet(STORAGE_KEYS.REQUEST_LOG, JSON.stringify(_requestLog.slice(-REQUEST_LOG_MAX)));\n  } catch {\n    // ignore\n  }\n}\n\nfunction pruneRequestLog() {\n  const now = nowMs();\n  const clearedAt = _requestLogClearMs || 0;\n  _requestLog = (_requestLog || []).filter(\n    (e) => e && typeof e.ts === \"number\" && e.ts > clearedAt && now - e.ts <= REQUEST_LOG_TTL_MS\n  );\n  if (_requestLog.length > REQUEST_LOG_MAX) {\n    _requestLog = _requestLog.slice(-REQUEST_LOG_MAX);\n  }\n}\n\nexport function logRequest(entry) {\n  void logRequestAsync(entry);\n}\n\nasync function logRequestAsync(entry) {\n  try {\n    await syncRequestLogClearMarker({ reset: true });\n    const logEntry = { ts: nowMs(), ...entry };\n\n    if (_requestLogLoaded) {\n      _requestLog.push(logEntry);\n      pruneRequestLog();\n      _requestLogLastLoadedMs = nowMs();\n      await persistRequestLog();\n      return;\n    }\n\n    await loadRequestLog();\n    _requestLog.push(logEntry);\n    pruneRequestLog();\n    _requestLogLastLoadedMs = nowMs();\n    await persistRequestLog();\n  } catch {\n    // ignore\n  }\n}\n\nexport async function getRequestLog(options = {}) {\n  const force = !!options?.fresh;\n  const now = nowMs();\n  if (force || !_requestLogLoaded || now - _requestLogLastLoadedMs > 1500) {\n    await loadRequestLog(true);\n  } else {\n    await loadRequestLog(false);\n  }\n  return _requestLog.slice();\n}\n\nexport async function clearRequestLog() {\n  const clearedAt = nowMs();\n  _requestLog = [];\n  _requestLogLoaded = true;\n  _requestLogLoading = null;\n  _requestLogClearMs = clearedAt;\n  _requestLogLastLoadedMs = clearedAt;\n  await rawSet(STORAGE_KEYS.REQUEST_LOG_CLEAR_AT, String(clearedAt));\n  await rawRemove(STORAGE_KEYS.REQUEST_LOG);\n}\n","// src/shared/providers.js\n// Provider implementations (Gemini + OpenAI) and shared request orchestration.\n//\n// Requirements implemented:\n// - Gemini 3 Flash (via Google Generative Language API)\n// - OpenAI GPT-5 Mini (via OpenAI Responses API)\n// - No temperature / sampling parameters are ever sent\n// - Provider selection happens via taskpane default provider (formulas cannot override)\n// - AI.WEB uses provider-native web search mechanisms:\n//   - Gemini: google_search tool\n//   - OpenAI: web_search tool\n\nimport {\n  PROVIDERS,\n  DEFAULTS,\n  normalizeProvider,\n  getDefaultProvider,\n  getApiKey,\n  getModel,\n  getOpenAIReasoningEffort,\n  getMaxOutputTokens,\n  clampInt,\n  nowMs,\n  sleep,\n  LRUCache,\n  hashKey,\n  logRequest,\n  getCacheClearAt,\n  getPersistentCache,\n  setPersistentCache,\n  clearPersistentCache\n} from \"./core.js\";\n\n// ---- In-memory cache (per runtime) ----\nconst CACHE = new LRUCache(800);\nlet _cacheClearLocalMs = 0;\n\nasync function syncCacheClearMarker() {\n  const clearedAt = await getCacheClearAt();\n  if (clearedAt > _cacheClearLocalMs) {\n    _cacheClearLocalMs = clearedAt;\n    CACHE.clear();\n  }\n}\n\n// Deduplicate in-flight identical requests to avoid bursts (per runtime)\nconst INFLIGHT = new Map(); // key => Promise<AIResult>\n\n// Basic concurrency limiter (per runtime)\nconst MAX_CONCURRENCY = 4;\nlet active = 0;\nconst queue = [];\n\nasync function withConcurrencyLimit(fn) {\n  if (active >= MAX_CONCURRENCY) await new Promise((resolve) => queue.push(resolve));\n  active++;\n  try {\n    return await fn();\n  } finally {\n    active--;\n    const next = queue.shift();\n    if (next) next();\n  }\n}\n\nfunction isNonEmptyString(s) {\n  return typeof s === \"string\" && s.trim().length > 0;\n}\n\nfunction normalizeBoolean(v, def = false) {\n  if (typeof v === \"boolean\") return v;\n  if (typeof v === \"number\") return v !== 0;\n  if (typeof v === \"string\") {\n    const s = v.trim().toLowerCase();\n    if ([\"1\", \"true\", \"yes\", \"y\", \"on\"].includes(s)) return true;\n    if ([\"0\", \"false\", \"no\", \"n\", \"off\"].includes(s)) return false;\n  }\n  return def;\n}\n\nfunction normalizeTimeoutMs(v) {\n  return clampInt(v, 1000, 120000, DEFAULTS.timeoutMs);\n}\n\nfunction normalizeRetry(v) {\n  return clampInt(v, 0, 5, DEFAULTS.retry);\n}\n\nfunction normalizeMaxOutputTokens(v) {\n  return clampInt(v, 1, 128000, DEFAULTS.maxOutputTokens);\n}\n\nfunction toLowerMsg(v) {\n  return String(v || \"\").toLowerCase();\n}\n\nfunction looksLikeStructuredOutputUnsupported(message) {\n  const s = toLowerMsg(message);\n  if (!s) return false;\n  return (\n    s.includes(\"responseschema\") ||\n    s.includes(\"response schema\") ||\n    s.includes(\"response_schema\") ||\n    s.includes(\"responsemime\") ||\n    s.includes(\"response mime\") ||\n    s.includes(\"response_mime\") ||\n    s.includes(\"response_mime_type\") ||\n    s.includes(\"json_schema\") ||\n    s.includes(\"response_format\") ||\n    s.includes(\"text.format\")\n  );\n}\n\nfunction looksLikeWebSearchUnsupported(message) {\n  const s = toLowerMsg(message);\n  if (!s) return false;\n  if (!(s.includes(\"web_search\") || s.includes(\"google_search\") || s.includes(\"web search\") || s.includes(\"google search\"))) {\n    return false;\n  }\n  return (\n    s.includes(\"not supported\") ||\n    s.includes(\"unsupported\") ||\n    s.includes(\"unknown\") ||\n    s.includes(\"unrecognized\") ||\n    s.includes(\"invalid\") ||\n    s.includes(\"not enabled\") ||\n    s.includes(\"not available\")\n  );\n}\n\nfunction ensureJsonInstruction(system) {\n  const suffix = \" Return valid JSON only.\";\n  if (!isNonEmptyString(system)) return \"Return valid JSON only.\";\n  const s = String(system).trim();\n  if (/json/i.test(s)) return s;\n  return s + suffix;\n}\n\nfunction extractFormulaFromText(text) {\n  if (!isNonEmptyString(text)) return \"\";\n  const raw = String(text).trim();\n  const match = raw.match(/=[^\\n\\r]+/);\n  const formula = (match ? match[0] : raw).trim();\n  if (!formula.startsWith(\"=\")) return \"\";\n  return formula;\n}\n\nfunction getFormulaForLog(fnName, text) {\n  if (fnName !== \"AI.FORMULA\") return \"\";\n  return extractFormulaFromText(text);\n}\n\n// ---- Public API ----\n\n/**\n * @typedef {Object} AIGenerateRequest\n * @property {string=} provider Optional override (should only be used by taskpane tests, not formulas).\n * @property {string=} system System instruction.\n * @property {string} user User prompt.\n * @property {boolean=} webSearch Enable provider web search tool.\n * @property {number=} maxOutputTokens Override max tokens (optional; normally from panel).\n * @property {number=} timeoutMs\n * @property {number=} retry\n * @property {boolean=} cache\n * @property {number=} cacheTtlSec\n * @property {string=} responseMimeType e.g., \"application/json\"\n * @property {Object=} responseJsonSchema JSON schema (strict) for structured output.\n * @property {string=} functionName Name for diagnostics.\n */\n\n/**\n * @typedef {Object} AIResult\n * @property {boolean} ok\n * @property {string=} text\n * @property {Array<{title?: string, url: string}>=} sources\n * @property {string=} provider\n * @property {string=} model\n * @property {Object=} usage\n * @property {string=} code\n * @property {string=} message\n */\n\nexport async function aiGenerate(req) {\n  const start = nowMs();\n  const provider = normalizeProvider(req?.provider) || (await getDefaultProvider());\n  const model = await getModel(provider);\n  const apiKey = await getApiKey(provider);\n  const fnName = req?.functionName || \"aiGenerate\";\n\n  if (!apiKey) {\n    logRequest({\n      fn: fnName,\n      provider,\n      model,\n      ok: false,\n      ms: nowMs() - start,\n      cache: false,\n      code: \"API_KEY_MISSING\",\n      message: `Cl API manquante pour le fournisseur ${provider}.`\n    });\n    return {\n      ok: false,\n      provider,\n      model,\n      code: \"API_KEY_MISSING\",\n      message: `Cl API manquante pour le fournisseur ${provider}.`\n    };\n  }\n\n  const user = String(req?.user || \"\");\n  const system = isNonEmptyString(req?.system) ? String(req.system) : \"\";\n\n  const webSearch = normalizeBoolean(req?.webSearch, false);\n  const timeoutMs = normalizeTimeoutMs(req?.timeoutMs);\n  const retry = normalizeRetry(req?.retry);\n\n  const cfgMax = await getMaxOutputTokens();\n  const maxOutputTokens = normalizeMaxOutputTokens(req?.maxOutputTokens ?? cfgMax);\n  const reasoningEffort = provider === PROVIDERS.OPENAI ? await getOpenAIReasoningEffort() : \"\";\n\n  const cacheEnabled = normalizeBoolean(req?.cache, DEFAULTS.cache);\n  const ttlSec = clampInt(\n    req?.cacheTtlSec ?? (webSearch ? DEFAULTS.webCacheTtlSec : DEFAULTS.cacheTtlSec),\n    1,\n    365 * 24 * 3600,\n    webSearch ? DEFAULTS.webCacheTtlSec : DEFAULTS.cacheTtlSec\n  );\n\n  await syncCacheClearMarker();\n\n  // Cache key (no temperature anywhere)\n  const cacheKeyPayload = {\n    v: 3,\n    provider,\n    model,\n    maxOutputTokens,\n    reasoningEffort,\n    webSearch,\n    system,\n    user,\n    responseMimeType: req?.responseMimeType || \"\",\n    responseJsonSchema: req?.responseJsonSchema || null\n  };\n\n  const cacheKey = await hashKey(cacheKeyPayload);\n\n  if (cacheEnabled) {\n    const cached = CACHE.get(cacheKey);\n    if (cached) {\n      const formula = getFormulaForLog(fnName, cached?.text);\n      logRequest({\n        fn: fnName,\n        provider,\n        model,\n        ok: true,\n        ms: nowMs() - start,\n        cache: true,\n        cacheKind: \"memory\",\n        inputTokens: 0,\n        outputTokens: 0,\n        totalTokens: 0,\n        formula: formula || undefined\n      });\n      return { ...cached, cached: true, cacheKind: \"memory\" };\n    }\n    const persisted = await getPersistentCache(cacheKey);\n    if (persisted) {\n      const formula = getFormulaForLog(fnName, persisted?.text);\n      CACHE.set(cacheKey, persisted, ttlSec * 1000);\n      logRequest({\n        fn: fnName,\n        provider,\n        model,\n        ok: true,\n        ms: nowMs() - start,\n        cache: true,\n        cacheKind: \"persistent\",\n        inputTokens: 0,\n        outputTokens: 0,\n        totalTokens: 0,\n        formula: formula || undefined\n      });\n      return { ...persisted, cached: true, cacheKind: \"persistent\" };\n    }\n  }\n\n  if (INFLIGHT.has(cacheKey)) return INFLIGHT.get(cacheKey);\n\n  const p = withConcurrencyLimit(async () => {\n    let attempt = 0;\n    let lastErr = null;\n\n    const callProvider = async (opts) =>\n      provider === PROVIDERS.OPENAI ? callOpenAI(opts) : callGemini(opts);\n\n    while (attempt <= retry) {\n      attempt++;\n      try {\n        const baseOpts = {\n          apiKey,\n          model,\n          system,\n          user,\n          maxOutputTokens,\n          reasoningEffort,\n          timeoutMs,\n          webSearch,\n          responseMimeType: req?.responseMimeType,\n          responseJsonSchema: req?.responseJsonSchema\n        };\n\n        let result = await callProvider(baseOpts);\n\n        if (!result.ok) {\n          let opts = baseOpts;\n\n          // Fallback #1: if web search fails, retry without tools.\n          if (opts.webSearch) {\n            const shouldRetryNoWeb =\n              looksLikeWebSearchUnsupported(result.message) || result.code === \"API_ERROR\" || result.code === \"EMPTY_RESPONSE\";\n            if (shouldRetryNoWeb) {\n              opts = { ...opts, webSearch: false };\n              result = await callProvider(opts);\n            }\n          }\n\n          // Fallback #2: if structured output fails, retry without schema/responseMimeType.\n          const wantsStructured = opts.responseMimeType || opts.responseJsonSchema;\n          if (!result.ok && wantsStructured) {\n            const shouldRetryPlainJson =\n              looksLikeStructuredOutputUnsupported(result.message) ||\n              result.code === \"API_ERROR\" ||\n              result.code === \"EMPTY_RESPONSE\";\n            if (shouldRetryPlainJson) {\n              opts = {\n                ...opts,\n                responseMimeType: undefined,\n                responseJsonSchema: undefined,\n                system: ensureJsonInstruction(opts.system)\n              };\n              result = await callProvider(opts);\n            }\n          }\n        }\n\n        // Log (best-effort)\n        const usage = normalizeUsage(result?.usage);\n        const formula = result.ok ? getFormulaForLog(fnName, result.text) : \"\";\n        logRequest({\n          fn: fnName,\n          provider,\n          model,\n          ok: result.ok,\n          ms: nowMs() - start,\n          attempt,\n          cache: false,\n          inputTokens: usage.inputTokens,\n          outputTokens: usage.outputTokens,\n          cachedInputTokens: usage.cachedInputTokens,\n          totalTokens: usage.totalTokens,\n          code: result.code,\n          message: result.message,\n          formula: formula || undefined\n        });\n\n        if (result.ok && cacheEnabled) {\n          CACHE.set(cacheKey, result, ttlSec * 1000);\n          await setPersistentCache(cacheKey, result, ttlSec * 1000, { provider, model });\n        }\n\n        return result;\n      } catch (e) {\n        lastErr = e;\n        if (attempt <= retry) await sleep(250 * attempt);\n      }\n    }\n\n    const msg = lastErr?.message ? String(lastErr.message) : \"Erreur inconnue.\";\n    logRequest({\n      fn: fnName,\n      provider,\n      model,\n      ok: false,\n      ms: nowMs() - start,\n      cache: false,\n      code: \"API_ERROR\",\n      message: msg\n    });\n    return { ok: false, provider, model, code: \"API_ERROR\", message: msg };\n  });\n\n  INFLIGHT.set(cacheKey, p);\n\n  try {\n    return await p;\n  } finally {\n    INFLIGHT.delete(cacheKey);\n  }\n}\n\n/**\n * Lightweight connectivity test for a provider (used from taskpane and AI.TEST()).\n */\nexport async function aiMinimalTest(providerOverride) {\n  const provider = normalizeProvider(providerOverride) || (await getDefaultProvider());\n  const model = await getModel(provider);\n  const apiKey = await getApiKey(provider);\n\n  if (!apiKey) {\n    return {\n      ok: false,\n      provider,\n      model,\n      code: \"API_KEY_MISSING\",\n      message: `Cl API manquante pour le fournisseur ${provider}.`\n    };\n  }\n\n  // Tiny request\n  return await aiGenerate({\n    provider,\n    system: \"You are a test endpoint. Reply with exactly: OK\",\n    user: \"OK\",\n    maxOutputTokens: 500,\n    cache: false,\n    webSearch: false,\n    functionName: \"AI.MINIMAL_TEST\"\n  });\n}\n\n// ---- Provider: Gemini (Google Generative Language API) ----\n\nfunction geminiEndpoint(model, apiKey) {\n  return `https://generativelanguage.googleapis.com/v1beta/models/${encodeURIComponent(model)}:generateContent?key=${encodeURIComponent(apiKey)}`;\n}\n\nasync function callGemini({\n  apiKey,\n  model,\n  system,\n  user,\n  maxOutputTokens,\n  timeoutMs,\n  webSearch,\n  responseMimeType,\n  responseJsonSchema\n}) {\n  const url = geminiEndpoint(model, apiKey);\n\n  const body = {\n    contents: [{ role: \"user\", parts: [{ text: user }] }],\n    generationConfig: {\n      maxOutputTokens\n    }\n  };\n\n  if (isNonEmptyString(system)) {\n    // API uses lowerCamelCase for this field in JSON representation\n    // Force explicit JSON instruction for robustness\n    const sysText = (responseMimeType === \"application/json\" || responseJsonSchema)\n      ? system + \" You must return valid JSON.\"\n      : system;\n    body.systemInstruction = { role: \"system\", parts: [{ text: sysText }] };\n  }\n\n  // Structured output (JSON) when requested\n  if (responseMimeType) {\n    body.generationConfig.responseMimeType = responseMimeType;\n  }\n  if (responseJsonSchema) {\n    body.generationConfig.responseSchema = responseJsonSchema;\n  }\n\n  // Web grounding tool\n  if (webSearch) {\n    // For REST v1beta, the tool name is usually google_search (snake_case).\n    // Note: Some newer endpoints might respect googleSearch, but snake_case is safer for REST.\n    body.tools = [{ google_search: {} }];\n  }\n\n  const res = await fetchWithTimeout(url, {\n    method: \"POST\",\n    headers: { \"Content-Type\": \"application/json\" },\n    body: JSON.stringify(body)\n  }, timeoutMs);\n\n  const json = await safeJson(res);\n\n  if (!res.ok) {\n    const msg = extractGeminiError(json) || `Gemini API error (${res.status}).`;\n    return { ok: false, provider: PROVIDERS.GEMINI, model, code: \"API_ERROR\", message: msg };\n  }\n\n  const text = extractGeminiText(json);\n  const sources = extractGeminiSources(json);\n  const usage = extractGeminiUsage(json);\n\n  if (!isNonEmptyString(text)) {\n    return { ok: false, provider: PROVIDERS.GEMINI, model, code: \"EMPTY_RESPONSE\", message: \"Rponse vide de Gemini.\" };\n  }\n\n  return { ok: true, provider: PROVIDERS.GEMINI, model, text: text.trim(), sources, usage };\n}\n\nfunction extractGeminiText(json) {\n  try {\n    const c = json?.candidates?.[0];\n    const parts = c?.content?.parts;\n    if (Array.isArray(parts)) {\n      return parts.map((p) => p?.text || \"\").join(\"\");\n    }\n    return \"\";\n  } catch {\n    return \"\";\n  }\n}\n\nfunction extractGeminiError(json) {\n  try {\n    const msg = json?.error?.message;\n    return msg ? String(msg) : \"\";\n  } catch {\n    return \"\";\n  }\n}\n\nfunction extractGeminiSources(json) {\n  try {\n    const c = json?.candidates?.[0];\n    const md = c?.groundingMetadata;\n    const chunks = md?.groundingChunks;\n    if (!Array.isArray(chunks)) return [];\n\n    const out = [];\n    for (const ch of chunks) {\n      const web = ch?.web;\n      if (!web?.uri) continue;\n      out.push({ title: web?.title || \"\", url: web.uri });\n    }\n\n    return dedupeSources(out);\n  } catch {\n    return [];\n  }\n}\n\n// ---- Provider: OpenAI (Responses API) ----\n\nasync function callOpenAI({\n  apiKey,\n  model,\n  system,\n  user,\n  maxOutputTokens,\n  reasoningEffort,\n  timeoutMs,\n  webSearch,\n  responseMimeType,\n  responseJsonSchema\n}) {\n  const url = \"https://api.openai.com/v1/responses\";\n\n  const body = {\n    model,\n    input: user, // Responses API uses 'input' (string or array of objects)\n    max_output_tokens: maxOutputTokens,\n    store: false\n  };\n\n  if (isNonEmptyString(reasoningEffort)) {\n    body.reasoning = { effort: reasoningEffort };\n  }\n\n  // System prompt\n  if (isNonEmptyString(system)) {\n    const sysText = (responseMimeType === \"application/json\" || responseJsonSchema)\n      ? system + \" You must return valid JSON.\"\n      : system;\n    body.instructions = sysText;\n  }\n\n  // Structured output (JSON)\n  // - If a JSON schema is provided: use json_schema strict mode.\n  // - Else if responseMimeType is JSON: request a json_object.\n  if (responseJsonSchema) {\n    // For GPT-5 Mini / v1/responses, we try to use the most standard way if possible.\n    // If body.text format fails, we rely on the prompt.\n    // We kept the previous implementation but added prompt reinforcement.\n    body.text = {\n      format: {\n        type: \"json_schema\",\n        name: \"excel_ai_schema\",\n        strict: true,\n        schema: responseJsonSchema\n      }\n    };\n  } else if (responseMimeType === \"application/json\") {\n    body.text = { format: { type: \"json_object\" } };\n  }\n\n  // Web search tool\n  if (webSearch) {\n    body.tools = [{ type: \"web_search\" }];\n    body.include = [\"web_search_call.action.sources\"];\n  }\n\n  const res = await fetchWithTimeout(url, {\n    method: \"POST\",\n    headers: {\n      \"Content-Type\": \"application/json\",\n      Authorization: `Bearer ${apiKey}`\n    },\n    body: JSON.stringify(body)\n  }, timeoutMs);\n\n  const json = await safeJson(res);\n\n  if (!res.ok) {\n    const msg = extractOpenAIError(json) || `OpenAI API error (${res.status}).`;\n    return { ok: false, provider: PROVIDERS.OPENAI, model, code: \"API_ERROR\", message: msg };\n  }\n\n  const text = extractOpenAIText(json);\n  const sources = webSearch ? extractOpenAISources(json) : [];\n  const usage = extractOpenAIUsage(json);\n\n  if (!isNonEmptyString(text)) {\n    return {\n      ok: false,\n      provider: PROVIDERS.OPENAI,\n      model,\n      code: \"EMPTY_RESPONSE\",\n      message: \"Rponse vide d'OpenAI.\"\n    };\n  }\n\n  return { ok: true, provider: PROVIDERS.OPENAI, model, text: text.trim(), sources, usage };\n}\n\nfunction extractOpenAIText(json) {\n  // 1. Try direct output_text (common in simple Responses)\n  try {\n    if (typeof json?.output_text === \"string\" && json.output_text.trim()) {\n      return json.output_text;\n    }\n  } catch {\n    // ignore\n  }\n\n  // 2. Try iterating over 'output' items (complex/agentic responses)\n  try {\n    const out = json?.output;\n    if (Array.isArray(out)) {\n      const texts = [];\n      for (const item of out) {\n        if (typeof item?.text === \"string\" && item.text.trim()) texts.push(item.text);\n        if (typeof item?.output_text === \"string\" && item.output_text.trim()) texts.push(item.output_text);\n        if (item?.type === \"output_text\" && typeof item?.text === \"string\") texts.push(item.text);\n        if (item?.type === \"text\" && typeof item?.text === \"string\") texts.push(item.text);\n\n        // Standard message output\n        if (item?.type === \"message\") {\n          const content = item?.content;\n          if (Array.isArray(content)) {\n            for (const part of content) {\n              if (part?.type === \"text\" && part?.text) texts.push(part.text);\n              if (part?.type === \"output_text\" && part?.text) texts.push(part.text);\n            }\n          } else if (typeof content === \"string\") {\n            texts.push(content);\n          }\n        }\n\n        if (item?.type !== \"message\") {\n          const content = item?.content;\n          if (Array.isArray(content)) {\n            for (const part of content) {\n              if (part?.type === \"text\" && part?.text) texts.push(part.text);\n              if (part?.type === \"output_text\" && part?.text) texts.push(part.text);\n            }\n          } else if (typeof content === \"string\") {\n            texts.push(content);\n          }\n        }\n      }\n      if (texts.length > 0) return texts.join(\"\\n\").trim();\n    }\n  } catch {\n    // ignore\n  }\n\n  // 3. Fallback: Chat Completions style (just in case model acts differently)\n  try {\n    return json?.choices?.[0]?.message?.content || \"\";\n  } catch {\n    return \"\";\n  }\n}\n\nfunction extractOpenAIError(json) {\n  try {\n    const msg = json?.error?.message;\n    return msg ? String(msg) : \"\";\n  } catch {\n    return \"\";\n  }\n}\n\nfunction extractOpenAISources(json) {\n  try {\n    const out = json?.output;\n    if (!Array.isArray(out)) return [];\n\n    const sources = [];\n    for (const item of out) {\n      if (item?.type !== \"web_search_call\") continue;\n      const s = item?.action?.sources;\n      if (!Array.isArray(s)) continue;\n      for (const src of s) {\n        if (!src?.url) continue;\n        sources.push({ title: src?.title || \"\", url: src.url });\n      }\n    }\n\n    return dedupeSources(sources);\n  } catch {\n    return [];\n  }\n}\n\nfunction extractGeminiUsage(json) {\n  try {\n    const u = json?.usageMetadata;\n    if (!u) return null;\n    return {\n      inputTokens: toInt(u?.promptTokenCount),\n      outputTokens: toInt(u?.candidatesTokenCount),\n      totalTokens: toInt(u?.totalTokenCount)\n    };\n  } catch {\n    return null;\n  }\n}\n\nfunction extractOpenAIUsage(json) {\n  try {\n    const u = json?.usage;\n    if (!u) return null;\n    return {\n      inputTokens: toInt(u?.input_tokens),\n      outputTokens: toInt(u?.output_tokens),\n      totalTokens: toInt(u?.total_tokens),\n      cachedInputTokens: toInt(u?.input_tokens_details?.cached_tokens)\n    };\n  } catch {\n    return null;\n  }\n}\n\nfunction normalizeUsage(usage) {\n  if (!usage || typeof usage !== \"object\") {\n    return { inputTokens: 0, outputTokens: 0, totalTokens: 0, cachedInputTokens: 0 };\n  }\n  return {\n    inputTokens: toInt(usage.inputTokens),\n    outputTokens: toInt(usage.outputTokens),\n    totalTokens: toInt(usage.totalTokens),\n    cachedInputTokens: toInt(usage.cachedInputTokens)\n  };\n}\n\nfunction toInt(value) {\n  const n = Number(value);\n  if (!Number.isFinite(n) || n <= 0) return 0;\n  return Math.floor(n);\n}\n\nexport async function clearAllCaches() {\n  CACHE.clear();\n  await clearPersistentCache();\n}\n\nfunction dedupeSources(list) {\n  const seen = new Set();\n  const out = [];\n  for (const s of list || []) {\n    const url = String(s?.url || \"\").trim();\n    if (!url) continue;\n    const key = url.toLowerCase();\n    if (seen.has(key)) continue;\n    seen.add(key);\n    out.push({ title: String(s?.title || \"\").trim(), url });\n  }\n  return out;\n}\n\n// ---- Helpers: fetch + timeout + JSON parsing ----\n\nasync function fetchWithTimeout(url, options, timeoutMs) {\n  const t = normalizeTimeoutMs(timeoutMs);\n\n  if (typeof AbortController === \"undefined\") {\n    // Basic fetch without cancellation (should be rare in modern Office runtimes)\n    return await fetch(url, options);\n  }\n\n  const ctrl = new AbortController();\n  const id = setTimeout(() => ctrl.abort(), t);\n\n  try {\n    return await fetch(url, { ...options, signal: ctrl.signal });\n  } finally {\n    clearTimeout(id);\n  }\n}\n\nasync function safeJson(res) {\n  try {\n    return await res.json();\n  } catch {\n    return {};\n  }\n}\n","// src/taskpane/taskpane.js\n// Taskpane logic: provider selection + keys/models + shared max tokens.\n//\n// Requirements implemented:\n// - Default provider selection only in panel (not in formulas)\n// - Two tabs: Gemini and OpenAI\n// - Single max output tokens setting shared by both providers\n// - No temperature/top-p controls\n\nimport {\n  PROVIDERS,\n  DEFAULTS,\n  storageBackendName,\n  getDefaultProvider,\n  setDefaultProvider,\n  getMaxOutputTokens,\n  setMaxOutputTokens,\n  getApiKey,\n  setApiKey,\n  clearApiKey,\n  getModel,\n  setModel,\n  getOpenAIReasoningEffort,\n  setOpenAIReasoningEffort,\n  getRequestLog,\n  clearRequestLog,\n  getPersistentCacheStats\n} from \"../shared/core\";\n\nimport { aiMinimalTest, clearAllCaches } from \"../shared/providers\";\n\nfunction el(id) {\n  return document.getElementById(id);\n}\n\nfunction setStatus(line, detailsObj) {\n  el(\"statusLine\").textContent = line || \"\";\n  if (detailsObj) {\n    try {\n      el(\"statusDetails\").textContent = JSON.stringify(detailsObj, null, 2);\n    } catch {\n      el(\"statusDetails\").textContent = String(detailsObj);\n    }\n  } else {\n    el(\"statusDetails\").textContent = \"\";\n  }\n}\n\nfunction formatNumber(value) {\n  const n = Number(value);\n  if (!Number.isFinite(n)) return \"0\";\n  return Math.round(n).toLocaleString(\"en-US\");\n}\n\nconst CURRENCY_SYMBOL = \"\";\nconst COST_ICON = \"$\";\nconst REASON_ICON = \"\\uD83E\\uDDE0\";\n\nconst FAVORITE_ICON = \"\\u2605\";\n\nfunction formatCost(value) {\n  const n = Number(value);\n  if (!Number.isFinite(n)) return `${CURRENCY_SYMBOL}0.0000`;\n  return `${CURRENCY_SYMBOL}${n.toFixed(4)}`;\n}\n\nfunction formatDuration(ms) {\n  const n = Number(ms);\n  if (!Number.isFinite(n)) return \"0.00s\";\n  return `${(n / 1000).toFixed(2)}s`;\n}\n\nfunction formatTime(ts) {\n  try {\n    const d = new Date(ts);\n    return d.toLocaleTimeString(\"fr-FR\", { hour: \"2-digit\", minute: \"2-digit\" });\n  } catch {\n    return \"--:--\";\n  }\n}\n\nfunction formatBytes(bytes) {\n  const n = Number(bytes);\n  if (!Number.isFinite(n) || n <= 0) return \"0 KB\";\n  if (n < 1024) return `${n} B`;\n  if (n < 1024 * 1024) return `${(n / 1024).toFixed(1)} KB`;\n  return `${(n / (1024 * 1024)).toFixed(2)} MB`;\n}\n\nconst TOKEN_EXP_MIN = 7;\nconst TOKEN_EXP_MAX = 17;\nconst UNKNOWN_MODEL_LABEL = \"modele inconnu\";\nconst OPENAI_REASONING_LEVELS = [\"none\", \"minimal\", \"low\", \"medium\", \"high\"];\n\nconst DEFAULT_MODELS = {\n  gemini: DEFAULTS.geminiModel,\n  openai: DEFAULTS.openaiModel\n};\n\nconst MODEL_CATALOG = {\n  gemini: [\n    {\n      id: \"gemini-3-pro-preview\",\n      label: \"Gemini 3 Pro Preview\",\n      prices: { input: 2, output: 12, cachedInput: 0.2 },\n      costLevel: 3,\n      reasoningLevel: 3\n    },\n    {\n      id: \"gemini-3-flash-preview\",\n      label: \"Gemini 3 Flash Preview\",\n      prices: { input: 0.5, output: 3, cachedInput: 0.05 },\n      costLevel: 2,\n      reasoningLevel: 2,\n      recommended: true\n    },\n    {\n      id: \"gemini-2.5-flash-lite\",\n      label: \"Gemini 2.5 Flash Lite\",\n      prices: { input: 0.1, output: 0.4, cachedInput: 0.01 },\n      costLevel: 1,\n      reasoningLevel: 1\n    }\n  ],\n  openai: [\n    {\n      id: \"gpt-5.2\",\n      label: \"GPT-5.2\",\n      prices: { input: 1.75, output: 14, cachedInput: 0.175 },\n      costLevel: 3,\n      reasoningLevel: 3,\n      supportsReasoningNone: true\n    },\n    {\n      id: \"gpt-5-mini\",\n      label: \"GPT-5 Mini\",\n      prices: { input: 0.25, output: 2, cachedInput: 0.025 },\n      costLevel: 2,\n      reasoningLevel: 2,\n      recommended: true,\n      supportsReasoningNone: false\n    },\n    {\n      id: \"gpt-5-nano\",\n      label: \"GPT-5 Nano\",\n      prices: { input: 0.05, output: 0.4, cachedInput: 0.005 },\n      costLevel: 1,\n      reasoningLevel: 1,\n      supportsReasoningNone: false\n    }\n  ]\n};\n\nconst MODEL_LOOKUP = {\n  gemini: new Map(MODEL_CATALOG.gemini.map((m) => [m.id.toLowerCase(), m])),\n  openai: new Map(MODEL_CATALOG.openai.map((m) => [m.id.toLowerCase(), m]))\n};\n\nconst PROVIDER_LABELS = {\n  gemini: \"Gemini\",\n  openai: \"OpenAI\"\n};\n\nfunction repeatIcon(icon, level) {\n  const count = Math.max(1, Number(level) || 1);\n  return new Array(count + 1).join(icon);\n}\n\nfunction getModelMeta(provider, model) {\n  const p = String(provider || \"\").toLowerCase();\n  const key = String(model || \"\").trim().toLowerCase();\n  const map = MODEL_LOOKUP[p];\n  if (map && key && map.has(key)) return map.get(key);\n  const fallback = DEFAULT_MODELS[p];\n  if (map && fallback && map.has(fallback.toLowerCase())) return map.get(fallback.toLowerCase());\n  return null;\n}\n\nfunction openaiModelAllowsNone(model) {\n  const key = String(model || \"\").trim().toLowerCase();\n  const meta = MODEL_LOOKUP.openai?.get(key);\n  if (meta && typeof meta.supportsReasoningNone === \"boolean\") return meta.supportsReasoningNone;\n  return true;\n}\n\nfunction getReasoningEffortLabel(value) {\n  const raw = String(value || \"\").trim().toLowerCase();\n  if (!raw) return \"\";\n  const idx = Number(raw);\n  if (Number.isFinite(idx)) {\n    const clamped = Math.min(OPENAI_REASONING_LEVELS.length - 1, Math.max(0, Math.round(idx)));\n    return OPENAI_REASONING_LEVELS[clamped] || \"\";\n  }\n  return raw;\n}\n\nfunction syncOpenAIReasoningEffort(modelId, preferred) {\n  const effortEl = el(\"openaiReasoningEffort\");\n  if (!effortEl) return \"\";\n  const allowNone = openaiModelAllowsNone(modelId);\n  const wrap = effortEl.closest(\".reasoning\");\n  if (wrap) wrap.classList.toggle(\"reasoning--no-none\", !allowNone);\n  effortEl.dataset.allowNone = allowNone ? \"1\" : \"0\";\n\n  const allowed = allowNone ? OPENAI_REASONING_LEVELS : OPENAI_REASONING_LEVELS.slice(1);\n  let next = getReasoningEffortLabel(preferred);\n  if (!allowed.includes(next)) {\n    next = allowed[0] || \"minimal\";\n  }\n  const index = OPENAI_REASONING_LEVELS.indexOf(next);\n  effortEl.value = String(index >= 0 ? index : 0);\n  effortEl.setAttribute(\"aria-valuetext\", next);\n  return next;\n}\n\nfunction formatRate(value) {\n  const n = Number(value);\n  if (!Number.isFinite(n)) return `${CURRENCY_SYMBOL}0`;\n  const decimals = n >= 1 ? 2 : 3;\n  let text = n.toFixed(decimals);\n  text = text.replace(/\\.?0+$/, \"\");\n  return `${CURRENCY_SYMBOL}${text}`;\n}\n\nfunction modelIndicators(meta) {\n  return {\n    cost: repeatIcon(COST_ICON, meta.costLevel),\n    reasoning: repeatIcon(REASON_ICON, meta.reasoningLevel)\n  };\n}\n\nfunction modelOptionLabel(meta) {\n  const indicators = modelIndicators(meta);\n  const favorite = meta.recommended ? `${FAVORITE_ICON} ` : \"\";\n  return `${favorite}${meta.id} | ${indicators.cost} | ${indicators.reasoning}`;\n}\n\nfunction estimateCost(entry) {\n  if (!entry) return 0;\n  const provider = String(entry.provider || \"\").toLowerCase();\n  const meta = getModelMeta(provider, entry.model);\n  if (!meta) return 0;\n\n  const inputTokens = Math.max(0, Number(entry.inputTokens || 0));\n  const outputTokens = Math.max(0, Number(entry.outputTokens || 0));\n  const cachedInputTokens = Math.max(0, Number(entry.cachedInputTokens || 0));\n\n  const cached = Math.min(cachedInputTokens, inputTokens);\n  const uncached = Math.max(0, inputTokens - cached);\n\n  const prices = meta.prices || {};\n  const inputRate = Number(prices.input || 0);\n  const cachedRate = Number(prices.cachedInput ?? prices.input ?? 0);\n  const outputRate = Number(prices.output || 0);\n\n  return (uncached / 1e6) * inputRate + (cached / 1e6) * cachedRate + (outputTokens / 1e6) * outputRate;\n}\n\nfunction normalizeUsageEntry(entry) {\n  return {\n    provider: entry?.provider || \"\",\n    inputTokens: Number(entry?.inputTokens || 0),\n    outputTokens: Number(entry?.outputTokens || 0),\n    cachedInputTokens: Number(entry?.cachedInputTokens || 0),\n    totalTokens: Number(entry?.totalTokens || 0),\n    ok: !!entry?.ok,\n    cache: !!entry?.cache,\n    ms: Number(entry?.ms || 0),\n    fn: entry?.fn || \"AI\",\n    model: entry?.model || \"\",\n    ts: Number(entry?.ts || 0),\n    message: entry?.message || \"\",\n    formula: entry?.formula || \"\"\n  };\n}\n\nfunction populateModelSelect(provider, selectEl, currentModel) {\n  if (!selectEl) return;\n  const list = MODEL_CATALOG[provider] || [];\n  const requested = String(currentModel || \"\").trim();\n  const requestedKey = requested.toLowerCase();\n  const fallback = DEFAULT_MODELS[provider] || \"\";\n\n  selectEl.innerHTML = \"\";\n  let matched = false;\n\n  for (const meta of list) {\n    const option = document.createElement(\"option\");\n    option.value = meta.id;\n    option.textContent = modelOptionLabel(meta);\n    if (meta.id.toLowerCase() === requestedKey) {\n      option.selected = true;\n      matched = true;\n    }\n    selectEl.appendChild(option);\n  }\n\n  if (requested && !matched) {\n    const option = document.createElement(\"option\");\n    option.value = requested;\n    option.textContent = `${requested} | hors liste`;\n    option.selected = true;\n    selectEl.appendChild(option);\n    return;\n  }\n\n  if (!requested && fallback) {\n    selectEl.value = fallback;\n  }\n}\n\nfunction renderPricingTable() {\n  const gemBody = el(\"pricingTableBodyGemini\");\n  const oaiBody = el(\"pricingTableBodyOpenAI\");\n  if (!gemBody && !oaiBody) return;\n  if (gemBody) gemBody.innerHTML = \"\";\n  if (oaiBody) oaiBody.innerHTML = \"\";\n\n  const renderProvider = (provider, body) => {\n    if (!body) return;\n    const list = MODEL_CATALOG[provider] || [];\n    for (const meta of list) {\n      const row = document.createElement(\"tr\");\n      const indicators = modelIndicators(meta);\n\n      const cellModel = document.createElement(\"td\");\n      cellModel.textContent = meta.id;\n\n      const cellInput = document.createElement(\"td\");\n      cellInput.className = \"pricing-table__col-price\";\n      cellInput.textContent = formatRate(meta.prices?.input);\n\n      const cellOutput = document.createElement(\"td\");\n      cellOutput.className = \"pricing-table__col-price\";\n      cellOutput.textContent = formatRate(meta.prices?.output);\n\n      const cellCost = document.createElement(\"td\");\n      cellCost.className = \"pricing-table__col-icon\";\n      cellCost.textContent = indicators.cost;\n\n      const cellReason = document.createElement(\"td\");\n      cellReason.className = \"pricing-table__col-icon\";\n      cellReason.textContent = indicators.reasoning;\n\n      row.appendChild(cellModel);\n      row.appendChild(cellInput);\n      row.appendChild(cellOutput);\n      row.appendChild(cellCost);\n      row.appendChild(cellReason);\n      body.appendChild(row);\n    }\n  };\n\n  renderProvider(PROVIDERS.GEMINI, gemBody);\n  renderProvider(PROVIDERS.OPENAI, oaiBody);\n}\n\nfunction setPricingModalOpen(isOpen) {\n  const modal = el(\"pricingModal\");\n  if (!modal) return;\n  modal.classList.toggle(\"is-open\", isOpen);\n  modal.setAttribute(\"aria-hidden\", isOpen ? \"false\" : \"true\");\n}\n\nfunction openPricingModal() {\n  renderPricingTable();\n  setPricingModalOpen(true);\n}\n\nfunction closePricingModal() {\n  setPricingModalOpen(false);\n}\n\nfunction setKeyStatus(id, hasKey) {\n  const node = el(id);\n  if (!node) return;\n  const ok = !!hasKey;\n  node.textContent = ok ? \"Cl enregistre\" : \"Cl manquante\";\n  node.classList.toggle(\"key-status--ok\", ok);\n  node.classList.toggle(\"key-status--missing\", !ok);\n}\n\nfunction clampExp(value) {\n  const n = Number(value);\n  if (!Number.isFinite(n)) return TOKEN_EXP_MIN;\n  return Math.min(TOKEN_EXP_MAX, Math.max(TOKEN_EXP_MIN, Math.round(n)));\n}\n\nfunction expToTokens(exp) {\n  return 2 ** clampExp(exp);\n}\n\nfunction tokensToExp(tokens) {\n  const n = Number(tokens);\n  if (!Number.isFinite(n) || n <= 0) return TOKEN_EXP_MIN;\n  return clampExp(Math.log2(n));\n}\n\nfunction setProviderButtons(provider) {\n  const isGemini = provider === PROVIDERS.GEMINI;\n  el(\"providerGemini\").classList.toggle(\"segmented__btn--active\", isGemini);\n  el(\"providerOpenAI\").classList.toggle(\"segmented__btn--active\", !isGemini);\n  el(\"providerGemini\").setAttribute(\"aria-pressed\", isGemini ? \"true\" : \"false\");\n  el(\"providerOpenAI\").setAttribute(\"aria-pressed\", !isGemini ? \"true\" : \"false\");\n}\n\nfunction getSelectedProvider() {\n  const geminiActive = el(\"providerGemini\").classList.contains(\"segmented__btn--active\");\n  return geminiActive ? PROVIDERS.GEMINI : PROVIDERS.OPENAI;\n}\n\nfunction updateMaxTokensValue() {\n  const exp = clampExp(el(\"maxTokensRange\").value);\n  const tokens = expToTokens(exp);\n  el(\"maxTokensValue\").textContent = formatNumber(tokens);\n  return tokens;\n}\n\nfunction activateTab(tab) {\n  const isGemini = tab === \"gemini\";\n  el(\"tabGemini\").classList.toggle(\"tab--active\", isGemini);\n  el(\"tabOpenAI\").classList.toggle(\"tab--active\", !isGemini);\n\n  el(\"tabGemini\").setAttribute(\"aria-selected\", isGemini ? \"true\" : \"false\");\n  el(\"tabOpenAI\").setAttribute(\"aria-selected\", !isGemini ? \"true\" : \"false\");\n\n  el(\"panelGemini\").classList.toggle(\"tab-panel--active\", isGemini);\n  el(\"panelOpenAI\").classList.toggle(\"tab-panel--active\", !isGemini);\n}\n\nasync function refreshUI() {\n  el(\"storageBackend\").textContent = storageBackendName();\n\n  const [provider, maxTok, gemModel, oaiModel, gemKey, oaiKey, oaiReasoningEffort] = await Promise.all([\n    getDefaultProvider(),\n    getMaxOutputTokens(),\n    getModel(PROVIDERS.GEMINI),\n    getModel(PROVIDERS.OPENAI),\n    getApiKey(PROVIDERS.GEMINI),\n    getApiKey(PROVIDERS.OPENAI),\n    getOpenAIReasoningEffort()\n  ]);\n\n  setProviderButtons(provider);\n\n  const exp = tokensToExp(maxTok);\n  const normalizedTokens = expToTokens(exp);\n  el(\"maxTokensRange\").value = String(exp);\n  el(\"maxTokensValue\").textContent = formatNumber(normalizedTokens);\n  if (normalizedTokens !== maxTok) {\n    await setMaxOutputTokens(normalizedTokens);\n  }\n\n  // Models\n  const geminiModelEl = el(\"geminiModel\");\n  const openaiModelEl = el(\"openaiModel\");\n  populateModelSelect(PROVIDERS.GEMINI, geminiModelEl, gemModel);\n  populateModelSelect(PROVIDERS.OPENAI, openaiModelEl, oaiModel);\n  const selectedOpenAIModel = openaiModelEl ? openaiModelEl.value : oaiModel;\n  const safeEffort = syncOpenAIReasoningEffort(selectedOpenAIModel, oaiReasoningEffort);\n  const effectiveEffort = safeEffort || oaiReasoningEffort;\n  if (safeEffort && safeEffort !== oaiReasoningEffort) {\n    await setOpenAIReasoningEffort(safeEffort);\n  }\n\n  // Keys are not displayed back (security / UX). Use placeholder to indicate presence.\n\n  el(\"geminiKey\").value = \"\";\n  el(\"openaiKey\").value = \"\";\n\n  el(\"geminiKey\").placeholder = gemKey ? \"Cl enregistre (laisser vide pour conserver)\" : \"AIza...\";\n  el(\"openaiKey\").placeholder = oaiKey ? \"Cl enregistre (laisser vide pour conserver)\" : \"sk-...\";\n\n  setKeyStatus(\"geminiKeyStatus\", gemKey);\n  setKeyStatus(\"openaiKeyStatus\", oaiKey);\n\n  setStatus(\"Configuration charge.\", {\n    defaultProvider: provider,\n    maxOutputTokens: normalizedTokens,\n    gemini: { key: gemKey ? \"set\" : \"missing\", model: gemModel },\n    openai: { key: oaiKey ? \"set\" : \"missing\", model: oaiModel, reasoningEffort: effectiveEffort }\n  });\n}\n\nfunction buildBreakdownRow(label, tokens, cost, isSub) {\n  const row = document.createElement(\"div\");\n  row.className = `breakdown__row ${isSub ? \"breakdown__row--sub\" : \"breakdown__row--total\"}`;\n\n  const name = document.createElement(\"div\");\n  name.className = \"breakdown__name\";\n  if (isSub) {\n    const model = document.createElement(\"span\");\n    model.className = \"breakdown__model\";\n    model.textContent = label;\n    name.appendChild(model);\n  } else {\n    name.textContent = label;\n  }\n\n  const tokensEl = document.createElement(\"div\");\n  tokensEl.className = \"breakdown__tokens\";\n  tokensEl.textContent = `${formatNumber(tokens)} tokens`;\n\n  const costEl = document.createElement(\"div\");\n  costEl.className = \"breakdown__cost\";\n  costEl.textContent = formatCost(cost);\n\n  row.appendChild(name);\n  row.appendChild(tokensEl);\n  row.appendChild(costEl);\n  return row;\n}\n\nfunction renderUsageBreakdown(breakdown) {\n  const container = el(\"usageBreakdown\");\n  if (!container) return;\n  container.innerHTML = \"\";\n\n  const providers = [PROVIDERS.GEMINI, PROVIDERS.OPENAI];\n  for (const provider of providers) {\n    const data = breakdown[provider] || { tokens: 0, cost: 0, models: new Map() };\n    container.appendChild(buildBreakdownRow(PROVIDER_LABELS[provider] || provider, data.tokens, data.cost, false));\n\n    const models = Array.from(data.models.values())\n      .filter((model) => (model.tokens || 0) > 0 || (model.cost || 0) > 0)\n      .sort((a, b) => b.tokens - a.tokens || a.label.localeCompare(b.label));\n\n    for (const model of models) {\n      container.appendChild(buildBreakdownRow(model.label, model.tokens, model.cost, true));\n    }\n  }\n}\n\nasync function refreshUsage() {\n  const rawLogs = await getRequestLog({ fresh: true });\n  const logs = rawLogs.map(normalizeUsageEntry).sort((a, b) => b.ts - a.ts);\n\n  const breakdown = {\n    gemini: { tokens: 0, cost: 0, models: new Map() },\n    openai: { tokens: 0, cost: 0, models: new Map() }\n  };\n\n  const total = {\n    inputTokens: 0,\n    outputTokens: 0,\n    cachedInputTokens: 0,\n    cost: 0,\n    requests: logs.length,\n    byProvider: {\n      gemini: { tokens: 0, cost: 0 },\n      openai: { tokens: 0, cost: 0 }\n    }\n  };\n\n  for (const entry of logs) {\n    const input = Math.max(0, entry.inputTokens);\n    const output = Math.max(0, entry.outputTokens);\n    const tokens = input + output;\n    const cost = estimateCost(entry);\n\n    total.inputTokens += input;\n    total.outputTokens += output;\n    total.cachedInputTokens += Math.max(0, entry.cachedInputTokens || 0);\n    total.cost += cost;\n\n    const provider = String(entry.provider || \"\").toLowerCase();\n    const bucket = breakdown[provider];\n    if (!bucket) continue;\n\n    bucket.tokens += tokens;\n    bucket.cost += cost;\n\n    if (tokens > 0 || cost > 0) {\n      const rawModel = String(entry.model || \"\").trim();\n      const label = rawModel || UNKNOWN_MODEL_LABEL;\n      const key = label.toLowerCase();\n      const modelEntry = bucket.models.get(key) || { label, tokens: 0, cost: 0 };\n      modelEntry.tokens += tokens;\n      modelEntry.cost += cost;\n      bucket.models.set(key, modelEntry);\n    }\n  }\n\n  total.byProvider.gemini.tokens = breakdown.gemini.tokens;\n  total.byProvider.gemini.cost = breakdown.gemini.cost;\n  total.byProvider.openai.tokens = breakdown.openai.tokens;\n  total.byProvider.openai.cost = breakdown.openai.cost;\n\n  el(\"usageTokensTotal\").textContent = formatNumber(total.inputTokens + total.outputTokens);\n  el(\"usageTokensInTotal\").textContent = formatNumber(total.inputTokens);\n  el(\"usageTokensOutTotal\").textContent = formatNumber(total.outputTokens);\n  el(\"usageCostTotal\").textContent = formatCost(total.cost);\n  el(\"usageCostGemini\").textContent = formatCost(total.byProvider.gemini.cost);\n  el(\"usageCostOpenAI\").textContent = formatCost(total.byProvider.openai.cost);\n\n  renderUsageBreakdown(breakdown);\n  renderLogList(logs);\n  drawUsageChart(logs);\n}\n\nfunction getTokenHeatClass(tokensTotal) {\n  const n = Number(tokensTotal || 0);\n  if (n >= 8000) return \"token-heat--extreme\";\n  if (n >= 4000) return \"token-heat--hot\";\n  if (n >= 1500) return \"token-heat--warm\";\n  return \"token-heat--cool\";\n}\n\nfunction renderLogList(logs) {\n  const list = el(\"logList\");\n  list.innerHTML = \"\";\n\n  if (!logs.length) {\n    const empty = document.createElement(\"div\");\n    empty.className = \"log-item\";\n    empty.textContent = \"Aucune activit enregistre pour le moment.\";\n    list.appendChild(empty);\n    return;\n  }\n\n  const buildTokenFlow = (iconText, value) => {\n    const wrap = document.createElement(\"span\");\n    wrap.className = \"token-flow\";\n\n    const icon = document.createElement(\"span\");\n    icon.className = \"token-flow__icon\";\n    icon.textContent = iconText;\n\n    const val = document.createElement(\"span\");\n    val.className = \"token-flow__value\";\n    val.textContent = formatNumber(value);\n\n    wrap.appendChild(icon);\n    wrap.appendChild(val);\n    return wrap;\n  };\n\n  const slice = logs.slice(0, 40);\n  for (const entry of slice) {\n    const item = document.createElement(\"div\");\n    const cacheClass = entry.cache ? \" log-item--cache\" : \"\";\n    item.className = `log-item ${entry.ok ? \"log-item--ok\" : \"log-item--error\"}${cacheClass}`;\n\n    const top = document.createElement(\"div\");\n    top.className = \"log-item__top\";\n\n    const title = document.createElement(\"div\");\n    title.className = \"log-item__title\";\n\n    const titleText = document.createElement(\"span\");\n    titleText.className = \"log-item__title-text\";\n    titleText.textContent = entry.fn;\n    title.appendChild(titleText);\n\n    const formulaText = String(entry.formula || \"\").trim();\n    let detail = null;\n    if (formulaText) {\n      const toggle = document.createElement(\"button\");\n      toggle.className = \"log-item__toggle\";\n      toggle.type = \"button\";\n      toggle.setAttribute(\"aria-expanded\", \"false\");\n      toggle.setAttribute(\"aria-label\", \"Afficher la formule\");\n\n      const chevron = document.createElement(\"span\");\n      chevron.className = \"log-item__chevron\";\n      toggle.appendChild(chevron);\n\n      toggle.addEventListener(\"click\", () => {\n        const isOpen = item.classList.toggle(\"log-item--expanded\");\n        toggle.setAttribute(\"aria-expanded\", isOpen ? \"true\" : \"false\");\n        toggle.setAttribute(\"aria-label\", isOpen ? \"Masquer la formule\" : \"Afficher la formule\");\n      });\n\n      title.appendChild(toggle);\n\n      detail = document.createElement(\"div\");\n      detail.className = \"log-item__detail\";\n      detail.textContent = formulaText;\n    }\n\n    const tags = document.createElement(\"div\");\n    tags.style.display = \"flex\";\n    tags.style.gap = \"6px\";\n\n    const providerTag = document.createElement(\"span\");\n    providerTag.className = \"tag\";\n    providerTag.textContent = entry.provider ? entry.provider.toUpperCase() : \"\";\n    tags.appendChild(providerTag);\n\n    const statusTag = document.createElement(\"span\");\n    statusTag.className = `tag ${entry.ok ? \"\" : \"tag--error\"}`;\n    statusTag.textContent = entry.ok ? \"OK\" : \"Erreur\";\n    tags.appendChild(statusTag);\n\n    if (entry.cache) {\n      const cacheTag = document.createElement(\"span\");\n      cacheTag.className = \"tag tag--cache\";\n      cacheTag.textContent = \"Cache\";\n      tags.appendChild(cacheTag);\n    }\n\n    top.appendChild(title);\n    top.appendChild(tags);\n\n    const meta = document.createElement(\"div\");\n    meta.className = \"log-item__meta\";\n\n    const tokensTotal = Math.max(0, entry.inputTokens + entry.outputTokens);\n    const modelLabel = entry.model ? entry.model : \"\";\n    const durationLabel = formatDuration(entry.ms);\n\n    const right = document.createElement(\"div\");\n    right.className = \"log-item__info\";\n    if (!entry.ok && entry.message) {\n      right.textContent = `${durationLabel}  ${entry.message.slice(0, 60)}`;\n    } else {\n      right.textContent = `${formatTime(entry.ts)}  ${durationLabel}${modelLabel ? `  ${modelLabel}` : \"\"}`;\n    }\n\n    if (entry.cache) {\n      const cacheNote = document.createElement(\"div\");\n      cacheNote.className = \"log-item__cache\";\n      cacheNote.textContent = \"Cache local\";\n      meta.appendChild(cacheNote);\n    } else {\n      const tokensWrap = document.createElement(\"div\");\n      tokensWrap.className = \"log-item__tokens\";\n\n      const tokensLine = document.createElement(\"div\");\n      tokensLine.className = \"log-item__tokens-line\";\n\n      const heatDot = document.createElement(\"span\");\n      heatDot.className = `log-item__heat ${getTokenHeatClass(tokensTotal)}`;\n\n      const tokensTotalEl = document.createElement(\"span\");\n      tokensTotalEl.className = \"log-item__tokens-total\";\n      tokensTotalEl.textContent = `${formatNumber(tokensTotal)} tokens`;\n\n      const tokensDetailEl = document.createElement(\"span\");\n      tokensDetailEl.className = \"log-item__tokens-detail\";\n      tokensDetailEl.appendChild(document.createTextNode(\"(\"));\n      tokensDetailEl.appendChild(buildTokenFlow(\"o<-\", entry.inputTokens));\n      tokensDetailEl.appendChild(document.createTextNode(\" / \"));\n      tokensDetailEl.appendChild(buildTokenFlow(\"o->\", entry.outputTokens));\n      tokensDetailEl.appendChild(document.createTextNode(\")\"));\n\n      tokensLine.appendChild(heatDot);\n      tokensLine.appendChild(tokensTotalEl);\n      tokensLine.appendChild(tokensDetailEl);\n      tokensWrap.appendChild(tokensLine);\n      meta.appendChild(tokensWrap);\n    }\n\n    meta.appendChild(right);\n\n    item.appendChild(top);\n    if (detail) item.appendChild(detail);\n    item.appendChild(meta);\n    list.appendChild(item);\n  }\n}\n\nfunction drawUsageChart(logs) {\n  const canvas = el(\"usageChart\");\n  if (!canvas) return;\n  const ctx = canvas.getContext(\"2d\");\n  if (!ctx) return;\n\n  const width = canvas.clientWidth || 320;\n  const height = canvas.clientHeight || 140;\n  const dpr = window.devicePixelRatio || 1;\n  canvas.width = width * dpr;\n  canvas.height = height * dpr;\n  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);\n\n  const now = Date.now();\n  const start = now - 60 * 60 * 1000;\n  const buckets = new Array(60).fill(0);\n\n  for (const entry of logs) {\n    if (!entry.ts || entry.ts < start) continue;\n    const index = Math.floor((entry.ts - start) / 60000);\n    if (index >= 0 && index < buckets.length) {\n      buckets[index] += Math.max(0, entry.inputTokens + entry.outputTokens);\n    }\n  }\n\n  const maxValue = Math.max(...buckets, 1);\n  const styles = getComputedStyle(document.documentElement);\n  const lineColor = styles.getPropertyValue(\"--accent-2\").trim() || \"#2a9d8f\";\n  const gridColor = \"rgba(38, 70, 83, 0.12)\";\n\n  ctx.clearRect(0, 0, width, height);\n\n  ctx.strokeStyle = gridColor;\n  ctx.lineWidth = 1;\n  for (let i = 1; i <= 3; i++) {\n    const y = (height / 4) * i;\n    ctx.beginPath();\n    ctx.moveTo(0, y);\n    ctx.lineTo(width, y);\n    ctx.stroke();\n  }\n\n  ctx.beginPath();\n  buckets.forEach((value, i) => {\n    const x = (i / (buckets.length - 1)) * width;\n    const y = height - (value / maxValue) * (height - 12) - 6;\n    if (i === 0) ctx.moveTo(x, y);\n    else ctx.lineTo(x, y);\n  });\n\n  const gradient = ctx.createLinearGradient(0, 0, 0, height);\n  gradient.addColorStop(0, \"rgba(42, 157, 143, 0.35)\");\n  gradient.addColorStop(1, \"rgba(42, 157, 143, 0.02)\");\n\n  ctx.lineWidth = 2;\n  ctx.strokeStyle = lineColor;\n  ctx.stroke();\n\n  ctx.lineTo(width, height);\n  ctx.lineTo(0, height);\n  ctx.closePath();\n  ctx.fillStyle = gradient;\n  ctx.fill();\n}\n\nasync function refreshCacheStats() {\n  const stats = await getPersistentCacheStats();\n  el(\"cacheEntries\").textContent = formatNumber(stats.entries);\n  el(\"cacheSize\").textContent = formatBytes(stats.sizeBytes);\n  el(\"cacheGeminiEntries\").textContent = formatNumber(stats.providers.gemini.entries);\n  el(\"cacheOpenAIEntries\").textContent = formatNumber(stats.providers.openai.entries);\n}\n\nasync function saveCommon() {\n  const provider = getSelectedProvider();\n  const exp = clampExp(el(\"maxTokensRange\").value);\n  const maxTok = expToTokens(exp);\n\n  const savedProvider = await setDefaultProvider(provider);\n  const savedTokens = await setMaxOutputTokens(maxTok);\n\n  setStatus(\"Paramtres enregistrs.\", { defaultProvider: savedProvider, maxOutputTokens: savedTokens });\n}\n\nfunction initCollapsibles() {\n  const toggles = document.querySelectorAll(\"[data-collapse-toggle]\");\n  toggles.forEach((btn) => {\n    const targetId = btn.getAttribute(\"aria-controls\");\n    const container = btn.closest(\"[data-collapsible]\");\n    if (!targetId || !container) return;\n    const body = document.getElementById(targetId);\n    if (!body) return;\n\n    const collapsed = container.classList.contains(\"is-collapsed\");\n    btn.setAttribute(\"aria-expanded\", collapsed ? \"false\" : \"true\");\n\n    btn.addEventListener(\"click\", () => {\n      const nextCollapsed = !container.classList.contains(\"is-collapsed\");\n      container.classList.toggle(\"is-collapsed\", nextCollapsed);\n      btn.setAttribute(\"aria-expanded\", nextCollapsed ? \"false\" : \"true\");\n    });\n  });\n}\n\nfunction attachStorageListeners() {\n  let queued = false;\n  const triggerRefresh = () => {\n    if (queued) return;\n    queued = true;\n    setTimeout(async () => {\n      queued = false;\n      await refreshUsage();\n      await refreshCacheStats();\n    }, 250);\n  };\n\n  try {\n    if (typeof OfficeRuntime !== \"undefined\" && OfficeRuntime?.storage?.onChanged) {\n      const onChanged = OfficeRuntime.storage.onChanged;\n      if (typeof onChanged.add === \"function\") onChanged.add(() => triggerRefresh());\n      else if (typeof onChanged.addListener === \"function\") onChanged.addListener(() => triggerRefresh());\n      else if (typeof onChanged === \"function\") onChanged(() => triggerRefresh());\n    }\n  } catch {\n    // ignore\n  }\n\n  try {\n    window.addEventListener(\"storage\", () => triggerRefresh());\n  } catch {\n    // ignore\n  }\n}\n\nasync function saveProvider(provider) {\n  const isGemini = provider === PROVIDERS.GEMINI;\n\n  const keyEl = isGemini ? el(\"geminiKey\") : el(\"openaiKey\");\n  const modelEl = isGemini ? el(\"geminiModel\") : el(\"openaiModel\");\n  const effortEl = isGemini ? null : el(\"openaiReasoningEffort\");\n\n  const newKey = (keyEl.value || \"\").trim();\n  const newModel = (modelEl.value || \"\").trim();\n  const rawEffort = effortEl ? (effortEl.value || \"\").trim() : \"\";\n  const newEffort = effortEl ? syncOpenAIReasoningEffort(newModel, rawEffort) : \"\";\n\n  if (newKey) await setApiKey(provider, newKey);\n  // If empty, keep existing key (don't overwrite).\n  await setModel(provider, newModel);\n  if (!isGemini && effortEl) await setOpenAIReasoningEffort(newEffort);\n\n  await saveCommon();\n  await refreshUI();\n}\n\nasync function clearProvider(provider) {\n  await clearApiKey(provider);\n  await refreshUI();\n  setStatus(\"Cl efface.\", { provider });\n}\n\nasync function testProvider(provider) {\n  setStatus(\"Test en cours\", { provider });\n\n  const r = await aiMinimalTest(provider);\n  if (r.ok) {\n    setStatus(\"OK\", { provider: r.provider, model: r.model, response: r.text });\n  } else {\n    setStatus(\"chec\", { provider: r.provider, model: r.model, error: r.message, code: r.code });\n  }\n}\n\nasync function safeOfficeReady() {\n  try {\n    if (typeof Office !== \"undefined\" && Office?.onReady) {\n      await Office.onReady();\n    }\n  } catch {\n    // Running outside Office host (e.g., direct browser open)\n  }\n}\n\nasync function init() {\n  initCollapsibles();\n  attachStorageListeners();\n\n  const pricingHelp = el(\"pricingHelp\");\n  if (pricingHelp) {\n    pricingHelp.addEventListener(\"click\", () => openPricingModal());\n  }\n\n  document.querySelectorAll(\"[data-modal-close]\").forEach((btn) => {\n    btn.addEventListener(\"click\", () => closePricingModal());\n  });\n\n  document.addEventListener(\"keydown\", (e) => {\n    if (e.key === \"Escape\") closePricingModal();\n  });\n\n  // Tabs\n  el(\"tabGemini\").addEventListener(\"click\", () => activateTab(\"gemini\"));\n  el(\"tabOpenAI\").addEventListener(\"click\", () => activateTab(\"openai\"));\n\n  // Provider selection buttons\n  el(\"providerGemini\").addEventListener(\"click\", async () => {\n    setProviderButtons(PROVIDERS.GEMINI);\n    await saveCommon();\n    await refreshUI();\n  });\n\n  el(\"providerOpenAI\").addEventListener(\"click\", async () => {\n    setProviderButtons(PROVIDERS.OPENAI);\n    await saveCommon();\n    await refreshUI();\n  });\n\n  // Max tokens slider\n  el(\"maxTokensRange\").addEventListener(\"input\", () => {\n    updateMaxTokensValue();\n  });\n\n  el(\"maxTokensRange\").addEventListener(\"change\", async () => {\n    await saveCommon();\n    await refreshUI();\n  });\n\n  const effortEl = el(\"openaiReasoningEffort\");\n  if (effortEl) {\n    effortEl.addEventListener(\"input\", () => {\n      const allowNone = effortEl.dataset.allowNone !== \"0\";\n      let label = getReasoningEffortLabel(effortEl.value);\n      if (!allowNone && label === \"none\") {\n        effortEl.value = \"1\";\n        label = getReasoningEffortLabel(effortEl.value);\n      }\n      effortEl.setAttribute(\"aria-valuetext\", label);\n    });\n  }\n\n  const openaiModelEl = el(\"openaiModel\");\n  if (openaiModelEl) {\n    openaiModelEl.addEventListener(\"change\", () => {\n      const effortEl = el(\"openaiReasoningEffort\");\n      const currentEffort = effortEl ? effortEl.value : \"\";\n      syncOpenAIReasoningEffort(openaiModelEl.value, currentEffort);\n    });\n  }\n\n  // Provider save/clear/test\n  el(\"saveGemini\").addEventListener(\"click\", async () => saveProvider(PROVIDERS.GEMINI));\n  el(\"saveOpenAI\").addEventListener(\"click\", async () => saveProvider(PROVIDERS.OPENAI));\n\n  el(\"clearGemini\").addEventListener(\"click\", async () => clearProvider(PROVIDERS.GEMINI));\n  el(\"clearOpenAI\").addEventListener(\"click\", async () => clearProvider(PROVIDERS.OPENAI));\n\n  el(\"testGemini\").addEventListener(\"click\", async () => testProvider(PROVIDERS.GEMINI));\n  el(\"testOpenAI\").addEventListener(\"click\", async () => testProvider(PROVIDERS.OPENAI));\n\n  el(\"clearLogs\").addEventListener(\"click\", async () => {\n    await clearRequestLog();\n    await refreshUsage();\n    setStatus(\"Journal effac.\", { ok: true });\n  });\n\n  el(\"refreshCache\").addEventListener(\"click\", async () => {\n    await refreshCacheStats();\n    setStatus(\"Cache actualis.\", { ok: true });\n  });\n\n  el(\"clearCache\").addEventListener(\"click\", async () => {\n    await clearAllCaches();\n    await refreshCacheStats();\n    setStatus(\"Cache vid.\", { ok: true });\n  });\n\n  // Default tab\n  activateTab(\"gemini\");\n\n  await refreshUI();\n  await refreshUsage();\n  await refreshCacheStats();\n\n  setInterval(refreshUsage, 2000);\n  setInterval(refreshCacheStats, 12000);\n}\n\ndocument.addEventListener(\"DOMContentLoaded\", async () => {\n  await safeOfficeReady();\n  await init();\n});\n\n"],"names":["PROVIDERS","Object","freeze","GEMINI","OPENAI","DEFAULTS","provider","geminiModel","openaiModel","openaiReasoningEffort","maxOutputTokens","retry","timeoutMs","cache","cacheTtlSec","webCacheTtlSec","STORAGE_KEYS","DEFAULT_PROVIDER","GEMINI_API_KEY","OPENAI_API_KEY","GEMINI_MODEL","OPENAI_MODEL","OPENAI_REASONING_EFFORT","MAX_OUTPUT_TOKENS","MIGRATION_DONE","REQUEST_LOG","REQUEST_LOG_CLEAR_AT","CACHE_INDEX","CACHE_CLEAR_AT","LEGACY_KEYS","DEFAULT_PROVIDER_V2","GEMINI_API_KEY_V2","OPENAI_API_KEY_V2","GEMINI_MODEL_V2","OPENAI_MODEL_V2","GEMINI_MAX_TOKENS_V2","OPENAI_MAX_TOKENS_V2","_migrationPromise","getRuntimeStorage","OfficeRuntime","storage","getItem","kind","window","localStorage","mem","Map","async","k","has","get","setItem","v","set","String","removeItem","delete","getLocalStorageSafe","rawGet","key","result","local","localValue","rawSet","value","rawRemove","ensureMigrated","normalizeProvider","legacyProvider","legacy","candidates","map","x","parseInt","trim","filter","n","Number","isFinite","migrated","length","Math","max","p","s","toLowerCase","OPENAI_REASONING_EFFORTS","Set","normalizeReasoningEffort","getDefaultProvider","keyKey","getApiKey","modelKey","getModel","raw","getOpenAIReasoningEffort","setOpenAIReasoningEffort","getMaxOutputTokens","clampInt","setMaxOutputTokens","nowMs","Date","now","sleep","ms","Promise","resolve","setTimeout","min","fallback","parseTimestampMs","CACHE_ENTRY_PREFIX","_cacheClearMs","syncCacheClearMarker","clearedAt","loadCacheIndex","arr","JSON","parse","Array","isArray","saveCacheIndex","entries","stringify","pruneCacheIndex","kept","removedKeys","entry","savedAt","savedAtMs","expiresAtMs","push","sort","a","b","over","toRemove","slice","r","list","removeCacheEntry","removeFromCacheIndex","index","next","item","setPersistentCache","cacheKey","ttlMs","meta","model","size","updated","pruned","sortKeysDeep","prototype","toString","call","out","keys","REQUEST_LOG_TTL_MS","_requestLog","_requestLogLoading","_requestLogLoaded","_requestLogLastLoadedMs","_requestLogClearMs","syncRequestLogClearMarker","options","reset","loadRequestLog","force","parsed","e","ts","persistRequestLog","pruneRequestLog","logRequest","logEntry","logRequestAsync","CACHE","constructor","maxEntries","this","oldestKey","clear","_cacheClearLocalMs","INFLIGHT","active","queue","isNonEmptyString","normalizeBoolean","def","includes","normalizeTimeoutMs","toLowerMsg","looksLikeStructuredOutputUnsupported","message","looksLikeWebSearchUnsupported","ensureJsonInstruction","system","test","getFormulaForLog","fnName","text","match","formula","startsWith","extractFormulaFromText","aiGenerate","req","start","apiKey","functionName","fn","ok","code","user","webSearch","cfgMax","normalizeMaxOutputTokens","reasoningEffort","cacheEnabled","ttlSec","getCacheClearAt","cacheKeyPayload","responseMimeType","responseJsonSchema","input","crypto","subtle","digest","TextEncoder","bytes","encode","from","Uint8Array","padStart","join","str","h","i","charCodeAt","imul","fnv1a32","hashKey","cached","cacheKind","inputTokens","outputTokens","totalTokens","undefined","persisted","Error","getPersistentCache","attempt","lastErr","callProvider","url","body","max_output_tokens","store","reasoning","effort","sysText","instructions","format","type","name","strict","schema","tools","include","res","fetchWithTimeout","method","headers","Authorization","json","safeJson","msg","error","extractOpenAIError","status","output_text","output","texts","content","part","choices","extractOpenAIText","sources","action","src","title","dedupeSources","extractOpenAISources","usage","u","toInt","input_tokens","output_tokens","total_tokens","cachedInputTokens","input_tokens_details","cached_tokens","extractOpenAIUsage","callOpenAI","opts","encodeURIComponent","geminiEndpoint","contents","role","parts","generationConfig","systemInstruction","responseSchema","google_search","extractGeminiError","c","extractGeminiText","md","groundingMetadata","chunks","groundingChunks","ch","web","uri","extractGeminiSources","usageMetadata","promptTokenCount","candidatesTokenCount","totalTokenCount","extractGeminiUsage","callGemini","baseOpts","wantsStructured","normalizeUsage","shift","withConcurrencyLimit","floor","seen","add","t","AbortController","fetch","ctrl","id","abort","signal","clearTimeout","el","document","getElementById","setStatus","line","detailsObj","textContent","formatNumber","round","toLocaleString","CURRENCY_SYMBOL","formatCost","toFixed","formatDuration","formatTime","toLocaleTimeString","hour","minute","OPENAI_REASONING_LEVELS","DEFAULT_MODELS","gemini","openai","MODEL_CATALOG","label","prices","cachedInput","costLevel","reasoningLevel","recommended","supportsReasoningNone","MODEL_LOOKUP","m","PROVIDER_LABELS","repeatIcon","icon","level","count","getReasoningEffortLabel","idx","clamped","syncOpenAIReasoningEffort","modelId","preferred","effortEl","allowNone","openaiModelAllowsNone","wrap","closest","classList","toggle","dataset","allowed","indexOf","setAttribute","formatRate","decimals","replace","modelIndicators","cost","modelOptionLabel","indicators","estimateCost","getModelMeta","uncached","normalizeUsageEntry","populateModelSelect","selectEl","currentModel","requested","requestedKey","innerHTML","matched","option","createElement","selected","appendChild","setPricingModalOpen","isOpen","modal","closePricingModal","setKeyStatus","hasKey","node","clampExp","expToTokens","exp","setProviderButtons","isGemini","activateTab","tab","refreshUI","maxTok","gemModel","oaiModel","gemKey","oaiKey","oaiReasoningEffort","all","tokens","log2","tokensToExp","normalizedTokens","geminiModelEl","openaiModelEl","safeEffort","effectiveEffort","placeholder","defaultProvider","buildBreakdownRow","isSub","row","className","tokensEl","costEl","refreshUsage","logs","fresh","getRequestLog","breakdown","models","total","requests","byProvider","bucket","modelEntry","container","providers","data","values","localeCompare","renderUsageBreakdown","empty","buildTokenFlow","iconText","val","cacheClass","top","titleText","formulaText","detail","chevron","addEventListener","tags","style","display","gap","providerTag","toUpperCase","statusTag","cacheTag","tokensTotal","modelLabel","durationLabel","right","cacheNote","tokensWrap","tokensLine","heatDot","getTokenHeatClass","tokensTotalEl","tokensDetailEl","createTextNode","renderLogList","canvas","ctx","getContext","width","clientWidth","height","clientHeight","dpr","devicePixelRatio","setTransform","buckets","fill","maxValue","lineColor","getComputedStyle","documentElement","getPropertyValue","clearRect","strokeStyle","lineWidth","y","beginPath","moveTo","lineTo","stroke","forEach","gradient","createLinearGradient","addColorStop","closePath","fillStyle","drawUsageChart","refreshCacheStats","stats","sizeBytes","oldestMs","newestMs","getPersistentCacheStats","formatBytes","saveCommon","contains","savedProvider","setDefaultProvider","saveProvider","keyEl","modelEl","newKey","newModel","rawEffort","newEffort","setApiKey","setModel","clearProvider","clearApiKey","testProvider","providerOverride","aiMinimalTest","response","init","querySelectorAll","btn","targetId","getAttribute","collapsed","nextCollapsed","queued","triggerRefresh","onChanged","addListener","attachStorageListeners","pricingHelp","gemBody","oaiBody","renderProvider","cellModel","cellInput","cellOutput","cellCost","cellReason","renderPricingTable","updateMaxTokensValue","currentEffort","clearRequestLog","clearPersistentCache","clearAllCaches","setInterval","Office","onReady","safeOfficeReady"],"ignoreList":[],"sourceRoot":""}