(()=>{"use strict";const e=Object.freeze({GEMINI:"gemini",OPENAI:"openai"}),t=Object.freeze({provider:e.GEMINI,geminiModel:"gemini-3-flash-preview",openaiModel:"gpt-5-mini",openaiReasoningEffort:"medium",maxOutputTokens:1024,retry:2,timeoutMs:12e4,cache:!0,cacheTtlSec:604800,webCacheTtlSec:3600}),n=Object.freeze({DEFAULT_PROVIDER:"AI_DEFAULT_PROVIDER_V3",GEMINI_API_KEY:"AI_GEMINI_API_KEY_V3",OPENAI_API_KEY:"AI_OPENAI_API_KEY_V3",GEMINI_MODEL:"AI_GEMINI_MODEL_V3",OPENAI_MODEL:"AI_OPENAI_MODEL_V3",OPENAI_REASONING_EFFORT:"AI_OPENAI_REASONING_EFFORT_V3",MAX_OUTPUT_TOKENS:"AI_MAX_OUTPUT_TOKENS_V3",ONBOARDING_SEEN:"AI_ONBOARDING_SEEN_V1",MIGRATION_DONE:"AI_MIGRATION_DONE_V3",REQUEST_LOG:"AI_REQUEST_LOG_V1",REQUEST_LOG_CLEAR_AT:"AI_REQUEST_LOG_CLEAR_AT_V1",CACHE_INDEX:"AI_CACHE_INDEX_V1",CACHE_CLEAR_AT:"AI_CACHE_CLEAR_AT_V1"}),r=Object.freeze({GEMINI_API_KEY:"GEMINI_API_KEY",MAX_OUTPUT_TOKENS:"MAX_OUTPUT_TOKENS",DEFAULT_PROVIDER_V2:"AI_DEFAULT_PROVIDER_V2",GEMINI_API_KEY_V2:"AI_GEMINI_API_KEY_V2",OPENAI_API_KEY_V2:"AI_OPENAI_API_KEY_V2",GEMINI_MODEL_V2:"AI_GEMINI_MODEL_V2",OPENAI_MODEL_V2:"AI_OPENAI_MODEL_V2",GEMINI_MAX_TOKENS_V2:"AI_GEMINI_MAX_OUTPUT_TOKENS_V2",OPENAI_MAX_TOKENS_V2:"AI_OPENAI_MAX_OUTPUT_TOKENS_V2"});let o=null;function s(){try{if("undefined"!=typeof OfficeRuntime&&OfficeRuntime?.storage?.getItem)return{kind:"office",storage:OfficeRuntime.storage}}catch{}try{if("undefined"!=typeof window&&window?.localStorage?.getItem)return{kind:"local",storage:window.localStorage}}catch{}const e=new Map;return{kind:"memory",storage:{getItem:async t=>e.has(t)?e.get(t):null,async setItem(t,n){e.set(t,String(n))},async removeItem(t){e.delete(t)}}}}function i(){try{if("undefined"!=typeof window&&window?.localStorage?.getItem)return window.localStorage}catch{return null}return null}async function a(e){const{kind:t,storage:n}=s();if("local"===t)try{return n.getItem(e)}catch{return null}if("office"===t)try{const t=await n.getItem(e);if(null==t){const t=i();if(!t)return null;try{const n=t.getItem(e);return null==n?null:n}catch{return null}}return t}catch{const t=i();if(!t)return null;try{return t.getItem(e)}catch{return null}}try{return await n.getItem(e)}catch{return null}}async function c(e,t){const{kind:n,storage:r}=s(),o=null==t?"":String(t);if("local"===n)try{return void r.setItem(e,o)}catch{return}if("office"===n){try{await r.setItem(e,o)}catch{}const t=i();if(!t)return;try{t.setItem(e,o)}catch{}return}try{await r.setItem(e,o)}catch{}}async function u(){if(o)return o;o=(async()=>{if("1"!==await a(n.MIGRATION_DONE)){if(!l(await a(n.DEFAULT_PROVIDER))){const e=l(await a(r.DEFAULT_PROVIDER_V2));await c(n.DEFAULT_PROVIDER,e||t.provider)}if(!await a(n.GEMINI_API_KEY)){const e=await a(r.GEMINI_API_KEY_V2)||await a(r.GEMINI_API_KEY);e&&await c(n.GEMINI_API_KEY,e)}if(!await a(n.OPENAI_API_KEY)){const e=await a(r.OPENAI_API_KEY_V2);e&&await c(n.OPENAI_API_KEY,e)}if(!await a(n.GEMINI_MODEL)){const e=await a(r.GEMINI_MODEL_V2);await c(n.GEMINI_MODEL,e||t.geminiModel)}if(!await a(n.OPENAI_MODEL)){const e=await a(r.OPENAI_MODEL_V2);await c(n.OPENAI_MODEL,e||t.openaiModel)}if(!await a(n.MAX_OUTPUT_TOKENS)){const e=[await a(r.MAX_OUTPUT_TOKENS),await a(r.GEMINI_MAX_TOKENS_V2),await a(r.OPENAI_MAX_TOKENS_V2)].map(e=>parseInt(String(e||"").trim(),10)).filter(e=>Number.isFinite(e)&&e>0),o=e.length?Math.max(...e):t.maxOutputTokens;await c(n.MAX_OUTPUT_TOKENS,String(o))}await c(n.MIGRATION_DONE,"1")}})();try{await o}finally{o=null}}function l(t){if(!t)return"";const n=String(t).trim().toLowerCase();return n===e.GEMINI?e.GEMINI:n===e.OPENAI?e.OPENAI:"google"===n||"gem"===n?e.GEMINI:"oai"===n||"chatgpt"===n?e.OPENAI:""}const m=new Set(["none","minimal","low","medium","high"]);async function p(){return await u(),l(await a(n.DEFAULT_PROVIDER))||t.provider}async function f(t){return await u(),(await a(function(t){return l(t)===e.OPENAI?n.OPENAI_API_KEY:n.GEMINI_API_KEY}(t))||"").trim()}async function h(r){await u();const o=l(r),s=await a(function(t){return l(t)===e.OPENAI?n.OPENAI_MODEL:n.GEMINI_MODEL}(o));return s&&String(s).trim()?String(s).trim():o===e.OPENAI?t.openaiModel:t.geminiModel}async function d(){await u();const e=await a(n.MAX_OUTPUT_TOKENS);return A(parseInt(String(e||"").trim(),10),1,128e3,t.maxOutputTokens)}function y(){return Date.now()}function g(e){return new Promise(t=>setTimeout(t,e))}function A(e,t,n,r=t){const o=parseInt(String(e),10);return Number.isFinite(o)?Math.max(t,Math.min(n,o)):r}function E(e){const t=parseInt(String(e||"").trim(),10);return Number.isFinite(t)&&t>0?t:0}const I="AI_CACHE_ENTRY_V1:";let w=0;async function N(){const e=E(await a(n.CACHE_CLEAR_AT));return e>w&&(w=e),w}async function _(){const e=await a(n.CACHE_INDEX);if(!e)return[];try{const t=JSON.parse(e);return Array.isArray(t)?t:[]}catch{return[]}}async function T(e){try{await c(n.CACHE_INDEX,JSON.stringify(e))}catch{}}async function S(e){e&&await async function(e){const{kind:t,storage:n}=s();if("local"===t)try{return void n.removeItem(e)}catch{return}if("office"===t){try{await n.removeItem(e)}catch{}const t=i();if(!t)return;try{t.removeItem(e)}catch{}return}try{await n.removeItem(e)}catch{}}(I+e)}async function O(e){const t=await _(),n=(t||[]).filter(t=>t?.key!==e);n.length!==t.length&&await T(n)}async function v(e,t,n,r={}){if(!e)return;const o=y(),s=await N(),i=s&&o<=s?s+1:o,a="number"==typeof n&&n>0?i+n:null,u={v:1,savedAtMs:i,expiresAtMs:a,value:t},l=JSON.stringify(u);await c(I+e,l);const m=await _(),p=r.provider||t?.provider||"",f=r.model||t?.model||"",h=l.length;let d=!1;const g=(m||[]).map(t=>t?.key!==e?t:(d=!0,{key:e,provider:p,model:f,size:h,savedAtMs:i,expiresAtMs:a}));d||g.push({key:e,provider:p,model:f,size:h,savedAtMs:i,expiresAtMs:a});const A=function(e,t=0){const n=y(),r=[],o=[];for(const s of e||[]){if(!s||!s.key)continue;const e=Number(s.savedAtMs||0);t&&(!Number.isFinite(e)||e<=t)||s.expiresAtMs&&s.expiresAtMs<=n?o.push(s.key):r.push(s)}if(r.length>250){r.sort((e,t)=>(e.savedAtMs||0)-(t.savedAtMs||0));const e=r.length-250,t=r.slice(0,e);for(const e of t)o.push(e.key);return{list:r.slice(e),removedKeys:o}}return{list:r,removedKeys:o}}(g,s);for(const e of A.removedKeys)await S(e);await T(A.list)}function x(e){if(Array.isArray(e))return e.map(x);if(t=e,"[object Object]"===Object.prototype.toString.call(t)){const t={};for(const n of Object.keys(e).sort())t[n]=x(e[n]);return t}var t;return e}const C=864e5;let M=[],R=null,b=!1,k=0,P=0;async function L(e={}){const t=E(await a(n.REQUEST_LOG_CLEAR_AT));return t>P&&(P=t,M=[],e.reset?(b=!0,R=null,k=y()):b=!1),P}async function $(){try{await c(n.REQUEST_LOG,JSON.stringify(M.slice(-500)))}catch{}}function F(){const e=y(),t=P||0;M=(M||[]).filter(n=>n&&"number"==typeof n.ts&&n.ts>t&&e-n.ts<=C),M.length>500&&(M=M.slice(-500))}function j(e){!async function(e){try{await L({reset:!0});const t={ts:y(),...e};if(b)return M.push(t),F(),k=y(),void await $();await async function(e=!1){if(R)return R;R=(async()=>{const t=await L();if(!e&&b)return M;const r=await a(n.REQUEST_LOG);let o=[];if(r)try{const e=JSON.parse(r);Array.isArray(e)&&(o=e)}catch{o=[]}const s=y();return o=o.map(e=>{if(!e)return null;let t=e.ts;if("string"==typeof t){const e=Date.parse(t);Number.isFinite(e)&&(t=e)}return"number"!=typeof t?null:{...e,ts:t}}).filter(e=>e&&"number"==typeof e.ts&&e.ts>t&&s-e.ts<=C),M=o.slice(-500),b=!0,k=y(),M})();try{return await R}finally{R=null}}(),M.push(t),F(),k=y(),await $()}catch{}}(e)}const U=new class{constructor(e=500){this.maxEntries=e,this.map=new Map}get(e){if(!this.map.has(e))return null;const t=this.map.get(e);return t?.expiresAtMs&&t.expiresAtMs<=y()?(this.map.delete(e),null):(this.map.delete(e),this.map.set(e,t),t.value)}set(e,t,n){const r="number"==typeof n&&n>0?y()+n:null;for(this.map.has(e)&&this.map.delete(e),this.map.set(e,{value:t,expiresAtMs:r});this.map.size>this.maxEntries;){const e=this.map.keys().next().value;this.map.delete(e)}}clear(){this.map.clear()}}(800);let V=0;const K=new Map;let G=0;const D=[];function J(e){return"string"==typeof e&&e.trim().length>0}function Y(e,t=!1){if("boolean"==typeof e)return e;if("number"==typeof e)return 0!==e;if("string"==typeof e){const t=e.trim().toLowerCase();if(["1","true","yes","y","on"].includes(t))return!0;if(["0","false","no","n","off"].includes(t))return!1}return t}function X(e){return A(e,1e3,12e4,t.timeoutMs)}function q(e){return String(e||"").toLowerCase()}function z(e){const t=q(e);return!!t&&(t.includes("responseschema")||t.includes("response schema")||t.includes("response_schema")||t.includes("responsemime")||t.includes("response mime")||t.includes("response_mime")||t.includes("response_mime_type")||t.includes("json_schema")||t.includes("response_format")||t.includes("text.format"))}function B(e){const t=q(e);return!!t&&!!(t.includes("web_search")||t.includes("google_search")||t.includes("web search")||t.includes("google search"))&&(t.includes("not supported")||t.includes("unsupported")||t.includes("unknown")||t.includes("unrecognized")||t.includes("invalid")||t.includes("not enabled")||t.includes("not available"))}function H(e){if(!J(e))return"Return valid JSON only.";const t=String(e).trim();return/json/i.test(t)?t:t+" Return valid JSON only."}function W(e,t){return"AI.FORMULA"!==e?"":function(e){if(!J(e))return"";const t=String(e).trim(),n=t.match(/=[^\n\r]+/),r=(n?n[0]:t).trim();return r.startsWith("=")?r:""}(t)}async function Q(r){const o=y(),s=l(r?.provider)||await p(),i=await h(s),c=await f(s),E=r?.functionName||"aiGenerate";if(!c)return j({fn:E,provider:s,model:i,ok:!1,ms:y()-o,cache:!1,code:"API_KEY_MISSING",message:`Clé API manquante pour le fournisseur ${s}.`}),{ok:!1,provider:s,model:i,code:"API_KEY_MISSING",message:`Clé API manquante pour le fournisseur ${s}.`};const w=String(r?.user||""),_=J(r?.system)?String(r.system):"",T=Y(r?.webSearch,!1),C=X(r?.timeoutMs),M=(R=r?.retry,A(R,0,5,t.retry));var R;const b=await d(),k=function(e){return A(e,1,128e3,t.maxOutputTokens)}(r?.maxOutputTokens??b),P=s===e.OPENAI?await async function(){return await u(),function(e){const n=String(e||"").trim().toLowerCase();return n&&m.has(n)?n:t.openaiReasoningEffort}(await a(n.OPENAI_REASONING_EFFORT)||t.openaiReasoningEffort)}():"",L=Y(r?.cache,t.cache),$=A(r?.cacheTtlSec??(T?t.webCacheTtlSec:t.cacheTtlSec),1,31536e3,T?t.webCacheTtlSec:t.cacheTtlSec);await async function(){const e=await async function(){return await N()}();e>V&&(V=e,U.clear())}();const F={v:3,provider:s,model:i,maxOutputTokens:k,reasoningEffort:P,webSearch:T,system:_,user:w,responseMimeType:r?.responseMimeType||"",responseJsonSchema:r?.responseJsonSchema||null},q=await async function(e){const t="string"==typeof e?e:(n=e,JSON.stringify(x(n)));var n;try{if("undefined"!=typeof crypto&&crypto?.subtle?.digest&&"undefined"!=typeof TextEncoder){const e=(new TextEncoder).encode(t),n=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(n)).map(e=>e.toString(16).padStart(2,"0")).join("")}}catch{}return`fnv1a:${function(e){let t=2166136261;for(let n=0;n<e.length;n++)t^=e.charCodeAt(n),t=Math.imul(t,16777619);return(t>>>0).toString(16).padStart(8,"0")}(t)}`}(F);if(L){const e=U.get(q);if(e){const t=W(E,e?.text);return j({fn:E,provider:s,model:i,ok:!0,ms:y()-o,cache:!0,cacheKind:"memory",inputTokens:0,outputTokens:0,reasoningTokens:0,totalTokens:0,formula:t||void 0}),{...e,cached:!0,cacheKind:"memory"}}const t=await async function(e){if(!e)return null;const t=await N(),n=await a(I+e);if(!n)return await O(e),null;try{const r=JSON.parse(n);if(!r||"object"!=typeof r)throw new Error("Invalid entry");const o=Number(r.savedAtMs||0);return t&&(!Number.isFinite(o)||o<=t)||r.expiresAtMs&&r.expiresAtMs<=y()?(await S(e),await O(e),null):r.value||null}catch{return await S(e),await O(e),null}}(q);if(t){const e=W(E,t?.text);return U.set(q,t,1e3*$),j({fn:E,provider:s,model:i,ok:!0,ms:y()-o,cache:!0,cacheKind:"persistent",inputTokens:0,outputTokens:0,reasoningTokens:0,totalTokens:0,formula:e||void 0}),{...t,cached:!0,cacheKind:"persistent"}}}if(K.has(q))return K.get(q);const Q=async function(){G>=4&&await new Promise(e=>D.push(e)),G++;try{return await(async()=>{let t=0,n=null;const a=async t=>s===e.OPENAI?async function({apiKey:t,model:n,system:r,user:o,maxOutputTokens:s,reasoningEffort:i,timeoutMs:a,webSearch:c,responseMimeType:u,responseJsonSchema:l}){const m="https://api.openai.com/v1/responses",p={model:n,input:o,max_output_tokens:s,store:!1};if(J(i)&&(p.reasoning={effort:i}),J(r)){const e="application/json"===u||l?r+" You must return valid JSON.":r;p.instructions=e}l?p.text={format:{type:"json_schema",name:"excel_ai_schema",strict:!0,schema:l}}:"application/json"===u&&(p.text={format:{type:"json_object"}}),c&&(p.tools=[{type:"web_search"}],p.include=["web_search_call.action.sources"]);const f=await ne(m,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify(p)},a),h=await re(f);if(!f.ok){const t=function(e){try{const t=e?.error?.message;return t?String(t):""}catch{return""}}(h)||`OpenAI API error (${f.status}).`;return{ok:!1,provider:e.OPENAI,model:n,code:"API_ERROR",message:t}}const d=function(e){try{if("string"==typeof e?.output_text&&e.output_text.trim())return e.output_text}catch{}try{const t=e?.output;if(Array.isArray(t)){const e=[];for(const n of t){if("string"==typeof n?.text&&n.text.trim()&&e.push(n.text),"string"==typeof n?.output_text&&n.output_text.trim()&&e.push(n.output_text),"output_text"===n?.type&&"string"==typeof n?.text&&e.push(n.text),"text"===n?.type&&"string"==typeof n?.text&&e.push(n.text),"message"===n?.type){const t=n?.content;if(Array.isArray(t))for(const n of t)"text"===n?.type&&n?.text&&e.push(n.text),"output_text"===n?.type&&n?.text&&e.push(n.text);else"string"==typeof t&&e.push(t)}if("message"!==n?.type){const t=n?.content;if(Array.isArray(t))for(const n of t)"text"===n?.type&&n?.text&&e.push(n.text),"output_text"===n?.type&&n?.text&&e.push(n.text);else"string"==typeof t&&e.push(t)}}if(e.length>0)return e.join("\n").trim()}}catch{}try{return e?.choices?.[0]?.message?.content||""}catch{return""}}(h),y=c?function(e){try{const t=e?.output;if(!Array.isArray(t))return[];const n=[];for(const e of t){if("web_search_call"!==e?.type)continue;const t=e?.action?.sources;if(Array.isArray(t))for(const e of t)e?.url&&n.push({title:e?.title||"",url:e.url})}return te(n)}catch{return[]}}(h):[],g=function(e){try{const t=e?.usage;if(!t)return null;const n=ee(t?.output_tokens),r=ee(t?.output_tokens_details?.reasoning_tokens),o=Math.max(0,n-r);return{inputTokens:ee(t?.input_tokens),outputTokens:o,reasoningTokens:r,totalTokens:ee(t?.total_tokens),cachedInputTokens:ee(t?.input_tokens_details?.cached_tokens)}}catch{return null}}(h);return J(d)?{ok:!0,provider:e.OPENAI,model:n,text:d.trim(),sources:y,usage:g}:{ok:!1,provider:e.OPENAI,model:n,code:"EMPTY_RESPONSE",message:"Réponse vide d'OpenAI."}}(t):async function({apiKey:t,model:n,system:r,user:o,maxOutputTokens:s,timeoutMs:i,webSearch:a,responseMimeType:c,responseJsonSchema:u}){const l=function(e,t){return`https://generativelanguage.googleapis.com/v1beta/models/${encodeURIComponent(e)}:generateContent?key=${encodeURIComponent(t)}`}(n,t),m={contents:[{role:"user",parts:[{text:o}]}],generationConfig:{maxOutputTokens:s}};if(J(r)){const e="application/json"===c||u?r+" You must return valid JSON.":r;m.systemInstruction={role:"system",parts:[{text:e}]}}c&&(m.generationConfig.responseMimeType=c),u&&(m.generationConfig.responseSchema=u),a&&(m.tools=[{google_search:{}}]);const p=await ne(l,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(m)},i),f=await re(p);if(!p.ok){const t=function(e){try{const t=e?.error?.message;return t?String(t):""}catch{return""}}(f)||`Gemini API error (${p.status}).`;return{ok:!1,provider:e.GEMINI,model:n,code:"API_ERROR",message:t}}const h=function(e){try{const t=e?.candidates?.[0],n=t?.content?.parts;return Array.isArray(n)?n.map(e=>e?.text||"").join(""):""}catch{return""}}(f),d=function(e){try{const t=e?.candidates?.[0],n=t?.groundingMetadata,r=n?.groundingChunks;if(!Array.isArray(r))return[];const o=[];for(const e of r){const t=e?.web;t?.uri&&o.push({title:t?.title||"",url:t.uri})}return te(o)}catch{return[]}}(f),y=function(e){try{const t=e?.usageMetadata;return t?{inputTokens:ee(t?.promptTokenCount),outputTokens:ee(t?.candidatesTokenCount),reasoningTokens:ee(t?.thoughtsTokenCount),totalTokens:ee(t?.totalTokenCount),cachedInputTokens:ee(t?.cachedContentTokenCount)}:null}catch{return null}}(f);return J(h)?{ok:!0,provider:e.GEMINI,model:n,text:h.trim(),sources:d,usage:y}:{ok:!1,provider:e.GEMINI,model:n,code:"EMPTY_RESPONSE",message:"Réponse vide de Gemini."}}(t);for(;t<=M;){t++;try{const e={apiKey:c,model:i,system:_,user:w,maxOutputTokens:k,reasoningEffort:P,timeoutMs:C,webSearch:T,responseMimeType:r?.responseMimeType,responseJsonSchema:r?.responseJsonSchema};let n=await a(e);if(!n.ok){let t=e;t.webSearch&&(B(n.message)||"API_ERROR"===n.code||"EMPTY_RESPONSE"===n.code)&&(t={...t,webSearch:!1},n=await a(t));const r=t.responseMimeType||t.responseJsonSchema;!n.ok&&r&&(z(n.message)||"API_ERROR"===n.code||"EMPTY_RESPONSE"===n.code)&&(t={...t,responseMimeType:void 0,responseJsonSchema:void 0,system:H(t.system)},n=await a(t))}const u=Z(n?.usage),l=n.ok?W(E,n.text):"";return j({fn:E,provider:s,model:i,ok:n.ok,ms:y()-o,attempt:t,cache:!1,inputTokens:u.inputTokens,outputTokens:u.outputTokens,reasoningTokens:u.reasoningTokens,cachedInputTokens:u.cachedInputTokens,totalTokens:u.totalTokens,code:n.code,message:n.message,formula:l||void 0}),n.ok&&L&&(U.set(q,n,1e3*$),await v(q,n,1e3*$,{provider:s,model:i})),n}catch(e){n=e,t<=M&&await g(250*t)}}const u=n?.message?String(n.message):"Erreur inconnue.";return j({fn:E,provider:s,model:i,ok:!1,ms:y()-o,cache:!1,code:"API_ERROR",message:u}),{ok:!1,provider:s,model:i,code:"API_ERROR",message:u}})()}finally{G--;const e=D.shift();e&&e()}}();K.set(q,Q);try{return await Q}finally{K.delete(q)}}function Z(e){if(!e||"object"!=typeof e)return{inputTokens:0,outputTokens:0,reasoningTokens:0,totalTokens:0,cachedInputTokens:0};const t=ee(e.inputTokens),n=ee(e.outputTokens),r=ee(e.reasoningTokens),o=ee(e.cachedInputTokens),s=ee(e.totalTokens),i=t+n+r;return{inputTokens:t,outputTokens:n,reasoningTokens:r,totalTokens:Math.max(s,i),cachedInputTokens:o}}function ee(e){const t=Number(e);return!Number.isFinite(t)||t<=0?0:Math.floor(t)}function te(e){const t=new Set,n=[];for(const r of e||[]){const e=String(r?.url||"").trim();if(!e)continue;const o=e.toLowerCase();t.has(o)||(t.add(o),n.push({title:String(r?.title||"").trim(),url:e}))}return n}async function ne(e,t,n){const r=X(n);if("undefined"==typeof AbortController)return await fetch(e,t);const o=new AbortController,s=setTimeout(()=>o.abort(),r);try{return await fetch(e,{...t,signal:o.signal})}finally{clearTimeout(s)}}async function re(e){try{return await e.json()}catch{return{}}}const oe=Number.POSITIVE_INFINITY,se="fr";function ie(e){return Array.isArray(e)}function ae(e){return Array.isArray(e)?0===e.length?[[]]:Array.isArray(e[0])?e:[e]:[[e]]}function ce(e){if(null==e)return"";if("string"==typeof e)return e;if("number"==typeof e)return String(e);if("boolean"==typeof e)return e?"TRUE":"FALSE";try{return String(e)}catch{return""}}function ue(e){const t=String(e||"");return t.length<=32e3?t:t.slice(0,31999)+"…"}function le(e,t=9e3){const n=ae(e),r=[];for(const e of n){const t=Array.isArray(e)?e:[e];r.push(t.map(ce).join("\t"))}let o=r.join("\n");return o.length>t&&(o=o.slice(0,t)+"\n…"),o}function me(e,t=200){const n=ae(e),r=[];for(const e of n){const n=Array.isArray(e)?e:[e];for(const e of n)if(r.push(ce(e)),r.length>=t)return r}return r}function pe(e){const t=new Set,n=[];for(const r of e){const e=r.toLowerCase();t.has(e)||(t.add(e),n.push(r))}return n}function fe(e,t){try{if("undefined"!=typeof CustomFunctions&&CustomFunctions?.Error){const n=e||CustomFunctions.ErrorCode.invalidValue;return new CustomFunctions.Error(n,t)}}catch{}return`#ERROR: ${t}`}function he(e){const t=String(e||"").trim(),n=t.match(/```(?:json)?\s*([\s\S]*?)\s*```/i);if(n)return JSON.parse(n[1]);try{return JSON.parse(t)}catch(e){const n=t.indexOf("{"),r=t.lastIndexOf("}");if(-1!==n&&r>n)try{return JSON.parse(t.slice(n,r+1))}catch{}const o=t.indexOf("["),s=t.lastIndexOf("]");if(-1!==o&&s>o)try{return JSON.parse(t.slice(o,s+1))}catch{}throw e}}const de="Never ask clarifying questions. If information is missing, make reasonable assumptions and proceed.";function ye(e="fr"){return["You are an assistant embedded in Microsoft Excel custom functions.",`Respond in ${e}.`,"Return a clear and accurate answer suitable for an Excel cell.",de,"No Markdown. No code fences. No surrounding quotes.","If the question cannot be answered from the provided information, say so briefly."].join("\n")}function ge(e,t){const n=Number.isFinite(Number(t))?Math.floor(Number(t)):0;return n>1?["You are a translation engine.",`Translate each cell independently into ${e}.`,de,"Return STRICT JSON only (no Markdown, no code fences).",`Return an object with a single key 'items' containing exactly ${n} strings in the same order as the provided cells.`,"Each item must contain ONLY the translated text for that cell.","Preserve numbers, units, and identifiers as-is unless they require translation.","For empty inputs, return an empty string at the same position.","Do not add any keys other than 'items'."].join("\n"):["You are a translation engine.",`Translate the user text into ${e}.`,de,"Return only the translated text. No quotes. No explanations."].join("\n")}function Ae(e,t="en"){return["You are a strict classifier.",`Return exactly one label from this set, using the label text verbatim: ${e.join(" | ")}`,"Do not translate, expand, or paraphrase labels.","If uncertain, return exactly: UNKNOWN",de,`Respond in ${t}.`,"Return only the label."].join("\n")}function Ee(e="fr",t){return"number"==typeof t&&t>1?["You are a text normalizer for spreadsheet cells.",`Respond in ${e}.`,de,"Return STRICT JSON only (no Markdown, no code fences).",`Return an object with a single key 'items' containing exactly ${t} strings in the same order as the provided cells.`,"Preserve the meaning of each cell independently.","For empty inputs, return an empty string at the same position.","Do not invent or merge content."].join("\n"):["You are a text normalizer for spreadsheet cells.",`Respond in ${e}.`,de,"Return only the cleaned text.","No quotes. No explanations."].join("\n")}function Ie(e="fr",t){return["You harmonize spreadsheet entries that refer to the same real-world value.",`Respond in ${e}.`,de,"Return STRICT JSON only (no Markdown, no code fences).",`Return an object with a single key 'items' containing exactly ${t} strings in the same order as the provided cells.`,"Normalize casing, accents, spacing, and fix obvious typos.","When several cells refer to the same entity, use ONE consistent, best-written value for all of them.","Keep outputs aligned with inputs; do not merge or reorder rows.","If an input is empty or whitespace-only, return an empty string for that position.","Do not invent new information beyond correcting the given values."].join("\n")}function we(e="fr",t){return"number"==typeof t&&t>1?["You summarize text for spreadsheet cells.",`Respond in ${e}.`,de,"Return STRICT JSON only (no Markdown, no code fences).",`Return an object with a single key 'items' containing exactly ${t} strings in the same order as the provided cells.`,"Summarize each cell independently; do not merge content across cells.","Use bullet points with '-' when it improves readability.","Keep outputs aligned with inputs. If an input is empty or whitespace-only, return an empty string for that position.","No Markdown headers. No code fences. No surrounding quotes."].join("\n"):["You summarize text for a spreadsheet cell.",`Respond in ${e}.`,de,"Return a clear summary suitable for an Excel cell.","Use bullet points with '-' when it improves readability.","No Markdown headers. No code fences. No surrounding quotes."].join("\n")}function Ne(e,t="fr",n){return["You are an expert extraction engine.",`Goal: Extract all entities matching this description: "${e}"`,`Respond in ${t}.`,de,"Lightly normalize results (trim spaces, fix obvious email obfuscation like [at]/(at) -> @ and [dot]/(dot)/point -> .).","Return STRICT JSON only (no Markdown, no code fences).","number"==typeof n&&n>0?`Return an object with a single key 'items' which is an array of exactly ${n} strings, preserving order.`:"Return an object with a single key 'items' which is an array of strings.",'Example: { "items": ["match1", "match2"] }',"number"==typeof n?"If a value is missing for a cell, return an empty string in that position.":'If nothing found, return { "items": [] }.',"Extract exact values from the text without inventing data."].join("\n")}function _e(e="fr",t){const n=Number.isFinite(Number(t))?Math.floor(Number(t)):0;return["You are filling spreadsheet cells based on examples.",`Respond in ${e}.`,de,"Return STRICT JSON only (no Markdown, no code fences).",n>0?`Return an object with a single key 'values' containing exactly ${n} strings, in the same order as the target rows.`:"Return an object with a single key 'values' containing an array of strings.","Return only the values, in order, one per target row.","If a value is unknown, return an empty string for that row.","Do not add any keys other than 'values'."].join("\n")}function Te(e){const t=(e||"").toLowerCase().startsWith("fr");return["You are an expert Excel formula generator.","Your goal is to output a VALID Excel formula string based on the user request.","Leverage advanced Excel capabilities (dynamic arrays, LET/LAMBDA, structured references, advanced date/time, lookup, statistics, financial functions) when relevant.",de,`Respond in ${e}.`,t?"Use FRENCH Excel function names (e.g., SOMME, SI, RECHERCHEV...).":"Use ENGLISH Excel function names (e.g., SUM, IF, VLOOKUP...).",t?"Use SEMICOLON (;) as argument separator.":"Use COMMA (,) as argument separator.","Return exactly one ready-to-use Excel formula with no surrounding text.","Return ONLY the formula starting with '='.","No Markdown. No code fences. No explanations."].join("\n")}function Se(e="fr"){return["You are a meticulous fact-finding assistant with access to reliable web knowledge.",de,"Return only one precise, up-to-date factual value plus the best authoritative source URL.","Never fabricate numbers or URLs. Use official or authoritative sources only.","Match the requested timeframe and scope exactly; ignore partial or approximate figures.","If the data cannot be confirmed with high confidence, return empty strings and explain why in a 'reason' field.",`Respond in ${e}.`,"Return STRICT JSON only (no Markdown, no code fences).",'Schema: {"value": "<concise value>", "source": "https://...", "reason": "<why unavailable>"}.',"The value must mirror the source exactly and stay under 80 characters."].join("\n")}async function Oe(){try{const t=await p(),n=await d(),r=await f(e.GEMINI),o=await f(e.OPENAI),i=await h(e.GEMINI);return[`Default provider: ${t}`,`Max output tokens: ${n}`,`Gemini: ${r?"key set":"key missing"} / model: ${i}`,`OpenAI: ${o?"key set":"key missing"} / model: ${await h(e.OPENAI)}`,`Storage: ${s().kind}`].join("\n")}catch(e){return fe(CustomFunctions?.ErrorCode?.notAvailable,e?.message||"Erreur KEY_STATUS.")}}async function ve(){const e=await async function(){const e=l(void 0)||await p(),t=await h(e);return await f(e)?await Q({provider:e,system:"You are a test endpoint. Reply with exactly: OK",user:"OK",maxOutputTokens:500,cache:!1,webSearch:!1,functionName:"AI.MINIMAL_TEST"}):{ok:!1,provider:e,model:t,code:"API_KEY_MISSING",message:`Clé API manquante pour le fournisseur ${e}.`}}();return e.ok?"OK":fe(CustomFunctions?.ErrorCode?.notAvailable,e.message||"Test échoué.")}async function xe(e,t){const n=ce(e).trim();if(!n)return fe(CustomFunctions?.ErrorCode?.invalidValue,"Le paramètre prompt est vide.");const r=null!=t&&ie(t)?le(t):"",o=r?`Contexte (TSV):\n${r}\n\nQuestion:\n${n}`:n,s=await Q({system:ye(se),user:o,webSearch:!1,functionName:"AI.ASK"});if(!s.ok)return fe(CustomFunctions?.ErrorCode?.notAvailable,s.message||"Erreur AI.ASK.");let i=s.text||"";return i=i.replace(/\*\*/g,"").replace(/##/g,"").replace(/__/g,""),ue(i)}async function Ce(e,t,n){const r=ce(e).trim();if(!r)return fe(CustomFunctions?.ErrorCode?.invalidValue,"Le paramètre query est vide.");const o=null!=t&&ie(t)?le(t):"",s=o?`Contexte (TSV):\n${o}\n\nRequête web:\n${r}`:r,i=await Q({system:Se(se),user:s,webSearch:!0,functionName:"AI.WEB"});if(!i.ok)return fe(CustomFunctions?.ErrorCode?.notAvailable,i.message||"Erreur AI.WEB.");let a=i.text||"",c=Array.isArray(i.sources)?i.sources:[],u=a;try{const e=he(a);if(e&&"object"==typeof e){const t=ce(e.value).trim(),n=ce(e.source).trim(),r=ce(e.reason).trim();t?u=t:r&&(u=r),n&&(c=[{title:"",url:n}])}}catch{}const l=1===function(e){const t=Number(e);return Number.isFinite(t)&&1===t?1:0}(n)?u+function(e,t=8){const n=(Array.isArray(e)?e:[]).slice(0,t);if(!n.length)return"";const r=["","Sources:"];let o=1;for(const e of n){const t=(e?.title||"").trim(),n=(e?.url||"").trim();n&&(r.push(`${o}. ${t?t+" - ":""}${n}`),o++)}return r.join("\n")}(c):u;return ue(l)}async function Me(e,t){const n=ce(t).trim();if(!n)return fe(CustomFunctions?.ErrorCode?.invalidValue,"La langue cible est vide.");const r=ae(e),o=me(r,oe+1),s=o.length,i=s>1;if(o.length>oe)return fe(CustomFunctions?.ErrorCode?.invalidValue,`Plage trop grande (max ${oe} cellules) pour AI.TRANSLATE.`);const a=o.map((e,t)=>`${t+1}. ${e}`),c=i?[`Translate each item to: ${n}.`,`Return JSON with items array of length ${s}. Use empty string for empty inputs.`,"",...a].join("\n"):`Translate to ${n}:\n${o[0]||""}`,u=await Q({system:ge(n,s),user:c,responseMimeType:i?"application/json":void 0,responseJsonSchema:i?{type:"object",additionalProperties:!1,required:["items"],properties:{items:{type:"array",items:{type:"string"}}}}:void 0,functionName:"AI.TRANSLATE"});if(!u.ok)return fe(CustomFunctions?.ErrorCode?.notAvailable,u.message||"Erreur AI.TRANSLATE.");let l=[];if(i)try{const e=he(u.text);Array.isArray(e?.items)&&(l=e.items.map(e=>ce(e)))}catch{if(!u.text)return fe(CustomFunctions?.ErrorCode?.invalidValue,"Réponse vide (TRANSLATE).");l=u.text.split("\n").map(e=>e.trim())}else{try{const e=he(u.text);Array.isArray(e?.items)&&(l=e.items.map(e=>ce(e)))}catch{}l.length||(l=[ce(u.text).trim()])}for(;l.length<o.length;)l.push("");l.length>o.length&&(l=l.slice(0,o.length));const m=[];let p=0;for(let e=0;e<r.length;e++){const t=[];for(let n=0;n<(r[e]||[]).length;n++)t.push(ue(l[p++]||""));m.push(t)}return m}async function Re(e,t){const n=function(e){return ie(e)?pe(me(e,2e3).map(e=>e.trim()).filter(Boolean)):pe(ce(e).split(/[,\|;\n\r]+/).map(e=>e.trim()).filter(Boolean))}(t);if(!n.length)return fe(CustomFunctions?.ErrorCode?.invalidValue,"La liste de labels est vide.");const r=ae(e),o=me(r,oe+1),s=o.length,i=s>1;if(o.length>oe)return fe(CustomFunctions?.ErrorCode?.invalidValue,`Plage trop grande (max ${oe} cellules) pour AI.CLASSIFY.`);const a=n.join(" | "),c=o.map((e,t)=>`${t+1}. ${e}`),u=i?["Classify each item into exactly one label from the allowed list.",`Allowed labels: ${a}`,`Return JSON with items array of length ${s}. Use UNKNOWN if unsure.`,"",...c].join("\n"):["Classify the following text into exactly one allowed label.",`Allowed labels: ${a}`,"",o[0]||""].join("\n"),l=await Q({system:Ae(n,se),user:u,responseMimeType:i?"application/json":void 0,responseJsonSchema:i?{type:"object",additionalProperties:!1,required:["items"],properties:{items:{type:"array",items:{type:"string"}}}}:void 0,functionName:"AI.CLASSIFY"});if(!l.ok)return fe(CustomFunctions?.ErrorCode?.notAvailable,l.message||"Erreur AI.CLASSIFY.");let m=[];if(i)try{const e=he(l.text);Array.isArray(e?.items)&&(m=e.items.map(e=>ce(e).trim()))}catch{m=l.text.split("\n").map(e=>e.trim())}else{try{const e=he(l.text);Array.isArray(e?.items)&&(m=e.items.map(e=>ce(e).trim()))}catch{}m.length||(m=[ce(l.text).trim()])}for(;m.length<o.length;)m.push("UNKNOWN");m.length>o.length&&(m=m.slice(0,o.length));const p=new Map(n.map(e=>[e.toLowerCase(),e]));m=m.map(e=>{const t=e.toLowerCase();return p.get(t)||e||"UNKNOWN"});const f=[];let h=0;for(let e=0;e<r.length;e++){const t=[];for(let n=0;n<(r[e]||[]).length;n++)t.push(ue(m[h++]||"UNKNOWN"));f.push(t)}return f}async function be(e,t){const n=ce(t).trim();if(!n)return fe(CustomFunctions?.ErrorCode?.invalidValue,"L'instruction est vide.");const r=ae(e),o=me(r,oe+1);if(o.length>oe)return fe(CustomFunctions?.ErrorCode?.invalidValue,`Plage trop grande (max ${oe} cellules) pour AI.EXTRACT.`);const s={type:"object",additionalProperties:!1,required:["items"],properties:{items:{type:"array",items:{type:"string"}}}};if(1===o.length){const e=[`Instruction: ${n}`,"Input:",o[0]].join("\n\n"),t=await Q({system:Ne(n,se),user:e,responseMimeType:"application/json",responseJsonSchema:s,functionName:"AI.EXTRACT"});if(!t.ok)return fe(CustomFunctions?.ErrorCode?.notAvailable,t.message||"Erreur AI.EXTRACT.");let r=[];try{const e=he(t.text);Array.isArray(e?.items)&&(r=e.items.map(e=>ce(e).trim()).filter(Boolean))}catch{if(r=t.text.split("\n").map(e=>e.trim()).filter(Boolean),0===r.length&&t.text)return fe(CustomFunctions?.ErrorCode?.invalidValue,`JSON Error: ${t.text.slice(0,100)}`)}return r.length?r.map(e=>[ue(e)]):[[""]]}const i=o.map((e,t)=>`${t+1}. ${e}`),a=[`Instruction: ${n}`,`Return JSON with items array of length ${o.length}.`,"Each item must be the best extracted value for the corresponding input (or empty string if none).","",...i].join("\n"),c=await Q({system:Ne(n,se,o.length),user:a,responseMimeType:"application/json",responseJsonSchema:s,functionName:"AI.EXTRACT_BATCH"});if(!c.ok)return fe(CustomFunctions?.ErrorCode?.notAvailable,c.message||"Erreur AI.EXTRACT.");let u=[];try{const e=he(c.text);Array.isArray(e?.items)&&(u=e.items.map(e=>ce(e).trim()))}catch{u=c.text.split("\n").map(e=>e.trim())}for(;u.length<o.length;)u.push("");u.length>o.length&&(u=u.slice(0,o.length));const l=[];let m=0;for(let e=0;e<r.length;e++){const t=[];for(let n=0;n<(r[e]||[]).length;n++)t.push(ue(u[m++]||""));l.push(t)}return l}async function ke(e){const t=ae(e),n=me(t,oe+1),r=n.length,o=r>1;if(n.length>oe)return fe(CustomFunctions?.ErrorCode?.invalidValue,`Plage trop grande (max ${oe} cellules) pour AI.CLEAN.`);const s=n.map((e,t)=>`${t+1}. ${e}`),i=o?["Clean each item for Excel (whitespace, line breaks).",`Return JSON with items array of length ${r}. Use empty string for empty inputs.`,"",...s].join("\n"):`Clean this text for Excel:\n${n[0]||""}`,a=await Q({system:Ee(se,r),user:i,responseMimeType:o?"application/json":void 0,responseJsonSchema:o?{type:"object",additionalProperties:!1,required:["items"],properties:{items:{type:"array",items:{type:"string"}}}}:void 0,functionName:"AI.CLEAN"});if(!a.ok)return fe(CustomFunctions?.ErrorCode?.notAvailable,a.message||"Erreur AI.CLEAN.");let c=[];if(o)try{const e=he(a.text);Array.isArray(e?.items)&&(c=e.items.map(e=>ce(e)))}catch{c=a.text.split("\n").map(e=>e.trim())}else{try{const e=he(a.text);Array.isArray(e?.items)&&(c=e.items.map(e=>ce(e)))}catch{}c.length||(c=[ce(a.text).trim()])}for(;c.length<n.length;)c.push("");c.length>n.length&&(c=c.slice(0,n.length));const u=[];let l=0;for(let e=0;e<t.length;e++){const n=[];for(let r=0;r<(t[e]||[]).length;r++)n.push(ue(c[l++]||""));u.push(n)}return u}async function Pe(e){const t=ae(e),n=me(t,oe+1),r=n.length;if(n.length>oe)return fe(CustomFunctions?.ErrorCode?.invalidValue,`Plage trop grande (max ${oe} cellules) pour AI.CONSISTENT.`);const o=["Normalize each item so that near-duplicates become identical.",`Return JSON with items array of length ${r}.`,"",...n.map((e,t)=>`${t+1}. ${e}`)].join("\n"),s=await Q({system:Ie(se,r),user:o,responseMimeType:"application/json",responseJsonSchema:{type:"object",additionalProperties:!1,required:["items"],properties:{items:{type:"array",items:{type:"string"}}}},functionName:"AI.CONSISTENT"});if(!s.ok)return fe(CustomFunctions?.ErrorCode?.notAvailable,s.message||"Erreur AI.CONSISTENT.");let i=[];try{const e=he(s.text);Array.isArray(e?.items)&&(i=e.items.map(e=>ce(e)))}catch{i=s.text.split("\n").map(e=>e.trim())}for(;i.length<n.length;)i.push("");i.length>n.length&&(i=i.slice(0,n.length));const a=[];let c=0;for(let e=0;e<t.length;e++){const n=[];for(let r=0;r<(t[e]||[]).length;r++)n.push(ue(i[c++]||""));a.push(n)}return a}async function Le(e,t){const n=ce(e).trim();if(!n)return fe(CustomFunctions?.ErrorCode?.invalidValue,"La description est vide.");const r=null!=t&&ie(t)?le(t):"",o=r?`Contexte (TSV):\n${r}\n\nDescription:\n${n}`:n,s=(a=function(){try{if("undefined"!=typeof Office&&Office?.context){const e=Office.context.displayLanguage||Office.context.contentLanguage;if(e)return String(e)}}catch{}try{if("undefined"!=typeof navigator&&navigator?.language)return String(navigator.language)}catch{}return se}(),String(a||"").toLowerCase().startsWith("fr")?"fr":"en"),i=await Q({system:Te(s),user:o,webSearch:!1,functionName:"AI.FORMULA"});var a;if(!i.ok)return fe(CustomFunctions?.ErrorCode?.notAvailable,i.message||"Erreur AI.FORMULA.");const c=(i.text||"").trim(),u=c.match(/=[^\n\r]+/),l=(u?u[0]:c).trim();return l.startsWith("=")?ue(l):fe(CustomFunctions?.ErrorCode?.notAvailable,"La réponse n'est pas une formule Excel valide.")}async function $e(e,t){const n=ce(e).trim();if(!n)return fe(CustomFunctions?.ErrorCode?.invalidValue,"La description est vide.");const r=null!=t&&ie(t)?le(t):"",o=["Build a table for Excel based on the description and optional context.","Return JSON { headers: [...], rows: [[...], ...] }",r?`\nContext (TSV):\n${r}`:"",`\nDescription:\n${n}`].join("\n"),s=await Q({system:["You generate tables for Excel.",de,"Return JSON that matches the provided schema.","Do not include any extra keys.","Use strings for all cell values."].join(" "),user:o,responseMimeType:"application/json",responseJsonSchema:{type:"object",additionalProperties:!1,required:["headers","rows"],properties:{headers:{type:"array",items:{type:"string"}},rows:{type:"array",items:{type:"array",items:{type:"string"}}}}},functionName:"AI.TABLE"});if(!s.ok)return fe(CustomFunctions?.ErrorCode?.notAvailable,s.message||"Erreur AI.TABLE.");let i=null;try{i=he(s.text)}catch{try{const e=s.text.match(/\{[\s\S]*\}/);if(!e)throw new Error;i=JSON.parse(e[0])}catch{return fe(CustomFunctions?.ErrorCode?.notAvailable,"Impossible de parser le JSON renvoyé par l'IA.")}}const a=Array.isArray(i?.headers)?i.headers.map(e=>ue(ce(e))):[],c=Array.isArray(i?.rows)?i.rows:[],u=a.length||(Array.isArray(c?.[0])?c[0].length:0)||1,l=a.length?a:Array.from({length:u},(e,t)=>`Col${t+1}`),m=[l];for(const e of c){const t=Array.isArray(e)?e.map(e=>ue(ce(e))):[];for(;t.length<l.length;)t.push("");t.length>l.length&&(t.length=l.length),m.push(t)}return m}async function Fe(e,t,n){const r=ce(n).trim();if(!r)return fe(CustomFunctions?.ErrorCode?.invalidValue,"L'instruction est vide.");const o=ae(e),s=ae(t),i=s.length;if(i<=0)return[[""]];if(i>oe)return fe(CustomFunctions?.ErrorCode?.invalidValue,`Plage cible trop grande (max ${oe} lignes) pour AI.FILL.`);const a=[`Instruction: ${r}`,"","Examples (TSV):",le(o,6e3),"","Target rows (TSV):",le(s,6e3),"",`Return JSON with values array of length ${i} (one value per target row).`].join("\n"),c=await Q({system:_e(se,i),user:a,responseMimeType:"application/json",responseJsonSchema:{type:"object",additionalProperties:!1,required:["values"],properties:{values:{type:"array",items:{type:"string"}}}},functionName:"AI.FILL"});if(!c.ok)return fe(CustomFunctions?.ErrorCode?.notAvailable,c.message||"Erreur AI.FILL.");let u=[];try{const e=JSON.parse(c.text);Array.isArray(e?.values)&&(u=e.values.map(e=>ce(e)))}catch{u=c.text.split("\n").map(e=>e.trim())}for(;u.length<i;)u.push("");return u.length>i&&(u=u.slice(0,i)),u.map(e=>[ue(e)])}async function je(e,t){const n=function(e){const t=Number(e);return Number.isFinite(t)&&1===t?1:0}(t),r=ae(e);if(1===n){const e=me(r,2e3).map(e=>e.trim()).filter(Boolean);if(!e.length)return[[""]];const t=`Content:\n${e.join("\n")}`,n=await Q({system:we(se),user:t,webSearch:!1,functionName:"AI.SUMMARIZE"});return n.ok?[[ue(n.text)]]:fe(CustomFunctions?.ErrorCode?.notAvailable,n.message||"Erreur AI.SUMMARIZE.")}const o=me(r,2e3).map(e=>e.trim()),s=o.length,i=s>1;if(!s)return[[""]];const a=o.map((e,t)=>`${t+1}. ${e}`),c=i?["Summarize each item for Excel.",`Return JSON with items array of length ${s}. Use empty string for empty inputs.`,"",...a].join("\n"):`Summarize for Excel:\n${o[0]||""}`,u=await Q({system:we(se,s),user:c,responseMimeType:i?"application/json":void 0,responseJsonSchema:i?{type:"object",additionalProperties:!1,required:["items"],properties:{items:{type:"array",items:{type:"string"}}}}:void 0,functionName:"AI.SUMMARIZE"});if(!u.ok)return fe(CustomFunctions?.ErrorCode?.notAvailable,u.message||"Erreur AI.SUMMARIZE.");let l=[];if(i)try{const e=he(u.text);Array.isArray(e?.items)&&(l=e.items.map(e=>ce(e)))}catch{l=u.text.split("\n").map(e=>e.trim())}else{try{const e=he(u.text);Array.isArray(e?.items)&&(l=e.items.map(e=>ce(e)))}catch{}l.length||(l=[ce(u.text).trim()])}for(;l.length<o.length;)l.push("");l.length>o.length&&(l=l.slice(0,o.length));const m=[];let p=0;for(let e=0;e<r.length;e++){const t=[];for(let n=0;n<(r[e]||[]).length;n++)t.push(ue(l[p++]||""));m.push(t)}return m}function Ue(e,t){try{const n=ae(e),r=ce(t).toLowerCase();let o=0;for(const e of n){const t=Array.isArray(e)?e:[e];for(const e of t)ce(e).toLowerCase()===r&&o++}return o}catch(e){return fe(CustomFunctions?.ErrorCode?.invalidValue,e?.message||"Erreur AI.COUNT.")}}const Ve=setInterval(()=>{(function(){try{if("undefined"==typeof CustomFunctions||!CustomFunctions?.associate)return!1;const e=(e,t)=>{try{return CustomFunctions.associate(e,t),!0}catch{return!1}};let t=!0;return t=e("AI.KEYSTATUS",Oe)&&t,t=e("AI.TEST",ve)&&t,t=e("AI.ASK",xe)&&t,t=e("AI.WEB",Ce)&&t,t=e("AI.TRANSLATE",Me)&&t,t=e("AI.CLASSIFY",Re)&&t,t=e("AI.EXTRACT",be)&&t,t=e("AI.CLEAN",ke)&&t,t=e("AI.CONSISTENT",Pe)&&t,t=e("AI.FORMULA",Le)&&t,t=e("AI.TABLE",$e)&&t,t=e("AI.FILL",Fe)&&t,t=e("AI.SUMMARIZE",je)&&t,t=e("AI.COUNT",Ue)&&t,t}catch{return!1}})()&&clearInterval(Ve)},200)})();
//# sourceMappingURL=functions.js.map