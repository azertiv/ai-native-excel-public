(()=>{"use strict";const e=Object.freeze({GEMINI:"gemini",OPENAI:"openai"}),t=Object.freeze({provider:e.GEMINI,geminiModel:"gemini-3-flash-preview",openaiModel:"gpt-5-mini",geminiReasoningEffort:"minimal",openaiReasoningEffort:"low",maxOutputTokens:4096,concurrencyLimit:4,rpmLimit:0,retry:2,timeoutMs:12e4,cache:!0,cacheTtlSec:604800}),n=Object.freeze({DEFAULT_PROVIDER:"AI_DEFAULT_PROVIDER_V3",GEMINI_API_KEY:"AI_GEMINI_API_KEY_V3",OPENAI_API_KEY:"AI_OPENAI_API_KEY_V3",GEMINI_MODEL:"AI_GEMINI_MODEL_V3",OPENAI_MODEL:"AI_OPENAI_MODEL_V3",GEMINI_REASONING_EFFORT:"AI_GEMINI_REASONING_EFFORT_V3",OPENAI_REASONING_EFFORT:"AI_OPENAI_REASONING_EFFORT_V3",MAX_OUTPUT_TOKENS:"AI_MAX_OUTPUT_TOKENS_V3",CONCURRENCY_LIMIT:"AI_CONCURRENCY_LIMIT_V1",RPM_LIMIT:"AI_RPM_LIMIT_V1",ONBOARDING_SEEN:"AI_ONBOARDING_SEEN_V1",ONBOARDING_KEYS_CONFIRMED:"AI_ONBOARDING_KEYS_CONFIRMED_V1",SECTION_ORDER:"AI_SECTION_ORDER_V1",SECTION_HIDDEN:"AI_SECTION_HIDDEN_V1",LICENSE:"AI_LICENSE_V1",PRIVACY_MODE:"AI_PRIVACY_MODE_V1",MIGRATION_DONE:"AI_MIGRATION_DONE_V3",REQUEST_LOG:"AI_REQUEST_LOG_V1",REQUEST_LOG_CLEAR_AT:"AI_REQUEST_LOG_CLEAR_AT_V1",USAGE_TOTALS:"AI_USAGE_TOTALS_V1",CACHE_INDEX:"AI_CACHE_INDEX_V1",CACHE_CLEAR_AT:"AI_CACHE_CLEAR_AT_V1",RUNTIME_STATUS:"AI_RUNTIME_STATUS_V1"}),r=new Set([n.GEMINI_API_KEY,n.OPENAI_API_KEY,n.LICENSE]),o=Object.freeze({GEMINI_API_KEY:"GEMINI_API_KEY",MAX_OUTPUT_TOKENS:"MAX_OUTPUT_TOKENS",DEFAULT_PROVIDER_V2:"AI_DEFAULT_PROVIDER_V2",GEMINI_API_KEY_V2:"AI_GEMINI_API_KEY_V2",OPENAI_API_KEY_V2:"AI_OPENAI_API_KEY_V2",GEMINI_MODEL_V2:"AI_GEMINI_MODEL_V2",OPENAI_MODEL_V2:"AI_OPENAI_MODEL_V2",GEMINI_MAX_TOKENS_V2:"AI_GEMINI_MAX_OUTPUT_TOKENS_V2",OPENAI_MAX_TOKENS_V2:"AI_OPENAI_MAX_OUTPUT_TOKENS_V2"});let s=null,i=!1,a=null,u=0;const c=1500;let l=null,m=0,f=null,p=0,h=null,d=0,g=null,y=0;const I={gemini:null,openai:null},A={gemini:0,openai:0},T={gemini:null,openai:null},E={gemini:0,openai:0};function k(){i=!0}const N={kind:"memory",storage:(()=>{const e=new Map;return{getItem:async t=>e.has(t)?e.get(t):null,async setItem(t,n){e.set(t,String(n))},async removeItem(t){e.delete(t)}}})()};function S(){if(!i)try{if("undefined"!=typeof OfficeRuntime&&OfficeRuntime?.storage?.getItem)return{kind:"office",storage:OfficeRuntime.storage}}catch{}try{if("undefined"!=typeof window&&window?.localStorage?.getItem)return{kind:"local",storage:window.localStorage}}catch{}return N}function _(){try{if("undefined"!=typeof window&&window?.localStorage?.getItem)return window.localStorage}catch{return null}return null}function w(e,t){try{return e.getItem(t)}catch{return null}}function b(e,t,n){try{return e.setItem(t,n),!0}catch{return!1}}function M(e,t){try{return e.removeItem(t),!0}catch{return!1}}async function O(e,t={}){const{kind:n,storage:o}=S(),s=t.sensitive??function(e){return r.has(e)}(e),a=!1!==t.allowLocalFallback;if("local"===n)return w(o,e);if("office"===n){let t=null;try{t=await o.getItem(e)}catch{k()}if(null!=t){if(s){const t=_();t&&M(t,e)}return t}if(!a)return null;const n=_();if(!n)return null;const r=w(n,e);if(null==r)return null;if(!i)try{await o.setItem(e,String(r)),M(n,e)}catch{k()}return r}try{return await o.getItem(e)}catch{return null}}async function C(e,t,n={}){const{kind:r,storage:o}=S(),s=null==t?"":String(t),i=!1!==n.allowLocalFallback;if("local"!==r){if("office"===r){let t=!1;try{await o.setItem(e,s),t=!0}catch{k()}const n=_();if(t)return void(n&&M(n,e));if(!i||!n)return;return void b(n,e,s)}try{await o.setItem(e,s)}catch{}}else b(o,e,s)}async function x(){if(s)return s;s=(async()=>{if("1"!==await O(n.MIGRATION_DONE)){if(!v(await O(n.DEFAULT_PROVIDER))){const e=v(await O(o.DEFAULT_PROVIDER_V2));await C(n.DEFAULT_PROVIDER,e||t.provider)}if(!await O(n.GEMINI_API_KEY)){const e=await O(o.GEMINI_API_KEY_V2)||await O(o.GEMINI_API_KEY);e&&await C(n.GEMINI_API_KEY,e)}if(!await O(n.OPENAI_API_KEY)){const e=await O(o.OPENAI_API_KEY_V2);e&&await C(n.OPENAI_API_KEY,e)}if(!await O(n.GEMINI_MODEL)){const e=await O(o.GEMINI_MODEL_V2);await C(n.GEMINI_MODEL,e||t.geminiModel)}if(!await O(n.OPENAI_MODEL)){const e=await O(o.OPENAI_MODEL_V2);await C(n.OPENAI_MODEL,e||t.openaiModel)}if(!await O(n.MAX_OUTPUT_TOKENS)){const e=[await O(o.MAX_OUTPUT_TOKENS),await O(o.GEMINI_MAX_TOKENS_V2),await O(o.OPENAI_MAX_TOKENS_V2)].map(e=>parseInt(String(e||"").trim(),10)).filter(e=>Number.isFinite(e)&&e>0),r=e.length?Math.max(...e):t.maxOutputTokens;await C(n.MAX_OUTPUT_TOKENS,String(r))}await C(n.MIGRATION_DONE,"1")}})();try{await s}finally{s=null}}function v(t){if(!t)return"";const n=String(t).trim().toLowerCase();return n===e.GEMINI?e.GEMINI:n===e.OPENAI?e.OPENAI:"google"===n||"gem"===n?e.GEMINI:"oai"===n||"chatgpt"===n?e.OPENAI:""}const R=new Set(["auto","minimal","low","medium","high"]),L=new Set(["none","minimal","low","medium","high"]);async function P(){const e=K();if(l&&e-m<c)return l;await x();const r=v(await O(n.DEFAULT_PROVIDER))||t.provider;return l=r,m=e,r}async function j(t){const r=v(t)===e.OPENAI?e.OPENAI:e.GEMINI,o=K();if(null!=I[r]&&o-A[r]<c)return(I[r]||"").trim();await x();const s=await O(function(t){return v(t)===e.OPENAI?n.OPENAI_API_KEY:n.GEMINI_API_KEY}(r))||"",i=String(s).trim();return I[r]=i,A[r]=o,i}async function F(r){const o=v(r)===e.OPENAI?e.OPENAI:e.GEMINI,s=K(),i=T[o];if(i&&s-E[o]<c)return i;await x();const a=await O(function(t){return v(t)===e.OPENAI?n.OPENAI_MODEL:n.GEMINI_MODEL}(o)),u=a&&String(a).trim()?String(a).trim():o===e.OPENAI?t.openaiModel:t.geminiModel;return T[o]=u,E[o]=s,u}async function $(){const e=K();if(f&&e-p<c)return f;await x();const r=await O(n.MAX_OUTPUT_TOKENS),o=Y(parseInt(String(r||"").trim(),10),1,128e3,t.maxOutputTokens);return f=o,p=e,o}const U=[4,8,16,32,64,128];async function V(e){const t=(r=e)&&"object"==typeof r?{active:Y(r.active,0,1e5,0),queued:Y(r.queued,0,1e5,0),rpm:Y(r.rpm,0,1e6,0),ts:Y(r.ts,0,Number.MAX_SAFE_INTEGER,0)}:{active:0,queued:0,rpm:0,ts:0};var r;return await C(n.RUNTIME_STATUS,JSON.stringify(t)),t}async function G(){return await async function(){const e=K();if(null!=a&&e-u<2e3)return a;const t="1"===await O(n.PRIVACY_MODE);return a=t,u=e,t}()}function K(){return Date.now()}function D(e){return new Promise(t=>setTimeout(t,e))}function Y(e,t,n,r=t){const o=parseInt(String(e),10);return Number.isFinite(o)?Math.max(t,Math.min(n,o)):r}const q=[/\bsk-[A-Za-z0-9-_]{1,}\b/gi,/\bAIza[0-9A-Za-z_-]{1,}\b/gi,/\b[A-Z0-9]{4}(?:-[A-Z0-9]{4}){1,3}\b/gi];function H(e){if(null==e)return"";let t=String(e);for(const e of q)t=t.replace(e,"[REDACTED]");return t}function J(e){if(null==e)return e;if("string"==typeof e)return H(e);if(Array.isArray(e))return e.map(J);if("object"==typeof e){const t={};for(const[n,r]of Object.entries(e))t[n]=J(r);return t}return e}function B(e){const t=parseInt(String(e||"").trim(),10);return Number.isFinite(t)&&t>0?t:0}const X="AI_CACHE_ENTRY_V1:",z=5242880;let Q=0;async function W(){const e=B(await O(n.CACHE_CLEAR_AT));return e>Q&&(Q=e),Q}async function Z(){const e=await O(n.CACHE_INDEX);if(!e)return[];try{const t=JSON.parse(e);return Array.isArray(t)?t:[]}catch{return[]}}async function ee(e){try{await C(n.CACHE_INDEX,JSON.stringify(e))}catch{}}async function te(e){e&&await async function(e){const{kind:t,storage:n}=S();if("local"!==t){if("office"===t){let t=!1;try{await n.removeItem(e),t=!0}catch{k()}const r=_();return void(r&&M(r,e))}try{await n.removeItem(e)}catch{}}else M(n,e)}(X+e)}async function ne(e){const t=await Z(),n=(t||[]).filter(t=>t?.key!==e);n.length!==t.length&&await ee(n)}async function re(e,t,n,r={}){if(!e)return;if(await G())return;const o=K(),s=await W(),i=s&&o<=s?s+1:o,a="number"==typeof n&&n>0?i+n:null,u={v:1,savedAtMs:i,expiresAtMs:a,value:t},c=JSON.stringify(u),l=function(e){if("string"!=typeof e)return 0;try{if("undefined"!=typeof TextEncoder)return(new TextEncoder).encode(e).length}catch{}return e.length}(c);if(l>z)return await te(e),void await ne(e);await C(X+e,c);const m=await Z(),f=r.provider||t?.provider||"",p=r.model||t?.model||"";let h=!1;const d=(m||[]).map(t=>t?.key!==e?t:(h=!0,{key:e,provider:f,model:p,size:l,savedAtMs:i,expiresAtMs:a}));h||d.push({key:e,provider:f,model:p,size:l,savedAtMs:i,expiresAtMs:a});const g=function(e,t=0){const n=K(),r=[],o=[];for(const s of e||[]){if(!s||!s.key)continue;const e=Number(s.savedAtMs||0);t&&(!Number.isFinite(e)||e<=t)||s.expiresAtMs&&s.expiresAtMs<=n?o.push(s.key):r.push(s)}let s=0;for(const e of r)s+=Number(e?.size||0);if(r.length>5e3||s>z){r.sort((e,t)=>(e.savedAtMs||0)-(t.savedAtMs||0));let e=0;for(;r.length-e>5e3||s>z;){const t=r[e];if(!t)break;o.push(t.key),s-=Number(t?.size||0),e+=1}return{list:r.slice(e),removedKeys:o}}return{list:r,removedKeys:o}}(d,s);for(const e of g.removedKeys)await te(e);await ee(g.list)}function oe(e){if(Array.isArray(e))return e.map(oe);if(t=e,"[object Object]"===Object.prototype.toString.call(t)){const t={};for(const n of Object.keys(e).sort())t[n]=oe(e[n]);return t}var t;return e}async function se(e){const t="string"==typeof e?e:(n=e,JSON.stringify(oe(n)));var n;try{if("undefined"!=typeof crypto&&crypto?.subtle?.digest&&"undefined"!=typeof TextEncoder){const e=(new TextEncoder).encode(t),n=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(n)).map(e=>e.toString(16).padStart(2,"0")).join("")}}catch{}return`fnv1a:${function(e){let t=2166136261;for(let n=0;n<e.length;n++)t^=e.charCodeAt(n),t=Math.imul(t,16777619);return(t>>>0).toString(16).padStart(8,"0")}(t)}`}const ie=1/0;let ae=[],ue=null,ce=!1,le=0,me=0,fe=[],pe=null,he=null,de=_e(),ge=null,ye=!1,Ie=0,Ae=!1;async function Te(e={}){const t=B(await O(n.REQUEST_LOG_CLEAR_AT));return t>me&&(me=t,ae=[],e.reset?(ce=!0,ue=null,le=K()):ce=!1),me}function Ee(e){return!!e&&!1===e.ok}function ke(){const e=K(),t=me||0,n=(ae||[]).filter(n=>n&&"number"==typeof n.ts&&n.ts>t&&e-n.ts<=ie),r=[],o=[];for(const e of n)Ee(e)?o.push(e):r.push(e);r.sort((e,t)=>e.ts-t.ts),o.sort((e,t)=>e.ts-t.ts);const s=r.slice(-50).concat(o.slice(-50));s.sort((e,t)=>e.ts-t.ts),ae=s}function Ne(e){const t=Number(e);return!Number.isFinite(t)||t<=0?0:Math.floor(t)}function Se(e){const t=Number(e);return!Number.isFinite(t)||t<=0?0:t}function _e(){return{inputTokens:0,outputTokens:0,reasoningTokens:0,cachedInputTokens:0,cacheStorageTokenHours:0,requests:0,batchApplied:{},byProvider:{[e.GEMINI]:{inputTokens:0,outputTokens:0,reasoningTokens:0,cachedInputTokens:0,cacheStorageTokenHours:0,requests:0,models:{}},[e.OPENAI]:{inputTokens:0,outputTokens:0,reasoningTokens:0,cachedInputTokens:0,cacheStorageTokenHours:0,requests:0,models:{}}}}}function we(e){if(!e||"object"!=typeof e)return{};const t=K(),n=Object.entries(e).filter(([,e])=>e&&"object"==typeof e).filter(([,e])=>{const n=Number(e.ts)||0;return!n||t-n<=864e5}).sort((e,t)=>(Number(e[1].ts)||0)-(Number(t[1].ts)||0)).slice(-80),r={};for(const[e,t]of n)r[e]=t;return r}async function be(t=!1){if(ge)return ge;ge=(async()=>{if(await G())return!t&&ye||(ye=!0,Ie=K()),de;if(!t&&ye)return de;const r=await O(n.USAGE_TOTALS);let o=null;if(r)try{o=JSON.parse(r)}catch{o=null}return de=function(t){const n=_e();if(!t||"object"!=typeof t)return n;n.inputTokens=Ne(t.inputTokens),n.outputTokens=Ne(t.outputTokens),n.reasoningTokens=Ne(t.reasoningTokens),n.cachedInputTokens=Ne(t.cachedInputTokens),n.cacheStorageTokenHours=Se(t.cacheStorageTokenHours),n.requests=Ne(t.requests),n.batchApplied=function(t){if(!t||"object"!=typeof t)return{};const n={};for(const[r,o]of Object.entries(t)){if(!o||"object"!=typeof o)continue;const t=o.models&&"object"==typeof o.models?o.models:{},s={};for(const[n,r]of Object.entries(t)){if(!r||"object"!=typeof r)continue;const t=String(r.provider||"").toLowerCase();if(t!==e.GEMINI&&t!==e.OPENAI)continue;const o=String(r.modelKey||r.model||n||"").toLowerCase();o&&(s[n]={provider:t,modelKey:o,label:"string"==typeof r.label?r.label:"",inputTokens:Ne(r.inputTokens),outputTokens:Ne(r.outputTokens),reasoningTokens:Ne(r.reasoningTokens),cachedInputTokens:Ne(r.cachedInputTokens),cacheStorageTokenHours:Se(r.cacheStorageTokenHours),requests:Ne(r.requests)})}n[r]={ts:Number(o.ts)||0,models:s}}return we(n)}(t.batchApplied);const r=t.byProvider&&"object"==typeof t.byProvider?t.byProvider:{};for(const t of[e.GEMINI,e.OPENAI]){const e=r[t];if(!e||"object"!=typeof e)continue;const o=n.byProvider[t];o.inputTokens=Ne(e.inputTokens),o.outputTokens=Ne(e.outputTokens),o.reasoningTokens=Ne(e.reasoningTokens),o.cachedInputTokens=Ne(e.cachedInputTokens),o.cacheStorageTokenHours=Se(e.cacheStorageTokenHours),o.requests=Ne(e.requests);const s=e.models&&"object"==typeof e.models?e.models:{};for(const[e,t]of Object.entries(s)){if(!t||"object"!=typeof t)continue;const n="string"==typeof t.label?t.label:String(e||""),r=String(e||n||"").toLowerCase();r&&(o.models[r]={label:n,inputTokens:Ne(t.inputTokens),outputTokens:Ne(t.outputTokens),reasoningTokens:Ne(t.reasoningTokens),cachedInputTokens:Ne(t.cachedInputTokens),cacheStorageTokenHours:Se(t.cacheStorageTokenHours),requests:Ne(t.requests)})}}return n}(o),ye=!0,Ie=K(),de})();try{return await ge}finally{ge=null}}function Me(t){if(!t||"object"!=typeof t)return!1;if(t.batch&&Array.isArray(t.batchModels)){const n=t.batchId?String(t.batchId):"",r=K(),o={};for(const n of t.batchModels){if(!n||"object"!=typeof n)continue;const t=String(n.provider||"").toLowerCase();if(t!==e.GEMINI&&t!==e.OPENAI)continue;const r=String(n.model||"").trim(),s=(r||"unknown").toLowerCase(),i=`${t}|${s}`,a=o[i]||{provider:t,modelKey:s,label:r,inputTokens:0,outputTokens:0,reasoningTokens:0,cachedInputTokens:0,cacheStorageTokenHours:0,requests:0};a.inputTokens+=Ne(n.inputTokens),a.outputTokens+=Ne(n.outputTokens),a.reasoningTokens+=Ne(n.reasoningTokens),a.cachedInputTokens+=Ne(n.cachedInputTokens),a.cacheStorageTokenHours+=Se(n.cacheStorageTokenHours),a.requests+=Ne(n.requests),!a.label&&r&&(a.label=r),o[i]=a}if(!n){let e=!1;for(const t of Object.values(o))Ce(t.provider,t.modelKey,t.label,t)&&(e=!0);return e}const s=de.batchApplied||{},i=s[n]?.models||{},a=new Set([...Object.keys(i),...Object.keys(o)]);let u=!1;for(const t of a){const n=o[t]||null,r=i[t]||null;if(!n&&!r)continue;const s=(n?.provider||r?.provider||"").toLowerCase(),a=(n?.modelKey||r?.modelKey||"").toLowerCase();if(s!==e.GEMINI&&s!==e.OPENAI)continue;if(!a)continue;const c={inputTokens:(n?.inputTokens||0)-(r?.inputTokens||0),outputTokens:(n?.outputTokens||0)-(r?.outputTokens||0),reasoningTokens:(n?.reasoningTokens||0)-(r?.reasoningTokens||0),cachedInputTokens:(n?.cachedInputTokens||0)-(r?.cachedInputTokens||0),cacheStorageTokenHours:(n?.cacheStorageTokenHours||0)-(r?.cacheStorageTokenHours||0),requests:(n?.requests||0)-(r?.requests||0),label:n?.label||r?.label||""};Oe(c)&&Ce(s,a,c.label,c)&&(u=!0)}return s[n]={ts:Number(t.ts)||r,models:o},de.batchApplied=we(s),u}const n=Ne(t.inputTokens),r=Ne(t.outputTokens),o=Ne(t.reasoningTokens),s=Ne(t.cachedInputTokens),i=Se(t.cacheStorageTokenHours);if(!(n+r+o+s>0||i>0))return!1;const a=String(t.provider||"").toLowerCase();if(a!==e.GEMINI&&a!==e.OPENAI)return!1;const u=String(t.model||"").trim();return Ce(a,(u||"unknown").toLowerCase(),u,{inputTokens:n,outputTokens:r,reasoningTokens:o,cachedInputTokens:s,cacheStorageTokenHours:i,requests:1})}function Oe(e){return 0!==Number(e?.inputTokens||0)||0!==Number(e?.outputTokens||0)||0!==Number(e?.reasoningTokens||0)||0!==Number(e?.cachedInputTokens||0)||0!==Number(e?.cacheStorageTokenHours||0)||0!==Number(e?.requests||0)}function Ce(e,t,n,r){if(!r)return!1;const o=Number(r.inputTokens||0),s=Number(r.outputTokens||0),i=Number(r.reasoningTokens||0),a=Number(r.cachedInputTokens||0),u=Number(r.cacheStorageTokenHours||0),c=Number(r.requests||0);if(!(o||s||i||a||u||c))return!1;de.inputTokens=Math.max(0,de.inputTokens+o),de.outputTokens=Math.max(0,de.outputTokens+s),de.reasoningTokens=Math.max(0,de.reasoningTokens+i),de.cachedInputTokens=Math.max(0,de.cachedInputTokens+a),de.cacheStorageTokenHours=Math.max(0,de.cacheStorageTokenHours+u),de.requests=Math.max(0,de.requests+c);const l=de.byProvider[e];l.inputTokens=Math.max(0,l.inputTokens+o),l.outputTokens=Math.max(0,l.outputTokens+s),l.reasoningTokens=Math.max(0,l.reasoningTokens+i),l.cachedInputTokens=Math.max(0,l.cachedInputTokens+a),l.cacheStorageTokenHours=Math.max(0,l.cacheStorageTokenHours+u),l.requests=Math.max(0,l.requests+c);const m=l.models||{},f=m[t]||{label:n,inputTokens:0,outputTokens:0,reasoningTokens:0,cachedInputTokens:0,cacheStorageTokenHours:0,requests:0};return!f.label&&n&&(f.label=n),f.inputTokens=Math.max(0,f.inputTokens+o),f.outputTokens=Math.max(0,f.outputTokens+s),f.reasoningTokens=Math.max(0,f.reasoningTokens+i),f.cachedInputTokens=Math.max(0,f.cachedInputTokens+a),f.cacheStorageTokenHours=Math.max(0,f.cacheStorageTokenHours+u),f.requests=Math.max(0,f.requests+c),m[t]=f,l.models=m,!0}function xe(e){if(!e||"object"!=typeof e)return;const t=Re({ts:K(),...e});if(t.batch&&t.batchId){let e=!1;for(let n=fe.length-1;n>=0;n-=1){const r=fe[n];if(r&&r.batch&&r.batchId===t.batchId){fe[n]=t,e=!0;break}}e||fe.push(t)}else fe.push(t);fe.length>=80?ve():pe||(pe=setTimeout(()=>{pe=null,ve()},500))}async function ve(){if(he)return he;if(fe.length){he=(async()=>{try{const e=fe;if(fe=[],!e.length)return;await be();let t=!1;for(const n of e)Me(n)&&(t=!0);if(t&&(Ie=K(),Ae=!0),await G())return ae.push(...e),ke(),ce=!0,void(le=K());await Te({reset:!0}),ce||await async function(e=!1){if(ue)return ue;ue=(async()=>{if(await G())return!e&&ce||(ce=!0,le=K()),ae;const t=await Te();if(!e&&ce)return ae;const r=await O(n.REQUEST_LOG);let o=[];if(r)try{o=function(e){if(Array.isArray(e))return e;if(e&&"object"==typeof e){const t=Array.isArray(e.normal)?e.normal:[],n=Array.isArray(e.errors)?e.errors:[];return t.concat(n)}return[]}(JSON.parse(r))}catch{o=[]}const s=K();return o=o.map(e=>{if(!e)return null;let t=e.ts;if("string"==typeof t){const e=Date.parse(t);Number.isFinite(e)&&(t=e)}return"number"!=typeof t?null:{...e,ts:t}}).filter(e=>e&&"number"==typeof e.ts&&e.ts>t&&s-e.ts<=ie).map(e=>Re(e)),ae=o,ke(),ce=!0,le=K(),ae})();try{return await ue}finally{ue=null}}();for(const t of e)if(t?.batch&&t?.batchId){const e=ae.findIndex(e=>e?.batch&&e?.batchId===t.batchId);e>=0?ae[e]=t:ae.push(t)}else ae.push(t);ke(),le=K(),await async function(){try{if(await G())return;ke(),await C(n.REQUEST_LOG,JSON.stringify(ae.slice(-100)))}catch{}}(),Ae&&(await async function(){try{if(await G())return;await C(n.USAGE_TOTALS,JSON.stringify(de))}catch{}}(),Ae=!1)}catch{}})();try{await he}finally{he=null}}}function Re(e){return e&&"object"==typeof e?J(e):e}const Le=new class{constructor(e=500){this.maxEntries=e,this.map=new Map}get(e){if(!this.map.has(e))return null;const t=this.map.get(e);return t?.expiresAtMs&&t.expiresAtMs<=K()?(this.map.delete(e),null):(this.map.delete(e),this.map.set(e,t),t.value)}set(e,t,n){const r="number"==typeof n&&n>0?K()+n:null;for(this.map.has(e)&&this.map.delete(e),this.map.set(e,{value:t,expiresAtMs:r});this.map.size>this.maxEntries;){const e=this.map.keys().next().value;this.map.delete(e)}}clear(){this.map.clear()}}(800);let Pe=0;const je=new Map,Fe=9e5,$e=new Map,Ue=new Map,Ve=Symbol("queue_cancelled"),Ge={ok:!1,code:"QUEUE_CANCELLED",message:"File d'attente arrêtée."};let Ke=t.concurrencyLimit,De=0,Ye=t.rpmLimit,qe=0,He=[],Je=Promise.resolve(),Be=null,Xe=0;const ze=new class{constructor(){this._items=[],this._head=0}get length(){return this._items.length-this._head}push(e){this._items.push(e)}shift(){if(this._head>=this._items.length)return;const e=this._items[this._head++];return this._head>1024&&2*this._head>this._items.length&&(this._items=this._items.slice(this._head),this._head=0),e}drain(){const e=this._items.slice(this._head);return this._items=[],this._head=0,e}};let Qe=null,We=null,Ze="";const et=Number.POSITIVE_INFINITY;let tt=null;function nt(){return Xe+ze.length}function rt(){return!!tt||!(nt()<et)&&(tt=function(){const e=K();return{id:`batch_${e}_${Math.random().toString(36).slice(2,8)}`,startedAt:e,endedAt:0,totalRequests:0,okCount:0,errorCount:0,cachedCount:0,inputTokens:0,outputTokens:0,reasoningTokens:0,cachedInputTokens:0,msSum:0,msMax:0,msMin:0,peakQueued:0,peakActive:0,models:new Map,lastLogAt:0}}(),!0)}function ot(){tt&&(tt.peakQueued=Math.max(tt.peakQueued,ze.length),tt.peakActive=Math.max(tt.peakActive,Xe))}function st({provider:e,model:t,ok:n,cached:r,usage:o,ms:s,cacheAdjusted:i=!1}){if(!tt)return!1;tt.totalRequests+=1,n?tt.okCount+=1:tt.errorCount+=1,r&&(tt.cachedCount+=1);const a=Number(o?.inputTokens||0)||0,u=Number(o?.outputTokens||0)||0,c=Number(o?.reasoningTokens||0)||0,l=Number(o?.cachedInputTokens||0)||0;tt.inputTokens+=a,tt.outputTokens+=u,tt.reasoningTokens+=c,tt.cachedInputTokens+=l;const m=Number(s||0)||0;if(m>0&&(tt.msSum+=m,tt.msMax=Math.max(tt.msMax,m),tt.msMin=tt.msMin?Math.min(tt.msMin,m):m),a+u+c+l>0){const n=`${String(e||"").toLowerCase()}|${String(t||"").trim()}`,r=tt.models.get(n)||{provider:String(e||"").toLowerCase(),model:String(t||"").trim(),inputTokens:0,outputTokens:0,reasoningTokens:0,cachedInputTokens:0,requests:0,cacheAdjusted:!1};r.inputTokens+=a,r.outputTokens+=u,r.reasoningTokens+=c,r.cachedInputTokens+=l,r.requests+=1,i&&(r.cacheAdjusted=!0),tt.models.set(n,r)}return function(){if(!tt)return;const e=K();if(e-tt.lastLogAt<1e3)return;tt.lastLogAt=e;const t=it(!1);t&&xe(t)}(),!0}function it(e){if(!tt)return null;const t=Array.from(tt.models.values()),n=tt.inputTokens+tt.outputTokens+tt.reasoningTokens,r=Math.max(0,(tt.endedAt||K())-tt.startedAt),o=tt.totalRequests>0?Math.round(tt.msSum/tt.totalRequests):0;return{fn:"AI.BATCH",provider:"batch",model:"",ok:0===tt.errorCount,cache:!1,ms:r,inputTokens:tt.inputTokens,outputTokens:tt.outputTokens,reasoningTokens:tt.reasoningTokens,cachedInputTokens:tt.cachedInputTokens,totalTokens:n,batch:!0,batchId:tt.id,batchLive:!e,batchModels:t,batchStats:{totalRequests:tt.totalRequests,ok:tt.okCount,error:tt.errorCount,cached:tt.cachedCount,avgMs:o,maxMs:tt.msMax,minMs:tt.msMin,peakQueued:tt.peakQueued,peakActive:tt.peakActive}}}function at(){if(!tt)return;if(Xe>0||ze.length>0)return;tt.endedAt=K();const e=it(!0);tt=null,e&&xe(e)}function ut(){return ft(K()),He.length}function ct(){const e={active:Xe,queued:ze.length,rpm:ut()};We=e,Qe||(Qe=setTimeout(()=>{Qe=null;const e=We;if(We=null,!e)return;const t=`${e.active}:${e.queued}:${e.rpm}`;t!==Ze&&(Ze=t,V({...e,ts:K()}))},120))}async function lt(){const e=K();if(e-De<1500)return Ke;const r=await async function(){return await x(),function(e){const n=Y(e,U[0],U[U.length-1],t.concurrencyLimit);if(U.includes(n))return n;let r=U[0],o=Math.abs(n-r);for(const e of U.slice(1)){const t=Math.abs(n-e);t<o&&(r=e,o=t)}return r}(await O(n.CONCURRENCY_LIMIT))}();return Ke=r,De=e,r}async function mt(){const e=K();if(e-qe<1500)return Ye;const r=await async function(){return await x(),function(e){return Y("string"==typeof e?parseInt(e.trim(),10):Number(e),0,1e5,t.rpmLimit)}(await O(n.RPM_LIMIT))}();return Ye=r,qe=e,r}function ft(e){const t=e-6e4;for(;He.length&&He[0]<=t;)He.shift()}function pt(){Be||(Be=setInterval(()=>{const e=ut();ct(),e<=0&&(clearInterval(Be),Be=null)},1e3))}function ht(e){return"string"==typeof e&&e.trim().length>0}function dt(e,t=!1){if("boolean"==typeof e)return e;if("number"==typeof e)return 0!==e;if("string"==typeof e){const t=e.trim().toLowerCase();if(["1","true","yes","y","on"].includes(t))return!0;if(["0","false","no","n","off"].includes(t))return!1}return t}function gt(e){return Y(e,1e3,12e4,t.timeoutMs)}function yt(e){return String(e||"").toLowerCase()}function It(e){const t=String(e||"").trim();return t?t.startsWith("models/")?t:`models/${t}`:""}function At(e){const t=yt(e);return!(!t||!t.includes("cached"))&&(t.includes("not found")||t.includes("invalid")||t.includes("expired")||t.includes("does not exist"))}function Tt(e){const t=yt(e);return!!t&&(t.includes("responseschema")||t.includes("response schema")||t.includes("response_schema")||t.includes("responsemime")||t.includes("response mime")||t.includes("response_mime")||t.includes("response_mime_type")||t.includes("json_schema")||t.includes("response_format")||t.includes("text.format"))}function Et(e){const t=yt(e);return!!t&&!!(t.includes("web_search")||t.includes("google_search")||t.includes("web search")||t.includes("google search"))&&(t.includes("not supported")||t.includes("unsupported")||t.includes("unknown")||t.includes("unrecognized")||t.includes("invalid")||t.includes("not enabled")||t.includes("not available"))}function kt(t,n){if(t!==e.GEMINI||n?.ok)return!1;if(503===n?.status)return!0;if("API_ERROR"!==n?.code)return!1;const r=yt(n?.message);return!!r&&(r.includes("overloaded")||r.includes("service unavailable")||r.includes("unavailable"))}function Nt(e){if(!ht(e))return"Return valid JSON only.";const t=String(e).trim();return/json/i.test(t)?t:t+" Return valid JSON only."}function St(e,t){return"AI.FORMULA"!==e?"":function(e){if(!ht(e))return"";const t=String(e).trim(),n=t.match(/=[^\n\r]+/),r=(n?n[0]:t).trim();return r.startsWith("=")?r:""}(t)}async function _t(r){const o=K(),s=v(r?.provider)||await P(),i=await F(s),a=await j(s),u=r?.functionName||"aiGenerate",l=ht(r?.functionCall)?String(r.functionCall):"",m=s===e.OPENAI?await async function(){const e=K();if(g&&e-y<c)return g;await x();const r=function(e){const n=String(e||"").trim().toLowerCase();return n&&L.has(n)?n:t.openaiReasoningEffort}(await O(n.OPENAI_REASONING_EFFORT)||t.openaiReasoningEffort);return g=r,y=e,r}():"",f=s===e.GEMINI?await async function(){const e=K();if(h&&e-d<c)return h;await x();const r=function(e){const n=String(e||"").trim().toLowerCase();return n&&R.has(n)?n:t.geminiReasoningEffort}(await O(n.GEMINI_REASONING_EFFORT)||t.geminiReasoningEffort);return h=r,d=e,r}():"",p=s===e.OPENAI?m:f;if(!a)return xe({fn:u,provider:s,model:i,ok:!1,ms:K()-o,cache:!1,reasoningEffort:p||void 0,call:l||void 0,code:"API_KEY_MISSING",message:`Clé API manquante pour le fournisseur ${s}.`}),{ok:!1,provider:s,model:i,code:"API_KEY_MISSING",message:`Clé API manquante pour le fournisseur ${s}.`};const I=ht(r?.cachePrefix)?String(r.cachePrefix):"",A=ht(r?.cacheSuffix)?String(r.cacheSuffix):"",T=I?I+A:String(r?.user||""),E=ht(r?.system)?String(r.system):"",k=dt(r?.webSearch,!1),N=gt(r?.timeoutMs),S=(_=r?.retry,Y(_,0,5,t.retry));var _;const w=Math.min(S,2),b=await $(),M=function(e){return Y(e,1,128e3,t.maxOutputTokens)}(r?.maxOutputTokens??b),C=s===e.GEMINI?function(e,t){const n=String(t||"").trim().toLowerCase();if(!n||"auto"===n||"none"===n)return null;const r=String(e||"").trim().toLowerCase();if(!r.includes("gemini"))return null;if(r.includes("gemini-3"))return r.includes("flash")?{thinkingLevel:(new Set(["minimal","low","medium","high"]).has(n)?n:"low").toUpperCase()}:{thinkingLevel:("high"===n||"medium"===n?"high":"low").toUpperCase()};if(r.includes("gemini-2.5")){let e={minimal:512,low:2048,medium:8192,high:24576}[n];return e?(r.includes("flash-lite")&&(e=Math.max(512,e)),r.includes("pro")&&(e=Math.max(128,e)),{thinkingBudget:e}):null}return null}(i,f):null,U=dt(r?.cache,t.cache),V=Y(r?.cacheTtlSec??t.cacheTtlSec,1,31536e3,t.cacheTtlSec),q=U&&!(tt||nt()>=et);await async function(){const e=await async function(){return await W()}();e>Pe&&(Pe=e,Le.clear())}();const J={v:3,provider:s,model:i,maxOutputTokens:M,reasoningEffort:m,geminiReasoningEffort:f,webSearch:k,system:E,user:T,responseMimeType:r?.responseMimeType||"",responseJsonSchema:r?.responseJsonSchema||null},B=await se(J);if(U){const e=Le.get(B);if(e){const t=St(u,e?.text),n=st({provider:s,model:i,ok:!0,cached:!0,usage:null,ms:K()-o});return n||xe({fn:u,provider:s,model:i,ok:!0,ms:K()-o,cache:!0,cacheKind:"memory",reasoningEffort:p||void 0,call:l||void 0,inputTokens:0,outputTokens:0,reasoningTokens:0,totalTokens:0,formula:t||void 0}),n&&at(),{...e,cached:!0,cacheKind:"memory"}}if(q){const e=await async function(e){if(!e)return null;if(await G())return null;const t=await W(),n=await O(X+e);if(!n)return await ne(e),null;try{const r=JSON.parse(n);if(!r||"object"!=typeof r)throw new Error("Invalid entry");const o=Number(r.savedAtMs||0);return t&&(!Number.isFinite(o)||o<=t)||r.expiresAtMs&&r.expiresAtMs<=K()?(await te(e),await ne(e),null):r.value||null}catch{return await te(e),await ne(e),null}}(B);if(e){const t=St(u,e?.text);Le.set(B,e,1e3*V);const n=st({provider:s,model:i,ok:!0,cached:!0,usage:null,ms:K()-o});return n||xe({fn:u,provider:s,model:i,ok:!0,ms:K()-o,cache:!0,cacheKind:"persistent",reasoningEffort:p||void 0,call:l||void 0,inputTokens:0,outputTokens:0,reasoningTokens:0,totalTokens:0,formula:t||void 0}),n&&at(),{...e,cached:!0,cacheKind:"persistent"}}}}if(je.has(B))return je.get(B);const z=async function(){for(;;){const e=await lt();if(Xe<e)break;if(await new Promise(e=>{ze.push(e),rt(),ot(),ct()})===Ve)return{...Ge}}Xe++,rt(),ot(),ct();try{return await async function(){const e=await mt();if(e&&!(e<=0))return Je=Je.then(()=>async function(e){for(;;){const t=K();if(ft(t),!e||e<=0||He.length<e)return He.push(t),pt(),void ct();const n=Math.max(0,He[0]+6e4-t);n>0?await D(n):await D(0)}}(e)),Je}(),await(async()=>{let t=0,n=null;const c=async t=>s===e.OPENAI?async function({apiKey:t,model:n,system:r,user:o,maxOutputTokens:s,reasoningEffort:i,timeoutMs:a,webSearch:u,responseMimeType:c,responseJsonSchema:l}){const m="https://api.openai.com/v1/responses",f={model:n,input:o,max_output_tokens:s,store:!1};if(ht(i)&&(f.reasoning={effort:i}),ht(r)){const e="application/json"===c||l?r+" You must return valid JSON.":r;f.instructions=e}l?f.text={format:{type:"json_schema",name:"excel_ai_schema",strict:!0,schema:l}}:"application/json"===c&&(f.text={format:{type:"json_object"}}),u&&(f.tools=[{type:"web_search"}],f.include=["web_search_call.action.sources"]);const p=await Ct(m,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify(f)},a),h=await xt(p);if(!p.ok){const t=function(e){try{const t=e?.error?.message;return t?String(t):""}catch{return""}}(h)||`OpenAI API error (${p.status}).`;return{ok:!1,provider:e.OPENAI,model:n,code:"API_ERROR",message:H(t)}}const d=function(e){try{if("string"==typeof e?.output_text&&e.output_text.trim())return e.output_text}catch{}try{const t=e?.output;if(Array.isArray(t)){const e=[];for(const n of t){if("string"==typeof n?.text&&n.text.trim()&&e.push(n.text),"string"==typeof n?.output_text&&n.output_text.trim()&&e.push(n.output_text),"output_text"===n?.type&&"string"==typeof n?.text&&e.push(n.text),"text"===n?.type&&"string"==typeof n?.text&&e.push(n.text),"message"===n?.type){const t=n?.content;if(Array.isArray(t))for(const n of t)"text"===n?.type&&n?.text&&e.push(n.text),"output_text"===n?.type&&n?.text&&e.push(n.text);else"string"==typeof t&&e.push(t)}if("message"!==n?.type){const t=n?.content;if(Array.isArray(t))for(const n of t)"text"===n?.type&&n?.text&&e.push(n.text),"output_text"===n?.type&&n?.text&&e.push(n.text);else"string"==typeof t&&e.push(t)}}if(e.length>0)return e.join("\n").trim()}}catch{}try{return e?.choices?.[0]?.message?.content||""}catch{return""}}(h),g=u?function(e){try{const t=e?.output;if(!Array.isArray(t))return[];const n=[];for(const e of t){if("web_search_call"!==e?.type)continue;const t=e?.action?.sources;if(Array.isArray(t))for(const e of t)e?.url&&n.push({title:e?.title||"",url:e.url})}return Ot(n)}catch{return[]}}(h):[],y=function(e){try{const t=e?.usage;if(!t)return null;const n=Mt(t?.output_tokens),r=Mt(t?.output_tokens_details?.reasoning_tokens),o=Math.max(0,n-r);return{inputTokens:Mt(t?.input_tokens),outputTokens:o,reasoningTokens:r,totalTokens:Mt(t?.total_tokens),cachedInputTokens:Mt(t?.input_tokens_details?.cached_tokens)}}catch{return null}}(h);return ht(d)?{ok:!0,provider:e.OPENAI,model:n,text:d.trim(),sources:g,usage:y}:{ok:!1,provider:e.OPENAI,model:n,code:"EMPTY_RESPONSE",message:"Réponse vide d'OpenAI."}}(t):wt(t);for(;t<=S;){t++;try{const n={apiKey:a,model:i,system:E,user:T,cachePrefix:I||void 0,cacheSuffix:A||void 0,maxOutputTokens:M,reasoningEffort:m,thinkingConfig:C,timeoutMs:N,webSearch:k,responseMimeType:r?.responseMimeType,responseJsonSchema:r?.responseJsonSchema};let f=await c(n);if(!f.ok&&!kt(s,f)){let e=n;e.webSearch&&(Et(f.message)||"API_ERROR"===f.code||"EMPTY_RESPONSE"===f.code)&&(e={...e,webSearch:!1},f=await c(e));const t=e.responseMimeType||e.responseJsonSchema;!f.ok&&t&&(Tt(f.message)||"API_ERROR"===f.code||"EMPTY_RESPONSE"===f.code)&&(e={...e,responseMimeType:void 0,responseJsonSchema:void 0,system:Nt(e.system)},f=await c(e))}const h=kt(s,f)&&t<=w;let d=bt(f?.usage);const g=s===e.GEMINI&&d.cachedInputTokens>0;g&&(d={...d,inputTokens:Math.max(0,d.inputTokens-d.cachedInputTokens)});const y=f.ok?St(u,f.text):"";if(h){await D(1e4);continue}return st({provider:s,model:i,ok:f.ok,cached:!1,usage:d,ms:K()-o,cacheAdjusted:g})||xe({fn:u,provider:s,model:i,ok:f.ok,ms:K()-o,attempt:t,cache:!1,reasoningEffort:p||void 0,call:l||void 0,inputTokens:d.inputTokens,outputTokens:d.outputTokens,reasoningTokens:d.reasoningTokens,cachedInputTokens:d.cachedInputTokens,totalTokens:d.totalTokens,code:f.code,message:f.message,formula:y||void 0,cacheHint:f.cacheHint||void 0,cacheStorageTokenHours:f.cacheStorageTokenHours||0,cacheAdjusted:g}),f.ok&&U&&(Le.set(B,f,1e3*V),q&&await re(B,f,1e3*V,{provider:s,model:i})),f}catch(e){n=e,t<=S&&await D(250*t)}}const f=function(e){if(!e)return!1;if("AbortError"===e.name)return!0;const t=String(e.message||"").toLowerCase();return t.includes("aborted")||t.includes("timeout")}(n),h=f?"TIMEOUT":"API_ERROR",d=H(f?"Délai dépassé (timeout).":n?.message?String(n.message):"Erreur inconnue.");return st({provider:s,model:i,ok:!1,cached:!1,usage:null,ms:K()-o})||xe({fn:u,provider:s,model:i,ok:!1,ms:K()-o,cache:!1,reasoningEffort:p||void 0,call:l||void 0,code:h,message:d}),{ok:!1,provider:s,model:i,code:h,message:d}})()}finally{Xe--;const e=ze.shift();e&&e(),ct(),at()}}();je.set(B,z);try{const e=await z;return"QUEUE_CANCELLED"===e?.code&&(st({provider:s,model:i,ok:!1,cached:!1,usage:null,ms:K()-o})||xe({fn:u,provider:s,model:i,ok:!1,ms:K()-o,cache:!1,reasoningEffort:p||void 0,call:l||void 0,inputTokens:0,outputTokens:0,reasoningTokens:0,cachedInputTokens:0,totalTokens:0,code:e.code,message:e.message})),e}finally{je.delete(B)}}async function wt({apiKey:t,model:n,system:r,user:o,cachePrefix:s,cacheSuffix:i,maxOutputTokens:a,thinkingConfig:u,timeoutMs:c,webSearch:l,responseMimeType:m,responseJsonSchema:f,disableCache:p=!1}){const h=function(e){return`https://generativelanguage.googleapis.com/v1beta/models/${encodeURIComponent(e)}:generateContent`}(n);let d="",g="",y="",I=o;const A=ht(r)?"application/json"===m||f?r+" You must return valid JSON.":r:"";if(!p&&!l&&ht(s)&&ht(i)&&i.trim().length>=1){const e=await async function({apiKey:e,model:t,system:n,prefix:r,ttlMs:o,timeoutMs:s}){if(!e||!ht(r))return null;if(await G())return null;if(r.length<200)return null;!function(){const e=K();for(const[t,n]of $e.entries())n?.expiresAtMs&&n.expiresAtMs<=e&&$e.delete(t)}();const i=await se({v:1,model:String(t||"").trim(),system:String(n||"").trim(),prefix:r}),a=$e.get(i);if(a?.name)return(!Number.isFinite(a.createdAtMs)||a.createdAtMs<=0)&&(a.createdAtMs=K()),(!Number.isFinite(a.expiresAtMs)||a.expiresAtMs<=a.createdAtMs)&&(a.expiresAtMs=a.createdAtMs+(o||Fe)),Number.isFinite(a.chargedTokenHours)||(a.chargedTokenHours=0),$e.set(i,a),{name:a.name,cacheKey:i};if(Ue.has(i))return Ue.get(i);const u=(async()=>{try{const a=await async function({apiKey:e,model:t,system:n,prefix:r,ttlMs:o,timeoutMs:s}){const i={model:It(t),contents:[{role:"user",parts:[{text:r}]}],ttl:`${Math.max(60,Math.floor((o||Fe)/1e3))}s`};ht(n)&&(i.systemInstruction={role:"system",parts:[{text:n}]});const a=await Ct("https://generativelanguage.googleapis.com/v1beta/cachedContents",{method:"POST",headers:{"Content-Type":"application/json","x-goog-api-key":e},body:JSON.stringify(i)},Math.max(1e4,Math.min(6e4,s||3e4))),u=await xt(a);if(!a.ok)return{ok:!1,status:a.status,json:u};const c=String(u?.name||"").trim();return c?{ok:!0,name:c,expireTime:u?.expireTime?Date.parse(String(u.expireTime)):0}:{ok:!1,status:a.status,json:u}}({apiKey:e,model:t,system:n,prefix:r,ttlMs:o,timeoutMs:s});if(!a?.ok||!a?.name)return null;const u=Number.isFinite(a.expireTime)&&a.expireTime>0?a.expireTime:K()+(o||Fe);return $e.set(i,{name:a.name,createdAtMs:K(),expiresAtMs:u,chargedTokenHours:0}),{name:a.name,cacheKey:i}}catch{return null}})();Ue.set(i,u);try{return await u}finally{Ue.delete(i)}}({apiKey:t,model:n,system:A,prefix:s,ttlMs:Fe,timeoutMs:c});e?.name&&(g=e.name,y=e.cacheKey||"",I=i,d="gemini_cached_content")}const T={contents:[{role:"user",parts:[{text:I}]}],generationConfig:{maxOutputTokens:a}};u&&"object"==typeof u&&(T.generationConfig.thinkingConfig=u),ht(A)&&!g&&(T.systemInstruction={role:"system",parts:[{text:A}]}),m&&(T.generationConfig.responseMimeType=m),f&&(T.generationConfig.responseSchema=f),l&&(T.tools=[{google_search:{}}]),g&&(T.cachedContent=g);const E=await Ct(h,{method:"POST",headers:{"Content-Type":"application/json","x-goog-api-key":t},body:JSON.stringify(T)},c),k=await xt(E),N=function(e){try{const t=e?.error;if(!t)return null;const n=t?.message,r=Number(t?.code);return{message:n?String(n):"",status:Number.isFinite(r)?r:void 0}}catch{return null}}(k);if(N?.message)return y&&At(N.message)?($e.delete(y),await wt({apiKey:t,model:n,system:r,user:o,cachePrefix:s,cacheSuffix:i,maxOutputTokens:a,thinkingConfig:u,timeoutMs:c,webSearch:l,responseMimeType:m,responseJsonSchema:f,disableCache:!0})):{ok:!1,provider:e.GEMINI,model:n,status:N.status??E.status,code:"API_ERROR",message:H(N.message),cacheHint:d};if(!E.ok){const p=function(e){try{const t=e?.error?.message;return t?String(t):""}catch{return""}}(k)||`Gemini API error (${E.status}).`;return y&&At(p)?($e.delete(y),await wt({apiKey:t,model:n,system:r,user:o,cachePrefix:s,cacheSuffix:i,maxOutputTokens:a,thinkingConfig:u,timeoutMs:c,webSearch:l,responseMimeType:m,responseJsonSchema:f,disableCache:!0})):{ok:!1,provider:e.GEMINI,model:n,status:E.status,code:"API_ERROR",message:H(p),cacheHint:d}}const S=function(e){try{const t=e?.candidates?.[0],n=t?.content?.parts;return Array.isArray(n)?n.map(e=>e?.text||"").join(""):""}catch{return""}}(k),_=function(e){try{const t=e?.candidates?.[0],n=t?.groundingMetadata,r=n?.groundingChunks;if(!Array.isArray(r))return[];const o=[];for(const e of r){const t=e?.web;t?.uri&&o.push({title:t?.title||"",url:t.uri})}return Ot(o)}catch{return[]}}(k),w=function(e){try{const t=e?.usageMetadata;return t?{inputTokens:Mt(t?.promptTokenCount),outputTokens:Mt(t?.candidatesTokenCount),reasoningTokens:Mt(t?.thoughtsTokenCount),totalTokens:Mt(t?.totalTokenCount),cachedInputTokens:Mt(t?.cachedContentTokenCount)}:null}catch{return null}}(k);let b=0;if("gemini_cached_content"===d&&y&&w?.cachedInputTokens>0){const e=$e.get(y);if(!(e?.chargedTokenHours&&e.chargedTokenHours>0)){const t=Number(e?.createdAtMs)||0,n=Number(e?.expiresAtMs)||0;let r=0;if(r=t>0&&n>t?n-t:Fe,r>0){const t=r/36e5;b=Math.max(0,Number(w.cachedInputTokens)||0)*t,e&&b>0&&(e.chargedTokenHours=b,$e.set(y,e))}}}return ht(S)?{ok:!0,provider:e.GEMINI,model:n,text:S.trim(),sources:_,usage:w,cacheHint:d,cacheStorageTokenHours:b||0}:{ok:!1,provider:e.GEMINI,model:n,code:"EMPTY_RESPONSE",message:"Réponse vide de Gemini.",cacheHint:d}}function bt(e){if(!e||"object"!=typeof e)return{inputTokens:0,outputTokens:0,reasoningTokens:0,totalTokens:0,cachedInputTokens:0};const t=Mt(e.inputTokens),n=Mt(e.outputTokens),r=Mt(e.reasoningTokens),o=Mt(e.cachedInputTokens),s=Mt(e.totalTokens),i=t+n+r;return{inputTokens:t,outputTokens:n,reasoningTokens:r,totalTokens:Math.max(s,i),cachedInputTokens:o}}function Mt(e){const t=Number(e);return!Number.isFinite(t)||t<=0?0:Math.floor(t)}function Ot(e){const t=new Set,n=[];for(const r of e||[]){const e=String(r?.url||"").trim();if(!e)continue;const o=e.toLowerCase();t.has(o)||(t.add(o),n.push({title:String(r?.title||"").trim(),url:e}))}return n}async function Ct(e,t,n){const r=gt(n);if("undefined"==typeof AbortController)return await fetch(e,t);const o=new AbortController,s=setTimeout(()=>o.abort(),r);try{return await fetch(e,{...t,signal:o.signal})}finally{clearTimeout(s)}}async function xt(e){try{return await e.json()}catch{return{}}}V({active:0,queued:0,rpm:0,ts:K()});const vt=Number.POSITIVE_INFINITY,Rt="fr";function Lt(e){return Array.isArray(e)}function Pt(e){return Array.isArray(e)?0===e.length?[[]]:Array.isArray(e[0])?e:[e]:[[e]]}function jt(e){if(null==e)return"";if("string"==typeof e)return e;if("number"==typeof e)return String(e);if("boolean"==typeof e)return e?"TRUE":"FALSE";try{return String(e)}catch{return""}}function Ft(e){const t=String(e||"");return t.length<=32e3?t:t.slice(0,31999)+"…"}function $t(e,t=9e3){const n=Pt(e),r=Math.max(0,Number(t)||0),o=[];let s=0,i=!1;const a=e=>{if(!e||i)return;if(s+e.length<=r)return o.push(e),void(s+=e.length);const t=Math.max(0,r-s);t>0&&(o.push(e.slice(0,t)),s+=t),i=!0};for(let e=0;e<n.length&&!i;e++){const t=Array.isArray(n[e])?n[e]:[n[e]];e>0&&a("\n");for(let e=0;e<t.length&&!i;e++)e>0&&a("\t"),a(jt(t[e]))}let u=o.join("");return i&&(u+="\n…"),u}function Ut(e,t=120){let n=String(e??"");return n=n.replace(/\r?\n/g,"\\n").replace(/\t/g,"\\t"),n.length>t&&(n=n.slice(0,Math.max(0,t-3))+"..."),n=n.replace(/"/g,'""'),`"${n}"`}function Vt(e){return null==e?"":"number"==typeof e&&Number.isFinite(e)?String(e):"boolean"==typeof e?e?"TRUE":"FALSE":Array.isArray(e)?Ut($t(e,120).replace(/…/g,"..."),120):Ut(e,120)}function Gt(e,t=[]){const n=t.map(Vt);let r=n.length-1;for(;r>=0&&""===n[r];)r--;return`=${e}(${n.slice(0,r+1).join(",")})`}function Kt(e,t=200){const n=Pt(e),r=[];for(const e of n){const n=Array.isArray(e)?e:[e];for(const e of n)if(r.push(jt(e)),r.length>=t)return r}return r}function Dt(e){const t=new Set,n=[];for(const r of e){const e=r.toLowerCase();t.has(e)||(t.add(e),n.push(r))}return n}function Yt(e,t){try{if("undefined"!=typeof CustomFunctions&&CustomFunctions?.Error){const n=e||CustomFunctions.ErrorCode.invalidValue;return new CustomFunctions.Error(n,t)}}catch{}return`#ERROR: ${t}`}function qt(e){const t=String(e||"").trim(),n=t.match(/```(?:json)?\s*([\s\S]*?)\s*```/i);if(n)return JSON.parse(n[1]);try{return JSON.parse(t)}catch(e){const n=t.indexOf("{"),r=t.lastIndexOf("}");if(-1!==n&&r>n)try{return JSON.parse(t.slice(n,r+1))}catch{}const o=t.indexOf("["),s=t.lastIndexOf("]");if(-1!==o&&s>o)try{return JSON.parse(t.slice(o,s+1))}catch{}throw e}}const Ht="Never ask clarifying questions. If information is missing, make reasonable assumptions and proceed.";function Jt(e="fr"){return["You are an assistant embedded in Microsoft Excel custom functions.",`Respond in ${e}.`,"Return a clear and accurate answer suitable for an Excel cell.",Ht,"No Markdown. No code fences. No surrounding quotes.","If the question cannot be answered from the provided information, say so briefly."].join("\n")}function Bt(e,t){const n=Number.isFinite(Number(t))?Math.floor(Number(t)):0;return n>1?["You are a translation engine.",`Translate each cell independently into ${e}.`,Ht,"Return STRICT JSON only (no Markdown, no code fences).",`Return an object with a single key 'items' containing exactly ${n} strings in the same order as the provided cells.`,"Each item must contain ONLY the translated text for that cell.","Preserve numbers, units, and identifiers as-is unless they require translation.","For empty inputs, return an empty string at the same position.","Do not add any keys other than 'items'."].join("\n"):["You are a translation engine.",`Translate the user text into ${e}.`,Ht,"Return only the translated text. No quotes. No explanations."].join("\n")}function Xt(e,t="en"){return["You are a strict classifier.",`Return exactly one label from this set, using the label text verbatim: ${e.join(" | ")}`,"Do not translate, expand, or paraphrase labels.","If uncertain, return exactly: UNKNOWN",Ht,`Respond in ${t}.`,"Return only the label."].join("\n")}function zt(e="fr",t){return"number"==typeof t&&t>1?["You are a text normalizer for spreadsheet cells.",`Respond in ${e}.`,Ht,"Return STRICT JSON only (no Markdown, no code fences).",`Return an object with a single key 'items' containing exactly ${t} strings in the same order as the provided cells.`,"Preserve the meaning of each cell independently.","For empty inputs, return an empty string at the same position.","Do not invent or merge content."].join("\n"):["You are a text normalizer for spreadsheet cells.",`Respond in ${e}.`,Ht,"Return only the cleaned text.","No quotes. No explanations."].join("\n")}function Qt(e="fr",t){return["You harmonize spreadsheet entries that refer to the same real-world value.",`Respond in ${e}.`,Ht,"Return STRICT JSON only (no Markdown, no code fences).",`Return an object with a single key 'items' containing exactly ${t} strings in the same order as the provided cells.`,"Normalize casing, accents, spacing, and fix obvious typos.","When several cells refer to the same entity, use ONE consistent, best-written value for all of them.","Keep outputs aligned with inputs; do not merge or reorder rows.","If an input is empty or whitespace-only, return an empty string for that position.","Do not invent new information beyond correcting the given values."].join("\n")}function Wt(e="fr",t){return"number"==typeof t&&t>1?["You summarize text for spreadsheet cells.",`Respond in ${e}.`,Ht,"Return STRICT JSON only (no Markdown, no code fences).",`Return an object with a single key 'items' containing exactly ${t} strings in the same order as the provided cells.`,"Summarize each cell independently; do not merge content across cells.","Use bullet points with '-' when it improves readability.","Keep outputs aligned with inputs. If an input is empty or whitespace-only, return an empty string for that position.","No Markdown headers. No code fences. No surrounding quotes."].join("\n"):["You summarize text for a spreadsheet cell.",`Respond in ${e}.`,Ht,"Return a clear summary suitable for an Excel cell.","Use bullet points with '-' when it improves readability.","No Markdown headers. No code fences. No surrounding quotes."].join("\n")}function Zt(e,t="fr",n){return["You are an expert extraction engine.",`Goal: Extract all entities matching this description: "${e}"`,`Respond in ${t}.`,Ht,"Lightly normalize results (trim spaces, fix obvious email obfuscation like [at]/(at) -> @ and [dot]/(dot)/point -> .).","Return STRICT JSON only (no Markdown, no code fences).","number"==typeof n&&n>0?`Return an object with a single key 'items' which is an array of exactly ${n} strings, preserving order.`:"Return an object with a single key 'items' which is an array of strings.",'Example: { "items": ["match1", "match2"] }',"number"==typeof n?"If a value is missing for a cell, return an empty string in that position.":'If nothing found, return { "items": [] }.',"Extract exact values from the text without inventing data."].join("\n")}function en(e="fr",t){const n=Number.isFinite(Number(t))?Math.floor(Number(t)):0;return["You are filling spreadsheet cells based on examples.",`Respond in ${e}.`,Ht,"Return STRICT JSON only (no Markdown, no code fences).",n>0?`Return an object with a single key 'values' containing exactly ${n} strings, in the same order as the target rows.`:"Return an object with a single key 'values' containing an array of strings.","Return only the values, in order, one per target row.","If a value is unknown, return an empty string for that row.","Do not add any keys other than 'values'."].join("\n")}function tn(e){const t=(e||"").toLowerCase().startsWith("fr");return["You are an expert Excel formula generator.","Your goal is to output a VALID Excel formula string based on the user request.","Leverage advanced Excel capabilities (dynamic arrays, LET/LAMBDA, structured references, advanced date/time, lookup, statistics, financial functions) when relevant.",Ht,`Respond in ${e}.`,t?"Use FRENCH Excel function names (e.g., SOMME, SI, RECHERCHEV...).":"Use ENGLISH Excel function names (e.g., SUM, IF, VLOOKUP...).",t?"Use SEMICOLON (;) as argument separator.":"Use COMMA (,) as argument separator.","Return exactly one ready-to-use Excel formula with no surrounding text.","Return ONLY the formula starting with '='.","No Markdown. No code fences. No explanations."].join("\n")}function nn(e="fr"){return["You are a meticulous fact-finding assistant with access to reliable web knowledge.",Ht,"Return only one precise, up-to-date factual value plus the best authoritative source URL.","Never fabricate numbers or URLs. Use official or authoritative sources only.","Match the requested timeframe and scope exactly; ignore partial or approximate figures.","If the data cannot be confirmed with high confidence, return empty strings and explain why in a 'reason' field.",`Respond in ${e}.`,"Return STRICT JSON only (no Markdown, no code fences).",'Schema: {"value": "<concise value>", "source": "https://...", "reason": "<why unavailable>"}.',"The value must mirror the source exactly and stay under 80 characters."].join("\n")}async function rn(){try{const t=await P(),n=await $(),r=await j(e.GEMINI),o=await j(e.OPENAI),s=await F(e.GEMINI);return[`Default provider: ${t}`,`Max output tokens: ${n}`,`Gemini: ${r?"key set":"key missing"} / model: ${s}`,`OpenAI: ${o?"key set":"key missing"} / model: ${await F(e.OPENAI)}`,`Storage: ${S().kind}`].join("\n")}catch(e){return Yt(CustomFunctions?.ErrorCode?.notAvailable,e?.message||"Erreur KEY_STATUS.")}}async function on(){const e=await async function(){const e=v(void 0)||await P(),t=await F(e);return await j(e)?await _t({provider:e,system:"You are a test endpoint. Reply with exactly: OK",user:"OK",maxOutputTokens:500,cache:!1,webSearch:!1,functionName:"AI.MINIMAL_TEST"}):{ok:!1,provider:e,model:t,code:"API_KEY_MISSING",message:`Clé API manquante pour le fournisseur ${e}.`}}();return e.ok?"OK":Yt(CustomFunctions?.ErrorCode?.notAvailable,e.message||"Test échoué.")}async function sn(e,t){const n=jt(e).trim();if(!n)return Yt(CustomFunctions?.ErrorCode?.invalidValue,"Le paramètre prompt est vide.");const r=null!=t&&Lt(t)?$t(t):"",o=r?`Contexte (TSV):\n${r}\n\nQuestion:\n${n}`:n,s=await _t({system:Jt(Rt),user:o,webSearch:!1,functionName:"AI.ASK",functionCall:Gt("AI.ASK",[e,t])});if(!s.ok)return Yt(CustomFunctions?.ErrorCode?.notAvailable,s.message||"Erreur AI.ASK.");let i=s.text||"";return i=i.replace(/\*\*/g,"").replace(/##/g,"").replace(/__/g,""),Ft(i)}async function an(e,t){const n=jt(e).trim();if(!n)return Yt(CustomFunctions?.ErrorCode?.invalidValue,"Le paramètre prompt est vide.");let r="";null!=t&&(r=Lt(t)?$t(t):jt(t).trim());const o=!!r,s=o?`${n}\n\nContexte (TSV):\n`:"",i=o?r:"",a=o?s+i:n,u=await _t({system:Jt(Rt),user:a,webSearch:!1,functionName:"AI.BATCH",functionCall:Gt("AI.BATCH",[e,t]),cachePrefix:o?s:void 0,cacheSuffix:o?i:void 0});if(!u.ok)return Yt(CustomFunctions?.ErrorCode?.notAvailable,u.message||"Erreur AI.BATCH.");let c=u.text||"";return c=c.replace(/\*\*/g,"").replace(/##/g,"").replace(/__/g,""),Ft(c)}async function un(e,t,n){const r=jt(e).trim();if(!r)return Yt(CustomFunctions?.ErrorCode?.invalidValue,"Le paramètre query est vide.");const o=null!=t&&Lt(t)?$t(t):"",s=o?`Contexte (TSV):\n${o}\n\nRequête web:\n${r}`:r,i=await _t({system:nn(Rt),user:s,webSearch:!0,functionName:"AI.WEB",functionCall:Gt("AI.WEB",[e,t,n])});if(!i.ok)return Yt(CustomFunctions?.ErrorCode?.notAvailable,i.message||"Erreur AI.WEB.");let a=i.text||"",u=Array.isArray(i.sources)?i.sources:[],c=a;try{const e=qt(a);if(e&&"object"==typeof e){const t=jt(e.value).trim(),n=jt(e.source).trim(),r=jt(e.reason).trim();t?c=t:r&&(c=r),n&&(u=[{title:"",url:n}])}}catch{}const l=1===function(e){const t=Number(e);return Number.isFinite(t)&&1===t?1:0}(n)?c+function(e,t=8){const n=(Array.isArray(e)?e:[]).slice(0,t);if(!n.length)return"";const r=["","Sources:"];let o=1;for(const e of n){const t=(e?.title||"").trim(),n=(e?.url||"").trim();n&&(r.push(`${o}. ${t?t+" - ":""}${n}`),o++)}return r.join("\n")}(u):c;return Ft(l)}async function cn(e,t){const n=jt(t).trim();if(!n)return Yt(CustomFunctions?.ErrorCode?.invalidValue,"La langue cible est vide.");const r=Pt(e),o=Kt(r,vt+1),s=o.length,i=s>1;if(o.length>vt)return Yt(CustomFunctions?.ErrorCode?.invalidValue,`Plage trop grande (max ${vt} cellules) pour AI.TRANSLATE.`);const a=o.map((e,t)=>`${t+1}. ${e}`),u=i?[`Translate each item to: ${n}.`,`Return JSON with items array of length ${s}. Use empty string for empty inputs.`,"",...a].join("\n"):`Translate to ${n}:\n${o[0]||""}`,c=await _t({system:Bt(n,s),user:u,responseMimeType:i?"application/json":void 0,responseJsonSchema:i?{type:"object",additionalProperties:!1,required:["items"],properties:{items:{type:"array",items:{type:"string"}}}}:void 0,functionName:"AI.TRANSLATE",functionCall:Gt("AI.TRANSLATE",[e,t])});if(!c.ok)return Yt(CustomFunctions?.ErrorCode?.notAvailable,c.message||"Erreur AI.TRANSLATE.");let l=[];if(i)try{const e=qt(c.text);Array.isArray(e?.items)&&(l=e.items.map(e=>jt(e)))}catch{if(!c.text)return Yt(CustomFunctions?.ErrorCode?.invalidValue,"Réponse vide (TRANSLATE).");l=c.text.split("\n").map(e=>e.trim())}else{try{const e=qt(c.text);Array.isArray(e?.items)&&(l=e.items.map(e=>jt(e)))}catch{}l.length||(l=[jt(c.text).trim()])}for(;l.length<o.length;)l.push("");l.length>o.length&&(l=l.slice(0,o.length));const m=[];let f=0;for(let e=0;e<r.length;e++){const t=[];for(let n=0;n<(r[e]||[]).length;n++)t.push(Ft(l[f++]||""));m.push(t)}return m}async function ln(e,t){const n=function(e){return Lt(e)?Dt(Kt(e,2e3).map(e=>e.trim()).filter(Boolean)):Dt(jt(e).split(/[,\|;\n\r]+/).map(e=>e.trim()).filter(Boolean))}(t);if(!n.length)return Yt(CustomFunctions?.ErrorCode?.invalidValue,"La liste de labels est vide.");const r=Pt(e),o=Kt(r,vt+1),s=o.length,i=s>1;if(o.length>vt)return Yt(CustomFunctions?.ErrorCode?.invalidValue,`Plage trop grande (max ${vt} cellules) pour AI.CLASSIFY.`);const a=n.join(" | "),u=o.map((e,t)=>`${t+1}. ${e}`),c=i?["Classify each item into exactly one label from the allowed list.",`Allowed labels: ${a}`,`Return JSON with items array of length ${s}. Use UNKNOWN if unsure.`,"",...u].join("\n"):["Classify the following text into exactly one allowed label.",`Allowed labels: ${a}`,"",o[0]||""].join("\n"),l=await _t({system:Xt(n,Rt),user:c,responseMimeType:i?"application/json":void 0,responseJsonSchema:i?{type:"object",additionalProperties:!1,required:["items"],properties:{items:{type:"array",items:{type:"string"}}}}:void 0,functionName:"AI.CLASSIFY",functionCall:Gt("AI.CLASSIFY",[e,t])});if(!l.ok)return Yt(CustomFunctions?.ErrorCode?.notAvailable,l.message||"Erreur AI.CLASSIFY.");let m=[];if(i)try{const e=qt(l.text);Array.isArray(e?.items)&&(m=e.items.map(e=>jt(e).trim()))}catch{m=l.text.split("\n").map(e=>e.trim())}else{try{const e=qt(l.text);Array.isArray(e?.items)&&(m=e.items.map(e=>jt(e).trim()))}catch{}m.length||(m=[jt(l.text).trim()])}for(;m.length<o.length;)m.push("UNKNOWN");m.length>o.length&&(m=m.slice(0,o.length));const f=new Map(n.map(e=>[e.toLowerCase(),e]));m=m.map(e=>{const t=e.toLowerCase();return f.get(t)||e||"UNKNOWN"});const p=[];let h=0;for(let e=0;e<r.length;e++){const t=[];for(let n=0;n<(r[e]||[]).length;n++)t.push(Ft(m[h++]||"UNKNOWN"));p.push(t)}return p}async function mn(e,t){const n=jt(t).trim();if(!n)return Yt(CustomFunctions?.ErrorCode?.invalidValue,"L'instruction est vide.");const r=Pt(e),o=Kt(r,vt+1);if(o.length>vt)return Yt(CustomFunctions?.ErrorCode?.invalidValue,`Plage trop grande (max ${vt} cellules) pour AI.EXTRACT.`);const s={type:"object",additionalProperties:!1,required:["items"],properties:{items:{type:"array",items:{type:"string"}}}};if(1===o.length){const r=[`Instruction: ${n}`,"Input:",o[0]].join("\n\n"),i=await _t({system:Zt(n,Rt),user:r,responseMimeType:"application/json",responseJsonSchema:s,functionName:"AI.EXTRACT",functionCall:Gt("AI.EXTRACT",[e,t])});if(!i.ok)return Yt(CustomFunctions?.ErrorCode?.notAvailable,i.message||"Erreur AI.EXTRACT.");let a=[];try{const e=qt(i.text);Array.isArray(e?.items)&&(a=e.items.map(e=>jt(e).trim()).filter(Boolean))}catch{if(a=i.text.split("\n").map(e=>e.trim()).filter(Boolean),0===a.length&&i.text)return Yt(CustomFunctions?.ErrorCode?.invalidValue,`JSON Error: ${i.text.slice(0,100)}`)}return a.length?a.map(e=>[Ft(e)]):[[""]]}const i=o.map((e,t)=>`${t+1}. ${e}`),a=[`Instruction: ${n}`,`Return JSON with items array of length ${o.length}.`,"Each item must be the best extracted value for the corresponding input (or empty string if none).","",...i].join("\n"),u=await _t({system:Zt(n,Rt,o.length),user:a,responseMimeType:"application/json",responseJsonSchema:s,functionName:"AI.EXTRACT_BATCH",functionCall:Gt("AI.EXTRACT",[e,t])});if(!u.ok)return Yt(CustomFunctions?.ErrorCode?.notAvailable,u.message||"Erreur AI.EXTRACT.");let c=[];try{const e=qt(u.text);Array.isArray(e?.items)&&(c=e.items.map(e=>jt(e).trim()))}catch{c=u.text.split("\n").map(e=>e.trim())}for(;c.length<o.length;)c.push("");c.length>o.length&&(c=c.slice(0,o.length));const l=[];let m=0;for(let e=0;e<r.length;e++){const t=[];for(let n=0;n<(r[e]||[]).length;n++)t.push(Ft(c[m++]||""));l.push(t)}return l}async function fn(e){const t=Pt(e),n=Kt(t,vt+1),r=n.length,o=r>1;if(n.length>vt)return Yt(CustomFunctions?.ErrorCode?.invalidValue,`Plage trop grande (max ${vt} cellules) pour AI.CLEAN.`);const s=n.map((e,t)=>`${t+1}. ${e}`),i=o?["Clean each item for Excel (whitespace, line breaks).",`Return JSON with items array of length ${r}. Use empty string for empty inputs.`,"",...s].join("\n"):`Clean this text for Excel:\n${n[0]||""}`,a=await _t({system:zt(Rt,r),user:i,responseMimeType:o?"application/json":void 0,responseJsonSchema:o?{type:"object",additionalProperties:!1,required:["items"],properties:{items:{type:"array",items:{type:"string"}}}}:void 0,functionName:"AI.CLEAN",functionCall:Gt("AI.CLEAN",[e])});if(!a.ok)return Yt(CustomFunctions?.ErrorCode?.notAvailable,a.message||"Erreur AI.CLEAN.");let u=[];if(o)try{const e=qt(a.text);Array.isArray(e?.items)&&(u=e.items.map(e=>jt(e)))}catch{u=a.text.split("\n").map(e=>e.trim())}else{try{const e=qt(a.text);Array.isArray(e?.items)&&(u=e.items.map(e=>jt(e)))}catch{}u.length||(u=[jt(a.text).trim()])}for(;u.length<n.length;)u.push("");u.length>n.length&&(u=u.slice(0,n.length));const c=[];let l=0;for(let e=0;e<t.length;e++){const n=[];for(let r=0;r<(t[e]||[]).length;r++)n.push(Ft(u[l++]||""));c.push(n)}return c}async function pn(e){const t=Pt(e),n=Kt(t,vt+1),r=n.length;if(n.length>vt)return Yt(CustomFunctions?.ErrorCode?.invalidValue,`Plage trop grande (max ${vt} cellules) pour AI.CONSISTENT.`);const o=["Normalize each item so that near-duplicates become identical.",`Return JSON with items array of length ${r}.`,"",...n.map((e,t)=>`${t+1}. ${e}`)].join("\n"),s=await _t({system:Qt(Rt,r),user:o,responseMimeType:"application/json",responseJsonSchema:{type:"object",additionalProperties:!1,required:["items"],properties:{items:{type:"array",items:{type:"string"}}}},functionName:"AI.CONSISTENT",functionCall:Gt("AI.CONSISTENT",[e])});if(!s.ok)return Yt(CustomFunctions?.ErrorCode?.notAvailable,s.message||"Erreur AI.CONSISTENT.");let i=[];try{const e=qt(s.text);Array.isArray(e?.items)&&(i=e.items.map(e=>jt(e)))}catch{i=s.text.split("\n").map(e=>e.trim())}for(;i.length<n.length;)i.push("");i.length>n.length&&(i=i.slice(0,n.length));const a=[];let u=0;for(let e=0;e<t.length;e++){const n=[];for(let r=0;r<(t[e]||[]).length;r++)n.push(Ft(i[u++]||""));a.push(n)}return a}async function hn(e,t){const n=jt(e).trim();if(!n)return Yt(CustomFunctions?.ErrorCode?.invalidValue,"La description est vide.");const r=null!=t&&Lt(t)?$t(t):"",o=r?`Contexte (TSV):\n${r}\n\nDescription:\n${n}`:n,s=(a=function(){try{if("undefined"!=typeof Office&&Office?.context){const e=Office.context.displayLanguage||Office.context.contentLanguage;if(e)return String(e)}}catch{}try{if("undefined"!=typeof navigator&&navigator?.language)return String(navigator.language)}catch{}return Rt}(),String(a||"").toLowerCase().startsWith("fr")?"fr":"en"),i=await _t({system:tn(s),user:o,webSearch:!1,functionName:"AI.FORMULA",functionCall:Gt("AI.FORMULA",[e,t])});var a;if(!i.ok)return Yt(CustomFunctions?.ErrorCode?.notAvailable,i.message||"Erreur AI.FORMULA.");const u=(i.text||"").trim(),c=u.match(/=[^\n\r]+/),l=(c?c[0]:u).trim();return l.startsWith("=")?Ft(l):Yt(CustomFunctions?.ErrorCode?.notAvailable,"La réponse n'est pas une formule Excel valide.")}async function dn(e,t){const n=jt(e).trim();if(!n)return Yt(CustomFunctions?.ErrorCode?.invalidValue,"La description est vide.");const r=null!=t&&Lt(t)?$t(t):"",o=["Build a table for Excel based on the description and optional context.","Return JSON { headers: [...], rows: [[...], ...] }",r?`\nContext (TSV):\n${r}`:"",`\nDescription:\n${n}`].join("\n"),s=await _t({system:["You generate tables for Excel.",Ht,"Return JSON that matches the provided schema.","Do not include any extra keys.","Use strings for all cell values."].join(" "),user:o,responseMimeType:"application/json",responseJsonSchema:{type:"object",additionalProperties:!1,required:["headers","rows"],properties:{headers:{type:"array",items:{type:"string"}},rows:{type:"array",items:{type:"array",items:{type:"string"}}}}},functionName:"AI.TABLE",functionCall:Gt("AI.TABLE",[e,t])});if(!s.ok)return Yt(CustomFunctions?.ErrorCode?.notAvailable,s.message||"Erreur AI.TABLE.");let i=null;try{i=qt(s.text)}catch{try{const e=s.text.match(/\{[\s\S]*\}/);if(!e)throw new Error;i=JSON.parse(e[0])}catch{return Yt(CustomFunctions?.ErrorCode?.notAvailable,"Impossible de parser le JSON renvoyé par l'IA.")}}const a=Array.isArray(i?.headers)?i.headers.map(e=>Ft(jt(e))):[],u=Array.isArray(i?.rows)?i.rows:[],c=a.length||(Array.isArray(u?.[0])?u[0].length:0)||1,l=a.length?a:Array.from({length:c},(e,t)=>`Col${t+1}`),m=[l];for(const e of u){const t=Array.isArray(e)?e.map(e=>Ft(jt(e))):[];for(;t.length<l.length;)t.push("");t.length>l.length&&(t.length=l.length),m.push(t)}return m}async function gn(e,t,n){const r=jt(n).trim();if(!r)return Yt(CustomFunctions?.ErrorCode?.invalidValue,"L'instruction est vide.");const o=Pt(e),s=Pt(t),i=s.length;if(i<=0)return[[""]];if(i>vt)return Yt(CustomFunctions?.ErrorCode?.invalidValue,`Plage cible trop grande (max ${vt} lignes) pour AI.FILL.`);const a=[`Instruction: ${r}`,"","Examples (TSV):",$t(o,6e3),"","Target rows (TSV):",$t(s,6e3),"",`Return JSON with values array of length ${i} (one value per target row).`].join("\n"),u=await _t({system:en(Rt,i),user:a,responseMimeType:"application/json",responseJsonSchema:{type:"object",additionalProperties:!1,required:["values"],properties:{values:{type:"array",items:{type:"string"}}}},functionName:"AI.FILL",functionCall:Gt("AI.FILL",[e,t,n])});if(!u.ok)return Yt(CustomFunctions?.ErrorCode?.notAvailable,u.message||"Erreur AI.FILL.");let c=[];try{const e=JSON.parse(u.text);Array.isArray(e?.values)&&(c=e.values.map(e=>jt(e)))}catch{c=u.text.split("\n").map(e=>e.trim())}for(;c.length<i;)c.push("");return c.length>i&&(c=c.slice(0,i)),c.map(e=>[Ft(e)])}async function yn(e,t){const n=function(e){const t=Number(e);return Number.isFinite(t)&&1===t?1:0}(t),r=Pt(e);if(1===n){const n=Kt(r,2e3).map(e=>e.trim()).filter(Boolean);if(!n.length)return[[""]];const o=`Content:\n${n.join("\n")}`,s=await _t({system:Wt(Rt),user:o,webSearch:!1,functionName:"AI.SUMMARIZE",functionCall:Gt("AI.SUMMARIZE",[e,t])});return s.ok?[[Ft(s.text)]]:Yt(CustomFunctions?.ErrorCode?.notAvailable,s.message||"Erreur AI.SUMMARIZE.")}const o=Kt(r,2e3).map(e=>e.trim()),s=o.length,i=s>1;if(!s)return[[""]];const a=o.map((e,t)=>`${t+1}. ${e}`),u=i?["Summarize each item for Excel.",`Return JSON with items array of length ${s}. Use empty string for empty inputs.`,"",...a].join("\n"):`Summarize for Excel:\n${o[0]||""}`,c=await _t({system:Wt(Rt,s),user:u,responseMimeType:i?"application/json":void 0,responseJsonSchema:i?{type:"object",additionalProperties:!1,required:["items"],properties:{items:{type:"array",items:{type:"string"}}}}:void 0,functionName:"AI.SUMMARIZE",functionCall:Gt("AI.SUMMARIZE",[e,t])});if(!c.ok)return Yt(CustomFunctions?.ErrorCode?.notAvailable,c.message||"Erreur AI.SUMMARIZE.");let l=[];if(i)try{const e=qt(c.text);Array.isArray(e?.items)&&(l=e.items.map(e=>jt(e)))}catch{l=c.text.split("\n").map(e=>e.trim())}else{try{const e=qt(c.text);Array.isArray(e?.items)&&(l=e.items.map(e=>jt(e)))}catch{}l.length||(l=[jt(c.text).trim()])}for(;l.length<o.length;)l.push("");l.length>o.length&&(l=l.slice(0,o.length));const m=[];let f=0;for(let e=0;e<r.length;e++){const t=[];for(let n=0;n<(r[e]||[]).length;n++)t.push(Ft(l[f++]||""));m.push(t)}return m}function In(e,t){try{const n=Pt(e),r=jt(t).toLowerCase();let o=0;for(const e of n){const t=Array.isArray(e)?e:[e];for(const e of t)jt(e).toLowerCase()===r&&o++}return o}catch(e){return Yt(CustomFunctions?.ErrorCode?.invalidValue,e?.message||"Erreur AI.COUNT.")}}const An=setInterval(()=>{(function(){try{if("undefined"==typeof CustomFunctions||!CustomFunctions?.associate)return!1;const e=(e,t)=>{try{return CustomFunctions.associate(e,t),!0}catch{return!1}};let t=!0;return t=e("AI.KEYSTATUS",rn)&&t,t=e("AI.TEST",on)&&t,t=e("AI.ASK",sn)&&t,t=e("AI.BATCH",an)&&t,t=e("AI.WEB",un)&&t,t=e("AI.TRANSLATE",cn)&&t,t=e("AI.CLASSIFY",ln)&&t,t=e("AI.EXTRACT",mn)&&t,t=e("AI.CLEAN",fn)&&t,t=e("AI.CONSISTENT",pn)&&t,t=e("AI.FORMULA",hn)&&t,t=e("AI.TABLE",dn)&&t,t=e("AI.FILL",gn)&&t,t=e("AI.SUMMARIZE",yn)&&t,t=e("AI.COUNT",In)&&t,t}catch{return!1}})()&&clearInterval(An)},200)})();
//# sourceMappingURL=functions.js.map